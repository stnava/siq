<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 15.0.4"/>
    <title>siq.get_data API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:.75rem center;margin-bottom:1rem;}.pdoc .alert > em{display:none;}.pdoc .alert > *:last-child{margin-bottom:0;}.pdoc .alert.note{color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .alert.tip{color:#0a3622;background-color:#d1e7dd;border-color:#a3cfbb;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%230a3622%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%206a6%206%200%201%201%2010.174%204.31c-.203.196-.359.4-.453.619l-.762%201.769A.5.5%200%200%201%2010.5%2013a.5.5%200%200%201%200%201%20.5.5%200%200%201%200%201l-.224.447a1%201%200%200%201-.894.553H6.618a1%201%200%200%201-.894-.553L5.5%2015a.5.5%200%200%201%200-1%20.5.5%200%200%201%200-1%20.5.5%200%200%201-.46-.302l-.761-1.77a2%202%200%200%200-.453-.618A5.98%205.98%200%200%201%202%206m6-5a5%205%200%200%200-3.479%208.592c.263.254.514.564.676.941L5.83%2012h4.342l.632-1.467c.162-.377.413-.687.676-.941A5%205%200%200%200%208%201%22/%3E%3C/svg%3E");}.pdoc .alert.important{color:#055160;background-color:#cff4fc;border-color:#9eeaf9;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23055160%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%200a2%202%200%200%200-2%202v12a2%202%200%200%200%202%202h12a2%202%200%200%200%202-2V2a2%202%200%200%200-2-2zm6%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .alert.caution{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M11.46.146A.5.5%200%200%200%2011.107%200H4.893a.5.5%200%200%200-.353.146L.146%204.54A.5.5%200%200%200%200%204.893v6.214a.5.5%200%200%200%20.146.353l4.394%204.394a.5.5%200%200%200%20.353.146h6.214a.5.5%200%200%200%20.353-.146l4.394-4.394a.5.5%200%200%200%20.146-.353V4.893a.5.5%200%200%200-.146-.353zM8%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .decorator-deprecated{color:#842029;}.pdoc .decorator-deprecated ~ span{filter:grayscale(1) opacity(0.8);}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../siq.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;siq</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="variable" href="#DATA_PATH">DATA_PATH</a>
            </li>
            <li>
                    <a class="function" href="#get_data">get_data</a>
            </li>
            <li>
                    <a class="function" href="#dbpn">dbpn</a>
            </li>
            <li>
                    <a class="function" href="#get_random_base_ind">get_random_base_ind</a>
            </li>
            <li>
                    <a class="function" href="#get_random_patch">get_random_patch</a>
            </li>
            <li>
                    <a class="function" href="#get_random_patch_pair">get_random_patch_pair</a>
            </li>
            <li>
                    <a class="function" href="#pseudo_3d_vgg_features">pseudo_3d_vgg_features</a>
            </li>
            <li>
                    <a class="function" href="#pseudo_3d_vgg_features_unbiased">pseudo_3d_vgg_features_unbiased</a>
            </li>
            <li>
                    <a class="function" href="#get_grader_feature_network">get_grader_feature_network</a>
            </li>
            <li>
                    <a class="function" href="#default_dbpn">default_dbpn</a>
            </li>
            <li>
                    <a class="function" href="#image_patch_training_data_from_filenames">image_patch_training_data_from_filenames</a>
            </li>
            <li>
                    <a class="function" href="#seg_patch_training_data_from_filenames">seg_patch_training_data_from_filenames</a>
            </li>
            <li>
                    <a class="function" href="#read">read</a>
            </li>
            <li>
                    <a class="function" href="#auto_weight_loss">auto_weight_loss</a>
            </li>
            <li>
                    <a class="function" href="#auto_weight_loss_seg">auto_weight_loss_seg</a>
            </li>
            <li>
                    <a class="function" href="#numpy_generator">numpy_generator</a>
            </li>
            <li>
                    <a class="function" href="#image_generator">image_generator</a>
            </li>
            <li>
                    <a class="function" href="#seg_generator">seg_generator</a>
            </li>
            <li>
                    <a class="function" href="#train">train</a>
            </li>
            <li>
                    <a class="function" href="#binary_dice_loss">binary_dice_loss</a>
            </li>
            <li>
                    <a class="function" href="#train_seg">train_seg</a>
            </li>
            <li>
                    <a class="function" href="#read_srmodel">read_srmodel</a>
            </li>
            <li>
                    <a class="function" href="#simulate_image">simulate_image</a>
            </li>
            <li>
                    <a class="function" href="#optimize_upsampling_shape">optimize_upsampling_shape</a>
            </li>
            <li>
                    <a class="function" href="#compare_models">compare_models</a>
            </li>
            <li>
                    <a class="function" href="#region_wise_super_resolution">region_wise_super_resolution</a>
            </li>
            <li>
                    <a class="function" href="#region_wise_super_resolution_blended">region_wise_super_resolution_blended</a>
            </li>
            <li>
                    <a class="function" href="#inference">inference</a>
            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../siq.html">siq</a><wbr>.get_data    </h1>

                
                        <input id="mod-get_data-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-get_data-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">   1</span></a><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">   2</span></a><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">PurePath</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">   3</span></a><span class="kn">import</span> <span class="nn">os</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">   4</span></a><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">   5</span></a><span class="kn">import</span> <span class="nn">math</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">   6</span></a><span class="kn">import</span> <span class="nn">os.path</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">   7</span></a><span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">path</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">   8</span></a><span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">exists</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">   9</span></a><span class="kn">import</span> <span class="nn">pickle</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos">  10</span></a><span class="kn">import</span> <span class="nn">sys</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos">  11</span></a><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos">  12</span></a><span class="kn">import</span> <span class="nn">random</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos">  13</span></a><span class="kn">import</span> <span class="nn">functools</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos">  14</span></a><span class="kn">from</span> <span class="nn">operator</span> <span class="kn">import</span> <span class="n">mul</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos">  15</span></a><span class="kn">from</span> <span class="nn">scipy.sparse.linalg</span> <span class="kn">import</span> <span class="n">svds</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos">  16</span></a><span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">pearsonr</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos">  17</span></a><span class="kn">import</span> <span class="nn">re</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos">  18</span></a>
</span><span id="L-19"><a href="#L-19"><span class="linenos">  19</span></a><span class="kn">import</span> <span class="nn">ants</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos">  20</span></a><span class="kn">import</span> <span class="nn">antspynet</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos">  21</span></a><span class="kn">import</span> <span class="nn">antspyt1w</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos">  22</span></a><span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos">  23</span></a><span class="kn">from</span> <span class="nn">tensorflow.python.eager.context</span> <span class="kn">import</span> <span class="n">eager_mode</span><span class="p">,</span> <span class="n">graph_mode</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos">  24</span></a>
</span><span id="L-25"><a href="#L-25"><span class="linenos">  25</span></a><span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Pool</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos">  26</span></a>
</span><span id="L-27"><a href="#L-27"><span class="linenos">  27</span></a><span class="n">DATA_PATH</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s1">&#39;~/.siq/&#39;</span><span class="p">)</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos">  28</span></a>
</span><span id="L-29"><a href="#L-29"><span class="linenos">  29</span></a><span class="k">def</span> <span class="nf">get_data</span><span class="p">(</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">force_download</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">target_extension</span><span class="o">=</span><span class="s1">&#39;.csv&#39;</span> <span class="p">):</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos">  30</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos">  31</span></a><span class="sd">    Get SIQ data filename</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos">  32</span></a>
</span><span id="L-33"><a href="#L-33"><span class="linenos">  33</span></a><span class="sd">    The first time this is called, it will download data to ~/.siq.</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos">  34</span></a><span class="sd">    After, it will just read data from disk.  The ~/.siq may need to</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos">  35</span></a><span class="sd">    be periodically deleted in order to ensure data is current.</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos">  36</span></a>
</span><span id="L-37"><a href="#L-37"><span class="linenos">  37</span></a><span class="sd">    Arguments</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos">  38</span></a><span class="sd">    ---------</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos">  39</span></a><span class="sd">    name : string</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos">  40</span></a><span class="sd">        name of data tag to retrieve</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos">  41</span></a><span class="sd">        Options:</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos">  42</span></a><span class="sd">            - &#39;all&#39;</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos">  43</span></a>
</span><span id="L-44"><a href="#L-44"><span class="linenos">  44</span></a><span class="sd">    force_download: boolean</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos">  45</span></a>
</span><span id="L-46"><a href="#L-46"><span class="linenos">  46</span></a><span class="sd">    version: version of data to download (integer)</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos">  47</span></a>
</span><span id="L-48"><a href="#L-48"><span class="linenos">  48</span></a><span class="sd">    Returns</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos">  49</span></a><span class="sd">    -------</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos">  50</span></a><span class="sd">    string</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos">  51</span></a><span class="sd">        filepath of selected data</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos">  52</span></a>
</span><span id="L-53"><a href="#L-53"><span class="linenos">  53</span></a><span class="sd">    Example</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos">  54</span></a><span class="sd">    -------</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos">  55</span></a><span class="sd">    &gt;&gt;&gt; import siq</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos">  56</span></a><span class="sd">    &gt;&gt;&gt; siq.get_data()</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos">  57</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos">  58</span></a>    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">DATA_PATH</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos">  59</span></a>
</span><span id="L-60"><a href="#L-60"><span class="linenos">  60</span></a>    <span class="k">def</span> <span class="nf">download_data</span><span class="p">(</span> <span class="n">version</span> <span class="p">):</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos">  61</span></a>        <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://figshare.com/ndownloader/articles/16912366/versions/&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">version</span><span class="p">)</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos">  62</span></a>        <span class="n">target_file_name</span> <span class="o">=</span> <span class="s2">&quot;16912366.zip&quot;</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos">  63</span></a>        <span class="n">target_file_name_path</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">get_file</span><span class="p">(</span><span class="n">target_file_name</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos">  64</span></a>            <span class="n">cache_subdir</span><span class="o">=</span><span class="n">DATA_PATH</span><span class="p">,</span> <span class="n">extract</span> <span class="o">=</span> <span class="kc">True</span> <span class="p">)</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos">  65</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span> <span class="n">DATA_PATH</span> <span class="o">+</span> <span class="n">target_file_name</span> <span class="p">)</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos">  66</span></a>
</span><span id="L-67"><a href="#L-67"><span class="linenos">  67</span></a>    <span class="k">if</span> <span class="n">force_download</span><span class="p">:</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos">  68</span></a>        <span class="n">download_data</span><span class="p">(</span> <span class="n">version</span> <span class="o">=</span> <span class="n">version</span> <span class="p">)</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos">  69</span></a>
</span><span id="L-70"><a href="#L-70"><span class="linenos">  70</span></a>
</span><span id="L-71"><a href="#L-71"><span class="linenos">  71</span></a>    <span class="n">files</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos">  72</span></a>    <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">DATA_PATH</span><span class="p">):</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos">  73</span></a>        <span class="k">if</span> <span class="p">(</span> <span class="n">fname</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">target_extension</span><span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos">  74</span></a>            <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_PATH</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos">  75</span></a>            <span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos">  76</span></a>
</span><span id="L-77"><a href="#L-77"><span class="linenos">  77</span></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span> <span class="n">files</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">:</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos">  78</span></a>        <span class="n">download_data</span><span class="p">(</span> <span class="n">version</span> <span class="o">=</span> <span class="n">version</span> <span class="p">)</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos">  79</span></a>        <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">DATA_PATH</span><span class="p">):</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos">  80</span></a>            <span class="k">if</span> <span class="p">(</span> <span class="n">fname</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">target_extension</span><span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos">  81</span></a>                <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_PATH</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos">  82</span></a>                <span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos">  83</span></a>
</span><span id="L-84"><a href="#L-84"><span class="linenos">  84</span></a>    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos">  85</span></a>        <span class="k">return</span> <span class="n">files</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos">  86</span></a>
</span><span id="L-87"><a href="#L-87"><span class="linenos">  87</span></a>    <span class="n">datapath</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos">  88</span></a>
</span><span id="L-89"><a href="#L-89"><span class="linenos">  89</span></a>    <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">DATA_PATH</span><span class="p">):</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos">  90</span></a>        <span class="n">mystem</span> <span class="o">=</span> <span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="o">.</span><span class="n">stem</span><span class="p">)</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos">  91</span></a>        <span class="n">mystem</span> <span class="o">=</span> <span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">mystem</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="o">.</span><span class="n">stem</span><span class="p">)</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos">  92</span></a>        <span class="n">mystem</span> <span class="o">=</span> <span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">mystem</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="o">.</span><span class="n">stem</span><span class="p">)</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos">  93</span></a>        <span class="k">if</span> <span class="p">(</span> <span class="n">name</span> <span class="o">==</span> <span class="n">mystem</span> <span class="ow">and</span> <span class="n">fname</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">target_extension</span><span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos">  94</span></a>            <span class="n">datapath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_PATH</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos">  95</span></a>
</span><span id="L-96"><a href="#L-96"><span class="linenos">  96</span></a>    <span class="k">return</span> <span class="n">datapath</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos">  97</span></a>
</span><span id="L-98"><a href="#L-98"><span class="linenos">  98</span></a>
</span><span id="L-99"><a href="#L-99"><span class="linenos">  99</span></a>
</span><span id="L-100"><a href="#L-100"><span class="linenos"> 100</span></a><span class="kn">from</span> <span class="nn">keras.models</span> <span class="kn">import</span> <span class="n">Model</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos"> 101</span></a><span class="kn">from</span> <span class="nn">keras.layers</span> <span class="kn">import</span> <span class="p">(</span><span class="n">Input</span><span class="p">,</span> <span class="n">Add</span><span class="p">,</span> <span class="n">Subtract</span><span class="p">,</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos"> 102</span></a>                          <span class="n">PReLU</span><span class="p">,</span> <span class="n">Concatenate</span><span class="p">,</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos"> 103</span></a>                          <span class="n">UpSampling2D</span><span class="p">,</span> <span class="n">UpSampling3D</span><span class="p">,</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos"> 104</span></a>                          <span class="n">Conv2D</span><span class="p">,</span> <span class="n">Conv2DTranspose</span><span class="p">,</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos"> 105</span></a>                          <span class="n">Conv3D</span><span class="p">,</span> <span class="n">Conv3DTranspose</span><span class="p">)</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos"> 106</span></a>
</span><span id="L-107"><a href="#L-107"><span class="linenos"> 107</span></a>
</span><span id="L-108"><a href="#L-108"><span class="linenos"> 108</span></a><span class="c1"># define the DBPN network - this uses a model definition that is general to&lt;br&gt;</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos"> 109</span></a><span class="c1"># both 2D and 3D. recommended parameters for different upsampling rates can&lt;br&gt;</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos"> 110</span></a><span class="c1"># be found in the papers by Haris et al.  We make one significant change to&lt;br&gt;</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos"> 111</span></a><span class="c1"># the original architecture by allowing standard interpolation for upsampling&lt;br&gt;</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos"> 112</span></a><span class="c1"># instead of convolutional upsampling.  this is controlled by the interpolation&lt;br&gt;</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos"> 113</span></a><span class="c1"># option.</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos"> 114</span></a>
</span><span id="L-115"><a href="#L-115"><span class="linenos"> 115</span></a>
</span><span id="L-116"><a href="#L-116"><span class="linenos"> 116</span></a>
</span><span id="L-117"><a href="#L-117"><span class="linenos"> 117</span></a><span class="k">def</span> <span class="nf">dbpn</span><span class="p">(</span><span class="n">input_image_size</span><span class="p">,</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos"> 118</span></a>                                                 <span class="n">number_of_outputs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos"> 119</span></a>                                                 <span class="n">number_of_base_filters</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos"> 120</span></a>                                                 <span class="n">number_of_feature_filters</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos"> 121</span></a>                                                 <span class="n">number_of_back_projection_stages</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos"> 122</span></a>                                                 <span class="n">convolution_kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos"> 123</span></a>                                                 <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos"> 124</span></a>                                                 <span class="n">last_convolution</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos"> 125</span></a>                                                 <span class="n">number_of_loss_functions</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos"> 126</span></a>                                                 <span class="n">interpolation</span> <span class="o">=</span> <span class="s1">&#39;nearest&#39;</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos"> 127</span></a>                                                <span class="p">):</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos"> 128</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos"> 129</span></a><span class="sd">    Creates a Deep Back-Projection Network (DBPN) for single image super-resolution.</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos"> 130</span></a>
</span><span id="L-131"><a href="#L-131"><span class="linenos"> 131</span></a><span class="sd">    This function constructs a Keras model based on the DBPN architecture, which</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos"> 132</span></a><span class="sd">    can be configured for either 2D or 3D inputs. The network uses iterative</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos"> 133</span></a><span class="sd">    up- and down-projection blocks to refine the high-resolution image estimate. A</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos"> 134</span></a><span class="sd">    key modification from the original paper is the option to use standard</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos"> 135</span></a><span class="sd">    interpolation for upsampling instead of deconvolution layers.</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos"> 136</span></a>
</span><span id="L-137"><a href="#L-137"><span class="linenos"> 137</span></a><span class="sd">    Reference:</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos"> 138</span></a><span class="sd">     - Haris, M., Shakhnarovich, G., &amp; Ukita, N. (2018). Deep Back-Projection</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos"> 139</span></a><span class="sd">       Networks For Super-Resolution. In CVPR.</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos"> 140</span></a>
</span><span id="L-141"><a href="#L-141"><span class="linenos"> 141</span></a><span class="sd">    Parameters</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos"> 142</span></a><span class="sd">    ----------</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos"> 143</span></a><span class="sd">    input_image_size : tuple or list</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos"> 144</span></a><span class="sd">        The shape of the input image, including the channel.</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos"> 145</span></a><span class="sd">        e.g., `(None, None, 1)` for 2D or `(None, None, None, 1)` for 3D.</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos"> 146</span></a>
</span><span id="L-147"><a href="#L-147"><span class="linenos"> 147</span></a><span class="sd">    number_of_outputs : int, optional</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos"> 148</span></a><span class="sd">        The number of channels in the output image. Default is 1.</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos"> 149</span></a>
</span><span id="L-150"><a href="#L-150"><span class="linenos"> 150</span></a><span class="sd">    number_of_base_filters : int, optional</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos"> 151</span></a><span class="sd">        The number of filters in the up/down projection blocks. Default is 64.</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos"> 152</span></a>
</span><span id="L-153"><a href="#L-153"><span class="linenos"> 153</span></a><span class="sd">    number_of_feature_filters : int, optional</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos"> 154</span></a><span class="sd">        The number of filters in the initial feature extraction layer. Default is 256.</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos"> 155</span></a>
</span><span id="L-156"><a href="#L-156"><span class="linenos"> 156</span></a><span class="sd">    number_of_back_projection_stages : int, optional</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos"> 157</span></a><span class="sd">        The number of iterative back-projection stages (T in the paper). Default is 7.</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos"> 158</span></a>
</span><span id="L-159"><a href="#L-159"><span class="linenos"> 159</span></a><span class="sd">    convolution_kernel_size : tuple or list, optional</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos"> 160</span></a><span class="sd">        The kernel size for the main projection convolutions. Should match the</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos"> 161</span></a><span class="sd">        dimensionality of the input. Default is (12, 12).</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos"> 162</span></a>
</span><span id="L-163"><a href="#L-163"><span class="linenos"> 163</span></a><span class="sd">    strides : tuple or list, optional</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos"> 164</span></a><span class="sd">        The strides for the up/down sampling operations, defining the</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos"> 165</span></a><span class="sd">        super-resolution factor. Default is (8, 8).</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos"> 166</span></a>
</span><span id="L-167"><a href="#L-167"><span class="linenos"> 167</span></a><span class="sd">    last_convolution : tuple or list, optional</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos"> 168</span></a><span class="sd">        The kernel size of the final reconstruction convolution. Default is (3, 3).</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos"> 169</span></a>
</span><span id="L-170"><a href="#L-170"><span class="linenos"> 170</span></a><span class="sd">    number_of_loss_functions : int, optional</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos"> 171</span></a><span class="sd">        If greater than 1, the model will have multiple identical output branches.</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos"> 172</span></a><span class="sd">        Typically set to 1. Default is 1.</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos"> 173</span></a>
</span><span id="L-174"><a href="#L-174"><span class="linenos"> 174</span></a><span class="sd">    interpolation : str, optional</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos"> 175</span></a><span class="sd">        The interpolation method to use for upsampling layers if not using</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos"> 176</span></a><span class="sd">        transposed convolutions. &#39;nearest&#39; or &#39;bilinear&#39;. Default is &#39;nearest&#39;.</span>
</span><span id="L-177"><a href="#L-177"><span class="linenos"> 177</span></a>
</span><span id="L-178"><a href="#L-178"><span class="linenos"> 178</span></a><span class="sd">    Returns</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos"> 179</span></a><span class="sd">    -------</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos"> 180</span></a><span class="sd">    keras.Model</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos"> 181</span></a><span class="sd">        A Keras model implementing the DBPN architecture for the specified</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos"> 182</span></a><span class="sd">        parameters.</span>
</span><span id="L-183"><a href="#L-183"><span class="linenos"> 183</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos"> 184</span></a>    <span class="n">idim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span> <span class="n">input_image_size</span> <span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos"> 185</span></a>    <span class="k">if</span> <span class="n">idim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos"> 186</span></a>        <span class="n">myconv</span> <span class="o">=</span> <span class="n">Conv2D</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos"> 187</span></a>        <span class="n">myconv_transpose</span> <span class="o">=</span> <span class="n">Conv2DTranspose</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos"> 188</span></a>        <span class="n">myupsampling</span> <span class="o">=</span> <span class="n">UpSampling2D</span>
</span><span id="L-189"><a href="#L-189"><span class="linenos"> 189</span></a>        <span class="n">shax</span> <span class="o">=</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span> <span class="p">)</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos"> 190</span></a>        <span class="n">firstConv</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos"> 191</span></a>        <span class="n">firstStrides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos"> 192</span></a>        <span class="n">smashConv</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos"> 193</span></a>    <span class="k">if</span> <span class="n">idim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos"> 194</span></a>        <span class="n">myconv</span> <span class="o">=</span> <span class="n">Conv3D</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos"> 195</span></a>        <span class="n">myconv_transpose</span> <span class="o">=</span> <span class="n">Conv3DTranspose</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos"> 196</span></a>        <span class="n">myupsampling</span> <span class="o">=</span> <span class="n">UpSampling3D</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos"> 197</span></a>        <span class="n">shax</span> <span class="o">=</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span> <span class="p">)</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos"> 198</span></a>        <span class="n">firstConv</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos"> 199</span></a>        <span class="n">firstStrides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos"> 200</span></a>        <span class="n">smashConv</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos"> 201</span></a>    <span class="k">def</span> <span class="nf">up_block_2d</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">number_of_filters</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos"> 202</span></a>                    <span class="n">include_dense_convolution_layer</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos"> 203</span></a>        <span class="k">if</span> <span class="n">include_dense_convolution_layer</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos"> 204</span></a>            <span class="n">L</span> <span class="o">=</span> <span class="n">myconv</span><span class="p">(</span><span class="n">filters</span> <span class="o">=</span> <span class="n">number_of_filters</span><span class="p">,</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos"> 205</span></a>                       <span class="n">use_bias</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos"> 206</span></a>                       <span class="n">kernel_size</span><span class="o">=</span><span class="n">smashConv</span><span class="p">,</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos"> 207</span></a>                       <span class="n">strides</span><span class="o">=</span><span class="n">firstStrides</span><span class="p">,</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos"> 208</span></a>                       <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)(</span><span class="n">L</span><span class="p">)</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos"> 209</span></a>            <span class="n">L</span> <span class="o">=</span> <span class="n">PReLU</span><span class="p">(</span><span class="n">alpha_initializer</span><span class="o">=</span><span class="s1">&#39;zero&#39;</span><span class="p">,</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos"> 210</span></a>                      <span class="n">shared_axes</span><span class="o">=</span><span class="n">shax</span><span class="p">)(</span><span class="n">L</span><span class="p">)</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos"> 211</span></a>        <span class="c1"># Scale up</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos"> 212</span></a>        <span class="k">if</span> <span class="n">idim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos"> 213</span></a>            <span class="n">H0</span> <span class="o">=</span> <span class="n">myupsampling</span><span class="p">(</span> <span class="n">size</span> <span class="o">=</span> <span class="n">strides</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">interpolation</span> <span class="p">)(</span><span class="n">L</span><span class="p">)</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos"> 214</span></a>        <span class="k">if</span> <span class="n">idim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos"> 215</span></a>            <span class="n">H0</span> <span class="o">=</span> <span class="n">myupsampling</span><span class="p">(</span> <span class="n">size</span> <span class="o">=</span> <span class="n">strides</span> <span class="p">)(</span><span class="n">L</span><span class="p">)</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos"> 216</span></a>        <span class="n">H0</span> <span class="o">=</span> <span class="n">myconv</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="n">number_of_filters</span><span class="p">,</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos"> 217</span></a>                    <span class="n">kernel_size</span><span class="o">=</span><span class="n">firstConv</span><span class="p">,</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos"> 218</span></a>                    <span class="n">strides</span><span class="o">=</span><span class="n">firstStrides</span><span class="p">,</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos"> 219</span></a>                    <span class="n">use_bias</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos"> 220</span></a>                    <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)(</span><span class="n">H0</span><span class="p">)</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos"> 221</span></a>        <span class="n">H0</span> <span class="o">=</span> <span class="n">PReLU</span><span class="p">(</span><span class="n">alpha_initializer</span><span class="o">=</span><span class="s1">&#39;zero&#39;</span><span class="p">,</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos"> 222</span></a>                   <span class="n">shared_axes</span><span class="o">=</span><span class="n">shax</span><span class="p">)(</span><span class="n">H0</span><span class="p">)</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos"> 223</span></a>        <span class="c1"># Scale down</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos"> 224</span></a>        <span class="n">L0</span> <span class="o">=</span> <span class="n">myconv</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="n">number_of_filters</span><span class="p">,</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos"> 225</span></a>                    <span class="n">kernel_size</span><span class="o">=</span><span class="n">kernel_size</span><span class="p">,</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos"> 226</span></a>                    <span class="n">strides</span><span class="o">=</span><span class="n">strides</span><span class="p">,</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos"> 227</span></a>                    <span class="n">kernel_initializer</span><span class="o">=</span><span class="s1">&#39;glorot_uniform&#39;</span><span class="p">,</span>
</span><span id="L-228"><a href="#L-228"><span class="linenos"> 228</span></a>                    <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)(</span><span class="n">H0</span><span class="p">)</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos"> 229</span></a>        <span class="n">L0</span> <span class="o">=</span> <span class="n">PReLU</span><span class="p">(</span><span class="n">alpha_initializer</span><span class="o">=</span><span class="s1">&#39;zero&#39;</span><span class="p">,</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos"> 230</span></a>                   <span class="n">shared_axes</span><span class="o">=</span><span class="n">shax</span><span class="p">)(</span><span class="n">L0</span><span class="p">)</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos"> 231</span></a>        <span class="c1"># Residual</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos"> 232</span></a>        <span class="n">E</span> <span class="o">=</span> <span class="n">Subtract</span><span class="p">()([</span><span class="n">L0</span><span class="p">,</span> <span class="n">L</span><span class="p">])</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos"> 233</span></a>        <span class="c1"># Scale residual up</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos"> 234</span></a>        <span class="k">if</span> <span class="n">idim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos"> 235</span></a>            <span class="n">H1</span> <span class="o">=</span> <span class="n">myupsampling</span><span class="p">(</span> <span class="n">size</span> <span class="o">=</span> <span class="n">strides</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">interpolation</span>  <span class="p">)(</span><span class="n">E</span><span class="p">)</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos"> 236</span></a>        <span class="k">if</span> <span class="n">idim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos"> 237</span></a>            <span class="n">H1</span> <span class="o">=</span> <span class="n">myupsampling</span><span class="p">(</span> <span class="n">size</span> <span class="o">=</span> <span class="n">strides</span> <span class="p">)(</span><span class="n">E</span><span class="p">)</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos"> 238</span></a>        <span class="n">H1</span> <span class="o">=</span> <span class="n">myconv</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="n">number_of_filters</span><span class="p">,</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos"> 239</span></a>                    <span class="n">kernel_size</span><span class="o">=</span><span class="n">firstConv</span><span class="p">,</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos"> 240</span></a>                    <span class="n">strides</span><span class="o">=</span><span class="n">firstStrides</span><span class="p">,</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos"> 241</span></a>                    <span class="n">use_bias</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos"> 242</span></a>                    <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)(</span><span class="n">H1</span><span class="p">)</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos"> 243</span></a>        <span class="n">H1</span> <span class="o">=</span> <span class="n">PReLU</span><span class="p">(</span><span class="n">alpha_initializer</span><span class="o">=</span><span class="s1">&#39;zero&#39;</span><span class="p">,</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos"> 244</span></a>                   <span class="n">shared_axes</span><span class="o">=</span><span class="n">shax</span><span class="p">)(</span><span class="n">H1</span><span class="p">)</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos"> 245</span></a>        <span class="c1"># Output feature map</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos"> 246</span></a>        <span class="n">up_block</span> <span class="o">=</span> <span class="n">Add</span><span class="p">()([</span><span class="n">H0</span><span class="p">,</span> <span class="n">H1</span><span class="p">])</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos"> 247</span></a>        <span class="k">return</span> <span class="n">up_block</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos"> 248</span></a>    <span class="k">def</span> <span class="nf">down_block_2d</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">number_of_filters</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos"> 249</span></a>                    <span class="n">include_dense_convolution_layer</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos"> 250</span></a>        <span class="k">if</span> <span class="n">include_dense_convolution_layer</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos"> 251</span></a>            <span class="n">H</span> <span class="o">=</span> <span class="n">myconv</span><span class="p">(</span><span class="n">filters</span> <span class="o">=</span> <span class="n">number_of_filters</span><span class="p">,</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos"> 252</span></a>                       <span class="n">use_bias</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos"> 253</span></a>                       <span class="n">kernel_size</span><span class="o">=</span><span class="n">smashConv</span><span class="p">,</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos"> 254</span></a>                       <span class="n">strides</span><span class="o">=</span><span class="n">firstStrides</span><span class="p">,</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos"> 255</span></a>                       <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)(</span><span class="n">H</span><span class="p">)</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos"> 256</span></a>            <span class="n">H</span> <span class="o">=</span> <span class="n">PReLU</span><span class="p">(</span><span class="n">alpha_initializer</span><span class="o">=</span><span class="s1">&#39;zero&#39;</span><span class="p">,</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos"> 257</span></a>                      <span class="n">shared_axes</span><span class="o">=</span><span class="n">shax</span><span class="p">)(</span><span class="n">H</span><span class="p">)</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos"> 258</span></a>        <span class="c1"># Scale down</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos"> 259</span></a>        <span class="n">L0</span> <span class="o">=</span> <span class="n">myconv</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="n">number_of_filters</span><span class="p">,</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos"> 260</span></a>                    <span class="n">kernel_size</span><span class="o">=</span><span class="n">kernel_size</span><span class="p">,</span>
</span><span id="L-261"><a href="#L-261"><span class="linenos"> 261</span></a>                    <span class="n">strides</span><span class="o">=</span><span class="n">strides</span><span class="p">,</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos"> 262</span></a>                    <span class="n">kernel_initializer</span><span class="o">=</span><span class="s1">&#39;glorot_uniform&#39;</span><span class="p">,</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos"> 263</span></a>                    <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)(</span><span class="n">H</span><span class="p">)</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos"> 264</span></a>        <span class="n">L0</span> <span class="o">=</span> <span class="n">PReLU</span><span class="p">(</span><span class="n">alpha_initializer</span><span class="o">=</span><span class="s1">&#39;zero&#39;</span><span class="p">,</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos"> 265</span></a>                   <span class="n">shared_axes</span><span class="o">=</span><span class="n">shax</span><span class="p">)(</span><span class="n">L0</span><span class="p">)</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos"> 266</span></a>        <span class="c1"># Scale up</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos"> 267</span></a>        <span class="k">if</span> <span class="n">idim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos"> 268</span></a>            <span class="n">H0</span> <span class="o">=</span> <span class="n">myupsampling</span><span class="p">(</span> <span class="n">size</span> <span class="o">=</span> <span class="n">strides</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">interpolation</span> <span class="p">)(</span><span class="n">L0</span><span class="p">)</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos"> 269</span></a>        <span class="k">if</span> <span class="n">idim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos"> 270</span></a>            <span class="n">H0</span> <span class="o">=</span> <span class="n">myupsampling</span><span class="p">(</span> <span class="n">size</span> <span class="o">=</span> <span class="n">strides</span> <span class="p">)(</span><span class="n">L0</span><span class="p">)</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos"> 271</span></a>        <span class="n">H0</span> <span class="o">=</span> <span class="n">myconv</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="n">number_of_filters</span><span class="p">,</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos"> 272</span></a>                    <span class="n">kernel_size</span><span class="o">=</span><span class="n">firstConv</span><span class="p">,</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos"> 273</span></a>                    <span class="n">strides</span><span class="o">=</span><span class="n">firstStrides</span><span class="p">,</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos"> 274</span></a>                    <span class="n">use_bias</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos"> 275</span></a>                    <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)(</span><span class="n">H0</span><span class="p">)</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos"> 276</span></a>        <span class="n">H0</span> <span class="o">=</span> <span class="n">PReLU</span><span class="p">(</span><span class="n">alpha_initializer</span><span class="o">=</span><span class="s1">&#39;zero&#39;</span><span class="p">,</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos"> 277</span></a>                   <span class="n">shared_axes</span><span class="o">=</span><span class="n">shax</span><span class="p">)(</span><span class="n">H0</span><span class="p">)</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos"> 278</span></a>        <span class="c1"># Residual</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos"> 279</span></a>        <span class="n">E</span> <span class="o">=</span> <span class="n">Subtract</span><span class="p">()([</span><span class="n">H0</span><span class="p">,</span> <span class="n">H</span><span class="p">])</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos"> 280</span></a>        <span class="c1"># Scale residual down</span>
</span><span id="L-281"><a href="#L-281"><span class="linenos"> 281</span></a>        <span class="n">L1</span> <span class="o">=</span> <span class="n">myconv</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="n">number_of_filters</span><span class="p">,</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos"> 282</span></a>                    <span class="n">kernel_size</span><span class="o">=</span><span class="n">kernel_size</span><span class="p">,</span>
</span><span id="L-283"><a href="#L-283"><span class="linenos"> 283</span></a>                    <span class="n">strides</span><span class="o">=</span><span class="n">strides</span><span class="p">,</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos"> 284</span></a>                    <span class="n">kernel_initializer</span><span class="o">=</span><span class="s1">&#39;glorot_uniform&#39;</span><span class="p">,</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos"> 285</span></a>                    <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)(</span><span class="n">E</span><span class="p">)</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos"> 286</span></a>        <span class="n">L1</span> <span class="o">=</span> <span class="n">PReLU</span><span class="p">(</span><span class="n">alpha_initializer</span><span class="o">=</span><span class="s1">&#39;zero&#39;</span><span class="p">,</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos"> 287</span></a>                   <span class="n">shared_axes</span><span class="o">=</span><span class="n">shax</span><span class="p">)(</span><span class="n">L1</span><span class="p">)</span>
</span><span id="L-288"><a href="#L-288"><span class="linenos"> 288</span></a>        <span class="c1"># Output feature map</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos"> 289</span></a>        <span class="n">down_block</span> <span class="o">=</span> <span class="n">Add</span><span class="p">()([</span><span class="n">L0</span><span class="p">,</span> <span class="n">L1</span><span class="p">])</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos"> 290</span></a>        <span class="k">return</span> <span class="n">down_block</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos"> 291</span></a>    <span class="n">inputs</span> <span class="o">=</span> <span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">input_image_size</span><span class="p">)</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos"> 292</span></a>    <span class="c1"># Initial feature extraction</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos"> 293</span></a>    <span class="n">model</span> <span class="o">=</span> <span class="n">myconv</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="n">number_of_feature_filters</span><span class="p">,</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos"> 294</span></a>                   <span class="n">kernel_size</span><span class="o">=</span><span class="n">firstConv</span><span class="p">,</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos"> 295</span></a>                   <span class="n">strides</span><span class="o">=</span><span class="n">firstStrides</span><span class="p">,</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos"> 296</span></a>                   <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos"> 297</span></a>                   <span class="n">kernel_initializer</span><span class="o">=</span><span class="s1">&#39;glorot_uniform&#39;</span><span class="p">)(</span><span class="n">inputs</span><span class="p">)</span>
</span><span id="L-298"><a href="#L-298"><span class="linenos"> 298</span></a>    <span class="n">model</span> <span class="o">=</span> <span class="n">PReLU</span><span class="p">(</span><span class="n">alpha_initializer</span><span class="o">=</span><span class="s1">&#39;zero&#39;</span><span class="p">,</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos"> 299</span></a>                  <span class="n">shared_axes</span><span class="o">=</span><span class="n">shax</span><span class="p">)(</span><span class="n">model</span><span class="p">)</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos"> 300</span></a>    <span class="c1"># Feature smashing</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos"> 301</span></a>    <span class="n">model</span> <span class="o">=</span> <span class="n">myconv</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="n">number_of_base_filters</span><span class="p">,</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos"> 302</span></a>                   <span class="n">kernel_size</span><span class="o">=</span><span class="n">smashConv</span><span class="p">,</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos"> 303</span></a>                   <span class="n">strides</span><span class="o">=</span><span class="n">firstStrides</span><span class="p">,</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos"> 304</span></a>                   <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos"> 305</span></a>                   <span class="n">kernel_initializer</span><span class="o">=</span><span class="s1">&#39;glorot_uniform&#39;</span><span class="p">)(</span><span class="n">model</span><span class="p">)</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos"> 306</span></a>    <span class="n">model</span> <span class="o">=</span> <span class="n">PReLU</span><span class="p">(</span><span class="n">alpha_initializer</span><span class="o">=</span><span class="s1">&#39;zero&#39;</span><span class="p">,</span>
</span><span id="L-307"><a href="#L-307"><span class="linenos"> 307</span></a>                  <span class="n">shared_axes</span><span class="o">=</span><span class="n">shax</span><span class="p">)(</span><span class="n">model</span><span class="p">)</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos"> 308</span></a>    <span class="c1"># Back projection</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos"> 309</span></a>    <span class="n">up_projection_blocks</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos"> 310</span></a>    <span class="n">down_projection_blocks</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos"> 311</span></a>    <span class="n">model</span> <span class="o">=</span> <span class="n">up_block_2d</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">number_of_filters</span><span class="o">=</span><span class="n">number_of_base_filters</span><span class="p">,</span>
</span><span id="L-312"><a href="#L-312"><span class="linenos"> 312</span></a>      <span class="n">kernel_size</span><span class="o">=</span><span class="n">convolution_kernel_size</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="n">strides</span><span class="p">)</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos"> 313</span></a>    <span class="n">up_projection_blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos"> 314</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_of_back_projection_stages</span><span class="p">):</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos"> 315</span></a>        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos"> 316</span></a>            <span class="n">model</span> <span class="o">=</span> <span class="n">down_block_2d</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">number_of_filters</span><span class="o">=</span><span class="n">number_of_base_filters</span><span class="p">,</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos"> 317</span></a>              <span class="n">kernel_size</span><span class="o">=</span><span class="n">convolution_kernel_size</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="n">strides</span><span class="p">)</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos"> 318</span></a>            <span class="n">down_projection_blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos"> 319</span></a>            <span class="n">model</span> <span class="o">=</span> <span class="n">up_block_2d</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">number_of_filters</span><span class="o">=</span><span class="n">number_of_base_filters</span><span class="p">,</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos"> 320</span></a>              <span class="n">kernel_size</span><span class="o">=</span><span class="n">convolution_kernel_size</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="n">strides</span><span class="p">)</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos"> 321</span></a>            <span class="n">up_projection_blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos"> 322</span></a>            <span class="n">model</span> <span class="o">=</span> <span class="n">Concatenate</span><span class="p">()(</span><span class="n">up_projection_blocks</span><span class="p">)</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos"> 323</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos"> 324</span></a>            <span class="n">model</span> <span class="o">=</span> <span class="n">down_block_2d</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">number_of_filters</span><span class="o">=</span><span class="n">number_of_base_filters</span><span class="p">,</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos"> 325</span></a>              <span class="n">kernel_size</span><span class="o">=</span><span class="n">convolution_kernel_size</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="n">strides</span><span class="p">,</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos"> 326</span></a>              <span class="n">include_dense_convolution_layer</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos"> 327</span></a>            <span class="n">down_projection_blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos"> 328</span></a>            <span class="n">model</span> <span class="o">=</span> <span class="n">Concatenate</span><span class="p">()(</span><span class="n">down_projection_blocks</span><span class="p">)</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos"> 329</span></a>            <span class="n">model</span> <span class="o">=</span> <span class="n">up_block_2d</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">number_of_filters</span><span class="o">=</span><span class="n">number_of_base_filters</span><span class="p">,</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos"> 330</span></a>              <span class="n">kernel_size</span><span class="o">=</span><span class="n">convolution_kernel_size</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="n">strides</span><span class="p">,</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos"> 331</span></a>              <span class="n">include_dense_convolution_layer</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos"> 332</span></a>            <span class="n">up_projection_blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos"> 333</span></a>            <span class="n">model</span> <span class="o">=</span> <span class="n">Concatenate</span><span class="p">()(</span><span class="n">up_projection_blocks</span><span class="p">)</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos"> 334</span></a>    <span class="n">outputs</span> <span class="o">=</span> <span class="n">myconv</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="n">number_of_outputs</span><span class="p">,</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos"> 335</span></a>                     <span class="n">kernel_size</span><span class="o">=</span><span class="n">last_convolution</span><span class="p">,</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos"> 336</span></a>                     <span class="n">strides</span><span class="o">=</span><span class="n">firstStrides</span><span class="p">,</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos"> 337</span></a>                     <span class="n">padding</span> <span class="o">=</span> <span class="s1">&#39;same&#39;</span><span class="p">,</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos"> 338</span></a>                     <span class="n">kernel_initializer</span> <span class="o">=</span> <span class="s2">&quot;glorot_uniform&quot;</span><span class="p">)(</span><span class="n">model</span><span class="p">)</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos"> 339</span></a>    <span class="k">if</span> <span class="n">number_of_loss_functions</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos"> 340</span></a>        <span class="n">deep_back_projection_network_model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">outputs</span><span class="p">)</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos"> 341</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-342"><a href="#L-342"><span class="linenos"> 342</span></a>        <span class="n">outputList</span><span class="o">=</span><span class="p">[]</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos"> 343</span></a>        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_of_loss_functions</span><span class="p">):</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos"> 344</span></a>            <span class="n">outputList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">outputs</span><span class="p">)</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos"> 345</span></a>        <span class="n">deep_back_projection_network_model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">outputList</span><span class="p">)</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos"> 346</span></a>    <span class="k">return</span> <span class="n">deep_back_projection_network_model</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos"> 347</span></a>
</span><span id="L-348"><a href="#L-348"><span class="linenos"> 348</span></a>
</span><span id="L-349"><a href="#L-349"><span class="linenos"> 349</span></a><span class="c1"># generate a random corner index for a patch</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos"> 350</span></a>
</span><span id="L-351"><a href="#L-351"><span class="linenos"> 351</span></a><span class="k">def</span> <span class="nf">get_random_base_ind</span><span class="p">(</span> <span class="n">full_dims</span><span class="p">,</span> <span class="n">patchWidth</span><span class="p">,</span> <span class="n">off</span><span class="o">=</span><span class="mi">8</span> <span class="p">):</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos"> 352</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-353"><a href="#L-353"><span class="linenos"> 353</span></a><span class="sd">    Generates a random top-left corner index for a patch.</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos"> 354</span></a>
</span><span id="L-355"><a href="#L-355"><span class="linenos"> 355</span></a><span class="sd">    This utility function computes a valid starting index (e.g., [x, y, z])</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos"> 356</span></a><span class="sd">    for extracting a patch from a larger volume, ensuring the patch fits entirely</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos"> 357</span></a><span class="sd">    within the volume&#39;s boundaries, accounting for an offset.</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos"> 358</span></a>
</span><span id="L-359"><a href="#L-359"><span class="linenos"> 359</span></a><span class="sd">    Parameters</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos"> 360</span></a><span class="sd">    ----------</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos"> 361</span></a><span class="sd">    full_dims : tuple or list</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos"> 362</span></a><span class="sd">        The dimensions of the full volume (e.g., img.shape).</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos"> 363</span></a>
</span><span id="L-364"><a href="#L-364"><span class="linenos"> 364</span></a><span class="sd">    patchWidth : tuple or list</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos"> 365</span></a><span class="sd">        The dimensions of the patch to be extracted.</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos"> 366</span></a>
</span><span id="L-367"><a href="#L-367"><span class="linenos"> 367</span></a><span class="sd">    off : int, optional</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos"> 368</span></a><span class="sd">        An offset from the edge of the volume to avoid sampling near borders.</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos"> 369</span></a><span class="sd">        Default is 8.</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos"> 370</span></a>
</span><span id="L-371"><a href="#L-371"><span class="linenos"> 371</span></a><span class="sd">    Returns</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos"> 372</span></a><span class="sd">    -------</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos"> 373</span></a><span class="sd">    list</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos"> 374</span></a><span class="sd">        A list of integers representing the starting coordinates for the patch.</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos"> 375</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos"> 376</span></a>    <span class="n">baseInd</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">]</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos"> 377</span></a>    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos"> 378</span></a>        <span class="n">baseInd</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">=</span><span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span> <span class="nb">range</span><span class="p">(</span> <span class="n">off</span><span class="p">,</span> <span class="n">full_dims</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">patchWidth</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="p">),</span> <span class="mi">1</span> <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos"> 379</span></a>    <span class="k">return</span> <span class="n">baseInd</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos"> 380</span></a>
</span><span id="L-381"><a href="#L-381"><span class="linenos"> 381</span></a>
</span><span id="L-382"><a href="#L-382"><span class="linenos"> 382</span></a><span class="c1"># extract a random patch</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos"> 383</span></a><span class="k">def</span> <span class="nf">get_random_patch</span><span class="p">(</span> <span class="n">img</span><span class="p">,</span> <span class="n">patchWidth</span> <span class="p">):</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos"> 384</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos"> 385</span></a><span class="sd">    Extracts a random patch from an image with non-zero variance.</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos"> 386</span></a>
</span><span id="L-387"><a href="#L-387"><span class="linenos"> 387</span></a><span class="sd">    This function repeatedly samples a random patch of a specified width from</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos"> 388</span></a><span class="sd">    the input image until it finds one where the standard deviation of pixel</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos"> 389</span></a><span class="sd">    intensities is greater than zero. This is useful for avoiding blank or</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos"> 390</span></a><span class="sd">    uniform patches during training data generation.</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos"> 391</span></a>
</span><span id="L-392"><a href="#L-392"><span class="linenos"> 392</span></a><span class="sd">    Parameters</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos"> 393</span></a><span class="sd">    ----------</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos"> 394</span></a><span class="sd">    img : ants.ANTsImage</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos"> 395</span></a><span class="sd">        The source image from which to extract a patch.</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos"> 396</span></a>
</span><span id="L-397"><a href="#L-397"><span class="linenos"> 397</span></a><span class="sd">    patchWidth : tuple or list</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos"> 398</span></a><span class="sd">        The desired dimensions of the output patch.</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos"> 399</span></a>
</span><span id="L-400"><a href="#L-400"><span class="linenos"> 400</span></a><span class="sd">    Returns</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos"> 401</span></a><span class="sd">    -------</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos"> 402</span></a><span class="sd">    ants.ANTsImage</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos"> 403</span></a><span class="sd">        A randomly extracted patch from the input image.</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos"> 404</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos"> 405</span></a>    <span class="n">mystd</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos"> 406</span></a>    <span class="k">while</span> <span class="n">mystd</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos"> 407</span></a>        <span class="n">inds</span> <span class="o">=</span> <span class="n">get_random_base_ind</span><span class="p">(</span> <span class="n">full_dims</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">patchWidth</span><span class="o">=</span><span class="n">patchWidth</span><span class="p">,</span> <span class="n">off</span><span class="o">=</span><span class="mi">8</span> <span class="p">)</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos"> 408</span></a>        <span class="n">hinds</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">]</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos"> 409</span></a>        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">inds</span><span class="p">)):</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos"> 410</span></a>            <span class="n">hinds</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">inds</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="n">patchWidth</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
</span><span id="L-411"><a href="#L-411"><span class="linenos"> 411</span></a>        <span class="n">myimg</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">crop_indices</span><span class="p">(</span> <span class="n">img</span><span class="p">,</span> <span class="n">inds</span><span class="p">,</span> <span class="n">hinds</span> <span class="p">)</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos"> 412</span></a>        <span class="n">mystd</span> <span class="o">=</span> <span class="n">myimg</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos"> 413</span></a>    <span class="k">return</span> <span class="n">myimg</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos"> 414</span></a>
</span><span id="L-415"><a href="#L-415"><span class="linenos"> 415</span></a><span class="k">def</span> <span class="nf">get_random_patch_pair</span><span class="p">(</span> <span class="n">img</span><span class="p">,</span> <span class="n">img2</span><span class="p">,</span> <span class="n">patchWidth</span> <span class="p">):</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos"> 416</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos"> 417</span></a><span class="sd">    Extracts a corresponding random patch from a pair of images.</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos"> 418</span></a>
</span><span id="L-419"><a href="#L-419"><span class="linenos"> 419</span></a><span class="sd">    This function finds a single random location and extracts a patch of the</span>
</span><span id="L-420"><a href="#L-420"><span class="linenos"> 420</span></a><span class="sd">    same size and position from two different input images. It ensures that</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos"> 421</span></a><span class="sd">    both extracted patches have non-zero variance. This is useful for creating</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos"> 422</span></a><span class="sd">    paired training data (e.g., low-res and high-res images).</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos"> 423</span></a>
</span><span id="L-424"><a href="#L-424"><span class="linenos"> 424</span></a><span class="sd">    Parameters</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos"> 425</span></a><span class="sd">    ----------</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos"> 426</span></a><span class="sd">    img : ants.ANTsImage</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos"> 427</span></a><span class="sd">        The first source image.</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos"> 428</span></a>
</span><span id="L-429"><a href="#L-429"><span class="linenos"> 429</span></a><span class="sd">    img2 : ants.ANTsImage</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos"> 430</span></a><span class="sd">        The second source image, spatially aligned with the first.</span>
</span><span id="L-431"><a href="#L-431"><span class="linenos"> 431</span></a>
</span><span id="L-432"><a href="#L-432"><span class="linenos"> 432</span></a><span class="sd">    patchWidth : tuple or list</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos"> 433</span></a><span class="sd">        The desired dimensions of the output patches.</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos"> 434</span></a>
</span><span id="L-435"><a href="#L-435"><span class="linenos"> 435</span></a><span class="sd">    Returns</span>
</span><span id="L-436"><a href="#L-436"><span class="linenos"> 436</span></a><span class="sd">    -------</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos"> 437</span></a><span class="sd">    tuple of ants.ANTsImage</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos"> 438</span></a><span class="sd">        A tuple containing two corresponding patches: (patch_from_img, patch_from_img2).</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos"> 439</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos"> 440</span></a>    <span class="n">mystd</span> <span class="o">=</span> <span class="n">mystd2</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos"> 441</span></a>    <span class="n">ct</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos"> 442</span></a>    <span class="k">while</span> <span class="n">mystd</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">mystd2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-443"><a href="#L-443"><span class="linenos"> 443</span></a>        <span class="n">inds</span> <span class="o">=</span> <span class="n">get_random_base_ind</span><span class="p">(</span> <span class="n">full_dims</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">patchWidth</span><span class="o">=</span><span class="n">patchWidth</span><span class="p">,</span> <span class="n">off</span><span class="o">=</span><span class="mi">8</span>  <span class="p">)</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos"> 444</span></a>        <span class="n">hinds</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">]</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos"> 445</span></a>        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">inds</span><span class="p">)):</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos"> 446</span></a>            <span class="n">hinds</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">inds</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="n">patchWidth</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos"> 447</span></a>        <span class="n">myimg</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">crop_indices</span><span class="p">(</span> <span class="n">img</span><span class="p">,</span> <span class="n">inds</span><span class="p">,</span> <span class="n">hinds</span> <span class="p">)</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos"> 448</span></a>        <span class="n">myimg2</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">crop_indices</span><span class="p">(</span> <span class="n">img2</span><span class="p">,</span> <span class="n">inds</span><span class="p">,</span> <span class="n">hinds</span> <span class="p">)</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos"> 449</span></a>        <span class="n">mystd</span> <span class="o">=</span> <span class="n">myimg</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos"> 450</span></a>        <span class="n">mystd2</span> <span class="o">=</span> <span class="n">myimg2</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos"> 451</span></a>        <span class="n">ct</span> <span class="o">=</span> <span class="n">ct</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos"> 452</span></a>        <span class="k">if</span> <span class="p">(</span> <span class="n">ct</span> <span class="o">&gt;</span> <span class="mi">20</span> <span class="p">):</span>
</span><span id="L-453"><a href="#L-453"><span class="linenos"> 453</span></a>            <span class="k">return</span> <span class="n">myimg</span><span class="p">,</span> <span class="n">myimg2</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos"> 454</span></a>    <span class="k">return</span> <span class="n">myimg</span><span class="p">,</span> <span class="n">myimg2</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos"> 455</span></a>
</span><span id="L-456"><a href="#L-456"><span class="linenos"> 456</span></a><span class="k">def</span> <span class="nf">pseudo_3d_vgg_features</span><span class="p">(</span> <span class="n">inshape</span> <span class="o">=</span> <span class="p">[</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">],</span> <span class="n">layer</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">pretrained</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span> <span class="p">):</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos"> 457</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-458"><a href="#L-458"><span class="linenos"> 458</span></a><span class="sd">    Creates a pseudo-3D VGG feature extractor from a pre-trained 2D VGG model.</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos"> 459</span></a>
</span><span id="L-460"><a href="#L-460"><span class="linenos"> 460</span></a><span class="sd">    This function constructs a 3D VGG-style network and initializes its weights</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos"> 461</span></a><span class="sd">    by &quot;stretching&quot; the weights from a pre-trained 2D VGG19 model (trained on</span>
</span><span id="L-462"><a href="#L-462"><span class="linenos"> 462</span></a><span class="sd">    ImageNet) along a specified axis. This is a technique to transfer 2D</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos"> 463</span></a><span class="sd">    perceptual knowledge to a 3D domain for tasks like perceptual loss.</span>
</span><span id="L-464"><a href="#L-464"><span class="linenos"> 464</span></a>
</span><span id="L-465"><a href="#L-465"><span class="linenos"> 465</span></a><span class="sd">    Parameters</span>
</span><span id="L-466"><a href="#L-466"><span class="linenos"> 466</span></a><span class="sd">    ----------</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos"> 467</span></a><span class="sd">    inshape : list of int, optional</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos"> 468</span></a><span class="sd">        The input shape of the 3D volume, e.g., `[128, 128, 128]`. Default is `[128,128,128]`.</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos"> 469</span></a>
</span><span id="L-470"><a href="#L-470"><span class="linenos"> 470</span></a><span class="sd">    layer : int, optional</span>
</span><span id="L-471"><a href="#L-471"><span class="linenos"> 471</span></a><span class="sd">        The block number of the VGG network from which to extract features. For</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos"> 472</span></a><span class="sd">        VGG19, this corresponds to block `layer` (e.g., layer=4 means &#39;block4_conv...&#39;).</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos"> 473</span></a><span class="sd">        Default is 4.</span>
</span><span id="L-474"><a href="#L-474"><span class="linenos"> 474</span></a>
</span><span id="L-475"><a href="#L-475"><span class="linenos"> 475</span></a><span class="sd">    angle : int, optional</span>
</span><span id="L-476"><a href="#L-476"><span class="linenos"> 476</span></a><span class="sd">        The axis along which to project the 2D weights:</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos"> 477</span></a><span class="sd">        - 0: Axial plane (stretches along Z)</span>
</span><span id="L-478"><a href="#L-478"><span class="linenos"> 478</span></a><span class="sd">        - 1: Coronal plane (stretches along Y)</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos"> 479</span></a><span class="sd">        - 2: Sagittal plane (stretches along X)</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos"> 480</span></a><span class="sd">        Default is 0.</span>
</span><span id="L-481"><a href="#L-481"><span class="linenos"> 481</span></a>
</span><span id="L-482"><a href="#L-482"><span class="linenos"> 482</span></a><span class="sd">    pretrained : bool, optional</span>
</span><span id="L-483"><a href="#L-483"><span class="linenos"> 483</span></a><span class="sd">        If True, loads the stretched ImageNet weights. If False, the model is</span>
</span><span id="L-484"><a href="#L-484"><span class="linenos"> 484</span></a><span class="sd">        randomly initialized. Default is True.</span>
</span><span id="L-485"><a href="#L-485"><span class="linenos"> 485</span></a>
</span><span id="L-486"><a href="#L-486"><span class="linenos"> 486</span></a><span class="sd">    verbose : bool, optional</span>
</span><span id="L-487"><a href="#L-487"><span class="linenos"> 487</span></a><span class="sd">        If True, prints information about the layers being used. Default is False.</span>
</span><span id="L-488"><a href="#L-488"><span class="linenos"> 488</span></a>
</span><span id="L-489"><a href="#L-489"><span class="linenos"> 489</span></a><span class="sd">    Returns</span>
</span><span id="L-490"><a href="#L-490"><span class="linenos"> 490</span></a><span class="sd">    -------</span>
</span><span id="L-491"><a href="#L-491"><span class="linenos"> 491</span></a><span class="sd">    tf.keras.Model</span>
</span><span id="L-492"><a href="#L-492"><span class="linenos"> 492</span></a><span class="sd">        A Keras model that takes a 3D volume as input and outputs the pseudo-3D</span>
</span><span id="L-493"><a href="#L-493"><span class="linenos"> 493</span></a><span class="sd">        feature map from the specified layer and angle.</span>
</span><span id="L-494"><a href="#L-494"><span class="linenos"> 494</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-495"><a href="#L-495"><span class="linenos"> 495</span></a>    <span class="k">def</span> <span class="nf">getLayerScaleFactorForTransferLearning</span><span class="p">(</span> <span class="n">k</span><span class="p">,</span> <span class="n">w3d</span><span class="p">,</span> <span class="n">w2d</span> <span class="p">):</span>
</span><span id="L-496"><a href="#L-496"><span class="linenos"> 496</span></a>        <span class="n">myfact</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span> <span class="n">w3d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span>  <span class="n">w2d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="p">)</span>
</span><span id="L-497"><a href="#L-497"><span class="linenos"> 497</span></a>        <span class="k">return</span> <span class="n">myfact</span>
</span><span id="L-498"><a href="#L-498"><span class="linenos"> 498</span></a>    <span class="n">vgg19</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">applications</span><span class="o">.</span><span class="n">VGG19</span><span class="p">(</span>
</span><span id="L-499"><a href="#L-499"><span class="linenos"> 499</span></a>            <span class="n">include_top</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">weights</span> <span class="o">=</span> <span class="s2">&quot;imagenet&quot;</span><span class="p">,</span>
</span><span id="L-500"><a href="#L-500"><span class="linenos"> 500</span></a>            <span class="n">input_shape</span> <span class="o">=</span> <span class="p">[</span><span class="n">inshape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">inshape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">3</span><span class="p">],</span>
</span><span id="L-501"><a href="#L-501"><span class="linenos"> 501</span></a>            <span class="n">classes</span> <span class="o">=</span> <span class="mi">1000</span> <span class="p">)</span>
</span><span id="L-502"><a href="#L-502"><span class="linenos"> 502</span></a>    <span class="k">def</span> <span class="nf">findLayerIndex</span><span class="p">(</span> <span class="n">layerName</span><span class="p">,</span> <span class="n">mdl</span> <span class="p">):</span>
</span><span id="L-503"><a href="#L-503"><span class="linenos"> 503</span></a>          <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">mdl</span><span class="o">.</span><span class="n">layers</span> <span class="p">)</span> <span class="p">):</span>
</span><span id="L-504"><a href="#L-504"><span class="linenos"> 504</span></a>            <span class="k">if</span> <span class="n">layerName</span> <span class="o">==</span> <span class="n">mdl</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">name</span> <span class="p">:</span>
</span><span id="L-505"><a href="#L-505"><span class="linenos"> 505</span></a>                <span class="k">return</span> <span class="n">k</span> <span class="o">-</span> <span class="mi">1</span>
</span><span id="L-506"><a href="#L-506"><span class="linenos"> 506</span></a>          <span class="k">return</span> <span class="kc">None</span>
</span><span id="L-507"><a href="#L-507"><span class="linenos"> 507</span></a>    <span class="n">layer_index</span> <span class="o">=</span> <span class="n">layer</span><span class="o">-</span><span class="mi">1</span> <span class="c1"># findLayerIndex( &#39;block2_conv2&#39;, vgg19 )</span>
</span><span id="L-508"><a href="#L-508"><span class="linenos"> 508</span></a>    <span class="n">vggmodelRaw</span> <span class="o">=</span> <span class="n">antspynet</span><span class="o">.</span><span class="n">create_vgg_model_3d</span><span class="p">(</span>
</span><span id="L-509"><a href="#L-509"><span class="linenos"> 509</span></a>            <span class="p">[</span><span class="n">inshape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">inshape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">inshape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="mi">1</span><span class="p">],</span>
</span><span id="L-510"><a href="#L-510"><span class="linenos"> 510</span></a>            <span class="n">number_of_classification_labels</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
</span><span id="L-511"><a href="#L-511"><span class="linenos"> 511</span></a>            <span class="n">layers</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span>
</span><span id="L-512"><a href="#L-512"><span class="linenos"> 512</span></a>            <span class="n">lowest_resolution</span> <span class="o">=</span> <span class="mi">64</span><span class="p">,</span>
</span><span id="L-513"><a href="#L-513"><span class="linenos"> 513</span></a>            <span class="n">convolution_kernel_size</span><span class="o">=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">pool_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
</span><span id="L-514"><a href="#L-514"><span class="linenos"> 514</span></a>            <span class="n">strides</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">number_of_dense_units</span><span class="o">=</span> <span class="mi">4096</span><span class="p">,</span> <span class="n">dropout_rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="L-515"><a href="#L-515"><span class="linenos"> 515</span></a>            <span class="n">style</span> <span class="o">=</span> <span class="mi">19</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;classification&quot;</span><span class="p">)</span>
</span><span id="L-516"><a href="#L-516"><span class="linenos"> 516</span></a>    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-517"><a href="#L-517"><span class="linenos"> 517</span></a>        <span class="nb">print</span><span class="p">(</span> <span class="n">vggmodelRaw</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">layer_index</span><span class="p">]</span> <span class="p">)</span>
</span><span id="L-518"><a href="#L-518"><span class="linenos"> 518</span></a>        <span class="nb">print</span><span class="p">(</span> <span class="n">vggmodelRaw</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">layer_index</span><span class="p">]</span><span class="o">.</span><span class="n">name</span> <span class="p">)</span>
</span><span id="L-519"><a href="#L-519"><span class="linenos"> 519</span></a>        <span class="nb">print</span><span class="p">(</span> <span class="n">vgg19</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">layer_index</span><span class="p">]</span> <span class="p">)</span>
</span><span id="L-520"><a href="#L-520"><span class="linenos"> 520</span></a>        <span class="nb">print</span><span class="p">(</span> <span class="n">vgg19</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">layer_index</span><span class="p">]</span><span class="o">.</span><span class="n">name</span> <span class="p">)</span>
</span><span id="L-521"><a href="#L-521"><span class="linenos"> 521</span></a>    <span class="n">feature_extractor_2d</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span>
</span><span id="L-522"><a href="#L-522"><span class="linenos"> 522</span></a>            <span class="n">inputs</span> <span class="o">=</span> <span class="n">vgg19</span><span class="o">.</span><span class="n">input</span><span class="p">,</span>
</span><span id="L-523"><a href="#L-523"><span class="linenos"> 523</span></a>            <span class="n">outputs</span> <span class="o">=</span> <span class="n">vgg19</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">layer_index</span><span class="p">]</span><span class="o">.</span><span class="n">output</span><span class="p">)</span>
</span><span id="L-524"><a href="#L-524"><span class="linenos"> 524</span></a>    <span class="n">feature_extractor</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span>
</span><span id="L-525"><a href="#L-525"><span class="linenos"> 525</span></a>            <span class="n">inputs</span> <span class="o">=</span> <span class="n">vggmodelRaw</span><span class="o">.</span><span class="n">input</span><span class="p">,</span>
</span><span id="L-526"><a href="#L-526"><span class="linenos"> 526</span></a>            <span class="n">outputs</span> <span class="o">=</span> <span class="n">vggmodelRaw</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">layer_index</span><span class="p">]</span><span class="o">.</span><span class="n">output</span><span class="p">)</span>
</span><span id="L-527"><a href="#L-527"><span class="linenos"> 527</span></a>    <span class="n">wts_2d</span> <span class="o">=</span> <span class="n">feature_extractor_2d</span><span class="o">.</span><span class="n">weights</span>
</span><span id="L-528"><a href="#L-528"><span class="linenos"> 528</span></a>    <span class="n">wts</span> <span class="o">=</span> <span class="n">feature_extractor</span><span class="o">.</span><span class="n">weights</span>
</span><span id="L-529"><a href="#L-529"><span class="linenos"> 529</span></a>    <span class="k">def</span> <span class="nf">checkwtshape</span><span class="p">(</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="p">):</span>
</span><span id="L-530"><a href="#L-530"><span class="linenos"> 530</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">):</span>
</span><span id="L-531"><a href="#L-531"><span class="linenos"> 531</span></a>                <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-532"><a href="#L-532"><span class="linenos"> 532</span></a>        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">)):</span>
</span><span id="L-533"><a href="#L-533"><span class="linenos"> 533</span></a>            <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">!=</span> <span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
</span><span id="L-534"><a href="#L-534"><span class="linenos"> 534</span></a>                <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-535"><a href="#L-535"><span class="linenos"> 535</span></a>        <span class="k">return</span> <span class="kc">True</span>
</span><span id="L-536"><a href="#L-536"><span class="linenos"> 536</span></a>    <span class="k">for</span> <span class="n">ww</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">wts</span><span class="p">)):</span>
</span><span id="L-537"><a href="#L-537"><span class="linenos"> 537</span></a>        <span class="n">wts</span><span class="p">[</span><span class="n">ww</span><span class="p">]</span><span class="o">=</span><span class="n">wts</span><span class="p">[</span><span class="n">ww</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="L-538"><a href="#L-538"><span class="linenos"> 538</span></a>        <span class="n">wts_2d</span><span class="p">[</span><span class="n">ww</span><span class="p">]</span><span class="o">=</span><span class="n">wts_2d</span><span class="p">[</span><span class="n">ww</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="L-539"><a href="#L-539"><span class="linenos"> 539</span></a>        <span class="k">if</span> <span class="n">checkwtshape</span><span class="p">(</span> <span class="n">wts</span><span class="p">[</span><span class="n">ww</span><span class="p">],</span> <span class="n">wts_2d</span><span class="p">[</span><span class="n">ww</span><span class="p">]</span> <span class="p">)</span> <span class="ow">and</span> <span class="n">ww</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-540"><a href="#L-540"><span class="linenos"> 540</span></a>            <span class="n">wts</span><span class="p">[</span><span class="n">ww</span><span class="p">]</span><span class="o">=</span><span class="n">wts_2d</span><span class="p">[</span><span class="n">ww</span><span class="p">]</span>
</span><span id="L-541"><a href="#L-541"><span class="linenos"> 541</span></a>        <span class="k">elif</span> <span class="n">ww</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-542"><a href="#L-542"><span class="linenos"> 542</span></a>            <span class="c1"># FIXME - should allow doing this across different angles</span>
</span><span id="L-543"><a href="#L-543"><span class="linenos"> 543</span></a>            <span class="k">if</span> <span class="n">angle</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-544"><a href="#L-544"><span class="linenos"> 544</span></a>                <span class="n">wts</span><span class="p">[</span><span class="n">ww</span><span class="p">][:,:,</span><span class="mi">0</span><span class="p">,:,:]</span><span class="o">=</span><span class="n">wts_2d</span><span class="p">[</span><span class="n">ww</span><span class="p">]</span><span class="o">/</span><span class="mf">3.0</span>
</span><span id="L-545"><a href="#L-545"><span class="linenos"> 545</span></a>                <span class="n">wts</span><span class="p">[</span><span class="n">ww</span><span class="p">][:,:,</span><span class="mi">1</span><span class="p">,:,:]</span><span class="o">=</span><span class="n">wts_2d</span><span class="p">[</span><span class="n">ww</span><span class="p">]</span><span class="o">/</span><span class="mf">3.0</span>
</span><span id="L-546"><a href="#L-546"><span class="linenos"> 546</span></a>                <span class="n">wts</span><span class="p">[</span><span class="n">ww</span><span class="p">][:,:,</span><span class="mi">2</span><span class="p">,:,:]</span><span class="o">=</span><span class="n">wts_2d</span><span class="p">[</span><span class="n">ww</span><span class="p">]</span><span class="o">/</span><span class="mf">3.0</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos"> 547</span></a>            <span class="k">if</span> <span class="n">angle</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-548"><a href="#L-548"><span class="linenos"> 548</span></a>                <span class="n">wts</span><span class="p">[</span><span class="n">ww</span><span class="p">][:,</span><span class="mi">0</span><span class="p">,:,:,:]</span><span class="o">=</span><span class="n">wts_2d</span><span class="p">[</span><span class="n">ww</span><span class="p">]</span><span class="o">/</span><span class="mf">3.0</span>
</span><span id="L-549"><a href="#L-549"><span class="linenos"> 549</span></a>                <span class="n">wts</span><span class="p">[</span><span class="n">ww</span><span class="p">][:,</span><span class="mi">1</span><span class="p">,:,:,:]</span><span class="o">=</span><span class="n">wts_2d</span><span class="p">[</span><span class="n">ww</span><span class="p">]</span><span class="o">/</span><span class="mf">3.0</span>
</span><span id="L-550"><a href="#L-550"><span class="linenos"> 550</span></a>                <span class="n">wts</span><span class="p">[</span><span class="n">ww</span><span class="p">][:,</span><span class="mi">2</span><span class="p">,:,:,:]</span><span class="o">=</span><span class="n">wts_2d</span><span class="p">[</span><span class="n">ww</span><span class="p">]</span><span class="o">/</span><span class="mf">3.0</span>
</span><span id="L-551"><a href="#L-551"><span class="linenos"> 551</span></a>            <span class="k">if</span> <span class="n">angle</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-552"><a href="#L-552"><span class="linenos"> 552</span></a>                <span class="n">wts</span><span class="p">[</span><span class="n">ww</span><span class="p">][</span><span class="mi">0</span><span class="p">,:,:,:,:]</span><span class="o">=</span><span class="n">wts_2d</span><span class="p">[</span><span class="n">ww</span><span class="p">]</span><span class="o">/</span><span class="mf">3.0</span>
</span><span id="L-553"><a href="#L-553"><span class="linenos"> 553</span></a>                <span class="n">wts</span><span class="p">[</span><span class="n">ww</span><span class="p">][</span><span class="mi">1</span><span class="p">,:,:,:,:]</span><span class="o">=</span><span class="n">wts_2d</span><span class="p">[</span><span class="n">ww</span><span class="p">]</span><span class="o">/</span><span class="mf">3.0</span>
</span><span id="L-554"><a href="#L-554"><span class="linenos"> 554</span></a>                <span class="n">wts</span><span class="p">[</span><span class="n">ww</span><span class="p">][</span><span class="mi">2</span><span class="p">,:,:,:,:]</span><span class="o">=</span><span class="n">wts_2d</span><span class="p">[</span><span class="n">ww</span><span class="p">]</span><span class="o">/</span><span class="mf">3.0</span>
</span><span id="L-555"><a href="#L-555"><span class="linenos"> 555</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-556"><a href="#L-556"><span class="linenos"> 556</span></a>            <span class="n">wts</span><span class="p">[</span><span class="n">ww</span><span class="p">][:,:,:,</span><span class="mi">0</span><span class="p">,:]</span><span class="o">=</span><span class="n">wts_2d</span><span class="p">[</span><span class="n">ww</span><span class="p">]</span>
</span><span id="L-557"><a href="#L-557"><span class="linenos"> 557</span></a>    <span class="k">if</span> <span class="n">pretrained</span><span class="p">:</span>
</span><span id="L-558"><a href="#L-558"><span class="linenos"> 558</span></a>        <span class="n">feature_extractor</span><span class="o">.</span><span class="n">set_weights</span><span class="p">(</span> <span class="n">wts</span> <span class="p">)</span>
</span><span id="L-559"><a href="#L-559"><span class="linenos"> 559</span></a>        <span class="n">newinput</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Rescaling</span><span class="p">(</span>  <span class="mf">255.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">127.5</span>  <span class="p">)(</span> <span class="n">feature_extractor</span><span class="o">.</span><span class="n">input</span> <span class="p">)</span>
</span><span id="L-560"><a href="#L-560"><span class="linenos"> 560</span></a>        <span class="n">feature_extractor2</span> <span class="o">=</span> <span class="n">feature_extractor</span><span class="p">(</span> <span class="n">newinput</span> <span class="p">)</span>
</span><span id="L-561"><a href="#L-561"><span class="linenos"> 561</span></a>        <span class="n">feature_extractor</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span> <span class="n">feature_extractor</span><span class="o">.</span><span class="n">input</span><span class="p">,</span> <span class="n">feature_extractor2</span> <span class="p">)</span>
</span><span id="L-562"><a href="#L-562"><span class="linenos"> 562</span></a>    <span class="k">return</span> <span class="n">feature_extractor</span>
</span><span id="L-563"><a href="#L-563"><span class="linenos"> 563</span></a>
</span><span id="L-564"><a href="#L-564"><span class="linenos"> 564</span></a><span class="k">def</span> <span class="nf">pseudo_3d_vgg_features_unbiased</span><span class="p">(</span> <span class="n">inshape</span> <span class="o">=</span> <span class="p">[</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">],</span> <span class="n">layer</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span> <span class="p">):</span>
</span><span id="L-565"><a href="#L-565"><span class="linenos"> 565</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-566"><a href="#L-566"><span class="linenos"> 566</span></a><span class="sd">    Create a pseudo-3D VGG-style feature extractor by aggregating axial, coronal,</span>
</span><span id="L-567"><a href="#L-567"><span class="linenos"> 567</span></a><span class="sd">    and sagittal VGG feature representations.</span>
</span><span id="L-568"><a href="#L-568"><span class="linenos"> 568</span></a>
</span><span id="L-569"><a href="#L-569"><span class="linenos"> 569</span></a><span class="sd">    This model extracts features along each principal axis using pre-trained 2D</span>
</span><span id="L-570"><a href="#L-570"><span class="linenos"> 570</span></a><span class="sd">    VGG-style networks and concatenates them to form an unbiased pseudo-3D feature space.</span>
</span><span id="L-571"><a href="#L-571"><span class="linenos"> 571</span></a>
</span><span id="L-572"><a href="#L-572"><span class="linenos"> 572</span></a><span class="sd">    Parameters</span>
</span><span id="L-573"><a href="#L-573"><span class="linenos"> 573</span></a><span class="sd">    ----------</span>
</span><span id="L-574"><a href="#L-574"><span class="linenos"> 574</span></a><span class="sd">    inshape : list of int, optional</span>
</span><span id="L-575"><a href="#L-575"><span class="linenos"> 575</span></a><span class="sd">        The input shape of the 3D volume, default is [128, 128, 128].</span>
</span><span id="L-576"><a href="#L-576"><span class="linenos"> 576</span></a>
</span><span id="L-577"><a href="#L-577"><span class="linenos"> 577</span></a><span class="sd">    layer : int, optional</span>
</span><span id="L-578"><a href="#L-578"><span class="linenos"> 578</span></a><span class="sd">        The VGG feature layer to extract. Higher values correspond to deeper</span>
</span><span id="L-579"><a href="#L-579"><span class="linenos"> 579</span></a><span class="sd">        layers in the pseudo-3D VGG backbone.</span>
</span><span id="L-580"><a href="#L-580"><span class="linenos"> 580</span></a>
</span><span id="L-581"><a href="#L-581"><span class="linenos"> 581</span></a><span class="sd">    verbose : bool, optional</span>
</span><span id="L-582"><a href="#L-582"><span class="linenos"> 582</span></a><span class="sd">        If True, prints debug messages during model construction.</span>
</span><span id="L-583"><a href="#L-583"><span class="linenos"> 583</span></a>
</span><span id="L-584"><a href="#L-584"><span class="linenos"> 584</span></a><span class="sd">    Returns</span>
</span><span id="L-585"><a href="#L-585"><span class="linenos"> 585</span></a><span class="sd">    -------</span>
</span><span id="L-586"><a href="#L-586"><span class="linenos"> 586</span></a><span class="sd">    tf.keras.Model</span>
</span><span id="L-587"><a href="#L-587"><span class="linenos"> 587</span></a><span class="sd">        A TensorFlow Keras model that takes a 3D input volume and outputs the</span>
</span><span id="L-588"><a href="#L-588"><span class="linenos"> 588</span></a><span class="sd">        concatenated pseudo-3D feature representation from the specified layer.</span>
</span><span id="L-589"><a href="#L-589"><span class="linenos"> 589</span></a>
</span><span id="L-590"><a href="#L-590"><span class="linenos"> 590</span></a><span class="sd">    Notes</span>
</span><span id="L-591"><a href="#L-591"><span class="linenos"> 591</span></a><span class="sd">    -----</span>
</span><span id="L-592"><a href="#L-592"><span class="linenos"> 592</span></a><span class="sd">    This is useful for perceptual loss or feature comparison in super-resolution</span>
</span><span id="L-593"><a href="#L-593"><span class="linenos"> 593</span></a><span class="sd">    and image synthesis tasks. The same input is processed in three anatomical</span>
</span><span id="L-594"><a href="#L-594"><span class="linenos"> 594</span></a><span class="sd">    planes (axial, coronal, sagittal), and features are concatenated.</span>
</span><span id="L-595"><a href="#L-595"><span class="linenos"> 595</span></a>
</span><span id="L-596"><a href="#L-596"><span class="linenos"> 596</span></a><span class="sd">    See Also</span>
</span><span id="L-597"><a href="#L-597"><span class="linenos"> 597</span></a><span class="sd">    --------</span>
</span><span id="L-598"><a href="#L-598"><span class="linenos"> 598</span></a><span class="sd">    pseudo_3d_vgg_features : Generates VGG features from a single anatomical plane.</span>
</span><span id="L-599"><a href="#L-599"><span class="linenos"> 599</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-600"><a href="#L-600"><span class="linenos"> 600</span></a>    <span class="n">f</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-601"><a href="#L-601"><span class="linenos"> 601</span></a>        <span class="n">pseudo_3d_vgg_features</span><span class="p">(</span> <span class="n">inshape</span><span class="p">,</span> <span class="n">layer</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">pretrained</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span> <span class="p">),</span>
</span><span id="L-602"><a href="#L-602"><span class="linenos"> 602</span></a>        <span class="n">pseudo_3d_vgg_features</span><span class="p">(</span> <span class="n">inshape</span><span class="p">,</span> <span class="n">layer</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">pretrained</span><span class="o">=</span><span class="kc">True</span> <span class="p">),</span>
</span><span id="L-603"><a href="#L-603"><span class="linenos"> 603</span></a>        <span class="n">pseudo_3d_vgg_features</span><span class="p">(</span> <span class="n">inshape</span><span class="p">,</span> <span class="n">layer</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">pretrained</span><span class="o">=</span><span class="kc">True</span> <span class="p">)</span> <span class="p">]</span>
</span><span id="L-604"><a href="#L-604"><span class="linenos"> 604</span></a>    <span class="n">f1</span><span class="o">=</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">inputs</span>
</span><span id="L-605"><a href="#L-605"><span class="linenos"> 605</span></a>    <span class="n">f0o</span><span class="o">=</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">](</span> <span class="n">f1</span> <span class="p">)</span>
</span><span id="L-606"><a href="#L-606"><span class="linenos"> 606</span></a>    <span class="n">f1o</span><span class="o">=</span><span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">](</span> <span class="n">f1</span> <span class="p">)</span>
</span><span id="L-607"><a href="#L-607"><span class="linenos"> 607</span></a>    <span class="n">f2o</span><span class="o">=</span><span class="n">f</span><span class="p">[</span><span class="mi">2</span><span class="p">](</span> <span class="n">f1</span> <span class="p">)</span>
</span><span id="L-608"><a href="#L-608"><span class="linenos"> 608</span></a>    <span class="n">catter</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span> <span class="p">[</span><span class="n">f0o</span><span class="p">,</span> <span class="n">f1o</span><span class="p">,</span> <span class="n">f2o</span> <span class="p">])</span>
</span><span id="L-609"><a href="#L-609"><span class="linenos"> 609</span></a>    <span class="n">feature_extractor</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span> <span class="n">f1</span><span class="p">,</span> <span class="n">catter</span> <span class="p">)</span>
</span><span id="L-610"><a href="#L-610"><span class="linenos"> 610</span></a>    <span class="k">return</span> <span class="n">feature_extractor</span>
</span><span id="L-611"><a href="#L-611"><span class="linenos"> 611</span></a>
</span><span id="L-612"><a href="#L-612"><span class="linenos"> 612</span></a><span class="k">def</span> <span class="nf">get_grader_feature_network</span><span class="p">(</span> <span class="n">layer</span><span class="o">=</span><span class="mi">6</span> <span class="p">):</span>
</span><span id="L-613"><a href="#L-613"><span class="linenos"> 613</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-614"><a href="#L-614"><span class="linenos"> 614</span></a><span class="sd">    Load and extract a ResNet-based feature subnetwork for perceptual loss or quality grading.</span>
</span><span id="L-615"><a href="#L-615"><span class="linenos"> 615</span></a>
</span><span id="L-616"><a href="#L-616"><span class="linenos"> 616</span></a><span class="sd">    This function loads a pre-trained 3D ResNet model (&quot;grader&quot;) used for</span>
</span><span id="L-617"><a href="#L-617"><span class="linenos"> 617</span></a><span class="sd">    perceptual feature extraction and returns a subnetwork that outputs activations</span>
</span><span id="L-618"><a href="#L-618"><span class="linenos"> 618</span></a><span class="sd">    from a specified internal layer.</span>
</span><span id="L-619"><a href="#L-619"><span class="linenos"> 619</span></a>
</span><span id="L-620"><a href="#L-620"><span class="linenos"> 620</span></a><span class="sd">    Parameters</span>
</span><span id="L-621"><a href="#L-621"><span class="linenos"> 621</span></a><span class="sd">    ----------</span>
</span><span id="L-622"><a href="#L-622"><span class="linenos"> 622</span></a><span class="sd">    layer : int, optional</span>
</span><span id="L-623"><a href="#L-623"><span class="linenos"> 623</span></a><span class="sd">        The index of the internal ResNet layer whose output should be used as</span>
</span><span id="L-624"><a href="#L-624"><span class="linenos"> 624</span></a><span class="sd">        the feature representation. Default is layer 6.</span>
</span><span id="L-625"><a href="#L-625"><span class="linenos"> 625</span></a>
</span><span id="L-626"><a href="#L-626"><span class="linenos"> 626</span></a><span class="sd">    Returns</span>
</span><span id="L-627"><a href="#L-627"><span class="linenos"> 627</span></a><span class="sd">    -------</span>
</span><span id="L-628"><a href="#L-628"><span class="linenos"> 628</span></a><span class="sd">    tf.keras.Model</span>
</span><span id="L-629"><a href="#L-629"><span class="linenos"> 629</span></a><span class="sd">        A Keras model that outputs features from the specified layer of the</span>
</span><span id="L-630"><a href="#L-630"><span class="linenos"> 630</span></a><span class="sd">        pre-trained 3D ResNet grader model.</span>
</span><span id="L-631"><a href="#L-631"><span class="linenos"> 631</span></a>
</span><span id="L-632"><a href="#L-632"><span class="linenos"> 632</span></a><span class="sd">    Raises</span>
</span><span id="L-633"><a href="#L-633"><span class="linenos"> 633</span></a><span class="sd">    ------</span>
</span><span id="L-634"><a href="#L-634"><span class="linenos"> 634</span></a><span class="sd">    Exception</span>
</span><span id="L-635"><a href="#L-635"><span class="linenos"> 635</span></a><span class="sd">        If the pre-trained weights file (`resnet_grader.h5`) is not found.</span>
</span><span id="L-636"><a href="#L-636"><span class="linenos"> 636</span></a>
</span><span id="L-637"><a href="#L-637"><span class="linenos"> 637</span></a><span class="sd">    Notes</span>
</span><span id="L-638"><a href="#L-638"><span class="linenos"> 638</span></a><span class="sd">    -----</span>
</span><span id="L-639"><a href="#L-639"><span class="linenos"> 639</span></a><span class="sd">    The pre-trained weights should be located in: `~/.antspyt1w/resnet_grader.keras`</span>
</span><span id="L-640"><a href="#L-640"><span class="linenos"> 640</span></a>
</span><span id="L-641"><a href="#L-641"><span class="linenos"> 641</span></a><span class="sd">    This model is typically used to compute perceptual loss by comparing</span>
</span><span id="L-642"><a href="#L-642"><span class="linenos"> 642</span></a><span class="sd">    intermediate activations between target and prediction volumes.</span>
</span><span id="L-643"><a href="#L-643"><span class="linenos"> 643</span></a>
</span><span id="L-644"><a href="#L-644"><span class="linenos"> 644</span></a><span class="sd">    See Also</span>
</span><span id="L-645"><a href="#L-645"><span class="linenos"> 645</span></a><span class="sd">    --------</span>
</span><span id="L-646"><a href="#L-646"><span class="linenos"> 646</span></a><span class="sd">    antspynet.create_resnet_model_3d : Constructs the base ResNet model.</span>
</span><span id="L-647"><a href="#L-647"><span class="linenos"> 647</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-648"><a href="#L-648"><span class="linenos"> 648</span></a>    <span class="n">grader</span> <span class="o">=</span> <span class="n">antspynet</span><span class="o">.</span><span class="n">create_resnet_model_3d</span><span class="p">(</span>
</span><span id="L-649"><a href="#L-649"><span class="linenos"> 649</span></a>        <span class="p">[</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
</span><span id="L-650"><a href="#L-650"><span class="linenos"> 650</span></a>        <span class="n">lowest_resolution</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
</span><span id="L-651"><a href="#L-651"><span class="linenos"> 651</span></a>        <span class="n">number_of_outputs</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
</span><span id="L-652"><a href="#L-652"><span class="linenos"> 652</span></a>        <span class="n">cardinality</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="L-653"><a href="#L-653"><span class="linenos"> 653</span></a>        <span class="n">squeeze_and_excite</span> <span class="o">=</span> <span class="kc">False</span> <span class="p">)</span>
</span><span id="L-654"><a href="#L-654"><span class="linenos"> 654</span></a>    <span class="c1"># the folder and data below as available from antspyt1w get_data</span>
</span><span id="L-655"><a href="#L-655"><span class="linenos"> 655</span></a>    <span class="n">graderfn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span> <span class="s2">&quot;~/.antspyt1w/resnet_grader.h5&quot;</span> <span class="p">)</span>
</span><span id="L-656"><a href="#L-656"><span class="linenos"> 656</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span> <span class="n">graderfn</span> <span class="p">):</span>
</span><span id="L-657"><a href="#L-657"><span class="linenos"> 657</span></a>        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;graderfn &quot;</span> <span class="o">+</span> <span class="n">graderfn</span> <span class="o">+</span> <span class="s2">&quot; does not exist&quot;</span><span class="p">)</span>
</span><span id="L-658"><a href="#L-658"><span class="linenos"> 658</span></a>    <span class="n">grader</span><span class="o">.</span><span class="n">load_weights</span><span class="p">(</span> <span class="n">graderfn</span><span class="p">)</span>
</span><span id="L-659"><a href="#L-659"><span class="linenos"> 659</span></a>    <span class="c1">#    feature_extractor_23 = tf.keras.Model( inputs=grader.inputs, outputs=grader.layers[23].output )</span>
</span><span id="L-660"><a href="#L-660"><span class="linenos"> 660</span></a>    <span class="c1">#   feature_extractor_44 = tf.keras.Model( inputs=grader.inputs, outputs=grader.layers[44].output )</span>
</span><span id="L-661"><a href="#L-661"><span class="linenos"> 661</span></a>    <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span> <span class="n">inputs</span><span class="o">=</span><span class="n">grader</span><span class="o">.</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">grader</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">layer</span><span class="p">]</span><span class="o">.</span><span class="n">output</span> <span class="p">)</span>
</span><span id="L-662"><a href="#L-662"><span class="linenos"> 662</span></a>
</span><span id="L-663"><a href="#L-663"><span class="linenos"> 663</span></a>
</span><span id="L-664"><a href="#L-664"><span class="linenos"> 664</span></a><span class="k">def</span> <span class="nf">default_dbpn</span><span class="p">(</span>
</span><span id="L-665"><a href="#L-665"><span class="linenos"> 665</span></a>    <span class="n">strider</span><span class="p">,</span> <span class="c1"># length should equal dimensionality</span>
</span><span id="L-666"><a href="#L-666"><span class="linenos"> 666</span></a>    <span class="n">dimensionality</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
</span><span id="L-667"><a href="#L-667"><span class="linenos"> 667</span></a>    <span class="n">nfilt</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>
</span><span id="L-668"><a href="#L-668"><span class="linenos"> 668</span></a>    <span class="n">nff</span> <span class="o">=</span> <span class="mi">256</span><span class="p">,</span>
</span><span id="L-669"><a href="#L-669"><span class="linenos"> 669</span></a>    <span class="n">convn</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
</span><span id="L-670"><a href="#L-670"><span class="linenos"> 670</span></a>    <span class="n">lastconv</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
</span><span id="L-671"><a href="#L-671"><span class="linenos"> 671</span></a>    <span class="n">nbp</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>
</span><span id="L-672"><a href="#L-672"><span class="linenos"> 672</span></a>    <span class="n">nChannelsIn</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="L-673"><a href="#L-673"><span class="linenos"> 673</span></a>    <span class="n">nChannelsOut</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="L-674"><a href="#L-674"><span class="linenos"> 674</span></a>    <span class="n">option</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-675"><a href="#L-675"><span class="linenos"> 675</span></a>    <span class="n">intensity_model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-676"><a href="#L-676"><span class="linenos"> 676</span></a>    <span class="n">segmentation_model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-677"><a href="#L-677"><span class="linenos"> 677</span></a>    <span class="n">sigmoid_second_channel</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-678"><a href="#L-678"><span class="linenos"> 678</span></a>    <span class="n">clone_intensity_to_segmentation</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-679"><a href="#L-679"><span class="linenos"> 679</span></a>    <span class="n">pro_seg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="L-680"><a href="#L-680"><span class="linenos"> 680</span></a>    <span class="n">freeze</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-681"><a href="#L-681"><span class="linenos"> 681</span></a>    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span>
</span><span id="L-682"><a href="#L-682"><span class="linenos"> 682</span></a> <span class="p">):</span>
</span><span id="L-683"><a href="#L-683"><span class="linenos"> 683</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-684"><a href="#L-684"><span class="linenos"> 684</span></a><span class="sd">    Constructs a DBPN model based on input parameters, and can optionally</span>
</span><span id="L-685"><a href="#L-685"><span class="linenos"> 685</span></a><span class="sd">    use external models for intensity or segmentation processing.</span>
</span><span id="L-686"><a href="#L-686"><span class="linenos"> 686</span></a>
</span><span id="L-687"><a href="#L-687"><span class="linenos"> 687</span></a><span class="sd">    Args:</span>
</span><span id="L-688"><a href="#L-688"><span class="linenos"> 688</span></a><span class="sd">        strider (list): List of strides, length must match `dimensionality`.</span>
</span><span id="L-689"><a href="#L-689"><span class="linenos"> 689</span></a><span class="sd">        dimensionality (int): Number of dimensions (2 or 3). Default is 3.</span>
</span><span id="L-690"><a href="#L-690"><span class="linenos"> 690</span></a><span class="sd">        nfilt (int): Number of base filters. Default is 64.</span>
</span><span id="L-691"><a href="#L-691"><span class="linenos"> 691</span></a><span class="sd">        nff (int): Number of feature filters. Default is 256.</span>
</span><span id="L-692"><a href="#L-692"><span class="linenos"> 692</span></a><span class="sd">        convn (int): Convolution kernel size. Default is 6.</span>
</span><span id="L-693"><a href="#L-693"><span class="linenos"> 693</span></a><span class="sd">        lastconv (int): Size of the last convolution. Default is 3.</span>
</span><span id="L-694"><a href="#L-694"><span class="linenos"> 694</span></a><span class="sd">        nbp (int): Number of back projection stages. Default is 7.</span>
</span><span id="L-695"><a href="#L-695"><span class="linenos"> 695</span></a><span class="sd">        nChannelsIn (int): Number of input channels. Default is 1.</span>
</span><span id="L-696"><a href="#L-696"><span class="linenos"> 696</span></a><span class="sd">        nChannelsOut (int): Number of output channels. Default is 1.</span>
</span><span id="L-697"><a href="#L-697"><span class="linenos"> 697</span></a><span class="sd">        option (str): Model size option (&#39;tiny&#39;, &#39;small&#39;, &#39;medium&#39;, &#39;large&#39;). Default is None.</span>
</span><span id="L-698"><a href="#L-698"><span class="linenos"> 698</span></a><span class="sd">        intensity_model (tf.keras.Model): Optional external intensity model.</span>
</span><span id="L-699"><a href="#L-699"><span class="linenos"> 699</span></a><span class="sd">        segmentation_model (tf.keras.Model): Optional external segmentation model.</span>
</span><span id="L-700"><a href="#L-700"><span class="linenos"> 700</span></a><span class="sd">        sigmoid_second_channel (bool): If True, applies sigmoid to second channel in output.</span>
</span><span id="L-701"><a href="#L-701"><span class="linenos"> 701</span></a><span class="sd">        clone_intensity_to_segmentation (bool): If True, clones intensity model weights to segmentation.</span>
</span><span id="L-702"><a href="#L-702"><span class="linenos"> 702</span></a><span class="sd">        pro_seg (int): If greater than 0, adds a segmentation arm.</span>
</span><span id="L-703"><a href="#L-703"><span class="linenos"> 703</span></a><span class="sd">        freeze (bool): If True, freezes the layers of the intensity/segmentation models.</span>
</span><span id="L-704"><a href="#L-704"><span class="linenos"> 704</span></a><span class="sd">        verbose (bool): If True, prints detailed logs.</span>
</span><span id="L-705"><a href="#L-705"><span class="linenos"> 705</span></a>
</span><span id="L-706"><a href="#L-706"><span class="linenos"> 706</span></a><span class="sd">    Returns:</span>
</span><span id="L-707"><a href="#L-707"><span class="linenos"> 707</span></a><span class="sd">        Model: A Keras model based on the specified configuration.</span>
</span><span id="L-708"><a href="#L-708"><span class="linenos"> 708</span></a>
</span><span id="L-709"><a href="#L-709"><span class="linenos"> 709</span></a><span class="sd">    Raises:</span>
</span><span id="L-710"><a href="#L-710"><span class="linenos"> 710</span></a><span class="sd">        Exception: If `len(strider)` is not equal to `dimensionality`.</span>
</span><span id="L-711"><a href="#L-711"><span class="linenos"> 711</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-712"><a href="#L-712"><span class="linenos"> 712</span></a>    <span class="k">if</span> <span class="n">option</span> <span class="o">==</span> <span class="s1">&#39;tiny&#39;</span><span class="p">:</span>
</span><span id="L-713"><a href="#L-713"><span class="linenos"> 713</span></a>        <span class="n">nfilt</span><span class="o">=</span><span class="mi">32</span>
</span><span id="L-714"><a href="#L-714"><span class="linenos"> 714</span></a>        <span class="n">nff</span> <span class="o">=</span> <span class="mi">64</span>
</span><span id="L-715"><a href="#L-715"><span class="linenos"> 715</span></a>        <span class="n">convn</span> <span class="o">=</span> <span class="mi">3</span>
</span><span id="L-716"><a href="#L-716"><span class="linenos"> 716</span></a>        <span class="n">lastconv</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-717"><a href="#L-717"><span class="linenos"> 717</span></a>        <span class="n">nbp</span><span class="o">=</span><span class="mi">2</span>
</span><span id="L-718"><a href="#L-718"><span class="linenos"> 718</span></a>    <span class="k">elif</span> <span class="n">option</span> <span class="o">==</span> <span class="s1">&#39;small&#39;</span><span class="p">:</span>
</span><span id="L-719"><a href="#L-719"><span class="linenos"> 719</span></a>        <span class="n">nfilt</span><span class="o">=</span><span class="mi">32</span>
</span><span id="L-720"><a href="#L-720"><span class="linenos"> 720</span></a>        <span class="n">nff</span> <span class="o">=</span> <span class="mi">64</span>
</span><span id="L-721"><a href="#L-721"><span class="linenos"> 721</span></a>        <span class="n">convn</span> <span class="o">=</span> <span class="mi">6</span>
</span><span id="L-722"><a href="#L-722"><span class="linenos"> 722</span></a>        <span class="n">lastconv</span> <span class="o">=</span> <span class="mi">3</span>
</span><span id="L-723"><a href="#L-723"><span class="linenos"> 723</span></a>        <span class="n">nbp</span><span class="o">=</span><span class="mi">4</span>
</span><span id="L-724"><a href="#L-724"><span class="linenos"> 724</span></a>    <span class="k">elif</span> <span class="n">option</span> <span class="o">==</span> <span class="s1">&#39;medium&#39;</span><span class="p">:</span>
</span><span id="L-725"><a href="#L-725"><span class="linenos"> 725</span></a>        <span class="n">nfilt</span><span class="o">=</span><span class="mi">64</span>
</span><span id="L-726"><a href="#L-726"><span class="linenos"> 726</span></a>        <span class="n">nff</span> <span class="o">=</span> <span class="mi">128</span>
</span><span id="L-727"><a href="#L-727"><span class="linenos"> 727</span></a>        <span class="n">convn</span> <span class="o">=</span> <span class="mi">6</span>
</span><span id="L-728"><a href="#L-728"><span class="linenos"> 728</span></a>        <span class="n">lastconv</span> <span class="o">=</span> <span class="mi">3</span>
</span><span id="L-729"><a href="#L-729"><span class="linenos"> 729</span></a>        <span class="n">nbp</span><span class="o">=</span><span class="mi">4</span>
</span><span id="L-730"><a href="#L-730"><span class="linenos"> 730</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-731"><a href="#L-731"><span class="linenos"> 731</span></a>        <span class="n">option</span><span class="o">=</span><span class="s1">&#39;large&#39;</span>
</span><span id="L-732"><a href="#L-732"><span class="linenos"> 732</span></a>    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-733"><a href="#L-733"><span class="linenos"> 733</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Building mode of size: &quot;</span> <span class="o">+</span> <span class="n">option</span><span class="p">)</span>
</span><span id="L-734"><a href="#L-734"><span class="linenos"> 734</span></a>        <span class="k">if</span> <span class="n">intensity_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-735"><a href="#L-735"><span class="linenos"> 735</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;user-passed intensity model will be frozen - only segmentation will train&quot;</span><span class="p">)</span>
</span><span id="L-736"><a href="#L-736"><span class="linenos"> 736</span></a>        <span class="k">if</span> <span class="n">segmentation_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-737"><a href="#L-737"><span class="linenos"> 737</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;user-passed segmentation model will be frozen - only intensity will train&quot;</span><span class="p">)</span>
</span><span id="L-738"><a href="#L-738"><span class="linenos"> 738</span></a>
</span><span id="L-739"><a href="#L-739"><span class="linenos"> 739</span></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">strider</span><span class="p">)</span> <span class="o">!=</span> <span class="n">dimensionality</span><span class="p">:</span>
</span><span id="L-740"><a href="#L-740"><span class="linenos"> 740</span></a>        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;len(strider) != dimensionality&quot;</span><span class="p">)</span>
</span><span id="L-741"><a href="#L-741"><span class="linenos"> 741</span></a>    <span class="c1"># **model instantiation**: these are close to defaults for the 2x network.&lt;br&gt;</span>
</span><span id="L-742"><a href="#L-742"><span class="linenos"> 742</span></a>    <span class="c1"># empirical evidence suggests that making covolutions and strides evenly&lt;br&gt;</span>
</span><span id="L-743"><a href="#L-743"><span class="linenos"> 743</span></a>    <span class="c1"># divisible by each other reduces artifacts.  2*3=6.</span>
</span><span id="L-744"><a href="#L-744"><span class="linenos"> 744</span></a>    <span class="c1"># ofn=&#39;./models/dsr3d_&#39;+str(strider)+&#39;up_&#39; + str(nfilt) + &#39;_&#39; + str( nff ) + &#39;_&#39; + str(convn)+ &#39;_&#39; + str(lastconv)+ &#39;_&#39; + str(os.environ[&#39;CUDA_VISIBLE_DEVICES&#39;])+&#39;_v0.0.keras&#39;</span>
</span><span id="L-745"><a href="#L-745"><span class="linenos"> 745</span></a>    <span class="k">if</span> <span class="n">dimensionality</span> <span class="o">==</span> <span class="mi">2</span> <span class="p">:</span>
</span><span id="L-746"><a href="#L-746"><span class="linenos"> 746</span></a>        <span class="n">mdl</span> <span class="o">=</span> <span class="n">dbpn</span><span class="p">(</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="n">nChannelsIn</span><span class="p">),</span>
</span><span id="L-747"><a href="#L-747"><span class="linenos"> 747</span></a>            <span class="n">number_of_outputs</span><span class="o">=</span><span class="n">nChannelsOut</span><span class="p">,</span>
</span><span id="L-748"><a href="#L-748"><span class="linenos"> 748</span></a>            <span class="n">number_of_base_filters</span><span class="o">=</span><span class="n">nfilt</span><span class="p">,</span>
</span><span id="L-749"><a href="#L-749"><span class="linenos"> 749</span></a>            <span class="n">number_of_feature_filters</span><span class="o">=</span><span class="n">nff</span><span class="p">,</span>
</span><span id="L-750"><a href="#L-750"><span class="linenos"> 750</span></a>            <span class="n">number_of_back_projection_stages</span><span class="o">=</span><span class="n">nbp</span><span class="p">,</span>
</span><span id="L-751"><a href="#L-751"><span class="linenos"> 751</span></a>            <span class="n">convolution_kernel_size</span><span class="o">=</span><span class="p">(</span><span class="n">convn</span><span class="p">,</span> <span class="n">convn</span><span class="p">),</span>
</span><span id="L-752"><a href="#L-752"><span class="linenos"> 752</span></a>            <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="n">strider</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">strider</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
</span><span id="L-753"><a href="#L-753"><span class="linenos"> 753</span></a>            <span class="n">last_convolution</span><span class="o">=</span><span class="p">(</span><span class="n">lastconv</span><span class="p">,</span> <span class="n">lastconv</span><span class="p">),</span>
</span><span id="L-754"><a href="#L-754"><span class="linenos"> 754</span></a>            <span class="n">number_of_loss_functions</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="L-755"><a href="#L-755"><span class="linenos"> 755</span></a>            <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>
</span><span id="L-756"><a href="#L-756"><span class="linenos"> 756</span></a>    <span class="k">if</span> <span class="n">dimensionality</span> <span class="o">==</span> <span class="mi">3</span> <span class="p">:</span>
</span><span id="L-757"><a href="#L-757"><span class="linenos"> 757</span></a>        <span class="n">mdl</span> <span class="o">=</span> <span class="n">dbpn</span><span class="p">(</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="n">nChannelsIn</span><span class="p">),</span>
</span><span id="L-758"><a href="#L-758"><span class="linenos"> 758</span></a>            <span class="n">number_of_outputs</span><span class="o">=</span><span class="n">nChannelsOut</span><span class="p">,</span>
</span><span id="L-759"><a href="#L-759"><span class="linenos"> 759</span></a>            <span class="n">number_of_base_filters</span><span class="o">=</span><span class="n">nfilt</span><span class="p">,</span>
</span><span id="L-760"><a href="#L-760"><span class="linenos"> 760</span></a>            <span class="n">number_of_feature_filters</span><span class="o">=</span><span class="n">nff</span><span class="p">,</span>
</span><span id="L-761"><a href="#L-761"><span class="linenos"> 761</span></a>            <span class="n">number_of_back_projection_stages</span><span class="o">=</span><span class="n">nbp</span><span class="p">,</span>
</span><span id="L-762"><a href="#L-762"><span class="linenos"> 762</span></a>            <span class="n">convolution_kernel_size</span><span class="o">=</span><span class="p">(</span><span class="n">convn</span><span class="p">,</span> <span class="n">convn</span><span class="p">,</span> <span class="n">convn</span><span class="p">),</span>
</span><span id="L-763"><a href="#L-763"><span class="linenos"> 763</span></a>            <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="n">strider</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">strider</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">strider</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
</span><span id="L-764"><a href="#L-764"><span class="linenos"> 764</span></a>            <span class="n">last_convolution</span><span class="o">=</span><span class="p">(</span><span class="n">lastconv</span><span class="p">,</span> <span class="n">lastconv</span><span class="p">,</span> <span class="n">lastconv</span><span class="p">),</span> <span class="n">number_of_loss_functions</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>
</span><span id="L-765"><a href="#L-765"><span class="linenos"> 765</span></a>    <span class="k">if</span> <span class="n">sigmoid_second_channel</span> <span class="ow">and</span> <span class="n">pro_seg</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">:</span>
</span><span id="L-766"><a href="#L-766"><span class="linenos"> 766</span></a>        <span class="k">if</span> <span class="n">dimensionality</span> <span class="o">==</span> <span class="mi">2</span> <span class="p">:</span>
</span><span id="L-767"><a href="#L-767"><span class="linenos"> 767</span></a>            <span class="n">input_image_size</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-768"><a href="#L-768"><span class="linenos"> 768</span></a>            <span class="k">if</span> <span class="n">intensity_model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-769"><a href="#L-769"><span class="linenos"> 769</span></a>                <span class="n">intensity_model</span> <span class="o">=</span> <span class="n">dbpn</span><span class="p">(</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
</span><span id="L-770"><a href="#L-770"><span class="linenos"> 770</span></a>                    <span class="n">number_of_outputs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="L-771"><a href="#L-771"><span class="linenos"> 771</span></a>                    <span class="n">number_of_base_filters</span><span class="o">=</span><span class="n">nfilt</span><span class="p">,</span>
</span><span id="L-772"><a href="#L-772"><span class="linenos"> 772</span></a>                    <span class="n">number_of_feature_filters</span><span class="o">=</span><span class="n">nff</span><span class="p">,</span>
</span><span id="L-773"><a href="#L-773"><span class="linenos"> 773</span></a>                    <span class="n">number_of_back_projection_stages</span><span class="o">=</span><span class="n">nbp</span><span class="p">,</span>
</span><span id="L-774"><a href="#L-774"><span class="linenos"> 774</span></a>                    <span class="n">convolution_kernel_size</span><span class="o">=</span><span class="p">(</span><span class="n">convn</span><span class="p">,</span> <span class="n">convn</span><span class="p">),</span>
</span><span id="L-775"><a href="#L-775"><span class="linenos"> 775</span></a>                    <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="n">strider</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">strider</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
</span><span id="L-776"><a href="#L-776"><span class="linenos"> 776</span></a>                    <span class="n">last_convolution</span><span class="o">=</span><span class="p">(</span><span class="n">lastconv</span><span class="p">,</span> <span class="n">lastconv</span><span class="p">),</span>
</span><span id="L-777"><a href="#L-777"><span class="linenos"> 777</span></a>                    <span class="n">number_of_loss_functions</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="L-778"><a href="#L-778"><span class="linenos"> 778</span></a>                    <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>
</span><span id="L-779"><a href="#L-779"><span class="linenos"> 779</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-780"><a href="#L-780"><span class="linenos"> 780</span></a>                <span class="k">if</span> <span class="n">freeze</span><span class="p">:</span>
</span><span id="L-781"><a href="#L-781"><span class="linenos"> 781</span></a>                    <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">intensity_model</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
</span><span id="L-782"><a href="#L-782"><span class="linenos"> 782</span></a>                        <span class="n">layer</span><span class="o">.</span><span class="n">trainable</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-783"><a href="#L-783"><span class="linenos"> 783</span></a>            <span class="k">if</span> <span class="n">segmentation_model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-784"><a href="#L-784"><span class="linenos"> 784</span></a>                <span class="n">segmentation_model</span> <span class="o">=</span> <span class="n">dbpn</span><span class="p">(</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
</span><span id="L-785"><a href="#L-785"><span class="linenos"> 785</span></a>                        <span class="n">number_of_outputs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="L-786"><a href="#L-786"><span class="linenos"> 786</span></a>                        <span class="n">number_of_base_filters</span><span class="o">=</span><span class="n">nfilt</span><span class="p">,</span>
</span><span id="L-787"><a href="#L-787"><span class="linenos"> 787</span></a>                        <span class="n">number_of_feature_filters</span><span class="o">=</span><span class="n">nff</span><span class="p">,</span>
</span><span id="L-788"><a href="#L-788"><span class="linenos"> 788</span></a>                        <span class="n">number_of_back_projection_stages</span><span class="o">=</span><span class="n">nbp</span><span class="p">,</span>
</span><span id="L-789"><a href="#L-789"><span class="linenos"> 789</span></a>                        <span class="n">convolution_kernel_size</span><span class="o">=</span><span class="p">(</span><span class="n">convn</span><span class="p">,</span> <span class="n">convn</span><span class="p">),</span>
</span><span id="L-790"><a href="#L-790"><span class="linenos"> 790</span></a>                        <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="n">strider</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">strider</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
</span><span id="L-791"><a href="#L-791"><span class="linenos"> 791</span></a>                        <span class="n">last_convolution</span><span class="o">=</span><span class="p">(</span><span class="n">lastconv</span><span class="p">,</span> <span class="n">lastconv</span><span class="p">),</span>
</span><span id="L-792"><a href="#L-792"><span class="linenos"> 792</span></a>                        <span class="n">number_of_loss_functions</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">)</span>
</span><span id="L-793"><a href="#L-793"><span class="linenos"> 793</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-794"><a href="#L-794"><span class="linenos"> 794</span></a>                <span class="k">if</span> <span class="n">freeze</span><span class="p">:</span>
</span><span id="L-795"><a href="#L-795"><span class="linenos"> 795</span></a>                    <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">segmentation_model</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
</span><span id="L-796"><a href="#L-796"><span class="linenos"> 796</span></a>                        <span class="n">layer</span><span class="o">.</span><span class="n">trainable</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-797"><a href="#L-797"><span class="linenos"> 797</span></a>        <span class="k">if</span> <span class="n">dimensionality</span> <span class="o">==</span> <span class="mi">3</span> <span class="p">:</span>
</span><span id="L-798"><a href="#L-798"><span class="linenos"> 798</span></a>            <span class="n">input_image_size</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-799"><a href="#L-799"><span class="linenos"> 799</span></a>            <span class="k">if</span> <span class="n">intensity_model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-800"><a href="#L-800"><span class="linenos"> 800</span></a>                <span class="n">intensity_model</span> <span class="o">=</span> <span class="n">dbpn</span><span class="p">(</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
</span><span id="L-801"><a href="#L-801"><span class="linenos"> 801</span></a>                    <span class="n">number_of_outputs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="L-802"><a href="#L-802"><span class="linenos"> 802</span></a>                    <span class="n">number_of_base_filters</span><span class="o">=</span><span class="n">nfilt</span><span class="p">,</span>
</span><span id="L-803"><a href="#L-803"><span class="linenos"> 803</span></a>                    <span class="n">number_of_feature_filters</span><span class="o">=</span><span class="n">nff</span><span class="p">,</span>
</span><span id="L-804"><a href="#L-804"><span class="linenos"> 804</span></a>                    <span class="n">number_of_back_projection_stages</span><span class="o">=</span><span class="n">nbp</span><span class="p">,</span>
</span><span id="L-805"><a href="#L-805"><span class="linenos"> 805</span></a>                    <span class="n">convolution_kernel_size</span><span class="o">=</span><span class="p">(</span><span class="n">convn</span><span class="p">,</span> <span class="n">convn</span><span class="p">,</span> <span class="n">convn</span><span class="p">),</span>
</span><span id="L-806"><a href="#L-806"><span class="linenos"> 806</span></a>                    <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="n">strider</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">strider</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">strider</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
</span><span id="L-807"><a href="#L-807"><span class="linenos"> 807</span></a>                    <span class="n">last_convolution</span><span class="o">=</span><span class="p">(</span><span class="n">lastconv</span><span class="p">,</span> <span class="n">lastconv</span><span class="p">,</span> <span class="n">lastconv</span><span class="p">),</span>
</span><span id="L-808"><a href="#L-808"><span class="linenos"> 808</span></a>                    <span class="n">number_of_loss_functions</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>
</span><span id="L-809"><a href="#L-809"><span class="linenos"> 809</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-810"><a href="#L-810"><span class="linenos"> 810</span></a>                <span class="k">if</span> <span class="n">freeze</span><span class="p">:</span>
</span><span id="L-811"><a href="#L-811"><span class="linenos"> 811</span></a>                    <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">intensity_model</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
</span><span id="L-812"><a href="#L-812"><span class="linenos"> 812</span></a>                        <span class="n">layer</span><span class="o">.</span><span class="n">trainable</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-813"><a href="#L-813"><span class="linenos"> 813</span></a>            <span class="k">if</span> <span class="n">segmentation_model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-814"><a href="#L-814"><span class="linenos"> 814</span></a>                <span class="n">segmentation_model</span> <span class="o">=</span> <span class="n">dbpn</span><span class="p">(</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
</span><span id="L-815"><a href="#L-815"><span class="linenos"> 815</span></a>                        <span class="n">number_of_outputs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="L-816"><a href="#L-816"><span class="linenos"> 816</span></a>                        <span class="n">number_of_base_filters</span><span class="o">=</span><span class="n">nfilt</span><span class="p">,</span>
</span><span id="L-817"><a href="#L-817"><span class="linenos"> 817</span></a>                        <span class="n">number_of_feature_filters</span><span class="o">=</span><span class="n">nff</span><span class="p">,</span>
</span><span id="L-818"><a href="#L-818"><span class="linenos"> 818</span></a>                        <span class="n">number_of_back_projection_stages</span><span class="o">=</span><span class="n">nbp</span><span class="p">,</span>
</span><span id="L-819"><a href="#L-819"><span class="linenos"> 819</span></a>                        <span class="n">convolution_kernel_size</span><span class="o">=</span><span class="p">(</span><span class="n">convn</span><span class="p">,</span> <span class="n">convn</span><span class="p">,</span> <span class="n">convn</span><span class="p">),</span>
</span><span id="L-820"><a href="#L-820"><span class="linenos"> 820</span></a>                        <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="n">strider</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">strider</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">strider</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
</span><span id="L-821"><a href="#L-821"><span class="linenos"> 821</span></a>                        <span class="n">last_convolution</span><span class="o">=</span><span class="p">(</span><span class="n">lastconv</span><span class="p">,</span> <span class="n">lastconv</span><span class="p">,</span> <span class="n">lastconv</span><span class="p">),</span>
</span><span id="L-822"><a href="#L-822"><span class="linenos"> 822</span></a>                        <span class="n">number_of_loss_functions</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">)</span>
</span><span id="L-823"><a href="#L-823"><span class="linenos"> 823</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-824"><a href="#L-824"><span class="linenos"> 824</span></a>                <span class="k">if</span> <span class="n">freeze</span><span class="p">:</span>
</span><span id="L-825"><a href="#L-825"><span class="linenos"> 825</span></a>                    <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">segmentation_model</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
</span><span id="L-826"><a href="#L-826"><span class="linenos"> 826</span></a>                        <span class="n">layer</span><span class="o">.</span><span class="n">trainable</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-827"><a href="#L-827"><span class="linenos"> 827</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-828"><a href="#L-828"><span class="linenos"> 828</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;len intensity_model layers : &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">intensity_model</span><span class="o">.</span><span class="n">layers</span> <span class="p">)))</span>
</span><span id="L-829"><a href="#L-829"><span class="linenos"> 829</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;len intensity_model weights : &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">intensity_model</span><span class="o">.</span><span class="n">weights</span> <span class="p">)))</span>
</span><span id="L-830"><a href="#L-830"><span class="linenos"> 830</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;len segmentation_model layers : &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">segmentation_model</span><span class="o">.</span><span class="n">layers</span> <span class="p">)))</span>
</span><span id="L-831"><a href="#L-831"><span class="linenos"> 831</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;len segmentation_model weights : &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">segmentation_model</span><span class="o">.</span><span class="n">weights</span> <span class="p">)))</span>
</span><span id="L-832"><a href="#L-832"><span class="linenos"> 832</span></a>        <span class="k">if</span> <span class="n">clone_intensity_to_segmentation</span><span class="p">:</span>
</span><span id="L-833"><a href="#L-833"><span class="linenos"> 833</span></a>            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span> <span class="n">segmentation_model</span><span class="o">.</span><span class="n">weights</span> <span class="p">)):</span>
</span><span id="L-834"><a href="#L-834"><span class="linenos"> 834</span></a>                <span class="k">if</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span> <span class="n">intensity_model</span><span class="o">.</span><span class="n">weights</span> <span class="p">):</span>
</span><span id="L-835"><a href="#L-835"><span class="linenos"> 835</span></a>                    <span class="k">if</span> <span class="n">intensity_model</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">segmentation_model</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
</span><span id="L-836"><a href="#L-836"><span class="linenos"> 836</span></a>                        <span class="n">segmentation_model</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">intensity_model</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
</span><span id="L-837"><a href="#L-837"><span class="linenos"> 837</span></a>        <span class="n">inputs</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">input_image_size</span><span class="p">)</span>
</span><span id="L-838"><a href="#L-838"><span class="linenos"> 838</span></a>        <span class="n">insplit</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span> <span class="n">inputs</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dimensionality</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-839"><a href="#L-839"><span class="linenos"> 839</span></a>        <span class="n">outputs</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-840"><a href="#L-840"><span class="linenos"> 840</span></a>            <span class="n">intensity_model</span><span class="p">(</span> <span class="n">insplit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">),</span>
</span><span id="L-841"><a href="#L-841"><span class="linenos"> 841</span></a>            <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span> <span class="n">segmentation_model</span><span class="p">(</span> <span class="n">insplit</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span> <span class="p">)</span> <span class="p">]</span>
</span><span id="L-842"><a href="#L-842"><span class="linenos"> 842</span></a>        <span class="n">mdlout</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">dimensionality</span><span class="o">+</span><span class="mi">1</span> <span class="p">)</span>
</span><span id="L-843"><a href="#L-843"><span class="linenos"> 843</span></a>        <span class="k">return</span> <span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">mdlout</span> <span class="p">)</span>
</span><span id="L-844"><a href="#L-844"><span class="linenos"> 844</span></a>    <span class="k">if</span> <span class="n">pro_seg</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">intensity_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-845"><a href="#L-845"><span class="linenos"> 845</span></a>        <span class="k">if</span> <span class="n">verbose</span> <span class="ow">and</span> <span class="n">freeze</span><span class="p">:</span>
</span><span id="L-846"><a href="#L-846"><span class="linenos"> 846</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Add a segmentation arm to the end. freeze intensity. intensity_model(seg) =&gt; conv =&gt; sigmoid&quot;</span><span class="p">)</span>
</span><span id="L-847"><a href="#L-847"><span class="linenos"> 847</span></a>        <span class="k">if</span> <span class="n">verbose</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">freeze</span><span class="p">:</span>
</span><span id="L-848"><a href="#L-848"><span class="linenos"> 848</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Add a segmentation arm to the end. freeze intensity. intensity_model(seg) =&gt; conv =&gt; sigmoid&quot;</span><span class="p">)</span>
</span><span id="L-849"><a href="#L-849"><span class="linenos"> 849</span></a>        <span class="k">if</span> <span class="n">freeze</span><span class="p">:</span>
</span><span id="L-850"><a href="#L-850"><span class="linenos"> 850</span></a>            <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">intensity_model</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
</span><span id="L-851"><a href="#L-851"><span class="linenos"> 851</span></a>                <span class="n">layer</span><span class="o">.</span><span class="n">trainable</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-852"><a href="#L-852"><span class="linenos"> 852</span></a>        <span class="k">if</span> <span class="n">dimensionality</span> <span class="o">==</span> <span class="mi">2</span> <span class="p">:</span>
</span><span id="L-853"><a href="#L-853"><span class="linenos"> 853</span></a>            <span class="n">input_image_size</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-854"><a href="#L-854"><span class="linenos"> 854</span></a>        <span class="k">elif</span> <span class="n">dimensionality</span> <span class="o">==</span> <span class="mi">3</span> <span class="p">:</span>
</span><span id="L-855"><a href="#L-855"><span class="linenos"> 855</span></a>            <span class="n">input_image_size</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-856"><a href="#L-856"><span class="linenos"> 856</span></a>        <span class="k">if</span> <span class="n">dimensionality</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-857"><a href="#L-857"><span class="linenos"> 857</span></a>            <span class="n">myconv</span> <span class="o">=</span> <span class="n">Conv2D</span>
</span><span id="L-858"><a href="#L-858"><span class="linenos"> 858</span></a>            <span class="n">firstConv</span> <span class="o">=</span> <span class="p">(</span><span class="n">convn</span><span class="p">,</span><span class="n">convn</span><span class="p">)</span>
</span><span id="L-859"><a href="#L-859"><span class="linenos"> 859</span></a>            <span class="n">firstStrides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-860"><a href="#L-860"><span class="linenos"> 860</span></a>            <span class="n">smashConv</span><span class="o">=</span><span class="p">(</span><span class="n">pro_seg</span><span class="p">,</span><span class="n">pro_seg</span><span class="p">)</span>
</span><span id="L-861"><a href="#L-861"><span class="linenos"> 861</span></a>        <span class="k">if</span> <span class="n">dimensionality</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="L-862"><a href="#L-862"><span class="linenos"> 862</span></a>            <span class="n">myconv</span> <span class="o">=</span> <span class="n">Conv3D</span>
</span><span id="L-863"><a href="#L-863"><span class="linenos"> 863</span></a>            <span class="n">firstConv</span> <span class="o">=</span> <span class="p">(</span><span class="n">convn</span><span class="p">,</span><span class="n">convn</span><span class="p">,</span><span class="n">convn</span><span class="p">)</span>
</span><span id="L-864"><a href="#L-864"><span class="linenos"> 864</span></a>            <span class="n">firstStrides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-865"><a href="#L-865"><span class="linenos"> 865</span></a>            <span class="n">smashConv</span><span class="o">=</span><span class="p">(</span><span class="n">pro_seg</span><span class="p">,</span><span class="n">pro_seg</span><span class="p">,</span><span class="n">pro_seg</span><span class="p">)</span>
</span><span id="L-866"><a href="#L-866"><span class="linenos"> 866</span></a>        <span class="n">inputs</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">input_image_size</span><span class="p">)</span>
</span><span id="L-867"><a href="#L-867"><span class="linenos"> 867</span></a>        <span class="n">insplit</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span> <span class="n">inputs</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dimensionality</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-868"><a href="#L-868"><span class="linenos"> 868</span></a>        <span class="c1"># define segmentation arm</span>
</span><span id="L-869"><a href="#L-869"><span class="linenos"> 869</span></a>        <span class="n">seggit</span> <span class="o">=</span> <span class="n">intensity_model</span><span class="p">(</span> <span class="n">insplit</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
</span><span id="L-870"><a href="#L-870"><span class="linenos"> 870</span></a>        <span class="n">L0</span> <span class="o">=</span> <span class="n">myconv</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="n">nff</span><span class="p">,</span>
</span><span id="L-871"><a href="#L-871"><span class="linenos"> 871</span></a>                    <span class="n">kernel_size</span><span class="o">=</span><span class="n">firstConv</span><span class="p">,</span>
</span><span id="L-872"><a href="#L-872"><span class="linenos"> 872</span></a>                    <span class="n">strides</span><span class="o">=</span><span class="n">firstStrides</span><span class="p">,</span>
</span><span id="L-873"><a href="#L-873"><span class="linenos"> 873</span></a>                    <span class="n">kernel_initializer</span><span class="o">=</span><span class="s1">&#39;glorot_uniform&#39;</span><span class="p">,</span>
</span><span id="L-874"><a href="#L-874"><span class="linenos"> 874</span></a>                    <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)(</span><span class="n">seggit</span><span class="p">)</span>
</span><span id="L-875"><a href="#L-875"><span class="linenos"> 875</span></a>        <span class="n">L1</span> <span class="o">=</span> <span class="n">myconv</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="n">nff</span><span class="p">,</span>
</span><span id="L-876"><a href="#L-876"><span class="linenos"> 876</span></a>                    <span class="n">kernel_size</span><span class="o">=</span><span class="n">firstConv</span><span class="p">,</span>
</span><span id="L-877"><a href="#L-877"><span class="linenos"> 877</span></a>                    <span class="n">strides</span><span class="o">=</span><span class="n">firstStrides</span><span class="p">,</span>
</span><span id="L-878"><a href="#L-878"><span class="linenos"> 878</span></a>                    <span class="n">kernel_initializer</span><span class="o">=</span><span class="s1">&#39;glorot_uniform&#39;</span><span class="p">,</span>
</span><span id="L-879"><a href="#L-879"><span class="linenos"> 879</span></a>                    <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)(</span><span class="n">L0</span><span class="p">)</span>
</span><span id="L-880"><a href="#L-880"><span class="linenos"> 880</span></a>        <span class="n">L2</span> <span class="o">=</span> <span class="n">myconv</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="L-881"><a href="#L-881"><span class="linenos"> 881</span></a>                    <span class="n">kernel_size</span><span class="o">=</span><span class="n">smashConv</span><span class="p">,</span>
</span><span id="L-882"><a href="#L-882"><span class="linenos"> 882</span></a>                    <span class="n">strides</span><span class="o">=</span><span class="n">firstStrides</span><span class="p">,</span>
</span><span id="L-883"><a href="#L-883"><span class="linenos"> 883</span></a>                    <span class="n">kernel_initializer</span><span class="o">=</span><span class="s1">&#39;glorot_uniform&#39;</span><span class="p">,</span>
</span><span id="L-884"><a href="#L-884"><span class="linenos"> 884</span></a>                    <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)(</span><span class="n">L1</span><span class="p">)</span>
</span><span id="L-885"><a href="#L-885"><span class="linenos"> 885</span></a>        <span class="n">outputs</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-886"><a href="#L-886"><span class="linenos"> 886</span></a>            <span class="n">intensity_model</span><span class="p">(</span> <span class="n">insplit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">),</span>
</span><span id="L-887"><a href="#L-887"><span class="linenos"> 887</span></a>            <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span> <span class="n">L2</span> <span class="p">)</span> <span class="p">]</span>
</span><span id="L-888"><a href="#L-888"><span class="linenos"> 888</span></a>        <span class="n">mdlout</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">dimensionality</span><span class="o">+</span><span class="mi">1</span> <span class="p">)</span>
</span><span id="L-889"><a href="#L-889"><span class="linenos"> 889</span></a>        <span class="k">return</span> <span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">mdlout</span> <span class="p">)</span>
</span><span id="L-890"><a href="#L-890"><span class="linenos"> 890</span></a>    <span class="k">return</span> <span class="n">mdl</span>
</span><span id="L-891"><a href="#L-891"><span class="linenos"> 891</span></a>
</span><span id="L-892"><a href="#L-892"><span class="linenos"> 892</span></a><span class="k">def</span> <span class="nf">image_patch_training_data_from_filenames</span><span class="p">(</span>
</span><span id="L-893"><a href="#L-893"><span class="linenos"> 893</span></a>    <span class="n">filenames</span><span class="p">,</span>
</span><span id="L-894"><a href="#L-894"><span class="linenos"> 894</span></a>    <span class="n">target_patch_size</span><span class="p">,</span>
</span><span id="L-895"><a href="#L-895"><span class="linenos"> 895</span></a>    <span class="n">target_patch_size_low</span><span class="p">,</span>
</span><span id="L-896"><a href="#L-896"><span class="linenos"> 896</span></a>    <span class="n">nPatches</span> <span class="o">=</span> <span class="mi">128</span><span class="p">,</span>
</span><span id="L-897"><a href="#L-897"><span class="linenos"> 897</span></a>    <span class="n">istest</span>   <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-898"><a href="#L-898"><span class="linenos"> 898</span></a>    <span class="n">patch_scaler</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-899"><a href="#L-899"><span class="linenos"> 899</span></a>    <span class="n">to_tensorflow</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-900"><a href="#L-900"><span class="linenos"> 900</span></a>    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-901"><a href="#L-901"><span class="linenos"> 901</span></a>    <span class="p">):</span>
</span><span id="L-902"><a href="#L-902"><span class="linenos"> 902</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-903"><a href="#L-903"><span class="linenos"> 903</span></a><span class="sd">    Generates a batch of paired high- and low-resolution image patches for training.</span>
</span><span id="L-904"><a href="#L-904"><span class="linenos"> 904</span></a>
</span><span id="L-905"><a href="#L-905"><span class="linenos"> 905</span></a><span class="sd">    This function creates training data by taking a list of high-resolution source</span>
</span><span id="L-906"><a href="#L-906"><span class="linenos"> 906</span></a><span class="sd">    images, extracting random patches, and then downsampling them to create</span>
</span><span id="L-907"><a href="#L-907"><span class="linenos"> 907</span></a><span class="sd">    low-resolution counterparts. This provides the (input, ground_truth) pairs</span>
</span><span id="L-908"><a href="#L-908"><span class="linenos"> 908</span></a><span class="sd">    needed to train a super-resolution model.</span>
</span><span id="L-909"><a href="#L-909"><span class="linenos"> 909</span></a>
</span><span id="L-910"><a href="#L-910"><span class="linenos"> 910</span></a><span class="sd">    Parameters</span>
</span><span id="L-911"><a href="#L-911"><span class="linenos"> 911</span></a><span class="sd">    ----------</span>
</span><span id="L-912"><a href="#L-912"><span class="linenos"> 912</span></a><span class="sd">    filenames : list of str</span>
</span><span id="L-913"><a href="#L-913"><span class="linenos"> 913</span></a><span class="sd">        A list of file paths to the high-resolution source images.</span>
</span><span id="L-914"><a href="#L-914"><span class="linenos"> 914</span></a>
</span><span id="L-915"><a href="#L-915"><span class="linenos"> 915</span></a><span class="sd">    target_patch_size : tuple or list of int</span>
</span><span id="L-916"><a href="#L-916"><span class="linenos"> 916</span></a><span class="sd">        The dimensions of the high-resolution (ground truth) patch to extract,</span>
</span><span id="L-917"><a href="#L-917"><span class="linenos"> 917</span></a><span class="sd">        e.g., `(128, 128, 128)`.</span>
</span><span id="L-918"><a href="#L-918"><span class="linenos"> 918</span></a>
</span><span id="L-919"><a href="#L-919"><span class="linenos"> 919</span></a><span class="sd">    target_patch_size_low : tuple or list of int</span>
</span><span id="L-920"><a href="#L-920"><span class="linenos"> 920</span></a><span class="sd">        The dimensions of the low-resolution (input) patch to generate. The ratio</span>
</span><span id="L-921"><a href="#L-921"><span class="linenos"> 921</span></a><span class="sd">        between `target_patch_size` and `target_patch_size_low` determines the</span>
</span><span id="L-922"><a href="#L-922"><span class="linenos"> 922</span></a><span class="sd">        super-resolution factor.</span>
</span><span id="L-923"><a href="#L-923"><span class="linenos"> 923</span></a>
</span><span id="L-924"><a href="#L-924"><span class="linenos"> 924</span></a><span class="sd">    nPatches : int, optional</span>
</span><span id="L-925"><a href="#L-925"><span class="linenos"> 925</span></a><span class="sd">        The number of patch pairs to generate in this batch. Default is 128.</span>
</span><span id="L-926"><a href="#L-926"><span class="linenos"> 926</span></a>
</span><span id="L-927"><a href="#L-927"><span class="linenos"> 927</span></a><span class="sd">    istest : bool, optional</span>
</span><span id="L-928"><a href="#L-928"><span class="linenos"> 928</span></a><span class="sd">        If True, the function also generates a third output array containing patches</span>
</span><span id="L-929"><a href="#L-929"><span class="linenos"> 929</span></a><span class="sd">        that have been naively upsampled using linear interpolation. This is useful</span>
</span><span id="L-930"><a href="#L-930"><span class="linenos"> 930</span></a><span class="sd">        for calculating baseline evaluation metrics (e.g., PSNR) against which the</span>
</span><span id="L-931"><a href="#L-931"><span class="linenos"> 931</span></a><span class="sd">        model&#39;s performance can be compared. Default is False.</span>
</span><span id="L-932"><a href="#L-932"><span class="linenos"> 932</span></a>
</span><span id="L-933"><a href="#L-933"><span class="linenos"> 933</span></a><span class="sd">    patch_scaler : bool, optional</span>
</span><span id="L-934"><a href="#L-934"><span class="linenos"> 934</span></a><span class="sd">        If True, scales the intensity of each high-resolution patch to the [0, 1]</span>
</span><span id="L-935"><a href="#L-935"><span class="linenos"> 935</span></a><span class="sd">        range before creating the downsampled version. This can help with</span>
</span><span id="L-936"><a href="#L-936"><span class="linenos"> 936</span></a><span class="sd">        training stability. Default is True.</span>
</span><span id="L-937"><a href="#L-937"><span class="linenos"> 937</span></a>
</span><span id="L-938"><a href="#L-938"><span class="linenos"> 938</span></a><span class="sd">    to_tensorflow : bool, optional</span>
</span><span id="L-939"><a href="#L-939"><span class="linenos"> 939</span></a><span class="sd">        If True, casts the output NumPy arrays to TensorFlow tensors. Default is False.</span>
</span><span id="L-940"><a href="#L-940"><span class="linenos"> 940</span></a>
</span><span id="L-941"><a href="#L-941"><span class="linenos"> 941</span></a><span class="sd">    verbose : bool, optional</span>
</span><span id="L-942"><a href="#L-942"><span class="linenos"> 942</span></a><span class="sd">        If True, prints progress messages during patch generation. Default is False.</span>
</span><span id="L-943"><a href="#L-943"><span class="linenos"> 943</span></a>
</span><span id="L-944"><a href="#L-944"><span class="linenos"> 944</span></a><span class="sd">    Returns</span>
</span><span id="L-945"><a href="#L-945"><span class="linenos"> 945</span></a><span class="sd">    -------</span>
</span><span id="L-946"><a href="#L-946"><span class="linenos"> 946</span></a><span class="sd">    tuple</span>
</span><span id="L-947"><a href="#L-947"><span class="linenos"> 947</span></a><span class="sd">        A tuple of NumPy arrays or TensorFlow tensors.</span>
</span><span id="L-948"><a href="#L-948"><span class="linenos"> 948</span></a><span class="sd">        - If `istest` is False: `(patchesResam, patchesOrig)`</span>
</span><span id="L-949"><a href="#L-949"><span class="linenos"> 949</span></a><span class="sd">            - `patchesResam`: The batch of low-resolution input patches (X_train).</span>
</span><span id="L-950"><a href="#L-950"><span class="linenos"> 950</span></a><span class="sd">            - `patchesOrig`: The batch of high-resolution ground truth patches (y_train).</span>
</span><span id="L-951"><a href="#L-951"><span class="linenos"> 951</span></a><span class="sd">        - If `istest` is True: `(patchesResam, patchesOrig, patchesUp)`</span>
</span><span id="L-952"><a href="#L-952"><span class="linenos"> 952</span></a><span class="sd">            - `patchesUp`: The batch of baseline, linearly-upsampled patches.</span>
</span><span id="L-953"><a href="#L-953"><span class="linenos"> 953</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-954"><a href="#L-954"><span class="linenos"> 954</span></a>    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-955"><a href="#L-955"><span class="linenos"> 955</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;begin image_patch_training_data_from_filenames&quot;</span><span class="p">)</span>
</span><span id="L-956"><a href="#L-956"><span class="linenos"> 956</span></a>    <span class="n">tardim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span> <span class="n">target_patch_size</span> <span class="p">)</span>
</span><span id="L-957"><a href="#L-957"><span class="linenos"> 957</span></a>    <span class="n">strider</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-958"><a href="#L-958"><span class="linenos"> 958</span></a>    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">tardim</span> <span class="p">):</span>
</span><span id="L-959"><a href="#L-959"><span class="linenos"> 959</span></a>        <span class="n">strider</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span> <span class="n">target_patch_size</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">/</span><span class="n">target_patch_size_low</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="p">)</span>
</span><span id="L-960"><a href="#L-960"><span class="linenos"> 960</span></a>    <span class="k">if</span> <span class="n">tardim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="L-961"><a href="#L-961"><span class="linenos"> 961</span></a>        <span class="n">shaperhi</span> <span class="o">=</span> <span class="p">(</span><span class="n">nPatches</span><span class="p">,</span><span class="n">target_patch_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">target_patch_size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">target_patch_size</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-962"><a href="#L-962"><span class="linenos"> 962</span></a>        <span class="n">shaperlo</span> <span class="o">=</span> <span class="p">(</span><span class="n">nPatches</span><span class="p">,</span><span class="n">target_patch_size_low</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">target_patch_size_low</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">target_patch_size_low</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-963"><a href="#L-963"><span class="linenos"> 963</span></a>    <span class="k">if</span> <span class="n">tardim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-964"><a href="#L-964"><span class="linenos"> 964</span></a>        <span class="n">shaperhi</span> <span class="o">=</span> <span class="p">(</span><span class="n">nPatches</span><span class="p">,</span><span class="n">target_patch_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">target_patch_size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-965"><a href="#L-965"><span class="linenos"> 965</span></a>        <span class="n">shaperlo</span> <span class="o">=</span> <span class="p">(</span><span class="n">nPatches</span><span class="p">,</span><span class="n">target_patch_size_low</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">target_patch_size_low</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-966"><a href="#L-966"><span class="linenos"> 966</span></a>    <span class="n">patchesOrig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">shaperhi</span><span class="p">)</span>
</span><span id="L-967"><a href="#L-967"><span class="linenos"> 967</span></a>    <span class="n">patchesResam</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">shaperlo</span><span class="p">)</span>
</span><span id="L-968"><a href="#L-968"><span class="linenos"> 968</span></a>    <span class="n">patchesUp</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-969"><a href="#L-969"><span class="linenos"> 969</span></a>    <span class="k">if</span> <span class="n">istest</span><span class="p">:</span>
</span><span id="L-970"><a href="#L-970"><span class="linenos"> 970</span></a>        <span class="n">patchesUp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">patchesOrig</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="L-971"><a href="#L-971"><span class="linenos"> 971</span></a>    <span class="k">for</span> <span class="n">myn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nPatches</span><span class="p">):</span>
</span><span id="L-972"><a href="#L-972"><span class="linenos"> 972</span></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-973"><a href="#L-973"><span class="linenos"> 973</span></a>                <span class="nb">print</span><span class="p">(</span><span class="n">myn</span><span class="p">)</span>
</span><span id="L-974"><a href="#L-974"><span class="linenos"> 974</span></a>            <span class="n">imgfn</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span> <span class="n">filenames</span><span class="p">,</span> <span class="mi">1</span> <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-975"><a href="#L-975"><span class="linenos"> 975</span></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-976"><a href="#L-976"><span class="linenos"> 976</span></a>                <span class="nb">print</span><span class="p">(</span><span class="n">imgfn</span><span class="p">)</span>
</span><span id="L-977"><a href="#L-977"><span class="linenos"> 977</span></a>            <span class="n">img</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">image_read</span><span class="p">(</span> <span class="n">imgfn</span> <span class="p">)</span><span class="o">.</span><span class="n">iMath</span><span class="p">(</span><span class="s2">&quot;Normalize&quot;</span><span class="p">)</span>
</span><span id="L-978"><a href="#L-978"><span class="linenos"> 978</span></a>            <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">components</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-979"><a href="#L-979"><span class="linenos"> 979</span></a>                <span class="n">img</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">split_channels</span><span class="p">(</span><span class="n">img</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-980"><a href="#L-980"><span class="linenos"> 980</span></a>            <span class="n">img</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">crop_image</span><span class="p">(</span> <span class="n">img</span><span class="p">,</span> <span class="n">ants</span><span class="o">.</span><span class="n">threshold_image</span><span class="p">(</span> <span class="n">img</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">)</span>
</span><span id="L-981"><a href="#L-981"><span class="linenos"> 981</span></a>            <span class="n">ants</span><span class="o">.</span><span class="n">set_origin</span><span class="p">(</span> <span class="n">img</span><span class="p">,</span> <span class="n">ants</span><span class="o">.</span><span class="n">get_center_of_mass</span><span class="p">(</span><span class="n">img</span><span class="p">)</span> <span class="p">)</span>
</span><span id="L-982"><a href="#L-982"><span class="linenos"> 982</span></a>            <span class="n">img</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">iMath</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="s2">&quot;Normalize&quot;</span><span class="p">)</span>
</span><span id="L-983"><a href="#L-983"><span class="linenos"> 983</span></a>            <span class="n">spc</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">get_spacing</span><span class="p">(</span> <span class="n">img</span> <span class="p">)</span>
</span><span id="L-984"><a href="#L-984"><span class="linenos"> 984</span></a>            <span class="n">newspc</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-985"><a href="#L-985"><span class="linenos"> 985</span></a>            <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spc</span><span class="p">)):</span>
</span><span id="L-986"><a href="#L-986"><span class="linenos"> 986</span></a>                <span class="n">newspc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spc</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span><span class="o">*</span><span class="n">strider</span><span class="p">[</span><span class="n">jj</span><span class="p">])</span>
</span><span id="L-987"><a href="#L-987"><span class="linenos"> 987</span></a>            <span class="n">interp_type</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
</span><span id="L-988"><a href="#L-988"><span class="linenos"> 988</span></a>            <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="L-989"><a href="#L-989"><span class="linenos"> 989</span></a>                <span class="n">imgp</span> <span class="o">=</span> <span class="n">get_random_patch</span><span class="p">(</span> <span class="n">img</span><span class="p">,</span> <span class="n">target_patch_size</span> <span class="p">)</span>
</span><span id="L-990"><a href="#L-990"><span class="linenos"> 990</span></a>                <span class="n">imgpmin</span> <span class="o">=</span> <span class="n">imgp</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
</span><span id="L-991"><a href="#L-991"><span class="linenos"> 991</span></a>                <span class="k">if</span> <span class="n">patch_scaler</span><span class="p">:</span>
</span><span id="L-992"><a href="#L-992"><span class="linenos"> 992</span></a>                    <span class="n">imgp</span> <span class="o">=</span> <span class="n">imgp</span> <span class="o">-</span> <span class="n">imgpmin</span>
</span><span id="L-993"><a href="#L-993"><span class="linenos"> 993</span></a>                    <span class="n">imgpmax</span> <span class="o">=</span> <span class="n">imgp</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</span><span id="L-994"><a href="#L-994"><span class="linenos"> 994</span></a>                    <span class="k">if</span> <span class="n">imgpmax</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">:</span>
</span><span id="L-995"><a href="#L-995"><span class="linenos"> 995</span></a>                        <span class="n">imgp</span> <span class="o">=</span> <span class="n">imgp</span> <span class="o">/</span> <span class="n">imgpmax</span>
</span><span id="L-996"><a href="#L-996"><span class="linenos"> 996</span></a>                <span class="n">rimgp</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">resample_image</span><span class="p">(</span> <span class="n">imgp</span><span class="p">,</span> <span class="n">newspc</span><span class="p">,</span> <span class="n">use_voxels</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">interp_type</span><span class="o">=</span><span class="n">interp_type</span>  <span class="p">)</span>
</span><span id="L-997"><a href="#L-997"><span class="linenos"> 997</span></a>                <span class="k">if</span> <span class="n">istest</span><span class="p">:</span>
</span><span id="L-998"><a href="#L-998"><span class="linenos"> 998</span></a>                    <span class="n">rimgbi</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">resample_image</span><span class="p">(</span> <span class="n">rimgp</span><span class="p">,</span> <span class="n">spc</span><span class="p">,</span> <span class="n">use_voxels</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">interp_type</span><span class="o">=</span><span class="mi">0</span>  <span class="p">)</span>
</span><span id="L-999"><a href="#L-999"><span class="linenos"> 999</span></a>                <span class="k">if</span> <span class="n">tardim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="L-1000"><a href="#L-1000"><span class="linenos">1000</span></a>                    <span class="n">patchesOrig</span><span class="p">[</span><span class="n">myn</span><span class="p">,:,:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">imgp</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="L-1001"><a href="#L-1001"><span class="linenos">1001</span></a>                    <span class="n">patchesResam</span><span class="p">[</span><span class="n">myn</span><span class="p">,:,:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">rimgp</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="L-1002"><a href="#L-1002"><span class="linenos">1002</span></a>                    <span class="k">if</span> <span class="n">istest</span><span class="p">:</span>
</span><span id="L-1003"><a href="#L-1003"><span class="linenos">1003</span></a>                        <span class="n">patchesUp</span><span class="p">[</span><span class="n">myn</span><span class="p">,:,:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">rimgbi</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="L-1004"><a href="#L-1004"><span class="linenos">1004</span></a>                <span class="k">if</span> <span class="n">tardim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-1005"><a href="#L-1005"><span class="linenos">1005</span></a>                    <span class="n">patchesOrig</span><span class="p">[</span><span class="n">myn</span><span class="p">,:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">imgp</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="L-1006"><a href="#L-1006"><span class="linenos">1006</span></a>                    <span class="n">patchesResam</span><span class="p">[</span><span class="n">myn</span><span class="p">,:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">rimgp</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="L-1007"><a href="#L-1007"><span class="linenos">1007</span></a>                    <span class="k">if</span> <span class="n">istest</span><span class="p">:</span>
</span><span id="L-1008"><a href="#L-1008"><span class="linenos">1008</span></a>                        <span class="n">patchesUp</span><span class="p">[</span><span class="n">myn</span><span class="p">,:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">rimgbi</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="L-1009"><a href="#L-1009"><span class="linenos">1009</span></a>    <span class="k">if</span> <span class="n">to_tensorflow</span><span class="p">:</span>
</span><span id="L-1010"><a href="#L-1010"><span class="linenos">1010</span></a>        <span class="n">patchesOrig</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span> <span class="n">patchesOrig</span><span class="p">,</span> <span class="s2">&quot;float32&quot;</span><span class="p">)</span>
</span><span id="L-1011"><a href="#L-1011"><span class="linenos">1011</span></a>        <span class="n">patchesResam</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span> <span class="n">patchesResam</span><span class="p">,</span> <span class="s2">&quot;float32&quot;</span><span class="p">)</span>
</span><span id="L-1012"><a href="#L-1012"><span class="linenos">1012</span></a>    <span class="k">if</span> <span class="n">istest</span><span class="p">:</span>
</span><span id="L-1013"><a href="#L-1013"><span class="linenos">1013</span></a>        <span class="k">if</span> <span class="n">to_tensorflow</span><span class="p">:</span>
</span><span id="L-1014"><a href="#L-1014"><span class="linenos">1014</span></a>            <span class="n">patchesUp</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span> <span class="n">patchesUp</span><span class="p">,</span> <span class="s2">&quot;float32&quot;</span><span class="p">)</span>
</span><span id="L-1015"><a href="#L-1015"><span class="linenos">1015</span></a>    <span class="k">return</span> <span class="n">patchesResam</span><span class="p">,</span> <span class="n">patchesOrig</span><span class="p">,</span> <span class="n">patchesUp</span>
</span><span id="L-1016"><a href="#L-1016"><span class="linenos">1016</span></a>
</span><span id="L-1017"><a href="#L-1017"><span class="linenos">1017</span></a>
</span><span id="L-1018"><a href="#L-1018"><span class="linenos">1018</span></a><span class="k">def</span> <span class="nf">seg_patch_training_data_from_filenames</span><span class="p">(</span>
</span><span id="L-1019"><a href="#L-1019"><span class="linenos">1019</span></a>    <span class="n">filenames</span><span class="p">,</span>
</span><span id="L-1020"><a href="#L-1020"><span class="linenos">1020</span></a>    <span class="n">target_patch_size</span><span class="p">,</span>
</span><span id="L-1021"><a href="#L-1021"><span class="linenos">1021</span></a>    <span class="n">target_patch_size_low</span><span class="p">,</span>
</span><span id="L-1022"><a href="#L-1022"><span class="linenos">1022</span></a>    <span class="n">nPatches</span> <span class="o">=</span> <span class="mi">128</span><span class="p">,</span>
</span><span id="L-1023"><a href="#L-1023"><span class="linenos">1023</span></a>    <span class="n">istest</span>   <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-1024"><a href="#L-1024"><span class="linenos">1024</span></a>    <span class="n">patch_scaler</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-1025"><a href="#L-1025"><span class="linenos">1025</span></a>    <span class="n">to_tensorflow</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-1026"><a href="#L-1026"><span class="linenos">1026</span></a>    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-1027"><a href="#L-1027"><span class="linenos">1027</span></a>    <span class="p">):</span>
</span><span id="L-1028"><a href="#L-1028"><span class="linenos">1028</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1029"><a href="#L-1029"><span class="linenos">1029</span></a><span class="sd">    Generates a batch of paired training data containing both images and segmentations.</span>
</span><span id="L-1030"><a href="#L-1030"><span class="linenos">1030</span></a>
</span><span id="L-1031"><a href="#L-1031"><span class="linenos">1031</span></a><span class="sd">    This function extends `image_patch_training_data_from_filenames` by adding a</span>
</span><span id="L-1032"><a href="#L-1032"><span class="linenos">1032</span></a><span class="sd">    second channel to the data. For each extracted image patch, it also generates</span>
</span><span id="L-1033"><a href="#L-1033"><span class="linenos">1033</span></a><span class="sd">    a corresponding segmentation mask using Otsu&#39;s thresholding. This is useful for</span>
</span><span id="L-1034"><a href="#L-1034"><span class="linenos">1034</span></a><span class="sd">    training multi-task models that perform super-resolution on both an image and</span>
</span><span id="L-1035"><a href="#L-1035"><span class="linenos">1035</span></a><span class="sd">    its associated segmentation simultaneously.</span>
</span><span id="L-1036"><a href="#L-1036"><span class="linenos">1036</span></a>
</span><span id="L-1037"><a href="#L-1037"><span class="linenos">1037</span></a><span class="sd">    Parameters</span>
</span><span id="L-1038"><a href="#L-1038"><span class="linenos">1038</span></a><span class="sd">    ----------</span>
</span><span id="L-1039"><a href="#L-1039"><span class="linenos">1039</span></a><span class="sd">    filenames : list of str</span>
</span><span id="L-1040"><a href="#L-1040"><span class="linenos">1040</span></a><span class="sd">        A list of file paths to the high-resolution source images.</span>
</span><span id="L-1041"><a href="#L-1041"><span class="linenos">1041</span></a>
</span><span id="L-1042"><a href="#L-1042"><span class="linenos">1042</span></a><span class="sd">    target_patch_size : tuple or list of int</span>
</span><span id="L-1043"><a href="#L-1043"><span class="linenos">1043</span></a><span class="sd">        The dimensions of the high-resolution patch, e.g., `(128, 128, 128)`.</span>
</span><span id="L-1044"><a href="#L-1044"><span class="linenos">1044</span></a>
</span><span id="L-1045"><a href="#L-1045"><span class="linenos">1045</span></a><span class="sd">    target_patch_size_low : tuple or list of int</span>
</span><span id="L-1046"><a href="#L-1046"><span class="linenos">1046</span></a><span class="sd">        The dimensions of the low-resolution input patch.</span>
</span><span id="L-1047"><a href="#L-1047"><span class="linenos">1047</span></a>
</span><span id="L-1048"><a href="#L-1048"><span class="linenos">1048</span></a><span class="sd">    nPatches : int, optional</span>
</span><span id="L-1049"><a href="#L-1049"><span class="linenos">1049</span></a><span class="sd">        The number of patch pairs to generate. Default is 128.</span>
</span><span id="L-1050"><a href="#L-1050"><span class="linenos">1050</span></a>
</span><span id="L-1051"><a href="#L-1051"><span class="linenos">1051</span></a><span class="sd">    istest : bool, optional</span>
</span><span id="L-1052"><a href="#L-1052"><span class="linenos">1052</span></a><span class="sd">        If True, also generates a third output array containing baseline upsampled</span>
</span><span id="L-1053"><a href="#L-1053"><span class="linenos">1053</span></a><span class="sd">        intensity images (channel 0 only). Default is False.</span>
</span><span id="L-1054"><a href="#L-1054"><span class="linenos">1054</span></a>
</span><span id="L-1055"><a href="#L-1055"><span class="linenos">1055</span></a><span class="sd">    patch_scaler : bool, optional</span>
</span><span id="L-1056"><a href="#L-1056"><span class="linenos">1056</span></a><span class="sd">        If True, scales the intensity of each image patch to the [0, 1] range.</span>
</span><span id="L-1057"><a href="#L-1057"><span class="linenos">1057</span></a><span class="sd">        Default is True.</span>
</span><span id="L-1058"><a href="#L-1058"><span class="linenos">1058</span></a>
</span><span id="L-1059"><a href="#L-1059"><span class="linenos">1059</span></a><span class="sd">    to_tensorflow : bool, optional</span>
</span><span id="L-1060"><a href="#L-1060"><span class="linenos">1060</span></a><span class="sd">        If True, casts the output NumPy arrays to TensorFlow tensors. Default is False.</span>
</span><span id="L-1061"><a href="#L-1061"><span class="linenos">1061</span></a>
</span><span id="L-1062"><a href="#L-1062"><span class="linenos">1062</span></a><span class="sd">    verbose : bool, optional</span>
</span><span id="L-1063"><a href="#L-1063"><span class="linenos">1063</span></a><span class="sd">        If True, prints progress messages. Default is False.</span>
</span><span id="L-1064"><a href="#L-1064"><span class="linenos">1064</span></a>
</span><span id="L-1065"><a href="#L-1065"><span class="linenos">1065</span></a><span class="sd">    Returns</span>
</span><span id="L-1066"><a href="#L-1066"><span class="linenos">1066</span></a><span class="sd">    -------</span>
</span><span id="L-1067"><a href="#L-1067"><span class="linenos">1067</span></a><span class="sd">    tuple</span>
</span><span id="L-1068"><a href="#L-1068"><span class="linenos">1068</span></a><span class="sd">        A tuple of multi-channel NumPy arrays or TensorFlow tensors. The structure</span>
</span><span id="L-1069"><a href="#L-1069"><span class="linenos">1069</span></a><span class="sd">        is the same as `image_patch_training_data_from_filenames`, but each</span>
</span><span id="L-1070"><a href="#L-1070"><span class="linenos">1070</span></a><span class="sd">        array has a channel dimension of 2:</span>
</span><span id="L-1071"><a href="#L-1071"><span class="linenos">1071</span></a><span class="sd">        - Channel 0: The intensity image.</span>
</span><span id="L-1072"><a href="#L-1072"><span class="linenos">1072</span></a><span class="sd">        - Channel 1: The binary segmentation mask.</span>
</span><span id="L-1073"><a href="#L-1073"><span class="linenos">1073</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1074"><a href="#L-1074"><span class="linenos">1074</span></a>    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1075"><a href="#L-1075"><span class="linenos">1075</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;begin seg_patch_training_data_from_filenames&quot;</span><span class="p">)</span>
</span><span id="L-1076"><a href="#L-1076"><span class="linenos">1076</span></a>    <span class="n">tardim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span> <span class="n">target_patch_size</span> <span class="p">)</span>
</span><span id="L-1077"><a href="#L-1077"><span class="linenos">1077</span></a>    <span class="n">strider</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1078"><a href="#L-1078"><span class="linenos">1078</span></a>    <span class="n">nchan</span> <span class="o">=</span> <span class="mi">2</span>
</span><span id="L-1079"><a href="#L-1079"><span class="linenos">1079</span></a>    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">tardim</span> <span class="p">):</span>
</span><span id="L-1080"><a href="#L-1080"><span class="linenos">1080</span></a>        <span class="n">strider</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span> <span class="n">target_patch_size</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">/</span><span class="n">target_patch_size_low</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="p">)</span>
</span><span id="L-1081"><a href="#L-1081"><span class="linenos">1081</span></a>    <span class="k">if</span> <span class="n">tardim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="L-1082"><a href="#L-1082"><span class="linenos">1082</span></a>        <span class="n">shaperhi</span> <span class="o">=</span> <span class="p">(</span><span class="n">nPatches</span><span class="p">,</span><span class="n">target_patch_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">target_patch_size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">target_patch_size</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">nchan</span><span class="p">)</span>
</span><span id="L-1083"><a href="#L-1083"><span class="linenos">1083</span></a>        <span class="n">shaperlo</span> <span class="o">=</span> <span class="p">(</span><span class="n">nPatches</span><span class="p">,</span><span class="n">target_patch_size_low</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">target_patch_size_low</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">target_patch_size_low</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">nchan</span><span class="p">)</span>
</span><span id="L-1084"><a href="#L-1084"><span class="linenos">1084</span></a>    <span class="k">if</span> <span class="n">tardim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-1085"><a href="#L-1085"><span class="linenos">1085</span></a>        <span class="n">shaperhi</span> <span class="o">=</span> <span class="p">(</span><span class="n">nPatches</span><span class="p">,</span><span class="n">target_patch_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">target_patch_size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nchan</span><span class="p">)</span>
</span><span id="L-1086"><a href="#L-1086"><span class="linenos">1086</span></a>        <span class="n">shaperlo</span> <span class="o">=</span> <span class="p">(</span><span class="n">nPatches</span><span class="p">,</span><span class="n">target_patch_size_low</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">target_patch_size_low</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nchan</span><span class="p">)</span>
</span><span id="L-1087"><a href="#L-1087"><span class="linenos">1087</span></a>    <span class="n">patchesOrig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">shaperhi</span><span class="p">)</span>
</span><span id="L-1088"><a href="#L-1088"><span class="linenos">1088</span></a>    <span class="n">patchesResam</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">shaperlo</span><span class="p">)</span>
</span><span id="L-1089"><a href="#L-1089"><span class="linenos">1089</span></a>    <span class="n">patchesUp</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-1090"><a href="#L-1090"><span class="linenos">1090</span></a>    <span class="k">if</span> <span class="n">istest</span><span class="p">:</span>
</span><span id="L-1091"><a href="#L-1091"><span class="linenos">1091</span></a>        <span class="n">patchesUp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">patchesOrig</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="L-1092"><a href="#L-1092"><span class="linenos">1092</span></a>    <span class="k">for</span> <span class="n">myn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nPatches</span><span class="p">):</span>
</span><span id="L-1093"><a href="#L-1093"><span class="linenos">1093</span></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1094"><a href="#L-1094"><span class="linenos">1094</span></a>                <span class="nb">print</span><span class="p">(</span><span class="n">myn</span><span class="p">)</span>
</span><span id="L-1095"><a href="#L-1095"><span class="linenos">1095</span></a>            <span class="n">imgfn</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span> <span class="n">filenames</span><span class="p">,</span> <span class="mi">1</span> <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1096"><a href="#L-1096"><span class="linenos">1096</span></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1097"><a href="#L-1097"><span class="linenos">1097</span></a>                <span class="nb">print</span><span class="p">(</span><span class="n">imgfn</span><span class="p">)</span>
</span><span id="L-1098"><a href="#L-1098"><span class="linenos">1098</span></a>            <span class="n">img</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">image_read</span><span class="p">(</span> <span class="n">imgfn</span> <span class="p">)</span><span class="o">.</span><span class="n">iMath</span><span class="p">(</span><span class="s2">&quot;Normalize&quot;</span><span class="p">)</span>
</span><span id="L-1099"><a href="#L-1099"><span class="linenos">1099</span></a>            <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">components</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-1100"><a href="#L-1100"><span class="linenos">1100</span></a>                <span class="n">img</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">split_channels</span><span class="p">(</span><span class="n">img</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1101"><a href="#L-1101"><span class="linenos">1101</span></a>            <span class="n">img</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">crop_image</span><span class="p">(</span> <span class="n">img</span><span class="p">,</span> <span class="n">ants</span><span class="o">.</span><span class="n">threshold_image</span><span class="p">(</span> <span class="n">img</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">)</span>
</span><span id="L-1102"><a href="#L-1102"><span class="linenos">1102</span></a>            <span class="n">ants</span><span class="o">.</span><span class="n">set_origin</span><span class="p">(</span> <span class="n">img</span><span class="p">,</span> <span class="n">ants</span><span class="o">.</span><span class="n">get_center_of_mass</span><span class="p">(</span><span class="n">img</span><span class="p">)</span> <span class="p">)</span>
</span><span id="L-1103"><a href="#L-1103"><span class="linenos">1103</span></a>            <span class="n">img</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">iMath</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="s2">&quot;Normalize&quot;</span><span class="p">)</span>
</span><span id="L-1104"><a href="#L-1104"><span class="linenos">1104</span></a>            <span class="n">spc</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">get_spacing</span><span class="p">(</span> <span class="n">img</span> <span class="p">)</span>
</span><span id="L-1105"><a href="#L-1105"><span class="linenos">1105</span></a>            <span class="n">newspc</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1106"><a href="#L-1106"><span class="linenos">1106</span></a>            <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spc</span><span class="p">)):</span>
</span><span id="L-1107"><a href="#L-1107"><span class="linenos">1107</span></a>                <span class="n">newspc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spc</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span><span class="o">*</span><span class="n">strider</span><span class="p">[</span><span class="n">jj</span><span class="p">])</span>
</span><span id="L-1108"><a href="#L-1108"><span class="linenos">1108</span></a>            <span class="n">interp_type</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
</span><span id="L-1109"><a href="#L-1109"><span class="linenos">1109</span></a>            <span class="n">seg_class</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="p">)</span>
</span><span id="L-1110"><a href="#L-1110"><span class="linenos">1110</span></a>            <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="L-1111"><a href="#L-1111"><span class="linenos">1111</span></a>                <span class="n">imgp</span> <span class="o">=</span> <span class="n">get_random_patch</span><span class="p">(</span> <span class="n">img</span><span class="p">,</span> <span class="n">target_patch_size</span> <span class="p">)</span>
</span><span id="L-1112"><a href="#L-1112"><span class="linenos">1112</span></a>                <span class="n">imgpmin</span> <span class="o">=</span> <span class="n">imgp</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
</span><span id="L-1113"><a href="#L-1113"><span class="linenos">1113</span></a>                <span class="k">if</span> <span class="n">patch_scaler</span><span class="p">:</span>
</span><span id="L-1114"><a href="#L-1114"><span class="linenos">1114</span></a>                    <span class="n">imgp</span> <span class="o">=</span> <span class="n">imgp</span> <span class="o">-</span> <span class="n">imgpmin</span>
</span><span id="L-1115"><a href="#L-1115"><span class="linenos">1115</span></a>                    <span class="n">imgpmax</span> <span class="o">=</span> <span class="n">imgp</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</span><span id="L-1116"><a href="#L-1116"><span class="linenos">1116</span></a>                    <span class="k">if</span> <span class="n">imgpmax</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">:</span>
</span><span id="L-1117"><a href="#L-1117"><span class="linenos">1117</span></a>                        <span class="n">imgp</span> <span class="o">=</span> <span class="n">imgp</span> <span class="o">/</span> <span class="n">imgpmax</span>
</span><span id="L-1118"><a href="#L-1118"><span class="linenos">1118</span></a>                <span class="n">segp</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">threshold_image</span><span class="p">(</span> <span class="n">imgp</span><span class="p">,</span> <span class="s2">&quot;Otsu&quot;</span><span class="p">,</span> <span class="mi">2</span> <span class="p">)</span><span class="o">.</span><span class="n">threshold_image</span><span class="p">(</span> <span class="n">seg_class</span><span class="p">,</span> <span class="n">seg_class</span> <span class="p">)</span>
</span><span id="L-1119"><a href="#L-1119"><span class="linenos">1119</span></a>                <span class="n">rimgp</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">resample_image</span><span class="p">(</span> <span class="n">imgp</span><span class="p">,</span> <span class="n">newspc</span><span class="p">,</span> <span class="n">use_voxels</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">interp_type</span><span class="o">=</span><span class="n">interp_type</span>  <span class="p">)</span>
</span><span id="L-1120"><a href="#L-1120"><span class="linenos">1120</span></a>                <span class="n">rsegp</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">resample_image</span><span class="p">(</span> <span class="n">segp</span><span class="p">,</span> <span class="n">newspc</span><span class="p">,</span> <span class="n">use_voxels</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">interp_type</span><span class="o">=</span><span class="n">interp_type</span>  <span class="p">)</span>
</span><span id="L-1121"><a href="#L-1121"><span class="linenos">1121</span></a>                <span class="k">if</span> <span class="n">istest</span><span class="p">:</span>
</span><span id="L-1122"><a href="#L-1122"><span class="linenos">1122</span></a>                    <span class="n">rimgbi</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">resample_image</span><span class="p">(</span> <span class="n">rimgp</span><span class="p">,</span> <span class="n">spc</span><span class="p">,</span> <span class="n">use_voxels</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">interp_type</span><span class="o">=</span><span class="mi">0</span>  <span class="p">)</span>
</span><span id="L-1123"><a href="#L-1123"><span class="linenos">1123</span></a>                <span class="k">if</span> <span class="n">tardim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="L-1124"><a href="#L-1124"><span class="linenos">1124</span></a>                    <span class="n">patchesOrig</span><span class="p">[</span><span class="n">myn</span><span class="p">,:,:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">imgp</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="L-1125"><a href="#L-1125"><span class="linenos">1125</span></a>                    <span class="n">patchesResam</span><span class="p">[</span><span class="n">myn</span><span class="p">,:,:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">rimgp</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="L-1126"><a href="#L-1126"><span class="linenos">1126</span></a>                    <span class="n">patchesOrig</span><span class="p">[</span><span class="n">myn</span><span class="p">,:,:,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">segp</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="L-1127"><a href="#L-1127"><span class="linenos">1127</span></a>                    <span class="n">patchesResam</span><span class="p">[</span><span class="n">myn</span><span class="p">,:,:,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">rsegp</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="L-1128"><a href="#L-1128"><span class="linenos">1128</span></a>                    <span class="k">if</span> <span class="n">istest</span><span class="p">:</span>
</span><span id="L-1129"><a href="#L-1129"><span class="linenos">1129</span></a>                        <span class="n">patchesUp</span><span class="p">[</span><span class="n">myn</span><span class="p">,:,:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">rimgbi</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="L-1130"><a href="#L-1130"><span class="linenos">1130</span></a>                <span class="k">if</span> <span class="n">tardim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-1131"><a href="#L-1131"><span class="linenos">1131</span></a>                    <span class="n">patchesOrig</span><span class="p">[</span><span class="n">myn</span><span class="p">,:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">imgp</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="L-1132"><a href="#L-1132"><span class="linenos">1132</span></a>                    <span class="n">patchesResam</span><span class="p">[</span><span class="n">myn</span><span class="p">,:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">rimgp</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="L-1133"><a href="#L-1133"><span class="linenos">1133</span></a>                    <span class="n">patchesOrig</span><span class="p">[</span><span class="n">myn</span><span class="p">,:,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">segp</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="L-1134"><a href="#L-1134"><span class="linenos">1134</span></a>                    <span class="n">patchesResam</span><span class="p">[</span><span class="n">myn</span><span class="p">,:,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">rsegp</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="L-1135"><a href="#L-1135"><span class="linenos">1135</span></a>                    <span class="k">if</span> <span class="n">istest</span><span class="p">:</span>
</span><span id="L-1136"><a href="#L-1136"><span class="linenos">1136</span></a>                        <span class="n">patchesUp</span><span class="p">[</span><span class="n">myn</span><span class="p">,:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">rimgbi</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="L-1137"><a href="#L-1137"><span class="linenos">1137</span></a>    <span class="k">if</span> <span class="n">to_tensorflow</span><span class="p">:</span>
</span><span id="L-1138"><a href="#L-1138"><span class="linenos">1138</span></a>        <span class="n">patchesOrig</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span> <span class="n">patchesOrig</span><span class="p">,</span> <span class="s2">&quot;float32&quot;</span><span class="p">)</span>
</span><span id="L-1139"><a href="#L-1139"><span class="linenos">1139</span></a>        <span class="n">patchesResam</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span> <span class="n">patchesResam</span><span class="p">,</span> <span class="s2">&quot;float32&quot;</span><span class="p">)</span>
</span><span id="L-1140"><a href="#L-1140"><span class="linenos">1140</span></a>    <span class="k">if</span> <span class="n">istest</span><span class="p">:</span>
</span><span id="L-1141"><a href="#L-1141"><span class="linenos">1141</span></a>        <span class="k">if</span> <span class="n">to_tensorflow</span><span class="p">:</span>
</span><span id="L-1142"><a href="#L-1142"><span class="linenos">1142</span></a>            <span class="n">patchesUp</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span> <span class="n">patchesUp</span><span class="p">,</span> <span class="s2">&quot;float32&quot;</span><span class="p">)</span>
</span><span id="L-1143"><a href="#L-1143"><span class="linenos">1143</span></a>    <span class="k">return</span> <span class="n">patchesResam</span><span class="p">,</span> <span class="n">patchesOrig</span><span class="p">,</span> <span class="n">patchesUp</span>
</span><span id="L-1144"><a href="#L-1144"><span class="linenos">1144</span></a>
</span><span id="L-1145"><a href="#L-1145"><span class="linenos">1145</span></a><span class="k">def</span> <span class="nf">read</span><span class="p">(</span> <span class="n">filename</span> <span class="p">):</span>
</span><span id="L-1146"><a href="#L-1146"><span class="linenos">1146</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1147"><a href="#L-1147"><span class="linenos">1147</span></a><span class="sd">    Reads an image or a NumPy array from a file.</span>
</span><span id="L-1148"><a href="#L-1148"><span class="linenos">1148</span></a>
</span><span id="L-1149"><a href="#L-1149"><span class="linenos">1149</span></a><span class="sd">    This function acts as a wrapper to intelligently load data. It checks the</span>
</span><span id="L-1150"><a href="#L-1150"><span class="linenos">1150</span></a><span class="sd">    file extension to decide whether to use `ants.image_read` for standard</span>
</span><span id="L-1151"><a href="#L-1151"><span class="linenos">1151</span></a><span class="sd">    medical image formats (e.g., .nii.gz, .mha) or `numpy.load` for `.npy` files.</span>
</span><span id="L-1152"><a href="#L-1152"><span class="linenos">1152</span></a>
</span><span id="L-1153"><a href="#L-1153"><span class="linenos">1153</span></a><span class="sd">    Parameters</span>
</span><span id="L-1154"><a href="#L-1154"><span class="linenos">1154</span></a><span class="sd">    ----------</span>
</span><span id="L-1155"><a href="#L-1155"><span class="linenos">1155</span></a><span class="sd">    filename : str</span>
</span><span id="L-1156"><a href="#L-1156"><span class="linenos">1156</span></a><span class="sd">        The full path to the file to be read.</span>
</span><span id="L-1157"><a href="#L-1157"><span class="linenos">1157</span></a>
</span><span id="L-1158"><a href="#L-1158"><span class="linenos">1158</span></a><span class="sd">    Returns</span>
</span><span id="L-1159"><a href="#L-1159"><span class="linenos">1159</span></a><span class="sd">    -------</span>
</span><span id="L-1160"><a href="#L-1160"><span class="linenos">1160</span></a><span class="sd">    ants.ANTsImage or np.ndarray</span>
</span><span id="L-1161"><a href="#L-1161"><span class="linenos">1161</span></a><span class="sd">        The loaded data object, either as an ANTsImage or a NumPy array.</span>
</span><span id="L-1162"><a href="#L-1162"><span class="linenos">1162</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1163"><a href="#L-1163"><span class="linenos">1163</span></a>    <span class="kn">import</span> <span class="nn">re</span>
</span><span id="L-1164"><a href="#L-1164"><span class="linenos">1164</span></a>    <span class="n">isnpy</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span> <span class="s2">&quot;.npy&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">filename</span> <span class="p">)</span> <span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span> <span class="n">filename</span> <span class="p">)</span>
</span><span id="L-1165"><a href="#L-1165"><span class="linenos">1165</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">isnpy</span><span class="p">:</span>
</span><span id="L-1166"><a href="#L-1166"><span class="linenos">1166</span></a>        <span class="n">myoutput</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">image_read</span><span class="p">(</span> <span class="n">filename</span> <span class="p">)</span>
</span><span id="L-1167"><a href="#L-1167"><span class="linenos">1167</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-1168"><a href="#L-1168"><span class="linenos">1168</span></a>        <span class="n">myoutput</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span> <span class="n">filename</span> <span class="p">)</span>
</span><span id="L-1169"><a href="#L-1169"><span class="linenos">1169</span></a>    <span class="k">return</span> <span class="n">myoutput</span>
</span><span id="L-1170"><a href="#L-1170"><span class="linenos">1170</span></a>
</span><span id="L-1171"><a href="#L-1171"><span class="linenos">1171</span></a>
</span><span id="L-1172"><a href="#L-1172"><span class="linenos">1172</span></a><span class="k">def</span> <span class="nf">auto_weight_loss</span><span class="p">(</span> <span class="n">mdl</span><span class="p">,</span> <span class="n">feature_extractor</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">feature</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">tv</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span> <span class="p">):</span>
</span><span id="L-1173"><a href="#L-1173"><span class="linenos">1173</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1174"><a href="#L-1174"><span class="linenos">1174</span></a><span class="sd">    Automatically compute weighting coefficients for a combined loss function</span>
</span><span id="L-1175"><a href="#L-1175"><span class="linenos">1175</span></a><span class="sd">    based on intensity (MSE), perceptual similarity (feature), and total variation (TV).</span>
</span><span id="L-1176"><a href="#L-1176"><span class="linenos">1176</span></a>
</span><span id="L-1177"><a href="#L-1177"><span class="linenos">1177</span></a><span class="sd">    Parameters</span>
</span><span id="L-1178"><a href="#L-1178"><span class="linenos">1178</span></a><span class="sd">    ----------</span>
</span><span id="L-1179"><a href="#L-1179"><span class="linenos">1179</span></a><span class="sd">    mdl : tf.keras.Model</span>
</span><span id="L-1180"><a href="#L-1180"><span class="linenos">1180</span></a><span class="sd">        A trained or untrained model to evaluate predictions on input `x`.</span>
</span><span id="L-1181"><a href="#L-1181"><span class="linenos">1181</span></a>
</span><span id="L-1182"><a href="#L-1182"><span class="linenos">1182</span></a><span class="sd">    feature_extractor : tf.keras.Model</span>
</span><span id="L-1183"><a href="#L-1183"><span class="linenos">1183</span></a><span class="sd">        A model that extracts intermediate features from the input. Commonly a VGG or ResNet</span>
</span><span id="L-1184"><a href="#L-1184"><span class="linenos">1184</span></a><span class="sd">        trained on a perceptual task.</span>
</span><span id="L-1185"><a href="#L-1185"><span class="linenos">1185</span></a>
</span><span id="L-1186"><a href="#L-1186"><span class="linenos">1186</span></a><span class="sd">    x : tf.Tensor</span>
</span><span id="L-1187"><a href="#L-1187"><span class="linenos">1187</span></a><span class="sd">        Input batch to the model.</span>
</span><span id="L-1188"><a href="#L-1188"><span class="linenos">1188</span></a>
</span><span id="L-1189"><a href="#L-1189"><span class="linenos">1189</span></a><span class="sd">    y : tf.Tensor</span>
</span><span id="L-1190"><a href="#L-1190"><span class="linenos">1190</span></a><span class="sd">        Ground truth target for `x`, typically a batch of 2D or 3D volumes.</span>
</span><span id="L-1191"><a href="#L-1191"><span class="linenos">1191</span></a>
</span><span id="L-1192"><a href="#L-1192"><span class="linenos">1192</span></a><span class="sd">    feature : float, optional</span>
</span><span id="L-1193"><a href="#L-1193"><span class="linenos">1193</span></a><span class="sd">        Weighting factor for the feature (perceptual) term in the loss. Default is 2.0.</span>
</span><span id="L-1194"><a href="#L-1194"><span class="linenos">1194</span></a>
</span><span id="L-1195"><a href="#L-1195"><span class="linenos">1195</span></a><span class="sd">    tv : float, optional</span>
</span><span id="L-1196"><a href="#L-1196"><span class="linenos">1196</span></a><span class="sd">        Weighting factor for the total variation term in the loss. Default is 0.1.</span>
</span><span id="L-1197"><a href="#L-1197"><span class="linenos">1197</span></a>
</span><span id="L-1198"><a href="#L-1198"><span class="linenos">1198</span></a><span class="sd">    verbose : bool, optional</span>
</span><span id="L-1199"><a href="#L-1199"><span class="linenos">1199</span></a><span class="sd">        If True, prints each component of the loss and its scaled value.</span>
</span><span id="L-1200"><a href="#L-1200"><span class="linenos">1200</span></a>
</span><span id="L-1201"><a href="#L-1201"><span class="linenos">1201</span></a><span class="sd">    Returns</span>
</span><span id="L-1202"><a href="#L-1202"><span class="linenos">1202</span></a><span class="sd">    -------</span>
</span><span id="L-1203"><a href="#L-1203"><span class="linenos">1203</span></a><span class="sd">    list of float</span>
</span><span id="L-1204"><a href="#L-1204"><span class="linenos">1204</span></a><span class="sd">        A list of computed weights in the order:</span>
</span><span id="L-1205"><a href="#L-1205"><span class="linenos">1205</span></a><span class="sd">        `[msq_weight, feature_weight, tv_weight]`</span>
</span><span id="L-1206"><a href="#L-1206"><span class="linenos">1206</span></a>
</span><span id="L-1207"><a href="#L-1207"><span class="linenos">1207</span></a><span class="sd">    Notes</span>
</span><span id="L-1208"><a href="#L-1208"><span class="linenos">1208</span></a><span class="sd">    -----</span>
</span><span id="L-1209"><a href="#L-1209"><span class="linenos">1209</span></a><span class="sd">    The total loss (to be used during training) can then be constructed as:</span>
</span><span id="L-1210"><a href="#L-1210"><span class="linenos">1210</span></a>
</span><span id="L-1211"><a href="#L-1211"><span class="linenos">1211</span></a><span class="sd">        `L = msq_weight * MSE + feature_weight * perceptual_loss + tv_weight * TV`</span>
</span><span id="L-1212"><a href="#L-1212"><span class="linenos">1212</span></a>
</span><span id="L-1213"><a href="#L-1213"><span class="linenos">1213</span></a><span class="sd">    This function is typically used to balance loss terms before training.</span>
</span><span id="L-1214"><a href="#L-1214"><span class="linenos">1214</span></a><span class="sd">    &quot;&quot;&quot;</span>    
</span><span id="L-1215"><a href="#L-1215"><span class="linenos">1215</span></a>    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">mdl</span><span class="p">(</span> <span class="n">x</span> <span class="p">)</span>
</span><span id="L-1216"><a href="#L-1216"><span class="linenos">1216</span></a>    <span class="n">squared_difference</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">square</span><span class="p">(</span> <span class="n">y</span> <span class="o">-</span> <span class="n">y_pred</span><span class="p">)</span>
</span><span id="L-1217"><a href="#L-1217"><span class="linenos">1217</span></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
</span><span id="L-1218"><a href="#L-1218"><span class="linenos">1218</span></a>            <span class="n">tdim</span> <span class="o">=</span> <span class="mi">3</span>
</span><span id="L-1219"><a href="#L-1219"><span class="linenos">1219</span></a>            <span class="n">myax</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span>
</span><span id="L-1220"><a href="#L-1220"><span class="linenos">1220</span></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
</span><span id="L-1221"><a href="#L-1221"><span class="linenos">1221</span></a>            <span class="n">tdim</span> <span class="o">=</span> <span class="mi">2</span>
</span><span id="L-1222"><a href="#L-1222"><span class="linenos">1222</span></a>            <span class="n">myax</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
</span><span id="L-1223"><a href="#L-1223"><span class="linenos">1223</span></a>    <span class="n">msqTerm</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">squared_difference</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">myax</span><span class="p">)</span>
</span><span id="L-1224"><a href="#L-1224"><span class="linenos">1224</span></a>    <span class="n">temp1</span> <span class="o">=</span> <span class="n">feature_extractor</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</span><span id="L-1225"><a href="#L-1225"><span class="linenos">1225</span></a>    <span class="n">temp2</span> <span class="o">=</span> <span class="n">feature_extractor</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span>
</span><span id="L-1226"><a href="#L-1226"><span class="linenos">1226</span></a>    <span class="n">feature_difference</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">temp1</span><span class="o">-</span><span class="n">temp2</span><span class="p">)</span>
</span><span id="L-1227"><a href="#L-1227"><span class="linenos">1227</span></a>    <span class="n">featureTerm</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">feature_difference</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">myax</span><span class="p">)</span>
</span><span id="L-1228"><a href="#L-1228"><span class="linenos">1228</span></a>    <span class="n">msqw</span> <span class="o">=</span> <span class="mf">10.0</span>
</span><span id="L-1229"><a href="#L-1229"><span class="linenos">1229</span></a>    <span class="n">featw</span> <span class="o">=</span> <span class="n">feature</span> <span class="o">*</span> <span class="n">msqw</span> <span class="o">*</span> <span class="n">msqTerm</span> <span class="o">/</span> <span class="n">featureTerm</span>
</span><span id="L-1230"><a href="#L-1230"><span class="linenos">1230</span></a>    <span class="n">mytv</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s1">&#39;float32&#39;</span><span class="p">)</span>
</span><span id="L-1231"><a href="#L-1231"><span class="linenos">1231</span></a>    <span class="k">if</span> <span class="n">tdim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="L-1232"><a href="#L-1232"><span class="linenos">1232</span></a>        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">y_pred</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">):</span> <span class="c1"># BUG not sure why myr fails .... might be old TF version</span>
</span><span id="L-1233"><a href="#L-1233"><span class="linenos">1233</span></a>            <span class="n">sqzd</span> <span class="o">=</span> <span class="n">y_pred</span><span class="p">[</span><span class="n">k</span><span class="p">,:,:,:,:]</span>
</span><span id="L-1234"><a href="#L-1234"><span class="linenos">1234</span></a>            <span class="n">mytv</span> <span class="o">=</span> <span class="n">mytv</span> <span class="o">+</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">total_variation</span><span class="p">(</span> <span class="n">sqzd</span> <span class="p">)</span> <span class="p">)</span>
</span><span id="L-1235"><a href="#L-1235"><span class="linenos">1235</span></a>    <span class="k">if</span> <span class="n">tdim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-1236"><a href="#L-1236"><span class="linenos">1236</span></a>        <span class="n">mytv</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">total_variation</span><span class="p">(</span> <span class="n">y_pred</span> <span class="p">)</span> <span class="p">)</span>
</span><span id="L-1237"><a href="#L-1237"><span class="linenos">1237</span></a>    <span class="n">tvw</span> <span class="o">=</span> <span class="n">tv</span> <span class="o">*</span> <span class="n">msqw</span> <span class="o">*</span> <span class="n">msqTerm</span> <span class="o">/</span> <span class="n">mytv</span>
</span><span id="L-1238"><a href="#L-1238"><span class="linenos">1238</span></a>    <span class="k">if</span> <span class="n">verbose</span> <span class="p">:</span>
</span><span id="L-1239"><a href="#L-1239"><span class="linenos">1239</span></a>        <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;MSQ: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span> <span class="n">msqw</span> <span class="o">*</span> <span class="n">msqTerm</span> <span class="p">)</span> <span class="p">)</span>
</span><span id="L-1240"><a href="#L-1240"><span class="linenos">1240</span></a>        <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Feat: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span> <span class="n">featw</span> <span class="o">*</span> <span class="n">featureTerm</span> <span class="p">)</span> <span class="p">)</span>
</span><span id="L-1241"><a href="#L-1241"><span class="linenos">1241</span></a>        <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Tv: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>  <span class="n">mytv</span> <span class="o">*</span> <span class="n">tvw</span> <span class="p">)</span> <span class="p">)</span>
</span><span id="L-1242"><a href="#L-1242"><span class="linenos">1242</span></a>    <span class="n">wts</span> <span class="o">=</span> <span class="p">[</span><span class="n">msqw</span><span class="p">,</span><span class="n">featw</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span><span class="n">tvw</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()]</span>
</span><span id="L-1243"><a href="#L-1243"><span class="linenos">1243</span></a>    <span class="k">return</span> <span class="n">wts</span>
</span><span id="L-1244"><a href="#L-1244"><span class="linenos">1244</span></a>
</span><span id="L-1245"><a href="#L-1245"><span class="linenos">1245</span></a><span class="k">def</span> <span class="nf">auto_weight_loss_seg</span><span class="p">(</span> <span class="n">mdl</span><span class="p">,</span> <span class="n">feature_extractor</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">feature</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">tv</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">dice</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span> <span class="p">):</span>
</span><span id="L-1246"><a href="#L-1246"><span class="linenos">1246</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1247"><a href="#L-1247"><span class="linenos">1247</span></a><span class="sd">    Automatically compute weighting coefficients for a combined loss function</span>
</span><span id="L-1248"><a href="#L-1248"><span class="linenos">1248</span></a><span class="sd">    that includes MSE, perceptual similarity, total variation, and segmentation Dice loss.</span>
</span><span id="L-1249"><a href="#L-1249"><span class="linenos">1249</span></a>
</span><span id="L-1250"><a href="#L-1250"><span class="linenos">1250</span></a><span class="sd">    Parameters</span>
</span><span id="L-1251"><a href="#L-1251"><span class="linenos">1251</span></a><span class="sd">    ----------</span>
</span><span id="L-1252"><a href="#L-1252"><span class="linenos">1252</span></a><span class="sd">    mdl : tf.keras.Model</span>
</span><span id="L-1253"><a href="#L-1253"><span class="linenos">1253</span></a><span class="sd">        A segmentation + super-resolution model that outputs both image and label predictions.</span>
</span><span id="L-1254"><a href="#L-1254"><span class="linenos">1254</span></a>
</span><span id="L-1255"><a href="#L-1255"><span class="linenos">1255</span></a><span class="sd">    feature_extractor : tf.keras.Model</span>
</span><span id="L-1256"><a href="#L-1256"><span class="linenos">1256</span></a><span class="sd">        Feature extractor model used to compute perceptual similarity loss.</span>
</span><span id="L-1257"><a href="#L-1257"><span class="linenos">1257</span></a>
</span><span id="L-1258"><a href="#L-1258"><span class="linenos">1258</span></a><span class="sd">    x : tf.Tensor</span>
</span><span id="L-1259"><a href="#L-1259"><span class="linenos">1259</span></a><span class="sd">        Input tensor to the model.</span>
</span><span id="L-1260"><a href="#L-1260"><span class="linenos">1260</span></a>
</span><span id="L-1261"><a href="#L-1261"><span class="linenos">1261</span></a><span class="sd">    y : tf.Tensor</span>
</span><span id="L-1262"><a href="#L-1262"><span class="linenos">1262</span></a><span class="sd">        Target tensor with two channels: [intensity_image, segmentation_label].</span>
</span><span id="L-1263"><a href="#L-1263"><span class="linenos">1263</span></a>
</span><span id="L-1264"><a href="#L-1264"><span class="linenos">1264</span></a><span class="sd">    feature : float, optional</span>
</span><span id="L-1265"><a href="#L-1265"><span class="linenos">1265</span></a><span class="sd">        Relative weight of the perceptual feature loss term. Default is 2.0.</span>
</span><span id="L-1266"><a href="#L-1266"><span class="linenos">1266</span></a>
</span><span id="L-1267"><a href="#L-1267"><span class="linenos">1267</span></a><span class="sd">    tv : float, optional</span>
</span><span id="L-1268"><a href="#L-1268"><span class="linenos">1268</span></a><span class="sd">        Relative weight of the total variation (TV) term. Default is 0.1.</span>
</span><span id="L-1269"><a href="#L-1269"><span class="linenos">1269</span></a>
</span><span id="L-1270"><a href="#L-1270"><span class="linenos">1270</span></a><span class="sd">    dice : float, optional</span>
</span><span id="L-1271"><a href="#L-1271"><span class="linenos">1271</span></a><span class="sd">        Relative weight of the Dice loss term (for segmentation agreement). Default is 0.5.</span>
</span><span id="L-1272"><a href="#L-1272"><span class="linenos">1272</span></a>
</span><span id="L-1273"><a href="#L-1273"><span class="linenos">1273</span></a><span class="sd">    verbose : bool, optional</span>
</span><span id="L-1274"><a href="#L-1274"><span class="linenos">1274</span></a><span class="sd">        If True, prints the scaled values of each component loss.</span>
</span><span id="L-1275"><a href="#L-1275"><span class="linenos">1275</span></a>
</span><span id="L-1276"><a href="#L-1276"><span class="linenos">1276</span></a><span class="sd">    Returns</span>
</span><span id="L-1277"><a href="#L-1277"><span class="linenos">1277</span></a><span class="sd">    -------</span>
</span><span id="L-1278"><a href="#L-1278"><span class="linenos">1278</span></a><span class="sd">    list of float</span>
</span><span id="L-1279"><a href="#L-1279"><span class="linenos">1279</span></a><span class="sd">        A list of loss term weights in the order:</span>
</span><span id="L-1280"><a href="#L-1280"><span class="linenos">1280</span></a><span class="sd">        `[msq_weight, feature_weight, tv_weight, dice_weight]`</span>
</span><span id="L-1281"><a href="#L-1281"><span class="linenos">1281</span></a>
</span><span id="L-1282"><a href="#L-1282"><span class="linenos">1282</span></a><span class="sd">    Notes</span>
</span><span id="L-1283"><a href="#L-1283"><span class="linenos">1283</span></a><span class="sd">    -----</span>
</span><span id="L-1284"><a href="#L-1284"><span class="linenos">1284</span></a><span class="sd">    - The input and output tensors must be shaped such that the last axis is 2:</span>
</span><span id="L-1285"><a href="#L-1285"><span class="linenos">1285</span></a><span class="sd">      channel 0 is intensity, channel 1 is segmentation.</span>
</span><span id="L-1286"><a href="#L-1286"><span class="linenos">1286</span></a><span class="sd">    - This is useful for dual-task networks that predict both high-res images</span>
</span><span id="L-1287"><a href="#L-1287"><span class="linenos">1287</span></a><span class="sd">      and associated segmentation masks.</span>
</span><span id="L-1288"><a href="#L-1288"><span class="linenos">1288</span></a>
</span><span id="L-1289"><a href="#L-1289"><span class="linenos">1289</span></a><span class="sd">    See Also</span>
</span><span id="L-1290"><a href="#L-1290"><span class="linenos">1290</span></a><span class="sd">    --------</span>
</span><span id="L-1291"><a href="#L-1291"><span class="linenos">1291</span></a><span class="sd">    binary_dice_loss : Computes Dice loss between predicted and ground-truth masks.</span>
</span><span id="L-1292"><a href="#L-1292"><span class="linenos">1292</span></a><span class="sd">    &quot;&quot;&quot;</span>    
</span><span id="L-1293"><a href="#L-1293"><span class="linenos">1293</span></a>    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">mdl</span><span class="p">(</span> <span class="n">x</span> <span class="p">)</span>
</span><span id="L-1294"><a href="#L-1294"><span class="linenos">1294</span></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
</span><span id="L-1295"><a href="#L-1295"><span class="linenos">1295</span></a>            <span class="n">tdim</span> <span class="o">=</span> <span class="mi">3</span>
</span><span id="L-1296"><a href="#L-1296"><span class="linenos">1296</span></a>            <span class="n">myax</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span>
</span><span id="L-1297"><a href="#L-1297"><span class="linenos">1297</span></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
</span><span id="L-1298"><a href="#L-1298"><span class="linenos">1298</span></a>            <span class="n">tdim</span> <span class="o">=</span> <span class="mi">2</span>
</span><span id="L-1299"><a href="#L-1299"><span class="linenos">1299</span></a>            <span class="n">myax</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
</span><span id="L-1300"><a href="#L-1300"><span class="linenos">1300</span></a>    <span class="n">y_intensity</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span> <span class="n">y</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">tdim</span><span class="o">+</span><span class="mi">1</span> <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1301"><a href="#L-1301"><span class="linenos">1301</span></a>    <span class="n">y_seg</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span> <span class="n">y</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">tdim</span><span class="o">+</span><span class="mi">1</span> <span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-1302"><a href="#L-1302"><span class="linenos">1302</span></a>    <span class="n">y_intensity_p</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span> <span class="n">y_pred</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">tdim</span><span class="o">+</span><span class="mi">1</span> <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1303"><a href="#L-1303"><span class="linenos">1303</span></a>    <span class="n">y_seg_p</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span> <span class="n">y_pred</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">tdim</span><span class="o">+</span><span class="mi">1</span> <span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-1304"><a href="#L-1304"><span class="linenos">1304</span></a>    <span class="n">squared_difference</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">square</span><span class="p">(</span> <span class="n">y_intensity</span> <span class="o">-</span> <span class="n">y_intensity_p</span> <span class="p">)</span>
</span><span id="L-1305"><a href="#L-1305"><span class="linenos">1305</span></a>    <span class="n">msqTerm</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">squared_difference</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">myax</span><span class="p">)</span>
</span><span id="L-1306"><a href="#L-1306"><span class="linenos">1306</span></a>    <span class="n">temp1</span> <span class="o">=</span> <span class="n">feature_extractor</span><span class="p">(</span><span class="n">y_intensity</span><span class="p">)</span>
</span><span id="L-1307"><a href="#L-1307"><span class="linenos">1307</span></a>    <span class="n">temp2</span> <span class="o">=</span> <span class="n">feature_extractor</span><span class="p">(</span><span class="n">y_intensity_p</span><span class="p">)</span>
</span><span id="L-1308"><a href="#L-1308"><span class="linenos">1308</span></a>    <span class="n">feature_difference</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">temp1</span><span class="o">-</span><span class="n">temp2</span><span class="p">)</span>
</span><span id="L-1309"><a href="#L-1309"><span class="linenos">1309</span></a>    <span class="n">featureTerm</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">feature_difference</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">myax</span><span class="p">)</span>
</span><span id="L-1310"><a href="#L-1310"><span class="linenos">1310</span></a>    <span class="n">msqw</span> <span class="o">=</span> <span class="mf">10.0</span>
</span><span id="L-1311"><a href="#L-1311"><span class="linenos">1311</span></a>    <span class="n">featw</span> <span class="o">=</span> <span class="n">feature</span> <span class="o">*</span> <span class="n">msqw</span> <span class="o">*</span> <span class="n">msqTerm</span> <span class="o">/</span> <span class="n">featureTerm</span>
</span><span id="L-1312"><a href="#L-1312"><span class="linenos">1312</span></a>    <span class="n">mytv</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s1">&#39;float32&#39;</span><span class="p">)</span>
</span><span id="L-1313"><a href="#L-1313"><span class="linenos">1313</span></a>    <span class="k">if</span> <span class="n">tdim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="L-1314"><a href="#L-1314"><span class="linenos">1314</span></a>        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">y_pred</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">):</span> <span class="c1"># BUG not sure why myr fails .... might be old TF version</span>
</span><span id="L-1315"><a href="#L-1315"><span class="linenos">1315</span></a>            <span class="n">sqzd</span> <span class="o">=</span> <span class="n">y_pred</span><span class="p">[</span><span class="n">k</span><span class="p">,:,:,:,</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1316"><a href="#L-1316"><span class="linenos">1316</span></a>            <span class="n">mytv</span> <span class="o">=</span> <span class="n">mytv</span> <span class="o">+</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">total_variation</span><span class="p">(</span> <span class="n">sqzd</span> <span class="p">)</span> <span class="p">)</span>
</span><span id="L-1317"><a href="#L-1317"><span class="linenos">1317</span></a>    <span class="k">if</span> <span class="n">tdim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-1318"><a href="#L-1318"><span class="linenos">1318</span></a>        <span class="n">mytv</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">total_variation</span><span class="p">(</span> <span class="n">y_pred</span><span class="p">[:,:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="p">)</span>
</span><span id="L-1319"><a href="#L-1319"><span class="linenos">1319</span></a>    <span class="n">tvw</span> <span class="o">=</span> <span class="n">tv</span> <span class="o">*</span> <span class="n">msqw</span> <span class="o">*</span> <span class="n">msqTerm</span> <span class="o">/</span> <span class="n">mytv</span>
</span><span id="L-1320"><a href="#L-1320"><span class="linenos">1320</span></a>    <span class="n">mydice</span> <span class="o">=</span> <span class="n">binary_dice_loss</span><span class="p">(</span> <span class="n">y_seg</span><span class="p">,</span> <span class="n">y_seg_p</span> <span class="p">)</span>
</span><span id="L-1321"><a href="#L-1321"><span class="linenos">1321</span></a>    <span class="n">mydice</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span> <span class="n">mydice</span> <span class="p">)</span>
</span><span id="L-1322"><a href="#L-1322"><span class="linenos">1322</span></a>    <span class="n">dicew</span> <span class="o">=</span> <span class="n">dice</span> <span class="o">*</span> <span class="n">msqw</span> <span class="o">*</span> <span class="n">msqTerm</span> <span class="o">/</span> <span class="n">mydice</span>
</span><span id="L-1323"><a href="#L-1323"><span class="linenos">1323</span></a>    <span class="n">dicewt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span> <span class="n">dicew</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="p">)</span>
</span><span id="L-1324"><a href="#L-1324"><span class="linenos">1324</span></a>    <span class="k">if</span> <span class="n">verbose</span> <span class="p">:</span>
</span><span id="L-1325"><a href="#L-1325"><span class="linenos">1325</span></a>        <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;MSQ: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span> <span class="n">msqw</span> <span class="o">*</span> <span class="n">msqTerm</span> <span class="p">)</span> <span class="p">)</span>
</span><span id="L-1326"><a href="#L-1326"><span class="linenos">1326</span></a>        <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Feat: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span> <span class="n">featw</span> <span class="o">*</span> <span class="n">featureTerm</span> <span class="p">)</span> <span class="p">)</span>
</span><span id="L-1327"><a href="#L-1327"><span class="linenos">1327</span></a>        <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Tv: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>  <span class="n">mytv</span> <span class="o">*</span> <span class="n">tvw</span> <span class="p">)</span> <span class="p">)</span>
</span><span id="L-1328"><a href="#L-1328"><span class="linenos">1328</span></a>        <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Dice: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span> <span class="n">mydice</span> <span class="o">*</span> <span class="n">dicewt</span> <span class="p">)</span> <span class="p">)</span>
</span><span id="L-1329"><a href="#L-1329"><span class="linenos">1329</span></a>    <span class="n">wts</span> <span class="o">=</span> <span class="p">[</span><span class="n">msqw</span><span class="p">,</span><span class="n">featw</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span><span class="n">tvw</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">dicewt</span> <span class="p">]</span>
</span><span id="L-1330"><a href="#L-1330"><span class="linenos">1330</span></a>    <span class="k">return</span> <span class="n">wts</span>
</span><span id="L-1331"><a href="#L-1331"><span class="linenos">1331</span></a>
</span><span id="L-1332"><a href="#L-1332"><span class="linenos">1332</span></a><span class="k">def</span> <span class="nf">numpy_generator</span><span class="p">(</span> <span class="n">filenames</span> <span class="p">):</span>
</span><span id="L-1333"><a href="#L-1333"><span class="linenos">1333</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1334"><a href="#L-1334"><span class="linenos">1334</span></a><span class="sd">    A placeholder or stub for a data generator.</span>
</span><span id="L-1335"><a href="#L-1335"><span class="linenos">1335</span></a>
</span><span id="L-1336"><a href="#L-1336"><span class="linenos">1336</span></a><span class="sd">    This generator yields a tuple of `None` values once and then stops. It is</span>
</span><span id="L-1337"><a href="#L-1337"><span class="linenos">1337</span></a><span class="sd">    likely intended as a template or for debugging purposes where a generator</span>
</span><span id="L-1338"><a href="#L-1338"><span class="linenos">1338</span></a><span class="sd">    object is required but no actual data needs to be processed.</span>
</span><span id="L-1339"><a href="#L-1339"><span class="linenos">1339</span></a>
</span><span id="L-1340"><a href="#L-1340"><span class="linenos">1340</span></a><span class="sd">    Parameters</span>
</span><span id="L-1341"><a href="#L-1341"><span class="linenos">1341</span></a><span class="sd">    ----------</span>
</span><span id="L-1342"><a href="#L-1342"><span class="linenos">1342</span></a><span class="sd">    filenames : any</span>
</span><span id="L-1343"><a href="#L-1343"><span class="linenos">1343</span></a><span class="sd">        An argument that is not used by the function.</span>
</span><span id="L-1344"><a href="#L-1344"><span class="linenos">1344</span></a>
</span><span id="L-1345"><a href="#L-1345"><span class="linenos">1345</span></a><span class="sd">    Yields</span>
</span><span id="L-1346"><a href="#L-1346"><span class="linenos">1346</span></a><span class="sd">    ------</span>
</span><span id="L-1347"><a href="#L-1347"><span class="linenos">1347</span></a><span class="sd">    tuple</span>
</span><span id="L-1348"><a href="#L-1348"><span class="linenos">1348</span></a><span class="sd">        A single tuple `(None, None, None)`.</span>
</span><span id="L-1349"><a href="#L-1349"><span class="linenos">1349</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1350"><a href="#L-1350"><span class="linenos">1350</span></a>    <span class="n">patchesResam</span><span class="o">=</span><span class="n">patchesOrig</span><span class="o">=</span><span class="n">patchesUp</span><span class="o">=</span><span class="kc">None</span>
</span><span id="L-1351"><a href="#L-1351"><span class="linenos">1351</span></a>    <span class="k">yield</span> <span class="p">(</span><span class="n">patchesResam</span><span class="p">,</span> <span class="n">patchesOrig</span><span class="p">,</span><span class="n">patchesUp</span><span class="p">)</span>
</span><span id="L-1352"><a href="#L-1352"><span class="linenos">1352</span></a>
</span><span id="L-1353"><a href="#L-1353"><span class="linenos">1353</span></a><span class="k">def</span> <span class="nf">image_generator</span><span class="p">(</span>
</span><span id="L-1354"><a href="#L-1354"><span class="linenos">1354</span></a>    <span class="n">filenames</span><span class="p">,</span>
</span><span id="L-1355"><a href="#L-1355"><span class="linenos">1355</span></a>    <span class="n">nPatches</span><span class="p">,</span>
</span><span id="L-1356"><a href="#L-1356"><span class="linenos">1356</span></a>    <span class="n">target_patch_size</span><span class="p">,</span>
</span><span id="L-1357"><a href="#L-1357"><span class="linenos">1357</span></a>    <span class="n">target_patch_size_low</span><span class="p">,</span>
</span><span id="L-1358"><a href="#L-1358"><span class="linenos">1358</span></a>    <span class="n">patch_scaler</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-1359"><a href="#L-1359"><span class="linenos">1359</span></a>    <span class="n">istest</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-1360"><a href="#L-1360"><span class="linenos">1360</span></a>    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span> <span class="p">):</span>
</span><span id="L-1361"><a href="#L-1361"><span class="linenos">1361</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1362"><a href="#L-1362"><span class="linenos">1362</span></a><span class="sd">    Creates an infinite generator of paired image patches for model training.</span>
</span><span id="L-1363"><a href="#L-1363"><span class="linenos">1363</span></a>
</span><span id="L-1364"><a href="#L-1364"><span class="linenos">1364</span></a><span class="sd">    This function continuously generates batches of low-resolution (input) and</span>
</span><span id="L-1365"><a href="#L-1365"><span class="linenos">1365</span></a><span class="sd">    high-resolution (ground truth) image patches. It is designed to be fed</span>
</span><span id="L-1366"><a href="#L-1366"><span class="linenos">1366</span></a><span class="sd">    directly into a Keras `model.fit()` call.</span>
</span><span id="L-1367"><a href="#L-1367"><span class="linenos">1367</span></a>
</span><span id="L-1368"><a href="#L-1368"><span class="linenos">1368</span></a><span class="sd">    Parameters</span>
</span><span id="L-1369"><a href="#L-1369"><span class="linenos">1369</span></a><span class="sd">    ----------</span>
</span><span id="L-1370"><a href="#L-1370"><span class="linenos">1370</span></a><span class="sd">    filenames : list of str</span>
</span><span id="L-1371"><a href="#L-1371"><span class="linenos">1371</span></a><span class="sd">        List of file paths to the high-resolution source images.</span>
</span><span id="L-1372"><a href="#L-1372"><span class="linenos">1372</span></a><span class="sd">    nPatches : int</span>
</span><span id="L-1373"><a href="#L-1373"><span class="linenos">1373</span></a><span class="sd">        The number of patch pairs to generate and yield in each batch.</span>
</span><span id="L-1374"><a href="#L-1374"><span class="linenos">1374</span></a><span class="sd">    target_patch_size : tuple or list of int</span>
</span><span id="L-1375"><a href="#L-1375"><span class="linenos">1375</span></a><span class="sd">        The dimensions of the high-resolution (ground truth) patches.</span>
</span><span id="L-1376"><a href="#L-1376"><span class="linenos">1376</span></a><span class="sd">    target_patch_size_low : tuple or list of int</span>
</span><span id="L-1377"><a href="#L-1377"><span class="linenos">1377</span></a><span class="sd">        The dimensions of the low-resolution (input) patches.</span>
</span><span id="L-1378"><a href="#L-1378"><span class="linenos">1378</span></a><span class="sd">    patch_scaler : bool, optional</span>
</span><span id="L-1379"><a href="#L-1379"><span class="linenos">1379</span></a><span class="sd">        If True, scales patch intensities to [0, 1]. Default is True.</span>
</span><span id="L-1380"><a href="#L-1380"><span class="linenos">1380</span></a><span class="sd">    istest : bool, optional</span>
</span><span id="L-1381"><a href="#L-1381"><span class="linenos">1381</span></a><span class="sd">        If True, the generator will also yield a third item: a baseline</span>
</span><span id="L-1382"><a href="#L-1382"><span class="linenos">1382</span></a><span class="sd">        linearly upsampled version of the low-resolution patch for comparison.</span>
</span><span id="L-1383"><a href="#L-1383"><span class="linenos">1383</span></a><span class="sd">        Default is False.</span>
</span><span id="L-1384"><a href="#L-1384"><span class="linenos">1384</span></a><span class="sd">    verbose : bool, optional</span>
</span><span id="L-1385"><a href="#L-1385"><span class="linenos">1385</span></a><span class="sd">        If True, passes verbosity to the underlying patch generation function.</span>
</span><span id="L-1386"><a href="#L-1386"><span class="linenos">1386</span></a><span class="sd">        Default is False.</span>
</span><span id="L-1387"><a href="#L-1387"><span class="linenos">1387</span></a>
</span><span id="L-1388"><a href="#L-1388"><span class="linenos">1388</span></a><span class="sd">    Yields</span>
</span><span id="L-1389"><a href="#L-1389"><span class="linenos">1389</span></a><span class="sd">    -------</span>
</span><span id="L-1390"><a href="#L-1390"><span class="linenos">1390</span></a><span class="sd">    tuple</span>
</span><span id="L-1391"><a href="#L-1391"><span class="linenos">1391</span></a><span class="sd">        A tuple of TensorFlow tensors ready for training or evaluation.</span>
</span><span id="L-1392"><a href="#L-1392"><span class="linenos">1392</span></a><span class="sd">        - If `istest` is False: `(low_res_batch, high_res_batch)`</span>
</span><span id="L-1393"><a href="#L-1393"><span class="linenos">1393</span></a><span class="sd">        - If `istest` is True: `(low_res_batch, high_res_batch, baseline_upsampled_batch)`</span>
</span><span id="L-1394"><a href="#L-1394"><span class="linenos">1394</span></a>
</span><span id="L-1395"><a href="#L-1395"><span class="linenos">1395</span></a><span class="sd">    See Also</span>
</span><span id="L-1396"><a href="#L-1396"><span class="linenos">1396</span></a><span class="sd">    --------</span>
</span><span id="L-1397"><a href="#L-1397"><span class="linenos">1397</span></a><span class="sd">    image_patch_training_data_from_filenames : The function that performs the</span>
</span><span id="L-1398"><a href="#L-1398"><span class="linenos">1398</span></a><span class="sd">                                               underlying patch extraction.</span>
</span><span id="L-1399"><a href="#L-1399"><span class="linenos">1399</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1400"><a href="#L-1400"><span class="linenos">1400</span></a>    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="L-1401"><a href="#L-1401"><span class="linenos">1401</span></a>        <span class="n">patchesResam</span><span class="p">,</span> <span class="n">patchesOrig</span><span class="p">,</span> <span class="n">patchesUp</span> <span class="o">=</span> <span class="n">image_patch_training_data_from_filenames</span><span class="p">(</span>
</span><span id="L-1402"><a href="#L-1402"><span class="linenos">1402</span></a>            <span class="n">filenames</span><span class="p">,</span>
</span><span id="L-1403"><a href="#L-1403"><span class="linenos">1403</span></a>            <span class="n">target_patch_size</span> <span class="o">=</span> <span class="n">target_patch_size</span><span class="p">,</span>
</span><span id="L-1404"><a href="#L-1404"><span class="linenos">1404</span></a>            <span class="n">target_patch_size_low</span> <span class="o">=</span> <span class="n">target_patch_size_low</span><span class="p">,</span>
</span><span id="L-1405"><a href="#L-1405"><span class="linenos">1405</span></a>            <span class="n">nPatches</span> <span class="o">=</span> <span class="n">nPatches</span><span class="p">,</span>
</span><span id="L-1406"><a href="#L-1406"><span class="linenos">1406</span></a>            <span class="n">istest</span>   <span class="o">=</span> <span class="n">istest</span><span class="p">,</span>
</span><span id="L-1407"><a href="#L-1407"><span class="linenos">1407</span></a>            <span class="n">patch_scaler</span><span class="o">=</span><span class="n">patch_scaler</span><span class="p">,</span>
</span><span id="L-1408"><a href="#L-1408"><span class="linenos">1408</span></a>            <span class="n">to_tensorflow</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="L-1409"><a href="#L-1409"><span class="linenos">1409</span></a>            <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span> <span class="p">)</span>
</span><span id="L-1410"><a href="#L-1410"><span class="linenos">1410</span></a>        <span class="k">if</span> <span class="n">istest</span><span class="p">:</span>
</span><span id="L-1411"><a href="#L-1411"><span class="linenos">1411</span></a>            <span class="k">yield</span> <span class="p">(</span><span class="n">patchesResam</span><span class="p">,</span> <span class="n">patchesOrig</span><span class="p">,</span><span class="n">patchesUp</span><span class="p">)</span>
</span><span id="L-1412"><a href="#L-1412"><span class="linenos">1412</span></a>        <span class="k">yield</span> <span class="p">(</span><span class="n">patchesResam</span><span class="p">,</span> <span class="n">patchesOrig</span><span class="p">)</span>
</span><span id="L-1413"><a href="#L-1413"><span class="linenos">1413</span></a>
</span><span id="L-1414"><a href="#L-1414"><span class="linenos">1414</span></a>
</span><span id="L-1415"><a href="#L-1415"><span class="linenos">1415</span></a><span class="k">def</span> <span class="nf">seg_generator</span><span class="p">(</span>
</span><span id="L-1416"><a href="#L-1416"><span class="linenos">1416</span></a>    <span class="n">filenames</span><span class="p">,</span>
</span><span id="L-1417"><a href="#L-1417"><span class="linenos">1417</span></a>    <span class="n">nPatches</span><span class="p">,</span>
</span><span id="L-1418"><a href="#L-1418"><span class="linenos">1418</span></a>    <span class="n">target_patch_size</span><span class="p">,</span>
</span><span id="L-1419"><a href="#L-1419"><span class="linenos">1419</span></a>    <span class="n">target_patch_size_low</span><span class="p">,</span>
</span><span id="L-1420"><a href="#L-1420"><span class="linenos">1420</span></a>    <span class="n">patch_scaler</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-1421"><a href="#L-1421"><span class="linenos">1421</span></a>    <span class="n">istest</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-1422"><a href="#L-1422"><span class="linenos">1422</span></a>    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span> <span class="p">):</span>
</span><span id="L-1423"><a href="#L-1423"><span class="linenos">1423</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1424"><a href="#L-1424"><span class="linenos">1424</span></a><span class="sd">    Creates an infinite generator of paired image and segmentation patches.</span>
</span><span id="L-1425"><a href="#L-1425"><span class="linenos">1425</span></a>
</span><span id="L-1426"><a href="#L-1426"><span class="linenos">1426</span></a><span class="sd">    This function continuously generates batches of multi-channel patches, where</span>
</span><span id="L-1427"><a href="#L-1427"><span class="linenos">1427</span></a><span class="sd">    one channel is the intensity image and the other is a segmentation mask.</span>
</span><span id="L-1428"><a href="#L-1428"><span class="linenos">1428</span></a><span class="sd">    It is designed for training multi-task super-resolution models.</span>
</span><span id="L-1429"><a href="#L-1429"><span class="linenos">1429</span></a>
</span><span id="L-1430"><a href="#L-1430"><span class="linenos">1430</span></a><span class="sd">    Parameters</span>
</span><span id="L-1431"><a href="#L-1431"><span class="linenos">1431</span></a><span class="sd">    ----------</span>
</span><span id="L-1432"><a href="#L-1432"><span class="linenos">1432</span></a><span class="sd">    filenames : list of str</span>
</span><span id="L-1433"><a href="#L-1433"><span class="linenos">1433</span></a><span class="sd">        List of file paths to the high-resolution source images.</span>
</span><span id="L-1434"><a href="#L-1434"><span class="linenos">1434</span></a><span class="sd">    nPatches : int</span>
</span><span id="L-1435"><a href="#L-1435"><span class="linenos">1435</span></a><span class="sd">        The number of patch pairs to generate and yield in each batch.</span>
</span><span id="L-1436"><a href="#L-1436"><span class="linenos">1436</span></a><span class="sd">    target_patch_size : tuple or list of int</span>
</span><span id="L-1437"><a href="#L-1437"><span class="linenos">1437</span></a><span class="sd">        The dimensions of the high-resolution patches.</span>
</span><span id="L-1438"><a href="#L-1438"><span class="linenos">1438</span></a><span class="sd">    target_patch_size_low : tuple or list of int</span>
</span><span id="L-1439"><a href="#L-1439"><span class="linenos">1439</span></a><span class="sd">        The dimensions of the low-resolution patches.</span>
</span><span id="L-1440"><a href="#L-1440"><span class="linenos">1440</span></a><span class="sd">    patch_scaler : bool, optional</span>
</span><span id="L-1441"><a href="#L-1441"><span class="linenos">1441</span></a><span class="sd">        If True, scales the intensity channel of patches to [0, 1]. Default is True.</span>
</span><span id="L-1442"><a href="#L-1442"><span class="linenos">1442</span></a><span class="sd">    istest : bool, optional</span>
</span><span id="L-1443"><a href="#L-1443"><span class="linenos">1443</span></a><span class="sd">        If True, yields an additional baseline upsampled patch for comparison.</span>
</span><span id="L-1444"><a href="#L-1444"><span class="linenos">1444</span></a><span class="sd">        Default is False.</span>
</span><span id="L-1445"><a href="#L-1445"><span class="linenos">1445</span></a><span class="sd">    verbose : bool, optional</span>
</span><span id="L-1446"><a href="#L-1446"><span class="linenos">1446</span></a><span class="sd">        If True, passes verbosity to the underlying patch generation function.</span>
</span><span id="L-1447"><a href="#L-1447"><span class="linenos">1447</span></a><span class="sd">        Default is False.</span>
</span><span id="L-1448"><a href="#L-1448"><span class="linenos">1448</span></a>
</span><span id="L-1449"><a href="#L-1449"><span class="linenos">1449</span></a><span class="sd">    Yields</span>
</span><span id="L-1450"><a href="#L-1450"><span class="linenos">1450</span></a><span class="sd">    -------</span>
</span><span id="L-1451"><a href="#L-1451"><span class="linenos">1451</span></a><span class="sd">    tuple</span>
</span><span id="L-1452"><a href="#L-1452"><span class="linenos">1452</span></a><span class="sd">        A tuple of multi-channel TensorFlow tensors. Each tensor has two channels:</span>
</span><span id="L-1453"><a href="#L-1453"><span class="linenos">1453</span></a><span class="sd">        Channel 0 contains the intensity image, and Channel 1 contains the</span>
</span><span id="L-1454"><a href="#L-1454"><span class="linenos">1454</span></a><span class="sd">        segmentation mask.</span>
</span><span id="L-1455"><a href="#L-1455"><span class="linenos">1455</span></a>
</span><span id="L-1456"><a href="#L-1456"><span class="linenos">1456</span></a><span class="sd">    See Also</span>
</span><span id="L-1457"><a href="#L-1457"><span class="linenos">1457</span></a><span class="sd">    --------</span>
</span><span id="L-1458"><a href="#L-1458"><span class="linenos">1458</span></a><span class="sd">    seg_patch_training_data_from_filenames : The function that performs the</span>
</span><span id="L-1459"><a href="#L-1459"><span class="linenos">1459</span></a><span class="sd">                                             underlying patch extraction.</span>
</span><span id="L-1460"><a href="#L-1460"><span class="linenos">1460</span></a><span class="sd">    image_generator : A similar generator for intensity-only data.</span>
</span><span id="L-1461"><a href="#L-1461"><span class="linenos">1461</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1462"><a href="#L-1462"><span class="linenos">1462</span></a>    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="L-1463"><a href="#L-1463"><span class="linenos">1463</span></a>        <span class="n">patchesResam</span><span class="p">,</span> <span class="n">patchesOrig</span><span class="p">,</span> <span class="n">patchesUp</span> <span class="o">=</span> <span class="n">seg_patch_training_data_from_filenames</span><span class="p">(</span>
</span><span id="L-1464"><a href="#L-1464"><span class="linenos">1464</span></a>            <span class="n">filenames</span><span class="p">,</span>
</span><span id="L-1465"><a href="#L-1465"><span class="linenos">1465</span></a>            <span class="n">target_patch_size</span> <span class="o">=</span> <span class="n">target_patch_size</span><span class="p">,</span>
</span><span id="L-1466"><a href="#L-1466"><span class="linenos">1466</span></a>            <span class="n">target_patch_size_low</span> <span class="o">=</span> <span class="n">target_patch_size_low</span><span class="p">,</span>
</span><span id="L-1467"><a href="#L-1467"><span class="linenos">1467</span></a>            <span class="n">nPatches</span> <span class="o">=</span> <span class="n">nPatches</span><span class="p">,</span>
</span><span id="L-1468"><a href="#L-1468"><span class="linenos">1468</span></a>            <span class="n">istest</span>   <span class="o">=</span> <span class="n">istest</span><span class="p">,</span>
</span><span id="L-1469"><a href="#L-1469"><span class="linenos">1469</span></a>            <span class="n">patch_scaler</span><span class="o">=</span><span class="n">patch_scaler</span><span class="p">,</span>
</span><span id="L-1470"><a href="#L-1470"><span class="linenos">1470</span></a>            <span class="n">to_tensorflow</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="L-1471"><a href="#L-1471"><span class="linenos">1471</span></a>            <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span> <span class="p">)</span>
</span><span id="L-1472"><a href="#L-1472"><span class="linenos">1472</span></a>        <span class="k">if</span> <span class="n">istest</span><span class="p">:</span>
</span><span id="L-1473"><a href="#L-1473"><span class="linenos">1473</span></a>            <span class="k">yield</span> <span class="p">(</span><span class="n">patchesResam</span><span class="p">,</span> <span class="n">patchesOrig</span><span class="p">,</span><span class="n">patchesUp</span><span class="p">)</span>
</span><span id="L-1474"><a href="#L-1474"><span class="linenos">1474</span></a>        <span class="k">yield</span> <span class="p">(</span><span class="n">patchesResam</span><span class="p">,</span> <span class="n">patchesOrig</span><span class="p">)</span>
</span><span id="L-1475"><a href="#L-1475"><span class="linenos">1475</span></a>
</span><span id="L-1476"><a href="#L-1476"><span class="linenos">1476</span></a>
</span><span id="L-1477"><a href="#L-1477"><span class="linenos">1477</span></a><span class="k">def</span> <span class="nf">train</span><span class="p">(</span>
</span><span id="L-1478"><a href="#L-1478"><span class="linenos">1478</span></a>    <span class="n">mdl</span><span class="p">,</span>
</span><span id="L-1479"><a href="#L-1479"><span class="linenos">1479</span></a>    <span class="n">filenames_train</span><span class="p">,</span>
</span><span id="L-1480"><a href="#L-1480"><span class="linenos">1480</span></a>    <span class="n">filenames_test</span><span class="p">,</span>
</span><span id="L-1481"><a href="#L-1481"><span class="linenos">1481</span></a>    <span class="n">target_patch_size</span><span class="p">,</span>
</span><span id="L-1482"><a href="#L-1482"><span class="linenos">1482</span></a>    <span class="n">target_patch_size_low</span><span class="p">,</span>
</span><span id="L-1483"><a href="#L-1483"><span class="linenos">1483</span></a>    <span class="n">output_prefix</span><span class="p">,</span>
</span><span id="L-1484"><a href="#L-1484"><span class="linenos">1484</span></a>    <span class="n">n_test</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
</span><span id="L-1485"><a href="#L-1485"><span class="linenos">1485</span></a>    <span class="n">learning_rate</span><span class="o">=</span><span class="mf">5e-5</span><span class="p">,</span>
</span><span id="L-1486"><a href="#L-1486"><span class="linenos">1486</span></a>    <span class="n">feature_layer</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
</span><span id="L-1487"><a href="#L-1487"><span class="linenos">1487</span></a>    <span class="n">feature</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
</span><span id="L-1488"><a href="#L-1488"><span class="linenos">1488</span></a>    <span class="n">tv</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
</span><span id="L-1489"><a href="#L-1489"><span class="linenos">1489</span></a>    <span class="n">max_iterations</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
</span><span id="L-1490"><a href="#L-1490"><span class="linenos">1490</span></a>    <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="L-1491"><a href="#L-1491"><span class="linenos">1491</span></a>    <span class="n">save_all_best</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-1492"><a href="#L-1492"><span class="linenos">1492</span></a>    <span class="n">feature_type</span> <span class="o">=</span> <span class="s1">&#39;grader&#39;</span><span class="p">,</span>
</span><span id="L-1493"><a href="#L-1493"><span class="linenos">1493</span></a>    <span class="n">check_eval_data_iteration</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
</span><span id="L-1494"><a href="#L-1494"><span class="linenos">1494</span></a>    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span>  <span class="p">):</span>
</span><span id="L-1495"><a href="#L-1495"><span class="linenos">1495</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1496"><a href="#L-1496"><span class="linenos">1496</span></a><span class="sd">    Orchestrates the training process for a super-resolution model.</span>
</span><span id="L-1497"><a href="#L-1497"><span class="linenos">1497</span></a>
</span><span id="L-1498"><a href="#L-1498"><span class="linenos">1498</span></a><span class="sd">    This function handles the entire training loop, including setting up data</span>
</span><span id="L-1499"><a href="#L-1499"><span class="linenos">1499</span></a><span class="sd">    generators, defining a composite loss function, automatically balancing loss</span>
</span><span id="L-1500"><a href="#L-1500"><span class="linenos">1500</span></a><span class="sd">    weights, iteratively training the model, periodically evaluating performance,</span>
</span><span id="L-1501"><a href="#L-1501"><span class="linenos">1501</span></a><span class="sd">    and saving the best-performing model weights.</span>
</span><span id="L-1502"><a href="#L-1502"><span class="linenos">1502</span></a>
</span><span id="L-1503"><a href="#L-1503"><span class="linenos">1503</span></a><span class="sd">    Parameters</span>
</span><span id="L-1504"><a href="#L-1504"><span class="linenos">1504</span></a><span class="sd">    ----------</span>
</span><span id="L-1505"><a href="#L-1505"><span class="linenos">1505</span></a><span class="sd">    mdl : tf.keras.Model</span>
</span><span id="L-1506"><a href="#L-1506"><span class="linenos">1506</span></a><span class="sd">        The Keras model to be trained.</span>
</span><span id="L-1507"><a href="#L-1507"><span class="linenos">1507</span></a><span class="sd">    filenames_train : list of str</span>
</span><span id="L-1508"><a href="#L-1508"><span class="linenos">1508</span></a><span class="sd">        List of file paths for the training dataset.</span>
</span><span id="L-1509"><a href="#L-1509"><span class="linenos">1509</span></a><span class="sd">    filenames_test : list of str</span>
</span><span id="L-1510"><a href="#L-1510"><span class="linenos">1510</span></a><span class="sd">        List of file paths for the validation/testing dataset.</span>
</span><span id="L-1511"><a href="#L-1511"><span class="linenos">1511</span></a><span class="sd">    target_patch_size : tuple or list</span>
</span><span id="L-1512"><a href="#L-1512"><span class="linenos">1512</span></a><span class="sd">        The dimensions of the high-resolution target patches.</span>
</span><span id="L-1513"><a href="#L-1513"><span class="linenos">1513</span></a><span class="sd">    target_patch_size_low : tuple or list</span>
</span><span id="L-1514"><a href="#L-1514"><span class="linenos">1514</span></a><span class="sd">        The dimensions of the low-resolution input patches.</span>
</span><span id="L-1515"><a href="#L-1515"><span class="linenos">1515</span></a><span class="sd">    output_prefix : str</span>
</span><span id="L-1516"><a href="#L-1516"><span class="linenos">1516</span></a><span class="sd">        A prefix for all output files (e.g., model weights, training logs).</span>
</span><span id="L-1517"><a href="#L-1517"><span class="linenos">1517</span></a><span class="sd">    n_test : int, optional</span>
</span><span id="L-1518"><a href="#L-1518"><span class="linenos">1518</span></a><span class="sd">        The number of validation patches to use for evaluation. Default is 8.</span>
</span><span id="L-1519"><a href="#L-1519"><span class="linenos">1519</span></a><span class="sd">    learning_rate : float, optional</span>
</span><span id="L-1520"><a href="#L-1520"><span class="linenos">1520</span></a><span class="sd">        The learning rate for the Adam optimizer. Default is 5e-5.</span>
</span><span id="L-1521"><a href="#L-1521"><span class="linenos">1521</span></a><span class="sd">    feature_layer : int, optional</span>
</span><span id="L-1522"><a href="#L-1522"><span class="linenos">1522</span></a><span class="sd">        The layer index from the feature extractor to use for perceptual loss.</span>
</span><span id="L-1523"><a href="#L-1523"><span class="linenos">1523</span></a><span class="sd">        Default is 6.</span>
</span><span id="L-1524"><a href="#L-1524"><span class="linenos">1524</span></a><span class="sd">    feature : float, optional</span>
</span><span id="L-1525"><a href="#L-1525"><span class="linenos">1525</span></a><span class="sd">        The relative weight of the perceptual (feature) loss term. Default is 2.0.</span>
</span><span id="L-1526"><a href="#L-1526"><span class="linenos">1526</span></a><span class="sd">    tv : float, optional</span>
</span><span id="L-1527"><a href="#L-1527"><span class="linenos">1527</span></a><span class="sd">        The relative weight of the Total Variation (TV) regularization term.</span>
</span><span id="L-1528"><a href="#L-1528"><span class="linenos">1528</span></a><span class="sd">        Default is 0.1.</span>
</span><span id="L-1529"><a href="#L-1529"><span class="linenos">1529</span></a><span class="sd">    max_iterations : int, optional</span>
</span><span id="L-1530"><a href="#L-1530"><span class="linenos">1530</span></a><span class="sd">        The total number of training iterations to run. Default is 1000.</span>
</span><span id="L-1531"><a href="#L-1531"><span class="linenos">1531</span></a><span class="sd">    batch_size : int, optional</span>
</span><span id="L-1532"><a href="#L-1532"><span class="linenos">1532</span></a><span class="sd">        The batch size for training. Note: this implementation is optimized for</span>
</span><span id="L-1533"><a href="#L-1533"><span class="linenos">1533</span></a><span class="sd">        batch_size=1 and may need adjustment for larger batches. Default is 1.</span>
</span><span id="L-1534"><a href="#L-1534"><span class="linenos">1534</span></a><span class="sd">    save_all_best : bool, optional</span>
</span><span id="L-1535"><a href="#L-1535"><span class="linenos">1535</span></a><span class="sd">        If True, saves a new model file every time validation loss improves.</span>
</span><span id="L-1536"><a href="#L-1536"><span class="linenos">1536</span></a><span class="sd">        If False, overwrites the single best model file. Default is False.</span>
</span><span id="L-1537"><a href="#L-1537"><span class="linenos">1537</span></a><span class="sd">    feature_type : str, optional</span>
</span><span id="L-1538"><a href="#L-1538"><span class="linenos">1538</span></a><span class="sd">        The type of feature extractor for perceptual loss. Options: &#39;grader&#39;,</span>
</span><span id="L-1539"><a href="#L-1539"><span class="linenos">1539</span></a><span class="sd">        &#39;vgg&#39;, &#39;vggrandom&#39;. Default is &#39;grader&#39;.</span>
</span><span id="L-1540"><a href="#L-1540"><span class="linenos">1540</span></a><span class="sd">    check_eval_data_iteration : int, optional</span>
</span><span id="L-1541"><a href="#L-1541"><span class="linenos">1541</span></a><span class="sd">        The frequency (in iterations) at which to run validation and save logs.</span>
</span><span id="L-1542"><a href="#L-1542"><span class="linenos">1542</span></a><span class="sd">        Default is 20.</span>
</span><span id="L-1543"><a href="#L-1543"><span class="linenos">1543</span></a><span class="sd">    verbose : bool, optional</span>
</span><span id="L-1544"><a href="#L-1544"><span class="linenos">1544</span></a><span class="sd">        If True, prints detailed progress information. Default is False.</span>
</span><span id="L-1545"><a href="#L-1545"><span class="linenos">1545</span></a>
</span><span id="L-1546"><a href="#L-1546"><span class="linenos">1546</span></a><span class="sd">    Returns</span>
</span><span id="L-1547"><a href="#L-1547"><span class="linenos">1547</span></a><span class="sd">    -------</span>
</span><span id="L-1548"><a href="#L-1548"><span class="linenos">1548</span></a><span class="sd">    pd.DataFrame</span>
</span><span id="L-1549"><a href="#L-1549"><span class="linenos">1549</span></a><span class="sd">        A DataFrame containing the training history, with columns for training</span>
</span><span id="L-1550"><a href="#L-1550"><span class="linenos">1550</span></a><span class="sd">        loss, validation loss, PSNR, and baseline PSNR over iterations.</span>
</span><span id="L-1551"><a href="#L-1551"><span class="linenos">1551</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1552"><a href="#L-1552"><span class="linenos">1552</span></a>    <span class="n">colnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;train_loss&#39;</span><span class="p">,</span><span class="s1">&#39;test_loss&#39;</span><span class="p">,</span><span class="s1">&#39;best&#39;</span><span class="p">,</span><span class="s1">&#39;eval_psnr&#39;</span><span class="p">,</span><span class="s1">&#39;eval_psnr_lin&#39;</span><span class="p">]</span>
</span><span id="L-1553"><a href="#L-1553"><span class="linenos">1553</span></a>    <span class="n">training_path</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span> <span class="n">max_iterations</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">colnames</span><span class="p">)</span> <span class="p">]</span> <span class="p">)</span>
</span><span id="L-1554"><a href="#L-1554"><span class="linenos">1554</span></a>    <span class="n">training_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span> <span class="p">)</span>
</span><span id="L-1555"><a href="#L-1555"><span class="linenos">1555</span></a>    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1556"><a href="#L-1556"><span class="linenos">1556</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;begin get feature extractor &quot;</span> <span class="o">+</span> <span class="n">feature_type</span><span class="p">)</span>
</span><span id="L-1557"><a href="#L-1557"><span class="linenos">1557</span></a>    <span class="k">if</span> <span class="n">feature_type</span> <span class="o">==</span> <span class="s1">&#39;grader&#39;</span><span class="p">:</span>
</span><span id="L-1558"><a href="#L-1558"><span class="linenos">1558</span></a>        <span class="n">feature_extractor</span> <span class="o">=</span> <span class="n">get_grader_feature_network</span><span class="p">(</span> <span class="n">feature_layer</span> <span class="p">)</span>
</span><span id="L-1559"><a href="#L-1559"><span class="linenos">1559</span></a>    <span class="k">elif</span> <span class="n">feature_type</span> <span class="o">==</span> <span class="s1">&#39;vggrandom&#39;</span><span class="p">:</span>
</span><span id="L-1560"><a href="#L-1560"><span class="linenos">1560</span></a>        <span class="k">with</span> <span class="n">eager_mode</span><span class="p">():</span>
</span><span id="L-1561"><a href="#L-1561"><span class="linenos">1561</span></a>            <span class="n">feature_extractor</span> <span class="o">=</span> <span class="n">pseudo_3d_vgg_features</span><span class="p">(</span> <span class="n">target_patch_size</span><span class="p">,</span> <span class="n">feature_layer</span><span class="p">,</span> <span class="n">pretrained</span><span class="o">=</span><span class="kc">False</span> <span class="p">)</span>
</span><span id="L-1562"><a href="#L-1562"><span class="linenos">1562</span></a>    <span class="k">elif</span> <span class="n">feature_type</span> <span class="o">==</span> <span class="s1">&#39;vgg&#39;</span><span class="p">:</span>
</span><span id="L-1563"><a href="#L-1563"><span class="linenos">1563</span></a>        <span class="k">with</span> <span class="n">eager_mode</span><span class="p">():</span>
</span><span id="L-1564"><a href="#L-1564"><span class="linenos">1564</span></a>            <span class="n">feature_extractor</span> <span class="o">=</span> <span class="n">pseudo_3d_vgg_features_unbiased</span><span class="p">(</span> <span class="n">target_patch_size</span><span class="p">,</span> <span class="n">feature_layer</span> <span class="p">)</span>
</span><span id="L-1565"><a href="#L-1565"><span class="linenos">1565</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-1566"><a href="#L-1566"><span class="linenos">1566</span></a>        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;feature type does not exist&quot;</span><span class="p">)</span>
</span><span id="L-1567"><a href="#L-1567"><span class="linenos">1567</span></a>    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1568"><a href="#L-1568"><span class="linenos">1568</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;begin train generator&quot;</span><span class="p">)</span>
</span><span id="L-1569"><a href="#L-1569"><span class="linenos">1569</span></a>    <span class="n">mydatgen</span> <span class="o">=</span> <span class="n">image_generator</span><span class="p">(</span>
</span><span id="L-1570"><a href="#L-1570"><span class="linenos">1570</span></a>        <span class="n">filenames_train</span><span class="p">,</span>
</span><span id="L-1571"><a href="#L-1571"><span class="linenos">1571</span></a>        <span class="n">nPatches</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="L-1572"><a href="#L-1572"><span class="linenos">1572</span></a>        <span class="n">target_patch_size</span><span class="o">=</span><span class="n">target_patch_size</span><span class="p">,</span>
</span><span id="L-1573"><a href="#L-1573"><span class="linenos">1573</span></a>        <span class="n">target_patch_size_low</span><span class="o">=</span><span class="n">target_patch_size_low</span><span class="p">,</span>
</span><span id="L-1574"><a href="#L-1574"><span class="linenos">1574</span></a>        <span class="n">istest</span><span class="o">=</span><span class="kc">False</span> <span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-1575"><a href="#L-1575"><span class="linenos">1575</span></a>    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1576"><a href="#L-1576"><span class="linenos">1576</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;begin test generator&quot;</span><span class="p">)</span>
</span><span id="L-1577"><a href="#L-1577"><span class="linenos">1577</span></a>    <span class="n">mydatgenTest</span> <span class="o">=</span> <span class="n">image_generator</span><span class="p">(</span> <span class="n">filenames_test</span><span class="p">,</span> <span class="n">nPatches</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="L-1578"><a href="#L-1578"><span class="linenos">1578</span></a>        <span class="n">target_patch_size</span><span class="o">=</span><span class="n">target_patch_size</span><span class="p">,</span>
</span><span id="L-1579"><a href="#L-1579"><span class="linenos">1579</span></a>        <span class="n">target_patch_size_low</span><span class="o">=</span><span class="n">target_patch_size_low</span><span class="p">,</span>
</span><span id="L-1580"><a href="#L-1580"><span class="linenos">1580</span></a>        <span class="n">istest</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1581"><a href="#L-1581"><span class="linenos">1581</span></a>    <span class="n">patchesResamTeTf</span><span class="p">,</span> <span class="n">patchesOrigTeTf</span><span class="p">,</span> <span class="n">patchesUpTeTf</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span> <span class="n">mydatgenTest</span> <span class="p">)</span>
</span><span id="L-1582"><a href="#L-1582"><span class="linenos">1582</span></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span> <span class="n">patchesOrigTeTf</span><span class="o">.</span><span class="n">shape</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
</span><span id="L-1583"><a href="#L-1583"><span class="linenos">1583</span></a>            <span class="n">tdim</span> <span class="o">=</span> <span class="mi">3</span>
</span><span id="L-1584"><a href="#L-1584"><span class="linenos">1584</span></a>            <span class="n">myax</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span>
</span><span id="L-1585"><a href="#L-1585"><span class="linenos">1585</span></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span> <span class="n">patchesOrigTeTf</span><span class="o">.</span><span class="n">shape</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
</span><span id="L-1586"><a href="#L-1586"><span class="linenos">1586</span></a>            <span class="n">tdim</span> <span class="o">=</span> <span class="mi">2</span>
</span><span id="L-1587"><a href="#L-1587"><span class="linenos">1587</span></a>            <span class="n">myax</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
</span><span id="L-1588"><a href="#L-1588"><span class="linenos">1588</span></a>    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1589"><a href="#L-1589"><span class="linenos">1589</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;begin train generator #2 at dim: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span> <span class="n">tdim</span><span class="p">))</span>
</span><span id="L-1590"><a href="#L-1590"><span class="linenos">1590</span></a>    <span class="n">mydatgenTest</span> <span class="o">=</span> <span class="n">image_generator</span><span class="p">(</span> <span class="n">filenames_test</span><span class="p">,</span> <span class="n">nPatches</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="L-1591"><a href="#L-1591"><span class="linenos">1591</span></a>        <span class="n">target_patch_size</span><span class="o">=</span><span class="n">target_patch_size</span><span class="p">,</span>
</span><span id="L-1592"><a href="#L-1592"><span class="linenos">1592</span></a>        <span class="n">target_patch_size_low</span><span class="o">=</span><span class="n">target_patch_size_low</span><span class="p">,</span>
</span><span id="L-1593"><a href="#L-1593"><span class="linenos">1593</span></a>        <span class="n">istest</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1594"><a href="#L-1594"><span class="linenos">1594</span></a>    <span class="n">patchesResamTeTfB</span><span class="p">,</span> <span class="n">patchesOrigTeTfB</span><span class="p">,</span> <span class="n">patchesUpTeTfB</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span> <span class="n">mydatgenTest</span> <span class="p">)</span>
</span><span id="L-1595"><a href="#L-1595"><span class="linenos">1595</span></a>    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">n_test</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">):</span>
</span><span id="L-1596"><a href="#L-1596"><span class="linenos">1596</span></a>        <span class="n">mydatgenTest</span> <span class="o">=</span> <span class="n">image_generator</span><span class="p">(</span> <span class="n">filenames_test</span><span class="p">,</span> <span class="n">nPatches</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="L-1597"><a href="#L-1597"><span class="linenos">1597</span></a>            <span class="n">target_patch_size</span><span class="o">=</span><span class="n">target_patch_size</span><span class="p">,</span>
</span><span id="L-1598"><a href="#L-1598"><span class="linenos">1598</span></a>            <span class="n">target_patch_size_low</span><span class="o">=</span><span class="n">target_patch_size_low</span><span class="p">,</span>
</span><span id="L-1599"><a href="#L-1599"><span class="linenos">1599</span></a>            <span class="n">istest</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1600"><a href="#L-1600"><span class="linenos">1600</span></a>        <span class="n">temp0</span><span class="p">,</span> <span class="n">temp1</span><span class="p">,</span> <span class="n">temp2</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span> <span class="n">mydatgenTest</span> <span class="p">)</span>
</span><span id="L-1601"><a href="#L-1601"><span class="linenos">1601</span></a>        <span class="n">patchesResamTeTfB</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span> <span class="p">[</span><span class="n">patchesResamTeTfB</span><span class="p">,</span><span class="n">temp0</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-1602"><a href="#L-1602"><span class="linenos">1602</span></a>        <span class="n">patchesOrigTeTfB</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span> <span class="p">[</span><span class="n">patchesOrigTeTfB</span><span class="p">,</span><span class="n">temp1</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-1603"><a href="#L-1603"><span class="linenos">1603</span></a>        <span class="n">patchesUpTeTfB</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span> <span class="p">[</span><span class="n">patchesUpTeTfB</span><span class="p">,</span><span class="n">temp2</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-1604"><a href="#L-1604"><span class="linenos">1604</span></a>    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1605"><a href="#L-1605"><span class="linenos">1605</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;begin auto_weight_loss&quot;</span><span class="p">)</span>
</span><span id="L-1606"><a href="#L-1606"><span class="linenos">1606</span></a>    <span class="n">wts_csv</span> <span class="o">=</span> <span class="n">output_prefix</span> <span class="o">+</span> <span class="s2">&quot;_training_weights.csv&quot;</span>
</span><span id="L-1607"><a href="#L-1607"><span class="linenos">1607</span></a>    <span class="k">if</span> <span class="n">exists</span><span class="p">(</span> <span class="n">wts_csv</span> <span class="p">):</span>
</span><span id="L-1608"><a href="#L-1608"><span class="linenos">1608</span></a>        <span class="n">wtsdf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span> <span class="n">wts_csv</span> <span class="p">)</span>
</span><span id="L-1609"><a href="#L-1609"><span class="linenos">1609</span></a>        <span class="n">wts</span> <span class="o">=</span> <span class="p">[</span><span class="n">wtsdf</span><span class="p">[</span><span class="s1">&#39;msq&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">wtsdf</span><span class="p">[</span><span class="s1">&#39;feat&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">wtsdf</span><span class="p">[</span><span class="s1">&#39;tv&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
</span><span id="L-1610"><a href="#L-1610"><span class="linenos">1610</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1611"><a href="#L-1611"><span class="linenos">1611</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;preset weights:&quot;</span> <span class="p">)</span>
</span><span id="L-1612"><a href="#L-1612"><span class="linenos">1612</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-1613"><a href="#L-1613"><span class="linenos">1613</span></a>        <span class="k">with</span> <span class="n">eager_mode</span><span class="p">():</span>
</span><span id="L-1614"><a href="#L-1614"><span class="linenos">1614</span></a>            <span class="n">wts</span> <span class="o">=</span> <span class="n">auto_weight_loss</span><span class="p">(</span> <span class="n">mdl</span><span class="p">,</span> <span class="n">feature_extractor</span><span class="p">,</span> <span class="n">patchesResamTeTf</span><span class="p">,</span> <span class="n">patchesOrigTeTf</span><span class="p">,</span>
</span><span id="L-1615"><a href="#L-1615"><span class="linenos">1615</span></a>                <span class="n">feature</span><span class="o">=</span><span class="n">feature</span><span class="p">,</span> <span class="n">tv</span><span class="o">=</span><span class="n">tv</span> <span class="p">)</span>
</span><span id="L-1616"><a href="#L-1616"><span class="linenos">1616</span></a>        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">wts</span><span class="p">)):</span>
</span><span id="L-1617"><a href="#L-1617"><span class="linenos">1617</span></a>            <span class="n">training_weights</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">=</span><span class="n">wts</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
</span><span id="L-1618"><a href="#L-1618"><span class="linenos">1618</span></a>        <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">training_weights</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;msq&quot;</span><span class="p">,</span><span class="s2">&quot;feat&quot;</span><span class="p">,</span><span class="s2">&quot;tv&quot;</span><span class="p">]</span> <span class="p">)</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span> <span class="n">wts_csv</span> <span class="p">)</span>
</span><span id="L-1619"><a href="#L-1619"><span class="linenos">1619</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1620"><a href="#L-1620"><span class="linenos">1620</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;automatic weights:&quot;</span> <span class="p">)</span>
</span><span id="L-1621"><a href="#L-1621"><span class="linenos">1621</span></a>    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1622"><a href="#L-1622"><span class="linenos">1622</span></a>        <span class="nb">print</span><span class="p">(</span> <span class="n">wts</span> <span class="p">)</span>
</span><span id="L-1623"><a href="#L-1623"><span class="linenos">1623</span></a>    <span class="k">def</span> <span class="nf">my_loss_6</span><span class="p">(</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">msqwt</span> <span class="o">=</span> <span class="n">wts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fw</span> <span class="o">=</span> <span class="n">wts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">tvwt</span> <span class="o">=</span> <span class="n">wts</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">mybs</span> <span class="o">=</span> <span class="n">batch_size</span> <span class="p">):</span>
</span><span id="L-1624"><a href="#L-1624"><span class="linenos">1624</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Composite loss: MSE + Perceptual Loss + Total Variation.&quot;&quot;&quot;</span>
</span><span id="L-1625"><a href="#L-1625"><span class="linenos">1625</span></a>        <span class="n">squared_difference</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">y_true</span> <span class="o">-</span> <span class="n">y_pred</span><span class="p">)</span>
</span><span id="L-1626"><a href="#L-1626"><span class="linenos">1626</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span> <span class="n">y_true</span><span class="o">.</span><span class="n">shape</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
</span><span id="L-1627"><a href="#L-1627"><span class="linenos">1627</span></a>            <span class="n">tdim</span> <span class="o">=</span> <span class="mi">3</span>
</span><span id="L-1628"><a href="#L-1628"><span class="linenos">1628</span></a>            <span class="n">myax</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span>
</span><span id="L-1629"><a href="#L-1629"><span class="linenos">1629</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span> <span class="n">y_true</span><span class="o">.</span><span class="n">shape</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
</span><span id="L-1630"><a href="#L-1630"><span class="linenos">1630</span></a>            <span class="n">tdim</span> <span class="o">=</span> <span class="mi">2</span>
</span><span id="L-1631"><a href="#L-1631"><span class="linenos">1631</span></a>            <span class="n">myax</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
</span><span id="L-1632"><a href="#L-1632"><span class="linenos">1632</span></a>        <span class="n">msqTerm</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">squared_difference</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">myax</span><span class="p">)</span>
</span><span id="L-1633"><a href="#L-1633"><span class="linenos">1633</span></a>        <span class="n">temp1</span> <span class="o">=</span> <span class="n">feature_extractor</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span>
</span><span id="L-1634"><a href="#L-1634"><span class="linenos">1634</span></a>        <span class="n">temp2</span> <span class="o">=</span> <span class="n">feature_extractor</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span>
</span><span id="L-1635"><a href="#L-1635"><span class="linenos">1635</span></a>        <span class="n">feature_difference</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">temp1</span><span class="o">-</span><span class="n">temp2</span><span class="p">)</span>
</span><span id="L-1636"><a href="#L-1636"><span class="linenos">1636</span></a>        <span class="n">featureTerm</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">feature_difference</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">myax</span><span class="p">)</span>
</span><span id="L-1637"><a href="#L-1637"><span class="linenos">1637</span></a>        <span class="n">loss</span> <span class="o">=</span> <span class="n">msqTerm</span> <span class="o">*</span> <span class="n">msqwt</span> <span class="o">+</span> <span class="n">featureTerm</span> <span class="o">*</span> <span class="n">fw</span>
</span><span id="L-1638"><a href="#L-1638"><span class="linenos">1638</span></a>        <span class="n">mytv</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s1">&#39;float32&#39;</span><span class="p">)</span>
</span><span id="L-1639"><a href="#L-1639"><span class="linenos">1639</span></a>        <span class="c1"># mybs =  int( y_pred.shape[0] ) --- should work but ... ?</span>
</span><span id="L-1640"><a href="#L-1640"><span class="linenos">1640</span></a>        <span class="k">if</span> <span class="n">tdim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="L-1641"><a href="#L-1641"><span class="linenos">1641</span></a>            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">mybs</span> <span class="p">):</span> <span class="c1"># BUG not sure why myr fails .... might be old TF version</span>
</span><span id="L-1642"><a href="#L-1642"><span class="linenos">1642</span></a>                <span class="n">sqzd</span> <span class="o">=</span> <span class="n">y_pred</span><span class="p">[</span><span class="n">k</span><span class="p">,:,:,:,:]</span>
</span><span id="L-1643"><a href="#L-1643"><span class="linenos">1643</span></a>                <span class="n">mytv</span> <span class="o">=</span> <span class="n">mytv</span> <span class="o">+</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">total_variation</span><span class="p">(</span> <span class="n">sqzd</span> <span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">tvwt</span>
</span><span id="L-1644"><a href="#L-1644"><span class="linenos">1644</span></a>        <span class="k">if</span> <span class="n">tdim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-1645"><a href="#L-1645"><span class="linenos">1645</span></a>            <span class="n">mytv</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">total_variation</span><span class="p">(</span> <span class="n">y_pred</span> <span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">tvwt</span>
</span><span id="L-1646"><a href="#L-1646"><span class="linenos">1646</span></a>        <span class="k">return</span><span class="p">(</span> <span class="n">loss</span> <span class="o">+</span> <span class="n">mytv</span> <span class="p">)</span>
</span><span id="L-1647"><a href="#L-1647"><span class="linenos">1647</span></a>    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1648"><a href="#L-1648"><span class="linenos">1648</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;begin model compilation&quot;</span><span class="p">)</span>
</span><span id="L-1649"><a href="#L-1649"><span class="linenos">1649</span></a>    <span class="n">opt</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span> <span class="n">learning_rate</span><span class="o">=</span><span class="n">learning_rate</span> <span class="p">)</span>
</span><span id="L-1650"><a href="#L-1650"><span class="linenos">1650</span></a>    <span class="n">mdl</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">opt</span><span class="p">,</span> <span class="n">loss</span><span class="o">=</span><span class="n">my_loss_6</span><span class="p">)</span>
</span><span id="L-1651"><a href="#L-1651"><span class="linenos">1651</span></a>    <span class="c1"># set up some parameters for tracking performance</span>
</span><span id="L-1652"><a href="#L-1652"><span class="linenos">1652</span></a>    <span class="n">bestValLoss</span><span class="o">=</span><span class="mf">1e12</span>
</span><span id="L-1653"><a href="#L-1653"><span class="linenos">1653</span></a>    <span class="n">bestSSIM</span><span class="o">=</span><span class="mf">0.0</span>
</span><span id="L-1654"><a href="#L-1654"><span class="linenos">1654</span></a>    <span class="n">bestQC0</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1000</span>
</span><span id="L-1655"><a href="#L-1655"><span class="linenos">1655</span></a>    <span class="n">bestQC1</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1000</span>
</span><span id="L-1656"><a href="#L-1656"><span class="linenos">1656</span></a>    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1657"><a href="#L-1657"><span class="linenos">1657</span></a>        <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;begin training&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span>  <span class="p">)</span>
</span><span id="L-1658"><a href="#L-1658"><span class="linenos">1658</span></a>    <span class="k">for</span> <span class="n">myrs</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">max_iterations</span> <span class="p">):</span>
</span><span id="L-1659"><a href="#L-1659"><span class="linenos">1659</span></a>        <span class="n">tracker</span> <span class="o">=</span> <span class="n">mdl</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span> <span class="n">mydatgen</span><span class="p">,</span>  <span class="n">epochs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">steps_per_epoch</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="L-1660"><a href="#L-1660"><span class="linenos">1660</span></a>            <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">patchesResamTeTf</span><span class="p">,</span><span class="n">patchesOrigTeTf</span><span class="p">)</span> <span class="p">)</span>
</span><span id="L-1661"><a href="#L-1661"><span class="linenos">1661</span></a>        <span class="n">training_path</span><span class="p">[</span><span class="n">myrs</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">tracker</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1662"><a href="#L-1662"><span class="linenos">1662</span></a>        <span class="n">training_path</span><span class="p">[</span><span class="n">myrs</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">tracker</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_loss&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1663"><a href="#L-1663"><span class="linenos">1663</span></a>        <span class="n">training_path</span><span class="p">[</span><span class="n">myrs</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
</span><span id="L-1664"><a href="#L-1664"><span class="linenos">1664</span></a>        <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;ntrain: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">myrs</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; loss &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span> <span class="n">tracker</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; val-loss &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">tracker</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_loss&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span>  <span class="p">)</span>
</span><span id="L-1665"><a href="#L-1665"><span class="linenos">1665</span></a>        <span class="k">if</span> <span class="n">myrs</span> <span class="o">%</span> <span class="n">check_eval_data_iteration</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1666"><a href="#L-1666"><span class="linenos">1666</span></a>            <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;/cpu:0&quot;</span><span class="p">):</span>
</span><span id="L-1667"><a href="#L-1667"><span class="linenos">1667</span></a>                <span class="n">myofn</span> <span class="o">=</span> <span class="n">output_prefix</span> <span class="o">+</span> <span class="s2">&quot;_best_mdl.keras&quot;</span>
</span><span id="L-1668"><a href="#L-1668"><span class="linenos">1668</span></a>                <span class="k">if</span> <span class="n">save_all_best</span><span class="p">:</span>
</span><span id="L-1669"><a href="#L-1669"><span class="linenos">1669</span></a>                    <span class="n">myofn</span> <span class="o">=</span> <span class="n">output_prefix</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">myrs</span><span class="p">)</span><span class="o">+</span> <span class="s2">&quot;_mdl.keras&quot;</span>
</span><span id="L-1670"><a href="#L-1670"><span class="linenos">1670</span></a>                <span class="n">tester</span> <span class="o">=</span> <span class="n">mdl</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span> <span class="n">patchesResamTeTfB</span><span class="p">,</span> <span class="n">patchesOrigTeTfB</span> <span class="p">)</span>
</span><span id="L-1671"><a href="#L-1671"><span class="linenos">1671</span></a>                <span class="k">if</span> <span class="p">(</span> <span class="n">tester</span> <span class="o">&lt;</span> <span class="n">bestValLoss</span> <span class="p">):</span>
</span><span id="L-1672"><a href="#L-1672"><span class="linenos">1672</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;MyIT &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span> <span class="n">myrs</span> <span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; IS BEST!! &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span> <span class="n">tester</span> <span class="p">)</span> <span class="o">+</span> <span class="n">myofn</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span> <span class="p">)</span>
</span><span id="L-1673"><a href="#L-1673"><span class="linenos">1673</span></a>                    <span class="n">bestValLoss</span> <span class="o">=</span> <span class="n">tester</span>
</span><span id="L-1674"><a href="#L-1674"><span class="linenos">1674</span></a>                    <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span> <span class="n">mdl</span><span class="p">,</span> <span class="n">myofn</span> <span class="p">)</span>
</span><span id="L-1675"><a href="#L-1675"><span class="linenos">1675</span></a>                    <span class="n">training_path</span><span class="p">[</span><span class="n">myrs</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
</span><span id="L-1676"><a href="#L-1676"><span class="linenos">1676</span></a>                <span class="n">pp</span> <span class="o">=</span> <span class="n">mdl</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span> <span class="n">patchesResamTeTfB</span><span class="p">,</span> <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">)</span>
</span><span id="L-1677"><a href="#L-1677"><span class="linenos">1677</span></a>                <span class="n">myssimSR</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">psnr</span><span class="p">(</span> <span class="n">pp</span> <span class="o">*</span> <span class="mi">220</span><span class="p">,</span> <span class="n">patchesOrigTeTfB</span><span class="o">*</span> <span class="mi">220</span><span class="p">,</span> <span class="n">max_val</span><span class="o">=</span><span class="mi">255</span> <span class="p">)</span>
</span><span id="L-1678"><a href="#L-1678"><span class="linenos">1678</span></a>                <span class="n">myssimSR</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span> <span class="n">myssimSR</span> <span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="L-1679"><a href="#L-1679"><span class="linenos">1679</span></a>                <span class="n">myssimBI</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">psnr</span><span class="p">(</span> <span class="n">patchesUpTeTfB</span> <span class="o">*</span> <span class="mi">220</span><span class="p">,</span> <span class="n">patchesOrigTeTfB</span><span class="o">*</span> <span class="mi">220</span><span class="p">,</span> <span class="n">max_val</span><span class="o">=</span><span class="mi">255</span> <span class="p">)</span>
</span><span id="L-1680"><a href="#L-1680"><span class="linenos">1680</span></a>                <span class="n">myssimBI</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span> <span class="n">myssimBI</span> <span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="L-1681"><a href="#L-1681"><span class="linenos">1681</span></a>                <span class="nb">print</span><span class="p">(</span> <span class="n">myofn</span> <span class="o">+</span> <span class="s2">&quot; : &quot;</span> <span class="o">+</span> <span class="s2">&quot;PSNR Lin: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span> <span class="n">myssimBI</span> <span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; SR: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span> <span class="n">myssimSR</span> <span class="p">),</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span>  <span class="p">)</span>
</span><span id="L-1682"><a href="#L-1682"><span class="linenos">1682</span></a>                <span class="n">training_path</span><span class="p">[</span><span class="n">myrs</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">myssimSR</span> <span class="c1"># psnr</span>
</span><span id="L-1683"><a href="#L-1683"><span class="linenos">1683</span></a>                <span class="n">training_path</span><span class="p">[</span><span class="n">myrs</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="n">myssimBI</span> <span class="c1"># psnrlin</span>
</span><span id="L-1684"><a href="#L-1684"><span class="linenos">1684</span></a>                <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">training_path</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">colnames</span> <span class="p">)</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span> <span class="n">output_prefix</span> <span class="o">+</span> <span class="s2">&quot;_training.csv&quot;</span> <span class="p">)</span>
</span><span id="L-1685"><a href="#L-1685"><span class="linenos">1685</span></a>    <span class="n">training_path</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">training_path</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">colnames</span> <span class="p">)</span>
</span><span id="L-1686"><a href="#L-1686"><span class="linenos">1686</span></a>    <span class="k">return</span> <span class="n">training_path</span>
</span><span id="L-1687"><a href="#L-1687"><span class="linenos">1687</span></a>
</span><span id="L-1688"><a href="#L-1688"><span class="linenos">1688</span></a>
</span><span id="L-1689"><a href="#L-1689"><span class="linenos">1689</span></a><span class="k">def</span> <span class="nf">binary_dice_loss</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">):</span>
</span><span id="L-1690"><a href="#L-1690"><span class="linenos">1690</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1691"><a href="#L-1691"><span class="linenos">1691</span></a><span class="sd">    Computes the Dice loss for binary segmentation tasks.</span>
</span><span id="L-1692"><a href="#L-1692"><span class="linenos">1692</span></a>
</span><span id="L-1693"><a href="#L-1693"><span class="linenos">1693</span></a><span class="sd">    The Dice coefficient is a common metric for comparing the overlap of two samples.</span>
</span><span id="L-1694"><a href="#L-1694"><span class="linenos">1694</span></a><span class="sd">    This loss function computes `1 - DiceCoefficient`, making it suitable for</span>
</span><span id="L-1695"><a href="#L-1695"><span class="linenos">1695</span></a><span class="sd">    minimization during training. A smoothing factor is added to avoid division</span>
</span><span id="L-1696"><a href="#L-1696"><span class="linenos">1696</span></a><span class="sd">    by zero when both the prediction and the ground truth are empty.</span>
</span><span id="L-1697"><a href="#L-1697"><span class="linenos">1697</span></a>
</span><span id="L-1698"><a href="#L-1698"><span class="linenos">1698</span></a><span class="sd">    Parameters</span>
</span><span id="L-1699"><a href="#L-1699"><span class="linenos">1699</span></a><span class="sd">    ----------</span>
</span><span id="L-1700"><a href="#L-1700"><span class="linenos">1700</span></a><span class="sd">    y_true : tf.Tensor</span>
</span><span id="L-1701"><a href="#L-1701"><span class="linenos">1701</span></a><span class="sd">        The ground truth binary segmentation mask. Values should be 0 or 1.</span>
</span><span id="L-1702"><a href="#L-1702"><span class="linenos">1702</span></a><span class="sd">    y_pred : tf.Tensor</span>
</span><span id="L-1703"><a href="#L-1703"><span class="linenos">1703</span></a><span class="sd">        The predicted binary segmentation mask, typically with values in [0, 1]</span>
</span><span id="L-1704"><a href="#L-1704"><span class="linenos">1704</span></a><span class="sd">        from a sigmoid activation.</span>
</span><span id="L-1705"><a href="#L-1705"><span class="linenos">1705</span></a>
</span><span id="L-1706"><a href="#L-1706"><span class="linenos">1706</span></a><span class="sd">    Returns</span>
</span><span id="L-1707"><a href="#L-1707"><span class="linenos">1707</span></a><span class="sd">    -------</span>
</span><span id="L-1708"><a href="#L-1708"><span class="linenos">1708</span></a><span class="sd">    tf.Tensor</span>
</span><span id="L-1709"><a href="#L-1709"><span class="linenos">1709</span></a><span class="sd">        A scalar tensor representing the Dice loss. The value ranges from -1 (perfect</span>
</span><span id="L-1710"><a href="#L-1710"><span class="linenos">1710</span></a><span class="sd">        match) to 0 (no overlap), though it&#39;s typically used as `1 - dice_coeff`</span>
</span><span id="L-1711"><a href="#L-1711"><span class="linenos">1711</span></a><span class="sd">        or just `-dice_coeff` (as here).</span>
</span><span id="L-1712"><a href="#L-1712"><span class="linenos">1712</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1713"><a href="#L-1713"><span class="linenos">1713</span></a>    <span class="n">smoothing_factor</span> <span class="o">=</span> <span class="mf">1e-4</span>
</span><span id="L-1714"><a href="#L-1714"><span class="linenos">1714</span></a>    <span class="n">K</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">backend</span>
</span><span id="L-1715"><a href="#L-1715"><span class="linenos">1715</span></a>    <span class="n">y_true_f</span> <span class="o">=</span> <span class="n">K</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span>
</span><span id="L-1716"><a href="#L-1716"><span class="linenos">1716</span></a>    <span class="n">y_pred_f</span> <span class="o">=</span> <span class="n">K</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span>
</span><span id="L-1717"><a href="#L-1717"><span class="linenos">1717</span></a>    <span class="n">intersection</span> <span class="o">=</span> <span class="n">K</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y_true_f</span> <span class="o">*</span> <span class="n">y_pred_f</span><span class="p">)</span>
</span><span id="L-1718"><a href="#L-1718"><span class="linenos">1718</span></a>    <span class="c1"># This is -1 * Dice Similarity Coefficient</span>
</span><span id="L-1719"><a href="#L-1719"><span class="linenos">1719</span></a>    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">intersection</span> <span class="o">+</span> <span class="n">smoothing_factor</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">K</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y_true_f</span><span class="p">)</span> <span class="o">+</span>
</span><span id="L-1720"><a href="#L-1720"><span class="linenos">1720</span></a>            <span class="n">K</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y_pred_f</span><span class="p">)</span> <span class="o">+</span> <span class="n">smoothing_factor</span><span class="p">)</span>
</span><span id="L-1721"><a href="#L-1721"><span class="linenos">1721</span></a>
</span><span id="L-1722"><a href="#L-1722"><span class="linenos">1722</span></a><span class="k">def</span> <span class="nf">train_seg</span><span class="p">(</span>
</span><span id="L-1723"><a href="#L-1723"><span class="linenos">1723</span></a>    <span class="n">mdl</span><span class="p">,</span>
</span><span id="L-1724"><a href="#L-1724"><span class="linenos">1724</span></a>    <span class="n">filenames_train</span><span class="p">,</span>
</span><span id="L-1725"><a href="#L-1725"><span class="linenos">1725</span></a>    <span class="n">filenames_test</span><span class="p">,</span>
</span><span id="L-1726"><a href="#L-1726"><span class="linenos">1726</span></a>    <span class="n">target_patch_size</span><span class="p">,</span>
</span><span id="L-1727"><a href="#L-1727"><span class="linenos">1727</span></a>    <span class="n">target_patch_size_low</span><span class="p">,</span>
</span><span id="L-1728"><a href="#L-1728"><span class="linenos">1728</span></a>    <span class="n">output_prefix</span><span class="p">,</span>
</span><span id="L-1729"><a href="#L-1729"><span class="linenos">1729</span></a>    <span class="n">n_test</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
</span><span id="L-1730"><a href="#L-1730"><span class="linenos">1730</span></a>    <span class="n">learning_rate</span><span class="o">=</span><span class="mf">5e-5</span><span class="p">,</span>
</span><span id="L-1731"><a href="#L-1731"><span class="linenos">1731</span></a>    <span class="n">feature_layer</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
</span><span id="L-1732"><a href="#L-1732"><span class="linenos">1732</span></a>    <span class="n">feature</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
</span><span id="L-1733"><a href="#L-1733"><span class="linenos">1733</span></a>    <span class="n">tv</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
</span><span id="L-1734"><a href="#L-1734"><span class="linenos">1734</span></a>    <span class="n">dice</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
</span><span id="L-1735"><a href="#L-1735"><span class="linenos">1735</span></a>    <span class="n">max_iterations</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
</span><span id="L-1736"><a href="#L-1736"><span class="linenos">1736</span></a>    <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="L-1737"><a href="#L-1737"><span class="linenos">1737</span></a>    <span class="n">save_all_best</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-1738"><a href="#L-1738"><span class="linenos">1738</span></a>    <span class="n">feature_type</span> <span class="o">=</span> <span class="s1">&#39;grader&#39;</span><span class="p">,</span>
</span><span id="L-1739"><a href="#L-1739"><span class="linenos">1739</span></a>    <span class="n">check_eval_data_iteration</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
</span><span id="L-1740"><a href="#L-1740"><span class="linenos">1740</span></a>    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span>  <span class="p">):</span>
</span><span id="L-1741"><a href="#L-1741"><span class="linenos">1741</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1742"><a href="#L-1742"><span class="linenos">1742</span></a><span class="sd">    Orchestrates training for a multi-task image and segmentation SR model.</span>
</span><span id="L-1743"><a href="#L-1743"><span class="linenos">1743</span></a>
</span><span id="L-1744"><a href="#L-1744"><span class="linenos">1744</span></a><span class="sd">    This function extends the `train` function to handle models that predict</span>
</span><span id="L-1745"><a href="#L-1745"><span class="linenos">1745</span></a><span class="sd">    both a super-resolved image and a super-resolved segmentation mask. It uses</span>
</span><span id="L-1746"><a href="#L-1746"><span class="linenos">1746</span></a><span class="sd">    a four-component composite loss: MSE (for image), a perceptual loss (for</span>
</span><span id="L-1747"><a href="#L-1747"><span class="linenos">1747</span></a><span class="sd">    image), Total Variation (for image), and Dice loss (for segmentation).</span>
</span><span id="L-1748"><a href="#L-1748"><span class="linenos">1748</span></a>
</span><span id="L-1749"><a href="#L-1749"><span class="linenos">1749</span></a><span class="sd">    Parameters</span>
</span><span id="L-1750"><a href="#L-1750"><span class="linenos">1750</span></a><span class="sd">    ----------</span>
</span><span id="L-1751"><a href="#L-1751"><span class="linenos">1751</span></a><span class="sd">    mdl : tf.keras.Model</span>
</span><span id="L-1752"><a href="#L-1752"><span class="linenos">1752</span></a><span class="sd">        The 2-channel Keras model to be trained.</span>
</span><span id="L-1753"><a href="#L-1753"><span class="linenos">1753</span></a><span class="sd">    filenames_train : list of str</span>
</span><span id="L-1754"><a href="#L-1754"><span class="linenos">1754</span></a><span class="sd">        List of file paths for the training dataset.</span>
</span><span id="L-1755"><a href="#L-1755"><span class="linenos">1755</span></a><span class="sd">    filenames_test : list of str</span>
</span><span id="L-1756"><a href="#L-1756"><span class="linenos">1756</span></a><span class="sd">        List of file paths for the validation/testing dataset.</span>
</span><span id="L-1757"><a href="#L-1757"><span class="linenos">1757</span></a><span class="sd">    target_patch_size : tuple or list</span>
</span><span id="L-1758"><a href="#L-1758"><span class="linenos">1758</span></a><span class="sd">        The dimensions of the high-resolution target patches.</span>
</span><span id="L-1759"><a href="#L-1759"><span class="linenos">1759</span></a><span class="sd">    target_patch_size_low : tuple or list</span>
</span><span id="L-1760"><a href="#L-1760"><span class="linenos">1760</span></a><span class="sd">        The dimensions of the low-resolution input patches.</span>
</span><span id="L-1761"><a href="#L-1761"><span class="linenos">1761</span></a><span class="sd">    output_prefix : str</span>
</span><span id="L-1762"><a href="#L-1762"><span class="linenos">1762</span></a><span class="sd">        A prefix for all output files.</span>
</span><span id="L-1763"><a href="#L-1763"><span class="linenos">1763</span></a><span class="sd">    n_test : int, optional</span>
</span><span id="L-1764"><a href="#L-1764"><span class="linenos">1764</span></a><span class="sd">        Number of validation patches for evaluation. Default is 8.</span>
</span><span id="L-1765"><a href="#L-1765"><span class="linenos">1765</span></a><span class="sd">    learning_rate : float, optional</span>
</span><span id="L-1766"><a href="#L-1766"><span class="linenos">1766</span></a><span class="sd">        Learning rate for the Adam optimizer. Default is 5e-5.</span>
</span><span id="L-1767"><a href="#L-1767"><span class="linenos">1767</span></a><span class="sd">    feature_layer : int, optional</span>
</span><span id="L-1768"><a href="#L-1768"><span class="linenos">1768</span></a><span class="sd">        Layer from the feature extractor for perceptual loss. Default is 6.</span>
</span><span id="L-1769"><a href="#L-1769"><span class="linenos">1769</span></a><span class="sd">    feature : float, optional</span>
</span><span id="L-1770"><a href="#L-1770"><span class="linenos">1770</span></a><span class="sd">        Relative weight of the perceptual loss term. Default is 2.0.</span>
</span><span id="L-1771"><a href="#L-1771"><span class="linenos">1771</span></a><span class="sd">    tv : float, optional</span>
</span><span id="L-1772"><a href="#L-1772"><span class="linenos">1772</span></a><span class="sd">        Relative weight of the Total Variation regularization term. Default is 0.1.</span>
</span><span id="L-1773"><a href="#L-1773"><span class="linenos">1773</span></a><span class="sd">    dice : float, optional</span>
</span><span id="L-1774"><a href="#L-1774"><span class="linenos">1774</span></a><span class="sd">        Relative weight of the Dice loss term for the segmentation mask.</span>
</span><span id="L-1775"><a href="#L-1775"><span class="linenos">1775</span></a><span class="sd">        Default is 0.5.</span>
</span><span id="L-1776"><a href="#L-1776"><span class="linenos">1776</span></a><span class="sd">    max_iterations : int, optional</span>
</span><span id="L-1777"><a href="#L-1777"><span class="linenos">1777</span></a><span class="sd">        Total number of training iterations. Default is 1000.</span>
</span><span id="L-1778"><a href="#L-1778"><span class="linenos">1778</span></a><span class="sd">    batch_size : int, optional</span>
</span><span id="L-1779"><a href="#L-1779"><span class="linenos">1779</span></a><span class="sd">        The batch size for training. Default is 1.</span>
</span><span id="L-1780"><a href="#L-1780"><span class="linenos">1780</span></a><span class="sd">    save_all_best : bool, optional</span>
</span><span id="L-1781"><a href="#L-1781"><span class="linenos">1781</span></a><span class="sd">        If True, saves all models that improve validation loss. Default is False.</span>
</span><span id="L-1782"><a href="#L-1782"><span class="linenos">1782</span></a><span class="sd">    feature_type : str, optional</span>
</span><span id="L-1783"><a href="#L-1783"><span class="linenos">1783</span></a><span class="sd">        Type of feature extractor for perceptual loss. Default is &#39;grader&#39;.</span>
</span><span id="L-1784"><a href="#L-1784"><span class="linenos">1784</span></a><span class="sd">    check_eval_data_iteration : int, optional</span>
</span><span id="L-1785"><a href="#L-1785"><span class="linenos">1785</span></a><span class="sd">        Frequency (in iterations) for running validation. Default is 20.</span>
</span><span id="L-1786"><a href="#L-1786"><span class="linenos">1786</span></a><span class="sd">    verbose : bool, optional</span>
</span><span id="L-1787"><a href="#L-1787"><span class="linenos">1787</span></a><span class="sd">        If True, prints detailed progress information. Default is False.</span>
</span><span id="L-1788"><a href="#L-1788"><span class="linenos">1788</span></a>
</span><span id="L-1789"><a href="#L-1789"><span class="linenos">1789</span></a><span class="sd">    Returns</span>
</span><span id="L-1790"><a href="#L-1790"><span class="linenos">1790</span></a><span class="sd">    -------</span>
</span><span id="L-1791"><a href="#L-1791"><span class="linenos">1791</span></a><span class="sd">    pd.DataFrame</span>
</span><span id="L-1792"><a href="#L-1792"><span class="linenos">1792</span></a><span class="sd">        A DataFrame containing the training history, including columns for losses</span>
</span><span id="L-1793"><a href="#L-1793"><span class="linenos">1793</span></a><span class="sd">        and evaluation metrics like PSNR and Dice score.</span>
</span><span id="L-1794"><a href="#L-1794"><span class="linenos">1794</span></a>
</span><span id="L-1795"><a href="#L-1795"><span class="linenos">1795</span></a><span class="sd">    See Also</span>
</span><span id="L-1796"><a href="#L-1796"><span class="linenos">1796</span></a><span class="sd">    --------</span>
</span><span id="L-1797"><a href="#L-1797"><span class="linenos">1797</span></a><span class="sd">    train : The training function for single-task (intensity-only) models.</span>
</span><span id="L-1798"><a href="#L-1798"><span class="linenos">1798</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1799"><a href="#L-1799"><span class="linenos">1799</span></a>    <span class="n">colnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;train_loss&#39;</span><span class="p">,</span><span class="s1">&#39;test_loss&#39;</span><span class="p">,</span><span class="s1">&#39;best&#39;</span><span class="p">,</span><span class="s1">&#39;eval_psnr&#39;</span><span class="p">,</span><span class="s1">&#39;eval_psnr_lin&#39;</span><span class="p">,</span><span class="s1">&#39;eval_msq&#39;</span><span class="p">,</span><span class="s1">&#39;eval_dice&#39;</span><span class="p">]</span>
</span><span id="L-1800"><a href="#L-1800"><span class="linenos">1800</span></a>    <span class="n">training_path</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span> <span class="n">max_iterations</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">colnames</span><span class="p">)</span> <span class="p">]</span> <span class="p">)</span>
</span><span id="L-1801"><a href="#L-1801"><span class="linenos">1801</span></a>    <span class="n">training_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span> <span class="p">)</span>
</span><span id="L-1802"><a href="#L-1802"><span class="linenos">1802</span></a>    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1803"><a href="#L-1803"><span class="linenos">1803</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;begin get feature extractor&quot;</span><span class="p">)</span>
</span><span id="L-1804"><a href="#L-1804"><span class="linenos">1804</span></a>    <span class="k">if</span> <span class="n">feature_type</span> <span class="o">==</span> <span class="s1">&#39;grader&#39;</span><span class="p">:</span>
</span><span id="L-1805"><a href="#L-1805"><span class="linenos">1805</span></a>        <span class="n">feature_extractor</span> <span class="o">=</span> <span class="n">get_grader_feature_network</span><span class="p">(</span> <span class="n">feature_layer</span> <span class="p">)</span>
</span><span id="L-1806"><a href="#L-1806"><span class="linenos">1806</span></a>    <span class="k">elif</span> <span class="n">feature_type</span> <span class="o">==</span> <span class="s1">&#39;vggrandom&#39;</span><span class="p">:</span>
</span><span id="L-1807"><a href="#L-1807"><span class="linenos">1807</span></a>        <span class="n">feature_extractor</span> <span class="o">=</span> <span class="n">pseudo_3d_vgg_features</span><span class="p">(</span> <span class="n">target_patch_size</span><span class="p">,</span> <span class="n">feature_layer</span><span class="p">,</span> <span class="n">pretrained</span><span class="o">=</span><span class="kc">False</span> <span class="p">)</span>
</span><span id="L-1808"><a href="#L-1808"><span class="linenos">1808</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-1809"><a href="#L-1809"><span class="linenos">1809</span></a>        <span class="n">feature_extractor</span> <span class="o">=</span> <span class="n">pseudo_3d_vgg_features_unbiased</span><span class="p">(</span> <span class="n">target_patch_size</span><span class="p">,</span> <span class="n">feature_layer</span>  <span class="p">)</span>
</span><span id="L-1810"><a href="#L-1810"><span class="linenos">1810</span></a>    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1811"><a href="#L-1811"><span class="linenos">1811</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;begin train generator&quot;</span><span class="p">)</span>
</span><span id="L-1812"><a href="#L-1812"><span class="linenos">1812</span></a>    <span class="n">mydatgen</span> <span class="o">=</span> <span class="n">seg_generator</span><span class="p">(</span>
</span><span id="L-1813"><a href="#L-1813"><span class="linenos">1813</span></a>        <span class="n">filenames_train</span><span class="p">,</span>
</span><span id="L-1814"><a href="#L-1814"><span class="linenos">1814</span></a>        <span class="n">nPatches</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="L-1815"><a href="#L-1815"><span class="linenos">1815</span></a>        <span class="n">target_patch_size</span><span class="o">=</span><span class="n">target_patch_size</span><span class="p">,</span>
</span><span id="L-1816"><a href="#L-1816"><span class="linenos">1816</span></a>        <span class="n">target_patch_size_low</span><span class="o">=</span><span class="n">target_patch_size_low</span><span class="p">,</span>
</span><span id="L-1817"><a href="#L-1817"><span class="linenos">1817</span></a>        <span class="n">istest</span><span class="o">=</span><span class="kc">False</span> <span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-1818"><a href="#L-1818"><span class="linenos">1818</span></a>    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1819"><a href="#L-1819"><span class="linenos">1819</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;begin test generator&quot;</span><span class="p">)</span>
</span><span id="L-1820"><a href="#L-1820"><span class="linenos">1820</span></a>    <span class="n">mydatgenTest</span> <span class="o">=</span> <span class="n">seg_generator</span><span class="p">(</span> <span class="n">filenames_test</span><span class="p">,</span> <span class="n">nPatches</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="L-1821"><a href="#L-1821"><span class="linenos">1821</span></a>        <span class="n">target_patch_size</span><span class="o">=</span><span class="n">target_patch_size</span><span class="p">,</span>
</span><span id="L-1822"><a href="#L-1822"><span class="linenos">1822</span></a>        <span class="n">target_patch_size_low</span><span class="o">=</span><span class="n">target_patch_size_low</span><span class="p">,</span>
</span><span id="L-1823"><a href="#L-1823"><span class="linenos">1823</span></a>        <span class="n">istest</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1824"><a href="#L-1824"><span class="linenos">1824</span></a>    <span class="n">patchesResamTeTf</span><span class="p">,</span> <span class="n">patchesOrigTeTf</span><span class="p">,</span> <span class="n">patchesUpTeTf</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span> <span class="n">mydatgenTest</span> <span class="p">)</span>
</span><span id="L-1825"><a href="#L-1825"><span class="linenos">1825</span></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span> <span class="n">patchesOrigTeTf</span><span class="o">.</span><span class="n">shape</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
</span><span id="L-1826"><a href="#L-1826"><span class="linenos">1826</span></a>            <span class="n">tdim</span> <span class="o">=</span> <span class="mi">3</span>
</span><span id="L-1827"><a href="#L-1827"><span class="linenos">1827</span></a>            <span class="n">myax</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span>
</span><span id="L-1828"><a href="#L-1828"><span class="linenos">1828</span></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span> <span class="n">patchesOrigTeTf</span><span class="o">.</span><span class="n">shape</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
</span><span id="L-1829"><a href="#L-1829"><span class="linenos">1829</span></a>            <span class="n">tdim</span> <span class="o">=</span> <span class="mi">2</span>
</span><span id="L-1830"><a href="#L-1830"><span class="linenos">1830</span></a>            <span class="n">myax</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
</span><span id="L-1831"><a href="#L-1831"><span class="linenos">1831</span></a>    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1832"><a href="#L-1832"><span class="linenos">1832</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;begin train generator #2 at dim: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span> <span class="n">tdim</span><span class="p">))</span>
</span><span id="L-1833"><a href="#L-1833"><span class="linenos">1833</span></a>    <span class="n">mydatgenTest</span> <span class="o">=</span> <span class="n">seg_generator</span><span class="p">(</span> <span class="n">filenames_test</span><span class="p">,</span> <span class="n">nPatches</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="L-1834"><a href="#L-1834"><span class="linenos">1834</span></a>        <span class="n">target_patch_size</span><span class="o">=</span><span class="n">target_patch_size</span><span class="p">,</span>
</span><span id="L-1835"><a href="#L-1835"><span class="linenos">1835</span></a>        <span class="n">target_patch_size_low</span><span class="o">=</span><span class="n">target_patch_size_low</span><span class="p">,</span>
</span><span id="L-1836"><a href="#L-1836"><span class="linenos">1836</span></a>        <span class="n">istest</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1837"><a href="#L-1837"><span class="linenos">1837</span></a>    <span class="n">patchesResamTeTfB</span><span class="p">,</span> <span class="n">patchesOrigTeTfB</span><span class="p">,</span> <span class="n">patchesUpTeTfB</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span> <span class="n">mydatgenTest</span> <span class="p">)</span>
</span><span id="L-1838"><a href="#L-1838"><span class="linenos">1838</span></a>    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">n_test</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">):</span>
</span><span id="L-1839"><a href="#L-1839"><span class="linenos">1839</span></a>        <span class="n">mydatgenTest</span> <span class="o">=</span> <span class="n">seg_generator</span><span class="p">(</span> <span class="n">filenames_test</span><span class="p">,</span> <span class="n">nPatches</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="L-1840"><a href="#L-1840"><span class="linenos">1840</span></a>            <span class="n">target_patch_size</span><span class="o">=</span><span class="n">target_patch_size</span><span class="p">,</span>
</span><span id="L-1841"><a href="#L-1841"><span class="linenos">1841</span></a>            <span class="n">target_patch_size_low</span><span class="o">=</span><span class="n">target_patch_size_low</span><span class="p">,</span>
</span><span id="L-1842"><a href="#L-1842"><span class="linenos">1842</span></a>            <span class="n">istest</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1843"><a href="#L-1843"><span class="linenos">1843</span></a>        <span class="n">temp0</span><span class="p">,</span> <span class="n">temp1</span><span class="p">,</span> <span class="n">temp2</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span> <span class="n">mydatgenTest</span> <span class="p">)</span>
</span><span id="L-1844"><a href="#L-1844"><span class="linenos">1844</span></a>        <span class="n">patchesResamTeTfB</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span> <span class="p">[</span><span class="n">patchesResamTeTfB</span><span class="p">,</span><span class="n">temp0</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-1845"><a href="#L-1845"><span class="linenos">1845</span></a>        <span class="n">patchesOrigTeTfB</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span> <span class="p">[</span><span class="n">patchesOrigTeTfB</span><span class="p">,</span><span class="n">temp1</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-1846"><a href="#L-1846"><span class="linenos">1846</span></a>        <span class="n">patchesUpTeTfB</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span> <span class="p">[</span><span class="n">patchesUpTeTfB</span><span class="p">,</span><span class="n">temp2</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-1847"><a href="#L-1847"><span class="linenos">1847</span></a>    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1848"><a href="#L-1848"><span class="linenos">1848</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;begin auto_weight_loss_seg&quot;</span><span class="p">)</span>
</span><span id="L-1849"><a href="#L-1849"><span class="linenos">1849</span></a>    <span class="n">wts_csv</span> <span class="o">=</span> <span class="n">output_prefix</span> <span class="o">+</span> <span class="s2">&quot;_training_weights.csv&quot;</span>
</span><span id="L-1850"><a href="#L-1850"><span class="linenos">1850</span></a>    <span class="k">if</span> <span class="n">exists</span><span class="p">(</span> <span class="n">wts_csv</span> <span class="p">):</span>
</span><span id="L-1851"><a href="#L-1851"><span class="linenos">1851</span></a>        <span class="n">wtsdf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span> <span class="n">wts_csv</span> <span class="p">)</span>
</span><span id="L-1852"><a href="#L-1852"><span class="linenos">1852</span></a>        <span class="n">wts</span> <span class="o">=</span> <span class="p">[</span><span class="n">wtsdf</span><span class="p">[</span><span class="s1">&#39;msq&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">wtsdf</span><span class="p">[</span><span class="s1">&#39;feat&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">wtsdf</span><span class="p">[</span><span class="s1">&#39;tv&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">wtsdf</span><span class="p">[</span><span class="s1">&#39;dice&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
</span><span id="L-1853"><a href="#L-1853"><span class="linenos">1853</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1854"><a href="#L-1854"><span class="linenos">1854</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;preset weights:&quot;</span> <span class="p">)</span>
</span><span id="L-1855"><a href="#L-1855"><span class="linenos">1855</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-1856"><a href="#L-1856"><span class="linenos">1856</span></a>        <span class="n">wts</span> <span class="o">=</span> <span class="n">auto_weight_loss_seg</span><span class="p">(</span> <span class="n">mdl</span><span class="p">,</span> <span class="n">feature_extractor</span><span class="p">,</span> <span class="n">patchesResamTeTf</span><span class="p">,</span> <span class="n">patchesOrigTeTf</span><span class="p">,</span>
</span><span id="L-1857"><a href="#L-1857"><span class="linenos">1857</span></a>            <span class="n">feature</span><span class="o">=</span><span class="n">feature</span><span class="p">,</span> <span class="n">tv</span><span class="o">=</span><span class="n">tv</span><span class="p">,</span> <span class="n">dice</span><span class="o">=</span><span class="n">dice</span> <span class="p">)</span>
</span><span id="L-1858"><a href="#L-1858"><span class="linenos">1858</span></a>        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">wts</span><span class="p">)):</span>
</span><span id="L-1859"><a href="#L-1859"><span class="linenos">1859</span></a>            <span class="n">training_weights</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">=</span><span class="n">wts</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
</span><span id="L-1860"><a href="#L-1860"><span class="linenos">1860</span></a>        <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">training_weights</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;msq&quot;</span><span class="p">,</span><span class="s2">&quot;feat&quot;</span><span class="p">,</span><span class="s2">&quot;tv&quot;</span><span class="p">,</span><span class="s2">&quot;dice&quot;</span><span class="p">]</span> <span class="p">)</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span> <span class="n">wts_csv</span> <span class="p">)</span>
</span><span id="L-1861"><a href="#L-1861"><span class="linenos">1861</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1862"><a href="#L-1862"><span class="linenos">1862</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;automatic weights:&quot;</span> <span class="p">)</span>
</span><span id="L-1863"><a href="#L-1863"><span class="linenos">1863</span></a>    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1864"><a href="#L-1864"><span class="linenos">1864</span></a>        <span class="nb">print</span><span class="p">(</span> <span class="n">wts</span> <span class="p">)</span>
</span><span id="L-1865"><a href="#L-1865"><span class="linenos">1865</span></a>    <span class="k">def</span> <span class="nf">my_loss_6</span><span class="p">(</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">msqwt</span> <span class="o">=</span> <span class="n">wts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fw</span> <span class="o">=</span> <span class="n">wts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">tvwt</span> <span class="o">=</span> <span class="n">wts</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">dicewt</span><span class="o">=</span><span class="n">wts</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">mybs</span> <span class="o">=</span> <span class="n">batch_size</span> <span class="p">):</span>
</span><span id="L-1866"><a href="#L-1866"><span class="linenos">1866</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Composite loss: MSE + Perceptual + TV + Dice.&quot;&quot;&quot;</span>
</span><span id="L-1867"><a href="#L-1867"><span class="linenos">1867</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span> <span class="n">y_true</span><span class="o">.</span><span class="n">shape</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
</span><span id="L-1868"><a href="#L-1868"><span class="linenos">1868</span></a>            <span class="n">tdim</span> <span class="o">=</span> <span class="mi">3</span>
</span><span id="L-1869"><a href="#L-1869"><span class="linenos">1869</span></a>            <span class="n">myax</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span>
</span><span id="L-1870"><a href="#L-1870"><span class="linenos">1870</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span> <span class="n">y_true</span><span class="o">.</span><span class="n">shape</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
</span><span id="L-1871"><a href="#L-1871"><span class="linenos">1871</span></a>            <span class="n">tdim</span> <span class="o">=</span> <span class="mi">2</span>
</span><span id="L-1872"><a href="#L-1872"><span class="linenos">1872</span></a>            <span class="n">myax</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
</span><span id="L-1873"><a href="#L-1873"><span class="linenos">1873</span></a>        <span class="n">y_intensity</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span> <span class="n">y_true</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">tdim</span><span class="o">+</span><span class="mi">1</span> <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1874"><a href="#L-1874"><span class="linenos">1874</span></a>        <span class="n">y_seg</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span> <span class="n">y_true</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">tdim</span><span class="o">+</span><span class="mi">1</span> <span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-1875"><a href="#L-1875"><span class="linenos">1875</span></a>        <span class="n">y_intensity_p</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span> <span class="n">y_pred</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">tdim</span><span class="o">+</span><span class="mi">1</span> <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1876"><a href="#L-1876"><span class="linenos">1876</span></a>        <span class="n">y_seg_p</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span> <span class="n">y_pred</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">tdim</span><span class="o">+</span><span class="mi">1</span> <span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-1877"><a href="#L-1877"><span class="linenos">1877</span></a>        <span class="n">squared_difference</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">y_intensity</span> <span class="o">-</span> <span class="n">y_intensity_p</span><span class="p">)</span>
</span><span id="L-1878"><a href="#L-1878"><span class="linenos">1878</span></a>        <span class="n">msqTerm</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">squared_difference</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">myax</span><span class="p">)</span>
</span><span id="L-1879"><a href="#L-1879"><span class="linenos">1879</span></a>        <span class="n">temp1</span> <span class="o">=</span> <span class="n">feature_extractor</span><span class="p">(</span><span class="n">y_intensity</span><span class="p">)</span>
</span><span id="L-1880"><a href="#L-1880"><span class="linenos">1880</span></a>        <span class="n">temp2</span> <span class="o">=</span> <span class="n">feature_extractor</span><span class="p">(</span><span class="n">y_intensity_p</span><span class="p">)</span>
</span><span id="L-1881"><a href="#L-1881"><span class="linenos">1881</span></a>        <span class="n">feature_difference</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">temp1</span><span class="o">-</span><span class="n">temp2</span><span class="p">)</span>
</span><span id="L-1882"><a href="#L-1882"><span class="linenos">1882</span></a>        <span class="n">featureTerm</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">feature_difference</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">myax</span><span class="p">)</span>
</span><span id="L-1883"><a href="#L-1883"><span class="linenos">1883</span></a>        <span class="n">loss</span> <span class="o">=</span> <span class="n">msqTerm</span> <span class="o">*</span> <span class="n">msqwt</span> <span class="o">+</span> <span class="n">featureTerm</span> <span class="o">*</span> <span class="n">fw</span>
</span><span id="L-1884"><a href="#L-1884"><span class="linenos">1884</span></a>        <span class="n">mytv</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s1">&#39;float32&#39;</span><span class="p">)</span>
</span><span id="L-1885"><a href="#L-1885"><span class="linenos">1885</span></a>        <span class="k">if</span> <span class="n">tdim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="L-1886"><a href="#L-1886"><span class="linenos">1886</span></a>            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">mybs</span> <span class="p">):</span> <span class="c1"># BUG not sure why myr fails .... might be old TF version</span>
</span><span id="L-1887"><a href="#L-1887"><span class="linenos">1887</span></a>                <span class="n">sqzd</span> <span class="o">=</span> <span class="n">y_pred</span><span class="p">[</span><span class="n">k</span><span class="p">,:,:,:,</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1888"><a href="#L-1888"><span class="linenos">1888</span></a>                <span class="n">mytv</span> <span class="o">=</span> <span class="n">mytv</span> <span class="o">+</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">total_variation</span><span class="p">(</span> <span class="n">sqzd</span> <span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">tvwt</span>
</span><span id="L-1889"><a href="#L-1889"><span class="linenos">1889</span></a>        <span class="k">if</span> <span class="n">tdim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-1890"><a href="#L-1890"><span class="linenos">1890</span></a>            <span class="n">mytv</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">total_variation</span><span class="p">(</span> <span class="n">y_pred</span><span class="p">[:,:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">tvwt</span>
</span><span id="L-1891"><a href="#L-1891"><span class="linenos">1891</span></a>        <span class="n">dicer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span> <span class="n">dicewt</span> <span class="o">*</span> <span class="n">binary_dice_loss</span><span class="p">(</span> <span class="n">y_seg</span><span class="p">,</span> <span class="n">y_seg_p</span> <span class="p">)</span> <span class="p">)</span>
</span><span id="L-1892"><a href="#L-1892"><span class="linenos">1892</span></a>        <span class="k">return</span><span class="p">(</span> <span class="n">loss</span> <span class="o">+</span> <span class="n">mytv</span> <span class="o">+</span> <span class="n">dicer</span> <span class="p">)</span>
</span><span id="L-1893"><a href="#L-1893"><span class="linenos">1893</span></a>    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1894"><a href="#L-1894"><span class="linenos">1894</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;begin model compilation&quot;</span><span class="p">)</span>
</span><span id="L-1895"><a href="#L-1895"><span class="linenos">1895</span></a>    <span class="n">opt</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span> <span class="n">learning_rate</span><span class="o">=</span><span class="n">learning_rate</span> <span class="p">)</span>
</span><span id="L-1896"><a href="#L-1896"><span class="linenos">1896</span></a>    <span class="n">mdl</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">opt</span><span class="p">,</span> <span class="n">loss</span><span class="o">=</span><span class="n">my_loss_6</span><span class="p">)</span>
</span><span id="L-1897"><a href="#L-1897"><span class="linenos">1897</span></a>    <span class="c1"># set up some parameters for tracking performance</span>
</span><span id="L-1898"><a href="#L-1898"><span class="linenos">1898</span></a>    <span class="n">bestValLoss</span><span class="o">=</span><span class="mf">1e12</span>
</span><span id="L-1899"><a href="#L-1899"><span class="linenos">1899</span></a>    <span class="n">bestSSIM</span><span class="o">=</span><span class="mf">0.0</span>
</span><span id="L-1900"><a href="#L-1900"><span class="linenos">1900</span></a>    <span class="n">bestQC0</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1000</span>
</span><span id="L-1901"><a href="#L-1901"><span class="linenos">1901</span></a>    <span class="n">bestQC1</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1000</span>
</span><span id="L-1902"><a href="#L-1902"><span class="linenos">1902</span></a>    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1903"><a href="#L-1903"><span class="linenos">1903</span></a>        <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;begin training&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span>  <span class="p">)</span>
</span><span id="L-1904"><a href="#L-1904"><span class="linenos">1904</span></a>    <span class="k">for</span> <span class="n">myrs</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">max_iterations</span> <span class="p">):</span>
</span><span id="L-1905"><a href="#L-1905"><span class="linenos">1905</span></a>        <span class="n">tracker</span> <span class="o">=</span> <span class="n">mdl</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span> <span class="n">mydatgen</span><span class="p">,</span>  <span class="n">epochs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">steps_per_epoch</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="L-1906"><a href="#L-1906"><span class="linenos">1906</span></a>            <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">patchesResamTeTf</span><span class="p">,</span><span class="n">patchesOrigTeTf</span><span class="p">)</span> <span class="p">)</span>
</span><span id="L-1907"><a href="#L-1907"><span class="linenos">1907</span></a>        <span class="n">training_path</span><span class="p">[</span><span class="n">myrs</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">tracker</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1908"><a href="#L-1908"><span class="linenos">1908</span></a>        <span class="n">training_path</span><span class="p">[</span><span class="n">myrs</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">tracker</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_loss&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1909"><a href="#L-1909"><span class="linenos">1909</span></a>        <span class="n">training_path</span><span class="p">[</span><span class="n">myrs</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
</span><span id="L-1910"><a href="#L-1910"><span class="linenos">1910</span></a>        <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;ntrain: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">myrs</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; loss &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span> <span class="n">tracker</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; val-loss &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">tracker</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_loss&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span>  <span class="p">)</span>
</span><span id="L-1911"><a href="#L-1911"><span class="linenos">1911</span></a>        <span class="k">if</span> <span class="n">myrs</span> <span class="o">%</span> <span class="n">check_eval_data_iteration</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1912"><a href="#L-1912"><span class="linenos">1912</span></a>            <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;/cpu:0&quot;</span><span class="p">):</span>
</span><span id="L-1913"><a href="#L-1913"><span class="linenos">1913</span></a>                <span class="n">myofn</span> <span class="o">=</span> <span class="n">output_prefix</span> <span class="o">+</span> <span class="s2">&quot;_best_mdl.keras&quot;</span>
</span><span id="L-1914"><a href="#L-1914"><span class="linenos">1914</span></a>                <span class="k">if</span> <span class="n">save_all_best</span><span class="p">:</span>
</span><span id="L-1915"><a href="#L-1915"><span class="linenos">1915</span></a>                    <span class="n">myofn</span> <span class="o">=</span> <span class="n">output_prefix</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">myrs</span><span class="p">)</span><span class="o">+</span> <span class="s2">&quot;_mdl.keras&quot;</span>
</span><span id="L-1916"><a href="#L-1916"><span class="linenos">1916</span></a>                <span class="n">tester</span> <span class="o">=</span> <span class="n">mdl</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span> <span class="n">patchesResamTeTfB</span><span class="p">,</span> <span class="n">patchesOrigTeTfB</span> <span class="p">)</span>
</span><span id="L-1917"><a href="#L-1917"><span class="linenos">1917</span></a>                <span class="k">if</span> <span class="p">(</span> <span class="n">tester</span> <span class="o">&lt;</span> <span class="n">bestValLoss</span> <span class="p">):</span>
</span><span id="L-1918"><a href="#L-1918"><span class="linenos">1918</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;MyIT &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span> <span class="n">myrs</span> <span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; IS BEST!! &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span> <span class="n">tester</span> <span class="p">)</span> <span class="o">+</span> <span class="n">myofn</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span> <span class="p">)</span>
</span><span id="L-1919"><a href="#L-1919"><span class="linenos">1919</span></a>                    <span class="n">bestValLoss</span> <span class="o">=</span> <span class="n">tester</span>
</span><span id="L-1920"><a href="#L-1920"><span class="linenos">1920</span></a>                    <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span> <span class="n">mdl</span><span class="p">,</span> <span class="n">myofn</span> <span class="p">)</span>
</span><span id="L-1921"><a href="#L-1921"><span class="linenos">1921</span></a>                    <span class="n">training_path</span><span class="p">[</span><span class="n">myrs</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
</span><span id="L-1922"><a href="#L-1922"><span class="linenos">1922</span></a>                <span class="n">pp</span> <span class="o">=</span> <span class="n">mdl</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span> <span class="n">patchesResamTeTfB</span><span class="p">,</span> <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">)</span>
</span><span id="L-1923"><a href="#L-1923"><span class="linenos">1923</span></a>                <span class="n">pp</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span> <span class="n">pp</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">tdim</span><span class="o">+</span><span class="mi">1</span> <span class="p">)</span>
</span><span id="L-1924"><a href="#L-1924"><span class="linenos">1924</span></a>                <span class="n">y_orig</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span> <span class="n">patchesOrigTeTfB</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">tdim</span><span class="o">+</span><span class="mi">1</span> <span class="p">)</span>
</span><span id="L-1925"><a href="#L-1925"><span class="linenos">1925</span></a>                <span class="n">y_up</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span> <span class="n">patchesUpTeTfB</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">tdim</span><span class="o">+</span><span class="mi">1</span> <span class="p">)</span>
</span><span id="L-1926"><a href="#L-1926"><span class="linenos">1926</span></a>                <span class="n">myssimSR</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">psnr</span><span class="p">(</span> <span class="n">pp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">220</span><span class="p">,</span> <span class="n">y_orig</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span> <span class="mi">220</span><span class="p">,</span> <span class="n">max_val</span><span class="o">=</span><span class="mi">255</span> <span class="p">)</span>
</span><span id="L-1927"><a href="#L-1927"><span class="linenos">1927</span></a>                <span class="n">myssimSR</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span> <span class="n">myssimSR</span> <span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="L-1928"><a href="#L-1928"><span class="linenos">1928</span></a>                <span class="n">myssimBI</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">psnr</span><span class="p">(</span> <span class="n">y_up</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">220</span><span class="p">,</span> <span class="n">y_orig</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span> <span class="mi">220</span><span class="p">,</span> <span class="n">max_val</span><span class="o">=</span><span class="mi">255</span> <span class="p">)</span>
</span><span id="L-1929"><a href="#L-1929"><span class="linenos">1929</span></a>                <span class="n">myssimBI</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span> <span class="n">myssimBI</span> <span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="L-1930"><a href="#L-1930"><span class="linenos">1930</span></a>                <span class="n">squared_difference</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">y_orig</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pp</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-1931"><a href="#L-1931"><span class="linenos">1931</span></a>                <span class="n">msqTerm</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">squared_difference</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="L-1932"><a href="#L-1932"><span class="linenos">1932</span></a>                <span class="n">dicer</span> <span class="o">=</span> <span class="n">binary_dice_loss</span><span class="p">(</span> <span class="n">y_orig</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
</span><span id="L-1933"><a href="#L-1933"><span class="linenos">1933</span></a>                <span class="n">dicer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span> <span class="n">dicer</span> <span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="L-1934"><a href="#L-1934"><span class="linenos">1934</span></a>                <span class="nb">print</span><span class="p">(</span> <span class="n">myofn</span> <span class="o">+</span> <span class="s2">&quot; : &quot;</span> <span class="o">+</span> <span class="s2">&quot;PSNR Lin: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span> <span class="n">myssimBI</span> <span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; SR: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span> <span class="n">myssimSR</span> <span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; MSQ: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">msqTerm</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; DICE: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">dicer</span><span class="p">),</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span>  <span class="p">)</span>
</span><span id="L-1935"><a href="#L-1935"><span class="linenos">1935</span></a>                <span class="n">training_path</span><span class="p">[</span><span class="n">myrs</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">myssimSR</span> <span class="c1"># psnr</span>
</span><span id="L-1936"><a href="#L-1936"><span class="linenos">1936</span></a>                <span class="n">training_path</span><span class="p">[</span><span class="n">myrs</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="n">myssimBI</span> <span class="c1"># psnrlin</span>
</span><span id="L-1937"><a href="#L-1937"><span class="linenos">1937</span></a>                <span class="n">training_path</span><span class="p">[</span><span class="n">myrs</span><span class="p">,</span><span class="mi">5</span><span class="p">]</span><span class="o">=</span><span class="n">msqTerm</span> <span class="c1"># msq</span>
</span><span id="L-1938"><a href="#L-1938"><span class="linenos">1938</span></a>                <span class="n">training_path</span><span class="p">[</span><span class="n">myrs</span><span class="p">,</span><span class="mi">6</span><span class="p">]</span><span class="o">=</span><span class="n">dicer</span> <span class="c1"># dice</span>
</span><span id="L-1939"><a href="#L-1939"><span class="linenos">1939</span></a>                <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">training_path</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">colnames</span> <span class="p">)</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span> <span class="n">output_prefix</span> <span class="o">+</span> <span class="s2">&quot;_training.csv&quot;</span> <span class="p">)</span>
</span><span id="L-1940"><a href="#L-1940"><span class="linenos">1940</span></a>    <span class="n">training_path</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">training_path</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">colnames</span> <span class="p">)</span>
</span><span id="L-1941"><a href="#L-1941"><span class="linenos">1941</span></a>    <span class="k">return</span> <span class="n">training_path</span>
</span><span id="L-1942"><a href="#L-1942"><span class="linenos">1942</span></a>
</span><span id="L-1943"><a href="#L-1943"><span class="linenos">1943</span></a>
</span><span id="L-1944"><a href="#L-1944"><span class="linenos">1944</span></a><span class="k">def</span> <span class="nf">read_srmodel</span><span class="p">(</span><span class="n">srfilename</span><span class="p">,</span> <span class="n">custom_objects</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-1945"><a href="#L-1945"><span class="linenos">1945</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1946"><a href="#L-1946"><span class="linenos">1946</span></a><span class="sd">    Load a super-resolution model (h5, .keras, or SavedModel format),</span>
</span><span id="L-1947"><a href="#L-1947"><span class="linenos">1947</span></a><span class="sd">    and determine its upsampling factor.</span>
</span><span id="L-1948"><a href="#L-1948"><span class="linenos">1948</span></a>
</span><span id="L-1949"><a href="#L-1949"><span class="linenos">1949</span></a><span class="sd">    Parameters</span>
</span><span id="L-1950"><a href="#L-1950"><span class="linenos">1950</span></a><span class="sd">    ----------</span>
</span><span id="L-1951"><a href="#L-1951"><span class="linenos">1951</span></a><span class="sd">    srfilename : str</span>
</span><span id="L-1952"><a href="#L-1952"><span class="linenos">1952</span></a><span class="sd">        Path to the model file (.h5, .keras, or a SavedModel folder).</span>
</span><span id="L-1953"><a href="#L-1953"><span class="linenos">1953</span></a><span class="sd">    custom_objects : dict, optional</span>
</span><span id="L-1954"><a href="#L-1954"><span class="linenos">1954</span></a><span class="sd">        Dictionary of custom objects used in the model (e.g. {&#39;TFOpLambda&#39;: tf.keras.layers.Lambda(...)})</span>
</span><span id="L-1955"><a href="#L-1955"><span class="linenos">1955</span></a>
</span><span id="L-1956"><a href="#L-1956"><span class="linenos">1956</span></a><span class="sd">    Returns</span>
</span><span id="L-1957"><a href="#L-1957"><span class="linenos">1957</span></a><span class="sd">    -------</span>
</span><span id="L-1958"><a href="#L-1958"><span class="linenos">1958</span></a><span class="sd">    model : tf.keras.Model</span>
</span><span id="L-1959"><a href="#L-1959"><span class="linenos">1959</span></a><span class="sd">        The loaded model.</span>
</span><span id="L-1960"><a href="#L-1960"><span class="linenos">1960</span></a><span class="sd">    upsampling_factor : list of int</span>
</span><span id="L-1961"><a href="#L-1961"><span class="linenos">1961</span></a><span class="sd">        List describing the upsampling factor:</span>
</span><span id="L-1962"><a href="#L-1962"><span class="linenos">1962</span></a><span class="sd">        - For 3D input: [x_up, y_up, z_up, channels]</span>
</span><span id="L-1963"><a href="#L-1963"><span class="linenos">1963</span></a><span class="sd">        - For 2D input: [x_up, y_up, channels]</span>
</span><span id="L-1964"><a href="#L-1964"><span class="linenos">1964</span></a>
</span><span id="L-1965"><a href="#L-1965"><span class="linenos">1965</span></a><span class="sd">    Example</span>
</span><span id="L-1966"><a href="#L-1966"><span class="linenos">1966</span></a><span class="sd">    -------</span>
</span><span id="L-1967"><a href="#L-1967"><span class="linenos">1967</span></a><span class="sd">    &gt;&gt;&gt; mdl, up = read_srmodel(&quot;mymodel.keras&quot;)</span>
</span><span id="L-1968"><a href="#L-1968"><span class="linenos">1968</span></a><span class="sd">    &gt;&gt;&gt; mdl, up = read_srmodel(&quot;my_weights.h5&quot;, custom_objects={&quot;TFOpLambda&quot;: tf.keras.layers.Lambda(tf.identity)})</span>
</span><span id="L-1969"><a href="#L-1969"><span class="linenos">1969</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1970"><a href="#L-1970"><span class="linenos">1970</span></a>
</span><span id="L-1971"><a href="#L-1971"><span class="linenos">1971</span></a>    <span class="c1"># Expand path and detect format</span>
</span><span id="L-1972"><a href="#L-1972"><span class="linenos">1972</span></a>    <span class="n">srfilename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">srfilename</span><span class="p">)</span>
</span><span id="L-1973"><a href="#L-1973"><span class="linenos">1973</span></a>    <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">srfilename</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="L-1974"><a href="#L-1974"><span class="linenos">1974</span></a>
</span><span id="L-1975"><a href="#L-1975"><span class="linenos">1975</span></a>    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">srfilename</span><span class="p">):</span>
</span><span id="L-1976"><a href="#L-1976"><span class="linenos">1976</span></a>        <span class="c1"># SavedModel directory</span>
</span><span id="L-1977"><a href="#L-1977"><span class="linenos">1977</span></a>        <span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="n">srfilename</span><span class="p">,</span> <span class="n">custom_objects</span><span class="o">=</span><span class="n">custom_objects</span><span class="p">,</span> <span class="nb">compile</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-1978"><a href="#L-1978"><span class="linenos">1978</span></a>    <span class="k">elif</span> <span class="n">ext</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;.h5&#39;</span><span class="p">,</span> <span class="s1">&#39;.keras&#39;</span><span class="p">]:</span>
</span><span id="L-1979"><a href="#L-1979"><span class="linenos">1979</span></a>        <span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="n">srfilename</span><span class="p">,</span> <span class="n">custom_objects</span><span class="o">=</span><span class="n">custom_objects</span><span class="p">,</span> <span class="nb">compile</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-1980"><a href="#L-1980"><span class="linenos">1980</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-1981"><a href="#L-1981"><span class="linenos">1981</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported model format: </span><span class="si">{</span><span class="n">ext</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-1982"><a href="#L-1982"><span class="linenos">1982</span></a>
</span><span id="L-1983"><a href="#L-1983"><span class="linenos">1983</span></a>    <span class="c1"># Determine channel index</span>
</span><span id="L-1984"><a href="#L-1984"><span class="linenos">1984</span></a>    <span class="n">input_shape</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">input_shape</span>
</span><span id="L-1985"><a href="#L-1985"><span class="linenos">1985</span></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">input_shape</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="L-1986"><a href="#L-1986"><span class="linenos">1986</span></a>        <span class="n">input_shape</span> <span class="o">=</span> <span class="n">input_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1987"><a href="#L-1987"><span class="linenos">1987</span></a>    <span class="n">chanindex</span> <span class="o">=</span> <span class="mi">3</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span> <span class="k">else</span> <span class="mi">4</span>
</span><span id="L-1988"><a href="#L-1988"><span class="linenos">1988</span></a>    <span class="n">nchan</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">input_shape</span><span class="p">[</span><span class="n">chanindex</span><span class="p">])</span>
</span><span id="L-1989"><a href="#L-1989"><span class="linenos">1989</span></a>
</span><span id="L-1990"><a href="#L-1990"><span class="linenos">1990</span></a>    <span class="c1"># Run dummy input to compute upsampling factor</span>
</span><span id="L-1991"><a href="#L-1991"><span class="linenos">1991</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="L-1992"><a href="#L-1992"><span class="linenos">1992</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>  <span class="c1"># 3D</span>
</span><span id="L-1993"><a href="#L-1993"><span class="linenos">1993</span></a>            <span class="n">dummy_input</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">nchan</span><span class="p">])</span>
</span><span id="L-1994"><a href="#L-1994"><span class="linenos">1994</span></a>        <span class="k">else</span><span class="p">:</span>  <span class="c1"># 2D</span>
</span><span id="L-1995"><a href="#L-1995"><span class="linenos">1995</span></a>            <span class="n">dummy_input</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">nchan</span><span class="p">])</span>
</span><span id="L-1996"><a href="#L-1996"><span class="linenos">1996</span></a>
</span><span id="L-1997"><a href="#L-1997"><span class="linenos">1997</span></a>        <span class="c1"># Handle named inputs if necessary</span>
</span><span id="L-1998"><a href="#L-1998"><span class="linenos">1998</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-1999"><a href="#L-1999"><span class="linenos">1999</span></a>            <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">dummy_input</span><span class="p">)</span>
</span><span id="L-2000"><a href="#L-2000"><span class="linenos">2000</span></a>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="L-2001"><a href="#L-2001"><span class="linenos">2001</span></a>            <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">({</span><span class="n">model</span><span class="o">.</span><span class="n">input_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">dummy_input</span><span class="p">})</span>
</span><span id="L-2002"><a href="#L-2002"><span class="linenos">2002</span></a>
</span><span id="L-2003"><a href="#L-2003"><span class="linenos">2003</span></a>        <span class="n">outshp</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">shape</span>
</span><span id="L-2004"><a href="#L-2004"><span class="linenos">2004</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
</span><span id="L-2005"><a href="#L-2005"><span class="linenos">2005</span></a>            <span class="k">return</span> <span class="n">model</span><span class="p">,</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">outshp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">8</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">outshp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="mi">8</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">outshp</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">/</span><span class="mi">8</span><span class="p">),</span> <span class="n">nchan</span><span class="p">]</span>
</span><span id="L-2006"><a href="#L-2006"><span class="linenos">2006</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-2007"><a href="#L-2007"><span class="linenos">2007</span></a>            <span class="k">return</span> <span class="n">model</span><span class="p">,</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">outshp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">8</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">outshp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="mi">8</span><span class="p">),</span> <span class="n">nchan</span><span class="p">]</span>
</span><span id="L-2008"><a href="#L-2008"><span class="linenos">2008</span></a>
</span><span id="L-2009"><a href="#L-2009"><span class="linenos">2009</span></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-2010"><a href="#L-2010"><span class="linenos">2010</span></a>        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not infer upsampling factor. Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-2011"><a href="#L-2011"><span class="linenos">2011</span></a>
</span><span id="L-2012"><a href="#L-2012"><span class="linenos">2012</span></a>
</span><span id="L-2013"><a href="#L-2013"><span class="linenos">2013</span></a><span class="k">def</span> <span class="nf">simulate_image</span><span class="p">(</span> <span class="n">shaper</span><span class="o">=</span><span class="p">[</span><span class="mi">32</span><span class="p">,</span><span class="mi">32</span><span class="p">,</span><span class="mi">32</span><span class="p">],</span> <span class="n">n_levels</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">multiply</span><span class="o">=</span><span class="kc">False</span> <span class="p">):</span>
</span><span id="L-2014"><a href="#L-2014"><span class="linenos">2014</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2015"><a href="#L-2015"><span class="linenos">2015</span></a><span class="sd">    generate an image of given shape and number of levels</span>
</span><span id="L-2016"><a href="#L-2016"><span class="linenos">2016</span></a>
</span><span id="L-2017"><a href="#L-2017"><span class="linenos">2017</span></a><span class="sd">    Arguments</span>
</span><span id="L-2018"><a href="#L-2018"><span class="linenos">2018</span></a><span class="sd">    ---------</span>
</span><span id="L-2019"><a href="#L-2019"><span class="linenos">2019</span></a><span class="sd">    shaper : [x,y,z] or [x,y]</span>
</span><span id="L-2020"><a href="#L-2020"><span class="linenos">2020</span></a>
</span><span id="L-2021"><a href="#L-2021"><span class="linenos">2021</span></a><span class="sd">    n_levels : int</span>
</span><span id="L-2022"><a href="#L-2022"><span class="linenos">2022</span></a>
</span><span id="L-2023"><a href="#L-2023"><span class="linenos">2023</span></a><span class="sd">    multiply : boolean</span>
</span><span id="L-2024"><a href="#L-2024"><span class="linenos">2024</span></a>
</span><span id="L-2025"><a href="#L-2025"><span class="linenos">2025</span></a><span class="sd">    Returns</span>
</span><span id="L-2026"><a href="#L-2026"><span class="linenos">2026</span></a><span class="sd">    -------</span>
</span><span id="L-2027"><a href="#L-2027"><span class="linenos">2027</span></a>
</span><span id="L-2028"><a href="#L-2028"><span class="linenos">2028</span></a><span class="sd">    ants.image</span>
</span><span id="L-2029"><a href="#L-2029"><span class="linenos">2029</span></a>
</span><span id="L-2030"><a href="#L-2030"><span class="linenos">2030</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-2031"><a href="#L-2031"><span class="linenos">2031</span></a>    <span class="n">img</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">shaper</span> <span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="mi">0</span>
</span><span id="L-2032"><a href="#L-2032"><span class="linenos">2032</span></a>    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_levels</span><span class="p">):</span>
</span><span id="L-2033"><a href="#L-2033"><span class="linenos">2033</span></a>        <span class="n">temp</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">shaper</span> <span class="p">)</span> <span class="p">)</span>
</span><span id="L-2034"><a href="#L-2034"><span class="linenos">2034</span></a>        <span class="n">temp</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">smooth_image</span><span class="p">(</span> <span class="n">temp</span><span class="p">,</span> <span class="n">n_levels</span> <span class="p">)</span>
</span><span id="L-2035"><a href="#L-2035"><span class="linenos">2035</span></a>        <span class="n">temp</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">threshold_image</span><span class="p">(</span> <span class="n">temp</span><span class="p">,</span> <span class="s2">&quot;Otsu&quot;</span><span class="p">,</span> <span class="mi">1</span> <span class="p">)</span>
</span><span id="L-2036"><a href="#L-2036"><span class="linenos">2036</span></a>        <span class="k">if</span> <span class="n">multiply</span><span class="p">:</span>
</span><span id="L-2037"><a href="#L-2037"><span class="linenos">2037</span></a>            <span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span> <span class="o">*</span> <span class="n">k</span>
</span><span id="L-2038"><a href="#L-2038"><span class="linenos">2038</span></a>        <span class="n">img</span> <span class="o">=</span> <span class="n">img</span> <span class="o">+</span> <span class="n">temp</span>
</span><span id="L-2039"><a href="#L-2039"><span class="linenos">2039</span></a>    <span class="k">return</span> <span class="n">img</span>
</span><span id="L-2040"><a href="#L-2040"><span class="linenos">2040</span></a>
</span><span id="L-2041"><a href="#L-2041"><span class="linenos">2041</span></a>
</span><span id="L-2042"><a href="#L-2042"><span class="linenos">2042</span></a><span class="k">def</span> <span class="nf">optimize_upsampling_shape</span><span class="p">(</span> <span class="n">spacing</span><span class="p">,</span> <span class="n">modality</span><span class="o">=</span><span class="s1">&#39;T1&#39;</span><span class="p">,</span> <span class="n">roundit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span> <span class="p">):</span>
</span><span id="L-2043"><a href="#L-2043"><span class="linenos">2043</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2044"><a href="#L-2044"><span class="linenos">2044</span></a><span class="sd">    Compute the optimal upsampling shape string (e.g., &#39;2x2x2&#39;) based on image voxel spacing</span>
</span><span id="L-2045"><a href="#L-2045"><span class="linenos">2045</span></a><span class="sd">    and imaging modality. This output is used to select an appropriate pretrained </span>
</span><span id="L-2046"><a href="#L-2046"><span class="linenos">2046</span></a><span class="sd">    super-resolution model filename.</span>
</span><span id="L-2047"><a href="#L-2047"><span class="linenos">2047</span></a>
</span><span id="L-2048"><a href="#L-2048"><span class="linenos">2048</span></a><span class="sd">    Parameters</span>
</span><span id="L-2049"><a href="#L-2049"><span class="linenos">2049</span></a><span class="sd">    ----------</span>
</span><span id="L-2050"><a href="#L-2050"><span class="linenos">2050</span></a><span class="sd">    spacing : sequence of float</span>
</span><span id="L-2051"><a href="#L-2051"><span class="linenos">2051</span></a><span class="sd">        Voxel spacing (physical size per voxel in mm) from the input image.</span>
</span><span id="L-2052"><a href="#L-2052"><span class="linenos">2052</span></a><span class="sd">        Typically obtained from `ants.get_spacing(image)`.</span>
</span><span id="L-2053"><a href="#L-2053"><span class="linenos">2053</span></a>
</span><span id="L-2054"><a href="#L-2054"><span class="linenos">2054</span></a><span class="sd">    modality : str, optional</span>
</span><span id="L-2055"><a href="#L-2055"><span class="linenos">2055</span></a><span class="sd">        Imaging modality. Affects resolution thresholds:</span>
</span><span id="L-2056"><a href="#L-2056"><span class="linenos">2056</span></a><span class="sd">        - &#39;T1&#39; : anatomical MRI (default minimum spacing: 0.35 mm)</span>
</span><span id="L-2057"><a href="#L-2057"><span class="linenos">2057</span></a><span class="sd">        - &#39;DTI&#39; : diffusion MRI (default minimum spacing: 1.0 mm)</span>
</span><span id="L-2058"><a href="#L-2058"><span class="linenos">2058</span></a><span class="sd">        - &#39;NM&#39; : nuclear medicine (e.g., PET/SPECT, minimum spacing: 0.25 mm)</span>
</span><span id="L-2059"><a href="#L-2059"><span class="linenos">2059</span></a>
</span><span id="L-2060"><a href="#L-2060"><span class="linenos">2060</span></a><span class="sd">    roundit : bool, optional</span>
</span><span id="L-2061"><a href="#L-2061"><span class="linenos">2061</span></a><span class="sd">        If True, uses rounded integer ratios for the upsampling shape.</span>
</span><span id="L-2062"><a href="#L-2062"><span class="linenos">2062</span></a><span class="sd">        Otherwise, uses floor division with constraints.</span>
</span><span id="L-2063"><a href="#L-2063"><span class="linenos">2063</span></a>
</span><span id="L-2064"><a href="#L-2064"><span class="linenos">2064</span></a><span class="sd">    verbose : bool, optional</span>
</span><span id="L-2065"><a href="#L-2065"><span class="linenos">2065</span></a><span class="sd">        If True, prints detailed internal values and logic.</span>
</span><span id="L-2066"><a href="#L-2066"><span class="linenos">2066</span></a>
</span><span id="L-2067"><a href="#L-2067"><span class="linenos">2067</span></a><span class="sd">    Returns</span>
</span><span id="L-2068"><a href="#L-2068"><span class="linenos">2068</span></a><span class="sd">    -------</span>
</span><span id="L-2069"><a href="#L-2069"><span class="linenos">2069</span></a><span class="sd">    str</span>
</span><span id="L-2070"><a href="#L-2070"><span class="linenos">2070</span></a><span class="sd">        Optimal upsampling shape string in the form &#39;AxBxC&#39;,</span>
</span><span id="L-2071"><a href="#L-2071"><span class="linenos">2071</span></a><span class="sd">        e.g., &#39;2x2x2&#39;, &#39;4x4x2&#39;.</span>
</span><span id="L-2072"><a href="#L-2072"><span class="linenos">2072</span></a>
</span><span id="L-2073"><a href="#L-2073"><span class="linenos">2073</span></a><span class="sd">    Notes</span>
</span><span id="L-2074"><a href="#L-2074"><span class="linenos">2074</span></a><span class="sd">    -----</span>
</span><span id="L-2075"><a href="#L-2075"><span class="linenos">2075</span></a><span class="sd">    - The function prevents upsampling ratios that would result in &#39;1x1x1&#39;</span>
</span><span id="L-2076"><a href="#L-2076"><span class="linenos">2076</span></a><span class="sd">      by defaulting to &#39;2x2x2&#39;.</span>
</span><span id="L-2077"><a href="#L-2077"><span class="linenos">2077</span></a><span class="sd">    - It also avoids uncommon ratios like &#39;5&#39; by rounding to the nearest valid option.</span>
</span><span id="L-2078"><a href="#L-2078"><span class="linenos">2078</span></a><span class="sd">    - The returned string is commonly used to populate a model filename template:</span>
</span><span id="L-2079"><a href="#L-2079"><span class="linenos">2079</span></a><span class="sd">      </span>
</span><span id="L-2080"><a href="#L-2080"><span class="linenos">2080</span></a><span class="sd">      Example:</span>
</span><span id="L-2081"><a href="#L-2081"><span class="linenos">2081</span></a><span class="sd">          &gt;&gt;&gt; bestup = optimize_upsampling_shape(ants.get_spacing(t1_img), modality=&#39;T1&#39;)</span>
</span><span id="L-2082"><a href="#L-2082"><span class="linenos">2082</span></a><span class="sd">          &gt;&gt;&gt; model = re.sub(&#39;bestup&#39;, bestup, &#39;siq_smallshort_train_bestup_1chan.keras&#39;)</span>
</span><span id="L-2083"><a href="#L-2083"><span class="linenos">2083</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-2084"><a href="#L-2084"><span class="linenos">2084</span></a>    <span class="n">minspc</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span> <span class="nb">list</span><span class="p">(</span> <span class="n">spacing</span> <span class="p">)</span> <span class="p">)</span>
</span><span id="L-2085"><a href="#L-2085"><span class="linenos">2085</span></a>    <span class="n">maxspc</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span> <span class="nb">list</span><span class="p">(</span> <span class="n">spacing</span> <span class="p">)</span> <span class="p">)</span>
</span><span id="L-2086"><a href="#L-2086"><span class="linenos">2086</span></a>    <span class="n">ratio</span> <span class="o">=</span> <span class="n">maxspc</span><span class="o">/</span><span class="n">minspc</span>
</span><span id="L-2087"><a href="#L-2087"><span class="linenos">2087</span></a>    <span class="k">if</span> <span class="n">ratio</span> <span class="o">==</span> <span class="mf">1.0</span><span class="p">:</span>
</span><span id="L-2088"><a href="#L-2088"><span class="linenos">2088</span></a>        <span class="n">ratio</span> <span class="o">=</span> <span class="mf">0.5</span>
</span><span id="L-2089"><a href="#L-2089"><span class="linenos">2089</span></a>    <span class="n">roundratio</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span> <span class="n">ratio</span> <span class="p">)</span>
</span><span id="L-2090"><a href="#L-2090"><span class="linenos">2090</span></a>    <span class="n">tarshaperaw</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-2091"><a href="#L-2091"><span class="linenos">2091</span></a>    <span class="n">tarshape</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-2092"><a href="#L-2092"><span class="linenos">2092</span></a>    <span class="n">tarshaperound</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-2093"><a href="#L-2093"><span class="linenos">2093</span></a>    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">spacing</span> <span class="p">)</span> <span class="p">):</span>
</span><span id="L-2094"><a href="#L-2094"><span class="linenos">2094</span></a>        <span class="n">locrat</span> <span class="o">=</span> <span class="n">spacing</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">/</span><span class="n">minspc</span>
</span><span id="L-2095"><a href="#L-2095"><span class="linenos">2095</span></a>        <span class="n">newspc</span> <span class="o">=</span> <span class="n">spacing</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">roundratio</span>
</span><span id="L-2096"><a href="#L-2096"><span class="linenos">2096</span></a>        <span class="n">tarshaperaw</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">locrat</span> <span class="p">)</span>
</span><span id="L-2097"><a href="#L-2097"><span class="linenos">2097</span></a>        <span class="k">if</span> <span class="n">modality</span> <span class="o">==</span> <span class="s2">&quot;NM&quot;</span><span class="p">:</span>
</span><span id="L-2098"><a href="#L-2098"><span class="linenos">2098</span></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-2099"><a href="#L-2099"><span class="linenos">2099</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using minspacing: 0.25&quot;</span><span class="p">)</span>
</span><span id="L-2100"><a href="#L-2100"><span class="linenos">2100</span></a>            <span class="k">if</span> <span class="n">newspc</span> <span class="o">&lt;</span> <span class="mf">0.25</span> <span class="p">:</span>
</span><span id="L-2101"><a href="#L-2101"><span class="linenos">2101</span></a>                <span class="n">locrat</span> <span class="o">=</span> <span class="n">spacing</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">/</span><span class="mf">0.25</span>
</span><span id="L-2102"><a href="#L-2102"><span class="linenos">2102</span></a>        <span class="k">elif</span> <span class="n">modality</span> <span class="o">==</span> <span class="s2">&quot;DTI&quot;</span><span class="p">:</span>
</span><span id="L-2103"><a href="#L-2103"><span class="linenos">2103</span></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-2104"><a href="#L-2104"><span class="linenos">2104</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using minspacing: 1.0&quot;</span><span class="p">)</span>
</span><span id="L-2105"><a href="#L-2105"><span class="linenos">2105</span></a>            <span class="k">if</span> <span class="n">newspc</span> <span class="o">&lt;</span> <span class="mf">1.0</span> <span class="p">:</span>
</span><span id="L-2106"><a href="#L-2106"><span class="linenos">2106</span></a>                <span class="n">locrat</span> <span class="o">=</span> <span class="n">spacing</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">/</span><span class="mf">1.0</span>
</span><span id="L-2107"><a href="#L-2107"><span class="linenos">2107</span></a>        <span class="k">else</span><span class="p">:</span> <span class="c1"># assume T1</span>
</span><span id="L-2108"><a href="#L-2108"><span class="linenos">2108</span></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-2109"><a href="#L-2109"><span class="linenos">2109</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using minspacing: 0.35&quot;</span><span class="p">)</span>
</span><span id="L-2110"><a href="#L-2110"><span class="linenos">2110</span></a>            <span class="k">if</span> <span class="n">newspc</span> <span class="o">&lt;</span> <span class="mf">0.35</span> <span class="p">:</span>
</span><span id="L-2111"><a href="#L-2111"><span class="linenos">2111</span></a>                <span class="n">locrat</span> <span class="o">=</span> <span class="n">spacing</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">/</span><span class="mf">0.35</span>
</span><span id="L-2112"><a href="#L-2112"><span class="linenos">2112</span></a>        <span class="n">myint</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">locrat</span> <span class="p">)</span>
</span><span id="L-2113"><a href="#L-2113"><span class="linenos">2113</span></a>        <span class="k">if</span> <span class="p">(</span> <span class="n">myint</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">):</span>
</span><span id="L-2114"><a href="#L-2114"><span class="linenos">2114</span></a>            <span class="n">myint</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-2115"><a href="#L-2115"><span class="linenos">2115</span></a>        <span class="k">if</span> <span class="n">myint</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
</span><span id="L-2116"><a href="#L-2116"><span class="linenos">2116</span></a>            <span class="n">myint</span> <span class="o">=</span> <span class="mi">4</span>
</span><span id="L-2117"><a href="#L-2117"><span class="linenos">2117</span></a>        <span class="k">if</span> <span class="p">(</span> <span class="n">myint</span> <span class="o">&gt;</span> <span class="mi">6</span> <span class="p">):</span>
</span><span id="L-2118"><a href="#L-2118"><span class="linenos">2118</span></a>            <span class="n">myint</span> <span class="o">=</span> <span class="mi">6</span>
</span><span id="L-2119"><a href="#L-2119"><span class="linenos">2119</span></a>        <span class="n">tarshape</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="nb">str</span><span class="p">(</span> <span class="n">myint</span> <span class="p">)</span> <span class="p">)</span>
</span><span id="L-2120"><a href="#L-2120"><span class="linenos">2120</span></a>        <span class="n">tarshaperound</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="nb">str</span><span class="p">(</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span> <span class="n">locrat</span> <span class="p">))</span> <span class="p">)</span> <span class="p">)</span>
</span><span id="L-2121"><a href="#L-2121"><span class="linenos">2121</span></a>    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-2122"><a href="#L-2122"><span class="linenos">2122</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;before emendation:&quot;</span><span class="p">)</span>
</span><span id="L-2123"><a href="#L-2123"><span class="linenos">2123</span></a>        <span class="nb">print</span><span class="p">(</span> <span class="n">tarshaperaw</span> <span class="p">)</span>
</span><span id="L-2124"><a href="#L-2124"><span class="linenos">2124</span></a>        <span class="nb">print</span><span class="p">(</span> <span class="n">tarshaperound</span> <span class="p">)</span>
</span><span id="L-2125"><a href="#L-2125"><span class="linenos">2125</span></a>        <span class="nb">print</span><span class="p">(</span> <span class="n">tarshape</span> <span class="p">)</span>
</span><span id="L-2126"><a href="#L-2126"><span class="linenos">2126</span></a>    <span class="n">allone</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-2127"><a href="#L-2127"><span class="linenos">2127</span></a>    <span class="k">if</span> <span class="n">roundit</span><span class="p">:</span>
</span><span id="L-2128"><a href="#L-2128"><span class="linenos">2128</span></a>        <span class="n">tarshape</span> <span class="o">=</span> <span class="n">tarshaperound</span>
</span><span id="L-2129"><a href="#L-2129"><span class="linenos">2129</span></a>    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">tarshape</span> <span class="p">)</span> <span class="p">):</span>
</span><span id="L-2130"><a href="#L-2130"><span class="linenos">2130</span></a>        <span class="k">if</span> <span class="n">tarshape</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;1&quot;</span><span class="p">:</span>
</span><span id="L-2131"><a href="#L-2131"><span class="linenos">2131</span></a>            <span class="n">allone</span><span class="o">=</span><span class="kc">False</span>
</span><span id="L-2132"><a href="#L-2132"><span class="linenos">2132</span></a>    <span class="k">if</span> <span class="n">allone</span><span class="p">:</span>
</span><span id="L-2133"><a href="#L-2133"><span class="linenos">2133</span></a>        <span class="n">tarshape</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;2&quot;</span><span class="p">,</span><span class="s2">&quot;2&quot;</span><span class="p">,</span><span class="s2">&quot;2&quot;</span><span class="p">]</span> <span class="c1"># default</span>
</span><span id="L-2134"><a href="#L-2134"><span class="linenos">2134</span></a>    <span class="k">return</span> <span class="s2">&quot;x&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tarshape</span><span class="p">)</span>
</span><span id="L-2135"><a href="#L-2135"><span class="linenos">2135</span></a>
</span><span id="L-2136"><a href="#L-2136"><span class="linenos">2136</span></a><span class="k">def</span> <span class="nf">compare_models</span><span class="p">(</span> <span class="n">model_filenames</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">n_classes</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
</span><span id="L-2137"><a href="#L-2137"><span class="linenos">2137</span></a>    <span class="n">poly_order</span><span class="o">=</span><span class="s1">&#39;hist&#39;</span><span class="p">,</span>
</span><span id="L-2138"><a href="#L-2138"><span class="linenos">2138</span></a>    <span class="n">identifier</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">noise_sd</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span> <span class="p">):</span>
</span><span id="L-2139"><a href="#L-2139"><span class="linenos">2139</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2140"><a href="#L-2140"><span class="linenos">2140</span></a><span class="sd">    Evaluates and compares the performance of multiple super-resolution models on a given image.</span>
</span><span id="L-2141"><a href="#L-2141"><span class="linenos">2141</span></a>
</span><span id="L-2142"><a href="#L-2142"><span class="linenos">2142</span></a><span class="sd">    This function provides a standardized way to benchmark SR models. For each model,</span>
</span><span id="L-2143"><a href="#L-2143"><span class="linenos">2143</span></a><span class="sd">    it performs the following steps:</span>
</span><span id="L-2144"><a href="#L-2144"><span class="linenos">2144</span></a><span class="sd">    1. Loads the model and determines its upsampling factor.</span>
</span><span id="L-2145"><a href="#L-2145"><span class="linenos">2145</span></a><span class="sd">    2. Downsamples the high-resolution input image (`img`) to create a low-resolution</span>
</span><span id="L-2146"><a href="#L-2146"><span class="linenos">2146</span></a><span class="sd">       input, simulating a real-world scenario.</span>
</span><span id="L-2147"><a href="#L-2147"><span class="linenos">2147</span></a><span class="sd">    3. Adds Gaussian noise to the low-resolution input to test for robustness.</span>
</span><span id="L-2148"><a href="#L-2148"><span class="linenos">2148</span></a><span class="sd">    4. Runs inference using the model to generate a super-resolved output.</span>
</span><span id="L-2149"><a href="#L-2149"><span class="linenos">2149</span></a><span class="sd">    5. Generates a baseline output by upsampling the low-res input with linear interpolation.</span>
</span><span id="L-2150"><a href="#L-2150"><span class="linenos">2150</span></a><span class="sd">    6. Calculates PSNR and SSIM metrics comparing both the model&#39;s output and the</span>
</span><span id="L-2151"><a href="#L-2151"><span class="linenos">2151</span></a><span class="sd">       baseline against the original high-resolution image.</span>
</span><span id="L-2152"><a href="#L-2152"><span class="linenos">2152</span></a><span class="sd">    7. If a dual-channel (image + segmentation) model is detected, it also calculates</span>
</span><span id="L-2153"><a href="#L-2153"><span class="linenos">2153</span></a><span class="sd">       Dice scores for segmentation performance.</span>
</span><span id="L-2154"><a href="#L-2154"><span class="linenos">2154</span></a><span class="sd">    8. Aggregates all results into a pandas DataFrame for easy comparison.</span>
</span><span id="L-2155"><a href="#L-2155"><span class="linenos">2155</span></a>
</span><span id="L-2156"><a href="#L-2156"><span class="linenos">2156</span></a><span class="sd">    Parameters</span>
</span><span id="L-2157"><a href="#L-2157"><span class="linenos">2157</span></a><span class="sd">    ----------</span>
</span><span id="L-2158"><a href="#L-2158"><span class="linenos">2158</span></a><span class="sd">    model_filenames : list of str</span>
</span><span id="L-2159"><a href="#L-2159"><span class="linenos">2159</span></a><span class="sd">        A list of file paths to the Keras models (.h5, .keras) to be compared.</span>
</span><span id="L-2160"><a href="#L-2160"><span class="linenos">2160</span></a><span class="sd">    img : ants.ANTsImage</span>
</span><span id="L-2161"><a href="#L-2161"><span class="linenos">2161</span></a><span class="sd">        The high-resolution ground truth image. This image will be downsampled to</span>
</span><span id="L-2162"><a href="#L-2162"><span class="linenos">2162</span></a><span class="sd">        create the input for the models.</span>
</span><span id="L-2163"><a href="#L-2163"><span class="linenos">2163</span></a><span class="sd">    n_classes : int, optional</span>
</span><span id="L-2164"><a href="#L-2164"><span class="linenos">2164</span></a><span class="sd">        The number of classes for Otsu&#39;s thresholding when auto-generating a</span>
</span><span id="L-2165"><a href="#L-2165"><span class="linenos">2165</span></a><span class="sd">        segmentation for evaluating dual-channel models. Default is 3.</span>
</span><span id="L-2166"><a href="#L-2166"><span class="linenos">2166</span></a><span class="sd">    poly_order : str or int, optional</span>
</span><span id="L-2167"><a href="#L-2167"><span class="linenos">2167</span></a><span class="sd">        Method for intensity matching between the SR output and the reference.</span>
</span><span id="L-2168"><a href="#L-2168"><span class="linenos">2168</span></a><span class="sd">        Options: &#39;hist&#39; for histogram matching (default), an integer for</span>
</span><span id="L-2169"><a href="#L-2169"><span class="linenos">2169</span></a><span class="sd">        polynomial regression, or None to disable.</span>
</span><span id="L-2170"><a href="#L-2170"><span class="linenos">2170</span></a><span class="sd">    identifier : str, optional</span>
</span><span id="L-2171"><a href="#L-2171"><span class="linenos">2171</span></a><span class="sd">        A custom identifier for the output DataFrame. If None, it is inferred</span>
</span><span id="L-2172"><a href="#L-2172"><span class="linenos">2172</span></a><span class="sd">        from the model filename. Default is None.</span>
</span><span id="L-2173"><a href="#L-2173"><span class="linenos">2173</span></a><span class="sd">    noise_sd : float, optional</span>
</span><span id="L-2174"><a href="#L-2174"><span class="linenos">2174</span></a><span class="sd">        Standard deviation of the additive Gaussian noise applied to the</span>
</span><span id="L-2175"><a href="#L-2175"><span class="linenos">2175</span></a><span class="sd">        downsampled image before inference. Default is 0.1.</span>
</span><span id="L-2176"><a href="#L-2176"><span class="linenos">2176</span></a><span class="sd">    verbose : bool, optional</span>
</span><span id="L-2177"><a href="#L-2177"><span class="linenos">2177</span></a><span class="sd">        If True, prints detailed progress and intermediate values. Default is False.</span>
</span><span id="L-2178"><a href="#L-2178"><span class="linenos">2178</span></a>
</span><span id="L-2179"><a href="#L-2179"><span class="linenos">2179</span></a><span class="sd">    Returns</span>
</span><span id="L-2180"><a href="#L-2180"><span class="linenos">2180</span></a><span class="sd">    -------</span>
</span><span id="L-2181"><a href="#L-2181"><span class="linenos">2181</span></a><span class="sd">    pd.DataFrame</span>
</span><span id="L-2182"><a href="#L-2182"><span class="linenos">2182</span></a><span class="sd">        A DataFrame where each row corresponds to a model. Columns contain evaluation</span>
</span><span id="L-2183"><a href="#L-2183"><span class="linenos">2183</span></a><span class="sd">        metrics (PSNR.SR, SSIM.SR, DICE.SR), baseline metrics (PSNR.LIN, SSIM.LIN,</span>
</span><span id="L-2184"><a href="#L-2184"><span class="linenos">2184</span></a><span class="sd">        DICE.NN), and metadata.</span>
</span><span id="L-2185"><a href="#L-2185"><span class="linenos">2185</span></a>
</span><span id="L-2186"><a href="#L-2186"><span class="linenos">2186</span></a><span class="sd">    Notes</span>
</span><span id="L-2187"><a href="#L-2187"><span class="linenos">2187</span></a><span class="sd">    -----</span>
</span><span id="L-2188"><a href="#L-2188"><span class="linenos">2188</span></a><span class="sd">    When evaluating a 2-channel (segmentation) model, the primary metric for the</span>
</span><span id="L-2189"><a href="#L-2189"><span class="linenos">2189</span></a><span class="sd">    segmentation task is the Dice score (`DICE.SR`). The intensity metrics (PSNR, SSIM)</span>
</span><span id="L-2190"><a href="#L-2190"><span class="linenos">2190</span></a><span class="sd">    are still computed on the first channel.</span>
</span><span id="L-2191"><a href="#L-2191"><span class="linenos">2191</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-2192"><a href="#L-2192"><span class="linenos">2192</span></a>    <span class="n">padding</span><span class="o">=</span><span class="mi">4</span>
</span><span id="L-2193"><a href="#L-2193"><span class="linenos">2193</span></a>    <span class="n">mydf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
</span><span id="L-2194"><a href="#L-2194"><span class="linenos">2194</span></a>    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">model_filenames</span> <span class="p">)</span> <span class="p">):</span>
</span><span id="L-2195"><a href="#L-2195"><span class="linenos">2195</span></a>        <span class="n">srmdl</span><span class="p">,</span> <span class="n">upshape</span> <span class="o">=</span> <span class="n">read_srmodel</span><span class="p">(</span> <span class="n">model_filenames</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="p">)</span>
</span><span id="L-2196"><a href="#L-2196"><span class="linenos">2196</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-2197"><a href="#L-2197"><span class="linenos">2197</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="n">model_filenames</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="p">)</span>
</span><span id="L-2198"><a href="#L-2198"><span class="linenos">2198</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="n">upshape</span> <span class="p">)</span>
</span><span id="L-2199"><a href="#L-2199"><span class="linenos">2199</span></a>        <span class="n">tarshape</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-2200"><a href="#L-2200"><span class="linenos">2200</span></a>        <span class="n">inspc</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">get_spacing</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
</span><span id="L-2201"><a href="#L-2201"><span class="linenos">2201</span></a>        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">)):</span>
</span><span id="L-2202"><a href="#L-2202"><span class="linenos">2202</span></a>            <span class="n">tarshape</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="nb">float</span><span class="p">(</span><span class="n">upshape</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">*</span> <span class="n">inspc</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="p">)</span>
</span><span id="L-2203"><a href="#L-2203"><span class="linenos">2203</span></a>        <span class="c1"># uses linear interp</span>
</span><span id="L-2204"><a href="#L-2204"><span class="linenos">2204</span></a>        <span class="n">dimg</span><span class="o">=</span><span class="n">ants</span><span class="o">.</span><span class="n">resample_image</span><span class="p">(</span> <span class="n">img</span><span class="p">,</span> <span class="n">tarshape</span><span class="p">,</span> <span class="n">use_voxels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">interp_type</span><span class="o">=</span><span class="mi">0</span> <span class="p">)</span>
</span><span id="L-2205"><a href="#L-2205"><span class="linenos">2205</span></a>        <span class="n">dimg</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">add_noise_to_image</span><span class="p">(</span> <span class="n">dimg</span><span class="p">,</span><span class="s1">&#39;additivegaussian&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">noise_sd</span><span class="p">]</span> <span class="p">)</span>
</span><span id="L-2206"><a href="#L-2206"><span class="linenos">2206</span></a>        <span class="kn">import</span> <span class="nn">math</span>
</span><span id="L-2207"><a href="#L-2207"><span class="linenos">2207</span></a>        <span class="n">dicesr</span><span class="o">=</span><span class="n">math</span><span class="o">.</span><span class="n">nan</span>
</span><span id="L-2208"><a href="#L-2208"><span class="linenos">2208</span></a>        <span class="n">dicenn</span><span class="o">=</span><span class="n">math</span><span class="o">.</span><span class="n">nan</span>
</span><span id="L-2209"><a href="#L-2209"><span class="linenos">2209</span></a>        <span class="k">if</span> <span class="n">upshape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-2210"><a href="#L-2210"><span class="linenos">2210</span></a>            <span class="n">seghigh</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">threshold_image</span><span class="p">(</span> <span class="n">img</span><span class="p">,</span><span class="s2">&quot;Otsu&quot;</span><span class="p">,</span><span class="n">n_classes</span><span class="p">)</span>
</span><span id="L-2211"><a href="#L-2211"><span class="linenos">2211</span></a>            <span class="n">seglow</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">resample_image</span><span class="p">(</span> <span class="n">seghigh</span><span class="p">,</span> <span class="n">tarshape</span><span class="p">,</span> <span class="n">use_voxels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">interp_type</span><span class="o">=</span><span class="mi">1</span> <span class="p">)</span>
</span><span id="L-2212"><a href="#L-2212"><span class="linenos">2212</span></a>            <span class="n">dimgup</span><span class="o">=</span><span class="n">inference</span><span class="p">(</span> <span class="n">dimg</span><span class="p">,</span> <span class="n">srmdl</span><span class="p">,</span> <span class="n">segmentation</span> <span class="o">=</span> <span class="n">seglow</span><span class="p">,</span> <span class="n">poly_order</span><span class="o">=</span><span class="n">poly_order</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span> <span class="p">)</span>
</span><span id="L-2213"><a href="#L-2213"><span class="linenos">2213</span></a>            <span class="n">dimgupseg</span> <span class="o">=</span> <span class="n">dimgup</span><span class="p">[</span><span class="s1">&#39;super_resolution_segmentation&#39;</span><span class="p">]</span>
</span><span id="L-2214"><a href="#L-2214"><span class="linenos">2214</span></a>            <span class="n">dimgup</span> <span class="o">=</span> <span class="n">dimgup</span><span class="p">[</span><span class="s1">&#39;super_resolution&#39;</span><span class="p">]</span>
</span><span id="L-2215"><a href="#L-2215"><span class="linenos">2215</span></a>            <span class="n">segblock</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">resample_image_to_target</span><span class="p">(</span> <span class="n">seghigh</span><span class="p">,</span> <span class="n">dimgupseg</span><span class="p">,</span> <span class="n">interp_type</span><span class="o">=</span><span class="s1">&#39;nearestNeighbor&#39;</span>  <span class="p">)</span>
</span><span id="L-2216"><a href="#L-2216"><span class="linenos">2216</span></a>            <span class="n">segimgnn</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">resample_image_to_target</span><span class="p">(</span> <span class="n">seglow</span><span class="p">,</span> <span class="n">dimgupseg</span><span class="p">,</span> <span class="n">interp_type</span><span class="o">=</span><span class="s1">&#39;nearestNeighbor&#39;</span> <span class="p">)</span>
</span><span id="L-2217"><a href="#L-2217"><span class="linenos">2217</span></a>            <span class="n">segblock</span><span class="p">[</span> <span class="n">dimgupseg</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-2218"><a href="#L-2218"><span class="linenos">2218</span></a>            <span class="n">segimgnn</span><span class="p">[</span> <span class="n">dimgupseg</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-2219"><a href="#L-2219"><span class="linenos">2219</span></a>            <span class="n">dicenn</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">label_overlap_measures</span><span class="p">(</span><span class="n">segblock</span><span class="p">,</span> <span class="n">segimgnn</span><span class="p">)[</span><span class="s1">&#39;MeanOverlap&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-2220"><a href="#L-2220"><span class="linenos">2220</span></a>            <span class="n">dicesr</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">label_overlap_measures</span><span class="p">(</span><span class="n">segblock</span><span class="p">,</span> <span class="n">dimgupseg</span><span class="p">)[</span><span class="s1">&#39;MeanOverlap&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-2221"><a href="#L-2221"><span class="linenos">2221</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-2222"><a href="#L-2222"><span class="linenos">2222</span></a>            <span class="n">dimgup</span><span class="o">=</span><span class="n">inference</span><span class="p">(</span> <span class="n">dimg</span><span class="p">,</span> <span class="n">srmdl</span><span class="p">,</span> <span class="n">poly_order</span><span class="o">=</span><span class="n">poly_order</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span> <span class="p">)</span>
</span><span id="L-2223"><a href="#L-2223"><span class="linenos">2223</span></a>        <span class="n">dimglin</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">resample_image_to_target</span><span class="p">(</span> <span class="n">dimg</span><span class="p">,</span> <span class="n">dimgup</span><span class="p">,</span> <span class="n">interp_type</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span> <span class="p">)</span>
</span><span id="L-2224"><a href="#L-2224"><span class="linenos">2224</span></a>        <span class="n">imgblock</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">resample_image_to_target</span><span class="p">(</span> <span class="n">img</span><span class="p">,</span> <span class="n">dimgup</span><span class="p">,</span> <span class="n">interp_type</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span>  <span class="p">)</span>
</span><span id="L-2225"><a href="#L-2225"><span class="linenos">2225</span></a>        <span class="n">dimgup</span><span class="p">[</span> <span class="n">imgblock</span> <span class="o">==</span> <span class="mf">0.0</span> <span class="p">]</span><span class="o">=</span><span class="mf">0.0</span>
</span><span id="L-2226"><a href="#L-2226"><span class="linenos">2226</span></a>        <span class="n">dimglin</span><span class="p">[</span> <span class="n">imgblock</span> <span class="o">==</span> <span class="mf">0.0</span> <span class="p">]</span><span class="o">=</span><span class="mf">0.0</span>
</span><span id="L-2227"><a href="#L-2227"><span class="linenos">2227</span></a>        <span class="n">padder</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-2228"><a href="#L-2228"><span class="linenos">2228</span></a>        <span class="n">dimwarning</span><span class="o">=</span><span class="kc">False</span>
</span><span id="L-2229"><a href="#L-2229"><span class="linenos">2229</span></a>        <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">dimension</span><span class="p">):</span>
</span><span id="L-2230"><a href="#L-2230"><span class="linenos">2230</span></a>            <span class="n">padder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">padding</span> <span class="p">)</span>
</span><span id="L-2231"><a href="#L-2231"><span class="linenos">2231</span></a>            <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span> <span class="o">!=</span> <span class="n">imgblock</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">jj</span><span class="p">]:</span>
</span><span id="L-2232"><a href="#L-2232"><span class="linenos">2232</span></a>                <span class="n">dimwarning</span><span class="o">=</span><span class="kc">True</span>
</span><span id="L-2233"><a href="#L-2233"><span class="linenos">2233</span></a>        <span class="k">if</span> <span class="n">dimwarning</span><span class="p">:</span>
</span><span id="L-2234"><a href="#L-2234"><span class="linenos">2234</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;NOTE: dimensions of downsampled to upsampled image do not match!!!&quot;</span><span class="p">)</span>
</span><span id="L-2235"><a href="#L-2235"><span class="linenos">2235</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;we force them to match but this suggests results may not be reliable.&quot;</span><span class="p">)</span>
</span><span id="L-2236"><a href="#L-2236"><span class="linenos">2236</span></a>        <span class="n">temp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span> <span class="n">model_filenames</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="p">)</span>
</span><span id="L-2237"><a href="#L-2237"><span class="linenos">2237</span></a>        <span class="n">temp</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span> <span class="s2">&quot;siq_default_sisr_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">temp</span> <span class="p">)</span>
</span><span id="L-2238"><a href="#L-2238"><span class="linenos">2238</span></a>        <span class="n">temp</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span> <span class="s2">&quot;_best_mdl.keras&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">temp</span> <span class="p">)</span>
</span><span id="L-2239"><a href="#L-2239"><span class="linenos">2239</span></a>        <span class="n">temp</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span> <span class="s2">&quot;_best_mdl.h5&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">temp</span> <span class="p">)</span>
</span><span id="L-2240"><a href="#L-2240"><span class="linenos">2240</span></a>        <span class="k">if</span> <span class="n">verbose</span> <span class="ow">and</span> <span class="n">dimwarning</span><span class="p">:</span>
</span><span id="L-2241"><a href="#L-2241"><span class="linenos">2241</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;original img shape&quot;</span> <span class="p">)</span>
</span><span id="L-2242"><a href="#L-2242"><span class="linenos">2242</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span> <span class="p">)</span>
</span><span id="L-2243"><a href="#L-2243"><span class="linenos">2243</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;resampled img shape&quot;</span> <span class="p">)</span>
</span><span id="L-2244"><a href="#L-2244"><span class="linenos">2244</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="n">imgblock</span><span class="o">.</span><span class="n">shape</span> <span class="p">)</span>
</span><span id="L-2245"><a href="#L-2245"><span class="linenos">2245</span></a>        <span class="n">a</span><span class="o">=</span><span class="p">[]</span>
</span><span id="L-2246"><a href="#L-2246"><span class="linenos">2246</span></a>        <span class="n">imgshape</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-2247"><a href="#L-2247"><span class="linenos">2247</span></a>        <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">upshape</span><span class="p">)):</span>
</span><span id="L-2248"><a href="#L-2248"><span class="linenos">2248</span></a>            <span class="n">a</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="nb">str</span><span class="p">(</span><span class="n">upshape</span><span class="p">[</span><span class="n">aa</span><span class="p">])</span> <span class="p">)</span>
</span><span id="L-2249"><a href="#L-2249"><span class="linenos">2249</span></a>            <span class="k">if</span> <span class="n">aa</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">imgblock</span><span class="o">.</span><span class="n">shape</span><span class="p">):</span>
</span><span id="L-2250"><a href="#L-2250"><span class="linenos">2250</span></a>                <span class="n">imgshape</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="nb">str</span><span class="p">(</span> <span class="n">imgblock</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">aa</span><span class="p">]</span> <span class="p">)</span> <span class="p">)</span>
</span><span id="L-2251"><a href="#L-2251"><span class="linenos">2251</span></a>        <span class="k">if</span> <span class="n">identifier</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-2252"><a href="#L-2252"><span class="linenos">2252</span></a>            <span class="n">identifier</span><span class="o">=</span><span class="n">temp</span>
</span><span id="L-2253"><a href="#L-2253"><span class="linenos">2253</span></a>        <span class="n">mydict</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-2254"><a href="#L-2254"><span class="linenos">2254</span></a>            <span class="s2">&quot;identifier&quot;</span><span class="p">:</span><span class="n">identifier</span><span class="p">,</span>
</span><span id="L-2255"><a href="#L-2255"><span class="linenos">2255</span></a>            <span class="s2">&quot;imgshape&quot;</span><span class="p">:</span><span class="s2">&quot;x&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">imgshape</span><span class="p">),</span>
</span><span id="L-2256"><a href="#L-2256"><span class="linenos">2256</span></a>            <span class="s2">&quot;mdl&quot;</span><span class="p">:</span> <span class="n">temp</span><span class="p">,</span>
</span><span id="L-2257"><a href="#L-2257"><span class="linenos">2257</span></a>            <span class="s2">&quot;mdlshape&quot;</span><span class="p">:</span><span class="s2">&quot;x&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">a</span><span class="p">),</span>
</span><span id="L-2258"><a href="#L-2258"><span class="linenos">2258</span></a>            <span class="s2">&quot;PSNR.LIN&quot;</span><span class="p">:</span> <span class="n">antspynet</span><span class="o">.</span><span class="n">psnr</span><span class="p">(</span> <span class="n">imgblock</span><span class="p">,</span> <span class="n">dimglin</span> <span class="p">),</span>
</span><span id="L-2259"><a href="#L-2259"><span class="linenos">2259</span></a>            <span class="s2">&quot;PSNR.SR&quot;</span><span class="p">:</span> <span class="n">antspynet</span><span class="o">.</span><span class="n">psnr</span><span class="p">(</span> <span class="n">imgblock</span><span class="p">,</span> <span class="n">dimgup</span> <span class="p">),</span>
</span><span id="L-2260"><a href="#L-2260"><span class="linenos">2260</span></a>            <span class="s2">&quot;SSIM.LIN&quot;</span><span class="p">:</span> <span class="n">antspynet</span><span class="o">.</span><span class="n">ssim</span><span class="p">(</span> <span class="n">imgblock</span><span class="p">,</span> <span class="n">dimglin</span> <span class="p">),</span>
</span><span id="L-2261"><a href="#L-2261"><span class="linenos">2261</span></a>            <span class="s2">&quot;SSIM.SR&quot;</span><span class="p">:</span> <span class="n">antspynet</span><span class="o">.</span><span class="n">ssim</span><span class="p">(</span> <span class="n">imgblock</span><span class="p">,</span> <span class="n">dimgup</span> <span class="p">),</span>
</span><span id="L-2262"><a href="#L-2262"><span class="linenos">2262</span></a>            <span class="s2">&quot;DICE.NN&quot;</span><span class="p">:</span> <span class="n">dicenn</span><span class="p">,</span>
</span><span id="L-2263"><a href="#L-2263"><span class="linenos">2263</span></a>            <span class="s2">&quot;DICE.SR&quot;</span><span class="p">:</span> <span class="n">dicesr</span><span class="p">,</span>
</span><span id="L-2264"><a href="#L-2264"><span class="linenos">2264</span></a>            <span class="s2">&quot;dimwarning&quot;</span><span class="p">:</span> <span class="n">dimwarning</span> <span class="p">}</span>
</span><span id="L-2265"><a href="#L-2265"><span class="linenos">2265</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-2266"><a href="#L-2266"><span class="linenos">2266</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="n">mydict</span> <span class="p">)</span>
</span><span id="L-2267"><a href="#L-2267"><span class="linenos">2267</span></a>        <span class="n">temp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">(</span> <span class="p">[</span><span class="n">mydict</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span>
</span><span id="L-2268"><a href="#L-2268"><span class="linenos">2268</span></a>        <span class="n">mydf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span> <span class="p">[</span><span class="n">mydf</span><span class="p">,</span><span class="n">temp</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span> <span class="p">)</span>
</span><span id="L-2269"><a href="#L-2269"><span class="linenos">2269</span></a>        <span class="c1"># end loop</span>
</span><span id="L-2270"><a href="#L-2270"><span class="linenos">2270</span></a>    <span class="k">return</span> <span class="n">mydf</span>
</span><span id="L-2271"><a href="#L-2271"><span class="linenos">2271</span></a>
</span><span id="L-2272"><a href="#L-2272"><span class="linenos">2272</span></a>
</span><span id="L-2273"><a href="#L-2273"><span class="linenos">2273</span></a>
</span><span id="L-2274"><a href="#L-2274"><span class="linenos">2274</span></a>
</span><span id="L-2275"><a href="#L-2275"><span class="linenos">2275</span></a><span class="k">def</span> <span class="nf">region_wise_super_resolution</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">super_res_model</span><span class="p">,</span> <span class="n">dilation_amount</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-2276"><a href="#L-2276"><span class="linenos">2276</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2277"><a href="#L-2277"><span class="linenos">2277</span></a><span class="sd">    Apply super-resolution model to each labeled region in the mask independently.</span>
</span><span id="L-2278"><a href="#L-2278"><span class="linenos">2278</span></a>
</span><span id="L-2279"><a href="#L-2279"><span class="linenos">2279</span></a><span class="sd">    Arguments</span>
</span><span id="L-2280"><a href="#L-2280"><span class="linenos">2280</span></a><span class="sd">    ---------</span>
</span><span id="L-2281"><a href="#L-2281"><span class="linenos">2281</span></a><span class="sd">    image : ANTsImage</span>
</span><span id="L-2282"><a href="#L-2282"><span class="linenos">2282</span></a><span class="sd">        Input image.</span>
</span><span id="L-2283"><a href="#L-2283"><span class="linenos">2283</span></a>
</span><span id="L-2284"><a href="#L-2284"><span class="linenos">2284</span></a><span class="sd">    mask : ANTsImage</span>
</span><span id="L-2285"><a href="#L-2285"><span class="linenos">2285</span></a><span class="sd">        Integer-labeled segmentation mask with non-zero regions to upsample.</span>
</span><span id="L-2286"><a href="#L-2286"><span class="linenos">2286</span></a>
</span><span id="L-2287"><a href="#L-2287"><span class="linenos">2287</span></a><span class="sd">    super_res_model : tf.keras.Model</span>
</span><span id="L-2288"><a href="#L-2288"><span class="linenos">2288</span></a><span class="sd">        Trained super-resolution model.</span>
</span><span id="L-2289"><a href="#L-2289"><span class="linenos">2289</span></a>
</span><span id="L-2290"><a href="#L-2290"><span class="linenos">2290</span></a><span class="sd">    dilation_amount : int</span>
</span><span id="L-2291"><a href="#L-2291"><span class="linenos">2291</span></a><span class="sd">        Number of morphological dilations applied to each label region before cropping.</span>
</span><span id="L-2292"><a href="#L-2292"><span class="linenos">2292</span></a>
</span><span id="L-2293"><a href="#L-2293"><span class="linenos">2293</span></a><span class="sd">    verbose : bool</span>
</span><span id="L-2294"><a href="#L-2294"><span class="linenos">2294</span></a><span class="sd">        If True, print detailed status.</span>
</span><span id="L-2295"><a href="#L-2295"><span class="linenos">2295</span></a>
</span><span id="L-2296"><a href="#L-2296"><span class="linenos">2296</span></a><span class="sd">    Returns</span>
</span><span id="L-2297"><a href="#L-2297"><span class="linenos">2297</span></a><span class="sd">    -------</span>
</span><span id="L-2298"><a href="#L-2298"><span class="linenos">2298</span></a><span class="sd">    ANTsImage : Full-size super-resolved image with per-label inference and stitching.</span>
</span><span id="L-2299"><a href="#L-2299"><span class="linenos">2299</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-2300"><a href="#L-2300"><span class="linenos">2300</span></a>    <span class="kn">import</span> <span class="nn">ants</span>
</span><span id="L-2301"><a href="#L-2301"><span class="linenos">2301</span></a>    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span><span id="L-2302"><a href="#L-2302"><span class="linenos">2302</span></a>    <span class="kn">from</span> <span class="nn">antspynet</span> <span class="kn">import</span> <span class="n">apply_super_resolution_model_to_image</span>
</span><span id="L-2303"><a href="#L-2303"><span class="linenos">2303</span></a>
</span><span id="L-2304"><a href="#L-2304"><span class="linenos">2304</span></a>    <span class="n">upFactor</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-2305"><a href="#L-2305"><span class="linenos">2305</span></a>    <span class="n">input_shape</span> <span class="o">=</span> <span class="n">super_res_model</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
</span><span id="L-2306"><a href="#L-2306"><span class="linenos">2306</span></a>    <span class="n">test_shape</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span> <span class="k">else</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="L-2307"><a href="#L-2307"><span class="linenos">2307</span></a>    <span class="n">test_input</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">test_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-2308"><a href="#L-2308"><span class="linenos">2308</span></a>    <span class="n">test_output</span> <span class="o">=</span> <span class="n">super_res_model</span><span class="p">(</span><span class="n">test_input</span><span class="p">)</span>
</span><span id="L-2309"><a href="#L-2309"><span class="linenos">2309</span></a>
</span><span id="L-2310"><a href="#L-2310"><span class="linenos">2310</span></a>    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">test_shape</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">):</span>  <span class="c1"># ignore batch + channel</span>
</span><span id="L-2311"><a href="#L-2311"><span class="linenos">2311</span></a>        <span class="n">upFactor</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">test_output</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">test_input</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]))</span>
</span><span id="L-2312"><a href="#L-2312"><span class="linenos">2312</span></a>
</span><span id="L-2313"><a href="#L-2313"><span class="linenos">2313</span></a>    <span class="n">original_size</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">shape</span>  <span class="c1"># e.g., (x, y, z)</span>
</span><span id="L-2314"><a href="#L-2314"><span class="linenos">2314</span></a>    <span class="n">new_size</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">s</span> <span class="o">*</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">original_size</span><span class="p">,</span> <span class="n">upFactor</span><span class="p">))</span>
</span><span id="L-2315"><a href="#L-2315"><span class="linenos">2315</span></a>    <span class="n">upsampled_mask</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">resample_image</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">new_size</span><span class="p">,</span> <span class="n">use_voxels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">interp_type</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-2316"><a href="#L-2316"><span class="linenos">2316</span></a>    <span class="n">upsampled_image</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">resample_image</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">new_size</span><span class="p">,</span> <span class="n">use_voxels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">interp_type</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-2317"><a href="#L-2317"><span class="linenos">2317</span></a>
</span><span id="L-2318"><a href="#L-2318"><span class="linenos">2318</span></a>    <span class="n">unique_labels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">upsampled_mask</span><span class="o">.</span><span class="n">numpy</span><span class="p">()))</span>
</span><span id="L-2319"><a href="#L-2319"><span class="linenos">2319</span></a>    <span class="k">if</span> <span class="mi">0</span> <span class="ow">in</span> <span class="n">unique_labels</span><span class="p">:</span>
</span><span id="L-2320"><a href="#L-2320"><span class="linenos">2320</span></a>        <span class="n">unique_labels</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-2321"><a href="#L-2321"><span class="linenos">2321</span></a>
</span><span id="L-2322"><a href="#L-2322"><span class="linenos">2322</span></a>    <span class="n">outimg</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">image_clone</span><span class="p">(</span><span class="n">upsampled_image</span><span class="p">)</span>
</span><span id="L-2323"><a href="#L-2323"><span class="linenos">2323</span></a>
</span><span id="L-2324"><a href="#L-2324"><span class="linenos">2324</span></a>    <span class="k">for</span> <span class="n">lab</span> <span class="ow">in</span> <span class="n">unique_labels</span><span class="p">:</span>
</span><span id="L-2325"><a href="#L-2325"><span class="linenos">2325</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-2326"><a href="#L-2326"><span class="linenos">2326</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing label: </span><span class="si">{</span><span class="n">lab</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-2327"><a href="#L-2327"><span class="linenos">2327</span></a>        <span class="n">regionmask</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">threshold_image</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">lab</span><span class="p">,</span> <span class="n">lab</span><span class="p">)</span><span class="o">.</span><span class="n">iMath</span><span class="p">(</span><span class="s2">&quot;MD&quot;</span><span class="p">,</span> <span class="n">dilation_amount</span><span class="p">)</span>
</span><span id="L-2328"><a href="#L-2328"><span class="linenos">2328</span></a>        <span class="n">cropped</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">crop_image</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">regionmask</span><span class="p">)</span>
</span><span id="L-2329"><a href="#L-2329"><span class="linenos">2329</span></a>        <span class="k">if</span> <span class="n">cropped</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-2330"><a href="#L-2330"><span class="linenos">2330</span></a>            <span class="k">continue</span>
</span><span id="L-2331"><a href="#L-2331"><span class="linenos">2331</span></a>        <span class="n">subimgsr</span> <span class="o">=</span> <span class="n">apply_super_resolution_model_to_image</span><span class="p">(</span>
</span><span id="L-2332"><a href="#L-2332"><span class="linenos">2332</span></a>            <span class="n">cropped</span><span class="p">,</span> <span class="n">super_res_model</span><span class="p">,</span> <span class="n">target_range</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span>
</span><span id="L-2333"><a href="#L-2333"><span class="linenos">2333</span></a>        <span class="p">)</span>
</span><span id="L-2334"><a href="#L-2334"><span class="linenos">2334</span></a>        <span class="n">stitched</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">decrop_image</span><span class="p">(</span><span class="n">subimgsr</span><span class="p">,</span> <span class="n">outimg</span><span class="p">)</span>
</span><span id="L-2335"><a href="#L-2335"><span class="linenos">2335</span></a>        <span class="n">outimg</span><span class="p">[</span><span class="n">upsampled_mask</span> <span class="o">==</span> <span class="n">lab</span><span class="p">]</span> <span class="o">=</span> <span class="n">stitched</span><span class="p">[</span><span class="n">upsampled_mask</span> <span class="o">==</span> <span class="n">lab</span><span class="p">]</span>
</span><span id="L-2336"><a href="#L-2336"><span class="linenos">2336</span></a>
</span><span id="L-2337"><a href="#L-2337"><span class="linenos">2337</span></a>    <span class="k">return</span> <span class="n">outimg</span>
</span><span id="L-2338"><a href="#L-2338"><span class="linenos">2338</span></a>
</span><span id="L-2339"><a href="#L-2339"><span class="linenos">2339</span></a>
</span><span id="L-2340"><a href="#L-2340"><span class="linenos">2340</span></a><span class="k">def</span> <span class="nf">region_wise_super_resolution_blended</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">super_res_model</span><span class="p">,</span> <span class="n">dilation_amount</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-2341"><a href="#L-2341"><span class="linenos">2341</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2342"><a href="#L-2342"><span class="linenos">2342</span></a><span class="sd">    Apply super-resolution model to labeled regions with smooth blending to minimize stitching artifacts.</span>
</span><span id="L-2343"><a href="#L-2343"><span class="linenos">2343</span></a>
</span><span id="L-2344"><a href="#L-2344"><span class="linenos">2344</span></a><span class="sd">    This version uses a weighted-averaging scheme based on distance transforms</span>
</span><span id="L-2345"><a href="#L-2345"><span class="linenos">2345</span></a><span class="sd">    to create seamless transitions between super-resolved regions and the background.</span>
</span><span id="L-2346"><a href="#L-2346"><span class="linenos">2346</span></a>
</span><span id="L-2347"><a href="#L-2347"><span class="linenos">2347</span></a><span class="sd">    Arguments</span>
</span><span id="L-2348"><a href="#L-2348"><span class="linenos">2348</span></a><span class="sd">    ---------</span>
</span><span id="L-2349"><a href="#L-2349"><span class="linenos">2349</span></a><span class="sd">    image : ANTsImage</span>
</span><span id="L-2350"><a href="#L-2350"><span class="linenos">2350</span></a><span class="sd">        Input low-resolution image.</span>
</span><span id="L-2351"><a href="#L-2351"><span class="linenos">2351</span></a>
</span><span id="L-2352"><a href="#L-2352"><span class="linenos">2352</span></a><span class="sd">    mask : ANTsImage</span>
</span><span id="L-2353"><a href="#L-2353"><span class="linenos">2353</span></a><span class="sd">        Integer-labeled segmentation mask.</span>
</span><span id="L-2354"><a href="#L-2354"><span class="linenos">2354</span></a>
</span><span id="L-2355"><a href="#L-2355"><span class="linenos">2355</span></a><span class="sd">    super_res_model : tf.keras.Model</span>
</span><span id="L-2356"><a href="#L-2356"><span class="linenos">2356</span></a><span class="sd">        Trained super-resolution model.</span>
</span><span id="L-2357"><a href="#L-2357"><span class="linenos">2357</span></a>
</span><span id="L-2358"><a href="#L-2358"><span class="linenos">2358</span></a><span class="sd">    dilation_amount : int</span>
</span><span id="L-2359"><a href="#L-2359"><span class="linenos">2359</span></a><span class="sd">        Number of morphological dilations applied to each label region before cropping.</span>
</span><span id="L-2360"><a href="#L-2360"><span class="linenos">2360</span></a><span class="sd">        This provides context to the SR model.</span>
</span><span id="L-2361"><a href="#L-2361"><span class="linenos">2361</span></a>
</span><span id="L-2362"><a href="#L-2362"><span class="linenos">2362</span></a><span class="sd">    verbose : bool</span>
</span><span id="L-2363"><a href="#L-2363"><span class="linenos">2363</span></a><span class="sd">        If True, print detailed status.</span>
</span><span id="L-2364"><a href="#L-2364"><span class="linenos">2364</span></a>
</span><span id="L-2365"><a href="#L-2365"><span class="linenos">2365</span></a><span class="sd">    Returns</span>
</span><span id="L-2366"><a href="#L-2366"><span class="linenos">2366</span></a><span class="sd">    -------</span>
</span><span id="L-2367"><a href="#L-2367"><span class="linenos">2367</span></a><span class="sd">    ANTsImage : Full-size, super-resolved image with seamless blending.</span>
</span><span id="L-2368"><a href="#L-2368"><span class="linenos">2368</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-2369"><a href="#L-2369"><span class="linenos">2369</span></a>    <span class="kn">import</span> <span class="nn">ants</span>
</span><span id="L-2370"><a href="#L-2370"><span class="linenos">2370</span></a>    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span><span id="L-2371"><a href="#L-2371"><span class="linenos">2371</span></a>    <span class="kn">from</span> <span class="nn">antspynet</span> <span class="kn">import</span> <span class="n">apply_super_resolution_model_to_image</span>
</span><span id="L-2372"><a href="#L-2372"><span class="linenos">2372</span></a>    <span class="n">epsilon32</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span>
</span><span id="L-2373"><a href="#L-2373"><span class="linenos">2373</span></a>    <span class="n">normalize_weight_maps</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># Default behavior to normalize weight maps</span>
</span><span id="L-2374"><a href="#L-2374"><span class="linenos">2374</span></a>    <span class="c1"># --- Step 1: Determine upsampling factor and prepare initial images ---</span>
</span><span id="L-2375"><a href="#L-2375"><span class="linenos">2375</span></a>    <span class="n">upFactor</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-2376"><a href="#L-2376"><span class="linenos">2376</span></a>    <span class="n">input_shape</span> <span class="o">=</span> <span class="n">super_res_model</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
</span><span id="L-2377"><a href="#L-2377"><span class="linenos">2377</span></a>    <span class="n">test_shape</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span> <span class="k">else</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="L-2378"><a href="#L-2378"><span class="linenos">2378</span></a>    <span class="n">test_input</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">test_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-2379"><a href="#L-2379"><span class="linenos">2379</span></a>    <span class="n">test_output</span> <span class="o">=</span> <span class="n">super_res_model</span><span class="p">(</span><span class="n">test_input</span><span class="p">)</span>
</span><span id="L-2380"><a href="#L-2380"><span class="linenos">2380</span></a>    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">test_shape</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">):</span>
</span><span id="L-2381"><a href="#L-2381"><span class="linenos">2381</span></a>        <span class="n">upFactor</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">test_output</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">test_input</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]))</span>
</span><span id="L-2382"><a href="#L-2382"><span class="linenos">2382</span></a>
</span><span id="L-2383"><a href="#L-2383"><span class="linenos">2383</span></a>    <span class="n">original_size</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span>
</span><span id="L-2384"><a href="#L-2384"><span class="linenos">2384</span></a>    <span class="n">new_size</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">s</span> <span class="o">*</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">original_size</span><span class="p">,</span> <span class="n">upFactor</span><span class="p">))</span>
</span><span id="L-2385"><a href="#L-2385"><span class="linenos">2385</span></a>
</span><span id="L-2386"><a href="#L-2386"><span class="linenos">2386</span></a>    <span class="c1"># The initial upsampled image will serve as our background</span>
</span><span id="L-2387"><a href="#L-2387"><span class="linenos">2387</span></a>    <span class="n">background_sr_image</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">resample_image</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">new_size</span><span class="p">,</span> <span class="n">use_voxels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">interp_type</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-2388"><a href="#L-2388"><span class="linenos">2388</span></a>
</span><span id="L-2389"><a href="#L-2389"><span class="linenos">2389</span></a>    <span class="c1"># --- Step 2: Initialize accumulator and weight sum canvases ---</span>
</span><span id="L-2390"><a href="#L-2390"><span class="linenos">2390</span></a>    <span class="c1"># These must be float type for accumulation</span>
</span><span id="L-2391"><a href="#L-2391"><span class="linenos">2391</span></a>    <span class="n">accumulator</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">image_clone</span><span class="p">(</span><span class="n">background_sr_image</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.0</span>
</span><span id="L-2392"><a href="#L-2392"><span class="linenos">2392</span></a>    <span class="n">weight_sum</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">image_clone</span><span class="p">(</span><span class="n">accumulator</span><span class="p">)</span>
</span><span id="L-2393"><a href="#L-2393"><span class="linenos">2393</span></a>
</span><span id="L-2394"><a href="#L-2394"><span class="linenos">2394</span></a>    <span class="n">unique_labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span> <span class="k">if</span> <span class="n">l</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="L-2395"><a href="#L-2395"><span class="linenos">2395</span></a>
</span><span id="L-2396"><a href="#L-2396"><span class="linenos">2396</span></a>    <span class="k">for</span> <span class="n">lab</span> <span class="ow">in</span> <span class="n">unique_labels</span><span class="p">:</span>
</span><span id="L-2397"><a href="#L-2397"><span class="linenos">2397</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-2398"><a href="#L-2398"><span class="linenos">2398</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Blending label: </span><span class="si">{</span><span class="n">lab</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-2399"><a href="#L-2399"><span class="linenos">2399</span></a>
</span><span id="L-2400"><a href="#L-2400"><span class="linenos">2400</span></a>        <span class="c1"># --- Step 3: Super-resolve a dilated patch (provides context to the model) ---</span>
</span><span id="L-2401"><a href="#L-2401"><span class="linenos">2401</span></a>        <span class="n">region_mask_dilated</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">threshold_image</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">lab</span><span class="p">,</span> <span class="n">lab</span><span class="p">)</span><span class="o">.</span><span class="n">iMath</span><span class="p">(</span><span class="s2">&quot;MD&quot;</span><span class="p">,</span> <span class="n">dilation_amount</span><span class="p">)</span>
</span><span id="L-2402"><a href="#L-2402"><span class="linenos">2402</span></a>        <span class="n">cropped_lowres</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">crop_image</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">region_mask_dilated</span><span class="p">)</span>
</span><span id="L-2403"><a href="#L-2403"><span class="linenos">2403</span></a>        <span class="k">if</span> <span class="n">cropped_lowres</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-2404"><a href="#L-2404"><span class="linenos">2404</span></a>            <span class="k">continue</span>
</span><span id="L-2405"><a href="#L-2405"><span class="linenos">2405</span></a>            
</span><span id="L-2406"><a href="#L-2406"><span class="linenos">2406</span></a>        <span class="c1"># Apply the model to the cropped low-res patch</span>
</span><span id="L-2407"><a href="#L-2407"><span class="linenos">2407</span></a>        <span class="n">sr_patch</span> <span class="o">=</span> <span class="n">apply_super_resolution_model_to_image</span><span class="p">(</span>
</span><span id="L-2408"><a href="#L-2408"><span class="linenos">2408</span></a>            <span class="n">cropped_lowres</span><span class="p">,</span> <span class="n">super_res_model</span><span class="p">,</span> <span class="n">target_range</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="L-2409"><a href="#L-2409"><span class="linenos">2409</span></a>        <span class="p">)</span>
</span><span id="L-2410"><a href="#L-2410"><span class="linenos">2410</span></a>        
</span><span id="L-2411"><a href="#L-2411"><span class="linenos">2411</span></a>        <span class="c1"># Place the super-resolved patch back onto a full-sized canvas</span>
</span><span id="L-2412"><a href="#L-2412"><span class="linenos">2412</span></a>        <span class="n">sr_patch_full_size</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">decrop_image</span><span class="p">(</span><span class="n">sr_patch</span><span class="p">,</span> <span class="n">accumulator</span><span class="p">)</span>
</span><span id="L-2413"><a href="#L-2413"><span class="linenos">2413</span></a>
</span><span id="L-2414"><a href="#L-2414"><span class="linenos">2414</span></a>        <span class="c1"># --- Step 4: Create a smooth weight map for this region ---</span>
</span><span id="L-2415"><a href="#L-2415"><span class="linenos">2415</span></a>        <span class="c1"># We use the *non-dilated* mask for the weight map to ensure a sharp focus on the target region.</span>
</span><span id="L-2416"><a href="#L-2416"><span class="linenos">2416</span></a>        <span class="n">region_mask_original</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">threshold_image</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">lab</span><span class="p">,</span> <span class="n">lab</span><span class="p">)</span>
</span><span id="L-2417"><a href="#L-2417"><span class="linenos">2417</span></a>        
</span><span id="L-2418"><a href="#L-2418"><span class="linenos">2418</span></a>        <span class="c1"># Resample the original region mask to the high-res grid</span>
</span><span id="L-2419"><a href="#L-2419"><span class="linenos">2419</span></a>        <span class="n">weight_map</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">resample_image</span><span class="p">(</span><span class="n">region_mask_original</span><span class="p">,</span> <span class="n">new_size</span><span class="p">,</span> <span class="n">use_voxels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">interp_type</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-2420"><a href="#L-2420"><span class="linenos">2420</span></a>        <span class="n">weight_map</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">smooth_image</span><span class="p">(</span><span class="n">weight_map</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span>
</span><span id="L-2421"><a href="#L-2421"><span class="linenos">2421</span></a>                                        <span class="n">sigma_in_physical_coordinates</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-2422"><a href="#L-2422"><span class="linenos">2422</span></a>        <span class="k">if</span> <span class="n">normalize_weight_maps</span><span class="p">:</span>
</span><span id="L-2423"><a href="#L-2423"><span class="linenos">2423</span></a>            <span class="n">weight_map</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">iMath</span><span class="p">(</span><span class="n">weight_map</span><span class="p">,</span> <span class="s2">&quot;Normalize&quot;</span><span class="p">)</span>
</span><span id="L-2424"><a href="#L-2424"><span class="linenos">2424</span></a>        <span class="c1"># --- Step 5: Accumulate the weighted values and the weights themselves ---</span>
</span><span id="L-2425"><a href="#L-2425"><span class="linenos">2425</span></a>        <span class="n">accumulator</span> <span class="o">+=</span> <span class="n">sr_patch_full_size</span> <span class="o">*</span> <span class="n">weight_map</span>
</span><span id="L-2426"><a href="#L-2426"><span class="linenos">2426</span></a>        <span class="n">weight_sum</span> <span class="o">+=</span> <span class="n">weight_map</span>
</span><span id="L-2427"><a href="#L-2427"><span class="linenos">2427</span></a>
</span><span id="L-2428"><a href="#L-2428"><span class="linenos">2428</span></a>    <span class="c1"># --- Step 6: Final Combination ---</span>
</span><span id="L-2429"><a href="#L-2429"><span class="linenos">2429</span></a>    <span class="c1"># Normalize the accumulator by the total weight at each pixel</span>
</span><span id="L-2430"><a href="#L-2430"><span class="linenos">2430</span></a>    <span class="n">weight_sum_np</span> <span class="o">=</span> <span class="n">weight_sum</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="L-2431"><a href="#L-2431"><span class="linenos">2431</span></a>    <span class="n">accumulator_np</span> <span class="o">=</span> <span class="n">accumulator</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="L-2432"><a href="#L-2432"><span class="linenos">2432</span></a>    
</span><span id="L-2433"><a href="#L-2433"><span class="linenos">2433</span></a>    <span class="c1"># Create a mask of pixels where blending occurred</span>
</span><span id="L-2434"><a href="#L-2434"><span class="linenos">2434</span></a>    <span class="n">blended_mask</span> <span class="o">=</span> <span class="n">weight_sum_np</span> <span class="o">&gt;</span> <span class="mf">0.0</span> <span class="c1"># Use a small epsilon for float safety</span>
</span><span id="L-2435"><a href="#L-2435"><span class="linenos">2435</span></a>
</span><span id="L-2436"><a href="#L-2436"><span class="linenos">2436</span></a>    <span class="c1"># Start with the original upsampled image as the base</span>
</span><span id="L-2437"><a href="#L-2437"><span class="linenos">2437</span></a>    <span class="n">final_image_np</span> <span class="o">=</span> <span class="n">background_sr_image</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="L-2438"><a href="#L-2438"><span class="linenos">2438</span></a>    
</span><span id="L-2439"><a href="#L-2439"><span class="linenos">2439</span></a>    <span class="c1"># Perform the weighted average only where weights are non-zero</span>
</span><span id="L-2440"><a href="#L-2440"><span class="linenos">2440</span></a>    <span class="n">final_image_np</span><span class="p">[</span><span class="n">blended_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">accumulator_np</span><span class="p">[</span><span class="n">blended_mask</span><span class="p">]</span> <span class="o">/</span> <span class="n">weight_sum_np</span><span class="p">[</span><span class="n">blended_mask</span><span class="p">]</span>
</span><span id="L-2441"><a href="#L-2441"><span class="linenos">2441</span></a>    
</span><span id="L-2442"><a href="#L-2442"><span class="linenos">2442</span></a>    <span class="c1"># Re-insert any non-blended background regions that were processed</span>
</span><span id="L-2443"><a href="#L-2443"><span class="linenos">2443</span></a>    <span class="c1"># This handles cases where regions overlap; the weighted average takes care of it.</span>
</span><span id="L-2444"><a href="#L-2444"><span class="linenos">2444</span></a>    
</span><span id="L-2445"><a href="#L-2445"><span class="linenos">2445</span></a>    <span class="k">return</span> <span class="n">ants</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">final_image_np</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">background_sr_image</span><span class="o">.</span><span class="n">origin</span><span class="p">,</span> 
</span><span id="L-2446"><a href="#L-2446"><span class="linenos">2446</span></a>                           <span class="n">spacing</span><span class="o">=</span><span class="n">background_sr_image</span><span class="o">.</span><span class="n">spacing</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="n">background_sr_image</span><span class="o">.</span><span class="n">direction</span><span class="p">)</span>
</span><span id="L-2447"><a href="#L-2447"><span class="linenos">2447</span></a>     
</span><span id="L-2448"><a href="#L-2448"><span class="linenos">2448</span></a>
</span><span id="L-2449"><a href="#L-2449"><span class="linenos">2449</span></a><span class="k">def</span> <span class="nf">inference</span><span class="p">(</span>
</span><span id="L-2450"><a href="#L-2450"><span class="linenos">2450</span></a>    <span class="n">image</span><span class="p">,</span>
</span><span id="L-2451"><a href="#L-2451"><span class="linenos">2451</span></a>    <span class="n">mdl</span><span class="p">,</span>
</span><span id="L-2452"><a href="#L-2452"><span class="linenos">2452</span></a>    <span class="n">truncation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-2453"><a href="#L-2453"><span class="linenos">2453</span></a>    <span class="n">segmentation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-2454"><a href="#L-2454"><span class="linenos">2454</span></a>    <span class="n">target_range</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
</span><span id="L-2455"><a href="#L-2455"><span class="linenos">2455</span></a>    <span class="n">poly_order</span><span class="o">=</span><span class="s1">&#39;hist&#39;</span><span class="p">,</span>
</span><span id="L-2456"><a href="#L-2456"><span class="linenos">2456</span></a>    <span class="n">dilation_amount</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="L-2457"><a href="#L-2457"><span class="linenos">2457</span></a>    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-2458"><a href="#L-2458"><span class="linenos">2458</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2459"><a href="#L-2459"><span class="linenos">2459</span></a><span class="sd">    Perform super-resolution inference on an input image, optionally guided by segmentation.</span>
</span><span id="L-2460"><a href="#L-2460"><span class="linenos">2460</span></a>
</span><span id="L-2461"><a href="#L-2461"><span class="linenos">2461</span></a><span class="sd">    This function uses a trained deep learning model to enhance the resolution of a medical image.</span>
</span><span id="L-2462"><a href="#L-2462"><span class="linenos">2462</span></a><span class="sd">    It optionally applies label-wise inference if a segmentation mask is provided.</span>
</span><span id="L-2463"><a href="#L-2463"><span class="linenos">2463</span></a>
</span><span id="L-2464"><a href="#L-2464"><span class="linenos">2464</span></a><span class="sd">    Parameters</span>
</span><span id="L-2465"><a href="#L-2465"><span class="linenos">2465</span></a><span class="sd">    ----------</span>
</span><span id="L-2466"><a href="#L-2466"><span class="linenos">2466</span></a><span class="sd">    image : ants.ANTsImage</span>
</span><span id="L-2467"><a href="#L-2467"><span class="linenos">2467</span></a><span class="sd">        Input image to be super-resolved.</span>
</span><span id="L-2468"><a href="#L-2468"><span class="linenos">2468</span></a>
</span><span id="L-2469"><a href="#L-2469"><span class="linenos">2469</span></a><span class="sd">    mdl : keras.Model</span>
</span><span id="L-2470"><a href="#L-2470"><span class="linenos">2470</span></a><span class="sd">        Trained super-resolution model, typically from ANTsPyNet.</span>
</span><span id="L-2471"><a href="#L-2471"><span class="linenos">2471</span></a>
</span><span id="L-2472"><a href="#L-2472"><span class="linenos">2472</span></a><span class="sd">    truncation : tuple or list of float, optional</span>
</span><span id="L-2473"><a href="#L-2473"><span class="linenos">2473</span></a><span class="sd">        Percentile values (e.g., [0.01, 0.99]) for intensity truncation before model input.</span>
</span><span id="L-2474"><a href="#L-2474"><span class="linenos">2474</span></a><span class="sd">        If None, no truncation is applied.</span>
</span><span id="L-2475"><a href="#L-2475"><span class="linenos">2475</span></a>
</span><span id="L-2476"><a href="#L-2476"><span class="linenos">2476</span></a><span class="sd">    segmentation : ants.ANTsImage, optional</span>
</span><span id="L-2477"><a href="#L-2477"><span class="linenos">2477</span></a><span class="sd">        A labeled segmentation mask. If provided, super-resolution is performed per label</span>
</span><span id="L-2478"><a href="#L-2478"><span class="linenos">2478</span></a><span class="sd">        using `region_wise_super_resolution` or `super_resolution_segmentation_per_label`.</span>
</span><span id="L-2479"><a href="#L-2479"><span class="linenos">2479</span></a>
</span><span id="L-2480"><a href="#L-2480"><span class="linenos">2480</span></a><span class="sd">    target_range : list of float</span>
</span><span id="L-2481"><a href="#L-2481"><span class="linenos">2481</span></a><span class="sd">        Intensity range used for scaling the input before applying the model.</span>
</span><span id="L-2482"><a href="#L-2482"><span class="linenos">2482</span></a><span class="sd">        Default is [1, 0] (internal default for `apply_super_resolution_model_to_image`).</span>
</span><span id="L-2483"><a href="#L-2483"><span class="linenos">2483</span></a>
</span><span id="L-2484"><a href="#L-2484"><span class="linenos">2484</span></a><span class="sd">    poly_order : int, str or None</span>
</span><span id="L-2485"><a href="#L-2485"><span class="linenos">2485</span></a><span class="sd">        Determines how to match intensity between the super-resolved image and the original.</span>
</span><span id="L-2486"><a href="#L-2486"><span class="linenos">2486</span></a><span class="sd">        Options:</span>
</span><span id="L-2487"><a href="#L-2487"><span class="linenos">2487</span></a><span class="sd">          - &#39;hist&#39; : use histogram matching</span>
</span><span id="L-2488"><a href="#L-2488"><span class="linenos">2488</span></a><span class="sd">          - int &gt;= 1 : perform polynomial regression of this order</span>
</span><span id="L-2489"><a href="#L-2489"><span class="linenos">2489</span></a><span class="sd">          - None : no intensity adjustment</span>
</span><span id="L-2490"><a href="#L-2490"><span class="linenos">2490</span></a>
</span><span id="L-2491"><a href="#L-2491"><span class="linenos">2491</span></a><span class="sd">    dilation_amount : int</span>
</span><span id="L-2492"><a href="#L-2492"><span class="linenos">2492</span></a><span class="sd">        Number of dilation steps applied to each segmentation label during</span>
</span><span id="L-2493"><a href="#L-2493"><span class="linenos">2493</span></a><span class="sd">        region-based super-resolution (if segmentation is provided).</span>
</span><span id="L-2494"><a href="#L-2494"><span class="linenos">2494</span></a>
</span><span id="L-2495"><a href="#L-2495"><span class="linenos">2495</span></a><span class="sd">    verbose : bool</span>
</span><span id="L-2496"><a href="#L-2496"><span class="linenos">2496</span></a><span class="sd">        If True, print progress and status messages.</span>
</span><span id="L-2497"><a href="#L-2497"><span class="linenos">2497</span></a>
</span><span id="L-2498"><a href="#L-2498"><span class="linenos">2498</span></a><span class="sd">    Returns</span>
</span><span id="L-2499"><a href="#L-2499"><span class="linenos">2499</span></a><span class="sd">    -------</span>
</span><span id="L-2500"><a href="#L-2500"><span class="linenos">2500</span></a><span class="sd">    ANTsImage or dict</span>
</span><span id="L-2501"><a href="#L-2501"><span class="linenos">2501</span></a><span class="sd">        - If `segmentation` is None, returns a single ANTsImage (super-resolved image).</span>
</span><span id="L-2502"><a href="#L-2502"><span class="linenos">2502</span></a><span class="sd">        - If `segmentation` is provided, returns a dictionary with:</span>
</span><span id="L-2503"><a href="#L-2503"><span class="linenos">2503</span></a><span class="sd">            - &#39;super_resolution&#39;: ANTsImage</span>
</span><span id="L-2504"><a href="#L-2504"><span class="linenos">2504</span></a><span class="sd">            - other entries may include label-wise results or metadata.</span>
</span><span id="L-2505"><a href="#L-2505"><span class="linenos">2505</span></a>
</span><span id="L-2506"><a href="#L-2506"><span class="linenos">2506</span></a><span class="sd">    Examples</span>
</span><span id="L-2507"><a href="#L-2507"><span class="linenos">2507</span></a><span class="sd">    --------</span>
</span><span id="L-2508"><a href="#L-2508"><span class="linenos">2508</span></a><span class="sd">    &gt;&gt;&gt; import ants</span>
</span><span id="L-2509"><a href="#L-2509"><span class="linenos">2509</span></a><span class="sd">    &gt;&gt;&gt; import antspynet</span>
</span><span id="L-2510"><a href="#L-2510"><span class="linenos">2510</span></a><span class="sd">    &gt;&gt;&gt; from siq import inference</span>
</span><span id="L-2511"><a href="#L-2511"><span class="linenos">2511</span></a><span class="sd">    &gt;&gt;&gt; img = ants.image_read(&quot;lowres.nii.gz&quot;)</span>
</span><span id="L-2512"><a href="#L-2512"><span class="linenos">2512</span></a><span class="sd">    &gt;&gt;&gt; model = antspynet.get_pretrained_network(&quot;dbpn&quot;, target_suffix=&quot;T1&quot;)</span>
</span><span id="L-2513"><a href="#L-2513"><span class="linenos">2513</span></a><span class="sd">    &gt;&gt;&gt; srimg = inference(img, model, truncation=[0.01, 0.99], verbose=True)</span>
</span><span id="L-2514"><a href="#L-2514"><span class="linenos">2514</span></a>
</span><span id="L-2515"><a href="#L-2515"><span class="linenos">2515</span></a><span class="sd">    &gt;&gt;&gt; seg = ants.image_read(&quot;mask.nii.gz&quot;)</span>
</span><span id="L-2516"><a href="#L-2516"><span class="linenos">2516</span></a><span class="sd">    &gt;&gt;&gt; sr_result = inference(img, model, segmentation=seg)</span>
</span><span id="L-2517"><a href="#L-2517"><span class="linenos">2517</span></a><span class="sd">    &gt;&gt;&gt; srimg = sr_result[&#39;super_resolution&#39;]</span>
</span><span id="L-2518"><a href="#L-2518"><span class="linenos">2518</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-2519"><a href="#L-2519"><span class="linenos">2519</span></a>    <span class="kn">import</span> <span class="nn">ants</span>
</span><span id="L-2520"><a href="#L-2520"><span class="linenos">2520</span></a>    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span><span id="L-2521"><a href="#L-2521"><span class="linenos">2521</span></a>    <span class="kn">import</span> <span class="nn">antspynet</span>
</span><span id="L-2522"><a href="#L-2522"><span class="linenos">2522</span></a>    <span class="kn">import</span> <span class="nn">antspyt1w</span>
</span><span id="L-2523"><a href="#L-2523"><span class="linenos">2523</span></a>    <span class="kn">from</span> <span class="nn">siq</span> <span class="kn">import</span> <span class="n">region_wise_super_resolution</span>
</span><span id="L-2524"><a href="#L-2524"><span class="linenos">2524</span></a>
</span><span id="L-2525"><a href="#L-2525"><span class="linenos">2525</span></a>    <span class="k">def</span> <span class="nf">apply_intensity_match</span><span class="p">(</span><span class="n">sr_image</span><span class="p">,</span> <span class="n">reference_image</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-2526"><a href="#L-2526"><span class="linenos">2526</span></a>        <span class="k">if</span> <span class="n">order</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-2527"><a href="#L-2527"><span class="linenos">2527</span></a>            <span class="k">return</span> <span class="n">sr_image</span>
</span><span id="L-2528"><a href="#L-2528"><span class="linenos">2528</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-2529"><a href="#L-2529"><span class="linenos">2529</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Applying intensity match with&quot;</span><span class="p">,</span> <span class="n">order</span><span class="p">)</span>
</span><span id="L-2530"><a href="#L-2530"><span class="linenos">2530</span></a>        <span class="k">if</span> <span class="n">order</span> <span class="o">==</span> <span class="s1">&#39;hist&#39;</span><span class="p">:</span>
</span><span id="L-2531"><a href="#L-2531"><span class="linenos">2531</span></a>            <span class="k">return</span> <span class="n">ants</span><span class="o">.</span><span class="n">histogram_match_image</span><span class="p">(</span><span class="n">sr_image</span><span class="p">,</span> <span class="n">reference_image</span><span class="p">)</span>
</span><span id="L-2532"><a href="#L-2532"><span class="linenos">2532</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-2533"><a href="#L-2533"><span class="linenos">2533</span></a>            <span class="k">return</span> <span class="n">ants</span><span class="o">.</span><span class="n">regression_match_image</span><span class="p">(</span><span class="n">sr_image</span><span class="p">,</span> <span class="n">reference_image</span><span class="p">,</span> <span class="n">poly_order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>
</span><span id="L-2534"><a href="#L-2534"><span class="linenos">2534</span></a>
</span><span id="L-2535"><a href="#L-2535"><span class="linenos">2535</span></a>    <span class="n">pimg</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">image_clone</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
</span><span id="L-2536"><a href="#L-2536"><span class="linenos">2536</span></a>    <span class="k">if</span> <span class="n">truncation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-2537"><a href="#L-2537"><span class="linenos">2537</span></a>        <span class="n">pimg</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">iMath</span><span class="p">(</span><span class="n">pimg</span><span class="p">,</span> <span class="s1">&#39;TruncateIntensity&#39;</span><span class="p">,</span> <span class="n">truncation</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">truncation</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-2538"><a href="#L-2538"><span class="linenos">2538</span></a>
</span><span id="L-2539"><a href="#L-2539"><span class="linenos">2539</span></a>    <span class="n">input_shape</span> <span class="o">=</span> <span class="n">mdl</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
</span><span id="L-2540"><a href="#L-2540"><span class="linenos">2540</span></a>    <span class="n">num_channels</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">input_shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-2541"><a href="#L-2541"><span class="linenos">2541</span></a>
</span><span id="L-2542"><a href="#L-2542"><span class="linenos">2542</span></a>    <span class="k">if</span> <span class="n">segmentation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-2543"><a href="#L-2543"><span class="linenos">2543</span></a>        <span class="k">if</span> <span class="n">num_channels</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-2544"><a href="#L-2544"><span class="linenos">2544</span></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-2545"><a href="#L-2545"><span class="linenos">2545</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using region-wise super resolution due to single-channel model with segmentation.&quot;</span><span class="p">)</span>
</span><span id="L-2546"><a href="#L-2546"><span class="linenos">2546</span></a>            <span class="n">sr</span> <span class="o">=</span> <span class="n">region_wise_super_resolution_blended</span><span class="p">(</span>
</span><span id="L-2547"><a href="#L-2547"><span class="linenos">2547</span></a>                <span class="n">pimg</span><span class="p">,</span> <span class="n">segmentation</span><span class="p">,</span> <span class="n">mdl</span><span class="p">,</span>
</span><span id="L-2548"><a href="#L-2548"><span class="linenos">2548</span></a>                <span class="n">dilation_amount</span><span class="o">=</span><span class="n">dilation_amount</span><span class="p">,</span>
</span><span id="L-2549"><a href="#L-2549"><span class="linenos">2549</span></a>                <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span>
</span><span id="L-2550"><a href="#L-2550"><span class="linenos">2550</span></a>            <span class="p">)</span>
</span><span id="L-2551"><a href="#L-2551"><span class="linenos">2551</span></a>            <span class="n">ref</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">resample_image_to_target</span><span class="p">(</span><span class="n">pimg</span><span class="p">,</span> <span class="n">sr</span><span class="p">)</span>
</span><span id="L-2552"><a href="#L-2552"><span class="linenos">2552</span></a>            <span class="k">return</span> <span class="n">apply_intensity_match</span><span class="p">(</span><span class="n">sr</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span> <span class="n">poly_order</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
</span><span id="L-2553"><a href="#L-2553"><span class="linenos">2553</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-2554"><a href="#L-2554"><span class="linenos">2554</span></a>            <span class="n">mynp</span> <span class="o">=</span> <span class="n">segmentation</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="L-2555"><a href="#L-2555"><span class="linenos">2555</span></a>            <span class="n">mynp</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">mynp</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">mynp</span><span class="p">)]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
</span><span id="L-2556"><a href="#L-2556"><span class="linenos">2556</span></a>            <span class="n">upFactor</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-2557"><a href="#L-2557"><span class="linenos">2557</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
</span><span id="L-2558"><a href="#L-2558"><span class="linenos">2558</span></a>                <span class="n">testarr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
</span><span id="L-2559"><a href="#L-2559"><span class="linenos">2559</span></a>                <span class="n">testarrout</span> <span class="o">=</span> <span class="n">mdl</span><span class="p">(</span><span class="n">testarr</span><span class="p">)</span>
</span><span id="L-2560"><a href="#L-2560"><span class="linenos">2560</span></a>                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
</span><span id="L-2561"><a href="#L-2561"><span class="linenos">2561</span></a>                    <span class="n">upFactor</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">testarrout</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">testarr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]))</span>
</span><span id="L-2562"><a href="#L-2562"><span class="linenos">2562</span></a>            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
</span><span id="L-2563"><a href="#L-2563"><span class="linenos">2563</span></a>                <span class="n">testarr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
</span><span id="L-2564"><a href="#L-2564"><span class="linenos">2564</span></a>                <span class="n">testarrout</span> <span class="o">=</span> <span class="n">mdl</span><span class="p">(</span><span class="n">testarr</span><span class="p">)</span>
</span><span id="L-2565"><a href="#L-2565"><span class="linenos">2565</span></a>                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
</span><span id="L-2566"><a href="#L-2566"><span class="linenos">2566</span></a>                    <span class="n">upFactor</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">testarrout</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">testarr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]))</span>
</span><span id="L-2567"><a href="#L-2567"><span class="linenos">2567</span></a>            <span class="n">temp</span> <span class="o">=</span> <span class="n">antspyt1w</span><span class="o">.</span><span class="n">super_resolution_segmentation_per_label</span><span class="p">(</span>
</span><span id="L-2568"><a href="#L-2568"><span class="linenos">2568</span></a>                <span class="n">pimg</span><span class="p">,</span>
</span><span id="L-2569"><a href="#L-2569"><span class="linenos">2569</span></a>                <span class="n">segmentation</span><span class="p">,</span>
</span><span id="L-2570"><a href="#L-2570"><span class="linenos">2570</span></a>                <span class="n">upFactor</span><span class="p">,</span>
</span><span id="L-2571"><a href="#L-2571"><span class="linenos">2571</span></a>                <span class="n">mdl</span><span class="p">,</span>
</span><span id="L-2572"><a href="#L-2572"><span class="linenos">2572</span></a>                <span class="n">segmentation_numbers</span><span class="o">=</span><span class="n">mynp</span><span class="p">,</span>
</span><span id="L-2573"><a href="#L-2573"><span class="linenos">2573</span></a>                <span class="n">target_range</span><span class="o">=</span><span class="n">target_range</span><span class="p">,</span>
</span><span id="L-2574"><a href="#L-2574"><span class="linenos">2574</span></a>                <span class="n">dilation_amount</span><span class="o">=</span><span class="n">dilation_amount</span><span class="p">,</span>
</span><span id="L-2575"><a href="#L-2575"><span class="linenos">2575</span></a>                <span class="n">poly_order</span><span class="o">=</span><span class="n">poly_order</span><span class="p">,</span>
</span><span id="L-2576"><a href="#L-2576"><span class="linenos">2576</span></a>                <span class="n">max_lab_plus_one</span><span class="o">=</span><span class="kc">True</span>
</span><span id="L-2577"><a href="#L-2577"><span class="linenos">2577</span></a>            <span class="p">)</span>
</span><span id="L-2578"><a href="#L-2578"><span class="linenos">2578</span></a>            <span class="n">imgsr</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;super_resolution&#39;</span><span class="p">]</span>
</span><span id="L-2579"><a href="#L-2579"><span class="linenos">2579</span></a>            <span class="n">ref</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">resample_image_to_target</span><span class="p">(</span><span class="n">pimg</span><span class="p">,</span> <span class="n">imgsr</span><span class="p">)</span>
</span><span id="L-2580"><a href="#L-2580"><span class="linenos">2580</span></a>            <span class="k">return</span> <span class="n">apply_intensity_match</span><span class="p">(</span><span class="n">imgsr</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span> <span class="n">poly_order</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
</span><span id="L-2581"><a href="#L-2581"><span class="linenos">2581</span></a>
</span><span id="L-2582"><a href="#L-2582"><span class="linenos">2582</span></a>    <span class="c1"># Default path: no segmentation</span>
</span><span id="L-2583"><a href="#L-2583"><span class="linenos">2583</span></a>    <span class="n">imgsr</span> <span class="o">=</span> <span class="n">antspynet</span><span class="o">.</span><span class="n">apply_super_resolution_model_to_image</span><span class="p">(</span>
</span><span id="L-2584"><a href="#L-2584"><span class="linenos">2584</span></a>        <span class="n">pimg</span><span class="p">,</span> <span class="n">mdl</span><span class="p">,</span> <span class="n">target_range</span><span class="o">=</span><span class="n">target_range</span><span class="p">,</span> <span class="n">regression_order</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span>
</span><span id="L-2585"><a href="#L-2585"><span class="linenos">2585</span></a>    <span class="p">)</span>
</span><span id="L-2586"><a href="#L-2586"><span class="linenos">2586</span></a>    <span class="n">ref</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">resample_image_to_target</span><span class="p">(</span><span class="n">pimg</span><span class="p">,</span> <span class="n">imgsr</span><span class="p">)</span>
</span><span id="L-2587"><a href="#L-2587"><span class="linenos">2587</span></a>    <span class="k">return</span> <span class="n">apply_intensity_match</span><span class="p">(</span><span class="n">imgsr</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span> <span class="n">poly_order</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
</span></pre></div>


            </section>
                <section id="DATA_PATH">
                    <div class="attr variable">
            <span class="name">DATA_PATH</span>        =
<span class="default_value">&#39;/Users/stnava/.siq/&#39;</span>

        
    </div>
    <a class="headerlink" href="#DATA_PATH"></a>
    
    

                </section>
                <section id="get_data">
                            <input id="get_data-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_data</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">name</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">force_download</span><span class="o">=</span><span class="kc">False</span>, </span><span class="param"><span class="n">version</span><span class="o">=</span><span class="mi">0</span>, </span><span class="param"><span class="n">target_extension</span><span class="o">=</span><span class="s1">&#39;.csv&#39;</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="get_data-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#get_data"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="get_data-31"><a href="#get_data-31"><span class="linenos">31</span></a><span class="k">def</span> <span class="nf">get_data</span><span class="p">(</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">force_download</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">target_extension</span><span class="o">=</span><span class="s1">&#39;.csv&#39;</span> <span class="p">):</span>
</span><span id="get_data-32"><a href="#get_data-32"><span class="linenos">32</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="get_data-33"><a href="#get_data-33"><span class="linenos">33</span></a><span class="sd">    Get SIQ data filename</span>
</span><span id="get_data-34"><a href="#get_data-34"><span class="linenos">34</span></a>
</span><span id="get_data-35"><a href="#get_data-35"><span class="linenos">35</span></a><span class="sd">    The first time this is called, it will download data to ~/.siq.</span>
</span><span id="get_data-36"><a href="#get_data-36"><span class="linenos">36</span></a><span class="sd">    After, it will just read data from disk.  The ~/.siq may need to</span>
</span><span id="get_data-37"><a href="#get_data-37"><span class="linenos">37</span></a><span class="sd">    be periodically deleted in order to ensure data is current.</span>
</span><span id="get_data-38"><a href="#get_data-38"><span class="linenos">38</span></a>
</span><span id="get_data-39"><a href="#get_data-39"><span class="linenos">39</span></a><span class="sd">    Arguments</span>
</span><span id="get_data-40"><a href="#get_data-40"><span class="linenos">40</span></a><span class="sd">    ---------</span>
</span><span id="get_data-41"><a href="#get_data-41"><span class="linenos">41</span></a><span class="sd">    name : string</span>
</span><span id="get_data-42"><a href="#get_data-42"><span class="linenos">42</span></a><span class="sd">        name of data tag to retrieve</span>
</span><span id="get_data-43"><a href="#get_data-43"><span class="linenos">43</span></a><span class="sd">        Options:</span>
</span><span id="get_data-44"><a href="#get_data-44"><span class="linenos">44</span></a><span class="sd">            - &#39;all&#39;</span>
</span><span id="get_data-45"><a href="#get_data-45"><span class="linenos">45</span></a>
</span><span id="get_data-46"><a href="#get_data-46"><span class="linenos">46</span></a><span class="sd">    force_download: boolean</span>
</span><span id="get_data-47"><a href="#get_data-47"><span class="linenos">47</span></a>
</span><span id="get_data-48"><a href="#get_data-48"><span class="linenos">48</span></a><span class="sd">    version: version of data to download (integer)</span>
</span><span id="get_data-49"><a href="#get_data-49"><span class="linenos">49</span></a>
</span><span id="get_data-50"><a href="#get_data-50"><span class="linenos">50</span></a><span class="sd">    Returns</span>
</span><span id="get_data-51"><a href="#get_data-51"><span class="linenos">51</span></a><span class="sd">    -------</span>
</span><span id="get_data-52"><a href="#get_data-52"><span class="linenos">52</span></a><span class="sd">    string</span>
</span><span id="get_data-53"><a href="#get_data-53"><span class="linenos">53</span></a><span class="sd">        filepath of selected data</span>
</span><span id="get_data-54"><a href="#get_data-54"><span class="linenos">54</span></a>
</span><span id="get_data-55"><a href="#get_data-55"><span class="linenos">55</span></a><span class="sd">    Example</span>
</span><span id="get_data-56"><a href="#get_data-56"><span class="linenos">56</span></a><span class="sd">    -------</span>
</span><span id="get_data-57"><a href="#get_data-57"><span class="linenos">57</span></a><span class="sd">    &gt;&gt;&gt; import siq</span>
</span><span id="get_data-58"><a href="#get_data-58"><span class="linenos">58</span></a><span class="sd">    &gt;&gt;&gt; siq.get_data()</span>
</span><span id="get_data-59"><a href="#get_data-59"><span class="linenos">59</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="get_data-60"><a href="#get_data-60"><span class="linenos">60</span></a>    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">DATA_PATH</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="get_data-61"><a href="#get_data-61"><span class="linenos">61</span></a>
</span><span id="get_data-62"><a href="#get_data-62"><span class="linenos">62</span></a>    <span class="k">def</span> <span class="nf">download_data</span><span class="p">(</span> <span class="n">version</span> <span class="p">):</span>
</span><span id="get_data-63"><a href="#get_data-63"><span class="linenos">63</span></a>        <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://figshare.com/ndownloader/articles/16912366/versions/&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">version</span><span class="p">)</span>
</span><span id="get_data-64"><a href="#get_data-64"><span class="linenos">64</span></a>        <span class="n">target_file_name</span> <span class="o">=</span> <span class="s2">&quot;16912366.zip&quot;</span>
</span><span id="get_data-65"><a href="#get_data-65"><span class="linenos">65</span></a>        <span class="n">target_file_name_path</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">get_file</span><span class="p">(</span><span class="n">target_file_name</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span>
</span><span id="get_data-66"><a href="#get_data-66"><span class="linenos">66</span></a>            <span class="n">cache_subdir</span><span class="o">=</span><span class="n">DATA_PATH</span><span class="p">,</span> <span class="n">extract</span> <span class="o">=</span> <span class="kc">True</span> <span class="p">)</span>
</span><span id="get_data-67"><a href="#get_data-67"><span class="linenos">67</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span> <span class="n">DATA_PATH</span> <span class="o">+</span> <span class="n">target_file_name</span> <span class="p">)</span>
</span><span id="get_data-68"><a href="#get_data-68"><span class="linenos">68</span></a>
</span><span id="get_data-69"><a href="#get_data-69"><span class="linenos">69</span></a>    <span class="k">if</span> <span class="n">force_download</span><span class="p">:</span>
</span><span id="get_data-70"><a href="#get_data-70"><span class="linenos">70</span></a>        <span class="n">download_data</span><span class="p">(</span> <span class="n">version</span> <span class="o">=</span> <span class="n">version</span> <span class="p">)</span>
</span><span id="get_data-71"><a href="#get_data-71"><span class="linenos">71</span></a>
</span><span id="get_data-72"><a href="#get_data-72"><span class="linenos">72</span></a>
</span><span id="get_data-73"><a href="#get_data-73"><span class="linenos">73</span></a>    <span class="n">files</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="get_data-74"><a href="#get_data-74"><span class="linenos">74</span></a>    <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">DATA_PATH</span><span class="p">):</span>
</span><span id="get_data-75"><a href="#get_data-75"><span class="linenos">75</span></a>        <span class="k">if</span> <span class="p">(</span> <span class="n">fname</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">target_extension</span><span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
</span><span id="get_data-76"><a href="#get_data-76"><span class="linenos">76</span></a>            <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_PATH</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
</span><span id="get_data-77"><a href="#get_data-77"><span class="linenos">77</span></a>            <span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
</span><span id="get_data-78"><a href="#get_data-78"><span class="linenos">78</span></a>
</span><span id="get_data-79"><a href="#get_data-79"><span class="linenos">79</span></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span> <span class="n">files</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">:</span>
</span><span id="get_data-80"><a href="#get_data-80"><span class="linenos">80</span></a>        <span class="n">download_data</span><span class="p">(</span> <span class="n">version</span> <span class="o">=</span> <span class="n">version</span> <span class="p">)</span>
</span><span id="get_data-81"><a href="#get_data-81"><span class="linenos">81</span></a>        <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">DATA_PATH</span><span class="p">):</span>
</span><span id="get_data-82"><a href="#get_data-82"><span class="linenos">82</span></a>            <span class="k">if</span> <span class="p">(</span> <span class="n">fname</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">target_extension</span><span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
</span><span id="get_data-83"><a href="#get_data-83"><span class="linenos">83</span></a>                <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_PATH</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
</span><span id="get_data-84"><a href="#get_data-84"><span class="linenos">84</span></a>                <span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
</span><span id="get_data-85"><a href="#get_data-85"><span class="linenos">85</span></a>
</span><span id="get_data-86"><a href="#get_data-86"><span class="linenos">86</span></a>    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
</span><span id="get_data-87"><a href="#get_data-87"><span class="linenos">87</span></a>        <span class="k">return</span> <span class="n">files</span>
</span><span id="get_data-88"><a href="#get_data-88"><span class="linenos">88</span></a>
</span><span id="get_data-89"><a href="#get_data-89"><span class="linenos">89</span></a>    <span class="n">datapath</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="get_data-90"><a href="#get_data-90"><span class="linenos">90</span></a>
</span><span id="get_data-91"><a href="#get_data-91"><span class="linenos">91</span></a>    <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">DATA_PATH</span><span class="p">):</span>
</span><span id="get_data-92"><a href="#get_data-92"><span class="linenos">92</span></a>        <span class="n">mystem</span> <span class="o">=</span> <span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="o">.</span><span class="n">stem</span><span class="p">)</span>
</span><span id="get_data-93"><a href="#get_data-93"><span class="linenos">93</span></a>        <span class="n">mystem</span> <span class="o">=</span> <span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">mystem</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="o">.</span><span class="n">stem</span><span class="p">)</span>
</span><span id="get_data-94"><a href="#get_data-94"><span class="linenos">94</span></a>        <span class="n">mystem</span> <span class="o">=</span> <span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">mystem</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="o">.</span><span class="n">stem</span><span class="p">)</span>
</span><span id="get_data-95"><a href="#get_data-95"><span class="linenos">95</span></a>        <span class="k">if</span> <span class="p">(</span> <span class="n">name</span> <span class="o">==</span> <span class="n">mystem</span> <span class="ow">and</span> <span class="n">fname</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">target_extension</span><span class="p">)</span> <span class="p">)</span> <span class="p">:</span>
</span><span id="get_data-96"><a href="#get_data-96"><span class="linenos">96</span></a>            <span class="n">datapath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_PATH</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
</span><span id="get_data-97"><a href="#get_data-97"><span class="linenos">97</span></a>
</span><span id="get_data-98"><a href="#get_data-98"><span class="linenos">98</span></a>    <span class="k">return</span> <span class="n">datapath</span>
</span></pre></div>


            <div class="docstring"><p>Get SIQ data filename</p>

<p>The first time this is called, it will download data to ~/.siq.
After, it will just read data from disk.  The ~/.siq may need to
be periodically deleted in order to ensure data is current.</p>

<h2 id="arguments">Arguments</h2>

<p>name : string
    name of data tag to retrieve
    Options:
        - 'all'</p>

<p>force_download: boolean</p>

<p>version: version of data to download (integer)</p>

<h2 id="returns">Returns</h2>

<p>string
    filepath of selected data</p>

<h2 id="example">Example</h2>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">siq</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n"><a href="">siq.get_data</a></span><span class="p">()</span>
</code></pre>
</div>
</div>


                </section>
                <section id="dbpn">
                            <input id="dbpn-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">dbpn</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">input_image_size</span>,</span><span class="param">	<span class="n">number_of_outputs</span><span class="o">=</span><span class="mi">1</span>,</span><span class="param">	<span class="n">number_of_base_filters</span><span class="o">=</span><span class="mi">64</span>,</span><span class="param">	<span class="n">number_of_feature_filters</span><span class="o">=</span><span class="mi">256</span>,</span><span class="param">	<span class="n">number_of_back_projection_stages</span><span class="o">=</span><span class="mi">7</span>,</span><span class="param">	<span class="n">convolution_kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span>,</span><span class="param">	<span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>,</span><span class="param">	<span class="n">last_convolution</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>,</span><span class="param">	<span class="n">number_of_loss_functions</span><span class="o">=</span><span class="mi">1</span>,</span><span class="param">	<span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="dbpn-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#dbpn"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="dbpn-119"><a href="#dbpn-119"><span class="linenos">119</span></a><span class="k">def</span> <span class="nf">dbpn</span><span class="p">(</span><span class="n">input_image_size</span><span class="p">,</span>
</span><span id="dbpn-120"><a href="#dbpn-120"><span class="linenos">120</span></a>                                                 <span class="n">number_of_outputs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="dbpn-121"><a href="#dbpn-121"><span class="linenos">121</span></a>                                                 <span class="n">number_of_base_filters</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>
</span><span id="dbpn-122"><a href="#dbpn-122"><span class="linenos">122</span></a>                                                 <span class="n">number_of_feature_filters</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span>
</span><span id="dbpn-123"><a href="#dbpn-123"><span class="linenos">123</span></a>                                                 <span class="n">number_of_back_projection_stages</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>
</span><span id="dbpn-124"><a href="#dbpn-124"><span class="linenos">124</span></a>                                                 <span class="n">convolution_kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span>
</span><span id="dbpn-125"><a href="#dbpn-125"><span class="linenos">125</span></a>                                                 <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
</span><span id="dbpn-126"><a href="#dbpn-126"><span class="linenos">126</span></a>                                                 <span class="n">last_convolution</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
</span><span id="dbpn-127"><a href="#dbpn-127"><span class="linenos">127</span></a>                                                 <span class="n">number_of_loss_functions</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="dbpn-128"><a href="#dbpn-128"><span class="linenos">128</span></a>                                                 <span class="n">interpolation</span> <span class="o">=</span> <span class="s1">&#39;nearest&#39;</span>
</span><span id="dbpn-129"><a href="#dbpn-129"><span class="linenos">129</span></a>                                                <span class="p">):</span>
</span><span id="dbpn-130"><a href="#dbpn-130"><span class="linenos">130</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="dbpn-131"><a href="#dbpn-131"><span class="linenos">131</span></a><span class="sd">    Creates a Deep Back-Projection Network (DBPN) for single image super-resolution.</span>
</span><span id="dbpn-132"><a href="#dbpn-132"><span class="linenos">132</span></a>
</span><span id="dbpn-133"><a href="#dbpn-133"><span class="linenos">133</span></a><span class="sd">    This function constructs a Keras model based on the DBPN architecture, which</span>
</span><span id="dbpn-134"><a href="#dbpn-134"><span class="linenos">134</span></a><span class="sd">    can be configured for either 2D or 3D inputs. The network uses iterative</span>
</span><span id="dbpn-135"><a href="#dbpn-135"><span class="linenos">135</span></a><span class="sd">    up- and down-projection blocks to refine the high-resolution image estimate. A</span>
</span><span id="dbpn-136"><a href="#dbpn-136"><span class="linenos">136</span></a><span class="sd">    key modification from the original paper is the option to use standard</span>
</span><span id="dbpn-137"><a href="#dbpn-137"><span class="linenos">137</span></a><span class="sd">    interpolation for upsampling instead of deconvolution layers.</span>
</span><span id="dbpn-138"><a href="#dbpn-138"><span class="linenos">138</span></a>
</span><span id="dbpn-139"><a href="#dbpn-139"><span class="linenos">139</span></a><span class="sd">    Reference:</span>
</span><span id="dbpn-140"><a href="#dbpn-140"><span class="linenos">140</span></a><span class="sd">     - Haris, M., Shakhnarovich, G., &amp; Ukita, N. (2018). Deep Back-Projection</span>
</span><span id="dbpn-141"><a href="#dbpn-141"><span class="linenos">141</span></a><span class="sd">       Networks For Super-Resolution. In CVPR.</span>
</span><span id="dbpn-142"><a href="#dbpn-142"><span class="linenos">142</span></a>
</span><span id="dbpn-143"><a href="#dbpn-143"><span class="linenos">143</span></a><span class="sd">    Parameters</span>
</span><span id="dbpn-144"><a href="#dbpn-144"><span class="linenos">144</span></a><span class="sd">    ----------</span>
</span><span id="dbpn-145"><a href="#dbpn-145"><span class="linenos">145</span></a><span class="sd">    input_image_size : tuple or list</span>
</span><span id="dbpn-146"><a href="#dbpn-146"><span class="linenos">146</span></a><span class="sd">        The shape of the input image, including the channel.</span>
</span><span id="dbpn-147"><a href="#dbpn-147"><span class="linenos">147</span></a><span class="sd">        e.g., `(None, None, 1)` for 2D or `(None, None, None, 1)` for 3D.</span>
</span><span id="dbpn-148"><a href="#dbpn-148"><span class="linenos">148</span></a>
</span><span id="dbpn-149"><a href="#dbpn-149"><span class="linenos">149</span></a><span class="sd">    number_of_outputs : int, optional</span>
</span><span id="dbpn-150"><a href="#dbpn-150"><span class="linenos">150</span></a><span class="sd">        The number of channels in the output image. Default is 1.</span>
</span><span id="dbpn-151"><a href="#dbpn-151"><span class="linenos">151</span></a>
</span><span id="dbpn-152"><a href="#dbpn-152"><span class="linenos">152</span></a><span class="sd">    number_of_base_filters : int, optional</span>
</span><span id="dbpn-153"><a href="#dbpn-153"><span class="linenos">153</span></a><span class="sd">        The number of filters in the up/down projection blocks. Default is 64.</span>
</span><span id="dbpn-154"><a href="#dbpn-154"><span class="linenos">154</span></a>
</span><span id="dbpn-155"><a href="#dbpn-155"><span class="linenos">155</span></a><span class="sd">    number_of_feature_filters : int, optional</span>
</span><span id="dbpn-156"><a href="#dbpn-156"><span class="linenos">156</span></a><span class="sd">        The number of filters in the initial feature extraction layer. Default is 256.</span>
</span><span id="dbpn-157"><a href="#dbpn-157"><span class="linenos">157</span></a>
</span><span id="dbpn-158"><a href="#dbpn-158"><span class="linenos">158</span></a><span class="sd">    number_of_back_projection_stages : int, optional</span>
</span><span id="dbpn-159"><a href="#dbpn-159"><span class="linenos">159</span></a><span class="sd">        The number of iterative back-projection stages (T in the paper). Default is 7.</span>
</span><span id="dbpn-160"><a href="#dbpn-160"><span class="linenos">160</span></a>
</span><span id="dbpn-161"><a href="#dbpn-161"><span class="linenos">161</span></a><span class="sd">    convolution_kernel_size : tuple or list, optional</span>
</span><span id="dbpn-162"><a href="#dbpn-162"><span class="linenos">162</span></a><span class="sd">        The kernel size for the main projection convolutions. Should match the</span>
</span><span id="dbpn-163"><a href="#dbpn-163"><span class="linenos">163</span></a><span class="sd">        dimensionality of the input. Default is (12, 12).</span>
</span><span id="dbpn-164"><a href="#dbpn-164"><span class="linenos">164</span></a>
</span><span id="dbpn-165"><a href="#dbpn-165"><span class="linenos">165</span></a><span class="sd">    strides : tuple or list, optional</span>
</span><span id="dbpn-166"><a href="#dbpn-166"><span class="linenos">166</span></a><span class="sd">        The strides for the up/down sampling operations, defining the</span>
</span><span id="dbpn-167"><a href="#dbpn-167"><span class="linenos">167</span></a><span class="sd">        super-resolution factor. Default is (8, 8).</span>
</span><span id="dbpn-168"><a href="#dbpn-168"><span class="linenos">168</span></a>
</span><span id="dbpn-169"><a href="#dbpn-169"><span class="linenos">169</span></a><span class="sd">    last_convolution : tuple or list, optional</span>
</span><span id="dbpn-170"><a href="#dbpn-170"><span class="linenos">170</span></a><span class="sd">        The kernel size of the final reconstruction convolution. Default is (3, 3).</span>
</span><span id="dbpn-171"><a href="#dbpn-171"><span class="linenos">171</span></a>
</span><span id="dbpn-172"><a href="#dbpn-172"><span class="linenos">172</span></a><span class="sd">    number_of_loss_functions : int, optional</span>
</span><span id="dbpn-173"><a href="#dbpn-173"><span class="linenos">173</span></a><span class="sd">        If greater than 1, the model will have multiple identical output branches.</span>
</span><span id="dbpn-174"><a href="#dbpn-174"><span class="linenos">174</span></a><span class="sd">        Typically set to 1. Default is 1.</span>
</span><span id="dbpn-175"><a href="#dbpn-175"><span class="linenos">175</span></a>
</span><span id="dbpn-176"><a href="#dbpn-176"><span class="linenos">176</span></a><span class="sd">    interpolation : str, optional</span>
</span><span id="dbpn-177"><a href="#dbpn-177"><span class="linenos">177</span></a><span class="sd">        The interpolation method to use for upsampling layers if not using</span>
</span><span id="dbpn-178"><a href="#dbpn-178"><span class="linenos">178</span></a><span class="sd">        transposed convolutions. &#39;nearest&#39; or &#39;bilinear&#39;. Default is &#39;nearest&#39;.</span>
</span><span id="dbpn-179"><a href="#dbpn-179"><span class="linenos">179</span></a>
</span><span id="dbpn-180"><a href="#dbpn-180"><span class="linenos">180</span></a><span class="sd">    Returns</span>
</span><span id="dbpn-181"><a href="#dbpn-181"><span class="linenos">181</span></a><span class="sd">    -------</span>
</span><span id="dbpn-182"><a href="#dbpn-182"><span class="linenos">182</span></a><span class="sd">    keras.Model</span>
</span><span id="dbpn-183"><a href="#dbpn-183"><span class="linenos">183</span></a><span class="sd">        A Keras model implementing the DBPN architecture for the specified</span>
</span><span id="dbpn-184"><a href="#dbpn-184"><span class="linenos">184</span></a><span class="sd">        parameters.</span>
</span><span id="dbpn-185"><a href="#dbpn-185"><span class="linenos">185</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="dbpn-186"><a href="#dbpn-186"><span class="linenos">186</span></a>    <span class="n">idim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span> <span class="n">input_image_size</span> <span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
</span><span id="dbpn-187"><a href="#dbpn-187"><span class="linenos">187</span></a>    <span class="k">if</span> <span class="n">idim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="dbpn-188"><a href="#dbpn-188"><span class="linenos">188</span></a>        <span class="n">myconv</span> <span class="o">=</span> <span class="n">Conv2D</span>
</span><span id="dbpn-189"><a href="#dbpn-189"><span class="linenos">189</span></a>        <span class="n">myconv_transpose</span> <span class="o">=</span> <span class="n">Conv2DTranspose</span>
</span><span id="dbpn-190"><a href="#dbpn-190"><span class="linenos">190</span></a>        <span class="n">myupsampling</span> <span class="o">=</span> <span class="n">UpSampling2D</span>
</span><span id="dbpn-191"><a href="#dbpn-191"><span class="linenos">191</span></a>        <span class="n">shax</span> <span class="o">=</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span> <span class="p">)</span>
</span><span id="dbpn-192"><a href="#dbpn-192"><span class="linenos">192</span></a>        <span class="n">firstConv</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
</span><span id="dbpn-193"><a href="#dbpn-193"><span class="linenos">193</span></a>        <span class="n">firstStrides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span><span id="dbpn-194"><a href="#dbpn-194"><span class="linenos">194</span></a>        <span class="n">smashConv</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span><span id="dbpn-195"><a href="#dbpn-195"><span class="linenos">195</span></a>    <span class="k">if</span> <span class="n">idim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="dbpn-196"><a href="#dbpn-196"><span class="linenos">196</span></a>        <span class="n">myconv</span> <span class="o">=</span> <span class="n">Conv3D</span>
</span><span id="dbpn-197"><a href="#dbpn-197"><span class="linenos">197</span></a>        <span class="n">myconv_transpose</span> <span class="o">=</span> <span class="n">Conv3DTranspose</span>
</span><span id="dbpn-198"><a href="#dbpn-198"><span class="linenos">198</span></a>        <span class="n">myupsampling</span> <span class="o">=</span> <span class="n">UpSampling3D</span>
</span><span id="dbpn-199"><a href="#dbpn-199"><span class="linenos">199</span></a>        <span class="n">shax</span> <span class="o">=</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span> <span class="p">)</span>
</span><span id="dbpn-200"><a href="#dbpn-200"><span class="linenos">200</span></a>        <span class="n">firstConv</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
</span><span id="dbpn-201"><a href="#dbpn-201"><span class="linenos">201</span></a>        <span class="n">firstStrides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span><span id="dbpn-202"><a href="#dbpn-202"><span class="linenos">202</span></a>        <span class="n">smashConv</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span><span id="dbpn-203"><a href="#dbpn-203"><span class="linenos">203</span></a>    <span class="k">def</span> <span class="nf">up_block_2d</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">number_of_filters</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
</span><span id="dbpn-204"><a href="#dbpn-204"><span class="linenos">204</span></a>                    <span class="n">include_dense_convolution_layer</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="dbpn-205"><a href="#dbpn-205"><span class="linenos">205</span></a>        <span class="k">if</span> <span class="n">include_dense_convolution_layer</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="dbpn-206"><a href="#dbpn-206"><span class="linenos">206</span></a>            <span class="n">L</span> <span class="o">=</span> <span class="n">myconv</span><span class="p">(</span><span class="n">filters</span> <span class="o">=</span> <span class="n">number_of_filters</span><span class="p">,</span>
</span><span id="dbpn-207"><a href="#dbpn-207"><span class="linenos">207</span></a>                       <span class="n">use_bias</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="dbpn-208"><a href="#dbpn-208"><span class="linenos">208</span></a>                       <span class="n">kernel_size</span><span class="o">=</span><span class="n">smashConv</span><span class="p">,</span>
</span><span id="dbpn-209"><a href="#dbpn-209"><span class="linenos">209</span></a>                       <span class="n">strides</span><span class="o">=</span><span class="n">firstStrides</span><span class="p">,</span>
</span><span id="dbpn-210"><a href="#dbpn-210"><span class="linenos">210</span></a>                       <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)(</span><span class="n">L</span><span class="p">)</span>
</span><span id="dbpn-211"><a href="#dbpn-211"><span class="linenos">211</span></a>            <span class="n">L</span> <span class="o">=</span> <span class="n">PReLU</span><span class="p">(</span><span class="n">alpha_initializer</span><span class="o">=</span><span class="s1">&#39;zero&#39;</span><span class="p">,</span>
</span><span id="dbpn-212"><a href="#dbpn-212"><span class="linenos">212</span></a>                      <span class="n">shared_axes</span><span class="o">=</span><span class="n">shax</span><span class="p">)(</span><span class="n">L</span><span class="p">)</span>
</span><span id="dbpn-213"><a href="#dbpn-213"><span class="linenos">213</span></a>        <span class="c1"># Scale up</span>
</span><span id="dbpn-214"><a href="#dbpn-214"><span class="linenos">214</span></a>        <span class="k">if</span> <span class="n">idim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="dbpn-215"><a href="#dbpn-215"><span class="linenos">215</span></a>            <span class="n">H0</span> <span class="o">=</span> <span class="n">myupsampling</span><span class="p">(</span> <span class="n">size</span> <span class="o">=</span> <span class="n">strides</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">interpolation</span> <span class="p">)(</span><span class="n">L</span><span class="p">)</span>
</span><span id="dbpn-216"><a href="#dbpn-216"><span class="linenos">216</span></a>        <span class="k">if</span> <span class="n">idim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="dbpn-217"><a href="#dbpn-217"><span class="linenos">217</span></a>            <span class="n">H0</span> <span class="o">=</span> <span class="n">myupsampling</span><span class="p">(</span> <span class="n">size</span> <span class="o">=</span> <span class="n">strides</span> <span class="p">)(</span><span class="n">L</span><span class="p">)</span>
</span><span id="dbpn-218"><a href="#dbpn-218"><span class="linenos">218</span></a>        <span class="n">H0</span> <span class="o">=</span> <span class="n">myconv</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="n">number_of_filters</span><span class="p">,</span>
</span><span id="dbpn-219"><a href="#dbpn-219"><span class="linenos">219</span></a>                    <span class="n">kernel_size</span><span class="o">=</span><span class="n">firstConv</span><span class="p">,</span>
</span><span id="dbpn-220"><a href="#dbpn-220"><span class="linenos">220</span></a>                    <span class="n">strides</span><span class="o">=</span><span class="n">firstStrides</span><span class="p">,</span>
</span><span id="dbpn-221"><a href="#dbpn-221"><span class="linenos">221</span></a>                    <span class="n">use_bias</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="dbpn-222"><a href="#dbpn-222"><span class="linenos">222</span></a>                    <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)(</span><span class="n">H0</span><span class="p">)</span>
</span><span id="dbpn-223"><a href="#dbpn-223"><span class="linenos">223</span></a>        <span class="n">H0</span> <span class="o">=</span> <span class="n">PReLU</span><span class="p">(</span><span class="n">alpha_initializer</span><span class="o">=</span><span class="s1">&#39;zero&#39;</span><span class="p">,</span>
</span><span id="dbpn-224"><a href="#dbpn-224"><span class="linenos">224</span></a>                   <span class="n">shared_axes</span><span class="o">=</span><span class="n">shax</span><span class="p">)(</span><span class="n">H0</span><span class="p">)</span>
</span><span id="dbpn-225"><a href="#dbpn-225"><span class="linenos">225</span></a>        <span class="c1"># Scale down</span>
</span><span id="dbpn-226"><a href="#dbpn-226"><span class="linenos">226</span></a>        <span class="n">L0</span> <span class="o">=</span> <span class="n">myconv</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="n">number_of_filters</span><span class="p">,</span>
</span><span id="dbpn-227"><a href="#dbpn-227"><span class="linenos">227</span></a>                    <span class="n">kernel_size</span><span class="o">=</span><span class="n">kernel_size</span><span class="p">,</span>
</span><span id="dbpn-228"><a href="#dbpn-228"><span class="linenos">228</span></a>                    <span class="n">strides</span><span class="o">=</span><span class="n">strides</span><span class="p">,</span>
</span><span id="dbpn-229"><a href="#dbpn-229"><span class="linenos">229</span></a>                    <span class="n">kernel_initializer</span><span class="o">=</span><span class="s1">&#39;glorot_uniform&#39;</span><span class="p">,</span>
</span><span id="dbpn-230"><a href="#dbpn-230"><span class="linenos">230</span></a>                    <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)(</span><span class="n">H0</span><span class="p">)</span>
</span><span id="dbpn-231"><a href="#dbpn-231"><span class="linenos">231</span></a>        <span class="n">L0</span> <span class="o">=</span> <span class="n">PReLU</span><span class="p">(</span><span class="n">alpha_initializer</span><span class="o">=</span><span class="s1">&#39;zero&#39;</span><span class="p">,</span>
</span><span id="dbpn-232"><a href="#dbpn-232"><span class="linenos">232</span></a>                   <span class="n">shared_axes</span><span class="o">=</span><span class="n">shax</span><span class="p">)(</span><span class="n">L0</span><span class="p">)</span>
</span><span id="dbpn-233"><a href="#dbpn-233"><span class="linenos">233</span></a>        <span class="c1"># Residual</span>
</span><span id="dbpn-234"><a href="#dbpn-234"><span class="linenos">234</span></a>        <span class="n">E</span> <span class="o">=</span> <span class="n">Subtract</span><span class="p">()([</span><span class="n">L0</span><span class="p">,</span> <span class="n">L</span><span class="p">])</span>
</span><span id="dbpn-235"><a href="#dbpn-235"><span class="linenos">235</span></a>        <span class="c1"># Scale residual up</span>
</span><span id="dbpn-236"><a href="#dbpn-236"><span class="linenos">236</span></a>        <span class="k">if</span> <span class="n">idim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="dbpn-237"><a href="#dbpn-237"><span class="linenos">237</span></a>            <span class="n">H1</span> <span class="o">=</span> <span class="n">myupsampling</span><span class="p">(</span> <span class="n">size</span> <span class="o">=</span> <span class="n">strides</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">interpolation</span>  <span class="p">)(</span><span class="n">E</span><span class="p">)</span>
</span><span id="dbpn-238"><a href="#dbpn-238"><span class="linenos">238</span></a>        <span class="k">if</span> <span class="n">idim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="dbpn-239"><a href="#dbpn-239"><span class="linenos">239</span></a>            <span class="n">H1</span> <span class="o">=</span> <span class="n">myupsampling</span><span class="p">(</span> <span class="n">size</span> <span class="o">=</span> <span class="n">strides</span> <span class="p">)(</span><span class="n">E</span><span class="p">)</span>
</span><span id="dbpn-240"><a href="#dbpn-240"><span class="linenos">240</span></a>        <span class="n">H1</span> <span class="o">=</span> <span class="n">myconv</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="n">number_of_filters</span><span class="p">,</span>
</span><span id="dbpn-241"><a href="#dbpn-241"><span class="linenos">241</span></a>                    <span class="n">kernel_size</span><span class="o">=</span><span class="n">firstConv</span><span class="p">,</span>
</span><span id="dbpn-242"><a href="#dbpn-242"><span class="linenos">242</span></a>                    <span class="n">strides</span><span class="o">=</span><span class="n">firstStrides</span><span class="p">,</span>
</span><span id="dbpn-243"><a href="#dbpn-243"><span class="linenos">243</span></a>                    <span class="n">use_bias</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="dbpn-244"><a href="#dbpn-244"><span class="linenos">244</span></a>                    <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)(</span><span class="n">H1</span><span class="p">)</span>
</span><span id="dbpn-245"><a href="#dbpn-245"><span class="linenos">245</span></a>        <span class="n">H1</span> <span class="o">=</span> <span class="n">PReLU</span><span class="p">(</span><span class="n">alpha_initializer</span><span class="o">=</span><span class="s1">&#39;zero&#39;</span><span class="p">,</span>
</span><span id="dbpn-246"><a href="#dbpn-246"><span class="linenos">246</span></a>                   <span class="n">shared_axes</span><span class="o">=</span><span class="n">shax</span><span class="p">)(</span><span class="n">H1</span><span class="p">)</span>
</span><span id="dbpn-247"><a href="#dbpn-247"><span class="linenos">247</span></a>        <span class="c1"># Output feature map</span>
</span><span id="dbpn-248"><a href="#dbpn-248"><span class="linenos">248</span></a>        <span class="n">up_block</span> <span class="o">=</span> <span class="n">Add</span><span class="p">()([</span><span class="n">H0</span><span class="p">,</span> <span class="n">H1</span><span class="p">])</span>
</span><span id="dbpn-249"><a href="#dbpn-249"><span class="linenos">249</span></a>        <span class="k">return</span> <span class="n">up_block</span>
</span><span id="dbpn-250"><a href="#dbpn-250"><span class="linenos">250</span></a>    <span class="k">def</span> <span class="nf">down_block_2d</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">number_of_filters</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
</span><span id="dbpn-251"><a href="#dbpn-251"><span class="linenos">251</span></a>                    <span class="n">include_dense_convolution_layer</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="dbpn-252"><a href="#dbpn-252"><span class="linenos">252</span></a>        <span class="k">if</span> <span class="n">include_dense_convolution_layer</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="dbpn-253"><a href="#dbpn-253"><span class="linenos">253</span></a>            <span class="n">H</span> <span class="o">=</span> <span class="n">myconv</span><span class="p">(</span><span class="n">filters</span> <span class="o">=</span> <span class="n">number_of_filters</span><span class="p">,</span>
</span><span id="dbpn-254"><a href="#dbpn-254"><span class="linenos">254</span></a>                       <span class="n">use_bias</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="dbpn-255"><a href="#dbpn-255"><span class="linenos">255</span></a>                       <span class="n">kernel_size</span><span class="o">=</span><span class="n">smashConv</span><span class="p">,</span>
</span><span id="dbpn-256"><a href="#dbpn-256"><span class="linenos">256</span></a>                       <span class="n">strides</span><span class="o">=</span><span class="n">firstStrides</span><span class="p">,</span>
</span><span id="dbpn-257"><a href="#dbpn-257"><span class="linenos">257</span></a>                       <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)(</span><span class="n">H</span><span class="p">)</span>
</span><span id="dbpn-258"><a href="#dbpn-258"><span class="linenos">258</span></a>            <span class="n">H</span> <span class="o">=</span> <span class="n">PReLU</span><span class="p">(</span><span class="n">alpha_initializer</span><span class="o">=</span><span class="s1">&#39;zero&#39;</span><span class="p">,</span>
</span><span id="dbpn-259"><a href="#dbpn-259"><span class="linenos">259</span></a>                      <span class="n">shared_axes</span><span class="o">=</span><span class="n">shax</span><span class="p">)(</span><span class="n">H</span><span class="p">)</span>
</span><span id="dbpn-260"><a href="#dbpn-260"><span class="linenos">260</span></a>        <span class="c1"># Scale down</span>
</span><span id="dbpn-261"><a href="#dbpn-261"><span class="linenos">261</span></a>        <span class="n">L0</span> <span class="o">=</span> <span class="n">myconv</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="n">number_of_filters</span><span class="p">,</span>
</span><span id="dbpn-262"><a href="#dbpn-262"><span class="linenos">262</span></a>                    <span class="n">kernel_size</span><span class="o">=</span><span class="n">kernel_size</span><span class="p">,</span>
</span><span id="dbpn-263"><a href="#dbpn-263"><span class="linenos">263</span></a>                    <span class="n">strides</span><span class="o">=</span><span class="n">strides</span><span class="p">,</span>
</span><span id="dbpn-264"><a href="#dbpn-264"><span class="linenos">264</span></a>                    <span class="n">kernel_initializer</span><span class="o">=</span><span class="s1">&#39;glorot_uniform&#39;</span><span class="p">,</span>
</span><span id="dbpn-265"><a href="#dbpn-265"><span class="linenos">265</span></a>                    <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)(</span><span class="n">H</span><span class="p">)</span>
</span><span id="dbpn-266"><a href="#dbpn-266"><span class="linenos">266</span></a>        <span class="n">L0</span> <span class="o">=</span> <span class="n">PReLU</span><span class="p">(</span><span class="n">alpha_initializer</span><span class="o">=</span><span class="s1">&#39;zero&#39;</span><span class="p">,</span>
</span><span id="dbpn-267"><a href="#dbpn-267"><span class="linenos">267</span></a>                   <span class="n">shared_axes</span><span class="o">=</span><span class="n">shax</span><span class="p">)(</span><span class="n">L0</span><span class="p">)</span>
</span><span id="dbpn-268"><a href="#dbpn-268"><span class="linenos">268</span></a>        <span class="c1"># Scale up</span>
</span><span id="dbpn-269"><a href="#dbpn-269"><span class="linenos">269</span></a>        <span class="k">if</span> <span class="n">idim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="dbpn-270"><a href="#dbpn-270"><span class="linenos">270</span></a>            <span class="n">H0</span> <span class="o">=</span> <span class="n">myupsampling</span><span class="p">(</span> <span class="n">size</span> <span class="o">=</span> <span class="n">strides</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">interpolation</span> <span class="p">)(</span><span class="n">L0</span><span class="p">)</span>
</span><span id="dbpn-271"><a href="#dbpn-271"><span class="linenos">271</span></a>        <span class="k">if</span> <span class="n">idim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="dbpn-272"><a href="#dbpn-272"><span class="linenos">272</span></a>            <span class="n">H0</span> <span class="o">=</span> <span class="n">myupsampling</span><span class="p">(</span> <span class="n">size</span> <span class="o">=</span> <span class="n">strides</span> <span class="p">)(</span><span class="n">L0</span><span class="p">)</span>
</span><span id="dbpn-273"><a href="#dbpn-273"><span class="linenos">273</span></a>        <span class="n">H0</span> <span class="o">=</span> <span class="n">myconv</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="n">number_of_filters</span><span class="p">,</span>
</span><span id="dbpn-274"><a href="#dbpn-274"><span class="linenos">274</span></a>                    <span class="n">kernel_size</span><span class="o">=</span><span class="n">firstConv</span><span class="p">,</span>
</span><span id="dbpn-275"><a href="#dbpn-275"><span class="linenos">275</span></a>                    <span class="n">strides</span><span class="o">=</span><span class="n">firstStrides</span><span class="p">,</span>
</span><span id="dbpn-276"><a href="#dbpn-276"><span class="linenos">276</span></a>                    <span class="n">use_bias</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="dbpn-277"><a href="#dbpn-277"><span class="linenos">277</span></a>                    <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)(</span><span class="n">H0</span><span class="p">)</span>
</span><span id="dbpn-278"><a href="#dbpn-278"><span class="linenos">278</span></a>        <span class="n">H0</span> <span class="o">=</span> <span class="n">PReLU</span><span class="p">(</span><span class="n">alpha_initializer</span><span class="o">=</span><span class="s1">&#39;zero&#39;</span><span class="p">,</span>
</span><span id="dbpn-279"><a href="#dbpn-279"><span class="linenos">279</span></a>                   <span class="n">shared_axes</span><span class="o">=</span><span class="n">shax</span><span class="p">)(</span><span class="n">H0</span><span class="p">)</span>
</span><span id="dbpn-280"><a href="#dbpn-280"><span class="linenos">280</span></a>        <span class="c1"># Residual</span>
</span><span id="dbpn-281"><a href="#dbpn-281"><span class="linenos">281</span></a>        <span class="n">E</span> <span class="o">=</span> <span class="n">Subtract</span><span class="p">()([</span><span class="n">H0</span><span class="p">,</span> <span class="n">H</span><span class="p">])</span>
</span><span id="dbpn-282"><a href="#dbpn-282"><span class="linenos">282</span></a>        <span class="c1"># Scale residual down</span>
</span><span id="dbpn-283"><a href="#dbpn-283"><span class="linenos">283</span></a>        <span class="n">L1</span> <span class="o">=</span> <span class="n">myconv</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="n">number_of_filters</span><span class="p">,</span>
</span><span id="dbpn-284"><a href="#dbpn-284"><span class="linenos">284</span></a>                    <span class="n">kernel_size</span><span class="o">=</span><span class="n">kernel_size</span><span class="p">,</span>
</span><span id="dbpn-285"><a href="#dbpn-285"><span class="linenos">285</span></a>                    <span class="n">strides</span><span class="o">=</span><span class="n">strides</span><span class="p">,</span>
</span><span id="dbpn-286"><a href="#dbpn-286"><span class="linenos">286</span></a>                    <span class="n">kernel_initializer</span><span class="o">=</span><span class="s1">&#39;glorot_uniform&#39;</span><span class="p">,</span>
</span><span id="dbpn-287"><a href="#dbpn-287"><span class="linenos">287</span></a>                    <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)(</span><span class="n">E</span><span class="p">)</span>
</span><span id="dbpn-288"><a href="#dbpn-288"><span class="linenos">288</span></a>        <span class="n">L1</span> <span class="o">=</span> <span class="n">PReLU</span><span class="p">(</span><span class="n">alpha_initializer</span><span class="o">=</span><span class="s1">&#39;zero&#39;</span><span class="p">,</span>
</span><span id="dbpn-289"><a href="#dbpn-289"><span class="linenos">289</span></a>                   <span class="n">shared_axes</span><span class="o">=</span><span class="n">shax</span><span class="p">)(</span><span class="n">L1</span><span class="p">)</span>
</span><span id="dbpn-290"><a href="#dbpn-290"><span class="linenos">290</span></a>        <span class="c1"># Output feature map</span>
</span><span id="dbpn-291"><a href="#dbpn-291"><span class="linenos">291</span></a>        <span class="n">down_block</span> <span class="o">=</span> <span class="n">Add</span><span class="p">()([</span><span class="n">L0</span><span class="p">,</span> <span class="n">L1</span><span class="p">])</span>
</span><span id="dbpn-292"><a href="#dbpn-292"><span class="linenos">292</span></a>        <span class="k">return</span> <span class="n">down_block</span>
</span><span id="dbpn-293"><a href="#dbpn-293"><span class="linenos">293</span></a>    <span class="n">inputs</span> <span class="o">=</span> <span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">input_image_size</span><span class="p">)</span>
</span><span id="dbpn-294"><a href="#dbpn-294"><span class="linenos">294</span></a>    <span class="c1"># Initial feature extraction</span>
</span><span id="dbpn-295"><a href="#dbpn-295"><span class="linenos">295</span></a>    <span class="n">model</span> <span class="o">=</span> <span class="n">myconv</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="n">number_of_feature_filters</span><span class="p">,</span>
</span><span id="dbpn-296"><a href="#dbpn-296"><span class="linenos">296</span></a>                   <span class="n">kernel_size</span><span class="o">=</span><span class="n">firstConv</span><span class="p">,</span>
</span><span id="dbpn-297"><a href="#dbpn-297"><span class="linenos">297</span></a>                   <span class="n">strides</span><span class="o">=</span><span class="n">firstStrides</span><span class="p">,</span>
</span><span id="dbpn-298"><a href="#dbpn-298"><span class="linenos">298</span></a>                   <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span>
</span><span id="dbpn-299"><a href="#dbpn-299"><span class="linenos">299</span></a>                   <span class="n">kernel_initializer</span><span class="o">=</span><span class="s1">&#39;glorot_uniform&#39;</span><span class="p">)(</span><span class="n">inputs</span><span class="p">)</span>
</span><span id="dbpn-300"><a href="#dbpn-300"><span class="linenos">300</span></a>    <span class="n">model</span> <span class="o">=</span> <span class="n">PReLU</span><span class="p">(</span><span class="n">alpha_initializer</span><span class="o">=</span><span class="s1">&#39;zero&#39;</span><span class="p">,</span>
</span><span id="dbpn-301"><a href="#dbpn-301"><span class="linenos">301</span></a>                  <span class="n">shared_axes</span><span class="o">=</span><span class="n">shax</span><span class="p">)(</span><span class="n">model</span><span class="p">)</span>
</span><span id="dbpn-302"><a href="#dbpn-302"><span class="linenos">302</span></a>    <span class="c1"># Feature smashing</span>
</span><span id="dbpn-303"><a href="#dbpn-303"><span class="linenos">303</span></a>    <span class="n">model</span> <span class="o">=</span> <span class="n">myconv</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="n">number_of_base_filters</span><span class="p">,</span>
</span><span id="dbpn-304"><a href="#dbpn-304"><span class="linenos">304</span></a>                   <span class="n">kernel_size</span><span class="o">=</span><span class="n">smashConv</span><span class="p">,</span>
</span><span id="dbpn-305"><a href="#dbpn-305"><span class="linenos">305</span></a>                   <span class="n">strides</span><span class="o">=</span><span class="n">firstStrides</span><span class="p">,</span>
</span><span id="dbpn-306"><a href="#dbpn-306"><span class="linenos">306</span></a>                   <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span>
</span><span id="dbpn-307"><a href="#dbpn-307"><span class="linenos">307</span></a>                   <span class="n">kernel_initializer</span><span class="o">=</span><span class="s1">&#39;glorot_uniform&#39;</span><span class="p">)(</span><span class="n">model</span><span class="p">)</span>
</span><span id="dbpn-308"><a href="#dbpn-308"><span class="linenos">308</span></a>    <span class="n">model</span> <span class="o">=</span> <span class="n">PReLU</span><span class="p">(</span><span class="n">alpha_initializer</span><span class="o">=</span><span class="s1">&#39;zero&#39;</span><span class="p">,</span>
</span><span id="dbpn-309"><a href="#dbpn-309"><span class="linenos">309</span></a>                  <span class="n">shared_axes</span><span class="o">=</span><span class="n">shax</span><span class="p">)(</span><span class="n">model</span><span class="p">)</span>
</span><span id="dbpn-310"><a href="#dbpn-310"><span class="linenos">310</span></a>    <span class="c1"># Back projection</span>
</span><span id="dbpn-311"><a href="#dbpn-311"><span class="linenos">311</span></a>    <span class="n">up_projection_blocks</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="dbpn-312"><a href="#dbpn-312"><span class="linenos">312</span></a>    <span class="n">down_projection_blocks</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="dbpn-313"><a href="#dbpn-313"><span class="linenos">313</span></a>    <span class="n">model</span> <span class="o">=</span> <span class="n">up_block_2d</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">number_of_filters</span><span class="o">=</span><span class="n">number_of_base_filters</span><span class="p">,</span>
</span><span id="dbpn-314"><a href="#dbpn-314"><span class="linenos">314</span></a>      <span class="n">kernel_size</span><span class="o">=</span><span class="n">convolution_kernel_size</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="n">strides</span><span class="p">)</span>
</span><span id="dbpn-315"><a href="#dbpn-315"><span class="linenos">315</span></a>    <span class="n">up_projection_blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</span><span id="dbpn-316"><a href="#dbpn-316"><span class="linenos">316</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_of_back_projection_stages</span><span class="p">):</span>
</span><span id="dbpn-317"><a href="#dbpn-317"><span class="linenos">317</span></a>        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="dbpn-318"><a href="#dbpn-318"><span class="linenos">318</span></a>            <span class="n">model</span> <span class="o">=</span> <span class="n">down_block_2d</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">number_of_filters</span><span class="o">=</span><span class="n">number_of_base_filters</span><span class="p">,</span>
</span><span id="dbpn-319"><a href="#dbpn-319"><span class="linenos">319</span></a>              <span class="n">kernel_size</span><span class="o">=</span><span class="n">convolution_kernel_size</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="n">strides</span><span class="p">)</span>
</span><span id="dbpn-320"><a href="#dbpn-320"><span class="linenos">320</span></a>            <span class="n">down_projection_blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</span><span id="dbpn-321"><a href="#dbpn-321"><span class="linenos">321</span></a>            <span class="n">model</span> <span class="o">=</span> <span class="n">up_block_2d</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">number_of_filters</span><span class="o">=</span><span class="n">number_of_base_filters</span><span class="p">,</span>
</span><span id="dbpn-322"><a href="#dbpn-322"><span class="linenos">322</span></a>              <span class="n">kernel_size</span><span class="o">=</span><span class="n">convolution_kernel_size</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="n">strides</span><span class="p">)</span>
</span><span id="dbpn-323"><a href="#dbpn-323"><span class="linenos">323</span></a>            <span class="n">up_projection_blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</span><span id="dbpn-324"><a href="#dbpn-324"><span class="linenos">324</span></a>            <span class="n">model</span> <span class="o">=</span> <span class="n">Concatenate</span><span class="p">()(</span><span class="n">up_projection_blocks</span><span class="p">)</span>
</span><span id="dbpn-325"><a href="#dbpn-325"><span class="linenos">325</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="dbpn-326"><a href="#dbpn-326"><span class="linenos">326</span></a>            <span class="n">model</span> <span class="o">=</span> <span class="n">down_block_2d</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">number_of_filters</span><span class="o">=</span><span class="n">number_of_base_filters</span><span class="p">,</span>
</span><span id="dbpn-327"><a href="#dbpn-327"><span class="linenos">327</span></a>              <span class="n">kernel_size</span><span class="o">=</span><span class="n">convolution_kernel_size</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="n">strides</span><span class="p">,</span>
</span><span id="dbpn-328"><a href="#dbpn-328"><span class="linenos">328</span></a>              <span class="n">include_dense_convolution_layer</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="dbpn-329"><a href="#dbpn-329"><span class="linenos">329</span></a>            <span class="n">down_projection_blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</span><span id="dbpn-330"><a href="#dbpn-330"><span class="linenos">330</span></a>            <span class="n">model</span> <span class="o">=</span> <span class="n">Concatenate</span><span class="p">()(</span><span class="n">down_projection_blocks</span><span class="p">)</span>
</span><span id="dbpn-331"><a href="#dbpn-331"><span class="linenos">331</span></a>            <span class="n">model</span> <span class="o">=</span> <span class="n">up_block_2d</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">number_of_filters</span><span class="o">=</span><span class="n">number_of_base_filters</span><span class="p">,</span>
</span><span id="dbpn-332"><a href="#dbpn-332"><span class="linenos">332</span></a>              <span class="n">kernel_size</span><span class="o">=</span><span class="n">convolution_kernel_size</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="n">strides</span><span class="p">,</span>
</span><span id="dbpn-333"><a href="#dbpn-333"><span class="linenos">333</span></a>              <span class="n">include_dense_convolution_layer</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="dbpn-334"><a href="#dbpn-334"><span class="linenos">334</span></a>            <span class="n">up_projection_blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</span><span id="dbpn-335"><a href="#dbpn-335"><span class="linenos">335</span></a>            <span class="n">model</span> <span class="o">=</span> <span class="n">Concatenate</span><span class="p">()(</span><span class="n">up_projection_blocks</span><span class="p">)</span>
</span><span id="dbpn-336"><a href="#dbpn-336"><span class="linenos">336</span></a>    <span class="n">outputs</span> <span class="o">=</span> <span class="n">myconv</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="n">number_of_outputs</span><span class="p">,</span>
</span><span id="dbpn-337"><a href="#dbpn-337"><span class="linenos">337</span></a>                     <span class="n">kernel_size</span><span class="o">=</span><span class="n">last_convolution</span><span class="p">,</span>
</span><span id="dbpn-338"><a href="#dbpn-338"><span class="linenos">338</span></a>                     <span class="n">strides</span><span class="o">=</span><span class="n">firstStrides</span><span class="p">,</span>
</span><span id="dbpn-339"><a href="#dbpn-339"><span class="linenos">339</span></a>                     <span class="n">padding</span> <span class="o">=</span> <span class="s1">&#39;same&#39;</span><span class="p">,</span>
</span><span id="dbpn-340"><a href="#dbpn-340"><span class="linenos">340</span></a>                     <span class="n">kernel_initializer</span> <span class="o">=</span> <span class="s2">&quot;glorot_uniform&quot;</span><span class="p">)(</span><span class="n">model</span><span class="p">)</span>
</span><span id="dbpn-341"><a href="#dbpn-341"><span class="linenos">341</span></a>    <span class="k">if</span> <span class="n">number_of_loss_functions</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="dbpn-342"><a href="#dbpn-342"><span class="linenos">342</span></a>        <span class="n">deep_back_projection_network_model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">outputs</span><span class="p">)</span>
</span><span id="dbpn-343"><a href="#dbpn-343"><span class="linenos">343</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="dbpn-344"><a href="#dbpn-344"><span class="linenos">344</span></a>        <span class="n">outputList</span><span class="o">=</span><span class="p">[]</span>
</span><span id="dbpn-345"><a href="#dbpn-345"><span class="linenos">345</span></a>        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_of_loss_functions</span><span class="p">):</span>
</span><span id="dbpn-346"><a href="#dbpn-346"><span class="linenos">346</span></a>            <span class="n">outputList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">outputs</span><span class="p">)</span>
</span><span id="dbpn-347"><a href="#dbpn-347"><span class="linenos">347</span></a>        <span class="n">deep_back_projection_network_model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">outputList</span><span class="p">)</span>
</span><span id="dbpn-348"><a href="#dbpn-348"><span class="linenos">348</span></a>    <span class="k">return</span> <span class="n">deep_back_projection_network_model</span>
</span></pre></div>


            <div class="docstring"><p>Creates a Deep Back-Projection Network (DBPN) for single image super-resolution.</p>

<p>This function constructs a Keras model based on the DBPN architecture, which
can be configured for either 2D or 3D inputs. The network uses iterative
up- and down-projection blocks to refine the high-resolution image estimate. A
key modification from the original paper is the option to use standard
interpolation for upsampling instead of deconvolution layers.</p>

<p>Reference:</p>

<ul>
<li>Haris, M., Shakhnarovich, G., &amp; Ukita, N. (2018). Deep Back-Projection
Networks For Super-Resolution. In CVPR.</li>
</ul>

<h2 id="parameters">Parameters</h2>

<p>input_image_size : tuple or list
    The shape of the input image, including the channel.
    e.g., <code>(None, None, 1)</code> for 2D or <code>(None, None, None, 1)</code> for 3D.</p>

<p>number_of_outputs : int, optional
    The number of channels in the output image. Default is 1.</p>

<p>number_of_base_filters : int, optional
    The number of filters in the up/down projection blocks. Default is 64.</p>

<p>number_of_feature_filters : int, optional
    The number of filters in the initial feature extraction layer. Default is 256.</p>

<p>number_of_back_projection_stages : int, optional
    The number of iterative back-projection stages (T in the paper). Default is 7.</p>

<p>convolution_kernel_size : tuple or list, optional
    The kernel size for the main projection convolutions. Should match the
    dimensionality of the input. Default is (12, 12).</p>

<p>strides : tuple or list, optional
    The strides for the up/down sampling operations, defining the
    super-resolution factor. Default is (8, 8).</p>

<p>last_convolution : tuple or list, optional
    The kernel size of the final reconstruction convolution. Default is (3, 3).</p>

<p>number_of_loss_functions : int, optional
    If greater than 1, the model will have multiple identical output branches.
    Typically set to 1. Default is 1.</p>

<p>interpolation : str, optional
    The interpolation method to use for upsampling layers if not using
    transposed convolutions. 'nearest' or 'bilinear'. Default is 'nearest'.</p>

<h2 id="returns">Returns</h2>

<p>keras.Model
    A Keras model implementing the DBPN architecture for the specified
    parameters.</p>
</div>


                </section>
                <section id="get_random_base_ind">
                            <input id="get_random_base_ind-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_random_base_ind</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">full_dims</span>, </span><span class="param"><span class="n">patchWidth</span>, </span><span class="param"><span class="n">off</span><span class="o">=</span><span class="mi">8</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="get_random_base_ind-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#get_random_base_ind"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="get_random_base_ind-353"><a href="#get_random_base_ind-353"><span class="linenos">353</span></a><span class="k">def</span> <span class="nf">get_random_base_ind</span><span class="p">(</span> <span class="n">full_dims</span><span class="p">,</span> <span class="n">patchWidth</span><span class="p">,</span> <span class="n">off</span><span class="o">=</span><span class="mi">8</span> <span class="p">):</span>
</span><span id="get_random_base_ind-354"><a href="#get_random_base_ind-354"><span class="linenos">354</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="get_random_base_ind-355"><a href="#get_random_base_ind-355"><span class="linenos">355</span></a><span class="sd">    Generates a random top-left corner index for a patch.</span>
</span><span id="get_random_base_ind-356"><a href="#get_random_base_ind-356"><span class="linenos">356</span></a>
</span><span id="get_random_base_ind-357"><a href="#get_random_base_ind-357"><span class="linenos">357</span></a><span class="sd">    This utility function computes a valid starting index (e.g., [x, y, z])</span>
</span><span id="get_random_base_ind-358"><a href="#get_random_base_ind-358"><span class="linenos">358</span></a><span class="sd">    for extracting a patch from a larger volume, ensuring the patch fits entirely</span>
</span><span id="get_random_base_ind-359"><a href="#get_random_base_ind-359"><span class="linenos">359</span></a><span class="sd">    within the volume&#39;s boundaries, accounting for an offset.</span>
</span><span id="get_random_base_ind-360"><a href="#get_random_base_ind-360"><span class="linenos">360</span></a>
</span><span id="get_random_base_ind-361"><a href="#get_random_base_ind-361"><span class="linenos">361</span></a><span class="sd">    Parameters</span>
</span><span id="get_random_base_ind-362"><a href="#get_random_base_ind-362"><span class="linenos">362</span></a><span class="sd">    ----------</span>
</span><span id="get_random_base_ind-363"><a href="#get_random_base_ind-363"><span class="linenos">363</span></a><span class="sd">    full_dims : tuple or list</span>
</span><span id="get_random_base_ind-364"><a href="#get_random_base_ind-364"><span class="linenos">364</span></a><span class="sd">        The dimensions of the full volume (e.g., img.shape).</span>
</span><span id="get_random_base_ind-365"><a href="#get_random_base_ind-365"><span class="linenos">365</span></a>
</span><span id="get_random_base_ind-366"><a href="#get_random_base_ind-366"><span class="linenos">366</span></a><span class="sd">    patchWidth : tuple or list</span>
</span><span id="get_random_base_ind-367"><a href="#get_random_base_ind-367"><span class="linenos">367</span></a><span class="sd">        The dimensions of the patch to be extracted.</span>
</span><span id="get_random_base_ind-368"><a href="#get_random_base_ind-368"><span class="linenos">368</span></a>
</span><span id="get_random_base_ind-369"><a href="#get_random_base_ind-369"><span class="linenos">369</span></a><span class="sd">    off : int, optional</span>
</span><span id="get_random_base_ind-370"><a href="#get_random_base_ind-370"><span class="linenos">370</span></a><span class="sd">        An offset from the edge of the volume to avoid sampling near borders.</span>
</span><span id="get_random_base_ind-371"><a href="#get_random_base_ind-371"><span class="linenos">371</span></a><span class="sd">        Default is 8.</span>
</span><span id="get_random_base_ind-372"><a href="#get_random_base_ind-372"><span class="linenos">372</span></a>
</span><span id="get_random_base_ind-373"><a href="#get_random_base_ind-373"><span class="linenos">373</span></a><span class="sd">    Returns</span>
</span><span id="get_random_base_ind-374"><a href="#get_random_base_ind-374"><span class="linenos">374</span></a><span class="sd">    -------</span>
</span><span id="get_random_base_ind-375"><a href="#get_random_base_ind-375"><span class="linenos">375</span></a><span class="sd">    list</span>
</span><span id="get_random_base_ind-376"><a href="#get_random_base_ind-376"><span class="linenos">376</span></a><span class="sd">        A list of integers representing the starting coordinates for the patch.</span>
</span><span id="get_random_base_ind-377"><a href="#get_random_base_ind-377"><span class="linenos">377</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="get_random_base_ind-378"><a href="#get_random_base_ind-378"><span class="linenos">378</span></a>    <span class="n">baseInd</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">]</span>
</span><span id="get_random_base_ind-379"><a href="#get_random_base_ind-379"><span class="linenos">379</span></a>    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
</span><span id="get_random_base_ind-380"><a href="#get_random_base_ind-380"><span class="linenos">380</span></a>        <span class="n">baseInd</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">=</span><span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span> <span class="nb">range</span><span class="p">(</span> <span class="n">off</span><span class="p">,</span> <span class="n">full_dims</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">patchWidth</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="p">),</span> <span class="mi">1</span> <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="get_random_base_ind-381"><a href="#get_random_base_ind-381"><span class="linenos">381</span></a>    <span class="k">return</span> <span class="n">baseInd</span>
</span></pre></div>


            <div class="docstring"><p>Generates a random top-left corner index for a patch.</p>

<p>This utility function computes a valid starting index (e.g., [x, y, z])
for extracting a patch from a larger volume, ensuring the patch fits entirely
within the volume's boundaries, accounting for an offset.</p>

<h2 id="parameters">Parameters</h2>

<p>full_dims : tuple or list
    The dimensions of the full volume (e.g., img.shape).</p>

<p>patchWidth : tuple or list
    The dimensions of the patch to be extracted.</p>

<p>off : int, optional
    An offset from the edge of the volume to avoid sampling near borders.
    Default is 8.</p>

<h2 id="returns">Returns</h2>

<p>list
    A list of integers representing the starting coordinates for the patch.</p>
</div>


                </section>
                <section id="get_random_patch">
                            <input id="get_random_patch-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_random_patch</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">img</span>, </span><span class="param"><span class="n">patchWidth</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="get_random_patch-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#get_random_patch"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="get_random_patch-385"><a href="#get_random_patch-385"><span class="linenos">385</span></a><span class="k">def</span> <span class="nf">get_random_patch</span><span class="p">(</span> <span class="n">img</span><span class="p">,</span> <span class="n">patchWidth</span> <span class="p">):</span>
</span><span id="get_random_patch-386"><a href="#get_random_patch-386"><span class="linenos">386</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="get_random_patch-387"><a href="#get_random_patch-387"><span class="linenos">387</span></a><span class="sd">    Extracts a random patch from an image with non-zero variance.</span>
</span><span id="get_random_patch-388"><a href="#get_random_patch-388"><span class="linenos">388</span></a>
</span><span id="get_random_patch-389"><a href="#get_random_patch-389"><span class="linenos">389</span></a><span class="sd">    This function repeatedly samples a random patch of a specified width from</span>
</span><span id="get_random_patch-390"><a href="#get_random_patch-390"><span class="linenos">390</span></a><span class="sd">    the input image until it finds one where the standard deviation of pixel</span>
</span><span id="get_random_patch-391"><a href="#get_random_patch-391"><span class="linenos">391</span></a><span class="sd">    intensities is greater than zero. This is useful for avoiding blank or</span>
</span><span id="get_random_patch-392"><a href="#get_random_patch-392"><span class="linenos">392</span></a><span class="sd">    uniform patches during training data generation.</span>
</span><span id="get_random_patch-393"><a href="#get_random_patch-393"><span class="linenos">393</span></a>
</span><span id="get_random_patch-394"><a href="#get_random_patch-394"><span class="linenos">394</span></a><span class="sd">    Parameters</span>
</span><span id="get_random_patch-395"><a href="#get_random_patch-395"><span class="linenos">395</span></a><span class="sd">    ----------</span>
</span><span id="get_random_patch-396"><a href="#get_random_patch-396"><span class="linenos">396</span></a><span class="sd">    img : ants.ANTsImage</span>
</span><span id="get_random_patch-397"><a href="#get_random_patch-397"><span class="linenos">397</span></a><span class="sd">        The source image from which to extract a patch.</span>
</span><span id="get_random_patch-398"><a href="#get_random_patch-398"><span class="linenos">398</span></a>
</span><span id="get_random_patch-399"><a href="#get_random_patch-399"><span class="linenos">399</span></a><span class="sd">    patchWidth : tuple or list</span>
</span><span id="get_random_patch-400"><a href="#get_random_patch-400"><span class="linenos">400</span></a><span class="sd">        The desired dimensions of the output patch.</span>
</span><span id="get_random_patch-401"><a href="#get_random_patch-401"><span class="linenos">401</span></a>
</span><span id="get_random_patch-402"><a href="#get_random_patch-402"><span class="linenos">402</span></a><span class="sd">    Returns</span>
</span><span id="get_random_patch-403"><a href="#get_random_patch-403"><span class="linenos">403</span></a><span class="sd">    -------</span>
</span><span id="get_random_patch-404"><a href="#get_random_patch-404"><span class="linenos">404</span></a><span class="sd">    ants.ANTsImage</span>
</span><span id="get_random_patch-405"><a href="#get_random_patch-405"><span class="linenos">405</span></a><span class="sd">        A randomly extracted patch from the input image.</span>
</span><span id="get_random_patch-406"><a href="#get_random_patch-406"><span class="linenos">406</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="get_random_patch-407"><a href="#get_random_patch-407"><span class="linenos">407</span></a>    <span class="n">mystd</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="get_random_patch-408"><a href="#get_random_patch-408"><span class="linenos">408</span></a>    <span class="k">while</span> <span class="n">mystd</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="get_random_patch-409"><a href="#get_random_patch-409"><span class="linenos">409</span></a>        <span class="n">inds</span> <span class="o">=</span> <span class="n">get_random_base_ind</span><span class="p">(</span> <span class="n">full_dims</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">patchWidth</span><span class="o">=</span><span class="n">patchWidth</span><span class="p">,</span> <span class="n">off</span><span class="o">=</span><span class="mi">8</span> <span class="p">)</span>
</span><span id="get_random_patch-410"><a href="#get_random_patch-410"><span class="linenos">410</span></a>        <span class="n">hinds</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">]</span>
</span><span id="get_random_patch-411"><a href="#get_random_patch-411"><span class="linenos">411</span></a>        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">inds</span><span class="p">)):</span>
</span><span id="get_random_patch-412"><a href="#get_random_patch-412"><span class="linenos">412</span></a>            <span class="n">hinds</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">inds</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="n">patchWidth</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
</span><span id="get_random_patch-413"><a href="#get_random_patch-413"><span class="linenos">413</span></a>        <span class="n">myimg</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">crop_indices</span><span class="p">(</span> <span class="n">img</span><span class="p">,</span> <span class="n">inds</span><span class="p">,</span> <span class="n">hinds</span> <span class="p">)</span>
</span><span id="get_random_patch-414"><a href="#get_random_patch-414"><span class="linenos">414</span></a>        <span class="n">mystd</span> <span class="o">=</span> <span class="n">myimg</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
</span><span id="get_random_patch-415"><a href="#get_random_patch-415"><span class="linenos">415</span></a>    <span class="k">return</span> <span class="n">myimg</span>
</span></pre></div>


            <div class="docstring"><p>Extracts a random patch from an image with non-zero variance.</p>

<p>This function repeatedly samples a random patch of a specified width from
the input image until it finds one where the standard deviation of pixel
intensities is greater than zero. This is useful for avoiding blank or
uniform patches during training data generation.</p>

<h2 id="parameters">Parameters</h2>

<p>img : ants.ANTsImage
    The source image from which to extract a patch.</p>

<p>patchWidth : tuple or list
    The desired dimensions of the output patch.</p>

<h2 id="returns">Returns</h2>

<p>ants.ANTsImage
    A randomly extracted patch from the input image.</p>
</div>


                </section>
                <section id="get_random_patch_pair">
                            <input id="get_random_patch_pair-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_random_patch_pair</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">img</span>, </span><span class="param"><span class="n">img2</span>, </span><span class="param"><span class="n">patchWidth</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="get_random_patch_pair-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#get_random_patch_pair"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="get_random_patch_pair-417"><a href="#get_random_patch_pair-417"><span class="linenos">417</span></a><span class="k">def</span> <span class="nf">get_random_patch_pair</span><span class="p">(</span> <span class="n">img</span><span class="p">,</span> <span class="n">img2</span><span class="p">,</span> <span class="n">patchWidth</span> <span class="p">):</span>
</span><span id="get_random_patch_pair-418"><a href="#get_random_patch_pair-418"><span class="linenos">418</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="get_random_patch_pair-419"><a href="#get_random_patch_pair-419"><span class="linenos">419</span></a><span class="sd">    Extracts a corresponding random patch from a pair of images.</span>
</span><span id="get_random_patch_pair-420"><a href="#get_random_patch_pair-420"><span class="linenos">420</span></a>
</span><span id="get_random_patch_pair-421"><a href="#get_random_patch_pair-421"><span class="linenos">421</span></a><span class="sd">    This function finds a single random location and extracts a patch of the</span>
</span><span id="get_random_patch_pair-422"><a href="#get_random_patch_pair-422"><span class="linenos">422</span></a><span class="sd">    same size and position from two different input images. It ensures that</span>
</span><span id="get_random_patch_pair-423"><a href="#get_random_patch_pair-423"><span class="linenos">423</span></a><span class="sd">    both extracted patches have non-zero variance. This is useful for creating</span>
</span><span id="get_random_patch_pair-424"><a href="#get_random_patch_pair-424"><span class="linenos">424</span></a><span class="sd">    paired training data (e.g., low-res and high-res images).</span>
</span><span id="get_random_patch_pair-425"><a href="#get_random_patch_pair-425"><span class="linenos">425</span></a>
</span><span id="get_random_patch_pair-426"><a href="#get_random_patch_pair-426"><span class="linenos">426</span></a><span class="sd">    Parameters</span>
</span><span id="get_random_patch_pair-427"><a href="#get_random_patch_pair-427"><span class="linenos">427</span></a><span class="sd">    ----------</span>
</span><span id="get_random_patch_pair-428"><a href="#get_random_patch_pair-428"><span class="linenos">428</span></a><span class="sd">    img : ants.ANTsImage</span>
</span><span id="get_random_patch_pair-429"><a href="#get_random_patch_pair-429"><span class="linenos">429</span></a><span class="sd">        The first source image.</span>
</span><span id="get_random_patch_pair-430"><a href="#get_random_patch_pair-430"><span class="linenos">430</span></a>
</span><span id="get_random_patch_pair-431"><a href="#get_random_patch_pair-431"><span class="linenos">431</span></a><span class="sd">    img2 : ants.ANTsImage</span>
</span><span id="get_random_patch_pair-432"><a href="#get_random_patch_pair-432"><span class="linenos">432</span></a><span class="sd">        The second source image, spatially aligned with the first.</span>
</span><span id="get_random_patch_pair-433"><a href="#get_random_patch_pair-433"><span class="linenos">433</span></a>
</span><span id="get_random_patch_pair-434"><a href="#get_random_patch_pair-434"><span class="linenos">434</span></a><span class="sd">    patchWidth : tuple or list</span>
</span><span id="get_random_patch_pair-435"><a href="#get_random_patch_pair-435"><span class="linenos">435</span></a><span class="sd">        The desired dimensions of the output patches.</span>
</span><span id="get_random_patch_pair-436"><a href="#get_random_patch_pair-436"><span class="linenos">436</span></a>
</span><span id="get_random_patch_pair-437"><a href="#get_random_patch_pair-437"><span class="linenos">437</span></a><span class="sd">    Returns</span>
</span><span id="get_random_patch_pair-438"><a href="#get_random_patch_pair-438"><span class="linenos">438</span></a><span class="sd">    -------</span>
</span><span id="get_random_patch_pair-439"><a href="#get_random_patch_pair-439"><span class="linenos">439</span></a><span class="sd">    tuple of ants.ANTsImage</span>
</span><span id="get_random_patch_pair-440"><a href="#get_random_patch_pair-440"><span class="linenos">440</span></a><span class="sd">        A tuple containing two corresponding patches: (patch_from_img, patch_from_img2).</span>
</span><span id="get_random_patch_pair-441"><a href="#get_random_patch_pair-441"><span class="linenos">441</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="get_random_patch_pair-442"><a href="#get_random_patch_pair-442"><span class="linenos">442</span></a>    <span class="n">mystd</span> <span class="o">=</span> <span class="n">mystd2</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="get_random_patch_pair-443"><a href="#get_random_patch_pair-443"><span class="linenos">443</span></a>    <span class="n">ct</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="get_random_patch_pair-444"><a href="#get_random_patch_pair-444"><span class="linenos">444</span></a>    <span class="k">while</span> <span class="n">mystd</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">mystd2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="get_random_patch_pair-445"><a href="#get_random_patch_pair-445"><span class="linenos">445</span></a>        <span class="n">inds</span> <span class="o">=</span> <span class="n">get_random_base_ind</span><span class="p">(</span> <span class="n">full_dims</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">patchWidth</span><span class="o">=</span><span class="n">patchWidth</span><span class="p">,</span> <span class="n">off</span><span class="o">=</span><span class="mi">8</span>  <span class="p">)</span>
</span><span id="get_random_patch_pair-446"><a href="#get_random_patch_pair-446"><span class="linenos">446</span></a>        <span class="n">hinds</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">]</span>
</span><span id="get_random_patch_pair-447"><a href="#get_random_patch_pair-447"><span class="linenos">447</span></a>        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">inds</span><span class="p">)):</span>
</span><span id="get_random_patch_pair-448"><a href="#get_random_patch_pair-448"><span class="linenos">448</span></a>            <span class="n">hinds</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">inds</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="n">patchWidth</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
</span><span id="get_random_patch_pair-449"><a href="#get_random_patch_pair-449"><span class="linenos">449</span></a>        <span class="n">myimg</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">crop_indices</span><span class="p">(</span> <span class="n">img</span><span class="p">,</span> <span class="n">inds</span><span class="p">,</span> <span class="n">hinds</span> <span class="p">)</span>
</span><span id="get_random_patch_pair-450"><a href="#get_random_patch_pair-450"><span class="linenos">450</span></a>        <span class="n">myimg2</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">crop_indices</span><span class="p">(</span> <span class="n">img2</span><span class="p">,</span> <span class="n">inds</span><span class="p">,</span> <span class="n">hinds</span> <span class="p">)</span>
</span><span id="get_random_patch_pair-451"><a href="#get_random_patch_pair-451"><span class="linenos">451</span></a>        <span class="n">mystd</span> <span class="o">=</span> <span class="n">myimg</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
</span><span id="get_random_patch_pair-452"><a href="#get_random_patch_pair-452"><span class="linenos">452</span></a>        <span class="n">mystd2</span> <span class="o">=</span> <span class="n">myimg2</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
</span><span id="get_random_patch_pair-453"><a href="#get_random_patch_pair-453"><span class="linenos">453</span></a>        <span class="n">ct</span> <span class="o">=</span> <span class="n">ct</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="get_random_patch_pair-454"><a href="#get_random_patch_pair-454"><span class="linenos">454</span></a>        <span class="k">if</span> <span class="p">(</span> <span class="n">ct</span> <span class="o">&gt;</span> <span class="mi">20</span> <span class="p">):</span>
</span><span id="get_random_patch_pair-455"><a href="#get_random_patch_pair-455"><span class="linenos">455</span></a>            <span class="k">return</span> <span class="n">myimg</span><span class="p">,</span> <span class="n">myimg2</span>
</span><span id="get_random_patch_pair-456"><a href="#get_random_patch_pair-456"><span class="linenos">456</span></a>    <span class="k">return</span> <span class="n">myimg</span><span class="p">,</span> <span class="n">myimg2</span>
</span></pre></div>


            <div class="docstring"><p>Extracts a corresponding random patch from a pair of images.</p>

<p>This function finds a single random location and extracts a patch of the
same size and position from two different input images. It ensures that
both extracted patches have non-zero variance. This is useful for creating
paired training data (e.g., low-res and high-res images).</p>

<h2 id="parameters">Parameters</h2>

<p>img : ants.ANTsImage
    The first source image.</p>

<p>img2 : ants.ANTsImage
    The second source image, spatially aligned with the first.</p>

<p>patchWidth : tuple or list
    The desired dimensions of the output patches.</p>

<h2 id="returns">Returns</h2>

<p>tuple of ants.ANTsImage
    A tuple containing two corresponding patches: (patch_from_img, patch_from_img2).</p>
</div>


                </section>
                <section id="pseudo_3d_vgg_features">
                            <input id="pseudo_3d_vgg_features-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">pseudo_3d_vgg_features</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">inshape</span><span class="o">=</span><span class="p">[</span><span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">]</span>,</span><span class="param">	<span class="n">layer</span><span class="o">=</span><span class="mi">4</span>,</span><span class="param">	<span class="n">angle</span><span class="o">=</span><span class="mi">0</span>,</span><span class="param">	<span class="n">pretrained</span><span class="o">=</span><span class="kc">True</span>,</span><span class="param">	<span class="n">verbose</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="pseudo_3d_vgg_features-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#pseudo_3d_vgg_features"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="pseudo_3d_vgg_features-458"><a href="#pseudo_3d_vgg_features-458"><span class="linenos">458</span></a><span class="k">def</span> <span class="nf">pseudo_3d_vgg_features</span><span class="p">(</span> <span class="n">inshape</span> <span class="o">=</span> <span class="p">[</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">],</span> <span class="n">layer</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">pretrained</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span> <span class="p">):</span>
</span><span id="pseudo_3d_vgg_features-459"><a href="#pseudo_3d_vgg_features-459"><span class="linenos">459</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="pseudo_3d_vgg_features-460"><a href="#pseudo_3d_vgg_features-460"><span class="linenos">460</span></a><span class="sd">    Creates a pseudo-3D VGG feature extractor from a pre-trained 2D VGG model.</span>
</span><span id="pseudo_3d_vgg_features-461"><a href="#pseudo_3d_vgg_features-461"><span class="linenos">461</span></a>
</span><span id="pseudo_3d_vgg_features-462"><a href="#pseudo_3d_vgg_features-462"><span class="linenos">462</span></a><span class="sd">    This function constructs a 3D VGG-style network and initializes its weights</span>
</span><span id="pseudo_3d_vgg_features-463"><a href="#pseudo_3d_vgg_features-463"><span class="linenos">463</span></a><span class="sd">    by &quot;stretching&quot; the weights from a pre-trained 2D VGG19 model (trained on</span>
</span><span id="pseudo_3d_vgg_features-464"><a href="#pseudo_3d_vgg_features-464"><span class="linenos">464</span></a><span class="sd">    ImageNet) along a specified axis. This is a technique to transfer 2D</span>
</span><span id="pseudo_3d_vgg_features-465"><a href="#pseudo_3d_vgg_features-465"><span class="linenos">465</span></a><span class="sd">    perceptual knowledge to a 3D domain for tasks like perceptual loss.</span>
</span><span id="pseudo_3d_vgg_features-466"><a href="#pseudo_3d_vgg_features-466"><span class="linenos">466</span></a>
</span><span id="pseudo_3d_vgg_features-467"><a href="#pseudo_3d_vgg_features-467"><span class="linenos">467</span></a><span class="sd">    Parameters</span>
</span><span id="pseudo_3d_vgg_features-468"><a href="#pseudo_3d_vgg_features-468"><span class="linenos">468</span></a><span class="sd">    ----------</span>
</span><span id="pseudo_3d_vgg_features-469"><a href="#pseudo_3d_vgg_features-469"><span class="linenos">469</span></a><span class="sd">    inshape : list of int, optional</span>
</span><span id="pseudo_3d_vgg_features-470"><a href="#pseudo_3d_vgg_features-470"><span class="linenos">470</span></a><span class="sd">        The input shape of the 3D volume, e.g., `[128, 128, 128]`. Default is `[128,128,128]`.</span>
</span><span id="pseudo_3d_vgg_features-471"><a href="#pseudo_3d_vgg_features-471"><span class="linenos">471</span></a>
</span><span id="pseudo_3d_vgg_features-472"><a href="#pseudo_3d_vgg_features-472"><span class="linenos">472</span></a><span class="sd">    layer : int, optional</span>
</span><span id="pseudo_3d_vgg_features-473"><a href="#pseudo_3d_vgg_features-473"><span class="linenos">473</span></a><span class="sd">        The block number of the VGG network from which to extract features. For</span>
</span><span id="pseudo_3d_vgg_features-474"><a href="#pseudo_3d_vgg_features-474"><span class="linenos">474</span></a><span class="sd">        VGG19, this corresponds to block `layer` (e.g., layer=4 means &#39;block4_conv...&#39;).</span>
</span><span id="pseudo_3d_vgg_features-475"><a href="#pseudo_3d_vgg_features-475"><span class="linenos">475</span></a><span class="sd">        Default is 4.</span>
</span><span id="pseudo_3d_vgg_features-476"><a href="#pseudo_3d_vgg_features-476"><span class="linenos">476</span></a>
</span><span id="pseudo_3d_vgg_features-477"><a href="#pseudo_3d_vgg_features-477"><span class="linenos">477</span></a><span class="sd">    angle : int, optional</span>
</span><span id="pseudo_3d_vgg_features-478"><a href="#pseudo_3d_vgg_features-478"><span class="linenos">478</span></a><span class="sd">        The axis along which to project the 2D weights:</span>
</span><span id="pseudo_3d_vgg_features-479"><a href="#pseudo_3d_vgg_features-479"><span class="linenos">479</span></a><span class="sd">        - 0: Axial plane (stretches along Z)</span>
</span><span id="pseudo_3d_vgg_features-480"><a href="#pseudo_3d_vgg_features-480"><span class="linenos">480</span></a><span class="sd">        - 1: Coronal plane (stretches along Y)</span>
</span><span id="pseudo_3d_vgg_features-481"><a href="#pseudo_3d_vgg_features-481"><span class="linenos">481</span></a><span class="sd">        - 2: Sagittal plane (stretches along X)</span>
</span><span id="pseudo_3d_vgg_features-482"><a href="#pseudo_3d_vgg_features-482"><span class="linenos">482</span></a><span class="sd">        Default is 0.</span>
</span><span id="pseudo_3d_vgg_features-483"><a href="#pseudo_3d_vgg_features-483"><span class="linenos">483</span></a>
</span><span id="pseudo_3d_vgg_features-484"><a href="#pseudo_3d_vgg_features-484"><span class="linenos">484</span></a><span class="sd">    pretrained : bool, optional</span>
</span><span id="pseudo_3d_vgg_features-485"><a href="#pseudo_3d_vgg_features-485"><span class="linenos">485</span></a><span class="sd">        If True, loads the stretched ImageNet weights. If False, the model is</span>
</span><span id="pseudo_3d_vgg_features-486"><a href="#pseudo_3d_vgg_features-486"><span class="linenos">486</span></a><span class="sd">        randomly initialized. Default is True.</span>
</span><span id="pseudo_3d_vgg_features-487"><a href="#pseudo_3d_vgg_features-487"><span class="linenos">487</span></a>
</span><span id="pseudo_3d_vgg_features-488"><a href="#pseudo_3d_vgg_features-488"><span class="linenos">488</span></a><span class="sd">    verbose : bool, optional</span>
</span><span id="pseudo_3d_vgg_features-489"><a href="#pseudo_3d_vgg_features-489"><span class="linenos">489</span></a><span class="sd">        If True, prints information about the layers being used. Default is False.</span>
</span><span id="pseudo_3d_vgg_features-490"><a href="#pseudo_3d_vgg_features-490"><span class="linenos">490</span></a>
</span><span id="pseudo_3d_vgg_features-491"><a href="#pseudo_3d_vgg_features-491"><span class="linenos">491</span></a><span class="sd">    Returns</span>
</span><span id="pseudo_3d_vgg_features-492"><a href="#pseudo_3d_vgg_features-492"><span class="linenos">492</span></a><span class="sd">    -------</span>
</span><span id="pseudo_3d_vgg_features-493"><a href="#pseudo_3d_vgg_features-493"><span class="linenos">493</span></a><span class="sd">    tf.keras.Model</span>
</span><span id="pseudo_3d_vgg_features-494"><a href="#pseudo_3d_vgg_features-494"><span class="linenos">494</span></a><span class="sd">        A Keras model that takes a 3D volume as input and outputs the pseudo-3D</span>
</span><span id="pseudo_3d_vgg_features-495"><a href="#pseudo_3d_vgg_features-495"><span class="linenos">495</span></a><span class="sd">        feature map from the specified layer and angle.</span>
</span><span id="pseudo_3d_vgg_features-496"><a href="#pseudo_3d_vgg_features-496"><span class="linenos">496</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="pseudo_3d_vgg_features-497"><a href="#pseudo_3d_vgg_features-497"><span class="linenos">497</span></a>    <span class="k">def</span> <span class="nf">getLayerScaleFactorForTransferLearning</span><span class="p">(</span> <span class="n">k</span><span class="p">,</span> <span class="n">w3d</span><span class="p">,</span> <span class="n">w2d</span> <span class="p">):</span>
</span><span id="pseudo_3d_vgg_features-498"><a href="#pseudo_3d_vgg_features-498"><span class="linenos">498</span></a>        <span class="n">myfact</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span> <span class="n">w3d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span>  <span class="n">w2d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="p">)</span>
</span><span id="pseudo_3d_vgg_features-499"><a href="#pseudo_3d_vgg_features-499"><span class="linenos">499</span></a>        <span class="k">return</span> <span class="n">myfact</span>
</span><span id="pseudo_3d_vgg_features-500"><a href="#pseudo_3d_vgg_features-500"><span class="linenos">500</span></a>    <span class="n">vgg19</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">applications</span><span class="o">.</span><span class="n">VGG19</span><span class="p">(</span>
</span><span id="pseudo_3d_vgg_features-501"><a href="#pseudo_3d_vgg_features-501"><span class="linenos">501</span></a>            <span class="n">include_top</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">weights</span> <span class="o">=</span> <span class="s2">&quot;imagenet&quot;</span><span class="p">,</span>
</span><span id="pseudo_3d_vgg_features-502"><a href="#pseudo_3d_vgg_features-502"><span class="linenos">502</span></a>            <span class="n">input_shape</span> <span class="o">=</span> <span class="p">[</span><span class="n">inshape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">inshape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">3</span><span class="p">],</span>
</span><span id="pseudo_3d_vgg_features-503"><a href="#pseudo_3d_vgg_features-503"><span class="linenos">503</span></a>            <span class="n">classes</span> <span class="o">=</span> <span class="mi">1000</span> <span class="p">)</span>
</span><span id="pseudo_3d_vgg_features-504"><a href="#pseudo_3d_vgg_features-504"><span class="linenos">504</span></a>    <span class="k">def</span> <span class="nf">findLayerIndex</span><span class="p">(</span> <span class="n">layerName</span><span class="p">,</span> <span class="n">mdl</span> <span class="p">):</span>
</span><span id="pseudo_3d_vgg_features-505"><a href="#pseudo_3d_vgg_features-505"><span class="linenos">505</span></a>          <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">mdl</span><span class="o">.</span><span class="n">layers</span> <span class="p">)</span> <span class="p">):</span>
</span><span id="pseudo_3d_vgg_features-506"><a href="#pseudo_3d_vgg_features-506"><span class="linenos">506</span></a>            <span class="k">if</span> <span class="n">layerName</span> <span class="o">==</span> <span class="n">mdl</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">name</span> <span class="p">:</span>
</span><span id="pseudo_3d_vgg_features-507"><a href="#pseudo_3d_vgg_features-507"><span class="linenos">507</span></a>                <span class="k">return</span> <span class="n">k</span> <span class="o">-</span> <span class="mi">1</span>
</span><span id="pseudo_3d_vgg_features-508"><a href="#pseudo_3d_vgg_features-508"><span class="linenos">508</span></a>          <span class="k">return</span> <span class="kc">None</span>
</span><span id="pseudo_3d_vgg_features-509"><a href="#pseudo_3d_vgg_features-509"><span class="linenos">509</span></a>    <span class="n">layer_index</span> <span class="o">=</span> <span class="n">layer</span><span class="o">-</span><span class="mi">1</span> <span class="c1"># findLayerIndex( &#39;block2_conv2&#39;, vgg19 )</span>
</span><span id="pseudo_3d_vgg_features-510"><a href="#pseudo_3d_vgg_features-510"><span class="linenos">510</span></a>    <span class="n">vggmodelRaw</span> <span class="o">=</span> <span class="n">antspynet</span><span class="o">.</span><span class="n">create_vgg_model_3d</span><span class="p">(</span>
</span><span id="pseudo_3d_vgg_features-511"><a href="#pseudo_3d_vgg_features-511"><span class="linenos">511</span></a>            <span class="p">[</span><span class="n">inshape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">inshape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">inshape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="mi">1</span><span class="p">],</span>
</span><span id="pseudo_3d_vgg_features-512"><a href="#pseudo_3d_vgg_features-512"><span class="linenos">512</span></a>            <span class="n">number_of_classification_labels</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
</span><span id="pseudo_3d_vgg_features-513"><a href="#pseudo_3d_vgg_features-513"><span class="linenos">513</span></a>            <span class="n">layers</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span>
</span><span id="pseudo_3d_vgg_features-514"><a href="#pseudo_3d_vgg_features-514"><span class="linenos">514</span></a>            <span class="n">lowest_resolution</span> <span class="o">=</span> <span class="mi">64</span><span class="p">,</span>
</span><span id="pseudo_3d_vgg_features-515"><a href="#pseudo_3d_vgg_features-515"><span class="linenos">515</span></a>            <span class="n">convolution_kernel_size</span><span class="o">=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">pool_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
</span><span id="pseudo_3d_vgg_features-516"><a href="#pseudo_3d_vgg_features-516"><span class="linenos">516</span></a>            <span class="n">strides</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">number_of_dense_units</span><span class="o">=</span> <span class="mi">4096</span><span class="p">,</span> <span class="n">dropout_rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="pseudo_3d_vgg_features-517"><a href="#pseudo_3d_vgg_features-517"><span class="linenos">517</span></a>            <span class="n">style</span> <span class="o">=</span> <span class="mi">19</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;classification&quot;</span><span class="p">)</span>
</span><span id="pseudo_3d_vgg_features-518"><a href="#pseudo_3d_vgg_features-518"><span class="linenos">518</span></a>    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="pseudo_3d_vgg_features-519"><a href="#pseudo_3d_vgg_features-519"><span class="linenos">519</span></a>        <span class="nb">print</span><span class="p">(</span> <span class="n">vggmodelRaw</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">layer_index</span><span class="p">]</span> <span class="p">)</span>
</span><span id="pseudo_3d_vgg_features-520"><a href="#pseudo_3d_vgg_features-520"><span class="linenos">520</span></a>        <span class="nb">print</span><span class="p">(</span> <span class="n">vggmodelRaw</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">layer_index</span><span class="p">]</span><span class="o">.</span><span class="n">name</span> <span class="p">)</span>
</span><span id="pseudo_3d_vgg_features-521"><a href="#pseudo_3d_vgg_features-521"><span class="linenos">521</span></a>        <span class="nb">print</span><span class="p">(</span> <span class="n">vgg19</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">layer_index</span><span class="p">]</span> <span class="p">)</span>
</span><span id="pseudo_3d_vgg_features-522"><a href="#pseudo_3d_vgg_features-522"><span class="linenos">522</span></a>        <span class="nb">print</span><span class="p">(</span> <span class="n">vgg19</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">layer_index</span><span class="p">]</span><span class="o">.</span><span class="n">name</span> <span class="p">)</span>
</span><span id="pseudo_3d_vgg_features-523"><a href="#pseudo_3d_vgg_features-523"><span class="linenos">523</span></a>    <span class="n">feature_extractor_2d</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span>
</span><span id="pseudo_3d_vgg_features-524"><a href="#pseudo_3d_vgg_features-524"><span class="linenos">524</span></a>            <span class="n">inputs</span> <span class="o">=</span> <span class="n">vgg19</span><span class="o">.</span><span class="n">input</span><span class="p">,</span>
</span><span id="pseudo_3d_vgg_features-525"><a href="#pseudo_3d_vgg_features-525"><span class="linenos">525</span></a>            <span class="n">outputs</span> <span class="o">=</span> <span class="n">vgg19</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">layer_index</span><span class="p">]</span><span class="o">.</span><span class="n">output</span><span class="p">)</span>
</span><span id="pseudo_3d_vgg_features-526"><a href="#pseudo_3d_vgg_features-526"><span class="linenos">526</span></a>    <span class="n">feature_extractor</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span>
</span><span id="pseudo_3d_vgg_features-527"><a href="#pseudo_3d_vgg_features-527"><span class="linenos">527</span></a>            <span class="n">inputs</span> <span class="o">=</span> <span class="n">vggmodelRaw</span><span class="o">.</span><span class="n">input</span><span class="p">,</span>
</span><span id="pseudo_3d_vgg_features-528"><a href="#pseudo_3d_vgg_features-528"><span class="linenos">528</span></a>            <span class="n">outputs</span> <span class="o">=</span> <span class="n">vggmodelRaw</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">layer_index</span><span class="p">]</span><span class="o">.</span><span class="n">output</span><span class="p">)</span>
</span><span id="pseudo_3d_vgg_features-529"><a href="#pseudo_3d_vgg_features-529"><span class="linenos">529</span></a>    <span class="n">wts_2d</span> <span class="o">=</span> <span class="n">feature_extractor_2d</span><span class="o">.</span><span class="n">weights</span>
</span><span id="pseudo_3d_vgg_features-530"><a href="#pseudo_3d_vgg_features-530"><span class="linenos">530</span></a>    <span class="n">wts</span> <span class="o">=</span> <span class="n">feature_extractor</span><span class="o">.</span><span class="n">weights</span>
</span><span id="pseudo_3d_vgg_features-531"><a href="#pseudo_3d_vgg_features-531"><span class="linenos">531</span></a>    <span class="k">def</span> <span class="nf">checkwtshape</span><span class="p">(</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="p">):</span>
</span><span id="pseudo_3d_vgg_features-532"><a href="#pseudo_3d_vgg_features-532"><span class="linenos">532</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">):</span>
</span><span id="pseudo_3d_vgg_features-533"><a href="#pseudo_3d_vgg_features-533"><span class="linenos">533</span></a>                <span class="k">return</span> <span class="kc">False</span>
</span><span id="pseudo_3d_vgg_features-534"><a href="#pseudo_3d_vgg_features-534"><span class="linenos">534</span></a>        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">)):</span>
</span><span id="pseudo_3d_vgg_features-535"><a href="#pseudo_3d_vgg_features-535"><span class="linenos">535</span></a>            <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">!=</span> <span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
</span><span id="pseudo_3d_vgg_features-536"><a href="#pseudo_3d_vgg_features-536"><span class="linenos">536</span></a>                <span class="k">return</span> <span class="kc">False</span>
</span><span id="pseudo_3d_vgg_features-537"><a href="#pseudo_3d_vgg_features-537"><span class="linenos">537</span></a>        <span class="k">return</span> <span class="kc">True</span>
</span><span id="pseudo_3d_vgg_features-538"><a href="#pseudo_3d_vgg_features-538"><span class="linenos">538</span></a>    <span class="k">for</span> <span class="n">ww</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">wts</span><span class="p">)):</span>
</span><span id="pseudo_3d_vgg_features-539"><a href="#pseudo_3d_vgg_features-539"><span class="linenos">539</span></a>        <span class="n">wts</span><span class="p">[</span><span class="n">ww</span><span class="p">]</span><span class="o">=</span><span class="n">wts</span><span class="p">[</span><span class="n">ww</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="pseudo_3d_vgg_features-540"><a href="#pseudo_3d_vgg_features-540"><span class="linenos">540</span></a>        <span class="n">wts_2d</span><span class="p">[</span><span class="n">ww</span><span class="p">]</span><span class="o">=</span><span class="n">wts_2d</span><span class="p">[</span><span class="n">ww</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="pseudo_3d_vgg_features-541"><a href="#pseudo_3d_vgg_features-541"><span class="linenos">541</span></a>        <span class="k">if</span> <span class="n">checkwtshape</span><span class="p">(</span> <span class="n">wts</span><span class="p">[</span><span class="n">ww</span><span class="p">],</span> <span class="n">wts_2d</span><span class="p">[</span><span class="n">ww</span><span class="p">]</span> <span class="p">)</span> <span class="ow">and</span> <span class="n">ww</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="pseudo_3d_vgg_features-542"><a href="#pseudo_3d_vgg_features-542"><span class="linenos">542</span></a>            <span class="n">wts</span><span class="p">[</span><span class="n">ww</span><span class="p">]</span><span class="o">=</span><span class="n">wts_2d</span><span class="p">[</span><span class="n">ww</span><span class="p">]</span>
</span><span id="pseudo_3d_vgg_features-543"><a href="#pseudo_3d_vgg_features-543"><span class="linenos">543</span></a>        <span class="k">elif</span> <span class="n">ww</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="pseudo_3d_vgg_features-544"><a href="#pseudo_3d_vgg_features-544"><span class="linenos">544</span></a>            <span class="c1"># FIXME - should allow doing this across different angles</span>
</span><span id="pseudo_3d_vgg_features-545"><a href="#pseudo_3d_vgg_features-545"><span class="linenos">545</span></a>            <span class="k">if</span> <span class="n">angle</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="pseudo_3d_vgg_features-546"><a href="#pseudo_3d_vgg_features-546"><span class="linenos">546</span></a>                <span class="n">wts</span><span class="p">[</span><span class="n">ww</span><span class="p">][:,:,</span><span class="mi">0</span><span class="p">,:,:]</span><span class="o">=</span><span class="n">wts_2d</span><span class="p">[</span><span class="n">ww</span><span class="p">]</span><span class="o">/</span><span class="mf">3.0</span>
</span><span id="pseudo_3d_vgg_features-547"><a href="#pseudo_3d_vgg_features-547"><span class="linenos">547</span></a>                <span class="n">wts</span><span class="p">[</span><span class="n">ww</span><span class="p">][:,:,</span><span class="mi">1</span><span class="p">,:,:]</span><span class="o">=</span><span class="n">wts_2d</span><span class="p">[</span><span class="n">ww</span><span class="p">]</span><span class="o">/</span><span class="mf">3.0</span>
</span><span id="pseudo_3d_vgg_features-548"><a href="#pseudo_3d_vgg_features-548"><span class="linenos">548</span></a>                <span class="n">wts</span><span class="p">[</span><span class="n">ww</span><span class="p">][:,:,</span><span class="mi">2</span><span class="p">,:,:]</span><span class="o">=</span><span class="n">wts_2d</span><span class="p">[</span><span class="n">ww</span><span class="p">]</span><span class="o">/</span><span class="mf">3.0</span>
</span><span id="pseudo_3d_vgg_features-549"><a href="#pseudo_3d_vgg_features-549"><span class="linenos">549</span></a>            <span class="k">if</span> <span class="n">angle</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="pseudo_3d_vgg_features-550"><a href="#pseudo_3d_vgg_features-550"><span class="linenos">550</span></a>                <span class="n">wts</span><span class="p">[</span><span class="n">ww</span><span class="p">][:,</span><span class="mi">0</span><span class="p">,:,:,:]</span><span class="o">=</span><span class="n">wts_2d</span><span class="p">[</span><span class="n">ww</span><span class="p">]</span><span class="o">/</span><span class="mf">3.0</span>
</span><span id="pseudo_3d_vgg_features-551"><a href="#pseudo_3d_vgg_features-551"><span class="linenos">551</span></a>                <span class="n">wts</span><span class="p">[</span><span class="n">ww</span><span class="p">][:,</span><span class="mi">1</span><span class="p">,:,:,:]</span><span class="o">=</span><span class="n">wts_2d</span><span class="p">[</span><span class="n">ww</span><span class="p">]</span><span class="o">/</span><span class="mf">3.0</span>
</span><span id="pseudo_3d_vgg_features-552"><a href="#pseudo_3d_vgg_features-552"><span class="linenos">552</span></a>                <span class="n">wts</span><span class="p">[</span><span class="n">ww</span><span class="p">][:,</span><span class="mi">2</span><span class="p">,:,:,:]</span><span class="o">=</span><span class="n">wts_2d</span><span class="p">[</span><span class="n">ww</span><span class="p">]</span><span class="o">/</span><span class="mf">3.0</span>
</span><span id="pseudo_3d_vgg_features-553"><a href="#pseudo_3d_vgg_features-553"><span class="linenos">553</span></a>            <span class="k">if</span> <span class="n">angle</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="pseudo_3d_vgg_features-554"><a href="#pseudo_3d_vgg_features-554"><span class="linenos">554</span></a>                <span class="n">wts</span><span class="p">[</span><span class="n">ww</span><span class="p">][</span><span class="mi">0</span><span class="p">,:,:,:,:]</span><span class="o">=</span><span class="n">wts_2d</span><span class="p">[</span><span class="n">ww</span><span class="p">]</span><span class="o">/</span><span class="mf">3.0</span>
</span><span id="pseudo_3d_vgg_features-555"><a href="#pseudo_3d_vgg_features-555"><span class="linenos">555</span></a>                <span class="n">wts</span><span class="p">[</span><span class="n">ww</span><span class="p">][</span><span class="mi">1</span><span class="p">,:,:,:,:]</span><span class="o">=</span><span class="n">wts_2d</span><span class="p">[</span><span class="n">ww</span><span class="p">]</span><span class="o">/</span><span class="mf">3.0</span>
</span><span id="pseudo_3d_vgg_features-556"><a href="#pseudo_3d_vgg_features-556"><span class="linenos">556</span></a>                <span class="n">wts</span><span class="p">[</span><span class="n">ww</span><span class="p">][</span><span class="mi">2</span><span class="p">,:,:,:,:]</span><span class="o">=</span><span class="n">wts_2d</span><span class="p">[</span><span class="n">ww</span><span class="p">]</span><span class="o">/</span><span class="mf">3.0</span>
</span><span id="pseudo_3d_vgg_features-557"><a href="#pseudo_3d_vgg_features-557"><span class="linenos">557</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="pseudo_3d_vgg_features-558"><a href="#pseudo_3d_vgg_features-558"><span class="linenos">558</span></a>            <span class="n">wts</span><span class="p">[</span><span class="n">ww</span><span class="p">][:,:,:,</span><span class="mi">0</span><span class="p">,:]</span><span class="o">=</span><span class="n">wts_2d</span><span class="p">[</span><span class="n">ww</span><span class="p">]</span>
</span><span id="pseudo_3d_vgg_features-559"><a href="#pseudo_3d_vgg_features-559"><span class="linenos">559</span></a>    <span class="k">if</span> <span class="n">pretrained</span><span class="p">:</span>
</span><span id="pseudo_3d_vgg_features-560"><a href="#pseudo_3d_vgg_features-560"><span class="linenos">560</span></a>        <span class="n">feature_extractor</span><span class="o">.</span><span class="n">set_weights</span><span class="p">(</span> <span class="n">wts</span> <span class="p">)</span>
</span><span id="pseudo_3d_vgg_features-561"><a href="#pseudo_3d_vgg_features-561"><span class="linenos">561</span></a>        <span class="n">newinput</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Rescaling</span><span class="p">(</span>  <span class="mf">255.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">127.5</span>  <span class="p">)(</span> <span class="n">feature_extractor</span><span class="o">.</span><span class="n">input</span> <span class="p">)</span>
</span><span id="pseudo_3d_vgg_features-562"><a href="#pseudo_3d_vgg_features-562"><span class="linenos">562</span></a>        <span class="n">feature_extractor2</span> <span class="o">=</span> <span class="n">feature_extractor</span><span class="p">(</span> <span class="n">newinput</span> <span class="p">)</span>
</span><span id="pseudo_3d_vgg_features-563"><a href="#pseudo_3d_vgg_features-563"><span class="linenos">563</span></a>        <span class="n">feature_extractor</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span> <span class="n">feature_extractor</span><span class="o">.</span><span class="n">input</span><span class="p">,</span> <span class="n">feature_extractor2</span> <span class="p">)</span>
</span><span id="pseudo_3d_vgg_features-564"><a href="#pseudo_3d_vgg_features-564"><span class="linenos">564</span></a>    <span class="k">return</span> <span class="n">feature_extractor</span>
</span></pre></div>


            <div class="docstring"><p>Creates a pseudo-3D VGG feature extractor from a pre-trained 2D VGG model.</p>

<p>This function constructs a 3D VGG-style network and initializes its weights
by "stretching" the weights from a pre-trained 2D VGG19 model (trained on
ImageNet) along a specified axis. This is a technique to transfer 2D
perceptual knowledge to a 3D domain for tasks like perceptual loss.</p>

<h2 id="parameters">Parameters</h2>

<p>inshape : list of int, optional
    The input shape of the 3D volume, e.g., <code>[128, 128, 128]</code>. Default is <code>[128,128,128]</code>.</p>

<p>layer : int, optional
    The block number of the VGG network from which to extract features. For
    VGG19, this corresponds to block <code>layer</code> (e.g., layer=4 means 'block4_conv...').
    Default is 4.</p>

<p>angle : int, optional
    The axis along which to project the 2D weights:
    - 0: Axial plane (stretches along Z)
    - 1: Coronal plane (stretches along Y)
    - 2: Sagittal plane (stretches along X)
    Default is 0.</p>

<p>pretrained : bool, optional
    If True, loads the stretched ImageNet weights. If False, the model is
    randomly initialized. Default is True.</p>

<p>verbose : bool, optional
    If True, prints information about the layers being used. Default is False.</p>

<h2 id="returns">Returns</h2>

<p>tf.keras.Model
    A Keras model that takes a 3D volume as input and outputs the pseudo-3D
    feature map from the specified layer and angle.</p>
</div>


                </section>
                <section id="pseudo_3d_vgg_features_unbiased">
                            <input id="pseudo_3d_vgg_features_unbiased-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">pseudo_3d_vgg_features_unbiased</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">inshape</span><span class="o">=</span><span class="p">[</span><span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">]</span>, </span><span class="param"><span class="n">layer</span><span class="o">=</span><span class="mi">4</span>, </span><span class="param"><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="pseudo_3d_vgg_features_unbiased-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#pseudo_3d_vgg_features_unbiased"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="pseudo_3d_vgg_features_unbiased-566"><a href="#pseudo_3d_vgg_features_unbiased-566"><span class="linenos">566</span></a><span class="k">def</span> <span class="nf">pseudo_3d_vgg_features_unbiased</span><span class="p">(</span> <span class="n">inshape</span> <span class="o">=</span> <span class="p">[</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">],</span> <span class="n">layer</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span> <span class="p">):</span>
</span><span id="pseudo_3d_vgg_features_unbiased-567"><a href="#pseudo_3d_vgg_features_unbiased-567"><span class="linenos">567</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="pseudo_3d_vgg_features_unbiased-568"><a href="#pseudo_3d_vgg_features_unbiased-568"><span class="linenos">568</span></a><span class="sd">    Create a pseudo-3D VGG-style feature extractor by aggregating axial, coronal,</span>
</span><span id="pseudo_3d_vgg_features_unbiased-569"><a href="#pseudo_3d_vgg_features_unbiased-569"><span class="linenos">569</span></a><span class="sd">    and sagittal VGG feature representations.</span>
</span><span id="pseudo_3d_vgg_features_unbiased-570"><a href="#pseudo_3d_vgg_features_unbiased-570"><span class="linenos">570</span></a>
</span><span id="pseudo_3d_vgg_features_unbiased-571"><a href="#pseudo_3d_vgg_features_unbiased-571"><span class="linenos">571</span></a><span class="sd">    This model extracts features along each principal axis using pre-trained 2D</span>
</span><span id="pseudo_3d_vgg_features_unbiased-572"><a href="#pseudo_3d_vgg_features_unbiased-572"><span class="linenos">572</span></a><span class="sd">    VGG-style networks and concatenates them to form an unbiased pseudo-3D feature space.</span>
</span><span id="pseudo_3d_vgg_features_unbiased-573"><a href="#pseudo_3d_vgg_features_unbiased-573"><span class="linenos">573</span></a>
</span><span id="pseudo_3d_vgg_features_unbiased-574"><a href="#pseudo_3d_vgg_features_unbiased-574"><span class="linenos">574</span></a><span class="sd">    Parameters</span>
</span><span id="pseudo_3d_vgg_features_unbiased-575"><a href="#pseudo_3d_vgg_features_unbiased-575"><span class="linenos">575</span></a><span class="sd">    ----------</span>
</span><span id="pseudo_3d_vgg_features_unbiased-576"><a href="#pseudo_3d_vgg_features_unbiased-576"><span class="linenos">576</span></a><span class="sd">    inshape : list of int, optional</span>
</span><span id="pseudo_3d_vgg_features_unbiased-577"><a href="#pseudo_3d_vgg_features_unbiased-577"><span class="linenos">577</span></a><span class="sd">        The input shape of the 3D volume, default is [128, 128, 128].</span>
</span><span id="pseudo_3d_vgg_features_unbiased-578"><a href="#pseudo_3d_vgg_features_unbiased-578"><span class="linenos">578</span></a>
</span><span id="pseudo_3d_vgg_features_unbiased-579"><a href="#pseudo_3d_vgg_features_unbiased-579"><span class="linenos">579</span></a><span class="sd">    layer : int, optional</span>
</span><span id="pseudo_3d_vgg_features_unbiased-580"><a href="#pseudo_3d_vgg_features_unbiased-580"><span class="linenos">580</span></a><span class="sd">        The VGG feature layer to extract. Higher values correspond to deeper</span>
</span><span id="pseudo_3d_vgg_features_unbiased-581"><a href="#pseudo_3d_vgg_features_unbiased-581"><span class="linenos">581</span></a><span class="sd">        layers in the pseudo-3D VGG backbone.</span>
</span><span id="pseudo_3d_vgg_features_unbiased-582"><a href="#pseudo_3d_vgg_features_unbiased-582"><span class="linenos">582</span></a>
</span><span id="pseudo_3d_vgg_features_unbiased-583"><a href="#pseudo_3d_vgg_features_unbiased-583"><span class="linenos">583</span></a><span class="sd">    verbose : bool, optional</span>
</span><span id="pseudo_3d_vgg_features_unbiased-584"><a href="#pseudo_3d_vgg_features_unbiased-584"><span class="linenos">584</span></a><span class="sd">        If True, prints debug messages during model construction.</span>
</span><span id="pseudo_3d_vgg_features_unbiased-585"><a href="#pseudo_3d_vgg_features_unbiased-585"><span class="linenos">585</span></a>
</span><span id="pseudo_3d_vgg_features_unbiased-586"><a href="#pseudo_3d_vgg_features_unbiased-586"><span class="linenos">586</span></a><span class="sd">    Returns</span>
</span><span id="pseudo_3d_vgg_features_unbiased-587"><a href="#pseudo_3d_vgg_features_unbiased-587"><span class="linenos">587</span></a><span class="sd">    -------</span>
</span><span id="pseudo_3d_vgg_features_unbiased-588"><a href="#pseudo_3d_vgg_features_unbiased-588"><span class="linenos">588</span></a><span class="sd">    tf.keras.Model</span>
</span><span id="pseudo_3d_vgg_features_unbiased-589"><a href="#pseudo_3d_vgg_features_unbiased-589"><span class="linenos">589</span></a><span class="sd">        A TensorFlow Keras model that takes a 3D input volume and outputs the</span>
</span><span id="pseudo_3d_vgg_features_unbiased-590"><a href="#pseudo_3d_vgg_features_unbiased-590"><span class="linenos">590</span></a><span class="sd">        concatenated pseudo-3D feature representation from the specified layer.</span>
</span><span id="pseudo_3d_vgg_features_unbiased-591"><a href="#pseudo_3d_vgg_features_unbiased-591"><span class="linenos">591</span></a>
</span><span id="pseudo_3d_vgg_features_unbiased-592"><a href="#pseudo_3d_vgg_features_unbiased-592"><span class="linenos">592</span></a><span class="sd">    Notes</span>
</span><span id="pseudo_3d_vgg_features_unbiased-593"><a href="#pseudo_3d_vgg_features_unbiased-593"><span class="linenos">593</span></a><span class="sd">    -----</span>
</span><span id="pseudo_3d_vgg_features_unbiased-594"><a href="#pseudo_3d_vgg_features_unbiased-594"><span class="linenos">594</span></a><span class="sd">    This is useful for perceptual loss or feature comparison in super-resolution</span>
</span><span id="pseudo_3d_vgg_features_unbiased-595"><a href="#pseudo_3d_vgg_features_unbiased-595"><span class="linenos">595</span></a><span class="sd">    and image synthesis tasks. The same input is processed in three anatomical</span>
</span><span id="pseudo_3d_vgg_features_unbiased-596"><a href="#pseudo_3d_vgg_features_unbiased-596"><span class="linenos">596</span></a><span class="sd">    planes (axial, coronal, sagittal), and features are concatenated.</span>
</span><span id="pseudo_3d_vgg_features_unbiased-597"><a href="#pseudo_3d_vgg_features_unbiased-597"><span class="linenos">597</span></a>
</span><span id="pseudo_3d_vgg_features_unbiased-598"><a href="#pseudo_3d_vgg_features_unbiased-598"><span class="linenos">598</span></a><span class="sd">    See Also</span>
</span><span id="pseudo_3d_vgg_features_unbiased-599"><a href="#pseudo_3d_vgg_features_unbiased-599"><span class="linenos">599</span></a><span class="sd">    --------</span>
</span><span id="pseudo_3d_vgg_features_unbiased-600"><a href="#pseudo_3d_vgg_features_unbiased-600"><span class="linenos">600</span></a><span class="sd">    pseudo_3d_vgg_features : Generates VGG features from a single anatomical plane.</span>
</span><span id="pseudo_3d_vgg_features_unbiased-601"><a href="#pseudo_3d_vgg_features_unbiased-601"><span class="linenos">601</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="pseudo_3d_vgg_features_unbiased-602"><a href="#pseudo_3d_vgg_features_unbiased-602"><span class="linenos">602</span></a>    <span class="n">f</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="pseudo_3d_vgg_features_unbiased-603"><a href="#pseudo_3d_vgg_features_unbiased-603"><span class="linenos">603</span></a>        <span class="n">pseudo_3d_vgg_features</span><span class="p">(</span> <span class="n">inshape</span><span class="p">,</span> <span class="n">layer</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">pretrained</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span> <span class="p">),</span>
</span><span id="pseudo_3d_vgg_features_unbiased-604"><a href="#pseudo_3d_vgg_features_unbiased-604"><span class="linenos">604</span></a>        <span class="n">pseudo_3d_vgg_features</span><span class="p">(</span> <span class="n">inshape</span><span class="p">,</span> <span class="n">layer</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">pretrained</span><span class="o">=</span><span class="kc">True</span> <span class="p">),</span>
</span><span id="pseudo_3d_vgg_features_unbiased-605"><a href="#pseudo_3d_vgg_features_unbiased-605"><span class="linenos">605</span></a>        <span class="n">pseudo_3d_vgg_features</span><span class="p">(</span> <span class="n">inshape</span><span class="p">,</span> <span class="n">layer</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">pretrained</span><span class="o">=</span><span class="kc">True</span> <span class="p">)</span> <span class="p">]</span>
</span><span id="pseudo_3d_vgg_features_unbiased-606"><a href="#pseudo_3d_vgg_features_unbiased-606"><span class="linenos">606</span></a>    <span class="n">f1</span><span class="o">=</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">inputs</span>
</span><span id="pseudo_3d_vgg_features_unbiased-607"><a href="#pseudo_3d_vgg_features_unbiased-607"><span class="linenos">607</span></a>    <span class="n">f0o</span><span class="o">=</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">](</span> <span class="n">f1</span> <span class="p">)</span>
</span><span id="pseudo_3d_vgg_features_unbiased-608"><a href="#pseudo_3d_vgg_features_unbiased-608"><span class="linenos">608</span></a>    <span class="n">f1o</span><span class="o">=</span><span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">](</span> <span class="n">f1</span> <span class="p">)</span>
</span><span id="pseudo_3d_vgg_features_unbiased-609"><a href="#pseudo_3d_vgg_features_unbiased-609"><span class="linenos">609</span></a>    <span class="n">f2o</span><span class="o">=</span><span class="n">f</span><span class="p">[</span><span class="mi">2</span><span class="p">](</span> <span class="n">f1</span> <span class="p">)</span>
</span><span id="pseudo_3d_vgg_features_unbiased-610"><a href="#pseudo_3d_vgg_features_unbiased-610"><span class="linenos">610</span></a>    <span class="n">catter</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span> <span class="p">[</span><span class="n">f0o</span><span class="p">,</span> <span class="n">f1o</span><span class="p">,</span> <span class="n">f2o</span> <span class="p">])</span>
</span><span id="pseudo_3d_vgg_features_unbiased-611"><a href="#pseudo_3d_vgg_features_unbiased-611"><span class="linenos">611</span></a>    <span class="n">feature_extractor</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span> <span class="n">f1</span><span class="p">,</span> <span class="n">catter</span> <span class="p">)</span>
</span><span id="pseudo_3d_vgg_features_unbiased-612"><a href="#pseudo_3d_vgg_features_unbiased-612"><span class="linenos">612</span></a>    <span class="k">return</span> <span class="n">feature_extractor</span>
</span></pre></div>


            <div class="docstring"><p>Create a pseudo-3D VGG-style feature extractor by aggregating axial, coronal,
and sagittal VGG feature representations.</p>

<p>This model extracts features along each principal axis using pre-trained 2D
VGG-style networks and concatenates them to form an unbiased pseudo-3D feature space.</p>

<h2 id="parameters">Parameters</h2>

<p>inshape : list of int, optional
    The input shape of the 3D volume, default is [128, 128, 128].</p>

<p>layer : int, optional
    The VGG feature layer to extract. Higher values correspond to deeper
    layers in the pseudo-3D VGG backbone.</p>

<p>verbose : bool, optional
    If True, prints debug messages during model construction.</p>

<h2 id="returns">Returns</h2>

<p>tf.keras.Model
    A TensorFlow Keras model that takes a 3D input volume and outputs the
    concatenated pseudo-3D feature representation from the specified layer.</p>

<h2 id="notes">Notes</h2>

<p>This is useful for perceptual loss or feature comparison in super-resolution
and image synthesis tasks. The same input is processed in three anatomical
planes (axial, coronal, sagittal), and features are concatenated.</p>

<h2 id="see-also">See Also</h2>

<p>pseudo_3d_vgg_features : Generates VGG features from a single anatomical plane.</p>
</div>


                </section>
                <section id="get_grader_feature_network">
                            <input id="get_grader_feature_network-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_grader_feature_network</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">layer</span><span class="o">=</span><span class="mi">6</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="get_grader_feature_network-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#get_grader_feature_network"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="get_grader_feature_network-614"><a href="#get_grader_feature_network-614"><span class="linenos">614</span></a><span class="k">def</span> <span class="nf">get_grader_feature_network</span><span class="p">(</span> <span class="n">layer</span><span class="o">=</span><span class="mi">6</span> <span class="p">):</span>
</span><span id="get_grader_feature_network-615"><a href="#get_grader_feature_network-615"><span class="linenos">615</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="get_grader_feature_network-616"><a href="#get_grader_feature_network-616"><span class="linenos">616</span></a><span class="sd">    Load and extract a ResNet-based feature subnetwork for perceptual loss or quality grading.</span>
</span><span id="get_grader_feature_network-617"><a href="#get_grader_feature_network-617"><span class="linenos">617</span></a>
</span><span id="get_grader_feature_network-618"><a href="#get_grader_feature_network-618"><span class="linenos">618</span></a><span class="sd">    This function loads a pre-trained 3D ResNet model (&quot;grader&quot;) used for</span>
</span><span id="get_grader_feature_network-619"><a href="#get_grader_feature_network-619"><span class="linenos">619</span></a><span class="sd">    perceptual feature extraction and returns a subnetwork that outputs activations</span>
</span><span id="get_grader_feature_network-620"><a href="#get_grader_feature_network-620"><span class="linenos">620</span></a><span class="sd">    from a specified internal layer.</span>
</span><span id="get_grader_feature_network-621"><a href="#get_grader_feature_network-621"><span class="linenos">621</span></a>
</span><span id="get_grader_feature_network-622"><a href="#get_grader_feature_network-622"><span class="linenos">622</span></a><span class="sd">    Parameters</span>
</span><span id="get_grader_feature_network-623"><a href="#get_grader_feature_network-623"><span class="linenos">623</span></a><span class="sd">    ----------</span>
</span><span id="get_grader_feature_network-624"><a href="#get_grader_feature_network-624"><span class="linenos">624</span></a><span class="sd">    layer : int, optional</span>
</span><span id="get_grader_feature_network-625"><a href="#get_grader_feature_network-625"><span class="linenos">625</span></a><span class="sd">        The index of the internal ResNet layer whose output should be used as</span>
</span><span id="get_grader_feature_network-626"><a href="#get_grader_feature_network-626"><span class="linenos">626</span></a><span class="sd">        the feature representation. Default is layer 6.</span>
</span><span id="get_grader_feature_network-627"><a href="#get_grader_feature_network-627"><span class="linenos">627</span></a>
</span><span id="get_grader_feature_network-628"><a href="#get_grader_feature_network-628"><span class="linenos">628</span></a><span class="sd">    Returns</span>
</span><span id="get_grader_feature_network-629"><a href="#get_grader_feature_network-629"><span class="linenos">629</span></a><span class="sd">    -------</span>
</span><span id="get_grader_feature_network-630"><a href="#get_grader_feature_network-630"><span class="linenos">630</span></a><span class="sd">    tf.keras.Model</span>
</span><span id="get_grader_feature_network-631"><a href="#get_grader_feature_network-631"><span class="linenos">631</span></a><span class="sd">        A Keras model that outputs features from the specified layer of the</span>
</span><span id="get_grader_feature_network-632"><a href="#get_grader_feature_network-632"><span class="linenos">632</span></a><span class="sd">        pre-trained 3D ResNet grader model.</span>
</span><span id="get_grader_feature_network-633"><a href="#get_grader_feature_network-633"><span class="linenos">633</span></a>
</span><span id="get_grader_feature_network-634"><a href="#get_grader_feature_network-634"><span class="linenos">634</span></a><span class="sd">    Raises</span>
</span><span id="get_grader_feature_network-635"><a href="#get_grader_feature_network-635"><span class="linenos">635</span></a><span class="sd">    ------</span>
</span><span id="get_grader_feature_network-636"><a href="#get_grader_feature_network-636"><span class="linenos">636</span></a><span class="sd">    Exception</span>
</span><span id="get_grader_feature_network-637"><a href="#get_grader_feature_network-637"><span class="linenos">637</span></a><span class="sd">        If the pre-trained weights file (`resnet_grader.h5`) is not found.</span>
</span><span id="get_grader_feature_network-638"><a href="#get_grader_feature_network-638"><span class="linenos">638</span></a>
</span><span id="get_grader_feature_network-639"><a href="#get_grader_feature_network-639"><span class="linenos">639</span></a><span class="sd">    Notes</span>
</span><span id="get_grader_feature_network-640"><a href="#get_grader_feature_network-640"><span class="linenos">640</span></a><span class="sd">    -----</span>
</span><span id="get_grader_feature_network-641"><a href="#get_grader_feature_network-641"><span class="linenos">641</span></a><span class="sd">    The pre-trained weights should be located in: `~/.antspyt1w/resnet_grader.keras`</span>
</span><span id="get_grader_feature_network-642"><a href="#get_grader_feature_network-642"><span class="linenos">642</span></a>
</span><span id="get_grader_feature_network-643"><a href="#get_grader_feature_network-643"><span class="linenos">643</span></a><span class="sd">    This model is typically used to compute perceptual loss by comparing</span>
</span><span id="get_grader_feature_network-644"><a href="#get_grader_feature_network-644"><span class="linenos">644</span></a><span class="sd">    intermediate activations between target and prediction volumes.</span>
</span><span id="get_grader_feature_network-645"><a href="#get_grader_feature_network-645"><span class="linenos">645</span></a>
</span><span id="get_grader_feature_network-646"><a href="#get_grader_feature_network-646"><span class="linenos">646</span></a><span class="sd">    See Also</span>
</span><span id="get_grader_feature_network-647"><a href="#get_grader_feature_network-647"><span class="linenos">647</span></a><span class="sd">    --------</span>
</span><span id="get_grader_feature_network-648"><a href="#get_grader_feature_network-648"><span class="linenos">648</span></a><span class="sd">    antspynet.create_resnet_model_3d : Constructs the base ResNet model.</span>
</span><span id="get_grader_feature_network-649"><a href="#get_grader_feature_network-649"><span class="linenos">649</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="get_grader_feature_network-650"><a href="#get_grader_feature_network-650"><span class="linenos">650</span></a>    <span class="n">grader</span> <span class="o">=</span> <span class="n">antspynet</span><span class="o">.</span><span class="n">create_resnet_model_3d</span><span class="p">(</span>
</span><span id="get_grader_feature_network-651"><a href="#get_grader_feature_network-651"><span class="linenos">651</span></a>        <span class="p">[</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
</span><span id="get_grader_feature_network-652"><a href="#get_grader_feature_network-652"><span class="linenos">652</span></a>        <span class="n">lowest_resolution</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
</span><span id="get_grader_feature_network-653"><a href="#get_grader_feature_network-653"><span class="linenos">653</span></a>        <span class="n">number_of_outputs</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
</span><span id="get_grader_feature_network-654"><a href="#get_grader_feature_network-654"><span class="linenos">654</span></a>        <span class="n">cardinality</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="get_grader_feature_network-655"><a href="#get_grader_feature_network-655"><span class="linenos">655</span></a>        <span class="n">squeeze_and_excite</span> <span class="o">=</span> <span class="kc">False</span> <span class="p">)</span>
</span><span id="get_grader_feature_network-656"><a href="#get_grader_feature_network-656"><span class="linenos">656</span></a>    <span class="c1"># the folder and data below as available from antspyt1w get_data</span>
</span><span id="get_grader_feature_network-657"><a href="#get_grader_feature_network-657"><span class="linenos">657</span></a>    <span class="n">graderfn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span> <span class="s2">&quot;~/.antspyt1w/resnet_grader.h5&quot;</span> <span class="p">)</span>
</span><span id="get_grader_feature_network-658"><a href="#get_grader_feature_network-658"><span class="linenos">658</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span> <span class="n">graderfn</span> <span class="p">):</span>
</span><span id="get_grader_feature_network-659"><a href="#get_grader_feature_network-659"><span class="linenos">659</span></a>        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;graderfn &quot;</span> <span class="o">+</span> <span class="n">graderfn</span> <span class="o">+</span> <span class="s2">&quot; does not exist&quot;</span><span class="p">)</span>
</span><span id="get_grader_feature_network-660"><a href="#get_grader_feature_network-660"><span class="linenos">660</span></a>    <span class="n">grader</span><span class="o">.</span><span class="n">load_weights</span><span class="p">(</span> <span class="n">graderfn</span><span class="p">)</span>
</span><span id="get_grader_feature_network-661"><a href="#get_grader_feature_network-661"><span class="linenos">661</span></a>    <span class="c1">#    feature_extractor_23 = tf.keras.Model( inputs=grader.inputs, outputs=grader.layers[23].output )</span>
</span><span id="get_grader_feature_network-662"><a href="#get_grader_feature_network-662"><span class="linenos">662</span></a>    <span class="c1">#   feature_extractor_44 = tf.keras.Model( inputs=grader.inputs, outputs=grader.layers[44].output )</span>
</span><span id="get_grader_feature_network-663"><a href="#get_grader_feature_network-663"><span class="linenos">663</span></a>    <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span> <span class="n">inputs</span><span class="o">=</span><span class="n">grader</span><span class="o">.</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">grader</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">layer</span><span class="p">]</span><span class="o">.</span><span class="n">output</span> <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Load and extract a ResNet-based feature subnetwork for perceptual loss or quality grading.</p>

<p>This function loads a pre-trained 3D ResNet model ("grader") used for
perceptual feature extraction and returns a subnetwork that outputs activations
from a specified internal layer.</p>

<h2 id="parameters">Parameters</h2>

<p>layer : int, optional
    The index of the internal ResNet layer whose output should be used as
    the feature representation. Default is layer 6.</p>

<h2 id="returns">Returns</h2>

<p>tf.keras.Model
    A Keras model that outputs features from the specified layer of the
    pre-trained 3D ResNet grader model.</p>

<h2 id="raises">Raises</h2>

<p>Exception
    If the pre-trained weights file (<code>resnet_grader.h5</code>) is not found.</p>

<h2 id="notes">Notes</h2>

<p>The pre-trained weights should be located in: <code>~/.antspyt1w/resnet_grader.keras</code></p>

<p>This model is typically used to compute perceptual loss by comparing
intermediate activations between target and prediction volumes.</p>

<h2 id="see-also">See Also</h2>

<p>antspynet.create_resnet_model_3d : Constructs the base ResNet model.</p>
</div>


                </section>
                <section id="default_dbpn">
                            <input id="default_dbpn-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">default_dbpn</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">strider</span>,</span><span class="param">	<span class="n">dimensionality</span><span class="o">=</span><span class="mi">3</span>,</span><span class="param">	<span class="n">nfilt</span><span class="o">=</span><span class="mi">64</span>,</span><span class="param">	<span class="n">nff</span><span class="o">=</span><span class="mi">256</span>,</span><span class="param">	<span class="n">convn</span><span class="o">=</span><span class="mi">6</span>,</span><span class="param">	<span class="n">lastconv</span><span class="o">=</span><span class="mi">3</span>,</span><span class="param">	<span class="n">nbp</span><span class="o">=</span><span class="mi">7</span>,</span><span class="param">	<span class="n">nChannelsIn</span><span class="o">=</span><span class="mi">1</span>,</span><span class="param">	<span class="n">nChannelsOut</span><span class="o">=</span><span class="mi">1</span>,</span><span class="param">	<span class="n">option</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">intensity_model</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">segmentation_model</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">sigmoid_second_channel</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">clone_intensity_to_segmentation</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">pro_seg</span><span class="o">=</span><span class="mi">0</span>,</span><span class="param">	<span class="n">freeze</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">verbose</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="default_dbpn-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#default_dbpn"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="default_dbpn-666"><a href="#default_dbpn-666"><span class="linenos">666</span></a><span class="k">def</span> <span class="nf">default_dbpn</span><span class="p">(</span>
</span><span id="default_dbpn-667"><a href="#default_dbpn-667"><span class="linenos">667</span></a>    <span class="n">strider</span><span class="p">,</span> <span class="c1"># length should equal dimensionality</span>
</span><span id="default_dbpn-668"><a href="#default_dbpn-668"><span class="linenos">668</span></a>    <span class="n">dimensionality</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
</span><span id="default_dbpn-669"><a href="#default_dbpn-669"><span class="linenos">669</span></a>    <span class="n">nfilt</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>
</span><span id="default_dbpn-670"><a href="#default_dbpn-670"><span class="linenos">670</span></a>    <span class="n">nff</span> <span class="o">=</span> <span class="mi">256</span><span class="p">,</span>
</span><span id="default_dbpn-671"><a href="#default_dbpn-671"><span class="linenos">671</span></a>    <span class="n">convn</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
</span><span id="default_dbpn-672"><a href="#default_dbpn-672"><span class="linenos">672</span></a>    <span class="n">lastconv</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
</span><span id="default_dbpn-673"><a href="#default_dbpn-673"><span class="linenos">673</span></a>    <span class="n">nbp</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>
</span><span id="default_dbpn-674"><a href="#default_dbpn-674"><span class="linenos">674</span></a>    <span class="n">nChannelsIn</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="default_dbpn-675"><a href="#default_dbpn-675"><span class="linenos">675</span></a>    <span class="n">nChannelsOut</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="default_dbpn-676"><a href="#default_dbpn-676"><span class="linenos">676</span></a>    <span class="n">option</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="default_dbpn-677"><a href="#default_dbpn-677"><span class="linenos">677</span></a>    <span class="n">intensity_model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="default_dbpn-678"><a href="#default_dbpn-678"><span class="linenos">678</span></a>    <span class="n">segmentation_model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="default_dbpn-679"><a href="#default_dbpn-679"><span class="linenos">679</span></a>    <span class="n">sigmoid_second_channel</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="default_dbpn-680"><a href="#default_dbpn-680"><span class="linenos">680</span></a>    <span class="n">clone_intensity_to_segmentation</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="default_dbpn-681"><a href="#default_dbpn-681"><span class="linenos">681</span></a>    <span class="n">pro_seg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="default_dbpn-682"><a href="#default_dbpn-682"><span class="linenos">682</span></a>    <span class="n">freeze</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="default_dbpn-683"><a href="#default_dbpn-683"><span class="linenos">683</span></a>    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span>
</span><span id="default_dbpn-684"><a href="#default_dbpn-684"><span class="linenos">684</span></a> <span class="p">):</span>
</span><span id="default_dbpn-685"><a href="#default_dbpn-685"><span class="linenos">685</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="default_dbpn-686"><a href="#default_dbpn-686"><span class="linenos">686</span></a><span class="sd">    Constructs a DBPN model based on input parameters, and can optionally</span>
</span><span id="default_dbpn-687"><a href="#default_dbpn-687"><span class="linenos">687</span></a><span class="sd">    use external models for intensity or segmentation processing.</span>
</span><span id="default_dbpn-688"><a href="#default_dbpn-688"><span class="linenos">688</span></a>
</span><span id="default_dbpn-689"><a href="#default_dbpn-689"><span class="linenos">689</span></a><span class="sd">    Args:</span>
</span><span id="default_dbpn-690"><a href="#default_dbpn-690"><span class="linenos">690</span></a><span class="sd">        strider (list): List of strides, length must match `dimensionality`.</span>
</span><span id="default_dbpn-691"><a href="#default_dbpn-691"><span class="linenos">691</span></a><span class="sd">        dimensionality (int): Number of dimensions (2 or 3). Default is 3.</span>
</span><span id="default_dbpn-692"><a href="#default_dbpn-692"><span class="linenos">692</span></a><span class="sd">        nfilt (int): Number of base filters. Default is 64.</span>
</span><span id="default_dbpn-693"><a href="#default_dbpn-693"><span class="linenos">693</span></a><span class="sd">        nff (int): Number of feature filters. Default is 256.</span>
</span><span id="default_dbpn-694"><a href="#default_dbpn-694"><span class="linenos">694</span></a><span class="sd">        convn (int): Convolution kernel size. Default is 6.</span>
</span><span id="default_dbpn-695"><a href="#default_dbpn-695"><span class="linenos">695</span></a><span class="sd">        lastconv (int): Size of the last convolution. Default is 3.</span>
</span><span id="default_dbpn-696"><a href="#default_dbpn-696"><span class="linenos">696</span></a><span class="sd">        nbp (int): Number of back projection stages. Default is 7.</span>
</span><span id="default_dbpn-697"><a href="#default_dbpn-697"><span class="linenos">697</span></a><span class="sd">        nChannelsIn (int): Number of input channels. Default is 1.</span>
</span><span id="default_dbpn-698"><a href="#default_dbpn-698"><span class="linenos">698</span></a><span class="sd">        nChannelsOut (int): Number of output channels. Default is 1.</span>
</span><span id="default_dbpn-699"><a href="#default_dbpn-699"><span class="linenos">699</span></a><span class="sd">        option (str): Model size option (&#39;tiny&#39;, &#39;small&#39;, &#39;medium&#39;, &#39;large&#39;). Default is None.</span>
</span><span id="default_dbpn-700"><a href="#default_dbpn-700"><span class="linenos">700</span></a><span class="sd">        intensity_model (tf.keras.Model): Optional external intensity model.</span>
</span><span id="default_dbpn-701"><a href="#default_dbpn-701"><span class="linenos">701</span></a><span class="sd">        segmentation_model (tf.keras.Model): Optional external segmentation model.</span>
</span><span id="default_dbpn-702"><a href="#default_dbpn-702"><span class="linenos">702</span></a><span class="sd">        sigmoid_second_channel (bool): If True, applies sigmoid to second channel in output.</span>
</span><span id="default_dbpn-703"><a href="#default_dbpn-703"><span class="linenos">703</span></a><span class="sd">        clone_intensity_to_segmentation (bool): If True, clones intensity model weights to segmentation.</span>
</span><span id="default_dbpn-704"><a href="#default_dbpn-704"><span class="linenos">704</span></a><span class="sd">        pro_seg (int): If greater than 0, adds a segmentation arm.</span>
</span><span id="default_dbpn-705"><a href="#default_dbpn-705"><span class="linenos">705</span></a><span class="sd">        freeze (bool): If True, freezes the layers of the intensity/segmentation models.</span>
</span><span id="default_dbpn-706"><a href="#default_dbpn-706"><span class="linenos">706</span></a><span class="sd">        verbose (bool): If True, prints detailed logs.</span>
</span><span id="default_dbpn-707"><a href="#default_dbpn-707"><span class="linenos">707</span></a>
</span><span id="default_dbpn-708"><a href="#default_dbpn-708"><span class="linenos">708</span></a><span class="sd">    Returns:</span>
</span><span id="default_dbpn-709"><a href="#default_dbpn-709"><span class="linenos">709</span></a><span class="sd">        Model: A Keras model based on the specified configuration.</span>
</span><span id="default_dbpn-710"><a href="#default_dbpn-710"><span class="linenos">710</span></a>
</span><span id="default_dbpn-711"><a href="#default_dbpn-711"><span class="linenos">711</span></a><span class="sd">    Raises:</span>
</span><span id="default_dbpn-712"><a href="#default_dbpn-712"><span class="linenos">712</span></a><span class="sd">        Exception: If `len(strider)` is not equal to `dimensionality`.</span>
</span><span id="default_dbpn-713"><a href="#default_dbpn-713"><span class="linenos">713</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="default_dbpn-714"><a href="#default_dbpn-714"><span class="linenos">714</span></a>    <span class="k">if</span> <span class="n">option</span> <span class="o">==</span> <span class="s1">&#39;tiny&#39;</span><span class="p">:</span>
</span><span id="default_dbpn-715"><a href="#default_dbpn-715"><span class="linenos">715</span></a>        <span class="n">nfilt</span><span class="o">=</span><span class="mi">32</span>
</span><span id="default_dbpn-716"><a href="#default_dbpn-716"><span class="linenos">716</span></a>        <span class="n">nff</span> <span class="o">=</span> <span class="mi">64</span>
</span><span id="default_dbpn-717"><a href="#default_dbpn-717"><span class="linenos">717</span></a>        <span class="n">convn</span> <span class="o">=</span> <span class="mi">3</span>
</span><span id="default_dbpn-718"><a href="#default_dbpn-718"><span class="linenos">718</span></a>        <span class="n">lastconv</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="default_dbpn-719"><a href="#default_dbpn-719"><span class="linenos">719</span></a>        <span class="n">nbp</span><span class="o">=</span><span class="mi">2</span>
</span><span id="default_dbpn-720"><a href="#default_dbpn-720"><span class="linenos">720</span></a>    <span class="k">elif</span> <span class="n">option</span> <span class="o">==</span> <span class="s1">&#39;small&#39;</span><span class="p">:</span>
</span><span id="default_dbpn-721"><a href="#default_dbpn-721"><span class="linenos">721</span></a>        <span class="n">nfilt</span><span class="o">=</span><span class="mi">32</span>
</span><span id="default_dbpn-722"><a href="#default_dbpn-722"><span class="linenos">722</span></a>        <span class="n">nff</span> <span class="o">=</span> <span class="mi">64</span>
</span><span id="default_dbpn-723"><a href="#default_dbpn-723"><span class="linenos">723</span></a>        <span class="n">convn</span> <span class="o">=</span> <span class="mi">6</span>
</span><span id="default_dbpn-724"><a href="#default_dbpn-724"><span class="linenos">724</span></a>        <span class="n">lastconv</span> <span class="o">=</span> <span class="mi">3</span>
</span><span id="default_dbpn-725"><a href="#default_dbpn-725"><span class="linenos">725</span></a>        <span class="n">nbp</span><span class="o">=</span><span class="mi">4</span>
</span><span id="default_dbpn-726"><a href="#default_dbpn-726"><span class="linenos">726</span></a>    <span class="k">elif</span> <span class="n">option</span> <span class="o">==</span> <span class="s1">&#39;medium&#39;</span><span class="p">:</span>
</span><span id="default_dbpn-727"><a href="#default_dbpn-727"><span class="linenos">727</span></a>        <span class="n">nfilt</span><span class="o">=</span><span class="mi">64</span>
</span><span id="default_dbpn-728"><a href="#default_dbpn-728"><span class="linenos">728</span></a>        <span class="n">nff</span> <span class="o">=</span> <span class="mi">128</span>
</span><span id="default_dbpn-729"><a href="#default_dbpn-729"><span class="linenos">729</span></a>        <span class="n">convn</span> <span class="o">=</span> <span class="mi">6</span>
</span><span id="default_dbpn-730"><a href="#default_dbpn-730"><span class="linenos">730</span></a>        <span class="n">lastconv</span> <span class="o">=</span> <span class="mi">3</span>
</span><span id="default_dbpn-731"><a href="#default_dbpn-731"><span class="linenos">731</span></a>        <span class="n">nbp</span><span class="o">=</span><span class="mi">4</span>
</span><span id="default_dbpn-732"><a href="#default_dbpn-732"><span class="linenos">732</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="default_dbpn-733"><a href="#default_dbpn-733"><span class="linenos">733</span></a>        <span class="n">option</span><span class="o">=</span><span class="s1">&#39;large&#39;</span>
</span><span id="default_dbpn-734"><a href="#default_dbpn-734"><span class="linenos">734</span></a>    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="default_dbpn-735"><a href="#default_dbpn-735"><span class="linenos">735</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Building mode of size: &quot;</span> <span class="o">+</span> <span class="n">option</span><span class="p">)</span>
</span><span id="default_dbpn-736"><a href="#default_dbpn-736"><span class="linenos">736</span></a>        <span class="k">if</span> <span class="n">intensity_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="default_dbpn-737"><a href="#default_dbpn-737"><span class="linenos">737</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;user-passed intensity model will be frozen - only segmentation will train&quot;</span><span class="p">)</span>
</span><span id="default_dbpn-738"><a href="#default_dbpn-738"><span class="linenos">738</span></a>        <span class="k">if</span> <span class="n">segmentation_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="default_dbpn-739"><a href="#default_dbpn-739"><span class="linenos">739</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;user-passed segmentation model will be frozen - only intensity will train&quot;</span><span class="p">)</span>
</span><span id="default_dbpn-740"><a href="#default_dbpn-740"><span class="linenos">740</span></a>
</span><span id="default_dbpn-741"><a href="#default_dbpn-741"><span class="linenos">741</span></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">strider</span><span class="p">)</span> <span class="o">!=</span> <span class="n">dimensionality</span><span class="p">:</span>
</span><span id="default_dbpn-742"><a href="#default_dbpn-742"><span class="linenos">742</span></a>        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;len(strider) != dimensionality&quot;</span><span class="p">)</span>
</span><span id="default_dbpn-743"><a href="#default_dbpn-743"><span class="linenos">743</span></a>    <span class="c1"># **model instantiation**: these are close to defaults for the 2x network.&lt;br&gt;</span>
</span><span id="default_dbpn-744"><a href="#default_dbpn-744"><span class="linenos">744</span></a>    <span class="c1"># empirical evidence suggests that making covolutions and strides evenly&lt;br&gt;</span>
</span><span id="default_dbpn-745"><a href="#default_dbpn-745"><span class="linenos">745</span></a>    <span class="c1"># divisible by each other reduces artifacts.  2*3=6.</span>
</span><span id="default_dbpn-746"><a href="#default_dbpn-746"><span class="linenos">746</span></a>    <span class="c1"># ofn=&#39;./models/dsr3d_&#39;+str(strider)+&#39;up_&#39; + str(nfilt) + &#39;_&#39; + str( nff ) + &#39;_&#39; + str(convn)+ &#39;_&#39; + str(lastconv)+ &#39;_&#39; + str(os.environ[&#39;CUDA_VISIBLE_DEVICES&#39;])+&#39;_v0.0.keras&#39;</span>
</span><span id="default_dbpn-747"><a href="#default_dbpn-747"><span class="linenos">747</span></a>    <span class="k">if</span> <span class="n">dimensionality</span> <span class="o">==</span> <span class="mi">2</span> <span class="p">:</span>
</span><span id="default_dbpn-748"><a href="#default_dbpn-748"><span class="linenos">748</span></a>        <span class="n">mdl</span> <span class="o">=</span> <span class="n">dbpn</span><span class="p">(</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="n">nChannelsIn</span><span class="p">),</span>
</span><span id="default_dbpn-749"><a href="#default_dbpn-749"><span class="linenos">749</span></a>            <span class="n">number_of_outputs</span><span class="o">=</span><span class="n">nChannelsOut</span><span class="p">,</span>
</span><span id="default_dbpn-750"><a href="#default_dbpn-750"><span class="linenos">750</span></a>            <span class="n">number_of_base_filters</span><span class="o">=</span><span class="n">nfilt</span><span class="p">,</span>
</span><span id="default_dbpn-751"><a href="#default_dbpn-751"><span class="linenos">751</span></a>            <span class="n">number_of_feature_filters</span><span class="o">=</span><span class="n">nff</span><span class="p">,</span>
</span><span id="default_dbpn-752"><a href="#default_dbpn-752"><span class="linenos">752</span></a>            <span class="n">number_of_back_projection_stages</span><span class="o">=</span><span class="n">nbp</span><span class="p">,</span>
</span><span id="default_dbpn-753"><a href="#default_dbpn-753"><span class="linenos">753</span></a>            <span class="n">convolution_kernel_size</span><span class="o">=</span><span class="p">(</span><span class="n">convn</span><span class="p">,</span> <span class="n">convn</span><span class="p">),</span>
</span><span id="default_dbpn-754"><a href="#default_dbpn-754"><span class="linenos">754</span></a>            <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="n">strider</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">strider</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
</span><span id="default_dbpn-755"><a href="#default_dbpn-755"><span class="linenos">755</span></a>            <span class="n">last_convolution</span><span class="o">=</span><span class="p">(</span><span class="n">lastconv</span><span class="p">,</span> <span class="n">lastconv</span><span class="p">),</span>
</span><span id="default_dbpn-756"><a href="#default_dbpn-756"><span class="linenos">756</span></a>            <span class="n">number_of_loss_functions</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="default_dbpn-757"><a href="#default_dbpn-757"><span class="linenos">757</span></a>            <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>
</span><span id="default_dbpn-758"><a href="#default_dbpn-758"><span class="linenos">758</span></a>    <span class="k">if</span> <span class="n">dimensionality</span> <span class="o">==</span> <span class="mi">3</span> <span class="p">:</span>
</span><span id="default_dbpn-759"><a href="#default_dbpn-759"><span class="linenos">759</span></a>        <span class="n">mdl</span> <span class="o">=</span> <span class="n">dbpn</span><span class="p">(</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="n">nChannelsIn</span><span class="p">),</span>
</span><span id="default_dbpn-760"><a href="#default_dbpn-760"><span class="linenos">760</span></a>            <span class="n">number_of_outputs</span><span class="o">=</span><span class="n">nChannelsOut</span><span class="p">,</span>
</span><span id="default_dbpn-761"><a href="#default_dbpn-761"><span class="linenos">761</span></a>            <span class="n">number_of_base_filters</span><span class="o">=</span><span class="n">nfilt</span><span class="p">,</span>
</span><span id="default_dbpn-762"><a href="#default_dbpn-762"><span class="linenos">762</span></a>            <span class="n">number_of_feature_filters</span><span class="o">=</span><span class="n">nff</span><span class="p">,</span>
</span><span id="default_dbpn-763"><a href="#default_dbpn-763"><span class="linenos">763</span></a>            <span class="n">number_of_back_projection_stages</span><span class="o">=</span><span class="n">nbp</span><span class="p">,</span>
</span><span id="default_dbpn-764"><a href="#default_dbpn-764"><span class="linenos">764</span></a>            <span class="n">convolution_kernel_size</span><span class="o">=</span><span class="p">(</span><span class="n">convn</span><span class="p">,</span> <span class="n">convn</span><span class="p">,</span> <span class="n">convn</span><span class="p">),</span>
</span><span id="default_dbpn-765"><a href="#default_dbpn-765"><span class="linenos">765</span></a>            <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="n">strider</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">strider</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">strider</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
</span><span id="default_dbpn-766"><a href="#default_dbpn-766"><span class="linenos">766</span></a>            <span class="n">last_convolution</span><span class="o">=</span><span class="p">(</span><span class="n">lastconv</span><span class="p">,</span> <span class="n">lastconv</span><span class="p">,</span> <span class="n">lastconv</span><span class="p">),</span> <span class="n">number_of_loss_functions</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>
</span><span id="default_dbpn-767"><a href="#default_dbpn-767"><span class="linenos">767</span></a>    <span class="k">if</span> <span class="n">sigmoid_second_channel</span> <span class="ow">and</span> <span class="n">pro_seg</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">:</span>
</span><span id="default_dbpn-768"><a href="#default_dbpn-768"><span class="linenos">768</span></a>        <span class="k">if</span> <span class="n">dimensionality</span> <span class="o">==</span> <span class="mi">2</span> <span class="p">:</span>
</span><span id="default_dbpn-769"><a href="#default_dbpn-769"><span class="linenos">769</span></a>            <span class="n">input_image_size</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span><span id="default_dbpn-770"><a href="#default_dbpn-770"><span class="linenos">770</span></a>            <span class="k">if</span> <span class="n">intensity_model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="default_dbpn-771"><a href="#default_dbpn-771"><span class="linenos">771</span></a>                <span class="n">intensity_model</span> <span class="o">=</span> <span class="n">dbpn</span><span class="p">(</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
</span><span id="default_dbpn-772"><a href="#default_dbpn-772"><span class="linenos">772</span></a>                    <span class="n">number_of_outputs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="default_dbpn-773"><a href="#default_dbpn-773"><span class="linenos">773</span></a>                    <span class="n">number_of_base_filters</span><span class="o">=</span><span class="n">nfilt</span><span class="p">,</span>
</span><span id="default_dbpn-774"><a href="#default_dbpn-774"><span class="linenos">774</span></a>                    <span class="n">number_of_feature_filters</span><span class="o">=</span><span class="n">nff</span><span class="p">,</span>
</span><span id="default_dbpn-775"><a href="#default_dbpn-775"><span class="linenos">775</span></a>                    <span class="n">number_of_back_projection_stages</span><span class="o">=</span><span class="n">nbp</span><span class="p">,</span>
</span><span id="default_dbpn-776"><a href="#default_dbpn-776"><span class="linenos">776</span></a>                    <span class="n">convolution_kernel_size</span><span class="o">=</span><span class="p">(</span><span class="n">convn</span><span class="p">,</span> <span class="n">convn</span><span class="p">),</span>
</span><span id="default_dbpn-777"><a href="#default_dbpn-777"><span class="linenos">777</span></a>                    <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="n">strider</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">strider</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
</span><span id="default_dbpn-778"><a href="#default_dbpn-778"><span class="linenos">778</span></a>                    <span class="n">last_convolution</span><span class="o">=</span><span class="p">(</span><span class="n">lastconv</span><span class="p">,</span> <span class="n">lastconv</span><span class="p">),</span>
</span><span id="default_dbpn-779"><a href="#default_dbpn-779"><span class="linenos">779</span></a>                    <span class="n">number_of_loss_functions</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="default_dbpn-780"><a href="#default_dbpn-780"><span class="linenos">780</span></a>                    <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>
</span><span id="default_dbpn-781"><a href="#default_dbpn-781"><span class="linenos">781</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="default_dbpn-782"><a href="#default_dbpn-782"><span class="linenos">782</span></a>                <span class="k">if</span> <span class="n">freeze</span><span class="p">:</span>
</span><span id="default_dbpn-783"><a href="#default_dbpn-783"><span class="linenos">783</span></a>                    <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">intensity_model</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
</span><span id="default_dbpn-784"><a href="#default_dbpn-784"><span class="linenos">784</span></a>                        <span class="n">layer</span><span class="o">.</span><span class="n">trainable</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="default_dbpn-785"><a href="#default_dbpn-785"><span class="linenos">785</span></a>            <span class="k">if</span> <span class="n">segmentation_model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="default_dbpn-786"><a href="#default_dbpn-786"><span class="linenos">786</span></a>                <span class="n">segmentation_model</span> <span class="o">=</span> <span class="n">dbpn</span><span class="p">(</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
</span><span id="default_dbpn-787"><a href="#default_dbpn-787"><span class="linenos">787</span></a>                        <span class="n">number_of_outputs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="default_dbpn-788"><a href="#default_dbpn-788"><span class="linenos">788</span></a>                        <span class="n">number_of_base_filters</span><span class="o">=</span><span class="n">nfilt</span><span class="p">,</span>
</span><span id="default_dbpn-789"><a href="#default_dbpn-789"><span class="linenos">789</span></a>                        <span class="n">number_of_feature_filters</span><span class="o">=</span><span class="n">nff</span><span class="p">,</span>
</span><span id="default_dbpn-790"><a href="#default_dbpn-790"><span class="linenos">790</span></a>                        <span class="n">number_of_back_projection_stages</span><span class="o">=</span><span class="n">nbp</span><span class="p">,</span>
</span><span id="default_dbpn-791"><a href="#default_dbpn-791"><span class="linenos">791</span></a>                        <span class="n">convolution_kernel_size</span><span class="o">=</span><span class="p">(</span><span class="n">convn</span><span class="p">,</span> <span class="n">convn</span><span class="p">),</span>
</span><span id="default_dbpn-792"><a href="#default_dbpn-792"><span class="linenos">792</span></a>                        <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="n">strider</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">strider</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
</span><span id="default_dbpn-793"><a href="#default_dbpn-793"><span class="linenos">793</span></a>                        <span class="n">last_convolution</span><span class="o">=</span><span class="p">(</span><span class="n">lastconv</span><span class="p">,</span> <span class="n">lastconv</span><span class="p">),</span>
</span><span id="default_dbpn-794"><a href="#default_dbpn-794"><span class="linenos">794</span></a>                        <span class="n">number_of_loss_functions</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">)</span>
</span><span id="default_dbpn-795"><a href="#default_dbpn-795"><span class="linenos">795</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="default_dbpn-796"><a href="#default_dbpn-796"><span class="linenos">796</span></a>                <span class="k">if</span> <span class="n">freeze</span><span class="p">:</span>
</span><span id="default_dbpn-797"><a href="#default_dbpn-797"><span class="linenos">797</span></a>                    <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">segmentation_model</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
</span><span id="default_dbpn-798"><a href="#default_dbpn-798"><span class="linenos">798</span></a>                        <span class="n">layer</span><span class="o">.</span><span class="n">trainable</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="default_dbpn-799"><a href="#default_dbpn-799"><span class="linenos">799</span></a>        <span class="k">if</span> <span class="n">dimensionality</span> <span class="o">==</span> <span class="mi">3</span> <span class="p">:</span>
</span><span id="default_dbpn-800"><a href="#default_dbpn-800"><span class="linenos">800</span></a>            <span class="n">input_image_size</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span><span id="default_dbpn-801"><a href="#default_dbpn-801"><span class="linenos">801</span></a>            <span class="k">if</span> <span class="n">intensity_model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="default_dbpn-802"><a href="#default_dbpn-802"><span class="linenos">802</span></a>                <span class="n">intensity_model</span> <span class="o">=</span> <span class="n">dbpn</span><span class="p">(</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
</span><span id="default_dbpn-803"><a href="#default_dbpn-803"><span class="linenos">803</span></a>                    <span class="n">number_of_outputs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="default_dbpn-804"><a href="#default_dbpn-804"><span class="linenos">804</span></a>                    <span class="n">number_of_base_filters</span><span class="o">=</span><span class="n">nfilt</span><span class="p">,</span>
</span><span id="default_dbpn-805"><a href="#default_dbpn-805"><span class="linenos">805</span></a>                    <span class="n">number_of_feature_filters</span><span class="o">=</span><span class="n">nff</span><span class="p">,</span>
</span><span id="default_dbpn-806"><a href="#default_dbpn-806"><span class="linenos">806</span></a>                    <span class="n">number_of_back_projection_stages</span><span class="o">=</span><span class="n">nbp</span><span class="p">,</span>
</span><span id="default_dbpn-807"><a href="#default_dbpn-807"><span class="linenos">807</span></a>                    <span class="n">convolution_kernel_size</span><span class="o">=</span><span class="p">(</span><span class="n">convn</span><span class="p">,</span> <span class="n">convn</span><span class="p">,</span> <span class="n">convn</span><span class="p">),</span>
</span><span id="default_dbpn-808"><a href="#default_dbpn-808"><span class="linenos">808</span></a>                    <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="n">strider</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">strider</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">strider</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
</span><span id="default_dbpn-809"><a href="#default_dbpn-809"><span class="linenos">809</span></a>                    <span class="n">last_convolution</span><span class="o">=</span><span class="p">(</span><span class="n">lastconv</span><span class="p">,</span> <span class="n">lastconv</span><span class="p">,</span> <span class="n">lastconv</span><span class="p">),</span>
</span><span id="default_dbpn-810"><a href="#default_dbpn-810"><span class="linenos">810</span></a>                    <span class="n">number_of_loss_functions</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>
</span><span id="default_dbpn-811"><a href="#default_dbpn-811"><span class="linenos">811</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="default_dbpn-812"><a href="#default_dbpn-812"><span class="linenos">812</span></a>                <span class="k">if</span> <span class="n">freeze</span><span class="p">:</span>
</span><span id="default_dbpn-813"><a href="#default_dbpn-813"><span class="linenos">813</span></a>                    <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">intensity_model</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
</span><span id="default_dbpn-814"><a href="#default_dbpn-814"><span class="linenos">814</span></a>                        <span class="n">layer</span><span class="o">.</span><span class="n">trainable</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="default_dbpn-815"><a href="#default_dbpn-815"><span class="linenos">815</span></a>            <span class="k">if</span> <span class="n">segmentation_model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="default_dbpn-816"><a href="#default_dbpn-816"><span class="linenos">816</span></a>                <span class="n">segmentation_model</span> <span class="o">=</span> <span class="n">dbpn</span><span class="p">(</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
</span><span id="default_dbpn-817"><a href="#default_dbpn-817"><span class="linenos">817</span></a>                        <span class="n">number_of_outputs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="default_dbpn-818"><a href="#default_dbpn-818"><span class="linenos">818</span></a>                        <span class="n">number_of_base_filters</span><span class="o">=</span><span class="n">nfilt</span><span class="p">,</span>
</span><span id="default_dbpn-819"><a href="#default_dbpn-819"><span class="linenos">819</span></a>                        <span class="n">number_of_feature_filters</span><span class="o">=</span><span class="n">nff</span><span class="p">,</span>
</span><span id="default_dbpn-820"><a href="#default_dbpn-820"><span class="linenos">820</span></a>                        <span class="n">number_of_back_projection_stages</span><span class="o">=</span><span class="n">nbp</span><span class="p">,</span>
</span><span id="default_dbpn-821"><a href="#default_dbpn-821"><span class="linenos">821</span></a>                        <span class="n">convolution_kernel_size</span><span class="o">=</span><span class="p">(</span><span class="n">convn</span><span class="p">,</span> <span class="n">convn</span><span class="p">,</span> <span class="n">convn</span><span class="p">),</span>
</span><span id="default_dbpn-822"><a href="#default_dbpn-822"><span class="linenos">822</span></a>                        <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="n">strider</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">strider</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">strider</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
</span><span id="default_dbpn-823"><a href="#default_dbpn-823"><span class="linenos">823</span></a>                        <span class="n">last_convolution</span><span class="o">=</span><span class="p">(</span><span class="n">lastconv</span><span class="p">,</span> <span class="n">lastconv</span><span class="p">,</span> <span class="n">lastconv</span><span class="p">),</span>
</span><span id="default_dbpn-824"><a href="#default_dbpn-824"><span class="linenos">824</span></a>                        <span class="n">number_of_loss_functions</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">)</span>
</span><span id="default_dbpn-825"><a href="#default_dbpn-825"><span class="linenos">825</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="default_dbpn-826"><a href="#default_dbpn-826"><span class="linenos">826</span></a>                <span class="k">if</span> <span class="n">freeze</span><span class="p">:</span>
</span><span id="default_dbpn-827"><a href="#default_dbpn-827"><span class="linenos">827</span></a>                    <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">segmentation_model</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
</span><span id="default_dbpn-828"><a href="#default_dbpn-828"><span class="linenos">828</span></a>                        <span class="n">layer</span><span class="o">.</span><span class="n">trainable</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="default_dbpn-829"><a href="#default_dbpn-829"><span class="linenos">829</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="default_dbpn-830"><a href="#default_dbpn-830"><span class="linenos">830</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;len intensity_model layers : &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">intensity_model</span><span class="o">.</span><span class="n">layers</span> <span class="p">)))</span>
</span><span id="default_dbpn-831"><a href="#default_dbpn-831"><span class="linenos">831</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;len intensity_model weights : &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">intensity_model</span><span class="o">.</span><span class="n">weights</span> <span class="p">)))</span>
</span><span id="default_dbpn-832"><a href="#default_dbpn-832"><span class="linenos">832</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;len segmentation_model layers : &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">segmentation_model</span><span class="o">.</span><span class="n">layers</span> <span class="p">)))</span>
</span><span id="default_dbpn-833"><a href="#default_dbpn-833"><span class="linenos">833</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;len segmentation_model weights : &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">segmentation_model</span><span class="o">.</span><span class="n">weights</span> <span class="p">)))</span>
</span><span id="default_dbpn-834"><a href="#default_dbpn-834"><span class="linenos">834</span></a>        <span class="k">if</span> <span class="n">clone_intensity_to_segmentation</span><span class="p">:</span>
</span><span id="default_dbpn-835"><a href="#default_dbpn-835"><span class="linenos">835</span></a>            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span> <span class="n">segmentation_model</span><span class="o">.</span><span class="n">weights</span> <span class="p">)):</span>
</span><span id="default_dbpn-836"><a href="#default_dbpn-836"><span class="linenos">836</span></a>                <span class="k">if</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span> <span class="n">intensity_model</span><span class="o">.</span><span class="n">weights</span> <span class="p">):</span>
</span><span id="default_dbpn-837"><a href="#default_dbpn-837"><span class="linenos">837</span></a>                    <span class="k">if</span> <span class="n">intensity_model</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">segmentation_model</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
</span><span id="default_dbpn-838"><a href="#default_dbpn-838"><span class="linenos">838</span></a>                        <span class="n">segmentation_model</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">intensity_model</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
</span><span id="default_dbpn-839"><a href="#default_dbpn-839"><span class="linenos">839</span></a>        <span class="n">inputs</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">input_image_size</span><span class="p">)</span>
</span><span id="default_dbpn-840"><a href="#default_dbpn-840"><span class="linenos">840</span></a>        <span class="n">insplit</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span> <span class="n">inputs</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dimensionality</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
</span><span id="default_dbpn-841"><a href="#default_dbpn-841"><span class="linenos">841</span></a>        <span class="n">outputs</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="default_dbpn-842"><a href="#default_dbpn-842"><span class="linenos">842</span></a>            <span class="n">intensity_model</span><span class="p">(</span> <span class="n">insplit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">),</span>
</span><span id="default_dbpn-843"><a href="#default_dbpn-843"><span class="linenos">843</span></a>            <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span> <span class="n">segmentation_model</span><span class="p">(</span> <span class="n">insplit</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span> <span class="p">)</span> <span class="p">]</span>
</span><span id="default_dbpn-844"><a href="#default_dbpn-844"><span class="linenos">844</span></a>        <span class="n">mdlout</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">dimensionality</span><span class="o">+</span><span class="mi">1</span> <span class="p">)</span>
</span><span id="default_dbpn-845"><a href="#default_dbpn-845"><span class="linenos">845</span></a>        <span class="k">return</span> <span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">mdlout</span> <span class="p">)</span>
</span><span id="default_dbpn-846"><a href="#default_dbpn-846"><span class="linenos">846</span></a>    <span class="k">if</span> <span class="n">pro_seg</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">intensity_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="default_dbpn-847"><a href="#default_dbpn-847"><span class="linenos">847</span></a>        <span class="k">if</span> <span class="n">verbose</span> <span class="ow">and</span> <span class="n">freeze</span><span class="p">:</span>
</span><span id="default_dbpn-848"><a href="#default_dbpn-848"><span class="linenos">848</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Add a segmentation arm to the end. freeze intensity. intensity_model(seg) =&gt; conv =&gt; sigmoid&quot;</span><span class="p">)</span>
</span><span id="default_dbpn-849"><a href="#default_dbpn-849"><span class="linenos">849</span></a>        <span class="k">if</span> <span class="n">verbose</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">freeze</span><span class="p">:</span>
</span><span id="default_dbpn-850"><a href="#default_dbpn-850"><span class="linenos">850</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Add a segmentation arm to the end. freeze intensity. intensity_model(seg) =&gt; conv =&gt; sigmoid&quot;</span><span class="p">)</span>
</span><span id="default_dbpn-851"><a href="#default_dbpn-851"><span class="linenos">851</span></a>        <span class="k">if</span> <span class="n">freeze</span><span class="p">:</span>
</span><span id="default_dbpn-852"><a href="#default_dbpn-852"><span class="linenos">852</span></a>            <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">intensity_model</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
</span><span id="default_dbpn-853"><a href="#default_dbpn-853"><span class="linenos">853</span></a>                <span class="n">layer</span><span class="o">.</span><span class="n">trainable</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="default_dbpn-854"><a href="#default_dbpn-854"><span class="linenos">854</span></a>        <span class="k">if</span> <span class="n">dimensionality</span> <span class="o">==</span> <span class="mi">2</span> <span class="p">:</span>
</span><span id="default_dbpn-855"><a href="#default_dbpn-855"><span class="linenos">855</span></a>            <span class="n">input_image_size</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span><span id="default_dbpn-856"><a href="#default_dbpn-856"><span class="linenos">856</span></a>        <span class="k">elif</span> <span class="n">dimensionality</span> <span class="o">==</span> <span class="mi">3</span> <span class="p">:</span>
</span><span id="default_dbpn-857"><a href="#default_dbpn-857"><span class="linenos">857</span></a>            <span class="n">input_image_size</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span><span id="default_dbpn-858"><a href="#default_dbpn-858"><span class="linenos">858</span></a>        <span class="k">if</span> <span class="n">dimensionality</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="default_dbpn-859"><a href="#default_dbpn-859"><span class="linenos">859</span></a>            <span class="n">myconv</span> <span class="o">=</span> <span class="n">Conv2D</span>
</span><span id="default_dbpn-860"><a href="#default_dbpn-860"><span class="linenos">860</span></a>            <span class="n">firstConv</span> <span class="o">=</span> <span class="p">(</span><span class="n">convn</span><span class="p">,</span><span class="n">convn</span><span class="p">)</span>
</span><span id="default_dbpn-861"><a href="#default_dbpn-861"><span class="linenos">861</span></a>            <span class="n">firstStrides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span><span id="default_dbpn-862"><a href="#default_dbpn-862"><span class="linenos">862</span></a>            <span class="n">smashConv</span><span class="o">=</span><span class="p">(</span><span class="n">pro_seg</span><span class="p">,</span><span class="n">pro_seg</span><span class="p">)</span>
</span><span id="default_dbpn-863"><a href="#default_dbpn-863"><span class="linenos">863</span></a>        <span class="k">if</span> <span class="n">dimensionality</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="default_dbpn-864"><a href="#default_dbpn-864"><span class="linenos">864</span></a>            <span class="n">myconv</span> <span class="o">=</span> <span class="n">Conv3D</span>
</span><span id="default_dbpn-865"><a href="#default_dbpn-865"><span class="linenos">865</span></a>            <span class="n">firstConv</span> <span class="o">=</span> <span class="p">(</span><span class="n">convn</span><span class="p">,</span><span class="n">convn</span><span class="p">,</span><span class="n">convn</span><span class="p">)</span>
</span><span id="default_dbpn-866"><a href="#default_dbpn-866"><span class="linenos">866</span></a>            <span class="n">firstStrides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span><span id="default_dbpn-867"><a href="#default_dbpn-867"><span class="linenos">867</span></a>            <span class="n">smashConv</span><span class="o">=</span><span class="p">(</span><span class="n">pro_seg</span><span class="p">,</span><span class="n">pro_seg</span><span class="p">,</span><span class="n">pro_seg</span><span class="p">)</span>
</span><span id="default_dbpn-868"><a href="#default_dbpn-868"><span class="linenos">868</span></a>        <span class="n">inputs</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">input_image_size</span><span class="p">)</span>
</span><span id="default_dbpn-869"><a href="#default_dbpn-869"><span class="linenos">869</span></a>        <span class="n">insplit</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span> <span class="n">inputs</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dimensionality</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
</span><span id="default_dbpn-870"><a href="#default_dbpn-870"><span class="linenos">870</span></a>        <span class="c1"># define segmentation arm</span>
</span><span id="default_dbpn-871"><a href="#default_dbpn-871"><span class="linenos">871</span></a>        <span class="n">seggit</span> <span class="o">=</span> <span class="n">intensity_model</span><span class="p">(</span> <span class="n">insplit</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
</span><span id="default_dbpn-872"><a href="#default_dbpn-872"><span class="linenos">872</span></a>        <span class="n">L0</span> <span class="o">=</span> <span class="n">myconv</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="n">nff</span><span class="p">,</span>
</span><span id="default_dbpn-873"><a href="#default_dbpn-873"><span class="linenos">873</span></a>                    <span class="n">kernel_size</span><span class="o">=</span><span class="n">firstConv</span><span class="p">,</span>
</span><span id="default_dbpn-874"><a href="#default_dbpn-874"><span class="linenos">874</span></a>                    <span class="n">strides</span><span class="o">=</span><span class="n">firstStrides</span><span class="p">,</span>
</span><span id="default_dbpn-875"><a href="#default_dbpn-875"><span class="linenos">875</span></a>                    <span class="n">kernel_initializer</span><span class="o">=</span><span class="s1">&#39;glorot_uniform&#39;</span><span class="p">,</span>
</span><span id="default_dbpn-876"><a href="#default_dbpn-876"><span class="linenos">876</span></a>                    <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)(</span><span class="n">seggit</span><span class="p">)</span>
</span><span id="default_dbpn-877"><a href="#default_dbpn-877"><span class="linenos">877</span></a>        <span class="n">L1</span> <span class="o">=</span> <span class="n">myconv</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="n">nff</span><span class="p">,</span>
</span><span id="default_dbpn-878"><a href="#default_dbpn-878"><span class="linenos">878</span></a>                    <span class="n">kernel_size</span><span class="o">=</span><span class="n">firstConv</span><span class="p">,</span>
</span><span id="default_dbpn-879"><a href="#default_dbpn-879"><span class="linenos">879</span></a>                    <span class="n">strides</span><span class="o">=</span><span class="n">firstStrides</span><span class="p">,</span>
</span><span id="default_dbpn-880"><a href="#default_dbpn-880"><span class="linenos">880</span></a>                    <span class="n">kernel_initializer</span><span class="o">=</span><span class="s1">&#39;glorot_uniform&#39;</span><span class="p">,</span>
</span><span id="default_dbpn-881"><a href="#default_dbpn-881"><span class="linenos">881</span></a>                    <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)(</span><span class="n">L0</span><span class="p">)</span>
</span><span id="default_dbpn-882"><a href="#default_dbpn-882"><span class="linenos">882</span></a>        <span class="n">L2</span> <span class="o">=</span> <span class="n">myconv</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="default_dbpn-883"><a href="#default_dbpn-883"><span class="linenos">883</span></a>                    <span class="n">kernel_size</span><span class="o">=</span><span class="n">smashConv</span><span class="p">,</span>
</span><span id="default_dbpn-884"><a href="#default_dbpn-884"><span class="linenos">884</span></a>                    <span class="n">strides</span><span class="o">=</span><span class="n">firstStrides</span><span class="p">,</span>
</span><span id="default_dbpn-885"><a href="#default_dbpn-885"><span class="linenos">885</span></a>                    <span class="n">kernel_initializer</span><span class="o">=</span><span class="s1">&#39;glorot_uniform&#39;</span><span class="p">,</span>
</span><span id="default_dbpn-886"><a href="#default_dbpn-886"><span class="linenos">886</span></a>                    <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)(</span><span class="n">L1</span><span class="p">)</span>
</span><span id="default_dbpn-887"><a href="#default_dbpn-887"><span class="linenos">887</span></a>        <span class="n">outputs</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="default_dbpn-888"><a href="#default_dbpn-888"><span class="linenos">888</span></a>            <span class="n">intensity_model</span><span class="p">(</span> <span class="n">insplit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">),</span>
</span><span id="default_dbpn-889"><a href="#default_dbpn-889"><span class="linenos">889</span></a>            <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span> <span class="n">L2</span> <span class="p">)</span> <span class="p">]</span>
</span><span id="default_dbpn-890"><a href="#default_dbpn-890"><span class="linenos">890</span></a>        <span class="n">mdlout</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">dimensionality</span><span class="o">+</span><span class="mi">1</span> <span class="p">)</span>
</span><span id="default_dbpn-891"><a href="#default_dbpn-891"><span class="linenos">891</span></a>        <span class="k">return</span> <span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">mdlout</span> <span class="p">)</span>
</span><span id="default_dbpn-892"><a href="#default_dbpn-892"><span class="linenos">892</span></a>    <span class="k">return</span> <span class="n">mdl</span>
</span></pre></div>


            <div class="docstring"><p>Constructs a DBPN model based on input parameters, and can optionally
use external models for intensity or segmentation processing.</p>

<p>Args:
    strider (list): List of strides, length must match <code>dimensionality</code>.
    dimensionality (int): Number of dimensions (2 or 3). Default is 3.
    nfilt (int): Number of base filters. Default is 64.
    nff (int): Number of feature filters. Default is 256.
    convn (int): Convolution kernel size. Default is 6.
    lastconv (int): Size of the last convolution. Default is 3.
    nbp (int): Number of back projection stages. Default is 7.
    nChannelsIn (int): Number of input channels. Default is 1.
    nChannelsOut (int): Number of output channels. Default is 1.
    option (str): Model size option ('tiny', 'small', 'medium', 'large'). Default is None.
    intensity_model (tf.keras.Model): Optional external intensity model.
    segmentation_model (tf.keras.Model): Optional external segmentation model.
    sigmoid_second_channel (bool): If True, applies sigmoid to second channel in output.
    clone_intensity_to_segmentation (bool): If True, clones intensity model weights to segmentation.
    pro_seg (int): If greater than 0, adds a segmentation arm.
    freeze (bool): If True, freezes the layers of the intensity/segmentation models.
    verbose (bool): If True, prints detailed logs.</p>

<p>Returns:
    Model: A Keras model based on the specified configuration.</p>

<p>Raises:
    Exception: If <code>len(strider)</code> is not equal to <code>dimensionality</code>.</p>
</div>


                </section>
                <section id="image_patch_training_data_from_filenames">
                            <input id="image_patch_training_data_from_filenames-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">image_patch_training_data_from_filenames</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">filenames</span>,</span><span class="param">	<span class="n">target_patch_size</span>,</span><span class="param">	<span class="n">target_patch_size_low</span>,</span><span class="param">	<span class="n">nPatches</span><span class="o">=</span><span class="mi">128</span>,</span><span class="param">	<span class="n">istest</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">patch_scaler</span><span class="o">=</span><span class="kc">True</span>,</span><span class="param">	<span class="n">to_tensorflow</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">verbose</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="image_patch_training_data_from_filenames-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#image_patch_training_data_from_filenames"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="image_patch_training_data_from_filenames-894"><a href="#image_patch_training_data_from_filenames-894"><span class="linenos"> 894</span></a><span class="k">def</span> <span class="nf">image_patch_training_data_from_filenames</span><span class="p">(</span>
</span><span id="image_patch_training_data_from_filenames-895"><a href="#image_patch_training_data_from_filenames-895"><span class="linenos"> 895</span></a>    <span class="n">filenames</span><span class="p">,</span>
</span><span id="image_patch_training_data_from_filenames-896"><a href="#image_patch_training_data_from_filenames-896"><span class="linenos"> 896</span></a>    <span class="n">target_patch_size</span><span class="p">,</span>
</span><span id="image_patch_training_data_from_filenames-897"><a href="#image_patch_training_data_from_filenames-897"><span class="linenos"> 897</span></a>    <span class="n">target_patch_size_low</span><span class="p">,</span>
</span><span id="image_patch_training_data_from_filenames-898"><a href="#image_patch_training_data_from_filenames-898"><span class="linenos"> 898</span></a>    <span class="n">nPatches</span> <span class="o">=</span> <span class="mi">128</span><span class="p">,</span>
</span><span id="image_patch_training_data_from_filenames-899"><a href="#image_patch_training_data_from_filenames-899"><span class="linenos"> 899</span></a>    <span class="n">istest</span>   <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="image_patch_training_data_from_filenames-900"><a href="#image_patch_training_data_from_filenames-900"><span class="linenos"> 900</span></a>    <span class="n">patch_scaler</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="image_patch_training_data_from_filenames-901"><a href="#image_patch_training_data_from_filenames-901"><span class="linenos"> 901</span></a>    <span class="n">to_tensorflow</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="image_patch_training_data_from_filenames-902"><a href="#image_patch_training_data_from_filenames-902"><span class="linenos"> 902</span></a>    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="image_patch_training_data_from_filenames-903"><a href="#image_patch_training_data_from_filenames-903"><span class="linenos"> 903</span></a>    <span class="p">):</span>
</span><span id="image_patch_training_data_from_filenames-904"><a href="#image_patch_training_data_from_filenames-904"><span class="linenos"> 904</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="image_patch_training_data_from_filenames-905"><a href="#image_patch_training_data_from_filenames-905"><span class="linenos"> 905</span></a><span class="sd">    Generates a batch of paired high- and low-resolution image patches for training.</span>
</span><span id="image_patch_training_data_from_filenames-906"><a href="#image_patch_training_data_from_filenames-906"><span class="linenos"> 906</span></a>
</span><span id="image_patch_training_data_from_filenames-907"><a href="#image_patch_training_data_from_filenames-907"><span class="linenos"> 907</span></a><span class="sd">    This function creates training data by taking a list of high-resolution source</span>
</span><span id="image_patch_training_data_from_filenames-908"><a href="#image_patch_training_data_from_filenames-908"><span class="linenos"> 908</span></a><span class="sd">    images, extracting random patches, and then downsampling them to create</span>
</span><span id="image_patch_training_data_from_filenames-909"><a href="#image_patch_training_data_from_filenames-909"><span class="linenos"> 909</span></a><span class="sd">    low-resolution counterparts. This provides the (input, ground_truth) pairs</span>
</span><span id="image_patch_training_data_from_filenames-910"><a href="#image_patch_training_data_from_filenames-910"><span class="linenos"> 910</span></a><span class="sd">    needed to train a super-resolution model.</span>
</span><span id="image_patch_training_data_from_filenames-911"><a href="#image_patch_training_data_from_filenames-911"><span class="linenos"> 911</span></a>
</span><span id="image_patch_training_data_from_filenames-912"><a href="#image_patch_training_data_from_filenames-912"><span class="linenos"> 912</span></a><span class="sd">    Parameters</span>
</span><span id="image_patch_training_data_from_filenames-913"><a href="#image_patch_training_data_from_filenames-913"><span class="linenos"> 913</span></a><span class="sd">    ----------</span>
</span><span id="image_patch_training_data_from_filenames-914"><a href="#image_patch_training_data_from_filenames-914"><span class="linenos"> 914</span></a><span class="sd">    filenames : list of str</span>
</span><span id="image_patch_training_data_from_filenames-915"><a href="#image_patch_training_data_from_filenames-915"><span class="linenos"> 915</span></a><span class="sd">        A list of file paths to the high-resolution source images.</span>
</span><span id="image_patch_training_data_from_filenames-916"><a href="#image_patch_training_data_from_filenames-916"><span class="linenos"> 916</span></a>
</span><span id="image_patch_training_data_from_filenames-917"><a href="#image_patch_training_data_from_filenames-917"><span class="linenos"> 917</span></a><span class="sd">    target_patch_size : tuple or list of int</span>
</span><span id="image_patch_training_data_from_filenames-918"><a href="#image_patch_training_data_from_filenames-918"><span class="linenos"> 918</span></a><span class="sd">        The dimensions of the high-resolution (ground truth) patch to extract,</span>
</span><span id="image_patch_training_data_from_filenames-919"><a href="#image_patch_training_data_from_filenames-919"><span class="linenos"> 919</span></a><span class="sd">        e.g., `(128, 128, 128)`.</span>
</span><span id="image_patch_training_data_from_filenames-920"><a href="#image_patch_training_data_from_filenames-920"><span class="linenos"> 920</span></a>
</span><span id="image_patch_training_data_from_filenames-921"><a href="#image_patch_training_data_from_filenames-921"><span class="linenos"> 921</span></a><span class="sd">    target_patch_size_low : tuple or list of int</span>
</span><span id="image_patch_training_data_from_filenames-922"><a href="#image_patch_training_data_from_filenames-922"><span class="linenos"> 922</span></a><span class="sd">        The dimensions of the low-resolution (input) patch to generate. The ratio</span>
</span><span id="image_patch_training_data_from_filenames-923"><a href="#image_patch_training_data_from_filenames-923"><span class="linenos"> 923</span></a><span class="sd">        between `target_patch_size` and `target_patch_size_low` determines the</span>
</span><span id="image_patch_training_data_from_filenames-924"><a href="#image_patch_training_data_from_filenames-924"><span class="linenos"> 924</span></a><span class="sd">        super-resolution factor.</span>
</span><span id="image_patch_training_data_from_filenames-925"><a href="#image_patch_training_data_from_filenames-925"><span class="linenos"> 925</span></a>
</span><span id="image_patch_training_data_from_filenames-926"><a href="#image_patch_training_data_from_filenames-926"><span class="linenos"> 926</span></a><span class="sd">    nPatches : int, optional</span>
</span><span id="image_patch_training_data_from_filenames-927"><a href="#image_patch_training_data_from_filenames-927"><span class="linenos"> 927</span></a><span class="sd">        The number of patch pairs to generate in this batch. Default is 128.</span>
</span><span id="image_patch_training_data_from_filenames-928"><a href="#image_patch_training_data_from_filenames-928"><span class="linenos"> 928</span></a>
</span><span id="image_patch_training_data_from_filenames-929"><a href="#image_patch_training_data_from_filenames-929"><span class="linenos"> 929</span></a><span class="sd">    istest : bool, optional</span>
</span><span id="image_patch_training_data_from_filenames-930"><a href="#image_patch_training_data_from_filenames-930"><span class="linenos"> 930</span></a><span class="sd">        If True, the function also generates a third output array containing patches</span>
</span><span id="image_patch_training_data_from_filenames-931"><a href="#image_patch_training_data_from_filenames-931"><span class="linenos"> 931</span></a><span class="sd">        that have been naively upsampled using linear interpolation. This is useful</span>
</span><span id="image_patch_training_data_from_filenames-932"><a href="#image_patch_training_data_from_filenames-932"><span class="linenos"> 932</span></a><span class="sd">        for calculating baseline evaluation metrics (e.g., PSNR) against which the</span>
</span><span id="image_patch_training_data_from_filenames-933"><a href="#image_patch_training_data_from_filenames-933"><span class="linenos"> 933</span></a><span class="sd">        model&#39;s performance can be compared. Default is False.</span>
</span><span id="image_patch_training_data_from_filenames-934"><a href="#image_patch_training_data_from_filenames-934"><span class="linenos"> 934</span></a>
</span><span id="image_patch_training_data_from_filenames-935"><a href="#image_patch_training_data_from_filenames-935"><span class="linenos"> 935</span></a><span class="sd">    patch_scaler : bool, optional</span>
</span><span id="image_patch_training_data_from_filenames-936"><a href="#image_patch_training_data_from_filenames-936"><span class="linenos"> 936</span></a><span class="sd">        If True, scales the intensity of each high-resolution patch to the [0, 1]</span>
</span><span id="image_patch_training_data_from_filenames-937"><a href="#image_patch_training_data_from_filenames-937"><span class="linenos"> 937</span></a><span class="sd">        range before creating the downsampled version. This can help with</span>
</span><span id="image_patch_training_data_from_filenames-938"><a href="#image_patch_training_data_from_filenames-938"><span class="linenos"> 938</span></a><span class="sd">        training stability. Default is True.</span>
</span><span id="image_patch_training_data_from_filenames-939"><a href="#image_patch_training_data_from_filenames-939"><span class="linenos"> 939</span></a>
</span><span id="image_patch_training_data_from_filenames-940"><a href="#image_patch_training_data_from_filenames-940"><span class="linenos"> 940</span></a><span class="sd">    to_tensorflow : bool, optional</span>
</span><span id="image_patch_training_data_from_filenames-941"><a href="#image_patch_training_data_from_filenames-941"><span class="linenos"> 941</span></a><span class="sd">        If True, casts the output NumPy arrays to TensorFlow tensors. Default is False.</span>
</span><span id="image_patch_training_data_from_filenames-942"><a href="#image_patch_training_data_from_filenames-942"><span class="linenos"> 942</span></a>
</span><span id="image_patch_training_data_from_filenames-943"><a href="#image_patch_training_data_from_filenames-943"><span class="linenos"> 943</span></a><span class="sd">    verbose : bool, optional</span>
</span><span id="image_patch_training_data_from_filenames-944"><a href="#image_patch_training_data_from_filenames-944"><span class="linenos"> 944</span></a><span class="sd">        If True, prints progress messages during patch generation. Default is False.</span>
</span><span id="image_patch_training_data_from_filenames-945"><a href="#image_patch_training_data_from_filenames-945"><span class="linenos"> 945</span></a>
</span><span id="image_patch_training_data_from_filenames-946"><a href="#image_patch_training_data_from_filenames-946"><span class="linenos"> 946</span></a><span class="sd">    Returns</span>
</span><span id="image_patch_training_data_from_filenames-947"><a href="#image_patch_training_data_from_filenames-947"><span class="linenos"> 947</span></a><span class="sd">    -------</span>
</span><span id="image_patch_training_data_from_filenames-948"><a href="#image_patch_training_data_from_filenames-948"><span class="linenos"> 948</span></a><span class="sd">    tuple</span>
</span><span id="image_patch_training_data_from_filenames-949"><a href="#image_patch_training_data_from_filenames-949"><span class="linenos"> 949</span></a><span class="sd">        A tuple of NumPy arrays or TensorFlow tensors.</span>
</span><span id="image_patch_training_data_from_filenames-950"><a href="#image_patch_training_data_from_filenames-950"><span class="linenos"> 950</span></a><span class="sd">        - If `istest` is False: `(patchesResam, patchesOrig)`</span>
</span><span id="image_patch_training_data_from_filenames-951"><a href="#image_patch_training_data_from_filenames-951"><span class="linenos"> 951</span></a><span class="sd">            - `patchesResam`: The batch of low-resolution input patches (X_train).</span>
</span><span id="image_patch_training_data_from_filenames-952"><a href="#image_patch_training_data_from_filenames-952"><span class="linenos"> 952</span></a><span class="sd">            - `patchesOrig`: The batch of high-resolution ground truth patches (y_train).</span>
</span><span id="image_patch_training_data_from_filenames-953"><a href="#image_patch_training_data_from_filenames-953"><span class="linenos"> 953</span></a><span class="sd">        - If `istest` is True: `(patchesResam, patchesOrig, patchesUp)`</span>
</span><span id="image_patch_training_data_from_filenames-954"><a href="#image_patch_training_data_from_filenames-954"><span class="linenos"> 954</span></a><span class="sd">            - `patchesUp`: The batch of baseline, linearly-upsampled patches.</span>
</span><span id="image_patch_training_data_from_filenames-955"><a href="#image_patch_training_data_from_filenames-955"><span class="linenos"> 955</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="image_patch_training_data_from_filenames-956"><a href="#image_patch_training_data_from_filenames-956"><span class="linenos"> 956</span></a>    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="image_patch_training_data_from_filenames-957"><a href="#image_patch_training_data_from_filenames-957"><span class="linenos"> 957</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;begin image_patch_training_data_from_filenames&quot;</span><span class="p">)</span>
</span><span id="image_patch_training_data_from_filenames-958"><a href="#image_patch_training_data_from_filenames-958"><span class="linenos"> 958</span></a>    <span class="n">tardim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span> <span class="n">target_patch_size</span> <span class="p">)</span>
</span><span id="image_patch_training_data_from_filenames-959"><a href="#image_patch_training_data_from_filenames-959"><span class="linenos"> 959</span></a>    <span class="n">strider</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="image_patch_training_data_from_filenames-960"><a href="#image_patch_training_data_from_filenames-960"><span class="linenos"> 960</span></a>    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">tardim</span> <span class="p">):</span>
</span><span id="image_patch_training_data_from_filenames-961"><a href="#image_patch_training_data_from_filenames-961"><span class="linenos"> 961</span></a>        <span class="n">strider</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span> <span class="n">target_patch_size</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">/</span><span class="n">target_patch_size_low</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="p">)</span>
</span><span id="image_patch_training_data_from_filenames-962"><a href="#image_patch_training_data_from_filenames-962"><span class="linenos"> 962</span></a>    <span class="k">if</span> <span class="n">tardim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="image_patch_training_data_from_filenames-963"><a href="#image_patch_training_data_from_filenames-963"><span class="linenos"> 963</span></a>        <span class="n">shaperhi</span> <span class="o">=</span> <span class="p">(</span><span class="n">nPatches</span><span class="p">,</span><span class="n">target_patch_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">target_patch_size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">target_patch_size</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="mi">1</span><span class="p">)</span>
</span><span id="image_patch_training_data_from_filenames-964"><a href="#image_patch_training_data_from_filenames-964"><span class="linenos"> 964</span></a>        <span class="n">shaperlo</span> <span class="o">=</span> <span class="p">(</span><span class="n">nPatches</span><span class="p">,</span><span class="n">target_patch_size_low</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">target_patch_size_low</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">target_patch_size_low</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="mi">1</span><span class="p">)</span>
</span><span id="image_patch_training_data_from_filenames-965"><a href="#image_patch_training_data_from_filenames-965"><span class="linenos"> 965</span></a>    <span class="k">if</span> <span class="n">tardim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="image_patch_training_data_from_filenames-966"><a href="#image_patch_training_data_from_filenames-966"><span class="linenos"> 966</span></a>        <span class="n">shaperhi</span> <span class="o">=</span> <span class="p">(</span><span class="n">nPatches</span><span class="p">,</span><span class="n">target_patch_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">target_patch_size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="p">)</span>
</span><span id="image_patch_training_data_from_filenames-967"><a href="#image_patch_training_data_from_filenames-967"><span class="linenos"> 967</span></a>        <span class="n">shaperlo</span> <span class="o">=</span> <span class="p">(</span><span class="n">nPatches</span><span class="p">,</span><span class="n">target_patch_size_low</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">target_patch_size_low</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="p">)</span>
</span><span id="image_patch_training_data_from_filenames-968"><a href="#image_patch_training_data_from_filenames-968"><span class="linenos"> 968</span></a>    <span class="n">patchesOrig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">shaperhi</span><span class="p">)</span>
</span><span id="image_patch_training_data_from_filenames-969"><a href="#image_patch_training_data_from_filenames-969"><span class="linenos"> 969</span></a>    <span class="n">patchesResam</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">shaperlo</span><span class="p">)</span>
</span><span id="image_patch_training_data_from_filenames-970"><a href="#image_patch_training_data_from_filenames-970"><span class="linenos"> 970</span></a>    <span class="n">patchesUp</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="image_patch_training_data_from_filenames-971"><a href="#image_patch_training_data_from_filenames-971"><span class="linenos"> 971</span></a>    <span class="k">if</span> <span class="n">istest</span><span class="p">:</span>
</span><span id="image_patch_training_data_from_filenames-972"><a href="#image_patch_training_data_from_filenames-972"><span class="linenos"> 972</span></a>        <span class="n">patchesUp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">patchesOrig</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="image_patch_training_data_from_filenames-973"><a href="#image_patch_training_data_from_filenames-973"><span class="linenos"> 973</span></a>    <span class="k">for</span> <span class="n">myn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nPatches</span><span class="p">):</span>
</span><span id="image_patch_training_data_from_filenames-974"><a href="#image_patch_training_data_from_filenames-974"><span class="linenos"> 974</span></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="image_patch_training_data_from_filenames-975"><a href="#image_patch_training_data_from_filenames-975"><span class="linenos"> 975</span></a>                <span class="nb">print</span><span class="p">(</span><span class="n">myn</span><span class="p">)</span>
</span><span id="image_patch_training_data_from_filenames-976"><a href="#image_patch_training_data_from_filenames-976"><span class="linenos"> 976</span></a>            <span class="n">imgfn</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span> <span class="n">filenames</span><span class="p">,</span> <span class="mi">1</span> <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="image_patch_training_data_from_filenames-977"><a href="#image_patch_training_data_from_filenames-977"><span class="linenos"> 977</span></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="image_patch_training_data_from_filenames-978"><a href="#image_patch_training_data_from_filenames-978"><span class="linenos"> 978</span></a>                <span class="nb">print</span><span class="p">(</span><span class="n">imgfn</span><span class="p">)</span>
</span><span id="image_patch_training_data_from_filenames-979"><a href="#image_patch_training_data_from_filenames-979"><span class="linenos"> 979</span></a>            <span class="n">img</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">image_read</span><span class="p">(</span> <span class="n">imgfn</span> <span class="p">)</span><span class="o">.</span><span class="n">iMath</span><span class="p">(</span><span class="s2">&quot;Normalize&quot;</span><span class="p">)</span>
</span><span id="image_patch_training_data_from_filenames-980"><a href="#image_patch_training_data_from_filenames-980"><span class="linenos"> 980</span></a>            <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">components</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="image_patch_training_data_from_filenames-981"><a href="#image_patch_training_data_from_filenames-981"><span class="linenos"> 981</span></a>                <span class="n">img</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">split_channels</span><span class="p">(</span><span class="n">img</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="image_patch_training_data_from_filenames-982"><a href="#image_patch_training_data_from_filenames-982"><span class="linenos"> 982</span></a>            <span class="n">img</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">crop_image</span><span class="p">(</span> <span class="n">img</span><span class="p">,</span> <span class="n">ants</span><span class="o">.</span><span class="n">threshold_image</span><span class="p">(</span> <span class="n">img</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">)</span>
</span><span id="image_patch_training_data_from_filenames-983"><a href="#image_patch_training_data_from_filenames-983"><span class="linenos"> 983</span></a>            <span class="n">ants</span><span class="o">.</span><span class="n">set_origin</span><span class="p">(</span> <span class="n">img</span><span class="p">,</span> <span class="n">ants</span><span class="o">.</span><span class="n">get_center_of_mass</span><span class="p">(</span><span class="n">img</span><span class="p">)</span> <span class="p">)</span>
</span><span id="image_patch_training_data_from_filenames-984"><a href="#image_patch_training_data_from_filenames-984"><span class="linenos"> 984</span></a>            <span class="n">img</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">iMath</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="s2">&quot;Normalize&quot;</span><span class="p">)</span>
</span><span id="image_patch_training_data_from_filenames-985"><a href="#image_patch_training_data_from_filenames-985"><span class="linenos"> 985</span></a>            <span class="n">spc</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">get_spacing</span><span class="p">(</span> <span class="n">img</span> <span class="p">)</span>
</span><span id="image_patch_training_data_from_filenames-986"><a href="#image_patch_training_data_from_filenames-986"><span class="linenos"> 986</span></a>            <span class="n">newspc</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="image_patch_training_data_from_filenames-987"><a href="#image_patch_training_data_from_filenames-987"><span class="linenos"> 987</span></a>            <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spc</span><span class="p">)):</span>
</span><span id="image_patch_training_data_from_filenames-988"><a href="#image_patch_training_data_from_filenames-988"><span class="linenos"> 988</span></a>                <span class="n">newspc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spc</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span><span class="o">*</span><span class="n">strider</span><span class="p">[</span><span class="n">jj</span><span class="p">])</span>
</span><span id="image_patch_training_data_from_filenames-989"><a href="#image_patch_training_data_from_filenames-989"><span class="linenos"> 989</span></a>            <span class="n">interp_type</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
</span><span id="image_patch_training_data_from_filenames-990"><a href="#image_patch_training_data_from_filenames-990"><span class="linenos"> 990</span></a>            <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="image_patch_training_data_from_filenames-991"><a href="#image_patch_training_data_from_filenames-991"><span class="linenos"> 991</span></a>                <span class="n">imgp</span> <span class="o">=</span> <span class="n">get_random_patch</span><span class="p">(</span> <span class="n">img</span><span class="p">,</span> <span class="n">target_patch_size</span> <span class="p">)</span>
</span><span id="image_patch_training_data_from_filenames-992"><a href="#image_patch_training_data_from_filenames-992"><span class="linenos"> 992</span></a>                <span class="n">imgpmin</span> <span class="o">=</span> <span class="n">imgp</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
</span><span id="image_patch_training_data_from_filenames-993"><a href="#image_patch_training_data_from_filenames-993"><span class="linenos"> 993</span></a>                <span class="k">if</span> <span class="n">patch_scaler</span><span class="p">:</span>
</span><span id="image_patch_training_data_from_filenames-994"><a href="#image_patch_training_data_from_filenames-994"><span class="linenos"> 994</span></a>                    <span class="n">imgp</span> <span class="o">=</span> <span class="n">imgp</span> <span class="o">-</span> <span class="n">imgpmin</span>
</span><span id="image_patch_training_data_from_filenames-995"><a href="#image_patch_training_data_from_filenames-995"><span class="linenos"> 995</span></a>                    <span class="n">imgpmax</span> <span class="o">=</span> <span class="n">imgp</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</span><span id="image_patch_training_data_from_filenames-996"><a href="#image_patch_training_data_from_filenames-996"><span class="linenos"> 996</span></a>                    <span class="k">if</span> <span class="n">imgpmax</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">:</span>
</span><span id="image_patch_training_data_from_filenames-997"><a href="#image_patch_training_data_from_filenames-997"><span class="linenos"> 997</span></a>                        <span class="n">imgp</span> <span class="o">=</span> <span class="n">imgp</span> <span class="o">/</span> <span class="n">imgpmax</span>
</span><span id="image_patch_training_data_from_filenames-998"><a href="#image_patch_training_data_from_filenames-998"><span class="linenos"> 998</span></a>                <span class="n">rimgp</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">resample_image</span><span class="p">(</span> <span class="n">imgp</span><span class="p">,</span> <span class="n">newspc</span><span class="p">,</span> <span class="n">use_voxels</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">interp_type</span><span class="o">=</span><span class="n">interp_type</span>  <span class="p">)</span>
</span><span id="image_patch_training_data_from_filenames-999"><a href="#image_patch_training_data_from_filenames-999"><span class="linenos"> 999</span></a>                <span class="k">if</span> <span class="n">istest</span><span class="p">:</span>
</span><span id="image_patch_training_data_from_filenames-1000"><a href="#image_patch_training_data_from_filenames-1000"><span class="linenos">1000</span></a>                    <span class="n">rimgbi</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">resample_image</span><span class="p">(</span> <span class="n">rimgp</span><span class="p">,</span> <span class="n">spc</span><span class="p">,</span> <span class="n">use_voxels</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">interp_type</span><span class="o">=</span><span class="mi">0</span>  <span class="p">)</span>
</span><span id="image_patch_training_data_from_filenames-1001"><a href="#image_patch_training_data_from_filenames-1001"><span class="linenos">1001</span></a>                <span class="k">if</span> <span class="n">tardim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="image_patch_training_data_from_filenames-1002"><a href="#image_patch_training_data_from_filenames-1002"><span class="linenos">1002</span></a>                    <span class="n">patchesOrig</span><span class="p">[</span><span class="n">myn</span><span class="p">,:,:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">imgp</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="image_patch_training_data_from_filenames-1003"><a href="#image_patch_training_data_from_filenames-1003"><span class="linenos">1003</span></a>                    <span class="n">patchesResam</span><span class="p">[</span><span class="n">myn</span><span class="p">,:,:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">rimgp</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="image_patch_training_data_from_filenames-1004"><a href="#image_patch_training_data_from_filenames-1004"><span class="linenos">1004</span></a>                    <span class="k">if</span> <span class="n">istest</span><span class="p">:</span>
</span><span id="image_patch_training_data_from_filenames-1005"><a href="#image_patch_training_data_from_filenames-1005"><span class="linenos">1005</span></a>                        <span class="n">patchesUp</span><span class="p">[</span><span class="n">myn</span><span class="p">,:,:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">rimgbi</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="image_patch_training_data_from_filenames-1006"><a href="#image_patch_training_data_from_filenames-1006"><span class="linenos">1006</span></a>                <span class="k">if</span> <span class="n">tardim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="image_patch_training_data_from_filenames-1007"><a href="#image_patch_training_data_from_filenames-1007"><span class="linenos">1007</span></a>                    <span class="n">patchesOrig</span><span class="p">[</span><span class="n">myn</span><span class="p">,:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">imgp</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="image_patch_training_data_from_filenames-1008"><a href="#image_patch_training_data_from_filenames-1008"><span class="linenos">1008</span></a>                    <span class="n">patchesResam</span><span class="p">[</span><span class="n">myn</span><span class="p">,:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">rimgp</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="image_patch_training_data_from_filenames-1009"><a href="#image_patch_training_data_from_filenames-1009"><span class="linenos">1009</span></a>                    <span class="k">if</span> <span class="n">istest</span><span class="p">:</span>
</span><span id="image_patch_training_data_from_filenames-1010"><a href="#image_patch_training_data_from_filenames-1010"><span class="linenos">1010</span></a>                        <span class="n">patchesUp</span><span class="p">[</span><span class="n">myn</span><span class="p">,:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">rimgbi</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="image_patch_training_data_from_filenames-1011"><a href="#image_patch_training_data_from_filenames-1011"><span class="linenos">1011</span></a>    <span class="k">if</span> <span class="n">to_tensorflow</span><span class="p">:</span>
</span><span id="image_patch_training_data_from_filenames-1012"><a href="#image_patch_training_data_from_filenames-1012"><span class="linenos">1012</span></a>        <span class="n">patchesOrig</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span> <span class="n">patchesOrig</span><span class="p">,</span> <span class="s2">&quot;float32&quot;</span><span class="p">)</span>
</span><span id="image_patch_training_data_from_filenames-1013"><a href="#image_patch_training_data_from_filenames-1013"><span class="linenos">1013</span></a>        <span class="n">patchesResam</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span> <span class="n">patchesResam</span><span class="p">,</span> <span class="s2">&quot;float32&quot;</span><span class="p">)</span>
</span><span id="image_patch_training_data_from_filenames-1014"><a href="#image_patch_training_data_from_filenames-1014"><span class="linenos">1014</span></a>    <span class="k">if</span> <span class="n">istest</span><span class="p">:</span>
</span><span id="image_patch_training_data_from_filenames-1015"><a href="#image_patch_training_data_from_filenames-1015"><span class="linenos">1015</span></a>        <span class="k">if</span> <span class="n">to_tensorflow</span><span class="p">:</span>
</span><span id="image_patch_training_data_from_filenames-1016"><a href="#image_patch_training_data_from_filenames-1016"><span class="linenos">1016</span></a>            <span class="n">patchesUp</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span> <span class="n">patchesUp</span><span class="p">,</span> <span class="s2">&quot;float32&quot;</span><span class="p">)</span>
</span><span id="image_patch_training_data_from_filenames-1017"><a href="#image_patch_training_data_from_filenames-1017"><span class="linenos">1017</span></a>    <span class="k">return</span> <span class="n">patchesResam</span><span class="p">,</span> <span class="n">patchesOrig</span><span class="p">,</span> <span class="n">patchesUp</span>
</span></pre></div>


            <div class="docstring"><p>Generates a batch of paired high- and low-resolution image patches for training.</p>

<p>This function creates training data by taking a list of high-resolution source
images, extracting random patches, and then downsampling them to create
low-resolution counterparts. This provides the (input, ground_truth) pairs
needed to train a super-resolution model.</p>

<h2 id="parameters">Parameters</h2>

<p>filenames : list of str
    A list of file paths to the high-resolution source images.</p>

<p>target_patch_size : tuple or list of int
    The dimensions of the high-resolution (ground truth) patch to extract,
    e.g., <code>(128, 128, 128)</code>.</p>

<p>target_patch_size_low : tuple or list of int
    The dimensions of the low-resolution (input) patch to generate. The ratio
    between <code>target_patch_size</code> and <code>target_patch_size_low</code> determines the
    super-resolution factor.</p>

<p>nPatches : int, optional
    The number of patch pairs to generate in this batch. Default is 128.</p>

<p>istest : bool, optional
    If True, the function also generates a third output array containing patches
    that have been naively upsampled using linear interpolation. This is useful
    for calculating baseline evaluation metrics (e.g., PSNR) against which the
    model's performance can be compared. Default is False.</p>

<p>patch_scaler : bool, optional
    If True, scales the intensity of each high-resolution patch to the [0, 1]
    range before creating the downsampled version. This can help with
    training stability. Default is True.</p>

<p>to_tensorflow : bool, optional
    If True, casts the output NumPy arrays to TensorFlow tensors. Default is False.</p>

<p>verbose : bool, optional
    If True, prints progress messages during patch generation. Default is False.</p>

<h2 id="returns">Returns</h2>

<p>tuple
    A tuple of NumPy arrays or TensorFlow tensors.
    - If <code>istest</code> is False: <code>(patchesResam, patchesOrig)</code>
        - <code>patchesResam</code>: The batch of low-resolution input patches (X_train).
        - <code>patchesOrig</code>: The batch of high-resolution ground truth patches (y_train).
    - If <code>istest</code> is True: <code>(patchesResam, patchesOrig, patchesUp)</code>
        - <code>patchesUp</code>: The batch of baseline, linearly-upsampled patches.</p>
</div>


                </section>
                <section id="seg_patch_training_data_from_filenames">
                            <input id="seg_patch_training_data_from_filenames-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">seg_patch_training_data_from_filenames</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">filenames</span>,</span><span class="param">	<span class="n">target_patch_size</span>,</span><span class="param">	<span class="n">target_patch_size_low</span>,</span><span class="param">	<span class="n">nPatches</span><span class="o">=</span><span class="mi">128</span>,</span><span class="param">	<span class="n">istest</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">patch_scaler</span><span class="o">=</span><span class="kc">True</span>,</span><span class="param">	<span class="n">to_tensorflow</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">verbose</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="seg_patch_training_data_from_filenames-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#seg_patch_training_data_from_filenames"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="seg_patch_training_data_from_filenames-1020"><a href="#seg_patch_training_data_from_filenames-1020"><span class="linenos">1020</span></a><span class="k">def</span> <span class="nf">seg_patch_training_data_from_filenames</span><span class="p">(</span>
</span><span id="seg_patch_training_data_from_filenames-1021"><a href="#seg_patch_training_data_from_filenames-1021"><span class="linenos">1021</span></a>    <span class="n">filenames</span><span class="p">,</span>
</span><span id="seg_patch_training_data_from_filenames-1022"><a href="#seg_patch_training_data_from_filenames-1022"><span class="linenos">1022</span></a>    <span class="n">target_patch_size</span><span class="p">,</span>
</span><span id="seg_patch_training_data_from_filenames-1023"><a href="#seg_patch_training_data_from_filenames-1023"><span class="linenos">1023</span></a>    <span class="n">target_patch_size_low</span><span class="p">,</span>
</span><span id="seg_patch_training_data_from_filenames-1024"><a href="#seg_patch_training_data_from_filenames-1024"><span class="linenos">1024</span></a>    <span class="n">nPatches</span> <span class="o">=</span> <span class="mi">128</span><span class="p">,</span>
</span><span id="seg_patch_training_data_from_filenames-1025"><a href="#seg_patch_training_data_from_filenames-1025"><span class="linenos">1025</span></a>    <span class="n">istest</span>   <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="seg_patch_training_data_from_filenames-1026"><a href="#seg_patch_training_data_from_filenames-1026"><span class="linenos">1026</span></a>    <span class="n">patch_scaler</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="seg_patch_training_data_from_filenames-1027"><a href="#seg_patch_training_data_from_filenames-1027"><span class="linenos">1027</span></a>    <span class="n">to_tensorflow</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="seg_patch_training_data_from_filenames-1028"><a href="#seg_patch_training_data_from_filenames-1028"><span class="linenos">1028</span></a>    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="seg_patch_training_data_from_filenames-1029"><a href="#seg_patch_training_data_from_filenames-1029"><span class="linenos">1029</span></a>    <span class="p">):</span>
</span><span id="seg_patch_training_data_from_filenames-1030"><a href="#seg_patch_training_data_from_filenames-1030"><span class="linenos">1030</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="seg_patch_training_data_from_filenames-1031"><a href="#seg_patch_training_data_from_filenames-1031"><span class="linenos">1031</span></a><span class="sd">    Generates a batch of paired training data containing both images and segmentations.</span>
</span><span id="seg_patch_training_data_from_filenames-1032"><a href="#seg_patch_training_data_from_filenames-1032"><span class="linenos">1032</span></a>
</span><span id="seg_patch_training_data_from_filenames-1033"><a href="#seg_patch_training_data_from_filenames-1033"><span class="linenos">1033</span></a><span class="sd">    This function extends `image_patch_training_data_from_filenames` by adding a</span>
</span><span id="seg_patch_training_data_from_filenames-1034"><a href="#seg_patch_training_data_from_filenames-1034"><span class="linenos">1034</span></a><span class="sd">    second channel to the data. For each extracted image patch, it also generates</span>
</span><span id="seg_patch_training_data_from_filenames-1035"><a href="#seg_patch_training_data_from_filenames-1035"><span class="linenos">1035</span></a><span class="sd">    a corresponding segmentation mask using Otsu&#39;s thresholding. This is useful for</span>
</span><span id="seg_patch_training_data_from_filenames-1036"><a href="#seg_patch_training_data_from_filenames-1036"><span class="linenos">1036</span></a><span class="sd">    training multi-task models that perform super-resolution on both an image and</span>
</span><span id="seg_patch_training_data_from_filenames-1037"><a href="#seg_patch_training_data_from_filenames-1037"><span class="linenos">1037</span></a><span class="sd">    its associated segmentation simultaneously.</span>
</span><span id="seg_patch_training_data_from_filenames-1038"><a href="#seg_patch_training_data_from_filenames-1038"><span class="linenos">1038</span></a>
</span><span id="seg_patch_training_data_from_filenames-1039"><a href="#seg_patch_training_data_from_filenames-1039"><span class="linenos">1039</span></a><span class="sd">    Parameters</span>
</span><span id="seg_patch_training_data_from_filenames-1040"><a href="#seg_patch_training_data_from_filenames-1040"><span class="linenos">1040</span></a><span class="sd">    ----------</span>
</span><span id="seg_patch_training_data_from_filenames-1041"><a href="#seg_patch_training_data_from_filenames-1041"><span class="linenos">1041</span></a><span class="sd">    filenames : list of str</span>
</span><span id="seg_patch_training_data_from_filenames-1042"><a href="#seg_patch_training_data_from_filenames-1042"><span class="linenos">1042</span></a><span class="sd">        A list of file paths to the high-resolution source images.</span>
</span><span id="seg_patch_training_data_from_filenames-1043"><a href="#seg_patch_training_data_from_filenames-1043"><span class="linenos">1043</span></a>
</span><span id="seg_patch_training_data_from_filenames-1044"><a href="#seg_patch_training_data_from_filenames-1044"><span class="linenos">1044</span></a><span class="sd">    target_patch_size : tuple or list of int</span>
</span><span id="seg_patch_training_data_from_filenames-1045"><a href="#seg_patch_training_data_from_filenames-1045"><span class="linenos">1045</span></a><span class="sd">        The dimensions of the high-resolution patch, e.g., `(128, 128, 128)`.</span>
</span><span id="seg_patch_training_data_from_filenames-1046"><a href="#seg_patch_training_data_from_filenames-1046"><span class="linenos">1046</span></a>
</span><span id="seg_patch_training_data_from_filenames-1047"><a href="#seg_patch_training_data_from_filenames-1047"><span class="linenos">1047</span></a><span class="sd">    target_patch_size_low : tuple or list of int</span>
</span><span id="seg_patch_training_data_from_filenames-1048"><a href="#seg_patch_training_data_from_filenames-1048"><span class="linenos">1048</span></a><span class="sd">        The dimensions of the low-resolution input patch.</span>
</span><span id="seg_patch_training_data_from_filenames-1049"><a href="#seg_patch_training_data_from_filenames-1049"><span class="linenos">1049</span></a>
</span><span id="seg_patch_training_data_from_filenames-1050"><a href="#seg_patch_training_data_from_filenames-1050"><span class="linenos">1050</span></a><span class="sd">    nPatches : int, optional</span>
</span><span id="seg_patch_training_data_from_filenames-1051"><a href="#seg_patch_training_data_from_filenames-1051"><span class="linenos">1051</span></a><span class="sd">        The number of patch pairs to generate. Default is 128.</span>
</span><span id="seg_patch_training_data_from_filenames-1052"><a href="#seg_patch_training_data_from_filenames-1052"><span class="linenos">1052</span></a>
</span><span id="seg_patch_training_data_from_filenames-1053"><a href="#seg_patch_training_data_from_filenames-1053"><span class="linenos">1053</span></a><span class="sd">    istest : bool, optional</span>
</span><span id="seg_patch_training_data_from_filenames-1054"><a href="#seg_patch_training_data_from_filenames-1054"><span class="linenos">1054</span></a><span class="sd">        If True, also generates a third output array containing baseline upsampled</span>
</span><span id="seg_patch_training_data_from_filenames-1055"><a href="#seg_patch_training_data_from_filenames-1055"><span class="linenos">1055</span></a><span class="sd">        intensity images (channel 0 only). Default is False.</span>
</span><span id="seg_patch_training_data_from_filenames-1056"><a href="#seg_patch_training_data_from_filenames-1056"><span class="linenos">1056</span></a>
</span><span id="seg_patch_training_data_from_filenames-1057"><a href="#seg_patch_training_data_from_filenames-1057"><span class="linenos">1057</span></a><span class="sd">    patch_scaler : bool, optional</span>
</span><span id="seg_patch_training_data_from_filenames-1058"><a href="#seg_patch_training_data_from_filenames-1058"><span class="linenos">1058</span></a><span class="sd">        If True, scales the intensity of each image patch to the [0, 1] range.</span>
</span><span id="seg_patch_training_data_from_filenames-1059"><a href="#seg_patch_training_data_from_filenames-1059"><span class="linenos">1059</span></a><span class="sd">        Default is True.</span>
</span><span id="seg_patch_training_data_from_filenames-1060"><a href="#seg_patch_training_data_from_filenames-1060"><span class="linenos">1060</span></a>
</span><span id="seg_patch_training_data_from_filenames-1061"><a href="#seg_patch_training_data_from_filenames-1061"><span class="linenos">1061</span></a><span class="sd">    to_tensorflow : bool, optional</span>
</span><span id="seg_patch_training_data_from_filenames-1062"><a href="#seg_patch_training_data_from_filenames-1062"><span class="linenos">1062</span></a><span class="sd">        If True, casts the output NumPy arrays to TensorFlow tensors. Default is False.</span>
</span><span id="seg_patch_training_data_from_filenames-1063"><a href="#seg_patch_training_data_from_filenames-1063"><span class="linenos">1063</span></a>
</span><span id="seg_patch_training_data_from_filenames-1064"><a href="#seg_patch_training_data_from_filenames-1064"><span class="linenos">1064</span></a><span class="sd">    verbose : bool, optional</span>
</span><span id="seg_patch_training_data_from_filenames-1065"><a href="#seg_patch_training_data_from_filenames-1065"><span class="linenos">1065</span></a><span class="sd">        If True, prints progress messages. Default is False.</span>
</span><span id="seg_patch_training_data_from_filenames-1066"><a href="#seg_patch_training_data_from_filenames-1066"><span class="linenos">1066</span></a>
</span><span id="seg_patch_training_data_from_filenames-1067"><a href="#seg_patch_training_data_from_filenames-1067"><span class="linenos">1067</span></a><span class="sd">    Returns</span>
</span><span id="seg_patch_training_data_from_filenames-1068"><a href="#seg_patch_training_data_from_filenames-1068"><span class="linenos">1068</span></a><span class="sd">    -------</span>
</span><span id="seg_patch_training_data_from_filenames-1069"><a href="#seg_patch_training_data_from_filenames-1069"><span class="linenos">1069</span></a><span class="sd">    tuple</span>
</span><span id="seg_patch_training_data_from_filenames-1070"><a href="#seg_patch_training_data_from_filenames-1070"><span class="linenos">1070</span></a><span class="sd">        A tuple of multi-channel NumPy arrays or TensorFlow tensors. The structure</span>
</span><span id="seg_patch_training_data_from_filenames-1071"><a href="#seg_patch_training_data_from_filenames-1071"><span class="linenos">1071</span></a><span class="sd">        is the same as `image_patch_training_data_from_filenames`, but each</span>
</span><span id="seg_patch_training_data_from_filenames-1072"><a href="#seg_patch_training_data_from_filenames-1072"><span class="linenos">1072</span></a><span class="sd">        array has a channel dimension of 2:</span>
</span><span id="seg_patch_training_data_from_filenames-1073"><a href="#seg_patch_training_data_from_filenames-1073"><span class="linenos">1073</span></a><span class="sd">        - Channel 0: The intensity image.</span>
</span><span id="seg_patch_training_data_from_filenames-1074"><a href="#seg_patch_training_data_from_filenames-1074"><span class="linenos">1074</span></a><span class="sd">        - Channel 1: The binary segmentation mask.</span>
</span><span id="seg_patch_training_data_from_filenames-1075"><a href="#seg_patch_training_data_from_filenames-1075"><span class="linenos">1075</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="seg_patch_training_data_from_filenames-1076"><a href="#seg_patch_training_data_from_filenames-1076"><span class="linenos">1076</span></a>    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="seg_patch_training_data_from_filenames-1077"><a href="#seg_patch_training_data_from_filenames-1077"><span class="linenos">1077</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;begin seg_patch_training_data_from_filenames&quot;</span><span class="p">)</span>
</span><span id="seg_patch_training_data_from_filenames-1078"><a href="#seg_patch_training_data_from_filenames-1078"><span class="linenos">1078</span></a>    <span class="n">tardim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span> <span class="n">target_patch_size</span> <span class="p">)</span>
</span><span id="seg_patch_training_data_from_filenames-1079"><a href="#seg_patch_training_data_from_filenames-1079"><span class="linenos">1079</span></a>    <span class="n">strider</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="seg_patch_training_data_from_filenames-1080"><a href="#seg_patch_training_data_from_filenames-1080"><span class="linenos">1080</span></a>    <span class="n">nchan</span> <span class="o">=</span> <span class="mi">2</span>
</span><span id="seg_patch_training_data_from_filenames-1081"><a href="#seg_patch_training_data_from_filenames-1081"><span class="linenos">1081</span></a>    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">tardim</span> <span class="p">):</span>
</span><span id="seg_patch_training_data_from_filenames-1082"><a href="#seg_patch_training_data_from_filenames-1082"><span class="linenos">1082</span></a>        <span class="n">strider</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span> <span class="n">target_patch_size</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">/</span><span class="n">target_patch_size_low</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="p">)</span>
</span><span id="seg_patch_training_data_from_filenames-1083"><a href="#seg_patch_training_data_from_filenames-1083"><span class="linenos">1083</span></a>    <span class="k">if</span> <span class="n">tardim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="seg_patch_training_data_from_filenames-1084"><a href="#seg_patch_training_data_from_filenames-1084"><span class="linenos">1084</span></a>        <span class="n">shaperhi</span> <span class="o">=</span> <span class="p">(</span><span class="n">nPatches</span><span class="p">,</span><span class="n">target_patch_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">target_patch_size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">target_patch_size</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">nchan</span><span class="p">)</span>
</span><span id="seg_patch_training_data_from_filenames-1085"><a href="#seg_patch_training_data_from_filenames-1085"><span class="linenos">1085</span></a>        <span class="n">shaperlo</span> <span class="o">=</span> <span class="p">(</span><span class="n">nPatches</span><span class="p">,</span><span class="n">target_patch_size_low</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">target_patch_size_low</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">target_patch_size_low</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">nchan</span><span class="p">)</span>
</span><span id="seg_patch_training_data_from_filenames-1086"><a href="#seg_patch_training_data_from_filenames-1086"><span class="linenos">1086</span></a>    <span class="k">if</span> <span class="n">tardim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="seg_patch_training_data_from_filenames-1087"><a href="#seg_patch_training_data_from_filenames-1087"><span class="linenos">1087</span></a>        <span class="n">shaperhi</span> <span class="o">=</span> <span class="p">(</span><span class="n">nPatches</span><span class="p">,</span><span class="n">target_patch_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">target_patch_size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nchan</span><span class="p">)</span>
</span><span id="seg_patch_training_data_from_filenames-1088"><a href="#seg_patch_training_data_from_filenames-1088"><span class="linenos">1088</span></a>        <span class="n">shaperlo</span> <span class="o">=</span> <span class="p">(</span><span class="n">nPatches</span><span class="p">,</span><span class="n">target_patch_size_low</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">target_patch_size_low</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">nchan</span><span class="p">)</span>
</span><span id="seg_patch_training_data_from_filenames-1089"><a href="#seg_patch_training_data_from_filenames-1089"><span class="linenos">1089</span></a>    <span class="n">patchesOrig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">shaperhi</span><span class="p">)</span>
</span><span id="seg_patch_training_data_from_filenames-1090"><a href="#seg_patch_training_data_from_filenames-1090"><span class="linenos">1090</span></a>    <span class="n">patchesResam</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">shaperlo</span><span class="p">)</span>
</span><span id="seg_patch_training_data_from_filenames-1091"><a href="#seg_patch_training_data_from_filenames-1091"><span class="linenos">1091</span></a>    <span class="n">patchesUp</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="seg_patch_training_data_from_filenames-1092"><a href="#seg_patch_training_data_from_filenames-1092"><span class="linenos">1092</span></a>    <span class="k">if</span> <span class="n">istest</span><span class="p">:</span>
</span><span id="seg_patch_training_data_from_filenames-1093"><a href="#seg_patch_training_data_from_filenames-1093"><span class="linenos">1093</span></a>        <span class="n">patchesUp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">patchesOrig</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="seg_patch_training_data_from_filenames-1094"><a href="#seg_patch_training_data_from_filenames-1094"><span class="linenos">1094</span></a>    <span class="k">for</span> <span class="n">myn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nPatches</span><span class="p">):</span>
</span><span id="seg_patch_training_data_from_filenames-1095"><a href="#seg_patch_training_data_from_filenames-1095"><span class="linenos">1095</span></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="seg_patch_training_data_from_filenames-1096"><a href="#seg_patch_training_data_from_filenames-1096"><span class="linenos">1096</span></a>                <span class="nb">print</span><span class="p">(</span><span class="n">myn</span><span class="p">)</span>
</span><span id="seg_patch_training_data_from_filenames-1097"><a href="#seg_patch_training_data_from_filenames-1097"><span class="linenos">1097</span></a>            <span class="n">imgfn</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span> <span class="n">filenames</span><span class="p">,</span> <span class="mi">1</span> <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="seg_patch_training_data_from_filenames-1098"><a href="#seg_patch_training_data_from_filenames-1098"><span class="linenos">1098</span></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="seg_patch_training_data_from_filenames-1099"><a href="#seg_patch_training_data_from_filenames-1099"><span class="linenos">1099</span></a>                <span class="nb">print</span><span class="p">(</span><span class="n">imgfn</span><span class="p">)</span>
</span><span id="seg_patch_training_data_from_filenames-1100"><a href="#seg_patch_training_data_from_filenames-1100"><span class="linenos">1100</span></a>            <span class="n">img</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">image_read</span><span class="p">(</span> <span class="n">imgfn</span> <span class="p">)</span><span class="o">.</span><span class="n">iMath</span><span class="p">(</span><span class="s2">&quot;Normalize&quot;</span><span class="p">)</span>
</span><span id="seg_patch_training_data_from_filenames-1101"><a href="#seg_patch_training_data_from_filenames-1101"><span class="linenos">1101</span></a>            <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">components</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="seg_patch_training_data_from_filenames-1102"><a href="#seg_patch_training_data_from_filenames-1102"><span class="linenos">1102</span></a>                <span class="n">img</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">split_channels</span><span class="p">(</span><span class="n">img</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="seg_patch_training_data_from_filenames-1103"><a href="#seg_patch_training_data_from_filenames-1103"><span class="linenos">1103</span></a>            <span class="n">img</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">crop_image</span><span class="p">(</span> <span class="n">img</span><span class="p">,</span> <span class="n">ants</span><span class="o">.</span><span class="n">threshold_image</span><span class="p">(</span> <span class="n">img</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">)</span>
</span><span id="seg_patch_training_data_from_filenames-1104"><a href="#seg_patch_training_data_from_filenames-1104"><span class="linenos">1104</span></a>            <span class="n">ants</span><span class="o">.</span><span class="n">set_origin</span><span class="p">(</span> <span class="n">img</span><span class="p">,</span> <span class="n">ants</span><span class="o">.</span><span class="n">get_center_of_mass</span><span class="p">(</span><span class="n">img</span><span class="p">)</span> <span class="p">)</span>
</span><span id="seg_patch_training_data_from_filenames-1105"><a href="#seg_patch_training_data_from_filenames-1105"><span class="linenos">1105</span></a>            <span class="n">img</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">iMath</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="s2">&quot;Normalize&quot;</span><span class="p">)</span>
</span><span id="seg_patch_training_data_from_filenames-1106"><a href="#seg_patch_training_data_from_filenames-1106"><span class="linenos">1106</span></a>            <span class="n">spc</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">get_spacing</span><span class="p">(</span> <span class="n">img</span> <span class="p">)</span>
</span><span id="seg_patch_training_data_from_filenames-1107"><a href="#seg_patch_training_data_from_filenames-1107"><span class="linenos">1107</span></a>            <span class="n">newspc</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="seg_patch_training_data_from_filenames-1108"><a href="#seg_patch_training_data_from_filenames-1108"><span class="linenos">1108</span></a>            <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spc</span><span class="p">)):</span>
</span><span id="seg_patch_training_data_from_filenames-1109"><a href="#seg_patch_training_data_from_filenames-1109"><span class="linenos">1109</span></a>                <span class="n">newspc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spc</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span><span class="o">*</span><span class="n">strider</span><span class="p">[</span><span class="n">jj</span><span class="p">])</span>
</span><span id="seg_patch_training_data_from_filenames-1110"><a href="#seg_patch_training_data_from_filenames-1110"><span class="linenos">1110</span></a>            <span class="n">interp_type</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
</span><span id="seg_patch_training_data_from_filenames-1111"><a href="#seg_patch_training_data_from_filenames-1111"><span class="linenos">1111</span></a>            <span class="n">seg_class</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="p">)</span>
</span><span id="seg_patch_training_data_from_filenames-1112"><a href="#seg_patch_training_data_from_filenames-1112"><span class="linenos">1112</span></a>            <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="seg_patch_training_data_from_filenames-1113"><a href="#seg_patch_training_data_from_filenames-1113"><span class="linenos">1113</span></a>                <span class="n">imgp</span> <span class="o">=</span> <span class="n">get_random_patch</span><span class="p">(</span> <span class="n">img</span><span class="p">,</span> <span class="n">target_patch_size</span> <span class="p">)</span>
</span><span id="seg_patch_training_data_from_filenames-1114"><a href="#seg_patch_training_data_from_filenames-1114"><span class="linenos">1114</span></a>                <span class="n">imgpmin</span> <span class="o">=</span> <span class="n">imgp</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
</span><span id="seg_patch_training_data_from_filenames-1115"><a href="#seg_patch_training_data_from_filenames-1115"><span class="linenos">1115</span></a>                <span class="k">if</span> <span class="n">patch_scaler</span><span class="p">:</span>
</span><span id="seg_patch_training_data_from_filenames-1116"><a href="#seg_patch_training_data_from_filenames-1116"><span class="linenos">1116</span></a>                    <span class="n">imgp</span> <span class="o">=</span> <span class="n">imgp</span> <span class="o">-</span> <span class="n">imgpmin</span>
</span><span id="seg_patch_training_data_from_filenames-1117"><a href="#seg_patch_training_data_from_filenames-1117"><span class="linenos">1117</span></a>                    <span class="n">imgpmax</span> <span class="o">=</span> <span class="n">imgp</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</span><span id="seg_patch_training_data_from_filenames-1118"><a href="#seg_patch_training_data_from_filenames-1118"><span class="linenos">1118</span></a>                    <span class="k">if</span> <span class="n">imgpmax</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">:</span>
</span><span id="seg_patch_training_data_from_filenames-1119"><a href="#seg_patch_training_data_from_filenames-1119"><span class="linenos">1119</span></a>                        <span class="n">imgp</span> <span class="o">=</span> <span class="n">imgp</span> <span class="o">/</span> <span class="n">imgpmax</span>
</span><span id="seg_patch_training_data_from_filenames-1120"><a href="#seg_patch_training_data_from_filenames-1120"><span class="linenos">1120</span></a>                <span class="n">segp</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">threshold_image</span><span class="p">(</span> <span class="n">imgp</span><span class="p">,</span> <span class="s2">&quot;Otsu&quot;</span><span class="p">,</span> <span class="mi">2</span> <span class="p">)</span><span class="o">.</span><span class="n">threshold_image</span><span class="p">(</span> <span class="n">seg_class</span><span class="p">,</span> <span class="n">seg_class</span> <span class="p">)</span>
</span><span id="seg_patch_training_data_from_filenames-1121"><a href="#seg_patch_training_data_from_filenames-1121"><span class="linenos">1121</span></a>                <span class="n">rimgp</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">resample_image</span><span class="p">(</span> <span class="n">imgp</span><span class="p">,</span> <span class="n">newspc</span><span class="p">,</span> <span class="n">use_voxels</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">interp_type</span><span class="o">=</span><span class="n">interp_type</span>  <span class="p">)</span>
</span><span id="seg_patch_training_data_from_filenames-1122"><a href="#seg_patch_training_data_from_filenames-1122"><span class="linenos">1122</span></a>                <span class="n">rsegp</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">resample_image</span><span class="p">(</span> <span class="n">segp</span><span class="p">,</span> <span class="n">newspc</span><span class="p">,</span> <span class="n">use_voxels</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">interp_type</span><span class="o">=</span><span class="n">interp_type</span>  <span class="p">)</span>
</span><span id="seg_patch_training_data_from_filenames-1123"><a href="#seg_patch_training_data_from_filenames-1123"><span class="linenos">1123</span></a>                <span class="k">if</span> <span class="n">istest</span><span class="p">:</span>
</span><span id="seg_patch_training_data_from_filenames-1124"><a href="#seg_patch_training_data_from_filenames-1124"><span class="linenos">1124</span></a>                    <span class="n">rimgbi</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">resample_image</span><span class="p">(</span> <span class="n">rimgp</span><span class="p">,</span> <span class="n">spc</span><span class="p">,</span> <span class="n">use_voxels</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">interp_type</span><span class="o">=</span><span class="mi">0</span>  <span class="p">)</span>
</span><span id="seg_patch_training_data_from_filenames-1125"><a href="#seg_patch_training_data_from_filenames-1125"><span class="linenos">1125</span></a>                <span class="k">if</span> <span class="n">tardim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="seg_patch_training_data_from_filenames-1126"><a href="#seg_patch_training_data_from_filenames-1126"><span class="linenos">1126</span></a>                    <span class="n">patchesOrig</span><span class="p">[</span><span class="n">myn</span><span class="p">,:,:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">imgp</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="seg_patch_training_data_from_filenames-1127"><a href="#seg_patch_training_data_from_filenames-1127"><span class="linenos">1127</span></a>                    <span class="n">patchesResam</span><span class="p">[</span><span class="n">myn</span><span class="p">,:,:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">rimgp</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="seg_patch_training_data_from_filenames-1128"><a href="#seg_patch_training_data_from_filenames-1128"><span class="linenos">1128</span></a>                    <span class="n">patchesOrig</span><span class="p">[</span><span class="n">myn</span><span class="p">,:,:,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">segp</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="seg_patch_training_data_from_filenames-1129"><a href="#seg_patch_training_data_from_filenames-1129"><span class="linenos">1129</span></a>                    <span class="n">patchesResam</span><span class="p">[</span><span class="n">myn</span><span class="p">,:,:,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">rsegp</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="seg_patch_training_data_from_filenames-1130"><a href="#seg_patch_training_data_from_filenames-1130"><span class="linenos">1130</span></a>                    <span class="k">if</span> <span class="n">istest</span><span class="p">:</span>
</span><span id="seg_patch_training_data_from_filenames-1131"><a href="#seg_patch_training_data_from_filenames-1131"><span class="linenos">1131</span></a>                        <span class="n">patchesUp</span><span class="p">[</span><span class="n">myn</span><span class="p">,:,:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">rimgbi</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="seg_patch_training_data_from_filenames-1132"><a href="#seg_patch_training_data_from_filenames-1132"><span class="linenos">1132</span></a>                <span class="k">if</span> <span class="n">tardim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="seg_patch_training_data_from_filenames-1133"><a href="#seg_patch_training_data_from_filenames-1133"><span class="linenos">1133</span></a>                    <span class="n">patchesOrig</span><span class="p">[</span><span class="n">myn</span><span class="p">,:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">imgp</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="seg_patch_training_data_from_filenames-1134"><a href="#seg_patch_training_data_from_filenames-1134"><span class="linenos">1134</span></a>                    <span class="n">patchesResam</span><span class="p">[</span><span class="n">myn</span><span class="p">,:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">rimgp</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="seg_patch_training_data_from_filenames-1135"><a href="#seg_patch_training_data_from_filenames-1135"><span class="linenos">1135</span></a>                    <span class="n">patchesOrig</span><span class="p">[</span><span class="n">myn</span><span class="p">,:,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">segp</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="seg_patch_training_data_from_filenames-1136"><a href="#seg_patch_training_data_from_filenames-1136"><span class="linenos">1136</span></a>                    <span class="n">patchesResam</span><span class="p">[</span><span class="n">myn</span><span class="p">,:,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">rsegp</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="seg_patch_training_data_from_filenames-1137"><a href="#seg_patch_training_data_from_filenames-1137"><span class="linenos">1137</span></a>                    <span class="k">if</span> <span class="n">istest</span><span class="p">:</span>
</span><span id="seg_patch_training_data_from_filenames-1138"><a href="#seg_patch_training_data_from_filenames-1138"><span class="linenos">1138</span></a>                        <span class="n">patchesUp</span><span class="p">[</span><span class="n">myn</span><span class="p">,:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">rimgbi</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="seg_patch_training_data_from_filenames-1139"><a href="#seg_patch_training_data_from_filenames-1139"><span class="linenos">1139</span></a>    <span class="k">if</span> <span class="n">to_tensorflow</span><span class="p">:</span>
</span><span id="seg_patch_training_data_from_filenames-1140"><a href="#seg_patch_training_data_from_filenames-1140"><span class="linenos">1140</span></a>        <span class="n">patchesOrig</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span> <span class="n">patchesOrig</span><span class="p">,</span> <span class="s2">&quot;float32&quot;</span><span class="p">)</span>
</span><span id="seg_patch_training_data_from_filenames-1141"><a href="#seg_patch_training_data_from_filenames-1141"><span class="linenos">1141</span></a>        <span class="n">patchesResam</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span> <span class="n">patchesResam</span><span class="p">,</span> <span class="s2">&quot;float32&quot;</span><span class="p">)</span>
</span><span id="seg_patch_training_data_from_filenames-1142"><a href="#seg_patch_training_data_from_filenames-1142"><span class="linenos">1142</span></a>    <span class="k">if</span> <span class="n">istest</span><span class="p">:</span>
</span><span id="seg_patch_training_data_from_filenames-1143"><a href="#seg_patch_training_data_from_filenames-1143"><span class="linenos">1143</span></a>        <span class="k">if</span> <span class="n">to_tensorflow</span><span class="p">:</span>
</span><span id="seg_patch_training_data_from_filenames-1144"><a href="#seg_patch_training_data_from_filenames-1144"><span class="linenos">1144</span></a>            <span class="n">patchesUp</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span> <span class="n">patchesUp</span><span class="p">,</span> <span class="s2">&quot;float32&quot;</span><span class="p">)</span>
</span><span id="seg_patch_training_data_from_filenames-1145"><a href="#seg_patch_training_data_from_filenames-1145"><span class="linenos">1145</span></a>    <span class="k">return</span> <span class="n">patchesResam</span><span class="p">,</span> <span class="n">patchesOrig</span><span class="p">,</span> <span class="n">patchesUp</span>
</span></pre></div>


            <div class="docstring"><p>Generates a batch of paired training data containing both images and segmentations.</p>

<p>This function extends <code><a href="#image_patch_training_data_from_filenames">image_patch_training_data_from_filenames</a></code> by adding a
second channel to the data. For each extracted image patch, it also generates
a corresponding segmentation mask using Otsu's thresholding. This is useful for
training multi-task models that perform super-resolution on both an image and
its associated segmentation simultaneously.</p>

<h2 id="parameters">Parameters</h2>

<p>filenames : list of str
    A list of file paths to the high-resolution source images.</p>

<p>target_patch_size : tuple or list of int
    The dimensions of the high-resolution patch, e.g., <code>(128, 128, 128)</code>.</p>

<p>target_patch_size_low : tuple or list of int
    The dimensions of the low-resolution input patch.</p>

<p>nPatches : int, optional
    The number of patch pairs to generate. Default is 128.</p>

<p>istest : bool, optional
    If True, also generates a third output array containing baseline upsampled
    intensity images (channel 0 only). Default is False.</p>

<p>patch_scaler : bool, optional
    If True, scales the intensity of each image patch to the [0, 1] range.
    Default is True.</p>

<p>to_tensorflow : bool, optional
    If True, casts the output NumPy arrays to TensorFlow tensors. Default is False.</p>

<p>verbose : bool, optional
    If True, prints progress messages. Default is False.</p>

<h2 id="returns">Returns</h2>

<p>tuple
    A tuple of multi-channel NumPy arrays or TensorFlow tensors. The structure
    is the same as <code><a href="#image_patch_training_data_from_filenames">image_patch_training_data_from_filenames</a></code>, but each
    array has a channel dimension of 2:
    - Channel 0: The intensity image.
    - Channel 1: The binary segmentation mask.</p>
</div>


                </section>
                <section id="read">
                            <input id="read-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">read</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">filename</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="read-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#read"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="read-1147"><a href="#read-1147"><span class="linenos">1147</span></a><span class="k">def</span> <span class="nf">read</span><span class="p">(</span> <span class="n">filename</span> <span class="p">):</span>
</span><span id="read-1148"><a href="#read-1148"><span class="linenos">1148</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="read-1149"><a href="#read-1149"><span class="linenos">1149</span></a><span class="sd">    Reads an image or a NumPy array from a file.</span>
</span><span id="read-1150"><a href="#read-1150"><span class="linenos">1150</span></a>
</span><span id="read-1151"><a href="#read-1151"><span class="linenos">1151</span></a><span class="sd">    This function acts as a wrapper to intelligently load data. It checks the</span>
</span><span id="read-1152"><a href="#read-1152"><span class="linenos">1152</span></a><span class="sd">    file extension to decide whether to use `ants.image_read` for standard</span>
</span><span id="read-1153"><a href="#read-1153"><span class="linenos">1153</span></a><span class="sd">    medical image formats (e.g., .nii.gz, .mha) or `numpy.load` for `.npy` files.</span>
</span><span id="read-1154"><a href="#read-1154"><span class="linenos">1154</span></a>
</span><span id="read-1155"><a href="#read-1155"><span class="linenos">1155</span></a><span class="sd">    Parameters</span>
</span><span id="read-1156"><a href="#read-1156"><span class="linenos">1156</span></a><span class="sd">    ----------</span>
</span><span id="read-1157"><a href="#read-1157"><span class="linenos">1157</span></a><span class="sd">    filename : str</span>
</span><span id="read-1158"><a href="#read-1158"><span class="linenos">1158</span></a><span class="sd">        The full path to the file to be read.</span>
</span><span id="read-1159"><a href="#read-1159"><span class="linenos">1159</span></a>
</span><span id="read-1160"><a href="#read-1160"><span class="linenos">1160</span></a><span class="sd">    Returns</span>
</span><span id="read-1161"><a href="#read-1161"><span class="linenos">1161</span></a><span class="sd">    -------</span>
</span><span id="read-1162"><a href="#read-1162"><span class="linenos">1162</span></a><span class="sd">    ants.ANTsImage or np.ndarray</span>
</span><span id="read-1163"><a href="#read-1163"><span class="linenos">1163</span></a><span class="sd">        The loaded data object, either as an ANTsImage or a NumPy array.</span>
</span><span id="read-1164"><a href="#read-1164"><span class="linenos">1164</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="read-1165"><a href="#read-1165"><span class="linenos">1165</span></a>    <span class="kn">import</span> <span class="nn">re</span>
</span><span id="read-1166"><a href="#read-1166"><span class="linenos">1166</span></a>    <span class="n">isnpy</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span> <span class="s2">&quot;.npy&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">filename</span> <span class="p">)</span> <span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span> <span class="n">filename</span> <span class="p">)</span>
</span><span id="read-1167"><a href="#read-1167"><span class="linenos">1167</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">isnpy</span><span class="p">:</span>
</span><span id="read-1168"><a href="#read-1168"><span class="linenos">1168</span></a>        <span class="n">myoutput</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">image_read</span><span class="p">(</span> <span class="n">filename</span> <span class="p">)</span>
</span><span id="read-1169"><a href="#read-1169"><span class="linenos">1169</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="read-1170"><a href="#read-1170"><span class="linenos">1170</span></a>        <span class="n">myoutput</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span> <span class="n">filename</span> <span class="p">)</span>
</span><span id="read-1171"><a href="#read-1171"><span class="linenos">1171</span></a>    <span class="k">return</span> <span class="n">myoutput</span>
</span></pre></div>


            <div class="docstring"><p>Reads an image or a NumPy array from a file.</p>

<p>This function acts as a wrapper to intelligently load data. It checks the
file extension to decide whether to use <code>ants.image_read</code> for standard
medical image formats (e.g., .nii.gz, .mha) or <code>numpy.load</code> for <code>.npy</code> files.</p>

<h2 id="parameters">Parameters</h2>

<p>filename : str
    The full path to the file to be read.</p>

<h2 id="returns">Returns</h2>

<p>ants.ANTsImage or np.ndarray
    The loaded data object, either as an ANTsImage or a NumPy array.</p>
</div>


                </section>
                <section id="auto_weight_loss">
                            <input id="auto_weight_loss-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">auto_weight_loss</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">mdl</span>, </span><span class="param"><span class="n">feature_extractor</span>, </span><span class="param"><span class="n">x</span>, </span><span class="param"><span class="n">y</span>, </span><span class="param"><span class="n">feature</span><span class="o">=</span><span class="mf">2.0</span>, </span><span class="param"><span class="n">tv</span><span class="o">=</span><span class="mf">0.1</span>, </span><span class="param"><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="auto_weight_loss-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#auto_weight_loss"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="auto_weight_loss-1174"><a href="#auto_weight_loss-1174"><span class="linenos">1174</span></a><span class="k">def</span> <span class="nf">auto_weight_loss</span><span class="p">(</span> <span class="n">mdl</span><span class="p">,</span> <span class="n">feature_extractor</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">feature</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">tv</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span> <span class="p">):</span>
</span><span id="auto_weight_loss-1175"><a href="#auto_weight_loss-1175"><span class="linenos">1175</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="auto_weight_loss-1176"><a href="#auto_weight_loss-1176"><span class="linenos">1176</span></a><span class="sd">    Automatically compute weighting coefficients for a combined loss function</span>
</span><span id="auto_weight_loss-1177"><a href="#auto_weight_loss-1177"><span class="linenos">1177</span></a><span class="sd">    based on intensity (MSE), perceptual similarity (feature), and total variation (TV).</span>
</span><span id="auto_weight_loss-1178"><a href="#auto_weight_loss-1178"><span class="linenos">1178</span></a>
</span><span id="auto_weight_loss-1179"><a href="#auto_weight_loss-1179"><span class="linenos">1179</span></a><span class="sd">    Parameters</span>
</span><span id="auto_weight_loss-1180"><a href="#auto_weight_loss-1180"><span class="linenos">1180</span></a><span class="sd">    ----------</span>
</span><span id="auto_weight_loss-1181"><a href="#auto_weight_loss-1181"><span class="linenos">1181</span></a><span class="sd">    mdl : tf.keras.Model</span>
</span><span id="auto_weight_loss-1182"><a href="#auto_weight_loss-1182"><span class="linenos">1182</span></a><span class="sd">        A trained or untrained model to evaluate predictions on input `x`.</span>
</span><span id="auto_weight_loss-1183"><a href="#auto_weight_loss-1183"><span class="linenos">1183</span></a>
</span><span id="auto_weight_loss-1184"><a href="#auto_weight_loss-1184"><span class="linenos">1184</span></a><span class="sd">    feature_extractor : tf.keras.Model</span>
</span><span id="auto_weight_loss-1185"><a href="#auto_weight_loss-1185"><span class="linenos">1185</span></a><span class="sd">        A model that extracts intermediate features from the input. Commonly a VGG or ResNet</span>
</span><span id="auto_weight_loss-1186"><a href="#auto_weight_loss-1186"><span class="linenos">1186</span></a><span class="sd">        trained on a perceptual task.</span>
</span><span id="auto_weight_loss-1187"><a href="#auto_weight_loss-1187"><span class="linenos">1187</span></a>
</span><span id="auto_weight_loss-1188"><a href="#auto_weight_loss-1188"><span class="linenos">1188</span></a><span class="sd">    x : tf.Tensor</span>
</span><span id="auto_weight_loss-1189"><a href="#auto_weight_loss-1189"><span class="linenos">1189</span></a><span class="sd">        Input batch to the model.</span>
</span><span id="auto_weight_loss-1190"><a href="#auto_weight_loss-1190"><span class="linenos">1190</span></a>
</span><span id="auto_weight_loss-1191"><a href="#auto_weight_loss-1191"><span class="linenos">1191</span></a><span class="sd">    y : tf.Tensor</span>
</span><span id="auto_weight_loss-1192"><a href="#auto_weight_loss-1192"><span class="linenos">1192</span></a><span class="sd">        Ground truth target for `x`, typically a batch of 2D or 3D volumes.</span>
</span><span id="auto_weight_loss-1193"><a href="#auto_weight_loss-1193"><span class="linenos">1193</span></a>
</span><span id="auto_weight_loss-1194"><a href="#auto_weight_loss-1194"><span class="linenos">1194</span></a><span class="sd">    feature : float, optional</span>
</span><span id="auto_weight_loss-1195"><a href="#auto_weight_loss-1195"><span class="linenos">1195</span></a><span class="sd">        Weighting factor for the feature (perceptual) term in the loss. Default is 2.0.</span>
</span><span id="auto_weight_loss-1196"><a href="#auto_weight_loss-1196"><span class="linenos">1196</span></a>
</span><span id="auto_weight_loss-1197"><a href="#auto_weight_loss-1197"><span class="linenos">1197</span></a><span class="sd">    tv : float, optional</span>
</span><span id="auto_weight_loss-1198"><a href="#auto_weight_loss-1198"><span class="linenos">1198</span></a><span class="sd">        Weighting factor for the total variation term in the loss. Default is 0.1.</span>
</span><span id="auto_weight_loss-1199"><a href="#auto_weight_loss-1199"><span class="linenos">1199</span></a>
</span><span id="auto_weight_loss-1200"><a href="#auto_weight_loss-1200"><span class="linenos">1200</span></a><span class="sd">    verbose : bool, optional</span>
</span><span id="auto_weight_loss-1201"><a href="#auto_weight_loss-1201"><span class="linenos">1201</span></a><span class="sd">        If True, prints each component of the loss and its scaled value.</span>
</span><span id="auto_weight_loss-1202"><a href="#auto_weight_loss-1202"><span class="linenos">1202</span></a>
</span><span id="auto_weight_loss-1203"><a href="#auto_weight_loss-1203"><span class="linenos">1203</span></a><span class="sd">    Returns</span>
</span><span id="auto_weight_loss-1204"><a href="#auto_weight_loss-1204"><span class="linenos">1204</span></a><span class="sd">    -------</span>
</span><span id="auto_weight_loss-1205"><a href="#auto_weight_loss-1205"><span class="linenos">1205</span></a><span class="sd">    list of float</span>
</span><span id="auto_weight_loss-1206"><a href="#auto_weight_loss-1206"><span class="linenos">1206</span></a><span class="sd">        A list of computed weights in the order:</span>
</span><span id="auto_weight_loss-1207"><a href="#auto_weight_loss-1207"><span class="linenos">1207</span></a><span class="sd">        `[msq_weight, feature_weight, tv_weight]`</span>
</span><span id="auto_weight_loss-1208"><a href="#auto_weight_loss-1208"><span class="linenos">1208</span></a>
</span><span id="auto_weight_loss-1209"><a href="#auto_weight_loss-1209"><span class="linenos">1209</span></a><span class="sd">    Notes</span>
</span><span id="auto_weight_loss-1210"><a href="#auto_weight_loss-1210"><span class="linenos">1210</span></a><span class="sd">    -----</span>
</span><span id="auto_weight_loss-1211"><a href="#auto_weight_loss-1211"><span class="linenos">1211</span></a><span class="sd">    The total loss (to be used during training) can then be constructed as:</span>
</span><span id="auto_weight_loss-1212"><a href="#auto_weight_loss-1212"><span class="linenos">1212</span></a>
</span><span id="auto_weight_loss-1213"><a href="#auto_weight_loss-1213"><span class="linenos">1213</span></a><span class="sd">        `L = msq_weight * MSE + feature_weight * perceptual_loss + tv_weight * TV`</span>
</span><span id="auto_weight_loss-1214"><a href="#auto_weight_loss-1214"><span class="linenos">1214</span></a>
</span><span id="auto_weight_loss-1215"><a href="#auto_weight_loss-1215"><span class="linenos">1215</span></a><span class="sd">    This function is typically used to balance loss terms before training.</span>
</span><span id="auto_weight_loss-1216"><a href="#auto_weight_loss-1216"><span class="linenos">1216</span></a><span class="sd">    &quot;&quot;&quot;</span>    
</span><span id="auto_weight_loss-1217"><a href="#auto_weight_loss-1217"><span class="linenos">1217</span></a>    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">mdl</span><span class="p">(</span> <span class="n">x</span> <span class="p">)</span>
</span><span id="auto_weight_loss-1218"><a href="#auto_weight_loss-1218"><span class="linenos">1218</span></a>    <span class="n">squared_difference</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">square</span><span class="p">(</span> <span class="n">y</span> <span class="o">-</span> <span class="n">y_pred</span><span class="p">)</span>
</span><span id="auto_weight_loss-1219"><a href="#auto_weight_loss-1219"><span class="linenos">1219</span></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
</span><span id="auto_weight_loss-1220"><a href="#auto_weight_loss-1220"><span class="linenos">1220</span></a>            <span class="n">tdim</span> <span class="o">=</span> <span class="mi">3</span>
</span><span id="auto_weight_loss-1221"><a href="#auto_weight_loss-1221"><span class="linenos">1221</span></a>            <span class="n">myax</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span>
</span><span id="auto_weight_loss-1222"><a href="#auto_weight_loss-1222"><span class="linenos">1222</span></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
</span><span id="auto_weight_loss-1223"><a href="#auto_weight_loss-1223"><span class="linenos">1223</span></a>            <span class="n">tdim</span> <span class="o">=</span> <span class="mi">2</span>
</span><span id="auto_weight_loss-1224"><a href="#auto_weight_loss-1224"><span class="linenos">1224</span></a>            <span class="n">myax</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
</span><span id="auto_weight_loss-1225"><a href="#auto_weight_loss-1225"><span class="linenos">1225</span></a>    <span class="n">msqTerm</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">squared_difference</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">myax</span><span class="p">)</span>
</span><span id="auto_weight_loss-1226"><a href="#auto_weight_loss-1226"><span class="linenos">1226</span></a>    <span class="n">temp1</span> <span class="o">=</span> <span class="n">feature_extractor</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</span><span id="auto_weight_loss-1227"><a href="#auto_weight_loss-1227"><span class="linenos">1227</span></a>    <span class="n">temp2</span> <span class="o">=</span> <span class="n">feature_extractor</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span>
</span><span id="auto_weight_loss-1228"><a href="#auto_weight_loss-1228"><span class="linenos">1228</span></a>    <span class="n">feature_difference</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">temp1</span><span class="o">-</span><span class="n">temp2</span><span class="p">)</span>
</span><span id="auto_weight_loss-1229"><a href="#auto_weight_loss-1229"><span class="linenos">1229</span></a>    <span class="n">featureTerm</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">feature_difference</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">myax</span><span class="p">)</span>
</span><span id="auto_weight_loss-1230"><a href="#auto_weight_loss-1230"><span class="linenos">1230</span></a>    <span class="n">msqw</span> <span class="o">=</span> <span class="mf">10.0</span>
</span><span id="auto_weight_loss-1231"><a href="#auto_weight_loss-1231"><span class="linenos">1231</span></a>    <span class="n">featw</span> <span class="o">=</span> <span class="n">feature</span> <span class="o">*</span> <span class="n">msqw</span> <span class="o">*</span> <span class="n">msqTerm</span> <span class="o">/</span> <span class="n">featureTerm</span>
</span><span id="auto_weight_loss-1232"><a href="#auto_weight_loss-1232"><span class="linenos">1232</span></a>    <span class="n">mytv</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s1">&#39;float32&#39;</span><span class="p">)</span>
</span><span id="auto_weight_loss-1233"><a href="#auto_weight_loss-1233"><span class="linenos">1233</span></a>    <span class="k">if</span> <span class="n">tdim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="auto_weight_loss-1234"><a href="#auto_weight_loss-1234"><span class="linenos">1234</span></a>        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">y_pred</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">):</span> <span class="c1"># BUG not sure why myr fails .... might be old TF version</span>
</span><span id="auto_weight_loss-1235"><a href="#auto_weight_loss-1235"><span class="linenos">1235</span></a>            <span class="n">sqzd</span> <span class="o">=</span> <span class="n">y_pred</span><span class="p">[</span><span class="n">k</span><span class="p">,:,:,:,:]</span>
</span><span id="auto_weight_loss-1236"><a href="#auto_weight_loss-1236"><span class="linenos">1236</span></a>            <span class="n">mytv</span> <span class="o">=</span> <span class="n">mytv</span> <span class="o">+</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">total_variation</span><span class="p">(</span> <span class="n">sqzd</span> <span class="p">)</span> <span class="p">)</span>
</span><span id="auto_weight_loss-1237"><a href="#auto_weight_loss-1237"><span class="linenos">1237</span></a>    <span class="k">if</span> <span class="n">tdim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="auto_weight_loss-1238"><a href="#auto_weight_loss-1238"><span class="linenos">1238</span></a>        <span class="n">mytv</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">total_variation</span><span class="p">(</span> <span class="n">y_pred</span> <span class="p">)</span> <span class="p">)</span>
</span><span id="auto_weight_loss-1239"><a href="#auto_weight_loss-1239"><span class="linenos">1239</span></a>    <span class="n">tvw</span> <span class="o">=</span> <span class="n">tv</span> <span class="o">*</span> <span class="n">msqw</span> <span class="o">*</span> <span class="n">msqTerm</span> <span class="o">/</span> <span class="n">mytv</span>
</span><span id="auto_weight_loss-1240"><a href="#auto_weight_loss-1240"><span class="linenos">1240</span></a>    <span class="k">if</span> <span class="n">verbose</span> <span class="p">:</span>
</span><span id="auto_weight_loss-1241"><a href="#auto_weight_loss-1241"><span class="linenos">1241</span></a>        <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;MSQ: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span> <span class="n">msqw</span> <span class="o">*</span> <span class="n">msqTerm</span> <span class="p">)</span> <span class="p">)</span>
</span><span id="auto_weight_loss-1242"><a href="#auto_weight_loss-1242"><span class="linenos">1242</span></a>        <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Feat: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span> <span class="n">featw</span> <span class="o">*</span> <span class="n">featureTerm</span> <span class="p">)</span> <span class="p">)</span>
</span><span id="auto_weight_loss-1243"><a href="#auto_weight_loss-1243"><span class="linenos">1243</span></a>        <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Tv: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>  <span class="n">mytv</span> <span class="o">*</span> <span class="n">tvw</span> <span class="p">)</span> <span class="p">)</span>
</span><span id="auto_weight_loss-1244"><a href="#auto_weight_loss-1244"><span class="linenos">1244</span></a>    <span class="n">wts</span> <span class="o">=</span> <span class="p">[</span><span class="n">msqw</span><span class="p">,</span><span class="n">featw</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span><span class="n">tvw</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()]</span>
</span><span id="auto_weight_loss-1245"><a href="#auto_weight_loss-1245"><span class="linenos">1245</span></a>    <span class="k">return</span> <span class="n">wts</span>
</span></pre></div>


            <div class="docstring"><p>Automatically compute weighting coefficients for a combined loss function
based on intensity (MSE), perceptual similarity (feature), and total variation (TV).</p>

<h2 id="parameters">Parameters</h2>

<p>mdl : tf.keras.Model
    A trained or untrained model to evaluate predictions on input <code>x</code>.</p>

<p>feature_extractor : tf.keras.Model
    A model that extracts intermediate features from the input. Commonly a VGG or ResNet
    trained on a perceptual task.</p>

<p>x : tf.Tensor
    Input batch to the model.</p>

<p>y : tf.Tensor
    Ground truth target for <code>x</code>, typically a batch of 2D or 3D volumes.</p>

<p>feature : float, optional
    Weighting factor for the feature (perceptual) term in the loss. Default is 2.0.</p>

<p>tv : float, optional
    Weighting factor for the total variation term in the loss. Default is 0.1.</p>

<p>verbose : bool, optional
    If True, prints each component of the loss and its scaled value.</p>

<h2 id="returns">Returns</h2>

<p>list of float
    A list of computed weights in the order:
    <code>[msq_weight, feature_weight, tv_weight]</code></p>

<h2 id="notes">Notes</h2>

<p>The total loss (to be used during training) can then be constructed as:</p>

<pre><code>`L = msq_weight * MSE + feature_weight * perceptual_loss + tv_weight * TV`
</code></pre>

<p>This function is typically used to balance loss terms before training.</p>
</div>


                </section>
                <section id="auto_weight_loss_seg">
                            <input id="auto_weight_loss_seg-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">auto_weight_loss_seg</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">mdl</span>,</span><span class="param">	<span class="n">feature_extractor</span>,</span><span class="param">	<span class="n">x</span>,</span><span class="param">	<span class="n">y</span>,</span><span class="param">	<span class="n">feature</span><span class="o">=</span><span class="mf">2.0</span>,</span><span class="param">	<span class="n">tv</span><span class="o">=</span><span class="mf">0.1</span>,</span><span class="param">	<span class="n">dice</span><span class="o">=</span><span class="mf">0.5</span>,</span><span class="param">	<span class="n">verbose</span><span class="o">=</span><span class="kc">True</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="auto_weight_loss_seg-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#auto_weight_loss_seg"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="auto_weight_loss_seg-1247"><a href="#auto_weight_loss_seg-1247"><span class="linenos">1247</span></a><span class="k">def</span> <span class="nf">auto_weight_loss_seg</span><span class="p">(</span> <span class="n">mdl</span><span class="p">,</span> <span class="n">feature_extractor</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">feature</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">tv</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">dice</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span> <span class="p">):</span>
</span><span id="auto_weight_loss_seg-1248"><a href="#auto_weight_loss_seg-1248"><span class="linenos">1248</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="auto_weight_loss_seg-1249"><a href="#auto_weight_loss_seg-1249"><span class="linenos">1249</span></a><span class="sd">    Automatically compute weighting coefficients for a combined loss function</span>
</span><span id="auto_weight_loss_seg-1250"><a href="#auto_weight_loss_seg-1250"><span class="linenos">1250</span></a><span class="sd">    that includes MSE, perceptual similarity, total variation, and segmentation Dice loss.</span>
</span><span id="auto_weight_loss_seg-1251"><a href="#auto_weight_loss_seg-1251"><span class="linenos">1251</span></a>
</span><span id="auto_weight_loss_seg-1252"><a href="#auto_weight_loss_seg-1252"><span class="linenos">1252</span></a><span class="sd">    Parameters</span>
</span><span id="auto_weight_loss_seg-1253"><a href="#auto_weight_loss_seg-1253"><span class="linenos">1253</span></a><span class="sd">    ----------</span>
</span><span id="auto_weight_loss_seg-1254"><a href="#auto_weight_loss_seg-1254"><span class="linenos">1254</span></a><span class="sd">    mdl : tf.keras.Model</span>
</span><span id="auto_weight_loss_seg-1255"><a href="#auto_weight_loss_seg-1255"><span class="linenos">1255</span></a><span class="sd">        A segmentation + super-resolution model that outputs both image and label predictions.</span>
</span><span id="auto_weight_loss_seg-1256"><a href="#auto_weight_loss_seg-1256"><span class="linenos">1256</span></a>
</span><span id="auto_weight_loss_seg-1257"><a href="#auto_weight_loss_seg-1257"><span class="linenos">1257</span></a><span class="sd">    feature_extractor : tf.keras.Model</span>
</span><span id="auto_weight_loss_seg-1258"><a href="#auto_weight_loss_seg-1258"><span class="linenos">1258</span></a><span class="sd">        Feature extractor model used to compute perceptual similarity loss.</span>
</span><span id="auto_weight_loss_seg-1259"><a href="#auto_weight_loss_seg-1259"><span class="linenos">1259</span></a>
</span><span id="auto_weight_loss_seg-1260"><a href="#auto_weight_loss_seg-1260"><span class="linenos">1260</span></a><span class="sd">    x : tf.Tensor</span>
</span><span id="auto_weight_loss_seg-1261"><a href="#auto_weight_loss_seg-1261"><span class="linenos">1261</span></a><span class="sd">        Input tensor to the model.</span>
</span><span id="auto_weight_loss_seg-1262"><a href="#auto_weight_loss_seg-1262"><span class="linenos">1262</span></a>
</span><span id="auto_weight_loss_seg-1263"><a href="#auto_weight_loss_seg-1263"><span class="linenos">1263</span></a><span class="sd">    y : tf.Tensor</span>
</span><span id="auto_weight_loss_seg-1264"><a href="#auto_weight_loss_seg-1264"><span class="linenos">1264</span></a><span class="sd">        Target tensor with two channels: [intensity_image, segmentation_label].</span>
</span><span id="auto_weight_loss_seg-1265"><a href="#auto_weight_loss_seg-1265"><span class="linenos">1265</span></a>
</span><span id="auto_weight_loss_seg-1266"><a href="#auto_weight_loss_seg-1266"><span class="linenos">1266</span></a><span class="sd">    feature : float, optional</span>
</span><span id="auto_weight_loss_seg-1267"><a href="#auto_weight_loss_seg-1267"><span class="linenos">1267</span></a><span class="sd">        Relative weight of the perceptual feature loss term. Default is 2.0.</span>
</span><span id="auto_weight_loss_seg-1268"><a href="#auto_weight_loss_seg-1268"><span class="linenos">1268</span></a>
</span><span id="auto_weight_loss_seg-1269"><a href="#auto_weight_loss_seg-1269"><span class="linenos">1269</span></a><span class="sd">    tv : float, optional</span>
</span><span id="auto_weight_loss_seg-1270"><a href="#auto_weight_loss_seg-1270"><span class="linenos">1270</span></a><span class="sd">        Relative weight of the total variation (TV) term. Default is 0.1.</span>
</span><span id="auto_weight_loss_seg-1271"><a href="#auto_weight_loss_seg-1271"><span class="linenos">1271</span></a>
</span><span id="auto_weight_loss_seg-1272"><a href="#auto_weight_loss_seg-1272"><span class="linenos">1272</span></a><span class="sd">    dice : float, optional</span>
</span><span id="auto_weight_loss_seg-1273"><a href="#auto_weight_loss_seg-1273"><span class="linenos">1273</span></a><span class="sd">        Relative weight of the Dice loss term (for segmentation agreement). Default is 0.5.</span>
</span><span id="auto_weight_loss_seg-1274"><a href="#auto_weight_loss_seg-1274"><span class="linenos">1274</span></a>
</span><span id="auto_weight_loss_seg-1275"><a href="#auto_weight_loss_seg-1275"><span class="linenos">1275</span></a><span class="sd">    verbose : bool, optional</span>
</span><span id="auto_weight_loss_seg-1276"><a href="#auto_weight_loss_seg-1276"><span class="linenos">1276</span></a><span class="sd">        If True, prints the scaled values of each component loss.</span>
</span><span id="auto_weight_loss_seg-1277"><a href="#auto_weight_loss_seg-1277"><span class="linenos">1277</span></a>
</span><span id="auto_weight_loss_seg-1278"><a href="#auto_weight_loss_seg-1278"><span class="linenos">1278</span></a><span class="sd">    Returns</span>
</span><span id="auto_weight_loss_seg-1279"><a href="#auto_weight_loss_seg-1279"><span class="linenos">1279</span></a><span class="sd">    -------</span>
</span><span id="auto_weight_loss_seg-1280"><a href="#auto_weight_loss_seg-1280"><span class="linenos">1280</span></a><span class="sd">    list of float</span>
</span><span id="auto_weight_loss_seg-1281"><a href="#auto_weight_loss_seg-1281"><span class="linenos">1281</span></a><span class="sd">        A list of loss term weights in the order:</span>
</span><span id="auto_weight_loss_seg-1282"><a href="#auto_weight_loss_seg-1282"><span class="linenos">1282</span></a><span class="sd">        `[msq_weight, feature_weight, tv_weight, dice_weight]`</span>
</span><span id="auto_weight_loss_seg-1283"><a href="#auto_weight_loss_seg-1283"><span class="linenos">1283</span></a>
</span><span id="auto_weight_loss_seg-1284"><a href="#auto_weight_loss_seg-1284"><span class="linenos">1284</span></a><span class="sd">    Notes</span>
</span><span id="auto_weight_loss_seg-1285"><a href="#auto_weight_loss_seg-1285"><span class="linenos">1285</span></a><span class="sd">    -----</span>
</span><span id="auto_weight_loss_seg-1286"><a href="#auto_weight_loss_seg-1286"><span class="linenos">1286</span></a><span class="sd">    - The input and output tensors must be shaped such that the last axis is 2:</span>
</span><span id="auto_weight_loss_seg-1287"><a href="#auto_weight_loss_seg-1287"><span class="linenos">1287</span></a><span class="sd">      channel 0 is intensity, channel 1 is segmentation.</span>
</span><span id="auto_weight_loss_seg-1288"><a href="#auto_weight_loss_seg-1288"><span class="linenos">1288</span></a><span class="sd">    - This is useful for dual-task networks that predict both high-res images</span>
</span><span id="auto_weight_loss_seg-1289"><a href="#auto_weight_loss_seg-1289"><span class="linenos">1289</span></a><span class="sd">      and associated segmentation masks.</span>
</span><span id="auto_weight_loss_seg-1290"><a href="#auto_weight_loss_seg-1290"><span class="linenos">1290</span></a>
</span><span id="auto_weight_loss_seg-1291"><a href="#auto_weight_loss_seg-1291"><span class="linenos">1291</span></a><span class="sd">    See Also</span>
</span><span id="auto_weight_loss_seg-1292"><a href="#auto_weight_loss_seg-1292"><span class="linenos">1292</span></a><span class="sd">    --------</span>
</span><span id="auto_weight_loss_seg-1293"><a href="#auto_weight_loss_seg-1293"><span class="linenos">1293</span></a><span class="sd">    binary_dice_loss : Computes Dice loss between predicted and ground-truth masks.</span>
</span><span id="auto_weight_loss_seg-1294"><a href="#auto_weight_loss_seg-1294"><span class="linenos">1294</span></a><span class="sd">    &quot;&quot;&quot;</span>    
</span><span id="auto_weight_loss_seg-1295"><a href="#auto_weight_loss_seg-1295"><span class="linenos">1295</span></a>    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">mdl</span><span class="p">(</span> <span class="n">x</span> <span class="p">)</span>
</span><span id="auto_weight_loss_seg-1296"><a href="#auto_weight_loss_seg-1296"><span class="linenos">1296</span></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
</span><span id="auto_weight_loss_seg-1297"><a href="#auto_weight_loss_seg-1297"><span class="linenos">1297</span></a>            <span class="n">tdim</span> <span class="o">=</span> <span class="mi">3</span>
</span><span id="auto_weight_loss_seg-1298"><a href="#auto_weight_loss_seg-1298"><span class="linenos">1298</span></a>            <span class="n">myax</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span>
</span><span id="auto_weight_loss_seg-1299"><a href="#auto_weight_loss_seg-1299"><span class="linenos">1299</span></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
</span><span id="auto_weight_loss_seg-1300"><a href="#auto_weight_loss_seg-1300"><span class="linenos">1300</span></a>            <span class="n">tdim</span> <span class="o">=</span> <span class="mi">2</span>
</span><span id="auto_weight_loss_seg-1301"><a href="#auto_weight_loss_seg-1301"><span class="linenos">1301</span></a>            <span class="n">myax</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
</span><span id="auto_weight_loss_seg-1302"><a href="#auto_weight_loss_seg-1302"><span class="linenos">1302</span></a>    <span class="n">y_intensity</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span> <span class="n">y</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">tdim</span><span class="o">+</span><span class="mi">1</span> <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="auto_weight_loss_seg-1303"><a href="#auto_weight_loss_seg-1303"><span class="linenos">1303</span></a>    <span class="n">y_seg</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span> <span class="n">y</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">tdim</span><span class="o">+</span><span class="mi">1</span> <span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="auto_weight_loss_seg-1304"><a href="#auto_weight_loss_seg-1304"><span class="linenos">1304</span></a>    <span class="n">y_intensity_p</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span> <span class="n">y_pred</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">tdim</span><span class="o">+</span><span class="mi">1</span> <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="auto_weight_loss_seg-1305"><a href="#auto_weight_loss_seg-1305"><span class="linenos">1305</span></a>    <span class="n">y_seg_p</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span> <span class="n">y_pred</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">tdim</span><span class="o">+</span><span class="mi">1</span> <span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="auto_weight_loss_seg-1306"><a href="#auto_weight_loss_seg-1306"><span class="linenos">1306</span></a>    <span class="n">squared_difference</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">square</span><span class="p">(</span> <span class="n">y_intensity</span> <span class="o">-</span> <span class="n">y_intensity_p</span> <span class="p">)</span>
</span><span id="auto_weight_loss_seg-1307"><a href="#auto_weight_loss_seg-1307"><span class="linenos">1307</span></a>    <span class="n">msqTerm</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">squared_difference</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">myax</span><span class="p">)</span>
</span><span id="auto_weight_loss_seg-1308"><a href="#auto_weight_loss_seg-1308"><span class="linenos">1308</span></a>    <span class="n">temp1</span> <span class="o">=</span> <span class="n">feature_extractor</span><span class="p">(</span><span class="n">y_intensity</span><span class="p">)</span>
</span><span id="auto_weight_loss_seg-1309"><a href="#auto_weight_loss_seg-1309"><span class="linenos">1309</span></a>    <span class="n">temp2</span> <span class="o">=</span> <span class="n">feature_extractor</span><span class="p">(</span><span class="n">y_intensity_p</span><span class="p">)</span>
</span><span id="auto_weight_loss_seg-1310"><a href="#auto_weight_loss_seg-1310"><span class="linenos">1310</span></a>    <span class="n">feature_difference</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">temp1</span><span class="o">-</span><span class="n">temp2</span><span class="p">)</span>
</span><span id="auto_weight_loss_seg-1311"><a href="#auto_weight_loss_seg-1311"><span class="linenos">1311</span></a>    <span class="n">featureTerm</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">feature_difference</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">myax</span><span class="p">)</span>
</span><span id="auto_weight_loss_seg-1312"><a href="#auto_weight_loss_seg-1312"><span class="linenos">1312</span></a>    <span class="n">msqw</span> <span class="o">=</span> <span class="mf">10.0</span>
</span><span id="auto_weight_loss_seg-1313"><a href="#auto_weight_loss_seg-1313"><span class="linenos">1313</span></a>    <span class="n">featw</span> <span class="o">=</span> <span class="n">feature</span> <span class="o">*</span> <span class="n">msqw</span> <span class="o">*</span> <span class="n">msqTerm</span> <span class="o">/</span> <span class="n">featureTerm</span>
</span><span id="auto_weight_loss_seg-1314"><a href="#auto_weight_loss_seg-1314"><span class="linenos">1314</span></a>    <span class="n">mytv</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s1">&#39;float32&#39;</span><span class="p">)</span>
</span><span id="auto_weight_loss_seg-1315"><a href="#auto_weight_loss_seg-1315"><span class="linenos">1315</span></a>    <span class="k">if</span> <span class="n">tdim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="auto_weight_loss_seg-1316"><a href="#auto_weight_loss_seg-1316"><span class="linenos">1316</span></a>        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">y_pred</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">):</span> <span class="c1"># BUG not sure why myr fails .... might be old TF version</span>
</span><span id="auto_weight_loss_seg-1317"><a href="#auto_weight_loss_seg-1317"><span class="linenos">1317</span></a>            <span class="n">sqzd</span> <span class="o">=</span> <span class="n">y_pred</span><span class="p">[</span><span class="n">k</span><span class="p">,:,:,:,</span><span class="mi">0</span><span class="p">]</span>
</span><span id="auto_weight_loss_seg-1318"><a href="#auto_weight_loss_seg-1318"><span class="linenos">1318</span></a>            <span class="n">mytv</span> <span class="o">=</span> <span class="n">mytv</span> <span class="o">+</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">total_variation</span><span class="p">(</span> <span class="n">sqzd</span> <span class="p">)</span> <span class="p">)</span>
</span><span id="auto_weight_loss_seg-1319"><a href="#auto_weight_loss_seg-1319"><span class="linenos">1319</span></a>    <span class="k">if</span> <span class="n">tdim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="auto_weight_loss_seg-1320"><a href="#auto_weight_loss_seg-1320"><span class="linenos">1320</span></a>        <span class="n">mytv</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">total_variation</span><span class="p">(</span> <span class="n">y_pred</span><span class="p">[:,:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="p">)</span>
</span><span id="auto_weight_loss_seg-1321"><a href="#auto_weight_loss_seg-1321"><span class="linenos">1321</span></a>    <span class="n">tvw</span> <span class="o">=</span> <span class="n">tv</span> <span class="o">*</span> <span class="n">msqw</span> <span class="o">*</span> <span class="n">msqTerm</span> <span class="o">/</span> <span class="n">mytv</span>
</span><span id="auto_weight_loss_seg-1322"><a href="#auto_weight_loss_seg-1322"><span class="linenos">1322</span></a>    <span class="n">mydice</span> <span class="o">=</span> <span class="n">binary_dice_loss</span><span class="p">(</span> <span class="n">y_seg</span><span class="p">,</span> <span class="n">y_seg_p</span> <span class="p">)</span>
</span><span id="auto_weight_loss_seg-1323"><a href="#auto_weight_loss_seg-1323"><span class="linenos">1323</span></a>    <span class="n">mydice</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span> <span class="n">mydice</span> <span class="p">)</span>
</span><span id="auto_weight_loss_seg-1324"><a href="#auto_weight_loss_seg-1324"><span class="linenos">1324</span></a>    <span class="n">dicew</span> <span class="o">=</span> <span class="n">dice</span> <span class="o">*</span> <span class="n">msqw</span> <span class="o">*</span> <span class="n">msqTerm</span> <span class="o">/</span> <span class="n">mydice</span>
</span><span id="auto_weight_loss_seg-1325"><a href="#auto_weight_loss_seg-1325"><span class="linenos">1325</span></a>    <span class="n">dicewt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span> <span class="n">dicew</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="p">)</span>
</span><span id="auto_weight_loss_seg-1326"><a href="#auto_weight_loss_seg-1326"><span class="linenos">1326</span></a>    <span class="k">if</span> <span class="n">verbose</span> <span class="p">:</span>
</span><span id="auto_weight_loss_seg-1327"><a href="#auto_weight_loss_seg-1327"><span class="linenos">1327</span></a>        <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;MSQ: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span> <span class="n">msqw</span> <span class="o">*</span> <span class="n">msqTerm</span> <span class="p">)</span> <span class="p">)</span>
</span><span id="auto_weight_loss_seg-1328"><a href="#auto_weight_loss_seg-1328"><span class="linenos">1328</span></a>        <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Feat: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span> <span class="n">featw</span> <span class="o">*</span> <span class="n">featureTerm</span> <span class="p">)</span> <span class="p">)</span>
</span><span id="auto_weight_loss_seg-1329"><a href="#auto_weight_loss_seg-1329"><span class="linenos">1329</span></a>        <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Tv: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>  <span class="n">mytv</span> <span class="o">*</span> <span class="n">tvw</span> <span class="p">)</span> <span class="p">)</span>
</span><span id="auto_weight_loss_seg-1330"><a href="#auto_weight_loss_seg-1330"><span class="linenos">1330</span></a>        <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Dice: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span> <span class="n">mydice</span> <span class="o">*</span> <span class="n">dicewt</span> <span class="p">)</span> <span class="p">)</span>
</span><span id="auto_weight_loss_seg-1331"><a href="#auto_weight_loss_seg-1331"><span class="linenos">1331</span></a>    <span class="n">wts</span> <span class="o">=</span> <span class="p">[</span><span class="n">msqw</span><span class="p">,</span><span class="n">featw</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span><span class="n">tvw</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">dicewt</span> <span class="p">]</span>
</span><span id="auto_weight_loss_seg-1332"><a href="#auto_weight_loss_seg-1332"><span class="linenos">1332</span></a>    <span class="k">return</span> <span class="n">wts</span>
</span></pre></div>


            <div class="docstring"><p>Automatically compute weighting coefficients for a combined loss function
that includes MSE, perceptual similarity, total variation, and segmentation Dice loss.</p>

<h2 id="parameters">Parameters</h2>

<p>mdl : tf.keras.Model
    A segmentation + super-resolution model that outputs both image and label predictions.</p>

<p>feature_extractor : tf.keras.Model
    Feature extractor model used to compute perceptual similarity loss.</p>

<p>x : tf.Tensor
    Input tensor to the model.</p>

<p>y : tf.Tensor
    Target tensor with two channels: [intensity_image, segmentation_label].</p>

<p>feature : float, optional
    Relative weight of the perceptual feature loss term. Default is 2.0.</p>

<p>tv : float, optional
    Relative weight of the total variation (TV) term. Default is 0.1.</p>

<p>dice : float, optional
    Relative weight of the Dice loss term (for segmentation agreement). Default is 0.5.</p>

<p>verbose : bool, optional
    If True, prints the scaled values of each component loss.</p>

<h2 id="returns">Returns</h2>

<p>list of float
    A list of loss term weights in the order:
    <code>[msq_weight, feature_weight, tv_weight, dice_weight]</code></p>

<h2 id="notes">Notes</h2>

<ul>
<li>The input and output tensors must be shaped such that the last axis is 2:
channel 0 is intensity, channel 1 is segmentation.</li>
<li>This is useful for dual-task networks that predict both high-res images
and associated segmentation masks.</li>
</ul>

<h2 id="see-also">See Also</h2>

<p>binary_dice_loss : Computes Dice loss between predicted and ground-truth masks.</p>
</div>


                </section>
                <section id="numpy_generator">
                            <input id="numpy_generator-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">numpy_generator</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">filenames</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="numpy_generator-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#numpy_generator"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="numpy_generator-1334"><a href="#numpy_generator-1334"><span class="linenos">1334</span></a><span class="k">def</span> <span class="nf">numpy_generator</span><span class="p">(</span> <span class="n">filenames</span> <span class="p">):</span>
</span><span id="numpy_generator-1335"><a href="#numpy_generator-1335"><span class="linenos">1335</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="numpy_generator-1336"><a href="#numpy_generator-1336"><span class="linenos">1336</span></a><span class="sd">    A placeholder or stub for a data generator.</span>
</span><span id="numpy_generator-1337"><a href="#numpy_generator-1337"><span class="linenos">1337</span></a>
</span><span id="numpy_generator-1338"><a href="#numpy_generator-1338"><span class="linenos">1338</span></a><span class="sd">    This generator yields a tuple of `None` values once and then stops. It is</span>
</span><span id="numpy_generator-1339"><a href="#numpy_generator-1339"><span class="linenos">1339</span></a><span class="sd">    likely intended as a template or for debugging purposes where a generator</span>
</span><span id="numpy_generator-1340"><a href="#numpy_generator-1340"><span class="linenos">1340</span></a><span class="sd">    object is required but no actual data needs to be processed.</span>
</span><span id="numpy_generator-1341"><a href="#numpy_generator-1341"><span class="linenos">1341</span></a>
</span><span id="numpy_generator-1342"><a href="#numpy_generator-1342"><span class="linenos">1342</span></a><span class="sd">    Parameters</span>
</span><span id="numpy_generator-1343"><a href="#numpy_generator-1343"><span class="linenos">1343</span></a><span class="sd">    ----------</span>
</span><span id="numpy_generator-1344"><a href="#numpy_generator-1344"><span class="linenos">1344</span></a><span class="sd">    filenames : any</span>
</span><span id="numpy_generator-1345"><a href="#numpy_generator-1345"><span class="linenos">1345</span></a><span class="sd">        An argument that is not used by the function.</span>
</span><span id="numpy_generator-1346"><a href="#numpy_generator-1346"><span class="linenos">1346</span></a>
</span><span id="numpy_generator-1347"><a href="#numpy_generator-1347"><span class="linenos">1347</span></a><span class="sd">    Yields</span>
</span><span id="numpy_generator-1348"><a href="#numpy_generator-1348"><span class="linenos">1348</span></a><span class="sd">    ------</span>
</span><span id="numpy_generator-1349"><a href="#numpy_generator-1349"><span class="linenos">1349</span></a><span class="sd">    tuple</span>
</span><span id="numpy_generator-1350"><a href="#numpy_generator-1350"><span class="linenos">1350</span></a><span class="sd">        A single tuple `(None, None, None)`.</span>
</span><span id="numpy_generator-1351"><a href="#numpy_generator-1351"><span class="linenos">1351</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="numpy_generator-1352"><a href="#numpy_generator-1352"><span class="linenos">1352</span></a>    <span class="n">patchesResam</span><span class="o">=</span><span class="n">patchesOrig</span><span class="o">=</span><span class="n">patchesUp</span><span class="o">=</span><span class="kc">None</span>
</span><span id="numpy_generator-1353"><a href="#numpy_generator-1353"><span class="linenos">1353</span></a>    <span class="k">yield</span> <span class="p">(</span><span class="n">patchesResam</span><span class="p">,</span> <span class="n">patchesOrig</span><span class="p">,</span><span class="n">patchesUp</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>A placeholder or stub for a data generator.</p>

<p>This generator yields a tuple of <code>None</code> values once and then stops. It is
likely intended as a template or for debugging purposes where a generator
object is required but no actual data needs to be processed.</p>

<h2 id="parameters">Parameters</h2>

<p>filenames : any
    An argument that is not used by the function.</p>

<h2 id="yields">Yields</h2>

<p>tuple
    A single tuple <code>(None, None, None)</code>.</p>
</div>


                </section>
                <section id="image_generator">
                            <input id="image_generator-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">image_generator</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">filenames</span>,</span><span class="param">	<span class="n">nPatches</span>,</span><span class="param">	<span class="n">target_patch_size</span>,</span><span class="param">	<span class="n">target_patch_size_low</span>,</span><span class="param">	<span class="n">patch_scaler</span><span class="o">=</span><span class="kc">True</span>,</span><span class="param">	<span class="n">istest</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">verbose</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="image_generator-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#image_generator"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="image_generator-1355"><a href="#image_generator-1355"><span class="linenos">1355</span></a><span class="k">def</span> <span class="nf">image_generator</span><span class="p">(</span>
</span><span id="image_generator-1356"><a href="#image_generator-1356"><span class="linenos">1356</span></a>    <span class="n">filenames</span><span class="p">,</span>
</span><span id="image_generator-1357"><a href="#image_generator-1357"><span class="linenos">1357</span></a>    <span class="n">nPatches</span><span class="p">,</span>
</span><span id="image_generator-1358"><a href="#image_generator-1358"><span class="linenos">1358</span></a>    <span class="n">target_patch_size</span><span class="p">,</span>
</span><span id="image_generator-1359"><a href="#image_generator-1359"><span class="linenos">1359</span></a>    <span class="n">target_patch_size_low</span><span class="p">,</span>
</span><span id="image_generator-1360"><a href="#image_generator-1360"><span class="linenos">1360</span></a>    <span class="n">patch_scaler</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="image_generator-1361"><a href="#image_generator-1361"><span class="linenos">1361</span></a>    <span class="n">istest</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="image_generator-1362"><a href="#image_generator-1362"><span class="linenos">1362</span></a>    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span> <span class="p">):</span>
</span><span id="image_generator-1363"><a href="#image_generator-1363"><span class="linenos">1363</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="image_generator-1364"><a href="#image_generator-1364"><span class="linenos">1364</span></a><span class="sd">    Creates an infinite generator of paired image patches for model training.</span>
</span><span id="image_generator-1365"><a href="#image_generator-1365"><span class="linenos">1365</span></a>
</span><span id="image_generator-1366"><a href="#image_generator-1366"><span class="linenos">1366</span></a><span class="sd">    This function continuously generates batches of low-resolution (input) and</span>
</span><span id="image_generator-1367"><a href="#image_generator-1367"><span class="linenos">1367</span></a><span class="sd">    high-resolution (ground truth) image patches. It is designed to be fed</span>
</span><span id="image_generator-1368"><a href="#image_generator-1368"><span class="linenos">1368</span></a><span class="sd">    directly into a Keras `model.fit()` call.</span>
</span><span id="image_generator-1369"><a href="#image_generator-1369"><span class="linenos">1369</span></a>
</span><span id="image_generator-1370"><a href="#image_generator-1370"><span class="linenos">1370</span></a><span class="sd">    Parameters</span>
</span><span id="image_generator-1371"><a href="#image_generator-1371"><span class="linenos">1371</span></a><span class="sd">    ----------</span>
</span><span id="image_generator-1372"><a href="#image_generator-1372"><span class="linenos">1372</span></a><span class="sd">    filenames : list of str</span>
</span><span id="image_generator-1373"><a href="#image_generator-1373"><span class="linenos">1373</span></a><span class="sd">        List of file paths to the high-resolution source images.</span>
</span><span id="image_generator-1374"><a href="#image_generator-1374"><span class="linenos">1374</span></a><span class="sd">    nPatches : int</span>
</span><span id="image_generator-1375"><a href="#image_generator-1375"><span class="linenos">1375</span></a><span class="sd">        The number of patch pairs to generate and yield in each batch.</span>
</span><span id="image_generator-1376"><a href="#image_generator-1376"><span class="linenos">1376</span></a><span class="sd">    target_patch_size : tuple or list of int</span>
</span><span id="image_generator-1377"><a href="#image_generator-1377"><span class="linenos">1377</span></a><span class="sd">        The dimensions of the high-resolution (ground truth) patches.</span>
</span><span id="image_generator-1378"><a href="#image_generator-1378"><span class="linenos">1378</span></a><span class="sd">    target_patch_size_low : tuple or list of int</span>
</span><span id="image_generator-1379"><a href="#image_generator-1379"><span class="linenos">1379</span></a><span class="sd">        The dimensions of the low-resolution (input) patches.</span>
</span><span id="image_generator-1380"><a href="#image_generator-1380"><span class="linenos">1380</span></a><span class="sd">    patch_scaler : bool, optional</span>
</span><span id="image_generator-1381"><a href="#image_generator-1381"><span class="linenos">1381</span></a><span class="sd">        If True, scales patch intensities to [0, 1]. Default is True.</span>
</span><span id="image_generator-1382"><a href="#image_generator-1382"><span class="linenos">1382</span></a><span class="sd">    istest : bool, optional</span>
</span><span id="image_generator-1383"><a href="#image_generator-1383"><span class="linenos">1383</span></a><span class="sd">        If True, the generator will also yield a third item: a baseline</span>
</span><span id="image_generator-1384"><a href="#image_generator-1384"><span class="linenos">1384</span></a><span class="sd">        linearly upsampled version of the low-resolution patch for comparison.</span>
</span><span id="image_generator-1385"><a href="#image_generator-1385"><span class="linenos">1385</span></a><span class="sd">        Default is False.</span>
</span><span id="image_generator-1386"><a href="#image_generator-1386"><span class="linenos">1386</span></a><span class="sd">    verbose : bool, optional</span>
</span><span id="image_generator-1387"><a href="#image_generator-1387"><span class="linenos">1387</span></a><span class="sd">        If True, passes verbosity to the underlying patch generation function.</span>
</span><span id="image_generator-1388"><a href="#image_generator-1388"><span class="linenos">1388</span></a><span class="sd">        Default is False.</span>
</span><span id="image_generator-1389"><a href="#image_generator-1389"><span class="linenos">1389</span></a>
</span><span id="image_generator-1390"><a href="#image_generator-1390"><span class="linenos">1390</span></a><span class="sd">    Yields</span>
</span><span id="image_generator-1391"><a href="#image_generator-1391"><span class="linenos">1391</span></a><span class="sd">    -------</span>
</span><span id="image_generator-1392"><a href="#image_generator-1392"><span class="linenos">1392</span></a><span class="sd">    tuple</span>
</span><span id="image_generator-1393"><a href="#image_generator-1393"><span class="linenos">1393</span></a><span class="sd">        A tuple of TensorFlow tensors ready for training or evaluation.</span>
</span><span id="image_generator-1394"><a href="#image_generator-1394"><span class="linenos">1394</span></a><span class="sd">        - If `istest` is False: `(low_res_batch, high_res_batch)`</span>
</span><span id="image_generator-1395"><a href="#image_generator-1395"><span class="linenos">1395</span></a><span class="sd">        - If `istest` is True: `(low_res_batch, high_res_batch, baseline_upsampled_batch)`</span>
</span><span id="image_generator-1396"><a href="#image_generator-1396"><span class="linenos">1396</span></a>
</span><span id="image_generator-1397"><a href="#image_generator-1397"><span class="linenos">1397</span></a><span class="sd">    See Also</span>
</span><span id="image_generator-1398"><a href="#image_generator-1398"><span class="linenos">1398</span></a><span class="sd">    --------</span>
</span><span id="image_generator-1399"><a href="#image_generator-1399"><span class="linenos">1399</span></a><span class="sd">    image_patch_training_data_from_filenames : The function that performs the</span>
</span><span id="image_generator-1400"><a href="#image_generator-1400"><span class="linenos">1400</span></a><span class="sd">                                               underlying patch extraction.</span>
</span><span id="image_generator-1401"><a href="#image_generator-1401"><span class="linenos">1401</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="image_generator-1402"><a href="#image_generator-1402"><span class="linenos">1402</span></a>    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="image_generator-1403"><a href="#image_generator-1403"><span class="linenos">1403</span></a>        <span class="n">patchesResam</span><span class="p">,</span> <span class="n">patchesOrig</span><span class="p">,</span> <span class="n">patchesUp</span> <span class="o">=</span> <span class="n">image_patch_training_data_from_filenames</span><span class="p">(</span>
</span><span id="image_generator-1404"><a href="#image_generator-1404"><span class="linenos">1404</span></a>            <span class="n">filenames</span><span class="p">,</span>
</span><span id="image_generator-1405"><a href="#image_generator-1405"><span class="linenos">1405</span></a>            <span class="n">target_patch_size</span> <span class="o">=</span> <span class="n">target_patch_size</span><span class="p">,</span>
</span><span id="image_generator-1406"><a href="#image_generator-1406"><span class="linenos">1406</span></a>            <span class="n">target_patch_size_low</span> <span class="o">=</span> <span class="n">target_patch_size_low</span><span class="p">,</span>
</span><span id="image_generator-1407"><a href="#image_generator-1407"><span class="linenos">1407</span></a>            <span class="n">nPatches</span> <span class="o">=</span> <span class="n">nPatches</span><span class="p">,</span>
</span><span id="image_generator-1408"><a href="#image_generator-1408"><span class="linenos">1408</span></a>            <span class="n">istest</span>   <span class="o">=</span> <span class="n">istest</span><span class="p">,</span>
</span><span id="image_generator-1409"><a href="#image_generator-1409"><span class="linenos">1409</span></a>            <span class="n">patch_scaler</span><span class="o">=</span><span class="n">patch_scaler</span><span class="p">,</span>
</span><span id="image_generator-1410"><a href="#image_generator-1410"><span class="linenos">1410</span></a>            <span class="n">to_tensorflow</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="image_generator-1411"><a href="#image_generator-1411"><span class="linenos">1411</span></a>            <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span> <span class="p">)</span>
</span><span id="image_generator-1412"><a href="#image_generator-1412"><span class="linenos">1412</span></a>        <span class="k">if</span> <span class="n">istest</span><span class="p">:</span>
</span><span id="image_generator-1413"><a href="#image_generator-1413"><span class="linenos">1413</span></a>            <span class="k">yield</span> <span class="p">(</span><span class="n">patchesResam</span><span class="p">,</span> <span class="n">patchesOrig</span><span class="p">,</span><span class="n">patchesUp</span><span class="p">)</span>
</span><span id="image_generator-1414"><a href="#image_generator-1414"><span class="linenos">1414</span></a>        <span class="k">yield</span> <span class="p">(</span><span class="n">patchesResam</span><span class="p">,</span> <span class="n">patchesOrig</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Creates an infinite generator of paired image patches for model training.</p>

<p>This function continuously generates batches of low-resolution (input) and
high-resolution (ground truth) image patches. It is designed to be fed
directly into a Keras <code>model.fit()</code> call.</p>

<h2 id="parameters">Parameters</h2>

<p>filenames : list of str
    List of file paths to the high-resolution source images.
nPatches : int
    The number of patch pairs to generate and yield in each batch.
target_patch_size : tuple or list of int
    The dimensions of the high-resolution (ground truth) patches.
target_patch_size_low : tuple or list of int
    The dimensions of the low-resolution (input) patches.
patch_scaler : bool, optional
    If True, scales patch intensities to [0, 1]. Default is True.
istest : bool, optional
    If True, the generator will also yield a third item: a baseline
    linearly upsampled version of the low-resolution patch for comparison.
    Default is False.
verbose : bool, optional
    If True, passes verbosity to the underlying patch generation function.
    Default is False.</p>

<h2 id="yields">Yields</h2>

<p>tuple
    A tuple of TensorFlow tensors ready for training or evaluation.
    - If <code>istest</code> is False: <code>(low_res_batch, high_res_batch)</code>
    - If <code>istest</code> is True: <code>(low_res_batch, high_res_batch, baseline_upsampled_batch)</code></p>

<h2 id="see-also">See Also</h2>

<p>image_patch_training_data_from_filenames : The function that performs the
                                           underlying patch extraction.</p>
</div>


                </section>
                <section id="seg_generator">
                            <input id="seg_generator-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">seg_generator</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">filenames</span>,</span><span class="param">	<span class="n">nPatches</span>,</span><span class="param">	<span class="n">target_patch_size</span>,</span><span class="param">	<span class="n">target_patch_size_low</span>,</span><span class="param">	<span class="n">patch_scaler</span><span class="o">=</span><span class="kc">True</span>,</span><span class="param">	<span class="n">istest</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">verbose</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="seg_generator-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#seg_generator"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="seg_generator-1417"><a href="#seg_generator-1417"><span class="linenos">1417</span></a><span class="k">def</span> <span class="nf">seg_generator</span><span class="p">(</span>
</span><span id="seg_generator-1418"><a href="#seg_generator-1418"><span class="linenos">1418</span></a>    <span class="n">filenames</span><span class="p">,</span>
</span><span id="seg_generator-1419"><a href="#seg_generator-1419"><span class="linenos">1419</span></a>    <span class="n">nPatches</span><span class="p">,</span>
</span><span id="seg_generator-1420"><a href="#seg_generator-1420"><span class="linenos">1420</span></a>    <span class="n">target_patch_size</span><span class="p">,</span>
</span><span id="seg_generator-1421"><a href="#seg_generator-1421"><span class="linenos">1421</span></a>    <span class="n">target_patch_size_low</span><span class="p">,</span>
</span><span id="seg_generator-1422"><a href="#seg_generator-1422"><span class="linenos">1422</span></a>    <span class="n">patch_scaler</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="seg_generator-1423"><a href="#seg_generator-1423"><span class="linenos">1423</span></a>    <span class="n">istest</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="seg_generator-1424"><a href="#seg_generator-1424"><span class="linenos">1424</span></a>    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span> <span class="p">):</span>
</span><span id="seg_generator-1425"><a href="#seg_generator-1425"><span class="linenos">1425</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="seg_generator-1426"><a href="#seg_generator-1426"><span class="linenos">1426</span></a><span class="sd">    Creates an infinite generator of paired image and segmentation patches.</span>
</span><span id="seg_generator-1427"><a href="#seg_generator-1427"><span class="linenos">1427</span></a>
</span><span id="seg_generator-1428"><a href="#seg_generator-1428"><span class="linenos">1428</span></a><span class="sd">    This function continuously generates batches of multi-channel patches, where</span>
</span><span id="seg_generator-1429"><a href="#seg_generator-1429"><span class="linenos">1429</span></a><span class="sd">    one channel is the intensity image and the other is a segmentation mask.</span>
</span><span id="seg_generator-1430"><a href="#seg_generator-1430"><span class="linenos">1430</span></a><span class="sd">    It is designed for training multi-task super-resolution models.</span>
</span><span id="seg_generator-1431"><a href="#seg_generator-1431"><span class="linenos">1431</span></a>
</span><span id="seg_generator-1432"><a href="#seg_generator-1432"><span class="linenos">1432</span></a><span class="sd">    Parameters</span>
</span><span id="seg_generator-1433"><a href="#seg_generator-1433"><span class="linenos">1433</span></a><span class="sd">    ----------</span>
</span><span id="seg_generator-1434"><a href="#seg_generator-1434"><span class="linenos">1434</span></a><span class="sd">    filenames : list of str</span>
</span><span id="seg_generator-1435"><a href="#seg_generator-1435"><span class="linenos">1435</span></a><span class="sd">        List of file paths to the high-resolution source images.</span>
</span><span id="seg_generator-1436"><a href="#seg_generator-1436"><span class="linenos">1436</span></a><span class="sd">    nPatches : int</span>
</span><span id="seg_generator-1437"><a href="#seg_generator-1437"><span class="linenos">1437</span></a><span class="sd">        The number of patch pairs to generate and yield in each batch.</span>
</span><span id="seg_generator-1438"><a href="#seg_generator-1438"><span class="linenos">1438</span></a><span class="sd">    target_patch_size : tuple or list of int</span>
</span><span id="seg_generator-1439"><a href="#seg_generator-1439"><span class="linenos">1439</span></a><span class="sd">        The dimensions of the high-resolution patches.</span>
</span><span id="seg_generator-1440"><a href="#seg_generator-1440"><span class="linenos">1440</span></a><span class="sd">    target_patch_size_low : tuple or list of int</span>
</span><span id="seg_generator-1441"><a href="#seg_generator-1441"><span class="linenos">1441</span></a><span class="sd">        The dimensions of the low-resolution patches.</span>
</span><span id="seg_generator-1442"><a href="#seg_generator-1442"><span class="linenos">1442</span></a><span class="sd">    patch_scaler : bool, optional</span>
</span><span id="seg_generator-1443"><a href="#seg_generator-1443"><span class="linenos">1443</span></a><span class="sd">        If True, scales the intensity channel of patches to [0, 1]. Default is True.</span>
</span><span id="seg_generator-1444"><a href="#seg_generator-1444"><span class="linenos">1444</span></a><span class="sd">    istest : bool, optional</span>
</span><span id="seg_generator-1445"><a href="#seg_generator-1445"><span class="linenos">1445</span></a><span class="sd">        If True, yields an additional baseline upsampled patch for comparison.</span>
</span><span id="seg_generator-1446"><a href="#seg_generator-1446"><span class="linenos">1446</span></a><span class="sd">        Default is False.</span>
</span><span id="seg_generator-1447"><a href="#seg_generator-1447"><span class="linenos">1447</span></a><span class="sd">    verbose : bool, optional</span>
</span><span id="seg_generator-1448"><a href="#seg_generator-1448"><span class="linenos">1448</span></a><span class="sd">        If True, passes verbosity to the underlying patch generation function.</span>
</span><span id="seg_generator-1449"><a href="#seg_generator-1449"><span class="linenos">1449</span></a><span class="sd">        Default is False.</span>
</span><span id="seg_generator-1450"><a href="#seg_generator-1450"><span class="linenos">1450</span></a>
</span><span id="seg_generator-1451"><a href="#seg_generator-1451"><span class="linenos">1451</span></a><span class="sd">    Yields</span>
</span><span id="seg_generator-1452"><a href="#seg_generator-1452"><span class="linenos">1452</span></a><span class="sd">    -------</span>
</span><span id="seg_generator-1453"><a href="#seg_generator-1453"><span class="linenos">1453</span></a><span class="sd">    tuple</span>
</span><span id="seg_generator-1454"><a href="#seg_generator-1454"><span class="linenos">1454</span></a><span class="sd">        A tuple of multi-channel TensorFlow tensors. Each tensor has two channels:</span>
</span><span id="seg_generator-1455"><a href="#seg_generator-1455"><span class="linenos">1455</span></a><span class="sd">        Channel 0 contains the intensity image, and Channel 1 contains the</span>
</span><span id="seg_generator-1456"><a href="#seg_generator-1456"><span class="linenos">1456</span></a><span class="sd">        segmentation mask.</span>
</span><span id="seg_generator-1457"><a href="#seg_generator-1457"><span class="linenos">1457</span></a>
</span><span id="seg_generator-1458"><a href="#seg_generator-1458"><span class="linenos">1458</span></a><span class="sd">    See Also</span>
</span><span id="seg_generator-1459"><a href="#seg_generator-1459"><span class="linenos">1459</span></a><span class="sd">    --------</span>
</span><span id="seg_generator-1460"><a href="#seg_generator-1460"><span class="linenos">1460</span></a><span class="sd">    seg_patch_training_data_from_filenames : The function that performs the</span>
</span><span id="seg_generator-1461"><a href="#seg_generator-1461"><span class="linenos">1461</span></a><span class="sd">                                             underlying patch extraction.</span>
</span><span id="seg_generator-1462"><a href="#seg_generator-1462"><span class="linenos">1462</span></a><span class="sd">    image_generator : A similar generator for intensity-only data.</span>
</span><span id="seg_generator-1463"><a href="#seg_generator-1463"><span class="linenos">1463</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="seg_generator-1464"><a href="#seg_generator-1464"><span class="linenos">1464</span></a>    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="seg_generator-1465"><a href="#seg_generator-1465"><span class="linenos">1465</span></a>        <span class="n">patchesResam</span><span class="p">,</span> <span class="n">patchesOrig</span><span class="p">,</span> <span class="n">patchesUp</span> <span class="o">=</span> <span class="n">seg_patch_training_data_from_filenames</span><span class="p">(</span>
</span><span id="seg_generator-1466"><a href="#seg_generator-1466"><span class="linenos">1466</span></a>            <span class="n">filenames</span><span class="p">,</span>
</span><span id="seg_generator-1467"><a href="#seg_generator-1467"><span class="linenos">1467</span></a>            <span class="n">target_patch_size</span> <span class="o">=</span> <span class="n">target_patch_size</span><span class="p">,</span>
</span><span id="seg_generator-1468"><a href="#seg_generator-1468"><span class="linenos">1468</span></a>            <span class="n">target_patch_size_low</span> <span class="o">=</span> <span class="n">target_patch_size_low</span><span class="p">,</span>
</span><span id="seg_generator-1469"><a href="#seg_generator-1469"><span class="linenos">1469</span></a>            <span class="n">nPatches</span> <span class="o">=</span> <span class="n">nPatches</span><span class="p">,</span>
</span><span id="seg_generator-1470"><a href="#seg_generator-1470"><span class="linenos">1470</span></a>            <span class="n">istest</span>   <span class="o">=</span> <span class="n">istest</span><span class="p">,</span>
</span><span id="seg_generator-1471"><a href="#seg_generator-1471"><span class="linenos">1471</span></a>            <span class="n">patch_scaler</span><span class="o">=</span><span class="n">patch_scaler</span><span class="p">,</span>
</span><span id="seg_generator-1472"><a href="#seg_generator-1472"><span class="linenos">1472</span></a>            <span class="n">to_tensorflow</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="seg_generator-1473"><a href="#seg_generator-1473"><span class="linenos">1473</span></a>            <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span> <span class="p">)</span>
</span><span id="seg_generator-1474"><a href="#seg_generator-1474"><span class="linenos">1474</span></a>        <span class="k">if</span> <span class="n">istest</span><span class="p">:</span>
</span><span id="seg_generator-1475"><a href="#seg_generator-1475"><span class="linenos">1475</span></a>            <span class="k">yield</span> <span class="p">(</span><span class="n">patchesResam</span><span class="p">,</span> <span class="n">patchesOrig</span><span class="p">,</span><span class="n">patchesUp</span><span class="p">)</span>
</span><span id="seg_generator-1476"><a href="#seg_generator-1476"><span class="linenos">1476</span></a>        <span class="k">yield</span> <span class="p">(</span><span class="n">patchesResam</span><span class="p">,</span> <span class="n">patchesOrig</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Creates an infinite generator of paired image and segmentation patches.</p>

<p>This function continuously generates batches of multi-channel patches, where
one channel is the intensity image and the other is a segmentation mask.
It is designed for training multi-task super-resolution models.</p>

<h2 id="parameters">Parameters</h2>

<p>filenames : list of str
    List of file paths to the high-resolution source images.
nPatches : int
    The number of patch pairs to generate and yield in each batch.
target_patch_size : tuple or list of int
    The dimensions of the high-resolution patches.
target_patch_size_low : tuple or list of int
    The dimensions of the low-resolution patches.
patch_scaler : bool, optional
    If True, scales the intensity channel of patches to [0, 1]. Default is True.
istest : bool, optional
    If True, yields an additional baseline upsampled patch for comparison.
    Default is False.
verbose : bool, optional
    If True, passes verbosity to the underlying patch generation function.
    Default is False.</p>

<h2 id="yields">Yields</h2>

<p>tuple
    A tuple of multi-channel TensorFlow tensors. Each tensor has two channels:
    Channel 0 contains the intensity image, and Channel 1 contains the
    segmentation mask.</p>

<h2 id="see-also">See Also</h2>

<p>seg_patch_training_data_from_filenames : The function that performs the
                                         underlying patch extraction.
image_generator : A similar generator for intensity-only data.</p>
</div>


                </section>
                <section id="train">
                            <input id="train-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">train</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">mdl</span>,</span><span class="param">	<span class="n">filenames_train</span>,</span><span class="param">	<span class="n">filenames_test</span>,</span><span class="param">	<span class="n">target_patch_size</span>,</span><span class="param">	<span class="n">target_patch_size_low</span>,</span><span class="param">	<span class="n">output_prefix</span>,</span><span class="param">	<span class="n">n_test</span><span class="o">=</span><span class="mi">8</span>,</span><span class="param">	<span class="n">learning_rate</span><span class="o">=</span><span class="mf">5e-05</span>,</span><span class="param">	<span class="n">feature_layer</span><span class="o">=</span><span class="mi">6</span>,</span><span class="param">	<span class="n">feature</span><span class="o">=</span><span class="mi">2</span>,</span><span class="param">	<span class="n">tv</span><span class="o">=</span><span class="mf">0.1</span>,</span><span class="param">	<span class="n">max_iterations</span><span class="o">=</span><span class="mi">1000</span>,</span><span class="param">	<span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span>,</span><span class="param">	<span class="n">save_all_best</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">feature_type</span><span class="o">=</span><span class="s1">&#39;grader&#39;</span>,</span><span class="param">	<span class="n">check_eval_data_iteration</span><span class="o">=</span><span class="mi">20</span>,</span><span class="param">	<span class="n">verbose</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="train-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#train"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="train-1479"><a href="#train-1479"><span class="linenos">1479</span></a><span class="k">def</span> <span class="nf">train</span><span class="p">(</span>
</span><span id="train-1480"><a href="#train-1480"><span class="linenos">1480</span></a>    <span class="n">mdl</span><span class="p">,</span>
</span><span id="train-1481"><a href="#train-1481"><span class="linenos">1481</span></a>    <span class="n">filenames_train</span><span class="p">,</span>
</span><span id="train-1482"><a href="#train-1482"><span class="linenos">1482</span></a>    <span class="n">filenames_test</span><span class="p">,</span>
</span><span id="train-1483"><a href="#train-1483"><span class="linenos">1483</span></a>    <span class="n">target_patch_size</span><span class="p">,</span>
</span><span id="train-1484"><a href="#train-1484"><span class="linenos">1484</span></a>    <span class="n">target_patch_size_low</span><span class="p">,</span>
</span><span id="train-1485"><a href="#train-1485"><span class="linenos">1485</span></a>    <span class="n">output_prefix</span><span class="p">,</span>
</span><span id="train-1486"><a href="#train-1486"><span class="linenos">1486</span></a>    <span class="n">n_test</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
</span><span id="train-1487"><a href="#train-1487"><span class="linenos">1487</span></a>    <span class="n">learning_rate</span><span class="o">=</span><span class="mf">5e-5</span><span class="p">,</span>
</span><span id="train-1488"><a href="#train-1488"><span class="linenos">1488</span></a>    <span class="n">feature_layer</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
</span><span id="train-1489"><a href="#train-1489"><span class="linenos">1489</span></a>    <span class="n">feature</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
</span><span id="train-1490"><a href="#train-1490"><span class="linenos">1490</span></a>    <span class="n">tv</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
</span><span id="train-1491"><a href="#train-1491"><span class="linenos">1491</span></a>    <span class="n">max_iterations</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
</span><span id="train-1492"><a href="#train-1492"><span class="linenos">1492</span></a>    <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="train-1493"><a href="#train-1493"><span class="linenos">1493</span></a>    <span class="n">save_all_best</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="train-1494"><a href="#train-1494"><span class="linenos">1494</span></a>    <span class="n">feature_type</span> <span class="o">=</span> <span class="s1">&#39;grader&#39;</span><span class="p">,</span>
</span><span id="train-1495"><a href="#train-1495"><span class="linenos">1495</span></a>    <span class="n">check_eval_data_iteration</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
</span><span id="train-1496"><a href="#train-1496"><span class="linenos">1496</span></a>    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span>  <span class="p">):</span>
</span><span id="train-1497"><a href="#train-1497"><span class="linenos">1497</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="train-1498"><a href="#train-1498"><span class="linenos">1498</span></a><span class="sd">    Orchestrates the training process for a super-resolution model.</span>
</span><span id="train-1499"><a href="#train-1499"><span class="linenos">1499</span></a>
</span><span id="train-1500"><a href="#train-1500"><span class="linenos">1500</span></a><span class="sd">    This function handles the entire training loop, including setting up data</span>
</span><span id="train-1501"><a href="#train-1501"><span class="linenos">1501</span></a><span class="sd">    generators, defining a composite loss function, automatically balancing loss</span>
</span><span id="train-1502"><a href="#train-1502"><span class="linenos">1502</span></a><span class="sd">    weights, iteratively training the model, periodically evaluating performance,</span>
</span><span id="train-1503"><a href="#train-1503"><span class="linenos">1503</span></a><span class="sd">    and saving the best-performing model weights.</span>
</span><span id="train-1504"><a href="#train-1504"><span class="linenos">1504</span></a>
</span><span id="train-1505"><a href="#train-1505"><span class="linenos">1505</span></a><span class="sd">    Parameters</span>
</span><span id="train-1506"><a href="#train-1506"><span class="linenos">1506</span></a><span class="sd">    ----------</span>
</span><span id="train-1507"><a href="#train-1507"><span class="linenos">1507</span></a><span class="sd">    mdl : tf.keras.Model</span>
</span><span id="train-1508"><a href="#train-1508"><span class="linenos">1508</span></a><span class="sd">        The Keras model to be trained.</span>
</span><span id="train-1509"><a href="#train-1509"><span class="linenos">1509</span></a><span class="sd">    filenames_train : list of str</span>
</span><span id="train-1510"><a href="#train-1510"><span class="linenos">1510</span></a><span class="sd">        List of file paths for the training dataset.</span>
</span><span id="train-1511"><a href="#train-1511"><span class="linenos">1511</span></a><span class="sd">    filenames_test : list of str</span>
</span><span id="train-1512"><a href="#train-1512"><span class="linenos">1512</span></a><span class="sd">        List of file paths for the validation/testing dataset.</span>
</span><span id="train-1513"><a href="#train-1513"><span class="linenos">1513</span></a><span class="sd">    target_patch_size : tuple or list</span>
</span><span id="train-1514"><a href="#train-1514"><span class="linenos">1514</span></a><span class="sd">        The dimensions of the high-resolution target patches.</span>
</span><span id="train-1515"><a href="#train-1515"><span class="linenos">1515</span></a><span class="sd">    target_patch_size_low : tuple or list</span>
</span><span id="train-1516"><a href="#train-1516"><span class="linenos">1516</span></a><span class="sd">        The dimensions of the low-resolution input patches.</span>
</span><span id="train-1517"><a href="#train-1517"><span class="linenos">1517</span></a><span class="sd">    output_prefix : str</span>
</span><span id="train-1518"><a href="#train-1518"><span class="linenos">1518</span></a><span class="sd">        A prefix for all output files (e.g., model weights, training logs).</span>
</span><span id="train-1519"><a href="#train-1519"><span class="linenos">1519</span></a><span class="sd">    n_test : int, optional</span>
</span><span id="train-1520"><a href="#train-1520"><span class="linenos">1520</span></a><span class="sd">        The number of validation patches to use for evaluation. Default is 8.</span>
</span><span id="train-1521"><a href="#train-1521"><span class="linenos">1521</span></a><span class="sd">    learning_rate : float, optional</span>
</span><span id="train-1522"><a href="#train-1522"><span class="linenos">1522</span></a><span class="sd">        The learning rate for the Adam optimizer. Default is 5e-5.</span>
</span><span id="train-1523"><a href="#train-1523"><span class="linenos">1523</span></a><span class="sd">    feature_layer : int, optional</span>
</span><span id="train-1524"><a href="#train-1524"><span class="linenos">1524</span></a><span class="sd">        The layer index from the feature extractor to use for perceptual loss.</span>
</span><span id="train-1525"><a href="#train-1525"><span class="linenos">1525</span></a><span class="sd">        Default is 6.</span>
</span><span id="train-1526"><a href="#train-1526"><span class="linenos">1526</span></a><span class="sd">    feature : float, optional</span>
</span><span id="train-1527"><a href="#train-1527"><span class="linenos">1527</span></a><span class="sd">        The relative weight of the perceptual (feature) loss term. Default is 2.0.</span>
</span><span id="train-1528"><a href="#train-1528"><span class="linenos">1528</span></a><span class="sd">    tv : float, optional</span>
</span><span id="train-1529"><a href="#train-1529"><span class="linenos">1529</span></a><span class="sd">        The relative weight of the Total Variation (TV) regularization term.</span>
</span><span id="train-1530"><a href="#train-1530"><span class="linenos">1530</span></a><span class="sd">        Default is 0.1.</span>
</span><span id="train-1531"><a href="#train-1531"><span class="linenos">1531</span></a><span class="sd">    max_iterations : int, optional</span>
</span><span id="train-1532"><a href="#train-1532"><span class="linenos">1532</span></a><span class="sd">        The total number of training iterations to run. Default is 1000.</span>
</span><span id="train-1533"><a href="#train-1533"><span class="linenos">1533</span></a><span class="sd">    batch_size : int, optional</span>
</span><span id="train-1534"><a href="#train-1534"><span class="linenos">1534</span></a><span class="sd">        The batch size for training. Note: this implementation is optimized for</span>
</span><span id="train-1535"><a href="#train-1535"><span class="linenos">1535</span></a><span class="sd">        batch_size=1 and may need adjustment for larger batches. Default is 1.</span>
</span><span id="train-1536"><a href="#train-1536"><span class="linenos">1536</span></a><span class="sd">    save_all_best : bool, optional</span>
</span><span id="train-1537"><a href="#train-1537"><span class="linenos">1537</span></a><span class="sd">        If True, saves a new model file every time validation loss improves.</span>
</span><span id="train-1538"><a href="#train-1538"><span class="linenos">1538</span></a><span class="sd">        If False, overwrites the single best model file. Default is False.</span>
</span><span id="train-1539"><a href="#train-1539"><span class="linenos">1539</span></a><span class="sd">    feature_type : str, optional</span>
</span><span id="train-1540"><a href="#train-1540"><span class="linenos">1540</span></a><span class="sd">        The type of feature extractor for perceptual loss. Options: &#39;grader&#39;,</span>
</span><span id="train-1541"><a href="#train-1541"><span class="linenos">1541</span></a><span class="sd">        &#39;vgg&#39;, &#39;vggrandom&#39;. Default is &#39;grader&#39;.</span>
</span><span id="train-1542"><a href="#train-1542"><span class="linenos">1542</span></a><span class="sd">    check_eval_data_iteration : int, optional</span>
</span><span id="train-1543"><a href="#train-1543"><span class="linenos">1543</span></a><span class="sd">        The frequency (in iterations) at which to run validation and save logs.</span>
</span><span id="train-1544"><a href="#train-1544"><span class="linenos">1544</span></a><span class="sd">        Default is 20.</span>
</span><span id="train-1545"><a href="#train-1545"><span class="linenos">1545</span></a><span class="sd">    verbose : bool, optional</span>
</span><span id="train-1546"><a href="#train-1546"><span class="linenos">1546</span></a><span class="sd">        If True, prints detailed progress information. Default is False.</span>
</span><span id="train-1547"><a href="#train-1547"><span class="linenos">1547</span></a>
</span><span id="train-1548"><a href="#train-1548"><span class="linenos">1548</span></a><span class="sd">    Returns</span>
</span><span id="train-1549"><a href="#train-1549"><span class="linenos">1549</span></a><span class="sd">    -------</span>
</span><span id="train-1550"><a href="#train-1550"><span class="linenos">1550</span></a><span class="sd">    pd.DataFrame</span>
</span><span id="train-1551"><a href="#train-1551"><span class="linenos">1551</span></a><span class="sd">        A DataFrame containing the training history, with columns for training</span>
</span><span id="train-1552"><a href="#train-1552"><span class="linenos">1552</span></a><span class="sd">        loss, validation loss, PSNR, and baseline PSNR over iterations.</span>
</span><span id="train-1553"><a href="#train-1553"><span class="linenos">1553</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="train-1554"><a href="#train-1554"><span class="linenos">1554</span></a>    <span class="n">colnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;train_loss&#39;</span><span class="p">,</span><span class="s1">&#39;test_loss&#39;</span><span class="p">,</span><span class="s1">&#39;best&#39;</span><span class="p">,</span><span class="s1">&#39;eval_psnr&#39;</span><span class="p">,</span><span class="s1">&#39;eval_psnr_lin&#39;</span><span class="p">]</span>
</span><span id="train-1555"><a href="#train-1555"><span class="linenos">1555</span></a>    <span class="n">training_path</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span> <span class="n">max_iterations</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">colnames</span><span class="p">)</span> <span class="p">]</span> <span class="p">)</span>
</span><span id="train-1556"><a href="#train-1556"><span class="linenos">1556</span></a>    <span class="n">training_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span> <span class="p">)</span>
</span><span id="train-1557"><a href="#train-1557"><span class="linenos">1557</span></a>    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="train-1558"><a href="#train-1558"><span class="linenos">1558</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;begin get feature extractor &quot;</span> <span class="o">+</span> <span class="n">feature_type</span><span class="p">)</span>
</span><span id="train-1559"><a href="#train-1559"><span class="linenos">1559</span></a>    <span class="k">if</span> <span class="n">feature_type</span> <span class="o">==</span> <span class="s1">&#39;grader&#39;</span><span class="p">:</span>
</span><span id="train-1560"><a href="#train-1560"><span class="linenos">1560</span></a>        <span class="n">feature_extractor</span> <span class="o">=</span> <span class="n">get_grader_feature_network</span><span class="p">(</span> <span class="n">feature_layer</span> <span class="p">)</span>
</span><span id="train-1561"><a href="#train-1561"><span class="linenos">1561</span></a>    <span class="k">elif</span> <span class="n">feature_type</span> <span class="o">==</span> <span class="s1">&#39;vggrandom&#39;</span><span class="p">:</span>
</span><span id="train-1562"><a href="#train-1562"><span class="linenos">1562</span></a>        <span class="k">with</span> <span class="n">eager_mode</span><span class="p">():</span>
</span><span id="train-1563"><a href="#train-1563"><span class="linenos">1563</span></a>            <span class="n">feature_extractor</span> <span class="o">=</span> <span class="n">pseudo_3d_vgg_features</span><span class="p">(</span> <span class="n">target_patch_size</span><span class="p">,</span> <span class="n">feature_layer</span><span class="p">,</span> <span class="n">pretrained</span><span class="o">=</span><span class="kc">False</span> <span class="p">)</span>
</span><span id="train-1564"><a href="#train-1564"><span class="linenos">1564</span></a>    <span class="k">elif</span> <span class="n">feature_type</span> <span class="o">==</span> <span class="s1">&#39;vgg&#39;</span><span class="p">:</span>
</span><span id="train-1565"><a href="#train-1565"><span class="linenos">1565</span></a>        <span class="k">with</span> <span class="n">eager_mode</span><span class="p">():</span>
</span><span id="train-1566"><a href="#train-1566"><span class="linenos">1566</span></a>            <span class="n">feature_extractor</span> <span class="o">=</span> <span class="n">pseudo_3d_vgg_features_unbiased</span><span class="p">(</span> <span class="n">target_patch_size</span><span class="p">,</span> <span class="n">feature_layer</span> <span class="p">)</span>
</span><span id="train-1567"><a href="#train-1567"><span class="linenos">1567</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="train-1568"><a href="#train-1568"><span class="linenos">1568</span></a>        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;feature type does not exist&quot;</span><span class="p">)</span>
</span><span id="train-1569"><a href="#train-1569"><span class="linenos">1569</span></a>    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="train-1570"><a href="#train-1570"><span class="linenos">1570</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;begin train generator&quot;</span><span class="p">)</span>
</span><span id="train-1571"><a href="#train-1571"><span class="linenos">1571</span></a>    <span class="n">mydatgen</span> <span class="o">=</span> <span class="n">image_generator</span><span class="p">(</span>
</span><span id="train-1572"><a href="#train-1572"><span class="linenos">1572</span></a>        <span class="n">filenames_train</span><span class="p">,</span>
</span><span id="train-1573"><a href="#train-1573"><span class="linenos">1573</span></a>        <span class="n">nPatches</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="train-1574"><a href="#train-1574"><span class="linenos">1574</span></a>        <span class="n">target_patch_size</span><span class="o">=</span><span class="n">target_patch_size</span><span class="p">,</span>
</span><span id="train-1575"><a href="#train-1575"><span class="linenos">1575</span></a>        <span class="n">target_patch_size_low</span><span class="o">=</span><span class="n">target_patch_size_low</span><span class="p">,</span>
</span><span id="train-1576"><a href="#train-1576"><span class="linenos">1576</span></a>        <span class="n">istest</span><span class="o">=</span><span class="kc">False</span> <span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="train-1577"><a href="#train-1577"><span class="linenos">1577</span></a>    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="train-1578"><a href="#train-1578"><span class="linenos">1578</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;begin test generator&quot;</span><span class="p">)</span>
</span><span id="train-1579"><a href="#train-1579"><span class="linenos">1579</span></a>    <span class="n">mydatgenTest</span> <span class="o">=</span> <span class="n">image_generator</span><span class="p">(</span> <span class="n">filenames_test</span><span class="p">,</span> <span class="n">nPatches</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="train-1580"><a href="#train-1580"><span class="linenos">1580</span></a>        <span class="n">target_patch_size</span><span class="o">=</span><span class="n">target_patch_size</span><span class="p">,</span>
</span><span id="train-1581"><a href="#train-1581"><span class="linenos">1581</span></a>        <span class="n">target_patch_size_low</span><span class="o">=</span><span class="n">target_patch_size_low</span><span class="p">,</span>
</span><span id="train-1582"><a href="#train-1582"><span class="linenos">1582</span></a>        <span class="n">istest</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="train-1583"><a href="#train-1583"><span class="linenos">1583</span></a>    <span class="n">patchesResamTeTf</span><span class="p">,</span> <span class="n">patchesOrigTeTf</span><span class="p">,</span> <span class="n">patchesUpTeTf</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span> <span class="n">mydatgenTest</span> <span class="p">)</span>
</span><span id="train-1584"><a href="#train-1584"><span class="linenos">1584</span></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span> <span class="n">patchesOrigTeTf</span><span class="o">.</span><span class="n">shape</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
</span><span id="train-1585"><a href="#train-1585"><span class="linenos">1585</span></a>            <span class="n">tdim</span> <span class="o">=</span> <span class="mi">3</span>
</span><span id="train-1586"><a href="#train-1586"><span class="linenos">1586</span></a>            <span class="n">myax</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span>
</span><span id="train-1587"><a href="#train-1587"><span class="linenos">1587</span></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span> <span class="n">patchesOrigTeTf</span><span class="o">.</span><span class="n">shape</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
</span><span id="train-1588"><a href="#train-1588"><span class="linenos">1588</span></a>            <span class="n">tdim</span> <span class="o">=</span> <span class="mi">2</span>
</span><span id="train-1589"><a href="#train-1589"><span class="linenos">1589</span></a>            <span class="n">myax</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
</span><span id="train-1590"><a href="#train-1590"><span class="linenos">1590</span></a>    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="train-1591"><a href="#train-1591"><span class="linenos">1591</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;begin train generator #2 at dim: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span> <span class="n">tdim</span><span class="p">))</span>
</span><span id="train-1592"><a href="#train-1592"><span class="linenos">1592</span></a>    <span class="n">mydatgenTest</span> <span class="o">=</span> <span class="n">image_generator</span><span class="p">(</span> <span class="n">filenames_test</span><span class="p">,</span> <span class="n">nPatches</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="train-1593"><a href="#train-1593"><span class="linenos">1593</span></a>        <span class="n">target_patch_size</span><span class="o">=</span><span class="n">target_patch_size</span><span class="p">,</span>
</span><span id="train-1594"><a href="#train-1594"><span class="linenos">1594</span></a>        <span class="n">target_patch_size_low</span><span class="o">=</span><span class="n">target_patch_size_low</span><span class="p">,</span>
</span><span id="train-1595"><a href="#train-1595"><span class="linenos">1595</span></a>        <span class="n">istest</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="train-1596"><a href="#train-1596"><span class="linenos">1596</span></a>    <span class="n">patchesResamTeTfB</span><span class="p">,</span> <span class="n">patchesOrigTeTfB</span><span class="p">,</span> <span class="n">patchesUpTeTfB</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span> <span class="n">mydatgenTest</span> <span class="p">)</span>
</span><span id="train-1597"><a href="#train-1597"><span class="linenos">1597</span></a>    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">n_test</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">):</span>
</span><span id="train-1598"><a href="#train-1598"><span class="linenos">1598</span></a>        <span class="n">mydatgenTest</span> <span class="o">=</span> <span class="n">image_generator</span><span class="p">(</span> <span class="n">filenames_test</span><span class="p">,</span> <span class="n">nPatches</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="train-1599"><a href="#train-1599"><span class="linenos">1599</span></a>            <span class="n">target_patch_size</span><span class="o">=</span><span class="n">target_patch_size</span><span class="p">,</span>
</span><span id="train-1600"><a href="#train-1600"><span class="linenos">1600</span></a>            <span class="n">target_patch_size_low</span><span class="o">=</span><span class="n">target_patch_size_low</span><span class="p">,</span>
</span><span id="train-1601"><a href="#train-1601"><span class="linenos">1601</span></a>            <span class="n">istest</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="train-1602"><a href="#train-1602"><span class="linenos">1602</span></a>        <span class="n">temp0</span><span class="p">,</span> <span class="n">temp1</span><span class="p">,</span> <span class="n">temp2</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span> <span class="n">mydatgenTest</span> <span class="p">)</span>
</span><span id="train-1603"><a href="#train-1603"><span class="linenos">1603</span></a>        <span class="n">patchesResamTeTfB</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span> <span class="p">[</span><span class="n">patchesResamTeTfB</span><span class="p">,</span><span class="n">temp0</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="train-1604"><a href="#train-1604"><span class="linenos">1604</span></a>        <span class="n">patchesOrigTeTfB</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span> <span class="p">[</span><span class="n">patchesOrigTeTfB</span><span class="p">,</span><span class="n">temp1</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="train-1605"><a href="#train-1605"><span class="linenos">1605</span></a>        <span class="n">patchesUpTeTfB</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span> <span class="p">[</span><span class="n">patchesUpTeTfB</span><span class="p">,</span><span class="n">temp2</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="train-1606"><a href="#train-1606"><span class="linenos">1606</span></a>    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="train-1607"><a href="#train-1607"><span class="linenos">1607</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;begin auto_weight_loss&quot;</span><span class="p">)</span>
</span><span id="train-1608"><a href="#train-1608"><span class="linenos">1608</span></a>    <span class="n">wts_csv</span> <span class="o">=</span> <span class="n">output_prefix</span> <span class="o">+</span> <span class="s2">&quot;_training_weights.csv&quot;</span>
</span><span id="train-1609"><a href="#train-1609"><span class="linenos">1609</span></a>    <span class="k">if</span> <span class="n">exists</span><span class="p">(</span> <span class="n">wts_csv</span> <span class="p">):</span>
</span><span id="train-1610"><a href="#train-1610"><span class="linenos">1610</span></a>        <span class="n">wtsdf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span> <span class="n">wts_csv</span> <span class="p">)</span>
</span><span id="train-1611"><a href="#train-1611"><span class="linenos">1611</span></a>        <span class="n">wts</span> <span class="o">=</span> <span class="p">[</span><span class="n">wtsdf</span><span class="p">[</span><span class="s1">&#39;msq&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">wtsdf</span><span class="p">[</span><span class="s1">&#39;feat&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">wtsdf</span><span class="p">[</span><span class="s1">&#39;tv&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
</span><span id="train-1612"><a href="#train-1612"><span class="linenos">1612</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="train-1613"><a href="#train-1613"><span class="linenos">1613</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;preset weights:&quot;</span> <span class="p">)</span>
</span><span id="train-1614"><a href="#train-1614"><span class="linenos">1614</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="train-1615"><a href="#train-1615"><span class="linenos">1615</span></a>        <span class="k">with</span> <span class="n">eager_mode</span><span class="p">():</span>
</span><span id="train-1616"><a href="#train-1616"><span class="linenos">1616</span></a>            <span class="n">wts</span> <span class="o">=</span> <span class="n">auto_weight_loss</span><span class="p">(</span> <span class="n">mdl</span><span class="p">,</span> <span class="n">feature_extractor</span><span class="p">,</span> <span class="n">patchesResamTeTf</span><span class="p">,</span> <span class="n">patchesOrigTeTf</span><span class="p">,</span>
</span><span id="train-1617"><a href="#train-1617"><span class="linenos">1617</span></a>                <span class="n">feature</span><span class="o">=</span><span class="n">feature</span><span class="p">,</span> <span class="n">tv</span><span class="o">=</span><span class="n">tv</span> <span class="p">)</span>
</span><span id="train-1618"><a href="#train-1618"><span class="linenos">1618</span></a>        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">wts</span><span class="p">)):</span>
</span><span id="train-1619"><a href="#train-1619"><span class="linenos">1619</span></a>            <span class="n">training_weights</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">=</span><span class="n">wts</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
</span><span id="train-1620"><a href="#train-1620"><span class="linenos">1620</span></a>        <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">training_weights</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;msq&quot;</span><span class="p">,</span><span class="s2">&quot;feat&quot;</span><span class="p">,</span><span class="s2">&quot;tv&quot;</span><span class="p">]</span> <span class="p">)</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span> <span class="n">wts_csv</span> <span class="p">)</span>
</span><span id="train-1621"><a href="#train-1621"><span class="linenos">1621</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="train-1622"><a href="#train-1622"><span class="linenos">1622</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;automatic weights:&quot;</span> <span class="p">)</span>
</span><span id="train-1623"><a href="#train-1623"><span class="linenos">1623</span></a>    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="train-1624"><a href="#train-1624"><span class="linenos">1624</span></a>        <span class="nb">print</span><span class="p">(</span> <span class="n">wts</span> <span class="p">)</span>
</span><span id="train-1625"><a href="#train-1625"><span class="linenos">1625</span></a>    <span class="k">def</span> <span class="nf">my_loss_6</span><span class="p">(</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">msqwt</span> <span class="o">=</span> <span class="n">wts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fw</span> <span class="o">=</span> <span class="n">wts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">tvwt</span> <span class="o">=</span> <span class="n">wts</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">mybs</span> <span class="o">=</span> <span class="n">batch_size</span> <span class="p">):</span>
</span><span id="train-1626"><a href="#train-1626"><span class="linenos">1626</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Composite loss: MSE + Perceptual Loss + Total Variation.&quot;&quot;&quot;</span>
</span><span id="train-1627"><a href="#train-1627"><span class="linenos">1627</span></a>        <span class="n">squared_difference</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">y_true</span> <span class="o">-</span> <span class="n">y_pred</span><span class="p">)</span>
</span><span id="train-1628"><a href="#train-1628"><span class="linenos">1628</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span> <span class="n">y_true</span><span class="o">.</span><span class="n">shape</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
</span><span id="train-1629"><a href="#train-1629"><span class="linenos">1629</span></a>            <span class="n">tdim</span> <span class="o">=</span> <span class="mi">3</span>
</span><span id="train-1630"><a href="#train-1630"><span class="linenos">1630</span></a>            <span class="n">myax</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span>
</span><span id="train-1631"><a href="#train-1631"><span class="linenos">1631</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span> <span class="n">y_true</span><span class="o">.</span><span class="n">shape</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
</span><span id="train-1632"><a href="#train-1632"><span class="linenos">1632</span></a>            <span class="n">tdim</span> <span class="o">=</span> <span class="mi">2</span>
</span><span id="train-1633"><a href="#train-1633"><span class="linenos">1633</span></a>            <span class="n">myax</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
</span><span id="train-1634"><a href="#train-1634"><span class="linenos">1634</span></a>        <span class="n">msqTerm</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">squared_difference</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">myax</span><span class="p">)</span>
</span><span id="train-1635"><a href="#train-1635"><span class="linenos">1635</span></a>        <span class="n">temp1</span> <span class="o">=</span> <span class="n">feature_extractor</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span>
</span><span id="train-1636"><a href="#train-1636"><span class="linenos">1636</span></a>        <span class="n">temp2</span> <span class="o">=</span> <span class="n">feature_extractor</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span>
</span><span id="train-1637"><a href="#train-1637"><span class="linenos">1637</span></a>        <span class="n">feature_difference</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">temp1</span><span class="o">-</span><span class="n">temp2</span><span class="p">)</span>
</span><span id="train-1638"><a href="#train-1638"><span class="linenos">1638</span></a>        <span class="n">featureTerm</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">feature_difference</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">myax</span><span class="p">)</span>
</span><span id="train-1639"><a href="#train-1639"><span class="linenos">1639</span></a>        <span class="n">loss</span> <span class="o">=</span> <span class="n">msqTerm</span> <span class="o">*</span> <span class="n">msqwt</span> <span class="o">+</span> <span class="n">featureTerm</span> <span class="o">*</span> <span class="n">fw</span>
</span><span id="train-1640"><a href="#train-1640"><span class="linenos">1640</span></a>        <span class="n">mytv</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s1">&#39;float32&#39;</span><span class="p">)</span>
</span><span id="train-1641"><a href="#train-1641"><span class="linenos">1641</span></a>        <span class="c1"># mybs =  int( y_pred.shape[0] ) --- should work but ... ?</span>
</span><span id="train-1642"><a href="#train-1642"><span class="linenos">1642</span></a>        <span class="k">if</span> <span class="n">tdim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="train-1643"><a href="#train-1643"><span class="linenos">1643</span></a>            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">mybs</span> <span class="p">):</span> <span class="c1"># BUG not sure why myr fails .... might be old TF version</span>
</span><span id="train-1644"><a href="#train-1644"><span class="linenos">1644</span></a>                <span class="n">sqzd</span> <span class="o">=</span> <span class="n">y_pred</span><span class="p">[</span><span class="n">k</span><span class="p">,:,:,:,:]</span>
</span><span id="train-1645"><a href="#train-1645"><span class="linenos">1645</span></a>                <span class="n">mytv</span> <span class="o">=</span> <span class="n">mytv</span> <span class="o">+</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">total_variation</span><span class="p">(</span> <span class="n">sqzd</span> <span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">tvwt</span>
</span><span id="train-1646"><a href="#train-1646"><span class="linenos">1646</span></a>        <span class="k">if</span> <span class="n">tdim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="train-1647"><a href="#train-1647"><span class="linenos">1647</span></a>            <span class="n">mytv</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">total_variation</span><span class="p">(</span> <span class="n">y_pred</span> <span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">tvwt</span>
</span><span id="train-1648"><a href="#train-1648"><span class="linenos">1648</span></a>        <span class="k">return</span><span class="p">(</span> <span class="n">loss</span> <span class="o">+</span> <span class="n">mytv</span> <span class="p">)</span>
</span><span id="train-1649"><a href="#train-1649"><span class="linenos">1649</span></a>    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="train-1650"><a href="#train-1650"><span class="linenos">1650</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;begin model compilation&quot;</span><span class="p">)</span>
</span><span id="train-1651"><a href="#train-1651"><span class="linenos">1651</span></a>    <span class="n">opt</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span> <span class="n">learning_rate</span><span class="o">=</span><span class="n">learning_rate</span> <span class="p">)</span>
</span><span id="train-1652"><a href="#train-1652"><span class="linenos">1652</span></a>    <span class="n">mdl</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">opt</span><span class="p">,</span> <span class="n">loss</span><span class="o">=</span><span class="n">my_loss_6</span><span class="p">)</span>
</span><span id="train-1653"><a href="#train-1653"><span class="linenos">1653</span></a>    <span class="c1"># set up some parameters for tracking performance</span>
</span><span id="train-1654"><a href="#train-1654"><span class="linenos">1654</span></a>    <span class="n">bestValLoss</span><span class="o">=</span><span class="mf">1e12</span>
</span><span id="train-1655"><a href="#train-1655"><span class="linenos">1655</span></a>    <span class="n">bestSSIM</span><span class="o">=</span><span class="mf">0.0</span>
</span><span id="train-1656"><a href="#train-1656"><span class="linenos">1656</span></a>    <span class="n">bestQC0</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1000</span>
</span><span id="train-1657"><a href="#train-1657"><span class="linenos">1657</span></a>    <span class="n">bestQC1</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1000</span>
</span><span id="train-1658"><a href="#train-1658"><span class="linenos">1658</span></a>    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="train-1659"><a href="#train-1659"><span class="linenos">1659</span></a>        <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;begin training&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span>  <span class="p">)</span>
</span><span id="train-1660"><a href="#train-1660"><span class="linenos">1660</span></a>    <span class="k">for</span> <span class="n">myrs</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">max_iterations</span> <span class="p">):</span>
</span><span id="train-1661"><a href="#train-1661"><span class="linenos">1661</span></a>        <span class="n">tracker</span> <span class="o">=</span> <span class="n">mdl</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span> <span class="n">mydatgen</span><span class="p">,</span>  <span class="n">epochs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">steps_per_epoch</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="train-1662"><a href="#train-1662"><span class="linenos">1662</span></a>            <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">patchesResamTeTf</span><span class="p">,</span><span class="n">patchesOrigTeTf</span><span class="p">)</span> <span class="p">)</span>
</span><span id="train-1663"><a href="#train-1663"><span class="linenos">1663</span></a>        <span class="n">training_path</span><span class="p">[</span><span class="n">myrs</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">tracker</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="train-1664"><a href="#train-1664"><span class="linenos">1664</span></a>        <span class="n">training_path</span><span class="p">[</span><span class="n">myrs</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">tracker</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_loss&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="train-1665"><a href="#train-1665"><span class="linenos">1665</span></a>        <span class="n">training_path</span><span class="p">[</span><span class="n">myrs</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
</span><span id="train-1666"><a href="#train-1666"><span class="linenos">1666</span></a>        <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;ntrain: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">myrs</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; loss &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span> <span class="n">tracker</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; val-loss &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">tracker</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_loss&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span>  <span class="p">)</span>
</span><span id="train-1667"><a href="#train-1667"><span class="linenos">1667</span></a>        <span class="k">if</span> <span class="n">myrs</span> <span class="o">%</span> <span class="n">check_eval_data_iteration</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="train-1668"><a href="#train-1668"><span class="linenos">1668</span></a>            <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;/cpu:0&quot;</span><span class="p">):</span>
</span><span id="train-1669"><a href="#train-1669"><span class="linenos">1669</span></a>                <span class="n">myofn</span> <span class="o">=</span> <span class="n">output_prefix</span> <span class="o">+</span> <span class="s2">&quot;_best_mdl.keras&quot;</span>
</span><span id="train-1670"><a href="#train-1670"><span class="linenos">1670</span></a>                <span class="k">if</span> <span class="n">save_all_best</span><span class="p">:</span>
</span><span id="train-1671"><a href="#train-1671"><span class="linenos">1671</span></a>                    <span class="n">myofn</span> <span class="o">=</span> <span class="n">output_prefix</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">myrs</span><span class="p">)</span><span class="o">+</span> <span class="s2">&quot;_mdl.keras&quot;</span>
</span><span id="train-1672"><a href="#train-1672"><span class="linenos">1672</span></a>                <span class="n">tester</span> <span class="o">=</span> <span class="n">mdl</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span> <span class="n">patchesResamTeTfB</span><span class="p">,</span> <span class="n">patchesOrigTeTfB</span> <span class="p">)</span>
</span><span id="train-1673"><a href="#train-1673"><span class="linenos">1673</span></a>                <span class="k">if</span> <span class="p">(</span> <span class="n">tester</span> <span class="o">&lt;</span> <span class="n">bestValLoss</span> <span class="p">):</span>
</span><span id="train-1674"><a href="#train-1674"><span class="linenos">1674</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;MyIT &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span> <span class="n">myrs</span> <span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; IS BEST!! &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span> <span class="n">tester</span> <span class="p">)</span> <span class="o">+</span> <span class="n">myofn</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span> <span class="p">)</span>
</span><span id="train-1675"><a href="#train-1675"><span class="linenos">1675</span></a>                    <span class="n">bestValLoss</span> <span class="o">=</span> <span class="n">tester</span>
</span><span id="train-1676"><a href="#train-1676"><span class="linenos">1676</span></a>                    <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span> <span class="n">mdl</span><span class="p">,</span> <span class="n">myofn</span> <span class="p">)</span>
</span><span id="train-1677"><a href="#train-1677"><span class="linenos">1677</span></a>                    <span class="n">training_path</span><span class="p">[</span><span class="n">myrs</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
</span><span id="train-1678"><a href="#train-1678"><span class="linenos">1678</span></a>                <span class="n">pp</span> <span class="o">=</span> <span class="n">mdl</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span> <span class="n">patchesResamTeTfB</span><span class="p">,</span> <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">)</span>
</span><span id="train-1679"><a href="#train-1679"><span class="linenos">1679</span></a>                <span class="n">myssimSR</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">psnr</span><span class="p">(</span> <span class="n">pp</span> <span class="o">*</span> <span class="mi">220</span><span class="p">,</span> <span class="n">patchesOrigTeTfB</span><span class="o">*</span> <span class="mi">220</span><span class="p">,</span> <span class="n">max_val</span><span class="o">=</span><span class="mi">255</span> <span class="p">)</span>
</span><span id="train-1680"><a href="#train-1680"><span class="linenos">1680</span></a>                <span class="n">myssimSR</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span> <span class="n">myssimSR</span> <span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="train-1681"><a href="#train-1681"><span class="linenos">1681</span></a>                <span class="n">myssimBI</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">psnr</span><span class="p">(</span> <span class="n">patchesUpTeTfB</span> <span class="o">*</span> <span class="mi">220</span><span class="p">,</span> <span class="n">patchesOrigTeTfB</span><span class="o">*</span> <span class="mi">220</span><span class="p">,</span> <span class="n">max_val</span><span class="o">=</span><span class="mi">255</span> <span class="p">)</span>
</span><span id="train-1682"><a href="#train-1682"><span class="linenos">1682</span></a>                <span class="n">myssimBI</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span> <span class="n">myssimBI</span> <span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="train-1683"><a href="#train-1683"><span class="linenos">1683</span></a>                <span class="nb">print</span><span class="p">(</span> <span class="n">myofn</span> <span class="o">+</span> <span class="s2">&quot; : &quot;</span> <span class="o">+</span> <span class="s2">&quot;PSNR Lin: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span> <span class="n">myssimBI</span> <span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; SR: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span> <span class="n">myssimSR</span> <span class="p">),</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span>  <span class="p">)</span>
</span><span id="train-1684"><a href="#train-1684"><span class="linenos">1684</span></a>                <span class="n">training_path</span><span class="p">[</span><span class="n">myrs</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">myssimSR</span> <span class="c1"># psnr</span>
</span><span id="train-1685"><a href="#train-1685"><span class="linenos">1685</span></a>                <span class="n">training_path</span><span class="p">[</span><span class="n">myrs</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="n">myssimBI</span> <span class="c1"># psnrlin</span>
</span><span id="train-1686"><a href="#train-1686"><span class="linenos">1686</span></a>                <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">training_path</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">colnames</span> <span class="p">)</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span> <span class="n">output_prefix</span> <span class="o">+</span> <span class="s2">&quot;_training.csv&quot;</span> <span class="p">)</span>
</span><span id="train-1687"><a href="#train-1687"><span class="linenos">1687</span></a>    <span class="n">training_path</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">training_path</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">colnames</span> <span class="p">)</span>
</span><span id="train-1688"><a href="#train-1688"><span class="linenos">1688</span></a>    <span class="k">return</span> <span class="n">training_path</span>
</span></pre></div>


            <div class="docstring"><p>Orchestrates the training process for a super-resolution model.</p>

<p>This function handles the entire training loop, including setting up data
generators, defining a composite loss function, automatically balancing loss
weights, iteratively training the model, periodically evaluating performance,
and saving the best-performing model weights.</p>

<h2 id="parameters">Parameters</h2>

<p>mdl : tf.keras.Model
    The Keras model to be trained.
filenames_train : list of str
    List of file paths for the training dataset.
filenames_test : list of str
    List of file paths for the validation/testing dataset.
target_patch_size : tuple or list
    The dimensions of the high-resolution target patches.
target_patch_size_low : tuple or list
    The dimensions of the low-resolution input patches.
output_prefix : str
    A prefix for all output files (e.g., model weights, training logs).
n_test : int, optional
    The number of validation patches to use for evaluation. Default is 8.
learning_rate : float, optional
    The learning rate for the Adam optimizer. Default is 5e-5.
feature_layer : int, optional
    The layer index from the feature extractor to use for perceptual loss.
    Default is 6.
feature : float, optional
    The relative weight of the perceptual (feature) loss term. Default is 2.0.
tv : float, optional
    The relative weight of the Total Variation (TV) regularization term.
    Default is 0.1.
max_iterations : int, optional
    The total number of training iterations to run. Default is 1000.
batch_size : int, optional
    The batch size for training. Note: this implementation is optimized for
    batch_size=1 and may need adjustment for larger batches. Default is 1.
save_all_best : bool, optional
    If True, saves a new model file every time validation loss improves.
    If False, overwrites the single best model file. Default is False.
feature_type : str, optional
    The type of feature extractor for perceptual loss. Options: 'grader',
    'vgg', 'vggrandom'. Default is 'grader'.
check_eval_data_iteration : int, optional
    The frequency (in iterations) at which to run validation and save logs.
    Default is 20.
verbose : bool, optional
    If True, prints detailed progress information. Default is False.</p>

<h2 id="returns">Returns</h2>

<p>pd.DataFrame
    A DataFrame containing the training history, with columns for training
    loss, validation loss, PSNR, and baseline PSNR over iterations.</p>
</div>


                </section>
                <section id="binary_dice_loss">
                            <input id="binary_dice_loss-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">binary_dice_loss</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">y_true</span>, </span><span class="param"><span class="n">y_pred</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="binary_dice_loss-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#binary_dice_loss"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="binary_dice_loss-1691"><a href="#binary_dice_loss-1691"><span class="linenos">1691</span></a><span class="k">def</span> <span class="nf">binary_dice_loss</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">):</span>
</span><span id="binary_dice_loss-1692"><a href="#binary_dice_loss-1692"><span class="linenos">1692</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="binary_dice_loss-1693"><a href="#binary_dice_loss-1693"><span class="linenos">1693</span></a><span class="sd">    Computes the Dice loss for binary segmentation tasks.</span>
</span><span id="binary_dice_loss-1694"><a href="#binary_dice_loss-1694"><span class="linenos">1694</span></a>
</span><span id="binary_dice_loss-1695"><a href="#binary_dice_loss-1695"><span class="linenos">1695</span></a><span class="sd">    The Dice coefficient is a common metric for comparing the overlap of two samples.</span>
</span><span id="binary_dice_loss-1696"><a href="#binary_dice_loss-1696"><span class="linenos">1696</span></a><span class="sd">    This loss function computes `1 - DiceCoefficient`, making it suitable for</span>
</span><span id="binary_dice_loss-1697"><a href="#binary_dice_loss-1697"><span class="linenos">1697</span></a><span class="sd">    minimization during training. A smoothing factor is added to avoid division</span>
</span><span id="binary_dice_loss-1698"><a href="#binary_dice_loss-1698"><span class="linenos">1698</span></a><span class="sd">    by zero when both the prediction and the ground truth are empty.</span>
</span><span id="binary_dice_loss-1699"><a href="#binary_dice_loss-1699"><span class="linenos">1699</span></a>
</span><span id="binary_dice_loss-1700"><a href="#binary_dice_loss-1700"><span class="linenos">1700</span></a><span class="sd">    Parameters</span>
</span><span id="binary_dice_loss-1701"><a href="#binary_dice_loss-1701"><span class="linenos">1701</span></a><span class="sd">    ----------</span>
</span><span id="binary_dice_loss-1702"><a href="#binary_dice_loss-1702"><span class="linenos">1702</span></a><span class="sd">    y_true : tf.Tensor</span>
</span><span id="binary_dice_loss-1703"><a href="#binary_dice_loss-1703"><span class="linenos">1703</span></a><span class="sd">        The ground truth binary segmentation mask. Values should be 0 or 1.</span>
</span><span id="binary_dice_loss-1704"><a href="#binary_dice_loss-1704"><span class="linenos">1704</span></a><span class="sd">    y_pred : tf.Tensor</span>
</span><span id="binary_dice_loss-1705"><a href="#binary_dice_loss-1705"><span class="linenos">1705</span></a><span class="sd">        The predicted binary segmentation mask, typically with values in [0, 1]</span>
</span><span id="binary_dice_loss-1706"><a href="#binary_dice_loss-1706"><span class="linenos">1706</span></a><span class="sd">        from a sigmoid activation.</span>
</span><span id="binary_dice_loss-1707"><a href="#binary_dice_loss-1707"><span class="linenos">1707</span></a>
</span><span id="binary_dice_loss-1708"><a href="#binary_dice_loss-1708"><span class="linenos">1708</span></a><span class="sd">    Returns</span>
</span><span id="binary_dice_loss-1709"><a href="#binary_dice_loss-1709"><span class="linenos">1709</span></a><span class="sd">    -------</span>
</span><span id="binary_dice_loss-1710"><a href="#binary_dice_loss-1710"><span class="linenos">1710</span></a><span class="sd">    tf.Tensor</span>
</span><span id="binary_dice_loss-1711"><a href="#binary_dice_loss-1711"><span class="linenos">1711</span></a><span class="sd">        A scalar tensor representing the Dice loss. The value ranges from -1 (perfect</span>
</span><span id="binary_dice_loss-1712"><a href="#binary_dice_loss-1712"><span class="linenos">1712</span></a><span class="sd">        match) to 0 (no overlap), though it&#39;s typically used as `1 - dice_coeff`</span>
</span><span id="binary_dice_loss-1713"><a href="#binary_dice_loss-1713"><span class="linenos">1713</span></a><span class="sd">        or just `-dice_coeff` (as here).</span>
</span><span id="binary_dice_loss-1714"><a href="#binary_dice_loss-1714"><span class="linenos">1714</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="binary_dice_loss-1715"><a href="#binary_dice_loss-1715"><span class="linenos">1715</span></a>    <span class="n">smoothing_factor</span> <span class="o">=</span> <span class="mf">1e-4</span>
</span><span id="binary_dice_loss-1716"><a href="#binary_dice_loss-1716"><span class="linenos">1716</span></a>    <span class="n">K</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">backend</span>
</span><span id="binary_dice_loss-1717"><a href="#binary_dice_loss-1717"><span class="linenos">1717</span></a>    <span class="n">y_true_f</span> <span class="o">=</span> <span class="n">K</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span>
</span><span id="binary_dice_loss-1718"><a href="#binary_dice_loss-1718"><span class="linenos">1718</span></a>    <span class="n">y_pred_f</span> <span class="o">=</span> <span class="n">K</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span>
</span><span id="binary_dice_loss-1719"><a href="#binary_dice_loss-1719"><span class="linenos">1719</span></a>    <span class="n">intersection</span> <span class="o">=</span> <span class="n">K</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y_true_f</span> <span class="o">*</span> <span class="n">y_pred_f</span><span class="p">)</span>
</span><span id="binary_dice_loss-1720"><a href="#binary_dice_loss-1720"><span class="linenos">1720</span></a>    <span class="c1"># This is -1 * Dice Similarity Coefficient</span>
</span><span id="binary_dice_loss-1721"><a href="#binary_dice_loss-1721"><span class="linenos">1721</span></a>    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">intersection</span> <span class="o">+</span> <span class="n">smoothing_factor</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">K</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y_true_f</span><span class="p">)</span> <span class="o">+</span>
</span><span id="binary_dice_loss-1722"><a href="#binary_dice_loss-1722"><span class="linenos">1722</span></a>            <span class="n">K</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y_pred_f</span><span class="p">)</span> <span class="o">+</span> <span class="n">smoothing_factor</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Computes the Dice loss for binary segmentation tasks.</p>

<p>The Dice coefficient is a common metric for comparing the overlap of two samples.
This loss function computes <code>1 - DiceCoefficient</code>, making it suitable for
minimization during training. A smoothing factor is added to avoid division
by zero when both the prediction and the ground truth are empty.</p>

<h2 id="parameters">Parameters</h2>

<p>y_true : tf.Tensor
    The ground truth binary segmentation mask. Values should be 0 or 1.
y_pred : tf.Tensor
    The predicted binary segmentation mask, typically with values in [0, 1]
    from a sigmoid activation.</p>

<h2 id="returns">Returns</h2>

<p>tf.Tensor
    A scalar tensor representing the Dice loss. The value ranges from -1 (perfect
    match) to 0 (no overlap), though it's typically used as <code>1 - dice_coeff</code>
    or just <code>-dice_coeff</code> (as here).</p>
</div>


                </section>
                <section id="train_seg">
                            <input id="train_seg-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">train_seg</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">mdl</span>,</span><span class="param">	<span class="n">filenames_train</span>,</span><span class="param">	<span class="n">filenames_test</span>,</span><span class="param">	<span class="n">target_patch_size</span>,</span><span class="param">	<span class="n">target_patch_size_low</span>,</span><span class="param">	<span class="n">output_prefix</span>,</span><span class="param">	<span class="n">n_test</span><span class="o">=</span><span class="mi">8</span>,</span><span class="param">	<span class="n">learning_rate</span><span class="o">=</span><span class="mf">5e-05</span>,</span><span class="param">	<span class="n">feature_layer</span><span class="o">=</span><span class="mi">6</span>,</span><span class="param">	<span class="n">feature</span><span class="o">=</span><span class="mi">2</span>,</span><span class="param">	<span class="n">tv</span><span class="o">=</span><span class="mf">0.1</span>,</span><span class="param">	<span class="n">dice</span><span class="o">=</span><span class="mf">0.5</span>,</span><span class="param">	<span class="n">max_iterations</span><span class="o">=</span><span class="mi">1000</span>,</span><span class="param">	<span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span>,</span><span class="param">	<span class="n">save_all_best</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">feature_type</span><span class="o">=</span><span class="s1">&#39;grader&#39;</span>,</span><span class="param">	<span class="n">check_eval_data_iteration</span><span class="o">=</span><span class="mi">20</span>,</span><span class="param">	<span class="n">verbose</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="train_seg-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#train_seg"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="train_seg-1724"><a href="#train_seg-1724"><span class="linenos">1724</span></a><span class="k">def</span> <span class="nf">train_seg</span><span class="p">(</span>
</span><span id="train_seg-1725"><a href="#train_seg-1725"><span class="linenos">1725</span></a>    <span class="n">mdl</span><span class="p">,</span>
</span><span id="train_seg-1726"><a href="#train_seg-1726"><span class="linenos">1726</span></a>    <span class="n">filenames_train</span><span class="p">,</span>
</span><span id="train_seg-1727"><a href="#train_seg-1727"><span class="linenos">1727</span></a>    <span class="n">filenames_test</span><span class="p">,</span>
</span><span id="train_seg-1728"><a href="#train_seg-1728"><span class="linenos">1728</span></a>    <span class="n">target_patch_size</span><span class="p">,</span>
</span><span id="train_seg-1729"><a href="#train_seg-1729"><span class="linenos">1729</span></a>    <span class="n">target_patch_size_low</span><span class="p">,</span>
</span><span id="train_seg-1730"><a href="#train_seg-1730"><span class="linenos">1730</span></a>    <span class="n">output_prefix</span><span class="p">,</span>
</span><span id="train_seg-1731"><a href="#train_seg-1731"><span class="linenos">1731</span></a>    <span class="n">n_test</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
</span><span id="train_seg-1732"><a href="#train_seg-1732"><span class="linenos">1732</span></a>    <span class="n">learning_rate</span><span class="o">=</span><span class="mf">5e-5</span><span class="p">,</span>
</span><span id="train_seg-1733"><a href="#train_seg-1733"><span class="linenos">1733</span></a>    <span class="n">feature_layer</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
</span><span id="train_seg-1734"><a href="#train_seg-1734"><span class="linenos">1734</span></a>    <span class="n">feature</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
</span><span id="train_seg-1735"><a href="#train_seg-1735"><span class="linenos">1735</span></a>    <span class="n">tv</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
</span><span id="train_seg-1736"><a href="#train_seg-1736"><span class="linenos">1736</span></a>    <span class="n">dice</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
</span><span id="train_seg-1737"><a href="#train_seg-1737"><span class="linenos">1737</span></a>    <span class="n">max_iterations</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
</span><span id="train_seg-1738"><a href="#train_seg-1738"><span class="linenos">1738</span></a>    <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="train_seg-1739"><a href="#train_seg-1739"><span class="linenos">1739</span></a>    <span class="n">save_all_best</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="train_seg-1740"><a href="#train_seg-1740"><span class="linenos">1740</span></a>    <span class="n">feature_type</span> <span class="o">=</span> <span class="s1">&#39;grader&#39;</span><span class="p">,</span>
</span><span id="train_seg-1741"><a href="#train_seg-1741"><span class="linenos">1741</span></a>    <span class="n">check_eval_data_iteration</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
</span><span id="train_seg-1742"><a href="#train_seg-1742"><span class="linenos">1742</span></a>    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span>  <span class="p">):</span>
</span><span id="train_seg-1743"><a href="#train_seg-1743"><span class="linenos">1743</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="train_seg-1744"><a href="#train_seg-1744"><span class="linenos">1744</span></a><span class="sd">    Orchestrates training for a multi-task image and segmentation SR model.</span>
</span><span id="train_seg-1745"><a href="#train_seg-1745"><span class="linenos">1745</span></a>
</span><span id="train_seg-1746"><a href="#train_seg-1746"><span class="linenos">1746</span></a><span class="sd">    This function extends the `train` function to handle models that predict</span>
</span><span id="train_seg-1747"><a href="#train_seg-1747"><span class="linenos">1747</span></a><span class="sd">    both a super-resolved image and a super-resolved segmentation mask. It uses</span>
</span><span id="train_seg-1748"><a href="#train_seg-1748"><span class="linenos">1748</span></a><span class="sd">    a four-component composite loss: MSE (for image), a perceptual loss (for</span>
</span><span id="train_seg-1749"><a href="#train_seg-1749"><span class="linenos">1749</span></a><span class="sd">    image), Total Variation (for image), and Dice loss (for segmentation).</span>
</span><span id="train_seg-1750"><a href="#train_seg-1750"><span class="linenos">1750</span></a>
</span><span id="train_seg-1751"><a href="#train_seg-1751"><span class="linenos">1751</span></a><span class="sd">    Parameters</span>
</span><span id="train_seg-1752"><a href="#train_seg-1752"><span class="linenos">1752</span></a><span class="sd">    ----------</span>
</span><span id="train_seg-1753"><a href="#train_seg-1753"><span class="linenos">1753</span></a><span class="sd">    mdl : tf.keras.Model</span>
</span><span id="train_seg-1754"><a href="#train_seg-1754"><span class="linenos">1754</span></a><span class="sd">        The 2-channel Keras model to be trained.</span>
</span><span id="train_seg-1755"><a href="#train_seg-1755"><span class="linenos">1755</span></a><span class="sd">    filenames_train : list of str</span>
</span><span id="train_seg-1756"><a href="#train_seg-1756"><span class="linenos">1756</span></a><span class="sd">        List of file paths for the training dataset.</span>
</span><span id="train_seg-1757"><a href="#train_seg-1757"><span class="linenos">1757</span></a><span class="sd">    filenames_test : list of str</span>
</span><span id="train_seg-1758"><a href="#train_seg-1758"><span class="linenos">1758</span></a><span class="sd">        List of file paths for the validation/testing dataset.</span>
</span><span id="train_seg-1759"><a href="#train_seg-1759"><span class="linenos">1759</span></a><span class="sd">    target_patch_size : tuple or list</span>
</span><span id="train_seg-1760"><a href="#train_seg-1760"><span class="linenos">1760</span></a><span class="sd">        The dimensions of the high-resolution target patches.</span>
</span><span id="train_seg-1761"><a href="#train_seg-1761"><span class="linenos">1761</span></a><span class="sd">    target_patch_size_low : tuple or list</span>
</span><span id="train_seg-1762"><a href="#train_seg-1762"><span class="linenos">1762</span></a><span class="sd">        The dimensions of the low-resolution input patches.</span>
</span><span id="train_seg-1763"><a href="#train_seg-1763"><span class="linenos">1763</span></a><span class="sd">    output_prefix : str</span>
</span><span id="train_seg-1764"><a href="#train_seg-1764"><span class="linenos">1764</span></a><span class="sd">        A prefix for all output files.</span>
</span><span id="train_seg-1765"><a href="#train_seg-1765"><span class="linenos">1765</span></a><span class="sd">    n_test : int, optional</span>
</span><span id="train_seg-1766"><a href="#train_seg-1766"><span class="linenos">1766</span></a><span class="sd">        Number of validation patches for evaluation. Default is 8.</span>
</span><span id="train_seg-1767"><a href="#train_seg-1767"><span class="linenos">1767</span></a><span class="sd">    learning_rate : float, optional</span>
</span><span id="train_seg-1768"><a href="#train_seg-1768"><span class="linenos">1768</span></a><span class="sd">        Learning rate for the Adam optimizer. Default is 5e-5.</span>
</span><span id="train_seg-1769"><a href="#train_seg-1769"><span class="linenos">1769</span></a><span class="sd">    feature_layer : int, optional</span>
</span><span id="train_seg-1770"><a href="#train_seg-1770"><span class="linenos">1770</span></a><span class="sd">        Layer from the feature extractor for perceptual loss. Default is 6.</span>
</span><span id="train_seg-1771"><a href="#train_seg-1771"><span class="linenos">1771</span></a><span class="sd">    feature : float, optional</span>
</span><span id="train_seg-1772"><a href="#train_seg-1772"><span class="linenos">1772</span></a><span class="sd">        Relative weight of the perceptual loss term. Default is 2.0.</span>
</span><span id="train_seg-1773"><a href="#train_seg-1773"><span class="linenos">1773</span></a><span class="sd">    tv : float, optional</span>
</span><span id="train_seg-1774"><a href="#train_seg-1774"><span class="linenos">1774</span></a><span class="sd">        Relative weight of the Total Variation regularization term. Default is 0.1.</span>
</span><span id="train_seg-1775"><a href="#train_seg-1775"><span class="linenos">1775</span></a><span class="sd">    dice : float, optional</span>
</span><span id="train_seg-1776"><a href="#train_seg-1776"><span class="linenos">1776</span></a><span class="sd">        Relative weight of the Dice loss term for the segmentation mask.</span>
</span><span id="train_seg-1777"><a href="#train_seg-1777"><span class="linenos">1777</span></a><span class="sd">        Default is 0.5.</span>
</span><span id="train_seg-1778"><a href="#train_seg-1778"><span class="linenos">1778</span></a><span class="sd">    max_iterations : int, optional</span>
</span><span id="train_seg-1779"><a href="#train_seg-1779"><span class="linenos">1779</span></a><span class="sd">        Total number of training iterations. Default is 1000.</span>
</span><span id="train_seg-1780"><a href="#train_seg-1780"><span class="linenos">1780</span></a><span class="sd">    batch_size : int, optional</span>
</span><span id="train_seg-1781"><a href="#train_seg-1781"><span class="linenos">1781</span></a><span class="sd">        The batch size for training. Default is 1.</span>
</span><span id="train_seg-1782"><a href="#train_seg-1782"><span class="linenos">1782</span></a><span class="sd">    save_all_best : bool, optional</span>
</span><span id="train_seg-1783"><a href="#train_seg-1783"><span class="linenos">1783</span></a><span class="sd">        If True, saves all models that improve validation loss. Default is False.</span>
</span><span id="train_seg-1784"><a href="#train_seg-1784"><span class="linenos">1784</span></a><span class="sd">    feature_type : str, optional</span>
</span><span id="train_seg-1785"><a href="#train_seg-1785"><span class="linenos">1785</span></a><span class="sd">        Type of feature extractor for perceptual loss. Default is &#39;grader&#39;.</span>
</span><span id="train_seg-1786"><a href="#train_seg-1786"><span class="linenos">1786</span></a><span class="sd">    check_eval_data_iteration : int, optional</span>
</span><span id="train_seg-1787"><a href="#train_seg-1787"><span class="linenos">1787</span></a><span class="sd">        Frequency (in iterations) for running validation. Default is 20.</span>
</span><span id="train_seg-1788"><a href="#train_seg-1788"><span class="linenos">1788</span></a><span class="sd">    verbose : bool, optional</span>
</span><span id="train_seg-1789"><a href="#train_seg-1789"><span class="linenos">1789</span></a><span class="sd">        If True, prints detailed progress information. Default is False.</span>
</span><span id="train_seg-1790"><a href="#train_seg-1790"><span class="linenos">1790</span></a>
</span><span id="train_seg-1791"><a href="#train_seg-1791"><span class="linenos">1791</span></a><span class="sd">    Returns</span>
</span><span id="train_seg-1792"><a href="#train_seg-1792"><span class="linenos">1792</span></a><span class="sd">    -------</span>
</span><span id="train_seg-1793"><a href="#train_seg-1793"><span class="linenos">1793</span></a><span class="sd">    pd.DataFrame</span>
</span><span id="train_seg-1794"><a href="#train_seg-1794"><span class="linenos">1794</span></a><span class="sd">        A DataFrame containing the training history, including columns for losses</span>
</span><span id="train_seg-1795"><a href="#train_seg-1795"><span class="linenos">1795</span></a><span class="sd">        and evaluation metrics like PSNR and Dice score.</span>
</span><span id="train_seg-1796"><a href="#train_seg-1796"><span class="linenos">1796</span></a>
</span><span id="train_seg-1797"><a href="#train_seg-1797"><span class="linenos">1797</span></a><span class="sd">    See Also</span>
</span><span id="train_seg-1798"><a href="#train_seg-1798"><span class="linenos">1798</span></a><span class="sd">    --------</span>
</span><span id="train_seg-1799"><a href="#train_seg-1799"><span class="linenos">1799</span></a><span class="sd">    train : The training function for single-task (intensity-only) models.</span>
</span><span id="train_seg-1800"><a href="#train_seg-1800"><span class="linenos">1800</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="train_seg-1801"><a href="#train_seg-1801"><span class="linenos">1801</span></a>    <span class="n">colnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;train_loss&#39;</span><span class="p">,</span><span class="s1">&#39;test_loss&#39;</span><span class="p">,</span><span class="s1">&#39;best&#39;</span><span class="p">,</span><span class="s1">&#39;eval_psnr&#39;</span><span class="p">,</span><span class="s1">&#39;eval_psnr_lin&#39;</span><span class="p">,</span><span class="s1">&#39;eval_msq&#39;</span><span class="p">,</span><span class="s1">&#39;eval_dice&#39;</span><span class="p">]</span>
</span><span id="train_seg-1802"><a href="#train_seg-1802"><span class="linenos">1802</span></a>    <span class="n">training_path</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span> <span class="n">max_iterations</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">colnames</span><span class="p">)</span> <span class="p">]</span> <span class="p">)</span>
</span><span id="train_seg-1803"><a href="#train_seg-1803"><span class="linenos">1803</span></a>    <span class="n">training_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span> <span class="p">)</span>
</span><span id="train_seg-1804"><a href="#train_seg-1804"><span class="linenos">1804</span></a>    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="train_seg-1805"><a href="#train_seg-1805"><span class="linenos">1805</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;begin get feature extractor&quot;</span><span class="p">)</span>
</span><span id="train_seg-1806"><a href="#train_seg-1806"><span class="linenos">1806</span></a>    <span class="k">if</span> <span class="n">feature_type</span> <span class="o">==</span> <span class="s1">&#39;grader&#39;</span><span class="p">:</span>
</span><span id="train_seg-1807"><a href="#train_seg-1807"><span class="linenos">1807</span></a>        <span class="n">feature_extractor</span> <span class="o">=</span> <span class="n">get_grader_feature_network</span><span class="p">(</span> <span class="n">feature_layer</span> <span class="p">)</span>
</span><span id="train_seg-1808"><a href="#train_seg-1808"><span class="linenos">1808</span></a>    <span class="k">elif</span> <span class="n">feature_type</span> <span class="o">==</span> <span class="s1">&#39;vggrandom&#39;</span><span class="p">:</span>
</span><span id="train_seg-1809"><a href="#train_seg-1809"><span class="linenos">1809</span></a>        <span class="n">feature_extractor</span> <span class="o">=</span> <span class="n">pseudo_3d_vgg_features</span><span class="p">(</span> <span class="n">target_patch_size</span><span class="p">,</span> <span class="n">feature_layer</span><span class="p">,</span> <span class="n">pretrained</span><span class="o">=</span><span class="kc">False</span> <span class="p">)</span>
</span><span id="train_seg-1810"><a href="#train_seg-1810"><span class="linenos">1810</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="train_seg-1811"><a href="#train_seg-1811"><span class="linenos">1811</span></a>        <span class="n">feature_extractor</span> <span class="o">=</span> <span class="n">pseudo_3d_vgg_features_unbiased</span><span class="p">(</span> <span class="n">target_patch_size</span><span class="p">,</span> <span class="n">feature_layer</span>  <span class="p">)</span>
</span><span id="train_seg-1812"><a href="#train_seg-1812"><span class="linenos">1812</span></a>    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="train_seg-1813"><a href="#train_seg-1813"><span class="linenos">1813</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;begin train generator&quot;</span><span class="p">)</span>
</span><span id="train_seg-1814"><a href="#train_seg-1814"><span class="linenos">1814</span></a>    <span class="n">mydatgen</span> <span class="o">=</span> <span class="n">seg_generator</span><span class="p">(</span>
</span><span id="train_seg-1815"><a href="#train_seg-1815"><span class="linenos">1815</span></a>        <span class="n">filenames_train</span><span class="p">,</span>
</span><span id="train_seg-1816"><a href="#train_seg-1816"><span class="linenos">1816</span></a>        <span class="n">nPatches</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="train_seg-1817"><a href="#train_seg-1817"><span class="linenos">1817</span></a>        <span class="n">target_patch_size</span><span class="o">=</span><span class="n">target_patch_size</span><span class="p">,</span>
</span><span id="train_seg-1818"><a href="#train_seg-1818"><span class="linenos">1818</span></a>        <span class="n">target_patch_size_low</span><span class="o">=</span><span class="n">target_patch_size_low</span><span class="p">,</span>
</span><span id="train_seg-1819"><a href="#train_seg-1819"><span class="linenos">1819</span></a>        <span class="n">istest</span><span class="o">=</span><span class="kc">False</span> <span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="train_seg-1820"><a href="#train_seg-1820"><span class="linenos">1820</span></a>    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="train_seg-1821"><a href="#train_seg-1821"><span class="linenos">1821</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;begin test generator&quot;</span><span class="p">)</span>
</span><span id="train_seg-1822"><a href="#train_seg-1822"><span class="linenos">1822</span></a>    <span class="n">mydatgenTest</span> <span class="o">=</span> <span class="n">seg_generator</span><span class="p">(</span> <span class="n">filenames_test</span><span class="p">,</span> <span class="n">nPatches</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="train_seg-1823"><a href="#train_seg-1823"><span class="linenos">1823</span></a>        <span class="n">target_patch_size</span><span class="o">=</span><span class="n">target_patch_size</span><span class="p">,</span>
</span><span id="train_seg-1824"><a href="#train_seg-1824"><span class="linenos">1824</span></a>        <span class="n">target_patch_size_low</span><span class="o">=</span><span class="n">target_patch_size_low</span><span class="p">,</span>
</span><span id="train_seg-1825"><a href="#train_seg-1825"><span class="linenos">1825</span></a>        <span class="n">istest</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="train_seg-1826"><a href="#train_seg-1826"><span class="linenos">1826</span></a>    <span class="n">patchesResamTeTf</span><span class="p">,</span> <span class="n">patchesOrigTeTf</span><span class="p">,</span> <span class="n">patchesUpTeTf</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span> <span class="n">mydatgenTest</span> <span class="p">)</span>
</span><span id="train_seg-1827"><a href="#train_seg-1827"><span class="linenos">1827</span></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span> <span class="n">patchesOrigTeTf</span><span class="o">.</span><span class="n">shape</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
</span><span id="train_seg-1828"><a href="#train_seg-1828"><span class="linenos">1828</span></a>            <span class="n">tdim</span> <span class="o">=</span> <span class="mi">3</span>
</span><span id="train_seg-1829"><a href="#train_seg-1829"><span class="linenos">1829</span></a>            <span class="n">myax</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span>
</span><span id="train_seg-1830"><a href="#train_seg-1830"><span class="linenos">1830</span></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span> <span class="n">patchesOrigTeTf</span><span class="o">.</span><span class="n">shape</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
</span><span id="train_seg-1831"><a href="#train_seg-1831"><span class="linenos">1831</span></a>            <span class="n">tdim</span> <span class="o">=</span> <span class="mi">2</span>
</span><span id="train_seg-1832"><a href="#train_seg-1832"><span class="linenos">1832</span></a>            <span class="n">myax</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
</span><span id="train_seg-1833"><a href="#train_seg-1833"><span class="linenos">1833</span></a>    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="train_seg-1834"><a href="#train_seg-1834"><span class="linenos">1834</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;begin train generator #2 at dim: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span> <span class="n">tdim</span><span class="p">))</span>
</span><span id="train_seg-1835"><a href="#train_seg-1835"><span class="linenos">1835</span></a>    <span class="n">mydatgenTest</span> <span class="o">=</span> <span class="n">seg_generator</span><span class="p">(</span> <span class="n">filenames_test</span><span class="p">,</span> <span class="n">nPatches</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="train_seg-1836"><a href="#train_seg-1836"><span class="linenos">1836</span></a>        <span class="n">target_patch_size</span><span class="o">=</span><span class="n">target_patch_size</span><span class="p">,</span>
</span><span id="train_seg-1837"><a href="#train_seg-1837"><span class="linenos">1837</span></a>        <span class="n">target_patch_size_low</span><span class="o">=</span><span class="n">target_patch_size_low</span><span class="p">,</span>
</span><span id="train_seg-1838"><a href="#train_seg-1838"><span class="linenos">1838</span></a>        <span class="n">istest</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="train_seg-1839"><a href="#train_seg-1839"><span class="linenos">1839</span></a>    <span class="n">patchesResamTeTfB</span><span class="p">,</span> <span class="n">patchesOrigTeTfB</span><span class="p">,</span> <span class="n">patchesUpTeTfB</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span> <span class="n">mydatgenTest</span> <span class="p">)</span>
</span><span id="train_seg-1840"><a href="#train_seg-1840"><span class="linenos">1840</span></a>    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">n_test</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">):</span>
</span><span id="train_seg-1841"><a href="#train_seg-1841"><span class="linenos">1841</span></a>        <span class="n">mydatgenTest</span> <span class="o">=</span> <span class="n">seg_generator</span><span class="p">(</span> <span class="n">filenames_test</span><span class="p">,</span> <span class="n">nPatches</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="train_seg-1842"><a href="#train_seg-1842"><span class="linenos">1842</span></a>            <span class="n">target_patch_size</span><span class="o">=</span><span class="n">target_patch_size</span><span class="p">,</span>
</span><span id="train_seg-1843"><a href="#train_seg-1843"><span class="linenos">1843</span></a>            <span class="n">target_patch_size_low</span><span class="o">=</span><span class="n">target_patch_size_low</span><span class="p">,</span>
</span><span id="train_seg-1844"><a href="#train_seg-1844"><span class="linenos">1844</span></a>            <span class="n">istest</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="train_seg-1845"><a href="#train_seg-1845"><span class="linenos">1845</span></a>        <span class="n">temp0</span><span class="p">,</span> <span class="n">temp1</span><span class="p">,</span> <span class="n">temp2</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span> <span class="n">mydatgenTest</span> <span class="p">)</span>
</span><span id="train_seg-1846"><a href="#train_seg-1846"><span class="linenos">1846</span></a>        <span class="n">patchesResamTeTfB</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span> <span class="p">[</span><span class="n">patchesResamTeTfB</span><span class="p">,</span><span class="n">temp0</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="train_seg-1847"><a href="#train_seg-1847"><span class="linenos">1847</span></a>        <span class="n">patchesOrigTeTfB</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span> <span class="p">[</span><span class="n">patchesOrigTeTfB</span><span class="p">,</span><span class="n">temp1</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="train_seg-1848"><a href="#train_seg-1848"><span class="linenos">1848</span></a>        <span class="n">patchesUpTeTfB</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span> <span class="p">[</span><span class="n">patchesUpTeTfB</span><span class="p">,</span><span class="n">temp2</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="train_seg-1849"><a href="#train_seg-1849"><span class="linenos">1849</span></a>    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="train_seg-1850"><a href="#train_seg-1850"><span class="linenos">1850</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;begin auto_weight_loss_seg&quot;</span><span class="p">)</span>
</span><span id="train_seg-1851"><a href="#train_seg-1851"><span class="linenos">1851</span></a>    <span class="n">wts_csv</span> <span class="o">=</span> <span class="n">output_prefix</span> <span class="o">+</span> <span class="s2">&quot;_training_weights.csv&quot;</span>
</span><span id="train_seg-1852"><a href="#train_seg-1852"><span class="linenos">1852</span></a>    <span class="k">if</span> <span class="n">exists</span><span class="p">(</span> <span class="n">wts_csv</span> <span class="p">):</span>
</span><span id="train_seg-1853"><a href="#train_seg-1853"><span class="linenos">1853</span></a>        <span class="n">wtsdf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span> <span class="n">wts_csv</span> <span class="p">)</span>
</span><span id="train_seg-1854"><a href="#train_seg-1854"><span class="linenos">1854</span></a>        <span class="n">wts</span> <span class="o">=</span> <span class="p">[</span><span class="n">wtsdf</span><span class="p">[</span><span class="s1">&#39;msq&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">wtsdf</span><span class="p">[</span><span class="s1">&#39;feat&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">wtsdf</span><span class="p">[</span><span class="s1">&#39;tv&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">wtsdf</span><span class="p">[</span><span class="s1">&#39;dice&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
</span><span id="train_seg-1855"><a href="#train_seg-1855"><span class="linenos">1855</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="train_seg-1856"><a href="#train_seg-1856"><span class="linenos">1856</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;preset weights:&quot;</span> <span class="p">)</span>
</span><span id="train_seg-1857"><a href="#train_seg-1857"><span class="linenos">1857</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="train_seg-1858"><a href="#train_seg-1858"><span class="linenos">1858</span></a>        <span class="n">wts</span> <span class="o">=</span> <span class="n">auto_weight_loss_seg</span><span class="p">(</span> <span class="n">mdl</span><span class="p">,</span> <span class="n">feature_extractor</span><span class="p">,</span> <span class="n">patchesResamTeTf</span><span class="p">,</span> <span class="n">patchesOrigTeTf</span><span class="p">,</span>
</span><span id="train_seg-1859"><a href="#train_seg-1859"><span class="linenos">1859</span></a>            <span class="n">feature</span><span class="o">=</span><span class="n">feature</span><span class="p">,</span> <span class="n">tv</span><span class="o">=</span><span class="n">tv</span><span class="p">,</span> <span class="n">dice</span><span class="o">=</span><span class="n">dice</span> <span class="p">)</span>
</span><span id="train_seg-1860"><a href="#train_seg-1860"><span class="linenos">1860</span></a>        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">wts</span><span class="p">)):</span>
</span><span id="train_seg-1861"><a href="#train_seg-1861"><span class="linenos">1861</span></a>            <span class="n">training_weights</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">=</span><span class="n">wts</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
</span><span id="train_seg-1862"><a href="#train_seg-1862"><span class="linenos">1862</span></a>        <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">training_weights</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;msq&quot;</span><span class="p">,</span><span class="s2">&quot;feat&quot;</span><span class="p">,</span><span class="s2">&quot;tv&quot;</span><span class="p">,</span><span class="s2">&quot;dice&quot;</span><span class="p">]</span> <span class="p">)</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span> <span class="n">wts_csv</span> <span class="p">)</span>
</span><span id="train_seg-1863"><a href="#train_seg-1863"><span class="linenos">1863</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="train_seg-1864"><a href="#train_seg-1864"><span class="linenos">1864</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;automatic weights:&quot;</span> <span class="p">)</span>
</span><span id="train_seg-1865"><a href="#train_seg-1865"><span class="linenos">1865</span></a>    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="train_seg-1866"><a href="#train_seg-1866"><span class="linenos">1866</span></a>        <span class="nb">print</span><span class="p">(</span> <span class="n">wts</span> <span class="p">)</span>
</span><span id="train_seg-1867"><a href="#train_seg-1867"><span class="linenos">1867</span></a>    <span class="k">def</span> <span class="nf">my_loss_6</span><span class="p">(</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">msqwt</span> <span class="o">=</span> <span class="n">wts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fw</span> <span class="o">=</span> <span class="n">wts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">tvwt</span> <span class="o">=</span> <span class="n">wts</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">dicewt</span><span class="o">=</span><span class="n">wts</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">mybs</span> <span class="o">=</span> <span class="n">batch_size</span> <span class="p">):</span>
</span><span id="train_seg-1868"><a href="#train_seg-1868"><span class="linenos">1868</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Composite loss: MSE + Perceptual + TV + Dice.&quot;&quot;&quot;</span>
</span><span id="train_seg-1869"><a href="#train_seg-1869"><span class="linenos">1869</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span> <span class="n">y_true</span><span class="o">.</span><span class="n">shape</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
</span><span id="train_seg-1870"><a href="#train_seg-1870"><span class="linenos">1870</span></a>            <span class="n">tdim</span> <span class="o">=</span> <span class="mi">3</span>
</span><span id="train_seg-1871"><a href="#train_seg-1871"><span class="linenos">1871</span></a>            <span class="n">myax</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span>
</span><span id="train_seg-1872"><a href="#train_seg-1872"><span class="linenos">1872</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span> <span class="n">y_true</span><span class="o">.</span><span class="n">shape</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
</span><span id="train_seg-1873"><a href="#train_seg-1873"><span class="linenos">1873</span></a>            <span class="n">tdim</span> <span class="o">=</span> <span class="mi">2</span>
</span><span id="train_seg-1874"><a href="#train_seg-1874"><span class="linenos">1874</span></a>            <span class="n">myax</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
</span><span id="train_seg-1875"><a href="#train_seg-1875"><span class="linenos">1875</span></a>        <span class="n">y_intensity</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span> <span class="n">y_true</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">tdim</span><span class="o">+</span><span class="mi">1</span> <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="train_seg-1876"><a href="#train_seg-1876"><span class="linenos">1876</span></a>        <span class="n">y_seg</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span> <span class="n">y_true</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">tdim</span><span class="o">+</span><span class="mi">1</span> <span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="train_seg-1877"><a href="#train_seg-1877"><span class="linenos">1877</span></a>        <span class="n">y_intensity_p</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span> <span class="n">y_pred</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">tdim</span><span class="o">+</span><span class="mi">1</span> <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="train_seg-1878"><a href="#train_seg-1878"><span class="linenos">1878</span></a>        <span class="n">y_seg_p</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span> <span class="n">y_pred</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">tdim</span><span class="o">+</span><span class="mi">1</span> <span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="train_seg-1879"><a href="#train_seg-1879"><span class="linenos">1879</span></a>        <span class="n">squared_difference</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">y_intensity</span> <span class="o">-</span> <span class="n">y_intensity_p</span><span class="p">)</span>
</span><span id="train_seg-1880"><a href="#train_seg-1880"><span class="linenos">1880</span></a>        <span class="n">msqTerm</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">squared_difference</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">myax</span><span class="p">)</span>
</span><span id="train_seg-1881"><a href="#train_seg-1881"><span class="linenos">1881</span></a>        <span class="n">temp1</span> <span class="o">=</span> <span class="n">feature_extractor</span><span class="p">(</span><span class="n">y_intensity</span><span class="p">)</span>
</span><span id="train_seg-1882"><a href="#train_seg-1882"><span class="linenos">1882</span></a>        <span class="n">temp2</span> <span class="o">=</span> <span class="n">feature_extractor</span><span class="p">(</span><span class="n">y_intensity_p</span><span class="p">)</span>
</span><span id="train_seg-1883"><a href="#train_seg-1883"><span class="linenos">1883</span></a>        <span class="n">feature_difference</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">temp1</span><span class="o">-</span><span class="n">temp2</span><span class="p">)</span>
</span><span id="train_seg-1884"><a href="#train_seg-1884"><span class="linenos">1884</span></a>        <span class="n">featureTerm</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">feature_difference</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">myax</span><span class="p">)</span>
</span><span id="train_seg-1885"><a href="#train_seg-1885"><span class="linenos">1885</span></a>        <span class="n">loss</span> <span class="o">=</span> <span class="n">msqTerm</span> <span class="o">*</span> <span class="n">msqwt</span> <span class="o">+</span> <span class="n">featureTerm</span> <span class="o">*</span> <span class="n">fw</span>
</span><span id="train_seg-1886"><a href="#train_seg-1886"><span class="linenos">1886</span></a>        <span class="n">mytv</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s1">&#39;float32&#39;</span><span class="p">)</span>
</span><span id="train_seg-1887"><a href="#train_seg-1887"><span class="linenos">1887</span></a>        <span class="k">if</span> <span class="n">tdim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="train_seg-1888"><a href="#train_seg-1888"><span class="linenos">1888</span></a>            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">mybs</span> <span class="p">):</span> <span class="c1"># BUG not sure why myr fails .... might be old TF version</span>
</span><span id="train_seg-1889"><a href="#train_seg-1889"><span class="linenos">1889</span></a>                <span class="n">sqzd</span> <span class="o">=</span> <span class="n">y_pred</span><span class="p">[</span><span class="n">k</span><span class="p">,:,:,:,</span><span class="mi">0</span><span class="p">]</span>
</span><span id="train_seg-1890"><a href="#train_seg-1890"><span class="linenos">1890</span></a>                <span class="n">mytv</span> <span class="o">=</span> <span class="n">mytv</span> <span class="o">+</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">total_variation</span><span class="p">(</span> <span class="n">sqzd</span> <span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">tvwt</span>
</span><span id="train_seg-1891"><a href="#train_seg-1891"><span class="linenos">1891</span></a>        <span class="k">if</span> <span class="n">tdim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="train_seg-1892"><a href="#train_seg-1892"><span class="linenos">1892</span></a>            <span class="n">mytv</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">total_variation</span><span class="p">(</span> <span class="n">y_pred</span><span class="p">[:,:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">tvwt</span>
</span><span id="train_seg-1893"><a href="#train_seg-1893"><span class="linenos">1893</span></a>        <span class="n">dicer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span> <span class="n">dicewt</span> <span class="o">*</span> <span class="n">binary_dice_loss</span><span class="p">(</span> <span class="n">y_seg</span><span class="p">,</span> <span class="n">y_seg_p</span> <span class="p">)</span> <span class="p">)</span>
</span><span id="train_seg-1894"><a href="#train_seg-1894"><span class="linenos">1894</span></a>        <span class="k">return</span><span class="p">(</span> <span class="n">loss</span> <span class="o">+</span> <span class="n">mytv</span> <span class="o">+</span> <span class="n">dicer</span> <span class="p">)</span>
</span><span id="train_seg-1895"><a href="#train_seg-1895"><span class="linenos">1895</span></a>    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="train_seg-1896"><a href="#train_seg-1896"><span class="linenos">1896</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;begin model compilation&quot;</span><span class="p">)</span>
</span><span id="train_seg-1897"><a href="#train_seg-1897"><span class="linenos">1897</span></a>    <span class="n">opt</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span> <span class="n">learning_rate</span><span class="o">=</span><span class="n">learning_rate</span> <span class="p">)</span>
</span><span id="train_seg-1898"><a href="#train_seg-1898"><span class="linenos">1898</span></a>    <span class="n">mdl</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">opt</span><span class="p">,</span> <span class="n">loss</span><span class="o">=</span><span class="n">my_loss_6</span><span class="p">)</span>
</span><span id="train_seg-1899"><a href="#train_seg-1899"><span class="linenos">1899</span></a>    <span class="c1"># set up some parameters for tracking performance</span>
</span><span id="train_seg-1900"><a href="#train_seg-1900"><span class="linenos">1900</span></a>    <span class="n">bestValLoss</span><span class="o">=</span><span class="mf">1e12</span>
</span><span id="train_seg-1901"><a href="#train_seg-1901"><span class="linenos">1901</span></a>    <span class="n">bestSSIM</span><span class="o">=</span><span class="mf">0.0</span>
</span><span id="train_seg-1902"><a href="#train_seg-1902"><span class="linenos">1902</span></a>    <span class="n">bestQC0</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1000</span>
</span><span id="train_seg-1903"><a href="#train_seg-1903"><span class="linenos">1903</span></a>    <span class="n">bestQC1</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1000</span>
</span><span id="train_seg-1904"><a href="#train_seg-1904"><span class="linenos">1904</span></a>    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="train_seg-1905"><a href="#train_seg-1905"><span class="linenos">1905</span></a>        <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;begin training&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span>  <span class="p">)</span>
</span><span id="train_seg-1906"><a href="#train_seg-1906"><span class="linenos">1906</span></a>    <span class="k">for</span> <span class="n">myrs</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">max_iterations</span> <span class="p">):</span>
</span><span id="train_seg-1907"><a href="#train_seg-1907"><span class="linenos">1907</span></a>        <span class="n">tracker</span> <span class="o">=</span> <span class="n">mdl</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span> <span class="n">mydatgen</span><span class="p">,</span>  <span class="n">epochs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">steps_per_epoch</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="train_seg-1908"><a href="#train_seg-1908"><span class="linenos">1908</span></a>            <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">patchesResamTeTf</span><span class="p">,</span><span class="n">patchesOrigTeTf</span><span class="p">)</span> <span class="p">)</span>
</span><span id="train_seg-1909"><a href="#train_seg-1909"><span class="linenos">1909</span></a>        <span class="n">training_path</span><span class="p">[</span><span class="n">myrs</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">tracker</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="train_seg-1910"><a href="#train_seg-1910"><span class="linenos">1910</span></a>        <span class="n">training_path</span><span class="p">[</span><span class="n">myrs</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">tracker</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_loss&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="train_seg-1911"><a href="#train_seg-1911"><span class="linenos">1911</span></a>        <span class="n">training_path</span><span class="p">[</span><span class="n">myrs</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
</span><span id="train_seg-1912"><a href="#train_seg-1912"><span class="linenos">1912</span></a>        <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;ntrain: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">myrs</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; loss &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span> <span class="n">tracker</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; val-loss &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">tracker</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_loss&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span>  <span class="p">)</span>
</span><span id="train_seg-1913"><a href="#train_seg-1913"><span class="linenos">1913</span></a>        <span class="k">if</span> <span class="n">myrs</span> <span class="o">%</span> <span class="n">check_eval_data_iteration</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="train_seg-1914"><a href="#train_seg-1914"><span class="linenos">1914</span></a>            <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;/cpu:0&quot;</span><span class="p">):</span>
</span><span id="train_seg-1915"><a href="#train_seg-1915"><span class="linenos">1915</span></a>                <span class="n">myofn</span> <span class="o">=</span> <span class="n">output_prefix</span> <span class="o">+</span> <span class="s2">&quot;_best_mdl.keras&quot;</span>
</span><span id="train_seg-1916"><a href="#train_seg-1916"><span class="linenos">1916</span></a>                <span class="k">if</span> <span class="n">save_all_best</span><span class="p">:</span>
</span><span id="train_seg-1917"><a href="#train_seg-1917"><span class="linenos">1917</span></a>                    <span class="n">myofn</span> <span class="o">=</span> <span class="n">output_prefix</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">myrs</span><span class="p">)</span><span class="o">+</span> <span class="s2">&quot;_mdl.keras&quot;</span>
</span><span id="train_seg-1918"><a href="#train_seg-1918"><span class="linenos">1918</span></a>                <span class="n">tester</span> <span class="o">=</span> <span class="n">mdl</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span> <span class="n">patchesResamTeTfB</span><span class="p">,</span> <span class="n">patchesOrigTeTfB</span> <span class="p">)</span>
</span><span id="train_seg-1919"><a href="#train_seg-1919"><span class="linenos">1919</span></a>                <span class="k">if</span> <span class="p">(</span> <span class="n">tester</span> <span class="o">&lt;</span> <span class="n">bestValLoss</span> <span class="p">):</span>
</span><span id="train_seg-1920"><a href="#train_seg-1920"><span class="linenos">1920</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;MyIT &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span> <span class="n">myrs</span> <span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; IS BEST!! &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span> <span class="n">tester</span> <span class="p">)</span> <span class="o">+</span> <span class="n">myofn</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span> <span class="p">)</span>
</span><span id="train_seg-1921"><a href="#train_seg-1921"><span class="linenos">1921</span></a>                    <span class="n">bestValLoss</span> <span class="o">=</span> <span class="n">tester</span>
</span><span id="train_seg-1922"><a href="#train_seg-1922"><span class="linenos">1922</span></a>                    <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span> <span class="n">mdl</span><span class="p">,</span> <span class="n">myofn</span> <span class="p">)</span>
</span><span id="train_seg-1923"><a href="#train_seg-1923"><span class="linenos">1923</span></a>                    <span class="n">training_path</span><span class="p">[</span><span class="n">myrs</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
</span><span id="train_seg-1924"><a href="#train_seg-1924"><span class="linenos">1924</span></a>                <span class="n">pp</span> <span class="o">=</span> <span class="n">mdl</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span> <span class="n">patchesResamTeTfB</span><span class="p">,</span> <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">)</span>
</span><span id="train_seg-1925"><a href="#train_seg-1925"><span class="linenos">1925</span></a>                <span class="n">pp</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span> <span class="n">pp</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">tdim</span><span class="o">+</span><span class="mi">1</span> <span class="p">)</span>
</span><span id="train_seg-1926"><a href="#train_seg-1926"><span class="linenos">1926</span></a>                <span class="n">y_orig</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span> <span class="n">patchesOrigTeTfB</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">tdim</span><span class="o">+</span><span class="mi">1</span> <span class="p">)</span>
</span><span id="train_seg-1927"><a href="#train_seg-1927"><span class="linenos">1927</span></a>                <span class="n">y_up</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span> <span class="n">patchesUpTeTfB</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">tdim</span><span class="o">+</span><span class="mi">1</span> <span class="p">)</span>
</span><span id="train_seg-1928"><a href="#train_seg-1928"><span class="linenos">1928</span></a>                <span class="n">myssimSR</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">psnr</span><span class="p">(</span> <span class="n">pp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">220</span><span class="p">,</span> <span class="n">y_orig</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span> <span class="mi">220</span><span class="p">,</span> <span class="n">max_val</span><span class="o">=</span><span class="mi">255</span> <span class="p">)</span>
</span><span id="train_seg-1929"><a href="#train_seg-1929"><span class="linenos">1929</span></a>                <span class="n">myssimSR</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span> <span class="n">myssimSR</span> <span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="train_seg-1930"><a href="#train_seg-1930"><span class="linenos">1930</span></a>                <span class="n">myssimBI</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">psnr</span><span class="p">(</span> <span class="n">y_up</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">220</span><span class="p">,</span> <span class="n">y_orig</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span> <span class="mi">220</span><span class="p">,</span> <span class="n">max_val</span><span class="o">=</span><span class="mi">255</span> <span class="p">)</span>
</span><span id="train_seg-1931"><a href="#train_seg-1931"><span class="linenos">1931</span></a>                <span class="n">myssimBI</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span> <span class="n">myssimBI</span> <span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="train_seg-1932"><a href="#train_seg-1932"><span class="linenos">1932</span></a>                <span class="n">squared_difference</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">y_orig</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pp</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="train_seg-1933"><a href="#train_seg-1933"><span class="linenos">1933</span></a>                <span class="n">msqTerm</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">squared_difference</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="train_seg-1934"><a href="#train_seg-1934"><span class="linenos">1934</span></a>                <span class="n">dicer</span> <span class="o">=</span> <span class="n">binary_dice_loss</span><span class="p">(</span> <span class="n">y_orig</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
</span><span id="train_seg-1935"><a href="#train_seg-1935"><span class="linenos">1935</span></a>                <span class="n">dicer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span> <span class="n">dicer</span> <span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="train_seg-1936"><a href="#train_seg-1936"><span class="linenos">1936</span></a>                <span class="nb">print</span><span class="p">(</span> <span class="n">myofn</span> <span class="o">+</span> <span class="s2">&quot; : &quot;</span> <span class="o">+</span> <span class="s2">&quot;PSNR Lin: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span> <span class="n">myssimBI</span> <span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; SR: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span> <span class="n">myssimSR</span> <span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; MSQ: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">msqTerm</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; DICE: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">dicer</span><span class="p">),</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span>  <span class="p">)</span>
</span><span id="train_seg-1937"><a href="#train_seg-1937"><span class="linenos">1937</span></a>                <span class="n">training_path</span><span class="p">[</span><span class="n">myrs</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">myssimSR</span> <span class="c1"># psnr</span>
</span><span id="train_seg-1938"><a href="#train_seg-1938"><span class="linenos">1938</span></a>                <span class="n">training_path</span><span class="p">[</span><span class="n">myrs</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="n">myssimBI</span> <span class="c1"># psnrlin</span>
</span><span id="train_seg-1939"><a href="#train_seg-1939"><span class="linenos">1939</span></a>                <span class="n">training_path</span><span class="p">[</span><span class="n">myrs</span><span class="p">,</span><span class="mi">5</span><span class="p">]</span><span class="o">=</span><span class="n">msqTerm</span> <span class="c1"># msq</span>
</span><span id="train_seg-1940"><a href="#train_seg-1940"><span class="linenos">1940</span></a>                <span class="n">training_path</span><span class="p">[</span><span class="n">myrs</span><span class="p">,</span><span class="mi">6</span><span class="p">]</span><span class="o">=</span><span class="n">dicer</span> <span class="c1"># dice</span>
</span><span id="train_seg-1941"><a href="#train_seg-1941"><span class="linenos">1941</span></a>                <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">training_path</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">colnames</span> <span class="p">)</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span> <span class="n">output_prefix</span> <span class="o">+</span> <span class="s2">&quot;_training.csv&quot;</span> <span class="p">)</span>
</span><span id="train_seg-1942"><a href="#train_seg-1942"><span class="linenos">1942</span></a>    <span class="n">training_path</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">training_path</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">colnames</span> <span class="p">)</span>
</span><span id="train_seg-1943"><a href="#train_seg-1943"><span class="linenos">1943</span></a>    <span class="k">return</span> <span class="n">training_path</span>
</span></pre></div>


            <div class="docstring"><p>Orchestrates training for a multi-task image and segmentation SR model.</p>

<p>This function extends the <code><a href="#train">train</a></code> function to handle models that predict
both a super-resolved image and a super-resolved segmentation mask. It uses
a four-component composite loss: MSE (for image), a perceptual loss (for
image), Total Variation (for image), and Dice loss (for segmentation).</p>

<h2 id="parameters">Parameters</h2>

<p>mdl : tf.keras.Model
    The 2-channel Keras model to be trained.
filenames_train : list of str
    List of file paths for the training dataset.
filenames_test : list of str
    List of file paths for the validation/testing dataset.
target_patch_size : tuple or list
    The dimensions of the high-resolution target patches.
target_patch_size_low : tuple or list
    The dimensions of the low-resolution input patches.
output_prefix : str
    A prefix for all output files.
n_test : int, optional
    Number of validation patches for evaluation. Default is 8.
learning_rate : float, optional
    Learning rate for the Adam optimizer. Default is 5e-5.
feature_layer : int, optional
    Layer from the feature extractor for perceptual loss. Default is 6.
feature : float, optional
    Relative weight of the perceptual loss term. Default is 2.0.
tv : float, optional
    Relative weight of the Total Variation regularization term. Default is 0.1.
dice : float, optional
    Relative weight of the Dice loss term for the segmentation mask.
    Default is 0.5.
max_iterations : int, optional
    Total number of training iterations. Default is 1000.
batch_size : int, optional
    The batch size for training. Default is 1.
save_all_best : bool, optional
    If True, saves all models that improve validation loss. Default is False.
feature_type : str, optional
    Type of feature extractor for perceptual loss. Default is 'grader'.
check_eval_data_iteration : int, optional
    Frequency (in iterations) for running validation. Default is 20.
verbose : bool, optional
    If True, prints detailed progress information. Default is False.</p>

<h2 id="returns">Returns</h2>

<p>pd.DataFrame
    A DataFrame containing the training history, including columns for losses
    and evaluation metrics like PSNR and Dice score.</p>

<h2 id="see-also">See Also</h2>

<p>train : The training function for single-task (intensity-only) models.</p>
</div>


                </section>
                <section id="read_srmodel">
                            <input id="read_srmodel-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">read_srmodel</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">srfilename</span>, </span><span class="param"><span class="n">custom_objects</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="read_srmodel-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#read_srmodel"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="read_srmodel-1946"><a href="#read_srmodel-1946"><span class="linenos">1946</span></a><span class="k">def</span> <span class="nf">read_srmodel</span><span class="p">(</span><span class="n">srfilename</span><span class="p">,</span> <span class="n">custom_objects</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="read_srmodel-1947"><a href="#read_srmodel-1947"><span class="linenos">1947</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="read_srmodel-1948"><a href="#read_srmodel-1948"><span class="linenos">1948</span></a><span class="sd">    Load a super-resolution model (h5, .keras, or SavedModel format),</span>
</span><span id="read_srmodel-1949"><a href="#read_srmodel-1949"><span class="linenos">1949</span></a><span class="sd">    and determine its upsampling factor.</span>
</span><span id="read_srmodel-1950"><a href="#read_srmodel-1950"><span class="linenos">1950</span></a>
</span><span id="read_srmodel-1951"><a href="#read_srmodel-1951"><span class="linenos">1951</span></a><span class="sd">    Parameters</span>
</span><span id="read_srmodel-1952"><a href="#read_srmodel-1952"><span class="linenos">1952</span></a><span class="sd">    ----------</span>
</span><span id="read_srmodel-1953"><a href="#read_srmodel-1953"><span class="linenos">1953</span></a><span class="sd">    srfilename : str</span>
</span><span id="read_srmodel-1954"><a href="#read_srmodel-1954"><span class="linenos">1954</span></a><span class="sd">        Path to the model file (.h5, .keras, or a SavedModel folder).</span>
</span><span id="read_srmodel-1955"><a href="#read_srmodel-1955"><span class="linenos">1955</span></a><span class="sd">    custom_objects : dict, optional</span>
</span><span id="read_srmodel-1956"><a href="#read_srmodel-1956"><span class="linenos">1956</span></a><span class="sd">        Dictionary of custom objects used in the model (e.g. {&#39;TFOpLambda&#39;: tf.keras.layers.Lambda(...)})</span>
</span><span id="read_srmodel-1957"><a href="#read_srmodel-1957"><span class="linenos">1957</span></a>
</span><span id="read_srmodel-1958"><a href="#read_srmodel-1958"><span class="linenos">1958</span></a><span class="sd">    Returns</span>
</span><span id="read_srmodel-1959"><a href="#read_srmodel-1959"><span class="linenos">1959</span></a><span class="sd">    -------</span>
</span><span id="read_srmodel-1960"><a href="#read_srmodel-1960"><span class="linenos">1960</span></a><span class="sd">    model : tf.keras.Model</span>
</span><span id="read_srmodel-1961"><a href="#read_srmodel-1961"><span class="linenos">1961</span></a><span class="sd">        The loaded model.</span>
</span><span id="read_srmodel-1962"><a href="#read_srmodel-1962"><span class="linenos">1962</span></a><span class="sd">    upsampling_factor : list of int</span>
</span><span id="read_srmodel-1963"><a href="#read_srmodel-1963"><span class="linenos">1963</span></a><span class="sd">        List describing the upsampling factor:</span>
</span><span id="read_srmodel-1964"><a href="#read_srmodel-1964"><span class="linenos">1964</span></a><span class="sd">        - For 3D input: [x_up, y_up, z_up, channels]</span>
</span><span id="read_srmodel-1965"><a href="#read_srmodel-1965"><span class="linenos">1965</span></a><span class="sd">        - For 2D input: [x_up, y_up, channels]</span>
</span><span id="read_srmodel-1966"><a href="#read_srmodel-1966"><span class="linenos">1966</span></a>
</span><span id="read_srmodel-1967"><a href="#read_srmodel-1967"><span class="linenos">1967</span></a><span class="sd">    Example</span>
</span><span id="read_srmodel-1968"><a href="#read_srmodel-1968"><span class="linenos">1968</span></a><span class="sd">    -------</span>
</span><span id="read_srmodel-1969"><a href="#read_srmodel-1969"><span class="linenos">1969</span></a><span class="sd">    &gt;&gt;&gt; mdl, up = read_srmodel(&quot;mymodel.keras&quot;)</span>
</span><span id="read_srmodel-1970"><a href="#read_srmodel-1970"><span class="linenos">1970</span></a><span class="sd">    &gt;&gt;&gt; mdl, up = read_srmodel(&quot;my_weights.h5&quot;, custom_objects={&quot;TFOpLambda&quot;: tf.keras.layers.Lambda(tf.identity)})</span>
</span><span id="read_srmodel-1971"><a href="#read_srmodel-1971"><span class="linenos">1971</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="read_srmodel-1972"><a href="#read_srmodel-1972"><span class="linenos">1972</span></a>
</span><span id="read_srmodel-1973"><a href="#read_srmodel-1973"><span class="linenos">1973</span></a>    <span class="c1"># Expand path and detect format</span>
</span><span id="read_srmodel-1974"><a href="#read_srmodel-1974"><span class="linenos">1974</span></a>    <span class="n">srfilename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">srfilename</span><span class="p">)</span>
</span><span id="read_srmodel-1975"><a href="#read_srmodel-1975"><span class="linenos">1975</span></a>    <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">srfilename</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="read_srmodel-1976"><a href="#read_srmodel-1976"><span class="linenos">1976</span></a>
</span><span id="read_srmodel-1977"><a href="#read_srmodel-1977"><span class="linenos">1977</span></a>    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">srfilename</span><span class="p">):</span>
</span><span id="read_srmodel-1978"><a href="#read_srmodel-1978"><span class="linenos">1978</span></a>        <span class="c1"># SavedModel directory</span>
</span><span id="read_srmodel-1979"><a href="#read_srmodel-1979"><span class="linenos">1979</span></a>        <span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="n">srfilename</span><span class="p">,</span> <span class="n">custom_objects</span><span class="o">=</span><span class="n">custom_objects</span><span class="p">,</span> <span class="nb">compile</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="read_srmodel-1980"><a href="#read_srmodel-1980"><span class="linenos">1980</span></a>    <span class="k">elif</span> <span class="n">ext</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;.h5&#39;</span><span class="p">,</span> <span class="s1">&#39;.keras&#39;</span><span class="p">]:</span>
</span><span id="read_srmodel-1981"><a href="#read_srmodel-1981"><span class="linenos">1981</span></a>        <span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="n">srfilename</span><span class="p">,</span> <span class="n">custom_objects</span><span class="o">=</span><span class="n">custom_objects</span><span class="p">,</span> <span class="nb">compile</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="read_srmodel-1982"><a href="#read_srmodel-1982"><span class="linenos">1982</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="read_srmodel-1983"><a href="#read_srmodel-1983"><span class="linenos">1983</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported model format: </span><span class="si">{</span><span class="n">ext</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="read_srmodel-1984"><a href="#read_srmodel-1984"><span class="linenos">1984</span></a>
</span><span id="read_srmodel-1985"><a href="#read_srmodel-1985"><span class="linenos">1985</span></a>    <span class="c1"># Determine channel index</span>
</span><span id="read_srmodel-1986"><a href="#read_srmodel-1986"><span class="linenos">1986</span></a>    <span class="n">input_shape</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">input_shape</span>
</span><span id="read_srmodel-1987"><a href="#read_srmodel-1987"><span class="linenos">1987</span></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">input_shape</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="read_srmodel-1988"><a href="#read_srmodel-1988"><span class="linenos">1988</span></a>        <span class="n">input_shape</span> <span class="o">=</span> <span class="n">input_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="read_srmodel-1989"><a href="#read_srmodel-1989"><span class="linenos">1989</span></a>    <span class="n">chanindex</span> <span class="o">=</span> <span class="mi">3</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span> <span class="k">else</span> <span class="mi">4</span>
</span><span id="read_srmodel-1990"><a href="#read_srmodel-1990"><span class="linenos">1990</span></a>    <span class="n">nchan</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">input_shape</span><span class="p">[</span><span class="n">chanindex</span><span class="p">])</span>
</span><span id="read_srmodel-1991"><a href="#read_srmodel-1991"><span class="linenos">1991</span></a>
</span><span id="read_srmodel-1992"><a href="#read_srmodel-1992"><span class="linenos">1992</span></a>    <span class="c1"># Run dummy input to compute upsampling factor</span>
</span><span id="read_srmodel-1993"><a href="#read_srmodel-1993"><span class="linenos">1993</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="read_srmodel-1994"><a href="#read_srmodel-1994"><span class="linenos">1994</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>  <span class="c1"># 3D</span>
</span><span id="read_srmodel-1995"><a href="#read_srmodel-1995"><span class="linenos">1995</span></a>            <span class="n">dummy_input</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">nchan</span><span class="p">])</span>
</span><span id="read_srmodel-1996"><a href="#read_srmodel-1996"><span class="linenos">1996</span></a>        <span class="k">else</span><span class="p">:</span>  <span class="c1"># 2D</span>
</span><span id="read_srmodel-1997"><a href="#read_srmodel-1997"><span class="linenos">1997</span></a>            <span class="n">dummy_input</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">nchan</span><span class="p">])</span>
</span><span id="read_srmodel-1998"><a href="#read_srmodel-1998"><span class="linenos">1998</span></a>
</span><span id="read_srmodel-1999"><a href="#read_srmodel-1999"><span class="linenos">1999</span></a>        <span class="c1"># Handle named inputs if necessary</span>
</span><span id="read_srmodel-2000"><a href="#read_srmodel-2000"><span class="linenos">2000</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="read_srmodel-2001"><a href="#read_srmodel-2001"><span class="linenos">2001</span></a>            <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">dummy_input</span><span class="p">)</span>
</span><span id="read_srmodel-2002"><a href="#read_srmodel-2002"><span class="linenos">2002</span></a>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="read_srmodel-2003"><a href="#read_srmodel-2003"><span class="linenos">2003</span></a>            <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">({</span><span class="n">model</span><span class="o">.</span><span class="n">input_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">dummy_input</span><span class="p">})</span>
</span><span id="read_srmodel-2004"><a href="#read_srmodel-2004"><span class="linenos">2004</span></a>
</span><span id="read_srmodel-2005"><a href="#read_srmodel-2005"><span class="linenos">2005</span></a>        <span class="n">outshp</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">shape</span>
</span><span id="read_srmodel-2006"><a href="#read_srmodel-2006"><span class="linenos">2006</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
</span><span id="read_srmodel-2007"><a href="#read_srmodel-2007"><span class="linenos">2007</span></a>            <span class="k">return</span> <span class="n">model</span><span class="p">,</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">outshp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">8</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">outshp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="mi">8</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">outshp</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">/</span><span class="mi">8</span><span class="p">),</span> <span class="n">nchan</span><span class="p">]</span>
</span><span id="read_srmodel-2008"><a href="#read_srmodel-2008"><span class="linenos">2008</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="read_srmodel-2009"><a href="#read_srmodel-2009"><span class="linenos">2009</span></a>            <span class="k">return</span> <span class="n">model</span><span class="p">,</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">outshp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">8</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">outshp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="mi">8</span><span class="p">),</span> <span class="n">nchan</span><span class="p">]</span>
</span><span id="read_srmodel-2010"><a href="#read_srmodel-2010"><span class="linenos">2010</span></a>
</span><span id="read_srmodel-2011"><a href="#read_srmodel-2011"><span class="linenos">2011</span></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="read_srmodel-2012"><a href="#read_srmodel-2012"><span class="linenos">2012</span></a>        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not infer upsampling factor. Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Load a super-resolution model (h5, .keras, or SavedModel format),
and determine its upsampling factor.</p>

<h2 id="parameters">Parameters</h2>

<p>srfilename : str
    Path to the model file (.h5, .keras, or a SavedModel folder).
custom_objects : dict, optional
    Dictionary of custom objects used in the model (e.g. {'TFOpLambda': tf.keras.layers.Lambda(...)})</p>

<h2 id="returns">Returns</h2>

<p>model : tf.keras.Model
    The loaded model.
upsampling_factor : list of int
    List describing the upsampling factor:
    - For 3D input: [x_up, y_up, z_up, channels]
    - For 2D input: [x_up, y_up, channels]</p>

<h2 id="example">Example</h2>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">mdl</span><span class="p">,</span> <span class="n">up</span> <span class="o">=</span> <span class="n">read_srmodel</span><span class="p">(</span><span class="s2">&quot;mymodel.keras&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">mdl</span><span class="p">,</span> <span class="n">up</span> <span class="o">=</span> <span class="n">read_srmodel</span><span class="p">(</span><span class="s2">&quot;my_weights.h5&quot;</span><span class="p">,</span> <span class="n">custom_objects</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;TFOpLambda&quot;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Lambda</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">identity</span><span class="p">)})</span>
</code></pre>
</div>
</div>


                </section>
                <section id="simulate_image">
                            <input id="simulate_image-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">simulate_image</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">shaper</span><span class="o">=</span><span class="p">[</span><span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">]</span>, </span><span class="param"><span class="n">n_levels</span><span class="o">=</span><span class="mi">10</span>, </span><span class="param"><span class="n">multiply</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="simulate_image-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#simulate_image"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="simulate_image-2015"><a href="#simulate_image-2015"><span class="linenos">2015</span></a><span class="k">def</span> <span class="nf">simulate_image</span><span class="p">(</span> <span class="n">shaper</span><span class="o">=</span><span class="p">[</span><span class="mi">32</span><span class="p">,</span><span class="mi">32</span><span class="p">,</span><span class="mi">32</span><span class="p">],</span> <span class="n">n_levels</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">multiply</span><span class="o">=</span><span class="kc">False</span> <span class="p">):</span>
</span><span id="simulate_image-2016"><a href="#simulate_image-2016"><span class="linenos">2016</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="simulate_image-2017"><a href="#simulate_image-2017"><span class="linenos">2017</span></a><span class="sd">    generate an image of given shape and number of levels</span>
</span><span id="simulate_image-2018"><a href="#simulate_image-2018"><span class="linenos">2018</span></a>
</span><span id="simulate_image-2019"><a href="#simulate_image-2019"><span class="linenos">2019</span></a><span class="sd">    Arguments</span>
</span><span id="simulate_image-2020"><a href="#simulate_image-2020"><span class="linenos">2020</span></a><span class="sd">    ---------</span>
</span><span id="simulate_image-2021"><a href="#simulate_image-2021"><span class="linenos">2021</span></a><span class="sd">    shaper : [x,y,z] or [x,y]</span>
</span><span id="simulate_image-2022"><a href="#simulate_image-2022"><span class="linenos">2022</span></a>
</span><span id="simulate_image-2023"><a href="#simulate_image-2023"><span class="linenos">2023</span></a><span class="sd">    n_levels : int</span>
</span><span id="simulate_image-2024"><a href="#simulate_image-2024"><span class="linenos">2024</span></a>
</span><span id="simulate_image-2025"><a href="#simulate_image-2025"><span class="linenos">2025</span></a><span class="sd">    multiply : boolean</span>
</span><span id="simulate_image-2026"><a href="#simulate_image-2026"><span class="linenos">2026</span></a>
</span><span id="simulate_image-2027"><a href="#simulate_image-2027"><span class="linenos">2027</span></a><span class="sd">    Returns</span>
</span><span id="simulate_image-2028"><a href="#simulate_image-2028"><span class="linenos">2028</span></a><span class="sd">    -------</span>
</span><span id="simulate_image-2029"><a href="#simulate_image-2029"><span class="linenos">2029</span></a>
</span><span id="simulate_image-2030"><a href="#simulate_image-2030"><span class="linenos">2030</span></a><span class="sd">    ants.image</span>
</span><span id="simulate_image-2031"><a href="#simulate_image-2031"><span class="linenos">2031</span></a>
</span><span id="simulate_image-2032"><a href="#simulate_image-2032"><span class="linenos">2032</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="simulate_image-2033"><a href="#simulate_image-2033"><span class="linenos">2033</span></a>    <span class="n">img</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">shaper</span> <span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="mi">0</span>
</span><span id="simulate_image-2034"><a href="#simulate_image-2034"><span class="linenos">2034</span></a>    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_levels</span><span class="p">):</span>
</span><span id="simulate_image-2035"><a href="#simulate_image-2035"><span class="linenos">2035</span></a>        <span class="n">temp</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">shaper</span> <span class="p">)</span> <span class="p">)</span>
</span><span id="simulate_image-2036"><a href="#simulate_image-2036"><span class="linenos">2036</span></a>        <span class="n">temp</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">smooth_image</span><span class="p">(</span> <span class="n">temp</span><span class="p">,</span> <span class="n">n_levels</span> <span class="p">)</span>
</span><span id="simulate_image-2037"><a href="#simulate_image-2037"><span class="linenos">2037</span></a>        <span class="n">temp</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">threshold_image</span><span class="p">(</span> <span class="n">temp</span><span class="p">,</span> <span class="s2">&quot;Otsu&quot;</span><span class="p">,</span> <span class="mi">1</span> <span class="p">)</span>
</span><span id="simulate_image-2038"><a href="#simulate_image-2038"><span class="linenos">2038</span></a>        <span class="k">if</span> <span class="n">multiply</span><span class="p">:</span>
</span><span id="simulate_image-2039"><a href="#simulate_image-2039"><span class="linenos">2039</span></a>            <span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span> <span class="o">*</span> <span class="n">k</span>
</span><span id="simulate_image-2040"><a href="#simulate_image-2040"><span class="linenos">2040</span></a>        <span class="n">img</span> <span class="o">=</span> <span class="n">img</span> <span class="o">+</span> <span class="n">temp</span>
</span><span id="simulate_image-2041"><a href="#simulate_image-2041"><span class="linenos">2041</span></a>    <span class="k">return</span> <span class="n">img</span>
</span></pre></div>


            <div class="docstring"><p>generate an image of given shape and number of levels</p>

<h2 id="arguments">Arguments</h2>

<p>shaper : [x,y,z] or [x,y]</p>

<p>n_levels : int</p>

<p>multiply : boolean</p>

<h2 id="returns">Returns</h2>

<p>ants.image</p>
</div>


                </section>
                <section id="optimize_upsampling_shape">
                            <input id="optimize_upsampling_shape-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">optimize_upsampling_shape</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">spacing</span>, </span><span class="param"><span class="n">modality</span><span class="o">=</span><span class="s1">&#39;T1&#39;</span>, </span><span class="param"><span class="n">roundit</span><span class="o">=</span><span class="kc">False</span>, </span><span class="param"><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="optimize_upsampling_shape-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#optimize_upsampling_shape"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="optimize_upsampling_shape-2044"><a href="#optimize_upsampling_shape-2044"><span class="linenos">2044</span></a><span class="k">def</span> <span class="nf">optimize_upsampling_shape</span><span class="p">(</span> <span class="n">spacing</span><span class="p">,</span> <span class="n">modality</span><span class="o">=</span><span class="s1">&#39;T1&#39;</span><span class="p">,</span> <span class="n">roundit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span> <span class="p">):</span>
</span><span id="optimize_upsampling_shape-2045"><a href="#optimize_upsampling_shape-2045"><span class="linenos">2045</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="optimize_upsampling_shape-2046"><a href="#optimize_upsampling_shape-2046"><span class="linenos">2046</span></a><span class="sd">    Compute the optimal upsampling shape string (e.g., &#39;2x2x2&#39;) based on image voxel spacing</span>
</span><span id="optimize_upsampling_shape-2047"><a href="#optimize_upsampling_shape-2047"><span class="linenos">2047</span></a><span class="sd">    and imaging modality. This output is used to select an appropriate pretrained </span>
</span><span id="optimize_upsampling_shape-2048"><a href="#optimize_upsampling_shape-2048"><span class="linenos">2048</span></a><span class="sd">    super-resolution model filename.</span>
</span><span id="optimize_upsampling_shape-2049"><a href="#optimize_upsampling_shape-2049"><span class="linenos">2049</span></a>
</span><span id="optimize_upsampling_shape-2050"><a href="#optimize_upsampling_shape-2050"><span class="linenos">2050</span></a><span class="sd">    Parameters</span>
</span><span id="optimize_upsampling_shape-2051"><a href="#optimize_upsampling_shape-2051"><span class="linenos">2051</span></a><span class="sd">    ----------</span>
</span><span id="optimize_upsampling_shape-2052"><a href="#optimize_upsampling_shape-2052"><span class="linenos">2052</span></a><span class="sd">    spacing : sequence of float</span>
</span><span id="optimize_upsampling_shape-2053"><a href="#optimize_upsampling_shape-2053"><span class="linenos">2053</span></a><span class="sd">        Voxel spacing (physical size per voxel in mm) from the input image.</span>
</span><span id="optimize_upsampling_shape-2054"><a href="#optimize_upsampling_shape-2054"><span class="linenos">2054</span></a><span class="sd">        Typically obtained from `ants.get_spacing(image)`.</span>
</span><span id="optimize_upsampling_shape-2055"><a href="#optimize_upsampling_shape-2055"><span class="linenos">2055</span></a>
</span><span id="optimize_upsampling_shape-2056"><a href="#optimize_upsampling_shape-2056"><span class="linenos">2056</span></a><span class="sd">    modality : str, optional</span>
</span><span id="optimize_upsampling_shape-2057"><a href="#optimize_upsampling_shape-2057"><span class="linenos">2057</span></a><span class="sd">        Imaging modality. Affects resolution thresholds:</span>
</span><span id="optimize_upsampling_shape-2058"><a href="#optimize_upsampling_shape-2058"><span class="linenos">2058</span></a><span class="sd">        - &#39;T1&#39; : anatomical MRI (default minimum spacing: 0.35 mm)</span>
</span><span id="optimize_upsampling_shape-2059"><a href="#optimize_upsampling_shape-2059"><span class="linenos">2059</span></a><span class="sd">        - &#39;DTI&#39; : diffusion MRI (default minimum spacing: 1.0 mm)</span>
</span><span id="optimize_upsampling_shape-2060"><a href="#optimize_upsampling_shape-2060"><span class="linenos">2060</span></a><span class="sd">        - &#39;NM&#39; : nuclear medicine (e.g., PET/SPECT, minimum spacing: 0.25 mm)</span>
</span><span id="optimize_upsampling_shape-2061"><a href="#optimize_upsampling_shape-2061"><span class="linenos">2061</span></a>
</span><span id="optimize_upsampling_shape-2062"><a href="#optimize_upsampling_shape-2062"><span class="linenos">2062</span></a><span class="sd">    roundit : bool, optional</span>
</span><span id="optimize_upsampling_shape-2063"><a href="#optimize_upsampling_shape-2063"><span class="linenos">2063</span></a><span class="sd">        If True, uses rounded integer ratios for the upsampling shape.</span>
</span><span id="optimize_upsampling_shape-2064"><a href="#optimize_upsampling_shape-2064"><span class="linenos">2064</span></a><span class="sd">        Otherwise, uses floor division with constraints.</span>
</span><span id="optimize_upsampling_shape-2065"><a href="#optimize_upsampling_shape-2065"><span class="linenos">2065</span></a>
</span><span id="optimize_upsampling_shape-2066"><a href="#optimize_upsampling_shape-2066"><span class="linenos">2066</span></a><span class="sd">    verbose : bool, optional</span>
</span><span id="optimize_upsampling_shape-2067"><a href="#optimize_upsampling_shape-2067"><span class="linenos">2067</span></a><span class="sd">        If True, prints detailed internal values and logic.</span>
</span><span id="optimize_upsampling_shape-2068"><a href="#optimize_upsampling_shape-2068"><span class="linenos">2068</span></a>
</span><span id="optimize_upsampling_shape-2069"><a href="#optimize_upsampling_shape-2069"><span class="linenos">2069</span></a><span class="sd">    Returns</span>
</span><span id="optimize_upsampling_shape-2070"><a href="#optimize_upsampling_shape-2070"><span class="linenos">2070</span></a><span class="sd">    -------</span>
</span><span id="optimize_upsampling_shape-2071"><a href="#optimize_upsampling_shape-2071"><span class="linenos">2071</span></a><span class="sd">    str</span>
</span><span id="optimize_upsampling_shape-2072"><a href="#optimize_upsampling_shape-2072"><span class="linenos">2072</span></a><span class="sd">        Optimal upsampling shape string in the form &#39;AxBxC&#39;,</span>
</span><span id="optimize_upsampling_shape-2073"><a href="#optimize_upsampling_shape-2073"><span class="linenos">2073</span></a><span class="sd">        e.g., &#39;2x2x2&#39;, &#39;4x4x2&#39;.</span>
</span><span id="optimize_upsampling_shape-2074"><a href="#optimize_upsampling_shape-2074"><span class="linenos">2074</span></a>
</span><span id="optimize_upsampling_shape-2075"><a href="#optimize_upsampling_shape-2075"><span class="linenos">2075</span></a><span class="sd">    Notes</span>
</span><span id="optimize_upsampling_shape-2076"><a href="#optimize_upsampling_shape-2076"><span class="linenos">2076</span></a><span class="sd">    -----</span>
</span><span id="optimize_upsampling_shape-2077"><a href="#optimize_upsampling_shape-2077"><span class="linenos">2077</span></a><span class="sd">    - The function prevents upsampling ratios that would result in &#39;1x1x1&#39;</span>
</span><span id="optimize_upsampling_shape-2078"><a href="#optimize_upsampling_shape-2078"><span class="linenos">2078</span></a><span class="sd">      by defaulting to &#39;2x2x2&#39;.</span>
</span><span id="optimize_upsampling_shape-2079"><a href="#optimize_upsampling_shape-2079"><span class="linenos">2079</span></a><span class="sd">    - It also avoids uncommon ratios like &#39;5&#39; by rounding to the nearest valid option.</span>
</span><span id="optimize_upsampling_shape-2080"><a href="#optimize_upsampling_shape-2080"><span class="linenos">2080</span></a><span class="sd">    - The returned string is commonly used to populate a model filename template:</span>
</span><span id="optimize_upsampling_shape-2081"><a href="#optimize_upsampling_shape-2081"><span class="linenos">2081</span></a><span class="sd">      </span>
</span><span id="optimize_upsampling_shape-2082"><a href="#optimize_upsampling_shape-2082"><span class="linenos">2082</span></a><span class="sd">      Example:</span>
</span><span id="optimize_upsampling_shape-2083"><a href="#optimize_upsampling_shape-2083"><span class="linenos">2083</span></a><span class="sd">          &gt;&gt;&gt; bestup = optimize_upsampling_shape(ants.get_spacing(t1_img), modality=&#39;T1&#39;)</span>
</span><span id="optimize_upsampling_shape-2084"><a href="#optimize_upsampling_shape-2084"><span class="linenos">2084</span></a><span class="sd">          &gt;&gt;&gt; model = re.sub(&#39;bestup&#39;, bestup, &#39;siq_smallshort_train_bestup_1chan.keras&#39;)</span>
</span><span id="optimize_upsampling_shape-2085"><a href="#optimize_upsampling_shape-2085"><span class="linenos">2085</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="optimize_upsampling_shape-2086"><a href="#optimize_upsampling_shape-2086"><span class="linenos">2086</span></a>    <span class="n">minspc</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span> <span class="nb">list</span><span class="p">(</span> <span class="n">spacing</span> <span class="p">)</span> <span class="p">)</span>
</span><span id="optimize_upsampling_shape-2087"><a href="#optimize_upsampling_shape-2087"><span class="linenos">2087</span></a>    <span class="n">maxspc</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span> <span class="nb">list</span><span class="p">(</span> <span class="n">spacing</span> <span class="p">)</span> <span class="p">)</span>
</span><span id="optimize_upsampling_shape-2088"><a href="#optimize_upsampling_shape-2088"><span class="linenos">2088</span></a>    <span class="n">ratio</span> <span class="o">=</span> <span class="n">maxspc</span><span class="o">/</span><span class="n">minspc</span>
</span><span id="optimize_upsampling_shape-2089"><a href="#optimize_upsampling_shape-2089"><span class="linenos">2089</span></a>    <span class="k">if</span> <span class="n">ratio</span> <span class="o">==</span> <span class="mf">1.0</span><span class="p">:</span>
</span><span id="optimize_upsampling_shape-2090"><a href="#optimize_upsampling_shape-2090"><span class="linenos">2090</span></a>        <span class="n">ratio</span> <span class="o">=</span> <span class="mf">0.5</span>
</span><span id="optimize_upsampling_shape-2091"><a href="#optimize_upsampling_shape-2091"><span class="linenos">2091</span></a>    <span class="n">roundratio</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span> <span class="n">ratio</span> <span class="p">)</span>
</span><span id="optimize_upsampling_shape-2092"><a href="#optimize_upsampling_shape-2092"><span class="linenos">2092</span></a>    <span class="n">tarshaperaw</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="optimize_upsampling_shape-2093"><a href="#optimize_upsampling_shape-2093"><span class="linenos">2093</span></a>    <span class="n">tarshape</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="optimize_upsampling_shape-2094"><a href="#optimize_upsampling_shape-2094"><span class="linenos">2094</span></a>    <span class="n">tarshaperound</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="optimize_upsampling_shape-2095"><a href="#optimize_upsampling_shape-2095"><span class="linenos">2095</span></a>    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">spacing</span> <span class="p">)</span> <span class="p">):</span>
</span><span id="optimize_upsampling_shape-2096"><a href="#optimize_upsampling_shape-2096"><span class="linenos">2096</span></a>        <span class="n">locrat</span> <span class="o">=</span> <span class="n">spacing</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">/</span><span class="n">minspc</span>
</span><span id="optimize_upsampling_shape-2097"><a href="#optimize_upsampling_shape-2097"><span class="linenos">2097</span></a>        <span class="n">newspc</span> <span class="o">=</span> <span class="n">spacing</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">roundratio</span>
</span><span id="optimize_upsampling_shape-2098"><a href="#optimize_upsampling_shape-2098"><span class="linenos">2098</span></a>        <span class="n">tarshaperaw</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">locrat</span> <span class="p">)</span>
</span><span id="optimize_upsampling_shape-2099"><a href="#optimize_upsampling_shape-2099"><span class="linenos">2099</span></a>        <span class="k">if</span> <span class="n">modality</span> <span class="o">==</span> <span class="s2">&quot;NM&quot;</span><span class="p">:</span>
</span><span id="optimize_upsampling_shape-2100"><a href="#optimize_upsampling_shape-2100"><span class="linenos">2100</span></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="optimize_upsampling_shape-2101"><a href="#optimize_upsampling_shape-2101"><span class="linenos">2101</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using minspacing: 0.25&quot;</span><span class="p">)</span>
</span><span id="optimize_upsampling_shape-2102"><a href="#optimize_upsampling_shape-2102"><span class="linenos">2102</span></a>            <span class="k">if</span> <span class="n">newspc</span> <span class="o">&lt;</span> <span class="mf">0.25</span> <span class="p">:</span>
</span><span id="optimize_upsampling_shape-2103"><a href="#optimize_upsampling_shape-2103"><span class="linenos">2103</span></a>                <span class="n">locrat</span> <span class="o">=</span> <span class="n">spacing</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">/</span><span class="mf">0.25</span>
</span><span id="optimize_upsampling_shape-2104"><a href="#optimize_upsampling_shape-2104"><span class="linenos">2104</span></a>        <span class="k">elif</span> <span class="n">modality</span> <span class="o">==</span> <span class="s2">&quot;DTI&quot;</span><span class="p">:</span>
</span><span id="optimize_upsampling_shape-2105"><a href="#optimize_upsampling_shape-2105"><span class="linenos">2105</span></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="optimize_upsampling_shape-2106"><a href="#optimize_upsampling_shape-2106"><span class="linenos">2106</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using minspacing: 1.0&quot;</span><span class="p">)</span>
</span><span id="optimize_upsampling_shape-2107"><a href="#optimize_upsampling_shape-2107"><span class="linenos">2107</span></a>            <span class="k">if</span> <span class="n">newspc</span> <span class="o">&lt;</span> <span class="mf">1.0</span> <span class="p">:</span>
</span><span id="optimize_upsampling_shape-2108"><a href="#optimize_upsampling_shape-2108"><span class="linenos">2108</span></a>                <span class="n">locrat</span> <span class="o">=</span> <span class="n">spacing</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">/</span><span class="mf">1.0</span>
</span><span id="optimize_upsampling_shape-2109"><a href="#optimize_upsampling_shape-2109"><span class="linenos">2109</span></a>        <span class="k">else</span><span class="p">:</span> <span class="c1"># assume T1</span>
</span><span id="optimize_upsampling_shape-2110"><a href="#optimize_upsampling_shape-2110"><span class="linenos">2110</span></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="optimize_upsampling_shape-2111"><a href="#optimize_upsampling_shape-2111"><span class="linenos">2111</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using minspacing: 0.35&quot;</span><span class="p">)</span>
</span><span id="optimize_upsampling_shape-2112"><a href="#optimize_upsampling_shape-2112"><span class="linenos">2112</span></a>            <span class="k">if</span> <span class="n">newspc</span> <span class="o">&lt;</span> <span class="mf">0.35</span> <span class="p">:</span>
</span><span id="optimize_upsampling_shape-2113"><a href="#optimize_upsampling_shape-2113"><span class="linenos">2113</span></a>                <span class="n">locrat</span> <span class="o">=</span> <span class="n">spacing</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">/</span><span class="mf">0.35</span>
</span><span id="optimize_upsampling_shape-2114"><a href="#optimize_upsampling_shape-2114"><span class="linenos">2114</span></a>        <span class="n">myint</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">locrat</span> <span class="p">)</span>
</span><span id="optimize_upsampling_shape-2115"><a href="#optimize_upsampling_shape-2115"><span class="linenos">2115</span></a>        <span class="k">if</span> <span class="p">(</span> <span class="n">myint</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">):</span>
</span><span id="optimize_upsampling_shape-2116"><a href="#optimize_upsampling_shape-2116"><span class="linenos">2116</span></a>            <span class="n">myint</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="optimize_upsampling_shape-2117"><a href="#optimize_upsampling_shape-2117"><span class="linenos">2117</span></a>        <span class="k">if</span> <span class="n">myint</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
</span><span id="optimize_upsampling_shape-2118"><a href="#optimize_upsampling_shape-2118"><span class="linenos">2118</span></a>            <span class="n">myint</span> <span class="o">=</span> <span class="mi">4</span>
</span><span id="optimize_upsampling_shape-2119"><a href="#optimize_upsampling_shape-2119"><span class="linenos">2119</span></a>        <span class="k">if</span> <span class="p">(</span> <span class="n">myint</span> <span class="o">&gt;</span> <span class="mi">6</span> <span class="p">):</span>
</span><span id="optimize_upsampling_shape-2120"><a href="#optimize_upsampling_shape-2120"><span class="linenos">2120</span></a>            <span class="n">myint</span> <span class="o">=</span> <span class="mi">6</span>
</span><span id="optimize_upsampling_shape-2121"><a href="#optimize_upsampling_shape-2121"><span class="linenos">2121</span></a>        <span class="n">tarshape</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="nb">str</span><span class="p">(</span> <span class="n">myint</span> <span class="p">)</span> <span class="p">)</span>
</span><span id="optimize_upsampling_shape-2122"><a href="#optimize_upsampling_shape-2122"><span class="linenos">2122</span></a>        <span class="n">tarshaperound</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="nb">str</span><span class="p">(</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span> <span class="n">locrat</span> <span class="p">))</span> <span class="p">)</span> <span class="p">)</span>
</span><span id="optimize_upsampling_shape-2123"><a href="#optimize_upsampling_shape-2123"><span class="linenos">2123</span></a>    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="optimize_upsampling_shape-2124"><a href="#optimize_upsampling_shape-2124"><span class="linenos">2124</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;before emendation:&quot;</span><span class="p">)</span>
</span><span id="optimize_upsampling_shape-2125"><a href="#optimize_upsampling_shape-2125"><span class="linenos">2125</span></a>        <span class="nb">print</span><span class="p">(</span> <span class="n">tarshaperaw</span> <span class="p">)</span>
</span><span id="optimize_upsampling_shape-2126"><a href="#optimize_upsampling_shape-2126"><span class="linenos">2126</span></a>        <span class="nb">print</span><span class="p">(</span> <span class="n">tarshaperound</span> <span class="p">)</span>
</span><span id="optimize_upsampling_shape-2127"><a href="#optimize_upsampling_shape-2127"><span class="linenos">2127</span></a>        <span class="nb">print</span><span class="p">(</span> <span class="n">tarshape</span> <span class="p">)</span>
</span><span id="optimize_upsampling_shape-2128"><a href="#optimize_upsampling_shape-2128"><span class="linenos">2128</span></a>    <span class="n">allone</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="optimize_upsampling_shape-2129"><a href="#optimize_upsampling_shape-2129"><span class="linenos">2129</span></a>    <span class="k">if</span> <span class="n">roundit</span><span class="p">:</span>
</span><span id="optimize_upsampling_shape-2130"><a href="#optimize_upsampling_shape-2130"><span class="linenos">2130</span></a>        <span class="n">tarshape</span> <span class="o">=</span> <span class="n">tarshaperound</span>
</span><span id="optimize_upsampling_shape-2131"><a href="#optimize_upsampling_shape-2131"><span class="linenos">2131</span></a>    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">tarshape</span> <span class="p">)</span> <span class="p">):</span>
</span><span id="optimize_upsampling_shape-2132"><a href="#optimize_upsampling_shape-2132"><span class="linenos">2132</span></a>        <span class="k">if</span> <span class="n">tarshape</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;1&quot;</span><span class="p">:</span>
</span><span id="optimize_upsampling_shape-2133"><a href="#optimize_upsampling_shape-2133"><span class="linenos">2133</span></a>            <span class="n">allone</span><span class="o">=</span><span class="kc">False</span>
</span><span id="optimize_upsampling_shape-2134"><a href="#optimize_upsampling_shape-2134"><span class="linenos">2134</span></a>    <span class="k">if</span> <span class="n">allone</span><span class="p">:</span>
</span><span id="optimize_upsampling_shape-2135"><a href="#optimize_upsampling_shape-2135"><span class="linenos">2135</span></a>        <span class="n">tarshape</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;2&quot;</span><span class="p">,</span><span class="s2">&quot;2&quot;</span><span class="p">,</span><span class="s2">&quot;2&quot;</span><span class="p">]</span> <span class="c1"># default</span>
</span><span id="optimize_upsampling_shape-2136"><a href="#optimize_upsampling_shape-2136"><span class="linenos">2136</span></a>    <span class="k">return</span> <span class="s2">&quot;x&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tarshape</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Compute the optimal upsampling shape string (e.g., '2x2x2') based on image voxel spacing
and imaging modality. This output is used to select an appropriate pretrained 
super-resolution model filename.</p>

<h2 id="parameters">Parameters</h2>

<p>spacing : sequence of float
    Voxel spacing (physical size per voxel in mm) from the input image.
    Typically obtained from <code>ants.get_spacing(image)</code>.</p>

<p>modality : str, optional
    Imaging modality. Affects resolution thresholds:
    - 'T1' : anatomical MRI (default minimum spacing: 0.35 mm)
    - 'DTI' : diffusion MRI (default minimum spacing: 1.0 mm)
    - 'NM' : nuclear medicine (e.g., PET/SPECT, minimum spacing: 0.25 mm)</p>

<p>roundit : bool, optional
    If True, uses rounded integer ratios for the upsampling shape.
    Otherwise, uses floor division with constraints.</p>

<p>verbose : bool, optional
    If True, prints detailed internal values and logic.</p>

<h2 id="returns">Returns</h2>

<p>str
    Optimal upsampling shape string in the form 'AxBxC',
    e.g., '2x2x2', '4x4x2'.</p>

<h2 id="notes">Notes</h2>

<ul>
<li>The function prevents upsampling ratios that would result in '1x1x1'
by defaulting to '2x2x2'.</li>
<li>It also avoids uncommon ratios like '5' by rounding to the nearest valid option.</li>
<li><p>The returned string is commonly used to populate a model filename template:</p>

<p>Example:</p>

<blockquote>
  <blockquote>
    <blockquote>
      <p>bestup = optimize_upsampling_shape(ants.get_spacing(t1_img), modality='T1')
      model = re.sub('bestup', bestup, 'siq_smallshort_train_bestup_1chan.keras')</p>
    </blockquote>
  </blockquote>
</blockquote></li>
</ul>
</div>


                </section>
                <section id="compare_models">
                            <input id="compare_models-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">compare_models</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">model_filenames</span>,</span><span class="param">	<span class="n">img</span>,</span><span class="param">	<span class="n">n_classes</span><span class="o">=</span><span class="mi">3</span>,</span><span class="param">	<span class="n">poly_order</span><span class="o">=</span><span class="s1">&#39;hist&#39;</span>,</span><span class="param">	<span class="n">identifier</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">noise_sd</span><span class="o">=</span><span class="mf">0.1</span>,</span><span class="param">	<span class="n">verbose</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="compare_models-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#compare_models"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="compare_models-2138"><a href="#compare_models-2138"><span class="linenos">2138</span></a><span class="k">def</span> <span class="nf">compare_models</span><span class="p">(</span> <span class="n">model_filenames</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">n_classes</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
</span><span id="compare_models-2139"><a href="#compare_models-2139"><span class="linenos">2139</span></a>    <span class="n">poly_order</span><span class="o">=</span><span class="s1">&#39;hist&#39;</span><span class="p">,</span>
</span><span id="compare_models-2140"><a href="#compare_models-2140"><span class="linenos">2140</span></a>    <span class="n">identifier</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">noise_sd</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span> <span class="p">):</span>
</span><span id="compare_models-2141"><a href="#compare_models-2141"><span class="linenos">2141</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="compare_models-2142"><a href="#compare_models-2142"><span class="linenos">2142</span></a><span class="sd">    Evaluates and compares the performance of multiple super-resolution models on a given image.</span>
</span><span id="compare_models-2143"><a href="#compare_models-2143"><span class="linenos">2143</span></a>
</span><span id="compare_models-2144"><a href="#compare_models-2144"><span class="linenos">2144</span></a><span class="sd">    This function provides a standardized way to benchmark SR models. For each model,</span>
</span><span id="compare_models-2145"><a href="#compare_models-2145"><span class="linenos">2145</span></a><span class="sd">    it performs the following steps:</span>
</span><span id="compare_models-2146"><a href="#compare_models-2146"><span class="linenos">2146</span></a><span class="sd">    1. Loads the model and determines its upsampling factor.</span>
</span><span id="compare_models-2147"><a href="#compare_models-2147"><span class="linenos">2147</span></a><span class="sd">    2. Downsamples the high-resolution input image (`img`) to create a low-resolution</span>
</span><span id="compare_models-2148"><a href="#compare_models-2148"><span class="linenos">2148</span></a><span class="sd">       input, simulating a real-world scenario.</span>
</span><span id="compare_models-2149"><a href="#compare_models-2149"><span class="linenos">2149</span></a><span class="sd">    3. Adds Gaussian noise to the low-resolution input to test for robustness.</span>
</span><span id="compare_models-2150"><a href="#compare_models-2150"><span class="linenos">2150</span></a><span class="sd">    4. Runs inference using the model to generate a super-resolved output.</span>
</span><span id="compare_models-2151"><a href="#compare_models-2151"><span class="linenos">2151</span></a><span class="sd">    5. Generates a baseline output by upsampling the low-res input with linear interpolation.</span>
</span><span id="compare_models-2152"><a href="#compare_models-2152"><span class="linenos">2152</span></a><span class="sd">    6. Calculates PSNR and SSIM metrics comparing both the model&#39;s output and the</span>
</span><span id="compare_models-2153"><a href="#compare_models-2153"><span class="linenos">2153</span></a><span class="sd">       baseline against the original high-resolution image.</span>
</span><span id="compare_models-2154"><a href="#compare_models-2154"><span class="linenos">2154</span></a><span class="sd">    7. If a dual-channel (image + segmentation) model is detected, it also calculates</span>
</span><span id="compare_models-2155"><a href="#compare_models-2155"><span class="linenos">2155</span></a><span class="sd">       Dice scores for segmentation performance.</span>
</span><span id="compare_models-2156"><a href="#compare_models-2156"><span class="linenos">2156</span></a><span class="sd">    8. Aggregates all results into a pandas DataFrame for easy comparison.</span>
</span><span id="compare_models-2157"><a href="#compare_models-2157"><span class="linenos">2157</span></a>
</span><span id="compare_models-2158"><a href="#compare_models-2158"><span class="linenos">2158</span></a><span class="sd">    Parameters</span>
</span><span id="compare_models-2159"><a href="#compare_models-2159"><span class="linenos">2159</span></a><span class="sd">    ----------</span>
</span><span id="compare_models-2160"><a href="#compare_models-2160"><span class="linenos">2160</span></a><span class="sd">    model_filenames : list of str</span>
</span><span id="compare_models-2161"><a href="#compare_models-2161"><span class="linenos">2161</span></a><span class="sd">        A list of file paths to the Keras models (.h5, .keras) to be compared.</span>
</span><span id="compare_models-2162"><a href="#compare_models-2162"><span class="linenos">2162</span></a><span class="sd">    img : ants.ANTsImage</span>
</span><span id="compare_models-2163"><a href="#compare_models-2163"><span class="linenos">2163</span></a><span class="sd">        The high-resolution ground truth image. This image will be downsampled to</span>
</span><span id="compare_models-2164"><a href="#compare_models-2164"><span class="linenos">2164</span></a><span class="sd">        create the input for the models.</span>
</span><span id="compare_models-2165"><a href="#compare_models-2165"><span class="linenos">2165</span></a><span class="sd">    n_classes : int, optional</span>
</span><span id="compare_models-2166"><a href="#compare_models-2166"><span class="linenos">2166</span></a><span class="sd">        The number of classes for Otsu&#39;s thresholding when auto-generating a</span>
</span><span id="compare_models-2167"><a href="#compare_models-2167"><span class="linenos">2167</span></a><span class="sd">        segmentation for evaluating dual-channel models. Default is 3.</span>
</span><span id="compare_models-2168"><a href="#compare_models-2168"><span class="linenos">2168</span></a><span class="sd">    poly_order : str or int, optional</span>
</span><span id="compare_models-2169"><a href="#compare_models-2169"><span class="linenos">2169</span></a><span class="sd">        Method for intensity matching between the SR output and the reference.</span>
</span><span id="compare_models-2170"><a href="#compare_models-2170"><span class="linenos">2170</span></a><span class="sd">        Options: &#39;hist&#39; for histogram matching (default), an integer for</span>
</span><span id="compare_models-2171"><a href="#compare_models-2171"><span class="linenos">2171</span></a><span class="sd">        polynomial regression, or None to disable.</span>
</span><span id="compare_models-2172"><a href="#compare_models-2172"><span class="linenos">2172</span></a><span class="sd">    identifier : str, optional</span>
</span><span id="compare_models-2173"><a href="#compare_models-2173"><span class="linenos">2173</span></a><span class="sd">        A custom identifier for the output DataFrame. If None, it is inferred</span>
</span><span id="compare_models-2174"><a href="#compare_models-2174"><span class="linenos">2174</span></a><span class="sd">        from the model filename. Default is None.</span>
</span><span id="compare_models-2175"><a href="#compare_models-2175"><span class="linenos">2175</span></a><span class="sd">    noise_sd : float, optional</span>
</span><span id="compare_models-2176"><a href="#compare_models-2176"><span class="linenos">2176</span></a><span class="sd">        Standard deviation of the additive Gaussian noise applied to the</span>
</span><span id="compare_models-2177"><a href="#compare_models-2177"><span class="linenos">2177</span></a><span class="sd">        downsampled image before inference. Default is 0.1.</span>
</span><span id="compare_models-2178"><a href="#compare_models-2178"><span class="linenos">2178</span></a><span class="sd">    verbose : bool, optional</span>
</span><span id="compare_models-2179"><a href="#compare_models-2179"><span class="linenos">2179</span></a><span class="sd">        If True, prints detailed progress and intermediate values. Default is False.</span>
</span><span id="compare_models-2180"><a href="#compare_models-2180"><span class="linenos">2180</span></a>
</span><span id="compare_models-2181"><a href="#compare_models-2181"><span class="linenos">2181</span></a><span class="sd">    Returns</span>
</span><span id="compare_models-2182"><a href="#compare_models-2182"><span class="linenos">2182</span></a><span class="sd">    -------</span>
</span><span id="compare_models-2183"><a href="#compare_models-2183"><span class="linenos">2183</span></a><span class="sd">    pd.DataFrame</span>
</span><span id="compare_models-2184"><a href="#compare_models-2184"><span class="linenos">2184</span></a><span class="sd">        A DataFrame where each row corresponds to a model. Columns contain evaluation</span>
</span><span id="compare_models-2185"><a href="#compare_models-2185"><span class="linenos">2185</span></a><span class="sd">        metrics (PSNR.SR, SSIM.SR, DICE.SR), baseline metrics (PSNR.LIN, SSIM.LIN,</span>
</span><span id="compare_models-2186"><a href="#compare_models-2186"><span class="linenos">2186</span></a><span class="sd">        DICE.NN), and metadata.</span>
</span><span id="compare_models-2187"><a href="#compare_models-2187"><span class="linenos">2187</span></a>
</span><span id="compare_models-2188"><a href="#compare_models-2188"><span class="linenos">2188</span></a><span class="sd">    Notes</span>
</span><span id="compare_models-2189"><a href="#compare_models-2189"><span class="linenos">2189</span></a><span class="sd">    -----</span>
</span><span id="compare_models-2190"><a href="#compare_models-2190"><span class="linenos">2190</span></a><span class="sd">    When evaluating a 2-channel (segmentation) model, the primary metric for the</span>
</span><span id="compare_models-2191"><a href="#compare_models-2191"><span class="linenos">2191</span></a><span class="sd">    segmentation task is the Dice score (`DICE.SR`). The intensity metrics (PSNR, SSIM)</span>
</span><span id="compare_models-2192"><a href="#compare_models-2192"><span class="linenos">2192</span></a><span class="sd">    are still computed on the first channel.</span>
</span><span id="compare_models-2193"><a href="#compare_models-2193"><span class="linenos">2193</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="compare_models-2194"><a href="#compare_models-2194"><span class="linenos">2194</span></a>    <span class="n">padding</span><span class="o">=</span><span class="mi">4</span>
</span><span id="compare_models-2195"><a href="#compare_models-2195"><span class="linenos">2195</span></a>    <span class="n">mydf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
</span><span id="compare_models-2196"><a href="#compare_models-2196"><span class="linenos">2196</span></a>    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">model_filenames</span> <span class="p">)</span> <span class="p">):</span>
</span><span id="compare_models-2197"><a href="#compare_models-2197"><span class="linenos">2197</span></a>        <span class="n">srmdl</span><span class="p">,</span> <span class="n">upshape</span> <span class="o">=</span> <span class="n">read_srmodel</span><span class="p">(</span> <span class="n">model_filenames</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="p">)</span>
</span><span id="compare_models-2198"><a href="#compare_models-2198"><span class="linenos">2198</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="compare_models-2199"><a href="#compare_models-2199"><span class="linenos">2199</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="n">model_filenames</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="p">)</span>
</span><span id="compare_models-2200"><a href="#compare_models-2200"><span class="linenos">2200</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="n">upshape</span> <span class="p">)</span>
</span><span id="compare_models-2201"><a href="#compare_models-2201"><span class="linenos">2201</span></a>        <span class="n">tarshape</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="compare_models-2202"><a href="#compare_models-2202"><span class="linenos">2202</span></a>        <span class="n">inspc</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">get_spacing</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
</span><span id="compare_models-2203"><a href="#compare_models-2203"><span class="linenos">2203</span></a>        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">)):</span>
</span><span id="compare_models-2204"><a href="#compare_models-2204"><span class="linenos">2204</span></a>            <span class="n">tarshape</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="nb">float</span><span class="p">(</span><span class="n">upshape</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">*</span> <span class="n">inspc</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="p">)</span>
</span><span id="compare_models-2205"><a href="#compare_models-2205"><span class="linenos">2205</span></a>        <span class="c1"># uses linear interp</span>
</span><span id="compare_models-2206"><a href="#compare_models-2206"><span class="linenos">2206</span></a>        <span class="n">dimg</span><span class="o">=</span><span class="n">ants</span><span class="o">.</span><span class="n">resample_image</span><span class="p">(</span> <span class="n">img</span><span class="p">,</span> <span class="n">tarshape</span><span class="p">,</span> <span class="n">use_voxels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">interp_type</span><span class="o">=</span><span class="mi">0</span> <span class="p">)</span>
</span><span id="compare_models-2207"><a href="#compare_models-2207"><span class="linenos">2207</span></a>        <span class="n">dimg</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">add_noise_to_image</span><span class="p">(</span> <span class="n">dimg</span><span class="p">,</span><span class="s1">&#39;additivegaussian&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">noise_sd</span><span class="p">]</span> <span class="p">)</span>
</span><span id="compare_models-2208"><a href="#compare_models-2208"><span class="linenos">2208</span></a>        <span class="kn">import</span> <span class="nn">math</span>
</span><span id="compare_models-2209"><a href="#compare_models-2209"><span class="linenos">2209</span></a>        <span class="n">dicesr</span><span class="o">=</span><span class="n">math</span><span class="o">.</span><span class="n">nan</span>
</span><span id="compare_models-2210"><a href="#compare_models-2210"><span class="linenos">2210</span></a>        <span class="n">dicenn</span><span class="o">=</span><span class="n">math</span><span class="o">.</span><span class="n">nan</span>
</span><span id="compare_models-2211"><a href="#compare_models-2211"><span class="linenos">2211</span></a>        <span class="k">if</span> <span class="n">upshape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="compare_models-2212"><a href="#compare_models-2212"><span class="linenos">2212</span></a>            <span class="n">seghigh</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">threshold_image</span><span class="p">(</span> <span class="n">img</span><span class="p">,</span><span class="s2">&quot;Otsu&quot;</span><span class="p">,</span><span class="n">n_classes</span><span class="p">)</span>
</span><span id="compare_models-2213"><a href="#compare_models-2213"><span class="linenos">2213</span></a>            <span class="n">seglow</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">resample_image</span><span class="p">(</span> <span class="n">seghigh</span><span class="p">,</span> <span class="n">tarshape</span><span class="p">,</span> <span class="n">use_voxels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">interp_type</span><span class="o">=</span><span class="mi">1</span> <span class="p">)</span>
</span><span id="compare_models-2214"><a href="#compare_models-2214"><span class="linenos">2214</span></a>            <span class="n">dimgup</span><span class="o">=</span><span class="n">inference</span><span class="p">(</span> <span class="n">dimg</span><span class="p">,</span> <span class="n">srmdl</span><span class="p">,</span> <span class="n">segmentation</span> <span class="o">=</span> <span class="n">seglow</span><span class="p">,</span> <span class="n">poly_order</span><span class="o">=</span><span class="n">poly_order</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span> <span class="p">)</span>
</span><span id="compare_models-2215"><a href="#compare_models-2215"><span class="linenos">2215</span></a>            <span class="n">dimgupseg</span> <span class="o">=</span> <span class="n">dimgup</span><span class="p">[</span><span class="s1">&#39;super_resolution_segmentation&#39;</span><span class="p">]</span>
</span><span id="compare_models-2216"><a href="#compare_models-2216"><span class="linenos">2216</span></a>            <span class="n">dimgup</span> <span class="o">=</span> <span class="n">dimgup</span><span class="p">[</span><span class="s1">&#39;super_resolution&#39;</span><span class="p">]</span>
</span><span id="compare_models-2217"><a href="#compare_models-2217"><span class="linenos">2217</span></a>            <span class="n">segblock</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">resample_image_to_target</span><span class="p">(</span> <span class="n">seghigh</span><span class="p">,</span> <span class="n">dimgupseg</span><span class="p">,</span> <span class="n">interp_type</span><span class="o">=</span><span class="s1">&#39;nearestNeighbor&#39;</span>  <span class="p">)</span>
</span><span id="compare_models-2218"><a href="#compare_models-2218"><span class="linenos">2218</span></a>            <span class="n">segimgnn</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">resample_image_to_target</span><span class="p">(</span> <span class="n">seglow</span><span class="p">,</span> <span class="n">dimgupseg</span><span class="p">,</span> <span class="n">interp_type</span><span class="o">=</span><span class="s1">&#39;nearestNeighbor&#39;</span> <span class="p">)</span>
</span><span id="compare_models-2219"><a href="#compare_models-2219"><span class="linenos">2219</span></a>            <span class="n">segblock</span><span class="p">[</span> <span class="n">dimgupseg</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="compare_models-2220"><a href="#compare_models-2220"><span class="linenos">2220</span></a>            <span class="n">segimgnn</span><span class="p">[</span> <span class="n">dimgupseg</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="compare_models-2221"><a href="#compare_models-2221"><span class="linenos">2221</span></a>            <span class="n">dicenn</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">label_overlap_measures</span><span class="p">(</span><span class="n">segblock</span><span class="p">,</span> <span class="n">segimgnn</span><span class="p">)[</span><span class="s1">&#39;MeanOverlap&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="compare_models-2222"><a href="#compare_models-2222"><span class="linenos">2222</span></a>            <span class="n">dicesr</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">label_overlap_measures</span><span class="p">(</span><span class="n">segblock</span><span class="p">,</span> <span class="n">dimgupseg</span><span class="p">)[</span><span class="s1">&#39;MeanOverlap&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="compare_models-2223"><a href="#compare_models-2223"><span class="linenos">2223</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="compare_models-2224"><a href="#compare_models-2224"><span class="linenos">2224</span></a>            <span class="n">dimgup</span><span class="o">=</span><span class="n">inference</span><span class="p">(</span> <span class="n">dimg</span><span class="p">,</span> <span class="n">srmdl</span><span class="p">,</span> <span class="n">poly_order</span><span class="o">=</span><span class="n">poly_order</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span> <span class="p">)</span>
</span><span id="compare_models-2225"><a href="#compare_models-2225"><span class="linenos">2225</span></a>        <span class="n">dimglin</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">resample_image_to_target</span><span class="p">(</span> <span class="n">dimg</span><span class="p">,</span> <span class="n">dimgup</span><span class="p">,</span> <span class="n">interp_type</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span> <span class="p">)</span>
</span><span id="compare_models-2226"><a href="#compare_models-2226"><span class="linenos">2226</span></a>        <span class="n">imgblock</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">resample_image_to_target</span><span class="p">(</span> <span class="n">img</span><span class="p">,</span> <span class="n">dimgup</span><span class="p">,</span> <span class="n">interp_type</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span>  <span class="p">)</span>
</span><span id="compare_models-2227"><a href="#compare_models-2227"><span class="linenos">2227</span></a>        <span class="n">dimgup</span><span class="p">[</span> <span class="n">imgblock</span> <span class="o">==</span> <span class="mf">0.0</span> <span class="p">]</span><span class="o">=</span><span class="mf">0.0</span>
</span><span id="compare_models-2228"><a href="#compare_models-2228"><span class="linenos">2228</span></a>        <span class="n">dimglin</span><span class="p">[</span> <span class="n">imgblock</span> <span class="o">==</span> <span class="mf">0.0</span> <span class="p">]</span><span class="o">=</span><span class="mf">0.0</span>
</span><span id="compare_models-2229"><a href="#compare_models-2229"><span class="linenos">2229</span></a>        <span class="n">padder</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="compare_models-2230"><a href="#compare_models-2230"><span class="linenos">2230</span></a>        <span class="n">dimwarning</span><span class="o">=</span><span class="kc">False</span>
</span><span id="compare_models-2231"><a href="#compare_models-2231"><span class="linenos">2231</span></a>        <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">dimension</span><span class="p">):</span>
</span><span id="compare_models-2232"><a href="#compare_models-2232"><span class="linenos">2232</span></a>            <span class="n">padder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">padding</span> <span class="p">)</span>
</span><span id="compare_models-2233"><a href="#compare_models-2233"><span class="linenos">2233</span></a>            <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span> <span class="o">!=</span> <span class="n">imgblock</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">jj</span><span class="p">]:</span>
</span><span id="compare_models-2234"><a href="#compare_models-2234"><span class="linenos">2234</span></a>                <span class="n">dimwarning</span><span class="o">=</span><span class="kc">True</span>
</span><span id="compare_models-2235"><a href="#compare_models-2235"><span class="linenos">2235</span></a>        <span class="k">if</span> <span class="n">dimwarning</span><span class="p">:</span>
</span><span id="compare_models-2236"><a href="#compare_models-2236"><span class="linenos">2236</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;NOTE: dimensions of downsampled to upsampled image do not match!!!&quot;</span><span class="p">)</span>
</span><span id="compare_models-2237"><a href="#compare_models-2237"><span class="linenos">2237</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;we force them to match but this suggests results may not be reliable.&quot;</span><span class="p">)</span>
</span><span id="compare_models-2238"><a href="#compare_models-2238"><span class="linenos">2238</span></a>        <span class="n">temp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span> <span class="n">model_filenames</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="p">)</span>
</span><span id="compare_models-2239"><a href="#compare_models-2239"><span class="linenos">2239</span></a>        <span class="n">temp</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span> <span class="s2">&quot;siq_default_sisr_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">temp</span> <span class="p">)</span>
</span><span id="compare_models-2240"><a href="#compare_models-2240"><span class="linenos">2240</span></a>        <span class="n">temp</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span> <span class="s2">&quot;_best_mdl.keras&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">temp</span> <span class="p">)</span>
</span><span id="compare_models-2241"><a href="#compare_models-2241"><span class="linenos">2241</span></a>        <span class="n">temp</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span> <span class="s2">&quot;_best_mdl.h5&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">temp</span> <span class="p">)</span>
</span><span id="compare_models-2242"><a href="#compare_models-2242"><span class="linenos">2242</span></a>        <span class="k">if</span> <span class="n">verbose</span> <span class="ow">and</span> <span class="n">dimwarning</span><span class="p">:</span>
</span><span id="compare_models-2243"><a href="#compare_models-2243"><span class="linenos">2243</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;original img shape&quot;</span> <span class="p">)</span>
</span><span id="compare_models-2244"><a href="#compare_models-2244"><span class="linenos">2244</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span> <span class="p">)</span>
</span><span id="compare_models-2245"><a href="#compare_models-2245"><span class="linenos">2245</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;resampled img shape&quot;</span> <span class="p">)</span>
</span><span id="compare_models-2246"><a href="#compare_models-2246"><span class="linenos">2246</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="n">imgblock</span><span class="o">.</span><span class="n">shape</span> <span class="p">)</span>
</span><span id="compare_models-2247"><a href="#compare_models-2247"><span class="linenos">2247</span></a>        <span class="n">a</span><span class="o">=</span><span class="p">[]</span>
</span><span id="compare_models-2248"><a href="#compare_models-2248"><span class="linenos">2248</span></a>        <span class="n">imgshape</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="compare_models-2249"><a href="#compare_models-2249"><span class="linenos">2249</span></a>        <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">upshape</span><span class="p">)):</span>
</span><span id="compare_models-2250"><a href="#compare_models-2250"><span class="linenos">2250</span></a>            <span class="n">a</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="nb">str</span><span class="p">(</span><span class="n">upshape</span><span class="p">[</span><span class="n">aa</span><span class="p">])</span> <span class="p">)</span>
</span><span id="compare_models-2251"><a href="#compare_models-2251"><span class="linenos">2251</span></a>            <span class="k">if</span> <span class="n">aa</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">imgblock</span><span class="o">.</span><span class="n">shape</span><span class="p">):</span>
</span><span id="compare_models-2252"><a href="#compare_models-2252"><span class="linenos">2252</span></a>                <span class="n">imgshape</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="nb">str</span><span class="p">(</span> <span class="n">imgblock</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">aa</span><span class="p">]</span> <span class="p">)</span> <span class="p">)</span>
</span><span id="compare_models-2253"><a href="#compare_models-2253"><span class="linenos">2253</span></a>        <span class="k">if</span> <span class="n">identifier</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="compare_models-2254"><a href="#compare_models-2254"><span class="linenos">2254</span></a>            <span class="n">identifier</span><span class="o">=</span><span class="n">temp</span>
</span><span id="compare_models-2255"><a href="#compare_models-2255"><span class="linenos">2255</span></a>        <span class="n">mydict</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="compare_models-2256"><a href="#compare_models-2256"><span class="linenos">2256</span></a>            <span class="s2">&quot;identifier&quot;</span><span class="p">:</span><span class="n">identifier</span><span class="p">,</span>
</span><span id="compare_models-2257"><a href="#compare_models-2257"><span class="linenos">2257</span></a>            <span class="s2">&quot;imgshape&quot;</span><span class="p">:</span><span class="s2">&quot;x&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">imgshape</span><span class="p">),</span>
</span><span id="compare_models-2258"><a href="#compare_models-2258"><span class="linenos">2258</span></a>            <span class="s2">&quot;mdl&quot;</span><span class="p">:</span> <span class="n">temp</span><span class="p">,</span>
</span><span id="compare_models-2259"><a href="#compare_models-2259"><span class="linenos">2259</span></a>            <span class="s2">&quot;mdlshape&quot;</span><span class="p">:</span><span class="s2">&quot;x&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">a</span><span class="p">),</span>
</span><span id="compare_models-2260"><a href="#compare_models-2260"><span class="linenos">2260</span></a>            <span class="s2">&quot;PSNR.LIN&quot;</span><span class="p">:</span> <span class="n">antspynet</span><span class="o">.</span><span class="n">psnr</span><span class="p">(</span> <span class="n">imgblock</span><span class="p">,</span> <span class="n">dimglin</span> <span class="p">),</span>
</span><span id="compare_models-2261"><a href="#compare_models-2261"><span class="linenos">2261</span></a>            <span class="s2">&quot;PSNR.SR&quot;</span><span class="p">:</span> <span class="n">antspynet</span><span class="o">.</span><span class="n">psnr</span><span class="p">(</span> <span class="n">imgblock</span><span class="p">,</span> <span class="n">dimgup</span> <span class="p">),</span>
</span><span id="compare_models-2262"><a href="#compare_models-2262"><span class="linenos">2262</span></a>            <span class="s2">&quot;SSIM.LIN&quot;</span><span class="p">:</span> <span class="n">antspynet</span><span class="o">.</span><span class="n">ssim</span><span class="p">(</span> <span class="n">imgblock</span><span class="p">,</span> <span class="n">dimglin</span> <span class="p">),</span>
</span><span id="compare_models-2263"><a href="#compare_models-2263"><span class="linenos">2263</span></a>            <span class="s2">&quot;SSIM.SR&quot;</span><span class="p">:</span> <span class="n">antspynet</span><span class="o">.</span><span class="n">ssim</span><span class="p">(</span> <span class="n">imgblock</span><span class="p">,</span> <span class="n">dimgup</span> <span class="p">),</span>
</span><span id="compare_models-2264"><a href="#compare_models-2264"><span class="linenos">2264</span></a>            <span class="s2">&quot;DICE.NN&quot;</span><span class="p">:</span> <span class="n">dicenn</span><span class="p">,</span>
</span><span id="compare_models-2265"><a href="#compare_models-2265"><span class="linenos">2265</span></a>            <span class="s2">&quot;DICE.SR&quot;</span><span class="p">:</span> <span class="n">dicesr</span><span class="p">,</span>
</span><span id="compare_models-2266"><a href="#compare_models-2266"><span class="linenos">2266</span></a>            <span class="s2">&quot;dimwarning&quot;</span><span class="p">:</span> <span class="n">dimwarning</span> <span class="p">}</span>
</span><span id="compare_models-2267"><a href="#compare_models-2267"><span class="linenos">2267</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="compare_models-2268"><a href="#compare_models-2268"><span class="linenos">2268</span></a>            <span class="nb">print</span><span class="p">(</span> <span class="n">mydict</span> <span class="p">)</span>
</span><span id="compare_models-2269"><a href="#compare_models-2269"><span class="linenos">2269</span></a>        <span class="n">temp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">(</span> <span class="p">[</span><span class="n">mydict</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span>
</span><span id="compare_models-2270"><a href="#compare_models-2270"><span class="linenos">2270</span></a>        <span class="n">mydf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span> <span class="p">[</span><span class="n">mydf</span><span class="p">,</span><span class="n">temp</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span> <span class="p">)</span>
</span><span id="compare_models-2271"><a href="#compare_models-2271"><span class="linenos">2271</span></a>        <span class="c1"># end loop</span>
</span><span id="compare_models-2272"><a href="#compare_models-2272"><span class="linenos">2272</span></a>    <span class="k">return</span> <span class="n">mydf</span>
</span></pre></div>


            <div class="docstring"><p>Evaluates and compares the performance of multiple super-resolution models on a given image.</p>

<p>This function provides a standardized way to benchmark SR models. For each model,
it performs the following steps:</p>

<ol>
<li>Loads the model and determines its upsampling factor.</li>
<li>Downsamples the high-resolution input image (<code>img</code>) to create a low-resolution
input, simulating a real-world scenario.</li>
<li>Adds Gaussian noise to the low-resolution input to test for robustness.</li>
<li>Runs inference using the model to generate a super-resolved output.</li>
<li>Generates a baseline output by upsampling the low-res input with linear interpolation.</li>
<li>Calculates PSNR and SSIM metrics comparing both the model's output and the
baseline against the original high-resolution image.</li>
<li>If a dual-channel (image + segmentation) model is detected, it also calculates
Dice scores for segmentation performance.</li>
<li>Aggregates all results into a pandas DataFrame for easy comparison.</li>
</ol>

<h2 id="parameters">Parameters</h2>

<p>model_filenames : list of str
    A list of file paths to the Keras models (.h5, .keras) to be compared.
img : ants.ANTsImage
    The high-resolution ground truth image. This image will be downsampled to
    create the input for the models.
n_classes : int, optional
    The number of classes for Otsu's thresholding when auto-generating a
    segmentation for evaluating dual-channel models. Default is 3.
poly_order : str or int, optional
    Method for intensity matching between the SR output and the reference.
    Options: 'hist' for histogram matching (default), an integer for
    polynomial regression, or None to disable.
identifier : str, optional
    A custom identifier for the output DataFrame. If None, it is inferred
    from the model filename. Default is None.
noise_sd : float, optional
    Standard deviation of the additive Gaussian noise applied to the
    downsampled image before inference. Default is 0.1.
verbose : bool, optional
    If True, prints detailed progress and intermediate values. Default is False.</p>

<h2 id="returns">Returns</h2>

<p>pd.DataFrame
    A DataFrame where each row corresponds to a model. Columns contain evaluation
    metrics (PSNR.SR, SSIM.SR, DICE.SR), baseline metrics (PSNR.LIN, SSIM.LIN,
    DICE.NN), and metadata.</p>

<h2 id="notes">Notes</h2>

<p>When evaluating a 2-channel (segmentation) model, the primary metric for the
segmentation task is the Dice score (<code>DICE.SR</code>). The intensity metrics (PSNR, SSIM)
are still computed on the first channel.</p>
</div>


                </section>
                <section id="region_wise_super_resolution">
                            <input id="region_wise_super_resolution-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">region_wise_super_resolution</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">image</span>, </span><span class="param"><span class="n">mask</span>, </span><span class="param"><span class="n">super_res_model</span>, </span><span class="param"><span class="n">dilation_amount</span><span class="o">=</span><span class="mi">4</span>, </span><span class="param"><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="region_wise_super_resolution-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#region_wise_super_resolution"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="region_wise_super_resolution-2277"><a href="#region_wise_super_resolution-2277"><span class="linenos">2277</span></a><span class="k">def</span> <span class="nf">region_wise_super_resolution</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">super_res_model</span><span class="p">,</span> <span class="n">dilation_amount</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="region_wise_super_resolution-2278"><a href="#region_wise_super_resolution-2278"><span class="linenos">2278</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="region_wise_super_resolution-2279"><a href="#region_wise_super_resolution-2279"><span class="linenos">2279</span></a><span class="sd">    Apply super-resolution model to each labeled region in the mask independently.</span>
</span><span id="region_wise_super_resolution-2280"><a href="#region_wise_super_resolution-2280"><span class="linenos">2280</span></a>
</span><span id="region_wise_super_resolution-2281"><a href="#region_wise_super_resolution-2281"><span class="linenos">2281</span></a><span class="sd">    Arguments</span>
</span><span id="region_wise_super_resolution-2282"><a href="#region_wise_super_resolution-2282"><span class="linenos">2282</span></a><span class="sd">    ---------</span>
</span><span id="region_wise_super_resolution-2283"><a href="#region_wise_super_resolution-2283"><span class="linenos">2283</span></a><span class="sd">    image : ANTsImage</span>
</span><span id="region_wise_super_resolution-2284"><a href="#region_wise_super_resolution-2284"><span class="linenos">2284</span></a><span class="sd">        Input image.</span>
</span><span id="region_wise_super_resolution-2285"><a href="#region_wise_super_resolution-2285"><span class="linenos">2285</span></a>
</span><span id="region_wise_super_resolution-2286"><a href="#region_wise_super_resolution-2286"><span class="linenos">2286</span></a><span class="sd">    mask : ANTsImage</span>
</span><span id="region_wise_super_resolution-2287"><a href="#region_wise_super_resolution-2287"><span class="linenos">2287</span></a><span class="sd">        Integer-labeled segmentation mask with non-zero regions to upsample.</span>
</span><span id="region_wise_super_resolution-2288"><a href="#region_wise_super_resolution-2288"><span class="linenos">2288</span></a>
</span><span id="region_wise_super_resolution-2289"><a href="#region_wise_super_resolution-2289"><span class="linenos">2289</span></a><span class="sd">    super_res_model : tf.keras.Model</span>
</span><span id="region_wise_super_resolution-2290"><a href="#region_wise_super_resolution-2290"><span class="linenos">2290</span></a><span class="sd">        Trained super-resolution model.</span>
</span><span id="region_wise_super_resolution-2291"><a href="#region_wise_super_resolution-2291"><span class="linenos">2291</span></a>
</span><span id="region_wise_super_resolution-2292"><a href="#region_wise_super_resolution-2292"><span class="linenos">2292</span></a><span class="sd">    dilation_amount : int</span>
</span><span id="region_wise_super_resolution-2293"><a href="#region_wise_super_resolution-2293"><span class="linenos">2293</span></a><span class="sd">        Number of morphological dilations applied to each label region before cropping.</span>
</span><span id="region_wise_super_resolution-2294"><a href="#region_wise_super_resolution-2294"><span class="linenos">2294</span></a>
</span><span id="region_wise_super_resolution-2295"><a href="#region_wise_super_resolution-2295"><span class="linenos">2295</span></a><span class="sd">    verbose : bool</span>
</span><span id="region_wise_super_resolution-2296"><a href="#region_wise_super_resolution-2296"><span class="linenos">2296</span></a><span class="sd">        If True, print detailed status.</span>
</span><span id="region_wise_super_resolution-2297"><a href="#region_wise_super_resolution-2297"><span class="linenos">2297</span></a>
</span><span id="region_wise_super_resolution-2298"><a href="#region_wise_super_resolution-2298"><span class="linenos">2298</span></a><span class="sd">    Returns</span>
</span><span id="region_wise_super_resolution-2299"><a href="#region_wise_super_resolution-2299"><span class="linenos">2299</span></a><span class="sd">    -------</span>
</span><span id="region_wise_super_resolution-2300"><a href="#region_wise_super_resolution-2300"><span class="linenos">2300</span></a><span class="sd">    ANTsImage : Full-size super-resolved image with per-label inference and stitching.</span>
</span><span id="region_wise_super_resolution-2301"><a href="#region_wise_super_resolution-2301"><span class="linenos">2301</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="region_wise_super_resolution-2302"><a href="#region_wise_super_resolution-2302"><span class="linenos">2302</span></a>    <span class="kn">import</span> <span class="nn">ants</span>
</span><span id="region_wise_super_resolution-2303"><a href="#region_wise_super_resolution-2303"><span class="linenos">2303</span></a>    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span><span id="region_wise_super_resolution-2304"><a href="#region_wise_super_resolution-2304"><span class="linenos">2304</span></a>    <span class="kn">from</span> <span class="nn">antspynet</span> <span class="kn">import</span> <span class="n">apply_super_resolution_model_to_image</span>
</span><span id="region_wise_super_resolution-2305"><a href="#region_wise_super_resolution-2305"><span class="linenos">2305</span></a>
</span><span id="region_wise_super_resolution-2306"><a href="#region_wise_super_resolution-2306"><span class="linenos">2306</span></a>    <span class="n">upFactor</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="region_wise_super_resolution-2307"><a href="#region_wise_super_resolution-2307"><span class="linenos">2307</span></a>    <span class="n">input_shape</span> <span class="o">=</span> <span class="n">super_res_model</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
</span><span id="region_wise_super_resolution-2308"><a href="#region_wise_super_resolution-2308"><span class="linenos">2308</span></a>    <span class="n">test_shape</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span> <span class="k">else</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="region_wise_super_resolution-2309"><a href="#region_wise_super_resolution-2309"><span class="linenos">2309</span></a>    <span class="n">test_input</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">test_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="region_wise_super_resolution-2310"><a href="#region_wise_super_resolution-2310"><span class="linenos">2310</span></a>    <span class="n">test_output</span> <span class="o">=</span> <span class="n">super_res_model</span><span class="p">(</span><span class="n">test_input</span><span class="p">)</span>
</span><span id="region_wise_super_resolution-2311"><a href="#region_wise_super_resolution-2311"><span class="linenos">2311</span></a>
</span><span id="region_wise_super_resolution-2312"><a href="#region_wise_super_resolution-2312"><span class="linenos">2312</span></a>    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">test_shape</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">):</span>  <span class="c1"># ignore batch + channel</span>
</span><span id="region_wise_super_resolution-2313"><a href="#region_wise_super_resolution-2313"><span class="linenos">2313</span></a>        <span class="n">upFactor</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">test_output</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">test_input</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]))</span>
</span><span id="region_wise_super_resolution-2314"><a href="#region_wise_super_resolution-2314"><span class="linenos">2314</span></a>
</span><span id="region_wise_super_resolution-2315"><a href="#region_wise_super_resolution-2315"><span class="linenos">2315</span></a>    <span class="n">original_size</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">shape</span>  <span class="c1"># e.g., (x, y, z)</span>
</span><span id="region_wise_super_resolution-2316"><a href="#region_wise_super_resolution-2316"><span class="linenos">2316</span></a>    <span class="n">new_size</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">s</span> <span class="o">*</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">original_size</span><span class="p">,</span> <span class="n">upFactor</span><span class="p">))</span>
</span><span id="region_wise_super_resolution-2317"><a href="#region_wise_super_resolution-2317"><span class="linenos">2317</span></a>    <span class="n">upsampled_mask</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">resample_image</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">new_size</span><span class="p">,</span> <span class="n">use_voxels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">interp_type</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="region_wise_super_resolution-2318"><a href="#region_wise_super_resolution-2318"><span class="linenos">2318</span></a>    <span class="n">upsampled_image</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">resample_image</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">new_size</span><span class="p">,</span> <span class="n">use_voxels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">interp_type</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="region_wise_super_resolution-2319"><a href="#region_wise_super_resolution-2319"><span class="linenos">2319</span></a>
</span><span id="region_wise_super_resolution-2320"><a href="#region_wise_super_resolution-2320"><span class="linenos">2320</span></a>    <span class="n">unique_labels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">upsampled_mask</span><span class="o">.</span><span class="n">numpy</span><span class="p">()))</span>
</span><span id="region_wise_super_resolution-2321"><a href="#region_wise_super_resolution-2321"><span class="linenos">2321</span></a>    <span class="k">if</span> <span class="mi">0</span> <span class="ow">in</span> <span class="n">unique_labels</span><span class="p">:</span>
</span><span id="region_wise_super_resolution-2322"><a href="#region_wise_super_resolution-2322"><span class="linenos">2322</span></a>        <span class="n">unique_labels</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="region_wise_super_resolution-2323"><a href="#region_wise_super_resolution-2323"><span class="linenos">2323</span></a>
</span><span id="region_wise_super_resolution-2324"><a href="#region_wise_super_resolution-2324"><span class="linenos">2324</span></a>    <span class="n">outimg</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">image_clone</span><span class="p">(</span><span class="n">upsampled_image</span><span class="p">)</span>
</span><span id="region_wise_super_resolution-2325"><a href="#region_wise_super_resolution-2325"><span class="linenos">2325</span></a>
</span><span id="region_wise_super_resolution-2326"><a href="#region_wise_super_resolution-2326"><span class="linenos">2326</span></a>    <span class="k">for</span> <span class="n">lab</span> <span class="ow">in</span> <span class="n">unique_labels</span><span class="p">:</span>
</span><span id="region_wise_super_resolution-2327"><a href="#region_wise_super_resolution-2327"><span class="linenos">2327</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="region_wise_super_resolution-2328"><a href="#region_wise_super_resolution-2328"><span class="linenos">2328</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing label: </span><span class="si">{</span><span class="n">lab</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="region_wise_super_resolution-2329"><a href="#region_wise_super_resolution-2329"><span class="linenos">2329</span></a>        <span class="n">regionmask</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">threshold_image</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">lab</span><span class="p">,</span> <span class="n">lab</span><span class="p">)</span><span class="o">.</span><span class="n">iMath</span><span class="p">(</span><span class="s2">&quot;MD&quot;</span><span class="p">,</span> <span class="n">dilation_amount</span><span class="p">)</span>
</span><span id="region_wise_super_resolution-2330"><a href="#region_wise_super_resolution-2330"><span class="linenos">2330</span></a>        <span class="n">cropped</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">crop_image</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">regionmask</span><span class="p">)</span>
</span><span id="region_wise_super_resolution-2331"><a href="#region_wise_super_resolution-2331"><span class="linenos">2331</span></a>        <span class="k">if</span> <span class="n">cropped</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="region_wise_super_resolution-2332"><a href="#region_wise_super_resolution-2332"><span class="linenos">2332</span></a>            <span class="k">continue</span>
</span><span id="region_wise_super_resolution-2333"><a href="#region_wise_super_resolution-2333"><span class="linenos">2333</span></a>        <span class="n">subimgsr</span> <span class="o">=</span> <span class="n">apply_super_resolution_model_to_image</span><span class="p">(</span>
</span><span id="region_wise_super_resolution-2334"><a href="#region_wise_super_resolution-2334"><span class="linenos">2334</span></a>            <span class="n">cropped</span><span class="p">,</span> <span class="n">super_res_model</span><span class="p">,</span> <span class="n">target_range</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span>
</span><span id="region_wise_super_resolution-2335"><a href="#region_wise_super_resolution-2335"><span class="linenos">2335</span></a>        <span class="p">)</span>
</span><span id="region_wise_super_resolution-2336"><a href="#region_wise_super_resolution-2336"><span class="linenos">2336</span></a>        <span class="n">stitched</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">decrop_image</span><span class="p">(</span><span class="n">subimgsr</span><span class="p">,</span> <span class="n">outimg</span><span class="p">)</span>
</span><span id="region_wise_super_resolution-2337"><a href="#region_wise_super_resolution-2337"><span class="linenos">2337</span></a>        <span class="n">outimg</span><span class="p">[</span><span class="n">upsampled_mask</span> <span class="o">==</span> <span class="n">lab</span><span class="p">]</span> <span class="o">=</span> <span class="n">stitched</span><span class="p">[</span><span class="n">upsampled_mask</span> <span class="o">==</span> <span class="n">lab</span><span class="p">]</span>
</span><span id="region_wise_super_resolution-2338"><a href="#region_wise_super_resolution-2338"><span class="linenos">2338</span></a>
</span><span id="region_wise_super_resolution-2339"><a href="#region_wise_super_resolution-2339"><span class="linenos">2339</span></a>    <span class="k">return</span> <span class="n">outimg</span>
</span></pre></div>


            <div class="docstring"><p>Apply super-resolution model to each labeled region in the mask independently.</p>

<h2 id="arguments">Arguments</h2>

<p>image : ANTsImage
    Input image.</p>

<p>mask : ANTsImage
    Integer-labeled segmentation mask with non-zero regions to upsample.</p>

<p>super_res_model : tf.keras.Model
    Trained super-resolution model.</p>

<p>dilation_amount : int
    Number of morphological dilations applied to each label region before cropping.</p>

<p>verbose : bool
    If True, print detailed status.</p>

<h2 id="returns">Returns</h2>

<p>ANTsImage : Full-size super-resolved image with per-label inference and stitching.</p>
</div>


                </section>
                <section id="region_wise_super_resolution_blended">
                            <input id="region_wise_super_resolution_blended-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">region_wise_super_resolution_blended</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">image</span>, </span><span class="param"><span class="n">mask</span>, </span><span class="param"><span class="n">super_res_model</span>, </span><span class="param"><span class="n">dilation_amount</span><span class="o">=</span><span class="mi">4</span>, </span><span class="param"><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="region_wise_super_resolution_blended-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#region_wise_super_resolution_blended"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="region_wise_super_resolution_blended-2342"><a href="#region_wise_super_resolution_blended-2342"><span class="linenos">2342</span></a><span class="k">def</span> <span class="nf">region_wise_super_resolution_blended</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">super_res_model</span><span class="p">,</span> <span class="n">dilation_amount</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="region_wise_super_resolution_blended-2343"><a href="#region_wise_super_resolution_blended-2343"><span class="linenos">2343</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="region_wise_super_resolution_blended-2344"><a href="#region_wise_super_resolution_blended-2344"><span class="linenos">2344</span></a><span class="sd">    Apply super-resolution model to labeled regions with smooth blending to minimize stitching artifacts.</span>
</span><span id="region_wise_super_resolution_blended-2345"><a href="#region_wise_super_resolution_blended-2345"><span class="linenos">2345</span></a>
</span><span id="region_wise_super_resolution_blended-2346"><a href="#region_wise_super_resolution_blended-2346"><span class="linenos">2346</span></a><span class="sd">    This version uses a weighted-averaging scheme based on distance transforms</span>
</span><span id="region_wise_super_resolution_blended-2347"><a href="#region_wise_super_resolution_blended-2347"><span class="linenos">2347</span></a><span class="sd">    to create seamless transitions between super-resolved regions and the background.</span>
</span><span id="region_wise_super_resolution_blended-2348"><a href="#region_wise_super_resolution_blended-2348"><span class="linenos">2348</span></a>
</span><span id="region_wise_super_resolution_blended-2349"><a href="#region_wise_super_resolution_blended-2349"><span class="linenos">2349</span></a><span class="sd">    Arguments</span>
</span><span id="region_wise_super_resolution_blended-2350"><a href="#region_wise_super_resolution_blended-2350"><span class="linenos">2350</span></a><span class="sd">    ---------</span>
</span><span id="region_wise_super_resolution_blended-2351"><a href="#region_wise_super_resolution_blended-2351"><span class="linenos">2351</span></a><span class="sd">    image : ANTsImage</span>
</span><span id="region_wise_super_resolution_blended-2352"><a href="#region_wise_super_resolution_blended-2352"><span class="linenos">2352</span></a><span class="sd">        Input low-resolution image.</span>
</span><span id="region_wise_super_resolution_blended-2353"><a href="#region_wise_super_resolution_blended-2353"><span class="linenos">2353</span></a>
</span><span id="region_wise_super_resolution_blended-2354"><a href="#region_wise_super_resolution_blended-2354"><span class="linenos">2354</span></a><span class="sd">    mask : ANTsImage</span>
</span><span id="region_wise_super_resolution_blended-2355"><a href="#region_wise_super_resolution_blended-2355"><span class="linenos">2355</span></a><span class="sd">        Integer-labeled segmentation mask.</span>
</span><span id="region_wise_super_resolution_blended-2356"><a href="#region_wise_super_resolution_blended-2356"><span class="linenos">2356</span></a>
</span><span id="region_wise_super_resolution_blended-2357"><a href="#region_wise_super_resolution_blended-2357"><span class="linenos">2357</span></a><span class="sd">    super_res_model : tf.keras.Model</span>
</span><span id="region_wise_super_resolution_blended-2358"><a href="#region_wise_super_resolution_blended-2358"><span class="linenos">2358</span></a><span class="sd">        Trained super-resolution model.</span>
</span><span id="region_wise_super_resolution_blended-2359"><a href="#region_wise_super_resolution_blended-2359"><span class="linenos">2359</span></a>
</span><span id="region_wise_super_resolution_blended-2360"><a href="#region_wise_super_resolution_blended-2360"><span class="linenos">2360</span></a><span class="sd">    dilation_amount : int</span>
</span><span id="region_wise_super_resolution_blended-2361"><a href="#region_wise_super_resolution_blended-2361"><span class="linenos">2361</span></a><span class="sd">        Number of morphological dilations applied to each label region before cropping.</span>
</span><span id="region_wise_super_resolution_blended-2362"><a href="#region_wise_super_resolution_blended-2362"><span class="linenos">2362</span></a><span class="sd">        This provides context to the SR model.</span>
</span><span id="region_wise_super_resolution_blended-2363"><a href="#region_wise_super_resolution_blended-2363"><span class="linenos">2363</span></a>
</span><span id="region_wise_super_resolution_blended-2364"><a href="#region_wise_super_resolution_blended-2364"><span class="linenos">2364</span></a><span class="sd">    verbose : bool</span>
</span><span id="region_wise_super_resolution_blended-2365"><a href="#region_wise_super_resolution_blended-2365"><span class="linenos">2365</span></a><span class="sd">        If True, print detailed status.</span>
</span><span id="region_wise_super_resolution_blended-2366"><a href="#region_wise_super_resolution_blended-2366"><span class="linenos">2366</span></a>
</span><span id="region_wise_super_resolution_blended-2367"><a href="#region_wise_super_resolution_blended-2367"><span class="linenos">2367</span></a><span class="sd">    Returns</span>
</span><span id="region_wise_super_resolution_blended-2368"><a href="#region_wise_super_resolution_blended-2368"><span class="linenos">2368</span></a><span class="sd">    -------</span>
</span><span id="region_wise_super_resolution_blended-2369"><a href="#region_wise_super_resolution_blended-2369"><span class="linenos">2369</span></a><span class="sd">    ANTsImage : Full-size, super-resolved image with seamless blending.</span>
</span><span id="region_wise_super_resolution_blended-2370"><a href="#region_wise_super_resolution_blended-2370"><span class="linenos">2370</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="region_wise_super_resolution_blended-2371"><a href="#region_wise_super_resolution_blended-2371"><span class="linenos">2371</span></a>    <span class="kn">import</span> <span class="nn">ants</span>
</span><span id="region_wise_super_resolution_blended-2372"><a href="#region_wise_super_resolution_blended-2372"><span class="linenos">2372</span></a>    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span><span id="region_wise_super_resolution_blended-2373"><a href="#region_wise_super_resolution_blended-2373"><span class="linenos">2373</span></a>    <span class="kn">from</span> <span class="nn">antspynet</span> <span class="kn">import</span> <span class="n">apply_super_resolution_model_to_image</span>
</span><span id="region_wise_super_resolution_blended-2374"><a href="#region_wise_super_resolution_blended-2374"><span class="linenos">2374</span></a>    <span class="n">epsilon32</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span>
</span><span id="region_wise_super_resolution_blended-2375"><a href="#region_wise_super_resolution_blended-2375"><span class="linenos">2375</span></a>    <span class="n">normalize_weight_maps</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># Default behavior to normalize weight maps</span>
</span><span id="region_wise_super_resolution_blended-2376"><a href="#region_wise_super_resolution_blended-2376"><span class="linenos">2376</span></a>    <span class="c1"># --- Step 1: Determine upsampling factor and prepare initial images ---</span>
</span><span id="region_wise_super_resolution_blended-2377"><a href="#region_wise_super_resolution_blended-2377"><span class="linenos">2377</span></a>    <span class="n">upFactor</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="region_wise_super_resolution_blended-2378"><a href="#region_wise_super_resolution_blended-2378"><span class="linenos">2378</span></a>    <span class="n">input_shape</span> <span class="o">=</span> <span class="n">super_res_model</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
</span><span id="region_wise_super_resolution_blended-2379"><a href="#region_wise_super_resolution_blended-2379"><span class="linenos">2379</span></a>    <span class="n">test_shape</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span> <span class="k">else</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="region_wise_super_resolution_blended-2380"><a href="#region_wise_super_resolution_blended-2380"><span class="linenos">2380</span></a>    <span class="n">test_input</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">test_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="region_wise_super_resolution_blended-2381"><a href="#region_wise_super_resolution_blended-2381"><span class="linenos">2381</span></a>    <span class="n">test_output</span> <span class="o">=</span> <span class="n">super_res_model</span><span class="p">(</span><span class="n">test_input</span><span class="p">)</span>
</span><span id="region_wise_super_resolution_blended-2382"><a href="#region_wise_super_resolution_blended-2382"><span class="linenos">2382</span></a>    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">test_shape</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">):</span>
</span><span id="region_wise_super_resolution_blended-2383"><a href="#region_wise_super_resolution_blended-2383"><span class="linenos">2383</span></a>        <span class="n">upFactor</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">test_output</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">test_input</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]))</span>
</span><span id="region_wise_super_resolution_blended-2384"><a href="#region_wise_super_resolution_blended-2384"><span class="linenos">2384</span></a>
</span><span id="region_wise_super_resolution_blended-2385"><a href="#region_wise_super_resolution_blended-2385"><span class="linenos">2385</span></a>    <span class="n">original_size</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span>
</span><span id="region_wise_super_resolution_blended-2386"><a href="#region_wise_super_resolution_blended-2386"><span class="linenos">2386</span></a>    <span class="n">new_size</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">s</span> <span class="o">*</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">original_size</span><span class="p">,</span> <span class="n">upFactor</span><span class="p">))</span>
</span><span id="region_wise_super_resolution_blended-2387"><a href="#region_wise_super_resolution_blended-2387"><span class="linenos">2387</span></a>
</span><span id="region_wise_super_resolution_blended-2388"><a href="#region_wise_super_resolution_blended-2388"><span class="linenos">2388</span></a>    <span class="c1"># The initial upsampled image will serve as our background</span>
</span><span id="region_wise_super_resolution_blended-2389"><a href="#region_wise_super_resolution_blended-2389"><span class="linenos">2389</span></a>    <span class="n">background_sr_image</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">resample_image</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">new_size</span><span class="p">,</span> <span class="n">use_voxels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">interp_type</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="region_wise_super_resolution_blended-2390"><a href="#region_wise_super_resolution_blended-2390"><span class="linenos">2390</span></a>
</span><span id="region_wise_super_resolution_blended-2391"><a href="#region_wise_super_resolution_blended-2391"><span class="linenos">2391</span></a>    <span class="c1"># --- Step 2: Initialize accumulator and weight sum canvases ---</span>
</span><span id="region_wise_super_resolution_blended-2392"><a href="#region_wise_super_resolution_blended-2392"><span class="linenos">2392</span></a>    <span class="c1"># These must be float type for accumulation</span>
</span><span id="region_wise_super_resolution_blended-2393"><a href="#region_wise_super_resolution_blended-2393"><span class="linenos">2393</span></a>    <span class="n">accumulator</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">image_clone</span><span class="p">(</span><span class="n">background_sr_image</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.0</span>
</span><span id="region_wise_super_resolution_blended-2394"><a href="#region_wise_super_resolution_blended-2394"><span class="linenos">2394</span></a>    <span class="n">weight_sum</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">image_clone</span><span class="p">(</span><span class="n">accumulator</span><span class="p">)</span>
</span><span id="region_wise_super_resolution_blended-2395"><a href="#region_wise_super_resolution_blended-2395"><span class="linenos">2395</span></a>
</span><span id="region_wise_super_resolution_blended-2396"><a href="#region_wise_super_resolution_blended-2396"><span class="linenos">2396</span></a>    <span class="n">unique_labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span> <span class="k">if</span> <span class="n">l</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="region_wise_super_resolution_blended-2397"><a href="#region_wise_super_resolution_blended-2397"><span class="linenos">2397</span></a>
</span><span id="region_wise_super_resolution_blended-2398"><a href="#region_wise_super_resolution_blended-2398"><span class="linenos">2398</span></a>    <span class="k">for</span> <span class="n">lab</span> <span class="ow">in</span> <span class="n">unique_labels</span><span class="p">:</span>
</span><span id="region_wise_super_resolution_blended-2399"><a href="#region_wise_super_resolution_blended-2399"><span class="linenos">2399</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="region_wise_super_resolution_blended-2400"><a href="#region_wise_super_resolution_blended-2400"><span class="linenos">2400</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Blending label: </span><span class="si">{</span><span class="n">lab</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="region_wise_super_resolution_blended-2401"><a href="#region_wise_super_resolution_blended-2401"><span class="linenos">2401</span></a>
</span><span id="region_wise_super_resolution_blended-2402"><a href="#region_wise_super_resolution_blended-2402"><span class="linenos">2402</span></a>        <span class="c1"># --- Step 3: Super-resolve a dilated patch (provides context to the model) ---</span>
</span><span id="region_wise_super_resolution_blended-2403"><a href="#region_wise_super_resolution_blended-2403"><span class="linenos">2403</span></a>        <span class="n">region_mask_dilated</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">threshold_image</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">lab</span><span class="p">,</span> <span class="n">lab</span><span class="p">)</span><span class="o">.</span><span class="n">iMath</span><span class="p">(</span><span class="s2">&quot;MD&quot;</span><span class="p">,</span> <span class="n">dilation_amount</span><span class="p">)</span>
</span><span id="region_wise_super_resolution_blended-2404"><a href="#region_wise_super_resolution_blended-2404"><span class="linenos">2404</span></a>        <span class="n">cropped_lowres</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">crop_image</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">region_mask_dilated</span><span class="p">)</span>
</span><span id="region_wise_super_resolution_blended-2405"><a href="#region_wise_super_resolution_blended-2405"><span class="linenos">2405</span></a>        <span class="k">if</span> <span class="n">cropped_lowres</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="region_wise_super_resolution_blended-2406"><a href="#region_wise_super_resolution_blended-2406"><span class="linenos">2406</span></a>            <span class="k">continue</span>
</span><span id="region_wise_super_resolution_blended-2407"><a href="#region_wise_super_resolution_blended-2407"><span class="linenos">2407</span></a>            
</span><span id="region_wise_super_resolution_blended-2408"><a href="#region_wise_super_resolution_blended-2408"><span class="linenos">2408</span></a>        <span class="c1"># Apply the model to the cropped low-res patch</span>
</span><span id="region_wise_super_resolution_blended-2409"><a href="#region_wise_super_resolution_blended-2409"><span class="linenos">2409</span></a>        <span class="n">sr_patch</span> <span class="o">=</span> <span class="n">apply_super_resolution_model_to_image</span><span class="p">(</span>
</span><span id="region_wise_super_resolution_blended-2410"><a href="#region_wise_super_resolution_blended-2410"><span class="linenos">2410</span></a>            <span class="n">cropped_lowres</span><span class="p">,</span> <span class="n">super_res_model</span><span class="p">,</span> <span class="n">target_range</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="region_wise_super_resolution_blended-2411"><a href="#region_wise_super_resolution_blended-2411"><span class="linenos">2411</span></a>        <span class="p">)</span>
</span><span id="region_wise_super_resolution_blended-2412"><a href="#region_wise_super_resolution_blended-2412"><span class="linenos">2412</span></a>        
</span><span id="region_wise_super_resolution_blended-2413"><a href="#region_wise_super_resolution_blended-2413"><span class="linenos">2413</span></a>        <span class="c1"># Place the super-resolved patch back onto a full-sized canvas</span>
</span><span id="region_wise_super_resolution_blended-2414"><a href="#region_wise_super_resolution_blended-2414"><span class="linenos">2414</span></a>        <span class="n">sr_patch_full_size</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">decrop_image</span><span class="p">(</span><span class="n">sr_patch</span><span class="p">,</span> <span class="n">accumulator</span><span class="p">)</span>
</span><span id="region_wise_super_resolution_blended-2415"><a href="#region_wise_super_resolution_blended-2415"><span class="linenos">2415</span></a>
</span><span id="region_wise_super_resolution_blended-2416"><a href="#region_wise_super_resolution_blended-2416"><span class="linenos">2416</span></a>        <span class="c1"># --- Step 4: Create a smooth weight map for this region ---</span>
</span><span id="region_wise_super_resolution_blended-2417"><a href="#region_wise_super_resolution_blended-2417"><span class="linenos">2417</span></a>        <span class="c1"># We use the *non-dilated* mask for the weight map to ensure a sharp focus on the target region.</span>
</span><span id="region_wise_super_resolution_blended-2418"><a href="#region_wise_super_resolution_blended-2418"><span class="linenos">2418</span></a>        <span class="n">region_mask_original</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">threshold_image</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">lab</span><span class="p">,</span> <span class="n">lab</span><span class="p">)</span>
</span><span id="region_wise_super_resolution_blended-2419"><a href="#region_wise_super_resolution_blended-2419"><span class="linenos">2419</span></a>        
</span><span id="region_wise_super_resolution_blended-2420"><a href="#region_wise_super_resolution_blended-2420"><span class="linenos">2420</span></a>        <span class="c1"># Resample the original region mask to the high-res grid</span>
</span><span id="region_wise_super_resolution_blended-2421"><a href="#region_wise_super_resolution_blended-2421"><span class="linenos">2421</span></a>        <span class="n">weight_map</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">resample_image</span><span class="p">(</span><span class="n">region_mask_original</span><span class="p">,</span> <span class="n">new_size</span><span class="p">,</span> <span class="n">use_voxels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">interp_type</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="region_wise_super_resolution_blended-2422"><a href="#region_wise_super_resolution_blended-2422"><span class="linenos">2422</span></a>        <span class="n">weight_map</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">smooth_image</span><span class="p">(</span><span class="n">weight_map</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span>
</span><span id="region_wise_super_resolution_blended-2423"><a href="#region_wise_super_resolution_blended-2423"><span class="linenos">2423</span></a>                                        <span class="n">sigma_in_physical_coordinates</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="region_wise_super_resolution_blended-2424"><a href="#region_wise_super_resolution_blended-2424"><span class="linenos">2424</span></a>        <span class="k">if</span> <span class="n">normalize_weight_maps</span><span class="p">:</span>
</span><span id="region_wise_super_resolution_blended-2425"><a href="#region_wise_super_resolution_blended-2425"><span class="linenos">2425</span></a>            <span class="n">weight_map</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">iMath</span><span class="p">(</span><span class="n">weight_map</span><span class="p">,</span> <span class="s2">&quot;Normalize&quot;</span><span class="p">)</span>
</span><span id="region_wise_super_resolution_blended-2426"><a href="#region_wise_super_resolution_blended-2426"><span class="linenos">2426</span></a>        <span class="c1"># --- Step 5: Accumulate the weighted values and the weights themselves ---</span>
</span><span id="region_wise_super_resolution_blended-2427"><a href="#region_wise_super_resolution_blended-2427"><span class="linenos">2427</span></a>        <span class="n">accumulator</span> <span class="o">+=</span> <span class="n">sr_patch_full_size</span> <span class="o">*</span> <span class="n">weight_map</span>
</span><span id="region_wise_super_resolution_blended-2428"><a href="#region_wise_super_resolution_blended-2428"><span class="linenos">2428</span></a>        <span class="n">weight_sum</span> <span class="o">+=</span> <span class="n">weight_map</span>
</span><span id="region_wise_super_resolution_blended-2429"><a href="#region_wise_super_resolution_blended-2429"><span class="linenos">2429</span></a>
</span><span id="region_wise_super_resolution_blended-2430"><a href="#region_wise_super_resolution_blended-2430"><span class="linenos">2430</span></a>    <span class="c1"># --- Step 6: Final Combination ---</span>
</span><span id="region_wise_super_resolution_blended-2431"><a href="#region_wise_super_resolution_blended-2431"><span class="linenos">2431</span></a>    <span class="c1"># Normalize the accumulator by the total weight at each pixel</span>
</span><span id="region_wise_super_resolution_blended-2432"><a href="#region_wise_super_resolution_blended-2432"><span class="linenos">2432</span></a>    <span class="n">weight_sum_np</span> <span class="o">=</span> <span class="n">weight_sum</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="region_wise_super_resolution_blended-2433"><a href="#region_wise_super_resolution_blended-2433"><span class="linenos">2433</span></a>    <span class="n">accumulator_np</span> <span class="o">=</span> <span class="n">accumulator</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="region_wise_super_resolution_blended-2434"><a href="#region_wise_super_resolution_blended-2434"><span class="linenos">2434</span></a>    
</span><span id="region_wise_super_resolution_blended-2435"><a href="#region_wise_super_resolution_blended-2435"><span class="linenos">2435</span></a>    <span class="c1"># Create a mask of pixels where blending occurred</span>
</span><span id="region_wise_super_resolution_blended-2436"><a href="#region_wise_super_resolution_blended-2436"><span class="linenos">2436</span></a>    <span class="n">blended_mask</span> <span class="o">=</span> <span class="n">weight_sum_np</span> <span class="o">&gt;</span> <span class="mf">0.0</span> <span class="c1"># Use a small epsilon for float safety</span>
</span><span id="region_wise_super_resolution_blended-2437"><a href="#region_wise_super_resolution_blended-2437"><span class="linenos">2437</span></a>
</span><span id="region_wise_super_resolution_blended-2438"><a href="#region_wise_super_resolution_blended-2438"><span class="linenos">2438</span></a>    <span class="c1"># Start with the original upsampled image as the base</span>
</span><span id="region_wise_super_resolution_blended-2439"><a href="#region_wise_super_resolution_blended-2439"><span class="linenos">2439</span></a>    <span class="n">final_image_np</span> <span class="o">=</span> <span class="n">background_sr_image</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="region_wise_super_resolution_blended-2440"><a href="#region_wise_super_resolution_blended-2440"><span class="linenos">2440</span></a>    
</span><span id="region_wise_super_resolution_blended-2441"><a href="#region_wise_super_resolution_blended-2441"><span class="linenos">2441</span></a>    <span class="c1"># Perform the weighted average only where weights are non-zero</span>
</span><span id="region_wise_super_resolution_blended-2442"><a href="#region_wise_super_resolution_blended-2442"><span class="linenos">2442</span></a>    <span class="n">final_image_np</span><span class="p">[</span><span class="n">blended_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">accumulator_np</span><span class="p">[</span><span class="n">blended_mask</span><span class="p">]</span> <span class="o">/</span> <span class="n">weight_sum_np</span><span class="p">[</span><span class="n">blended_mask</span><span class="p">]</span>
</span><span id="region_wise_super_resolution_blended-2443"><a href="#region_wise_super_resolution_blended-2443"><span class="linenos">2443</span></a>    
</span><span id="region_wise_super_resolution_blended-2444"><a href="#region_wise_super_resolution_blended-2444"><span class="linenos">2444</span></a>    <span class="c1"># Re-insert any non-blended background regions that were processed</span>
</span><span id="region_wise_super_resolution_blended-2445"><a href="#region_wise_super_resolution_blended-2445"><span class="linenos">2445</span></a>    <span class="c1"># This handles cases where regions overlap; the weighted average takes care of it.</span>
</span><span id="region_wise_super_resolution_blended-2446"><a href="#region_wise_super_resolution_blended-2446"><span class="linenos">2446</span></a>    
</span><span id="region_wise_super_resolution_blended-2447"><a href="#region_wise_super_resolution_blended-2447"><span class="linenos">2447</span></a>    <span class="k">return</span> <span class="n">ants</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">final_image_np</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">background_sr_image</span><span class="o">.</span><span class="n">origin</span><span class="p">,</span> 
</span><span id="region_wise_super_resolution_blended-2448"><a href="#region_wise_super_resolution_blended-2448"><span class="linenos">2448</span></a>                           <span class="n">spacing</span><span class="o">=</span><span class="n">background_sr_image</span><span class="o">.</span><span class="n">spacing</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="n">background_sr_image</span><span class="o">.</span><span class="n">direction</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Apply super-resolution model to labeled regions with smooth blending to minimize stitching artifacts.</p>

<p>This version uses a weighted-averaging scheme based on distance transforms
to create seamless transitions between super-resolved regions and the background.</p>

<h2 id="arguments">Arguments</h2>

<p>image : ANTsImage
    Input low-resolution image.</p>

<p>mask : ANTsImage
    Integer-labeled segmentation mask.</p>

<p>super_res_model : tf.keras.Model
    Trained super-resolution model.</p>

<p>dilation_amount : int
    Number of morphological dilations applied to each label region before cropping.
    This provides context to the SR model.</p>

<p>verbose : bool
    If True, print detailed status.</p>

<h2 id="returns">Returns</h2>

<p>ANTsImage : Full-size, super-resolved image with seamless blending.</p>
</div>


                </section>
                <section id="inference">
                            <input id="inference-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">inference</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">image</span>,</span><span class="param">	<span class="n">mdl</span>,</span><span class="param">	<span class="n">truncation</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">segmentation</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">target_range</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>,</span><span class="param">	<span class="n">poly_order</span><span class="o">=</span><span class="s1">&#39;hist&#39;</span>,</span><span class="param">	<span class="n">dilation_amount</span><span class="o">=</span><span class="mi">0</span>,</span><span class="param">	<span class="n">verbose</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="inference-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#inference"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="inference-2451"><a href="#inference-2451"><span class="linenos">2451</span></a><span class="k">def</span> <span class="nf">inference</span><span class="p">(</span>
</span><span id="inference-2452"><a href="#inference-2452"><span class="linenos">2452</span></a>    <span class="n">image</span><span class="p">,</span>
</span><span id="inference-2453"><a href="#inference-2453"><span class="linenos">2453</span></a>    <span class="n">mdl</span><span class="p">,</span>
</span><span id="inference-2454"><a href="#inference-2454"><span class="linenos">2454</span></a>    <span class="n">truncation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="inference-2455"><a href="#inference-2455"><span class="linenos">2455</span></a>    <span class="n">segmentation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="inference-2456"><a href="#inference-2456"><span class="linenos">2456</span></a>    <span class="n">target_range</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
</span><span id="inference-2457"><a href="#inference-2457"><span class="linenos">2457</span></a>    <span class="n">poly_order</span><span class="o">=</span><span class="s1">&#39;hist&#39;</span><span class="p">,</span>
</span><span id="inference-2458"><a href="#inference-2458"><span class="linenos">2458</span></a>    <span class="n">dilation_amount</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="inference-2459"><a href="#inference-2459"><span class="linenos">2459</span></a>    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="inference-2460"><a href="#inference-2460"><span class="linenos">2460</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="inference-2461"><a href="#inference-2461"><span class="linenos">2461</span></a><span class="sd">    Perform super-resolution inference on an input image, optionally guided by segmentation.</span>
</span><span id="inference-2462"><a href="#inference-2462"><span class="linenos">2462</span></a>
</span><span id="inference-2463"><a href="#inference-2463"><span class="linenos">2463</span></a><span class="sd">    This function uses a trained deep learning model to enhance the resolution of a medical image.</span>
</span><span id="inference-2464"><a href="#inference-2464"><span class="linenos">2464</span></a><span class="sd">    It optionally applies label-wise inference if a segmentation mask is provided.</span>
</span><span id="inference-2465"><a href="#inference-2465"><span class="linenos">2465</span></a>
</span><span id="inference-2466"><a href="#inference-2466"><span class="linenos">2466</span></a><span class="sd">    Parameters</span>
</span><span id="inference-2467"><a href="#inference-2467"><span class="linenos">2467</span></a><span class="sd">    ----------</span>
</span><span id="inference-2468"><a href="#inference-2468"><span class="linenos">2468</span></a><span class="sd">    image : ants.ANTsImage</span>
</span><span id="inference-2469"><a href="#inference-2469"><span class="linenos">2469</span></a><span class="sd">        Input image to be super-resolved.</span>
</span><span id="inference-2470"><a href="#inference-2470"><span class="linenos">2470</span></a>
</span><span id="inference-2471"><a href="#inference-2471"><span class="linenos">2471</span></a><span class="sd">    mdl : keras.Model</span>
</span><span id="inference-2472"><a href="#inference-2472"><span class="linenos">2472</span></a><span class="sd">        Trained super-resolution model, typically from ANTsPyNet.</span>
</span><span id="inference-2473"><a href="#inference-2473"><span class="linenos">2473</span></a>
</span><span id="inference-2474"><a href="#inference-2474"><span class="linenos">2474</span></a><span class="sd">    truncation : tuple or list of float, optional</span>
</span><span id="inference-2475"><a href="#inference-2475"><span class="linenos">2475</span></a><span class="sd">        Percentile values (e.g., [0.01, 0.99]) for intensity truncation before model input.</span>
</span><span id="inference-2476"><a href="#inference-2476"><span class="linenos">2476</span></a><span class="sd">        If None, no truncation is applied.</span>
</span><span id="inference-2477"><a href="#inference-2477"><span class="linenos">2477</span></a>
</span><span id="inference-2478"><a href="#inference-2478"><span class="linenos">2478</span></a><span class="sd">    segmentation : ants.ANTsImage, optional</span>
</span><span id="inference-2479"><a href="#inference-2479"><span class="linenos">2479</span></a><span class="sd">        A labeled segmentation mask. If provided, super-resolution is performed per label</span>
</span><span id="inference-2480"><a href="#inference-2480"><span class="linenos">2480</span></a><span class="sd">        using `region_wise_super_resolution` or `super_resolution_segmentation_per_label`.</span>
</span><span id="inference-2481"><a href="#inference-2481"><span class="linenos">2481</span></a>
</span><span id="inference-2482"><a href="#inference-2482"><span class="linenos">2482</span></a><span class="sd">    target_range : list of float</span>
</span><span id="inference-2483"><a href="#inference-2483"><span class="linenos">2483</span></a><span class="sd">        Intensity range used for scaling the input before applying the model.</span>
</span><span id="inference-2484"><a href="#inference-2484"><span class="linenos">2484</span></a><span class="sd">        Default is [1, 0] (internal default for `apply_super_resolution_model_to_image`).</span>
</span><span id="inference-2485"><a href="#inference-2485"><span class="linenos">2485</span></a>
</span><span id="inference-2486"><a href="#inference-2486"><span class="linenos">2486</span></a><span class="sd">    poly_order : int, str or None</span>
</span><span id="inference-2487"><a href="#inference-2487"><span class="linenos">2487</span></a><span class="sd">        Determines how to match intensity between the super-resolved image and the original.</span>
</span><span id="inference-2488"><a href="#inference-2488"><span class="linenos">2488</span></a><span class="sd">        Options:</span>
</span><span id="inference-2489"><a href="#inference-2489"><span class="linenos">2489</span></a><span class="sd">          - &#39;hist&#39; : use histogram matching</span>
</span><span id="inference-2490"><a href="#inference-2490"><span class="linenos">2490</span></a><span class="sd">          - int &gt;= 1 : perform polynomial regression of this order</span>
</span><span id="inference-2491"><a href="#inference-2491"><span class="linenos">2491</span></a><span class="sd">          - None : no intensity adjustment</span>
</span><span id="inference-2492"><a href="#inference-2492"><span class="linenos">2492</span></a>
</span><span id="inference-2493"><a href="#inference-2493"><span class="linenos">2493</span></a><span class="sd">    dilation_amount : int</span>
</span><span id="inference-2494"><a href="#inference-2494"><span class="linenos">2494</span></a><span class="sd">        Number of dilation steps applied to each segmentation label during</span>
</span><span id="inference-2495"><a href="#inference-2495"><span class="linenos">2495</span></a><span class="sd">        region-based super-resolution (if segmentation is provided).</span>
</span><span id="inference-2496"><a href="#inference-2496"><span class="linenos">2496</span></a>
</span><span id="inference-2497"><a href="#inference-2497"><span class="linenos">2497</span></a><span class="sd">    verbose : bool</span>
</span><span id="inference-2498"><a href="#inference-2498"><span class="linenos">2498</span></a><span class="sd">        If True, print progress and status messages.</span>
</span><span id="inference-2499"><a href="#inference-2499"><span class="linenos">2499</span></a>
</span><span id="inference-2500"><a href="#inference-2500"><span class="linenos">2500</span></a><span class="sd">    Returns</span>
</span><span id="inference-2501"><a href="#inference-2501"><span class="linenos">2501</span></a><span class="sd">    -------</span>
</span><span id="inference-2502"><a href="#inference-2502"><span class="linenos">2502</span></a><span class="sd">    ANTsImage or dict</span>
</span><span id="inference-2503"><a href="#inference-2503"><span class="linenos">2503</span></a><span class="sd">        - If `segmentation` is None, returns a single ANTsImage (super-resolved image).</span>
</span><span id="inference-2504"><a href="#inference-2504"><span class="linenos">2504</span></a><span class="sd">        - If `segmentation` is provided, returns a dictionary with:</span>
</span><span id="inference-2505"><a href="#inference-2505"><span class="linenos">2505</span></a><span class="sd">            - &#39;super_resolution&#39;: ANTsImage</span>
</span><span id="inference-2506"><a href="#inference-2506"><span class="linenos">2506</span></a><span class="sd">            - other entries may include label-wise results or metadata.</span>
</span><span id="inference-2507"><a href="#inference-2507"><span class="linenos">2507</span></a>
</span><span id="inference-2508"><a href="#inference-2508"><span class="linenos">2508</span></a><span class="sd">    Examples</span>
</span><span id="inference-2509"><a href="#inference-2509"><span class="linenos">2509</span></a><span class="sd">    --------</span>
</span><span id="inference-2510"><a href="#inference-2510"><span class="linenos">2510</span></a><span class="sd">    &gt;&gt;&gt; import ants</span>
</span><span id="inference-2511"><a href="#inference-2511"><span class="linenos">2511</span></a><span class="sd">    &gt;&gt;&gt; import antspynet</span>
</span><span id="inference-2512"><a href="#inference-2512"><span class="linenos">2512</span></a><span class="sd">    &gt;&gt;&gt; from siq import inference</span>
</span><span id="inference-2513"><a href="#inference-2513"><span class="linenos">2513</span></a><span class="sd">    &gt;&gt;&gt; img = ants.image_read(&quot;lowres.nii.gz&quot;)</span>
</span><span id="inference-2514"><a href="#inference-2514"><span class="linenos">2514</span></a><span class="sd">    &gt;&gt;&gt; model = antspynet.get_pretrained_network(&quot;dbpn&quot;, target_suffix=&quot;T1&quot;)</span>
</span><span id="inference-2515"><a href="#inference-2515"><span class="linenos">2515</span></a><span class="sd">    &gt;&gt;&gt; srimg = inference(img, model, truncation=[0.01, 0.99], verbose=True)</span>
</span><span id="inference-2516"><a href="#inference-2516"><span class="linenos">2516</span></a>
</span><span id="inference-2517"><a href="#inference-2517"><span class="linenos">2517</span></a><span class="sd">    &gt;&gt;&gt; seg = ants.image_read(&quot;mask.nii.gz&quot;)</span>
</span><span id="inference-2518"><a href="#inference-2518"><span class="linenos">2518</span></a><span class="sd">    &gt;&gt;&gt; sr_result = inference(img, model, segmentation=seg)</span>
</span><span id="inference-2519"><a href="#inference-2519"><span class="linenos">2519</span></a><span class="sd">    &gt;&gt;&gt; srimg = sr_result[&#39;super_resolution&#39;]</span>
</span><span id="inference-2520"><a href="#inference-2520"><span class="linenos">2520</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="inference-2521"><a href="#inference-2521"><span class="linenos">2521</span></a>    <span class="kn">import</span> <span class="nn">ants</span>
</span><span id="inference-2522"><a href="#inference-2522"><span class="linenos">2522</span></a>    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span><span id="inference-2523"><a href="#inference-2523"><span class="linenos">2523</span></a>    <span class="kn">import</span> <span class="nn">antspynet</span>
</span><span id="inference-2524"><a href="#inference-2524"><span class="linenos">2524</span></a>    <span class="kn">import</span> <span class="nn">antspyt1w</span>
</span><span id="inference-2525"><a href="#inference-2525"><span class="linenos">2525</span></a>    <span class="kn">from</span> <span class="nn">siq</span> <span class="kn">import</span> <span class="n">region_wise_super_resolution</span>
</span><span id="inference-2526"><a href="#inference-2526"><span class="linenos">2526</span></a>
</span><span id="inference-2527"><a href="#inference-2527"><span class="linenos">2527</span></a>    <span class="k">def</span> <span class="nf">apply_intensity_match</span><span class="p">(</span><span class="n">sr_image</span><span class="p">,</span> <span class="n">reference_image</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="inference-2528"><a href="#inference-2528"><span class="linenos">2528</span></a>        <span class="k">if</span> <span class="n">order</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="inference-2529"><a href="#inference-2529"><span class="linenos">2529</span></a>            <span class="k">return</span> <span class="n">sr_image</span>
</span><span id="inference-2530"><a href="#inference-2530"><span class="linenos">2530</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="inference-2531"><a href="#inference-2531"><span class="linenos">2531</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Applying intensity match with&quot;</span><span class="p">,</span> <span class="n">order</span><span class="p">)</span>
</span><span id="inference-2532"><a href="#inference-2532"><span class="linenos">2532</span></a>        <span class="k">if</span> <span class="n">order</span> <span class="o">==</span> <span class="s1">&#39;hist&#39;</span><span class="p">:</span>
</span><span id="inference-2533"><a href="#inference-2533"><span class="linenos">2533</span></a>            <span class="k">return</span> <span class="n">ants</span><span class="o">.</span><span class="n">histogram_match_image</span><span class="p">(</span><span class="n">sr_image</span><span class="p">,</span> <span class="n">reference_image</span><span class="p">)</span>
</span><span id="inference-2534"><a href="#inference-2534"><span class="linenos">2534</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="inference-2535"><a href="#inference-2535"><span class="linenos">2535</span></a>            <span class="k">return</span> <span class="n">ants</span><span class="o">.</span><span class="n">regression_match_image</span><span class="p">(</span><span class="n">sr_image</span><span class="p">,</span> <span class="n">reference_image</span><span class="p">,</span> <span class="n">poly_order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>
</span><span id="inference-2536"><a href="#inference-2536"><span class="linenos">2536</span></a>
</span><span id="inference-2537"><a href="#inference-2537"><span class="linenos">2537</span></a>    <span class="n">pimg</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">image_clone</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
</span><span id="inference-2538"><a href="#inference-2538"><span class="linenos">2538</span></a>    <span class="k">if</span> <span class="n">truncation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="inference-2539"><a href="#inference-2539"><span class="linenos">2539</span></a>        <span class="n">pimg</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">iMath</span><span class="p">(</span><span class="n">pimg</span><span class="p">,</span> <span class="s1">&#39;TruncateIntensity&#39;</span><span class="p">,</span> <span class="n">truncation</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">truncation</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="inference-2540"><a href="#inference-2540"><span class="linenos">2540</span></a>
</span><span id="inference-2541"><a href="#inference-2541"><span class="linenos">2541</span></a>    <span class="n">input_shape</span> <span class="o">=</span> <span class="n">mdl</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
</span><span id="inference-2542"><a href="#inference-2542"><span class="linenos">2542</span></a>    <span class="n">num_channels</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">input_shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="inference-2543"><a href="#inference-2543"><span class="linenos">2543</span></a>
</span><span id="inference-2544"><a href="#inference-2544"><span class="linenos">2544</span></a>    <span class="k">if</span> <span class="n">segmentation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="inference-2545"><a href="#inference-2545"><span class="linenos">2545</span></a>        <span class="k">if</span> <span class="n">num_channels</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="inference-2546"><a href="#inference-2546"><span class="linenos">2546</span></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="inference-2547"><a href="#inference-2547"><span class="linenos">2547</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using region-wise super resolution due to single-channel model with segmentation.&quot;</span><span class="p">)</span>
</span><span id="inference-2548"><a href="#inference-2548"><span class="linenos">2548</span></a>            <span class="n">sr</span> <span class="o">=</span> <span class="n">region_wise_super_resolution_blended</span><span class="p">(</span>
</span><span id="inference-2549"><a href="#inference-2549"><span class="linenos">2549</span></a>                <span class="n">pimg</span><span class="p">,</span> <span class="n">segmentation</span><span class="p">,</span> <span class="n">mdl</span><span class="p">,</span>
</span><span id="inference-2550"><a href="#inference-2550"><span class="linenos">2550</span></a>                <span class="n">dilation_amount</span><span class="o">=</span><span class="n">dilation_amount</span><span class="p">,</span>
</span><span id="inference-2551"><a href="#inference-2551"><span class="linenos">2551</span></a>                <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span>
</span><span id="inference-2552"><a href="#inference-2552"><span class="linenos">2552</span></a>            <span class="p">)</span>
</span><span id="inference-2553"><a href="#inference-2553"><span class="linenos">2553</span></a>            <span class="n">ref</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">resample_image_to_target</span><span class="p">(</span><span class="n">pimg</span><span class="p">,</span> <span class="n">sr</span><span class="p">)</span>
</span><span id="inference-2554"><a href="#inference-2554"><span class="linenos">2554</span></a>            <span class="k">return</span> <span class="n">apply_intensity_match</span><span class="p">(</span><span class="n">sr</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span> <span class="n">poly_order</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
</span><span id="inference-2555"><a href="#inference-2555"><span class="linenos">2555</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="inference-2556"><a href="#inference-2556"><span class="linenos">2556</span></a>            <span class="n">mynp</span> <span class="o">=</span> <span class="n">segmentation</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="inference-2557"><a href="#inference-2557"><span class="linenos">2557</span></a>            <span class="n">mynp</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">mynp</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">mynp</span><span class="p">)]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
</span><span id="inference-2558"><a href="#inference-2558"><span class="linenos">2558</span></a>            <span class="n">upFactor</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="inference-2559"><a href="#inference-2559"><span class="linenos">2559</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
</span><span id="inference-2560"><a href="#inference-2560"><span class="linenos">2560</span></a>                <span class="n">testarr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
</span><span id="inference-2561"><a href="#inference-2561"><span class="linenos">2561</span></a>                <span class="n">testarrout</span> <span class="o">=</span> <span class="n">mdl</span><span class="p">(</span><span class="n">testarr</span><span class="p">)</span>
</span><span id="inference-2562"><a href="#inference-2562"><span class="linenos">2562</span></a>                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
</span><span id="inference-2563"><a href="#inference-2563"><span class="linenos">2563</span></a>                    <span class="n">upFactor</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">testarrout</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">testarr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]))</span>
</span><span id="inference-2564"><a href="#inference-2564"><span class="linenos">2564</span></a>            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
</span><span id="inference-2565"><a href="#inference-2565"><span class="linenos">2565</span></a>                <span class="n">testarr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
</span><span id="inference-2566"><a href="#inference-2566"><span class="linenos">2566</span></a>                <span class="n">testarrout</span> <span class="o">=</span> <span class="n">mdl</span><span class="p">(</span><span class="n">testarr</span><span class="p">)</span>
</span><span id="inference-2567"><a href="#inference-2567"><span class="linenos">2567</span></a>                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
</span><span id="inference-2568"><a href="#inference-2568"><span class="linenos">2568</span></a>                    <span class="n">upFactor</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">testarrout</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">testarr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]))</span>
</span><span id="inference-2569"><a href="#inference-2569"><span class="linenos">2569</span></a>            <span class="n">temp</span> <span class="o">=</span> <span class="n">antspyt1w</span><span class="o">.</span><span class="n">super_resolution_segmentation_per_label</span><span class="p">(</span>
</span><span id="inference-2570"><a href="#inference-2570"><span class="linenos">2570</span></a>                <span class="n">pimg</span><span class="p">,</span>
</span><span id="inference-2571"><a href="#inference-2571"><span class="linenos">2571</span></a>                <span class="n">segmentation</span><span class="p">,</span>
</span><span id="inference-2572"><a href="#inference-2572"><span class="linenos">2572</span></a>                <span class="n">upFactor</span><span class="p">,</span>
</span><span id="inference-2573"><a href="#inference-2573"><span class="linenos">2573</span></a>                <span class="n">mdl</span><span class="p">,</span>
</span><span id="inference-2574"><a href="#inference-2574"><span class="linenos">2574</span></a>                <span class="n">segmentation_numbers</span><span class="o">=</span><span class="n">mynp</span><span class="p">,</span>
</span><span id="inference-2575"><a href="#inference-2575"><span class="linenos">2575</span></a>                <span class="n">target_range</span><span class="o">=</span><span class="n">target_range</span><span class="p">,</span>
</span><span id="inference-2576"><a href="#inference-2576"><span class="linenos">2576</span></a>                <span class="n">dilation_amount</span><span class="o">=</span><span class="n">dilation_amount</span><span class="p">,</span>
</span><span id="inference-2577"><a href="#inference-2577"><span class="linenos">2577</span></a>                <span class="n">poly_order</span><span class="o">=</span><span class="n">poly_order</span><span class="p">,</span>
</span><span id="inference-2578"><a href="#inference-2578"><span class="linenos">2578</span></a>                <span class="n">max_lab_plus_one</span><span class="o">=</span><span class="kc">True</span>
</span><span id="inference-2579"><a href="#inference-2579"><span class="linenos">2579</span></a>            <span class="p">)</span>
</span><span id="inference-2580"><a href="#inference-2580"><span class="linenos">2580</span></a>            <span class="n">imgsr</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;super_resolution&#39;</span><span class="p">]</span>
</span><span id="inference-2581"><a href="#inference-2581"><span class="linenos">2581</span></a>            <span class="n">ref</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">resample_image_to_target</span><span class="p">(</span><span class="n">pimg</span><span class="p">,</span> <span class="n">imgsr</span><span class="p">)</span>
</span><span id="inference-2582"><a href="#inference-2582"><span class="linenos">2582</span></a>            <span class="k">return</span> <span class="n">apply_intensity_match</span><span class="p">(</span><span class="n">imgsr</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span> <span class="n">poly_order</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
</span><span id="inference-2583"><a href="#inference-2583"><span class="linenos">2583</span></a>
</span><span id="inference-2584"><a href="#inference-2584"><span class="linenos">2584</span></a>    <span class="c1"># Default path: no segmentation</span>
</span><span id="inference-2585"><a href="#inference-2585"><span class="linenos">2585</span></a>    <span class="n">imgsr</span> <span class="o">=</span> <span class="n">antspynet</span><span class="o">.</span><span class="n">apply_super_resolution_model_to_image</span><span class="p">(</span>
</span><span id="inference-2586"><a href="#inference-2586"><span class="linenos">2586</span></a>        <span class="n">pimg</span><span class="p">,</span> <span class="n">mdl</span><span class="p">,</span> <span class="n">target_range</span><span class="o">=</span><span class="n">target_range</span><span class="p">,</span> <span class="n">regression_order</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span>
</span><span id="inference-2587"><a href="#inference-2587"><span class="linenos">2587</span></a>    <span class="p">)</span>
</span><span id="inference-2588"><a href="#inference-2588"><span class="linenos">2588</span></a>    <span class="n">ref</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">resample_image_to_target</span><span class="p">(</span><span class="n">pimg</span><span class="p">,</span> <span class="n">imgsr</span><span class="p">)</span>
</span><span id="inference-2589"><a href="#inference-2589"><span class="linenos">2589</span></a>    <span class="k">return</span> <span class="n">apply_intensity_match</span><span class="p">(</span><span class="n">imgsr</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span> <span class="n">poly_order</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Perform super-resolution inference on an input image, optionally guided by segmentation.</p>

<p>This function uses a trained deep learning model to enhance the resolution of a medical image.
It optionally applies label-wise inference if a segmentation mask is provided.</p>

<h2 id="parameters">Parameters</h2>

<p>image : ants.ANTsImage
    Input image to be super-resolved.</p>

<p>mdl : keras.Model
    Trained super-resolution model, typically from ANTsPyNet.</p>

<p>truncation : tuple or list of float, optional
    Percentile values (e.g., [0.01, 0.99]) for intensity truncation before model input.
    If None, no truncation is applied.</p>

<p>segmentation : ants.ANTsImage, optional
    A labeled segmentation mask. If provided, super-resolution is performed per label
    using <code><a href="#region_wise_super_resolution">region_wise_super_resolution</a></code> or <code>super_resolution_segmentation_per_label</code>.</p>

<p>target_range : list of float
    Intensity range used for scaling the input before applying the model.
    Default is [1, 0] (internal default for <code>apply_super_resolution_model_to_image</code>).</p>

<p>poly_order : int, str or None
    Determines how to match intensity between the super-resolved image and the original.
    Options:
      - 'hist' : use histogram matching
      - int &gt;= 1 : perform polynomial regression of this order
      - None : no intensity adjustment</p>

<p>dilation_amount : int
    Number of dilation steps applied to each segmentation label during
    region-based super-resolution (if segmentation is provided).</p>

<p>verbose : bool
    If True, print progress and status messages.</p>

<h2 id="returns">Returns</h2>

<p>ANTsImage or dict
    - If <code>segmentation</code> is None, returns a single ANTsImage (super-resolved image).
    - If <code>segmentation</code> is provided, returns a dictionary with:
        - 'super_resolution': ANTsImage
        - other entries may include label-wise results or metadata.</p>

<h2 id="examples">Examples</h2>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">ants</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">antspynet</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">siq</span> <span class="kn">import</span> <span class="n">inference</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">img</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">image_read</span><span class="p">(</span><span class="s2">&quot;lowres.nii.gz&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">model</span> <span class="o">=</span> <span class="n">antspynet</span><span class="o">.</span><span class="n">get_pretrained_network</span><span class="p">(</span><span class="s2">&quot;dbpn&quot;</span><span class="p">,</span> <span class="n">target_suffix</span><span class="o">=</span><span class="s2">&quot;T1&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">srimg</span> <span class="o">=</span> <span class="n">inference</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">truncation</span><span class="o">=</span><span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre>
</div>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">seg</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">image_read</span><span class="p">(</span><span class="s2">&quot;mask.nii.gz&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">sr_result</span> <span class="o">=</span> <span class="n">inference</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">segmentation</span><span class="o">=</span><span class="n">seg</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">srimg</span> <span class="o">=</span> <span class="n">sr_result</span><span class="p">[</span><span class="s1">&#39;super_resolution&#39;</span><span class="p">]</span>
</code></pre>
</div>
</div>


                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>